var exo={sceneGraph:{primitives:{},properties:{},nodes:{},plugs:{}},models:{manipulators:{}},api:{},geometry:{bone:{}},shapes:{},math:{},resources:{importers:{loaders:{}},exporters:{},renderer:{}},operators:{},translators:{three:{gizmos:{},nodes:{},plugs:{}},vray:{factory:{},nodes:{},plugs:{}}},ui:{vm:{},views:{properties:{}},home:{},plugins:{},files:{},results:{},scenes:{},user:{},admin:{},help:{}}};var defer=function(ms,fn,context){if(fn===undefined){throw new Error("Attempt to call defer with undefined")}return function(){var args=_.toArray(arguments);setTimeout(function(){fn.apply(context,args)},ms)}};window.exo=exo;exo.trackEvent=function(eventClass,eventOperation,eventOperationInfo,eventData){if(typeof exo.conf.analyticsTest==="undefined"){console.error("Analytics test variable undefined");return}var evCategory=eventClass||"Unnamed Event";if(eventOperation){evCategory=evCategory+" "+eventOperation}var evName=evCategory;if(eventOperationInfo){evName=evCategory+", "+eventOperationInfo}var evData=eventData||{};evData.category=evCategory;if(exo.conf.analyticsTest){evName="Test - "+evName;evData.category="Test - "+evCategory}analytics.track(evName,evData)};exo.Stats=function(){this.collection={};this.lastChanged=new Date};exo.Stats.prototype={each:function(fn,context){return _.each(this.collection,fn,context)},map:function(fn,context){return _.map(this.collection,fn,context)},reset:function(){_.each(this.collection,function(info,key){delete info.average;info.total=0;info.count=0;delete info.value;delete info.t})},track:function(key,options){var defaultFormat=function(v){return typeof v==="number"?v%1===0?_.str.numberFormat(v,0):_.str.numberFormat(v,2):v};options=options||{};this.collection[key]={format:options.format||defaultFormat,label:options.label||_.str.humanize(key),count:0,total:0}},set:function(key,value,label){if(!this.collection[key])this.track(key);this.collection[key].value=value;if(label)this.collection[key].label=label;this.lastChanged=new Date},mark:function(key){var t=new Date;var info=this.collection[key];if(info){if(info.t)this._calc(key,t);info.t=t}else{this.track(key,{});this.collection[key].t=t}},start:function(key){if(!this.collection[key])this.track(key);this.collection[key].t=new Date},stop:function(key){if(!this.collection[key])this.track(key);this._calc(key,new Date);this.collection[key].t=null},_calc:function(key,t){var info=this.collection[key];if(!info||!info.t)return;var delta=t-info.t;info.total+=delta;info.count++;info.average=info.total/info.count;this.lastChanged=t}};exo.stats=new exo.Stats;exo.profiling=new exo.Stats;!function(){var v=new THREE.Vector4;var matrix=new THREE.Matrix4;var det3x3=function(el){var a=el[0],b=el[1],c=el[2],d=el[4],e=el[5],f=el[6],g=el[8],h=el[9],i=el[10];return a*(e*i-f*h)-b*(d*i-f*g)+c*(d*h-e*g)};var correctRotationMatrix=function(mat,scale){var el=mat.elements;if(det3x3(el)>=0){return false}for(var i=11;i>=0;--i){el[i]*=-1}scale.x*=-1;scale.y*=-1;scale.z*=-1;return true};THREE.Matrix4.prototype.decompose=function(position,quaternion,scale){var te=this.elements;position=position instanceof THREE.Vector3?position:new THREE.Vector3;quaternion=quaternion instanceof THREE.Quaternion?quaternion:new THREE.Quaternion;scale=scale instanceof THREE.Vector3?scale:new THREE.Vector3;v.set(te[0],te[1],te[2],te[3]);scale.x=v.length();v.set(te[4],te[5],te[6],te[7]);scale.y=v.length();v.set(te[8],te[9],te[10],te[11]);scale.z=v.length();position.x=te[12];position.y=te[13];position.z=te[14];matrix.copy(this);var me=matrix.elements;var div=scale.x;if(div!==0){div=1/div;me[0]*=div;me[1]*=div;me[2]*=div}div=scale.y;if(div!==0){div=1/div;me[4]*=div;me[5]*=div;me[6]*=div}div=scale.z;if(div!==0){div=1/div;me[8]*=div;me[9]*=div;me[10]*=div}var flipFaces=correctRotationMatrix(matrix,scale);quaternion.setFromRotationMatrix(matrix);return[position,quaternion,scale,flipFaces]}}();!function(){THREE.Vector3.prototype.apply3x3InMatrix4=function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z;this.y=e[1]*x+e[5]*y+e[9]*z;this.z=e[2]*x+e[6]*y+e[10]*z;return this}}();THREE.Plane.prototype.applyMatrix4=function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(matrix,optionalNormalMatrix){optionalNormalMatrix=optionalNormalMatrix||(new THREE.Matrix3).getNormalMatrix(matrix);var newNormal=v1.copy(this.normal).applyMatrix3(optionalNormalMatrix).normalize();var newCoplanarPoint=this.coplanarPoint(v2);newCoplanarPoint.applyMatrix4(matrix);this.setFromNormalAndCoplanarPoint(newNormal,newCoplanarPoint);return this}}();!function(){var allOperators=[];var registry={};exo.sceneGraph.registry={clear:function(){allOperators=[];registry={}},addOperator:function(operator){var invalid=function(message){console.log(operator);throw new Error(message+", invalid operator specification, see console.log for details.")};if(operator.name===undefined)invalid("operator.name is not defined");var fn=operator.create||operator.modify||operator.apply;if(!fn){invalid("Operator `apply` must be defined")}if(operator.target!==undefined&&operator.targets===undefined){operator.targets=[operator.target]}if(operator.targets===undefined)invalid("operator target or targets is not defined");allOperators.push(operator);_.each(operator.targets,function(target){registry[target]=registry[target]||{};registry[target][operator.name]=operator})},operator:function(primitive,name){var ops=registry[primitive];return ops&&ops[name]},operators:function(primitive){return(primitive?registry[primitive]:allOperators)||{}}}}();exo.sceneGraph.SchemaBase=highbrow.extend("Model","SchemaBase",{constructor:function(attrs,options){attrs=attrs||{};if(this.name===null||this.name===undefined){this.name=this.constructor.name}this.time=0;this.version=-1;this.schema=_.clone(this.schema)||{};this._generatedId=uuid.v4();this.id=attrs._id=attrs._id||this._generatedId;if(options){if(options.root)this.root=options.root;if(options.context)this.context=options.context;if(options.parent)this.parent=options.parent}_.each(this.schema,function(info,key){this.schema[key]=exo.sceneGraph.Property.build(info,{root:this,key:key})},this);this._backboneConstructor(attrs,options);this._setInitialize(attrs);var initializedAttrs={};_.each(this.schema,function(info,key){if(this.attributes[key]===undefined){initializedAttrs[key]=this.schema[key].initializeValue(this)}},this);if(_.size(initializedAttrs)){this._setInitialize(initializedAttrs)}this.initialize.apply(this,arguments);this.triggerDirty()},buildSchema:function(){this.schema=_.clone(this.schema)||{};_.each(this.schema,function(info,key){this.schema[key]=exo.sceneGraph.Property.build(info,{root:this,key:key})},this)},_setInitialize:function(attributes){this.set(attributes,{silent:true});this.changed={};this._silent={};this._pending={};this._previousAttributes=_.clone(this.attributes)},_backboneConstructor:function(attributes,options){if(options&&options.collection)this.collection=options.collection;this.attributes={};this._escapedAttributes={};this.cid=_.uniqueId("c");this.changed={};this._silent={};this._pending={}},isNew:function(){return this._generatedId===this.id},triggerDirty:function(){this.version++;this.trigger("dirty",this)},update:function(){},setTime:function(time){if(this.time!==time){this.time=time;this.trigger("timeChange",time)}},set:function(key,value,options){var attrs,attr,val;if(_.isObject(key)||!key){attrs=key;options=value}else{attrs={};attrs[key]=value}_.each(attrs,function(val,key){var sub;if(key.indexOf(".")>=0){var components=key.split(".");key=components[0];sub=components[1]}if(this.schema[key]){if(sub){if(!this.schema[key].setProperty){throw new Error("No property for: "+key)}if(this.schema[key].isKeyFramed(this.time)[sub]){attrs[key]=this.schema[key].setIntermediateProperty(val,sub,this.time)}else{attrs[key]=this.schema[key].setProperty(val,sub)}}else{attrs[key]=this.schema[key].setIntermediateOrNot(val,this.time)}}else{}},this);if(!(options&&options.silent)){this.triggerDirty()}return highbrow.Model.prototype.set.call(this,attrs,options)},ctx:function(selection){var scene=this.scene();var ctx=scene?scene.getCtx():null;if(ctx&&!this.detached){return selection?ctx(selection):ctx(this)}else{var node=this.node();if(this.detachable||node&&node.detachable){return this.mockCtx()}else{exo.reportError("Context not found - is this attached to the Scene?")}}},mockCtx:function(){if(!this._mockCtx)this._mockCtx=this.createMockCtx();return this._mockCtx},createMockCtx:function(){var model=this;return{set:function(key,value,options){model.set(key,value,options)},get:function(key){return model.get(key)},addNode:function(){return model.addNode?model.addNode.apply(model,arguments):null},removeNode:function(){return model.removeNode?model.removeNode.apply(model,arguments):null},addOperator:function(){return model.addOperator?model.addOperator.apply(model,arguments):null},removeOperator:function(){return model.removeOperator?model.removeOperator.apply(model,arguments):null},exec:function(){var editor=model.editor?model.editor():null;var ctx=editor?editor.getCtx():null;if(ctx)return ctx.exec.apply(ctx,arguments)}}},path:function(){return""},node:function(){return null},scene:function(){return null},setAt:function(key,val,time,interpolationType){var sub;if(key.indexOf(".")>=0){var components=key.split(".");key=components[0];sub=components[1]}time=time===undefined?this.time:time;if(this.schema[key]===undefined)return;var attrs={};if(sub){attrs[key]=this.schema[key].setPropertyAt(val,sub,time,interpolationType)}else{attrs[key]=this.schema[key].setAt(val,time,interpolationType)}var options={};highbrow.Model.prototype.set.call(this,attrs,options)},setExpr:function(key,expr){if(this.schema[key]!==undefined){this.attributes[key]=this.schema[key].setExpr(expr,this.time)}},get:function(key){return this.schema[key]?this.schema[key].getAt(this.time):this.attributes[key]},getAt:function(key,time){return this.schema[key]?this.schema[key].getAt(time):this.attributes[key]},toggleKeyFrame:function(key){this.attributes[key]=this.schema[key].toggleKeyFrame(this.time)},removeKeyFrame:function(key,time){if(time===undefined)time=this.time;this.schema[key].removeKey(time)},isKeyFramed:function(key){return this.schema[key]&&this.schema[key].isKeyFramed(this.time)},isAnimated:function(){var animated=false;_.each(this.attributes,function(attr,key){if(this.isKeyFramed(key)){animated=true}},this);return animated},clearKeyFrames:function(key){if(this.isKeyFramed(key))this.schema[key].clearKeyFrames()},stringify:function(key){return JSON.stringify(this.attributes[key])},attributeToJSON:function(key){return this.schema[key].toJSON()},stringifyPrevious:function(key){return JSON.stringify(this._previousAttributes[key])}},{extendWith:function(name,protoProps,classProps){var baseSchema=this.prototype.schema||{};var incomingSchema=protoProps.schema||{};var newcls=highbrow.extend(this,name,protoProps,classProps);newcls.prototype.schema=_.extend({},baseSchema,incomingSchema);return newcls}});exo.sceneGraph.Property=function(schema,options){options=options||{};this.options=options;this.root=options.root;this.key=options.key;this.schema=schema||{};this.type=this.schema.type;if(this.schema.animatable&&this.interpolationScheme){this.animatable=true;_.extend(this,this.keyFramable)}this.initialize()};exo.sceneGraph.Property.extend=Backbone.Model.extend;exo.sceneGraph.Property.build=function(info,options){if(!exo.sceneGraph.properties[info.type]){throw new Error("Invalid Schema Property: "+info.type)}return new exo.sceneGraph.properties[info.type](info,options)};_.extend(exo.sceneGraph.Property.prototype,{initialize:function(){},plug:function(){return this.root.plug?this.root.plug():this.root},set:function(val){this.value=this.normalize(val);return this.toJSON()},setAt:function(val,time,interpolationType){return this.set(val)},setExpr:function(){},get:function(){return this.value},getAt:function(time){return this.get()},isKeyFramed:function(){return false},normalize:function(val){return val},parse:function(val){this.set(val)},triggerChange:function(type,time){var plug=this.plug();if(type){if(plug!==this.root){this.root.trigger(type+":keyFrame",this.root,this.key,time)}this.plug().trigger(type+":keyFrame",this.root,this.key,time)}var val=time!==undefined?this.getAt(time):this.get();this.root.trigger("change:"+this.key,this.root,val,{});this.root.trigger("change",this.root,{})},toJSON:function(){return this.value},setIntermediateOrNot:function(val,time){return this.set(val)},initializeValue:function(root){var initialValue=null;if(this.schema.defaultValue!==undefined){initialValue=this.schema.defaultValue}if(this.schema.initialValue!==undefined){initialValue=this.schema.initialValue}if(this.options.value!==undefined){initialValue=this.options.value}if(initialValue==undefined&&this.defaultValue){initialValue=this.defaultValue}if(_.isFunction(initialValue)){initialValue=initialValue(root)}return this.set(initialValue)},keyFramable:{initialize:function(){var opts={normalize:this.normalize.bind(this),interpolationScheme:this.interpolationScheme};this.track=new exo.sceneGraph.Track(this.defaultValue,opts);this.initWatchers()},initWatchers:function(){this.root.on("timeChange",function(t){if(this.track.intermediate)this.track.clearIntermediate()},this)},set:function(val){this.track.set(val);return this.track.toJSON()},get:function(){return this.track.get()},getAt:function(time){return this.track.getAt(time)},setAt:function(val,time){if(this.track.setAt(val,time)){this.plug().trigger("add:keyFrame",this.root,this.key,time)}return this.track.toJSON()},setIntermediate:function(val,time){val=this.track.setIntermediate(val,time);this.triggerChange(null,time)},setIntermediateOrNot:function(val,time){var keyframeData=val&&(val.keys||val.expr);if(!keyframeData&&this.isKeyFramed(time)){return this.setIntermediate(val,time)}else{return this.set(val)}},removeKey:function(time){if(this.track.removeKey(time)){this.triggerChange("remove",time)}},clearKeyFrames:function(){var result=this.track.clearKeyFrames();this.triggerChange("remove");return result},setExpr:function(exp){return this.track.setExpr(exp)},toJSON:function(){return this.track.toJSON()},isKeyFramed:function(time){return this.track.isKeyFramed(time)},hasKeyFrames:function(time){return this.track.hasKeyFrames()},keyFrames:function(){return this.track.keyFrames()},getKeyFrameTimes:function(){return this.track.getTimes()},toggleKeyFrame:function(time){return this.isKeyFramed()?this.set(this.track.getAt(time)):this.setAt(time,this.track.get())}}});exo.sceneGraph.KeyFrame=function(keys,options){options=options||{};this.keys=keys||[];this.times=_.pluck(this.keys,"t");var first_key=this.keys[0];if(first_key&&first_key.v!==undefined&&options.interpolationScheme!=="discrete"){var forceDiscreteInterp=true;var value=keys[0].v;if(value instanceof THREE.Vector3||value instanceof THREE.Color||typeof value==="number"){forceDiscreteInterp=false}if(forceDiscreteInterp){options.interpolationScheme="discrete"}}this.interpolate=this[(options.interpolationScheme||"linear")+"Interpolation"]};var cubicTangent=function(times,values){var p_k,t_k,tan={m_0:0,m_1:0};p_k=values[1];t_k=times[1];if(t_k!==times[0]){tan.m_0=((values[2]-p_k)/(times[2]-t_k)+(p_k-values[0])/(t_k-times[0]))*.5}p_k=values[2];t_k=times[2];if(t_k!==times[3]){tan.m_1=((values[3]-p_k)/(times[3]-t_k)+(p_k-values[1])/(t_k-times[1]))*.5}return tan};var cubicInterpolation=function(H,p0,m0,p1,m1){return H.h00*p0+H.h10*m0+H.h01*p1+H.h11*m1};var cubicReal=function(H,times,values,tangents){var tan;if(tangents!==undefined){tan={m_0:tangents[0],m_1:tangents[1]}}else{tan=cubicTangent(times,values)}return cubicInterpolation(H,values[1],tan.m_0,values[2],tan.m_1)};var cubicVector3=function(H,times,values,tangents){var x_vals=[values[0].x,values[1].x,values[2].x,values[3].x];var y_vals=[values[0].y,values[1].y,values[2].y,values[3].y];var z_vals=[values[0].z,values[1].z,values[2].z,values[3].z];var x_tan,y_tan,z_tan;if(tangents!==undefined){x_tan={m_0:tangents[0].x,m_1:tangents[1].x};y_tan={m_0:tangents[0].y,m_1:tangents[1].y};z_tan={m_0:tangents[0].z,m_1:tangents[1].z}}else{x_tan=cubicTangent(times,x_vals);y_tan=cubicTangent(times,y_vals);z_tan=cubicTangent(times,z_vals)}return new THREE.Vector3(cubicInterpolation(H,x_vals[1],x_tan.m_0,x_vals[2],x_tan.m_1),cubicInterpolation(H,y_vals[1],y_tan.m_0,y_vals[2],y_tan.m_1),cubicInterpolation(H,z_vals[1],z_tan.m_0,z_vals[2],z_tan.m_1))};var cubicColor=function(H,times,values,tangents){var clamp=function(val,min,max){min=min||0;max=max||1;return val<min?min:val>max?max:val};var x_vals=[values[0].r,values[1].r,values[2].r,values[3].r];var y_vals=[values[0].g,values[1].g,values[2].g,values[3].g];var z_vals=[values[0].b,values[1].b,values[2].b,values[3].b];var x_tan,y_tan,z_tan;if(tangents!==undefined){x_tan={m_0:tangents[0].r,m_1:tangents[1].r};y_tan={m_0:tangents[0].g,m_1:tangents[1].g};z_tan={m_0:tangents[0].b,m_1:tangents[1].b}}else{x_tan=cubicTangent(times,x_vals);y_tan=cubicTangent(times,y_vals);z_tan=cubicTangent(times,z_vals)}var ret=new THREE.Color;ret.r=clamp(cubicInterpolation(H,x_vals[1],x_tan.m_0,x_vals[2],x_tan.m_1));ret.g=clamp(cubicInterpolation(H,y_vals[1],y_tan.m_0,y_vals[2],y_tan.m_1));ret.b=clamp(cubicInterpolation(H,z_vals[1],z_tan.m_0,z_vals[2],z_tan.m_1));return ret};_.extend(exo.sceneGraph.KeyFrame.prototype,{insert:function(time,value){var idx=_.sortedIndex(this.times,time);var isNew=!(this.keys[idx]&&this.keys[idx].t===time);if(!isNew){this.keys[idx].v=value}else{this.times.splice(idx,0,time);this.keys.splice(idx,0,{t:time,v:value})}return isNew},remove:function(time){var idx=_.sortedIndex(this.times,time);if(this.times[idx]===time){this.times.splice(idx,1);this.keys.splice(idx,1)}},toJSON:function(){return _.map(this.keys,function(key){var info={};if(key.v instanceof THREE.Vector3){return _.extend({},key,{v:[key.v.x,key.v.y,key.v.z]})}else if(key.v instanceof THREE.Color){return _.extend({},key,{v:key.v.getHex()})}else{return _.extend({},key)}})},has:function(time){return this.times[_.sortedIndex(this.times,time)]===time},discreteInterpolation:function(time){if(time<=this.times[0]){return this.keys[0].v}else if(time>=this.times[this.times.length-1]){return this.keys[this.times.length-1].v}var idx=_.sortedIndex(this.times,time);if(this.times[idx]===time){return this.keys[idx].v}return this.keys[idx-1].v},linearInterpolation:function(time){if(time<=this.times[0]){return this.keys[0].v}else if(time>=this.times[this.times.length-1]){return this.keys[this.times.length-1].v}var idx=_.sortedIndex(this.times,time);var min_k=this.times[idx-1];time=(time-min_k)/(this.times[idx]-min_k);var min_v=this.keys[idx-1].v;var max_v=this.keys[idx].v;if(min_v instanceof THREE.Vector3){return new THREE.Vector3(min_v.x+time*(max_v.x-min_v.x),min_v.y+time*(max_v.y-min_v.y),min_v.z+time*(max_v.z-min_v.z))}else if(min_v instanceof THREE.Color){var ret=new THREE.Color;ret.r=min_v.r+time*(max_v.r-min_v.r);ret.g=min_v.g+time*(max_v.g-min_v.g);ret.b=min_v.b+time*(max_v.b-min_v.b);return ret}return min_v+time*(max_v-min_v)},cubicInterpolation:function(){var _timesArray=new Array(4);var _valsArray=new Array(4);var _tangArray=new Array(2);return function(time){var keys=this.keys;if(time<=keys[0].t){var tmp=keys[0];if(tmp.tangent!==undefined){return tmp.v+(time-tmp.t)*tmp.tangent}return tmp.v}else if(time>=keys[keys.length-1].t){var tmp=keys[keys.length-1];if(tmp.tangent!==undefined)return tmp.v+(time-tmp.t)*tmp.tangent;return tmp.v}var idx=_.sortedIndex(this.times,time)-1;var min_k=keys[idx].t;time=(time-min_k)/(keys[idx+1].t-min_k);var H={};var _1_m_t_sq=Math.pow(1-time,2),_t_sq=time*time,_2_t=2*time;H.h00=(1+_2_t)*_1_m_t_sq,H.h10=time*_1_m_t_sq,H.h01=_t_sq*(3-_2_t),H.h11=_t_sq*(time-1);var _times=_timesArray;var _vals=_valsArray;var _tang=_tangArray;var tmp;if(idx===0){tmp=this.keys[idx];_times[0]=tmp.t;_vals[0]=tmp.v}else{tmp=this.keys[idx-1];_times[0]=tmp.t;_vals[0]=tmp.v}tmp=this.keys[idx];_times[1]=tmp.t;_vals[1]=tmp.v;_tang[0]=tmp.tangent;tmp=this.keys[idx+1];_times[2]=tmp.t;_vals[2]=tmp.v;_tang[1]=tmp.tangent;if(_tang[0]===undefined||_tang[1]===undefined){_tang=undefined}if(idx+2===this.keys.length){_times[3]=tmp.t;_vals[3]=tmp.v}else{tmp=this.keys[idx+2];_times[3]=tmp.t;_vals[3]=tmp.v}tmp=_vals[0];if(tmp instanceof THREE.Vector3){return cubicVector3(H,_times,_vals,_tang)}else if(tmp instanceof THREE.Color){return cubicColor(H,_times,_vals,_tang)}return cubicReal(H,_times,_vals,_tang)}}()});exo.sceneGraph.Track=function(val,options){if(options.normalize)this.normalize=options.normalize;this.interpolationScheme=options.interpolationScheme||"linear";this.root=options.root;this.set(val)};_.extend(exo.sceneGraph.Track.prototype,{normalize:function(v){return v},set:function(val){if(_.isObject(val)&&val.keys){this.value=null;this.expr=null;this.keyf=new exo.sceneGraph.KeyFrame(_.map(val.keys,function(info){info.v=this.normalize(info.v);return info},this),{interpolationSchema:this.interpolationScheme})}else if(_.isObject(val)&&val.expr){this.value=null;this.keyf=null;this.expr=val.expr}else{this.keyf=null;this.expr=null;this.value=this.normalize(val)}},get:function(){return this.value},setAt:function(val,time,interpolationScheme){val=this.normalize(val);this.intermediate=null;this.value=null;if(this.keyf){return this.keyf.insert(time,val)}else{this.keyf=new exo.sceneGraph.KeyFrame([{t:time,v:val}],{interpolationScheme:interpolationScheme||this.interpolationScheme});return true}},setIntermediate:function(val,time){this.intermediate={};this.intermediate[time]=this.normalize(val);return this.intermediate[time]},clearIntermediate:function(){this.intermediate={}},removeKey:function(time){if(!this.keyf)return false;var currentValue=this.getAt(time);this.keyf.remove(time);if(!this.keyf.keys.length){this.keyf=null;this.value=currentValue}return true},getAt:function(time){if(time===undefined)throw new Error("Expect a time to be set");if(this.intermediate&&this.intermediate[time]!==undefined){return this.intermediate[time]}if(this.keyf&&this.keyf.keys.length){return this.keyf.interpolate(time)}else if(this.exp!==undefined){return eval(this.exp)}return this.value},setExpr:function(exp,time){var val=eval(exp);this.exp=exp;this.keyf=null;return{expr:this.exp}},toggleKeyFrame:function(time){var res=this.isKeyFramed()?this.set(this.value):this.setAt(time,this.value);return res},clearKeyFrames:function(){if(!this.keyf)return false;for(var i=this.keyf.keys.length-1;i>=0;--i){this.removeKey(this.keyf.keys[i].t)}},isKeyFramed:function(time){if(!this.keyf)return false;var info={length:this.keyf.times.length};if(this.intermediate&&this.intermediate[time]!==undefined){_.extend(info,{modified:true,type:"modified",value:this.intermediate[time]})}else if(this.keyf.has(time)){_.extend(info,{key:true,type:"key",value:this.getAt(time)})}else{_.extend(info,{interpolated:true,type:"interpolated",value:this.keyf.interpolate(time)})}return info},hasKeyFrames:function(){return this.keyf?this.keyf.times.length:0},keyFrames:function(){return this.keyf?this.keyf.keys:[]},getTimes:function(){return this.keyf?this.keyf.times:[]},toJSON:function(){if(this.keyf){return{keys:this.keyf.toJSON()}}else if(this.expr){return{expr:this.expr}}else{return this.value}}});exo.sceneGraph.properties.File=exo.sceneGraph.Property.extend({normalize:function(id){if(!id){return null}if(id instanceof exo.sceneGraph.File){return id}var scene=this.root.scene();if(!scene||!scene.files){this.loadId=id;return null}var file=scene.files.get(id);if(!file){this.loadId=id;var that=this;scene.files.onAdd(id,function(err,file){that.set(id);that.root.triggerDirty()});return null}else if(this.loadId&&this.loadId!==file.id){this.loadId=null}return file},get:function(){if(this.loadId&&!this.value){var loadId=this.loadId;this.loadId=null;this.set(loadId)}return this.value},defaultValue:function(){return null},toJSON:function(){return this.loadId||this.value&&this.value.id}});exo.sceneGraph.properties.Blob=exo.sceneGraph.properties.File.extend({});exo.sceneGraph.properties.Boolean=exo.sceneGraph.Property.extend({normalize:function(v){return!!v}});exo.sceneGraph.properties.Button=exo.sceneGraph.Property.extend();exo.sceneGraph.properties.Color=exo.sceneGraph.Property.extend({normalize:function(val){if(typeof val==="number"){val=new THREE.Color(val)}else if(_.isObject(val)&&!(val instanceof THREE.Color)){var c=new THREE.Color;c.setRGB(val.r,val.g,val.b);val=c}return val},normalizeValue:function(val){var num=Number(val);if(_.isNaN(num))return 1;if(num<this.schema.minValue)return this.schema.minValue;if(num>this.schema.maxValue)return this.schema.maxValue;return num},interpolationScheme:"custom",defaultValue:{r:1,g:1,b:1},toJSON:function(){return{r:this.value.r,g:this.value.g,b:this.value.b}},keyFramable:{initialize:function(){var opts={normalize:this.normalizeValue.bind(this)};if(this.schema.minValue===undefined){this.schema.minValue=0}if(this.schema.maxValue===undefined){this.schema.maxValue=1}this.defaultValue=this.normalize(this.defaultValue);this.r=new exo.sceneGraph.Track(this.defaultValue.r,opts);this.g=new exo.sceneGraph.Track(this.defaultValue.g,opts);this.b=new exo.sceneGraph.Track(this.defaultValue.b,opts);this.initWatchers()},initWatchers:function(){this.root.on("timeChange",function(t){if(this.r.intermediate)this.r.clearIntermediate();if(this.g.intermediate)this.g.clearIntermediate();if(this.b.intermediate)this.b.clearIntermediate()},this)},set:function(val){val=this.normalize(val);this.r.set(val.r);this.g.set(val.g);this.b.set(val.b);return this.toJSON()},get:function(){var c=new THREE.Color;c.setRGB(this.r.get(),this.g.get(),this.b.get());return c},getAt:function(time){var c=new THREE.Color;c.setRGB(this.r.getAt(time),this.g.getAt(time),this.b.getAt(time));return c},setAt:function(val,time){val=this.normalize(val);var addR=this.r.setAt(val.r,time);var addG=this.g.setAt(val.g,time);var addB=this.b.setAt(val.b,time);if(addR||addG||addB){this.plug().trigger("add:keyFrame",this.root,this.key,time)}return this.toJSON()},setProperty:function(val,key){if(key!=="r"&&key!=="g"&&key!=="b"){throw new Error("Color property must be r,g or b: "+key)}this[key].set(val);return this.toJSON()},setPropertyAt:function(val,key,time){if(key!=="r"&&key!=="g"&&key!=="b"){throw new Error("Color property must be r,g or b: "+key)}if(this[key].setAt(val,time)){this.plug().trigger("add:keyFrame",this.root,this.key,time)}},setIntermediate:function(val,time){this.r.setIntermediate(val.r,time);this.g.setIntermediate(val.g,time);this.b.setIntermediate(val.b,time);this.triggerChange(null,time)},setIntermediateProperty:function(val,key,time){this[key].setIntermediate(val,time)},removeKey:function(time){var removeR=this.r.removeKey(time);var removeG=this.g.removeKey(time);var removeB=this.b.removeKey(time);if(removeR||removeG||removeB){this.triggerChange("remove",time)}},removePropertyAt:function(key,time){if(key!=="r"&&key!=="g"&&key!=="b"){throw new Error("Vec3 property must be r,g or b: "+key)}if(this[key].removeKey(time)){this.triggerChange("remove",time)}},toJSON:function(){return{r:this.r.toJSON(),g:this.g.toJSON(),b:this.b.toJSON()}},clearKeyFrames:function(){var result=this.r.clearKeyFrames();result=this.g.clearKeyFrames()&&result;result=this.b.clearKeyFrames()&&result;this.triggerChange("remove");return result},isKeyFramed:function(time){var result={r:this.r.isKeyFramed(time),g:this.g.isKeyFramed(time),b:this.b.isKeyFramed(time),isAll:function(type){return this.r.type===type&&this.g.type===type&&this.b.type===type}};result.key=result.isAll("key");return result.r||result.g||result.b?result:false},hasKeyFrames:function(time){return this.r.hasKeyFrames()},keyFrames:function(){return this.r.keyFrames().concat(this.g.keyFrames()).concat(this.b.keyFrames())},getKeyFrameTimes:function(){var r=this.r.getTimes();var g=this.g.getTimes();var b=this.b.getTimes();var times=r.concat(g).concat(b);times.sort(function(a,b){return a-b});return _.uniq(times)}}});exo.sceneGraph.properties.Image=exo.sceneGraph.properties.File.extend({});exo.sceneGraph.properties.Integer=exo.sceneGraph.Property.extend({normalize:function(val){var num=parseInt(val,10);if(_.isNaN(num)){num=this.value&&this.value.get?this.value.get():this.value}else{if(this.schema.minValue!==undefined){num=num<this.schema.minValue?this.schema.minValue:num}if(this.schema.maxValue!==undefined){num=num>this.schema.maxValue?this.schema.maxValue:num}num=Math.round(num*1e4)/1e4}return num},defaultValue:0,interpolationScheme:"discrete"});exo.sceneGraph.properties.JSON=exo.sceneGraph.properties.File.extend({});exo.sceneGraph.properties.Node=exo.sceneGraph.Property.extend({normalize:function(id){this.plug=this.root&&this.root.plug?this.root.plug():null;this.parentNode=this.plug?this.plug.node():null;if(!id){return this.dereference()}var scene=this.root.scene();if(!scene){this.loadId=id;return null}var node=id instanceof exo.sceneGraph.Node?id:scene.getNodeById(id);if(!node){this.loadId=id;return null}else if(this.loadId&&this.loadId!==node.id){this.loadId=null}if(this.parentNode){this.parentNode.references=this.parentNode.references||{};if(!this.canReference(node)){return this.dereference()}}if(this.value&&this.value.id&&node.id!==this.value.id){this.stopWatching(this.value);if(this.parentNode){this.parentNode.references[node.id]=undefined}}node.on("dirty",this.watch,this);node.on("removed",this.removed,this);if(this.parentNode){this.currentId=node.id;this.parentNode.references[node.id]=node}if(this.plug){this.plug.version++}return node},removed:function(node){if(!this.canReference(node)){return this.dereference()}this.stopWatching(node);this.root.ctx().set(this.key,null)},stopWatching:function(node){node.off("dirty",this.watch,this);node.off("removed",this.removed,this)},dereference:function(){if(this.parentNode&&this.currentId){this.parentNode.references[this.currentId]=undefined;this.currentId=""}return null},canReference:function(node){return this.parentNode&&node.id!==this.parentNode.id&&!node.references[this.parentNode.id]},get:function(){if(this.loadId&&(this.value===null||this.value===undefined)){var loadId=this.loadId;this.loadId=null;this.set(loadId)}return this.value},watch:function(){var parentId=this.parentNode?this.parentNode.id:"";if(this.value&&!this.value.references[parentId]&&!this.parentNode.updatingReference){if(this.plug){this.parentNode.updatingReference=true;this.root.dirty=true;this.plug.version++;this.plug.triggerDirty();this.parentNode.updatingReference=false}}},toJSON:function(){return this.loadId||this.value&&this.value.id}});exo.sceneGraph.properties.NodeList=exo.sceneGraph.Property.extend({set:function(val){val=val===null||val===undefined?[]:val;if(!_.isArray(val)){throw new Error("Expecting an array of nodes (or ids)")}this.value=this.normalize(val);return _.map(this.value,function(n){return n.id?n.id:n})},normalize:function(ids){if(!ids.length)return{};var old=this.value;ids=_.reject(ids,function(id){return id===this.root.id},this);var scene=this.root.scene();if(!scene){this.loadLater=ids;return{}}var newNodes={};var loadLater=[];_.each(ids,function(id){var node=this.findAndWatch(id,scene);if(node){newNodes[node.id]=node}else{loadLater.push(id)}},this);if(loadLater.length){this.loadLater=ids;return{}}_.each(old,function(node,id){if(!newNodes[id]){this.stopWatching(node)}},this);return newNodes},findAndWatch:function(id,scene){var node=id instanceof exo.sceneGraph.Node?id:scene.getNodeById(id);if(!node){return null}node.on("dirty",this.watch,this);node.on("removed",this.removed,this);return node},removed:function(node){this.stopWatching(node);var ids=_.map(_.reject(this.get(),function(n){return n.id===node.id}),function(n){return n.id});this.root.ctx().set(this.key,ids)},stopWatching:function(node){node.off("dirty",this.watch,this);node.off("removed",this.removed,this)},get:function(){if(this.loadLater){var loadLater=this.loadLater;this.loadLater=null;this.set(loadLater)}return _.values(this.value)
},watch:function(node){var plug=this.root.plug();var timeline=this.root.scene()&&this.root.scene().Timeline;if(timeline&&timeline.playing){if(this.lastUpdated!==plug.time){this.lastUpdated=plug.time;this.root.dirty=true;plug.triggerDirty()}}else{this.root.dirty=true;plug.triggerDirty()}},toJSON:function(){return _.keys(this.value)}});exo.sceneGraph.properties.Number=exo.sceneGraph.Property.extend({normalize:function(val){var num=Number(val);if(_.isNaN(num)){num=this.value&&this.value.get?this.value.get():this.defaultValue}else{if(this.schema.minValue!==undefined){num=num<this.schema.minValue?this.schema.minValue:num}if(this.schema.maxValue!==undefined){num=num>this.schema.maxValue?this.schema.maxValue:num}num=Math.round(num*1e4)/1e4}return num},interpolationScheme:"linear"});exo.sceneGraph.properties.Object=exo.sceneGraph.Property.extend({});exo.sceneGraph.properties.Options=exo.sceneGraph.Property.extend();exo.sceneGraph.properties.Text=exo.sceneGraph.Property.extend();exo.sceneGraph.properties.TextArea=exo.sceneGraph.Property.extend();exo.sceneGraph.properties.Vec3=exo.sceneGraph.Property.extend({normalize:function(val){if(val instanceof THREE.Vector3){}else if(_.isArray(val)){val=new THREE.Vector3(val[0],val[1],val[2])}else{val=new THREE.Vector3(val.x,val.y,val.z)}val.x=this.normalizeValue(val.x);val.y=this.normalizeValue(val.y);val.z=this.normalizeValue(val.z);return val},normalizeValue:function(val){if(this.schema.minValue!==undefined&&val<this.schema.minValue){return this.schema.minValue}if(this.schema.maxValue!==undefined&&val>this.schema.maxValue){return this.schema.maxValue}return val},setProperty:function(val,key){if(key!=="x"&&key!=="y"&&key!=="z"){throw new Error("Vec3 property must be x,y or z: "+key)}this.value[key]=this.normalizeValue(val);return this.toJSON()},toJSON:function(){return{x:this.value.x,y:this.value.y,z:this.value.z}},interpolationScheme:"custom",defaultValue:{x:0,y:0,z:0},keyFramable:{initialize:function(){var opts={normalize:this.normalizeValue.bind(this),interpolationScheme:"linear"};this.defaultValue=this.normalize(this.defaultValue);this.x=new exo.sceneGraph.Track(this.defaultValue.x,opts);this.y=new exo.sceneGraph.Track(this.defaultValue.y,opts);this.z=new exo.sceneGraph.Track(this.defaultValue.z,opts);this.tracks={x:this.x,y:this.y,z:this.z};this.initWatchers()},initWatchers:function(){this.root.on("timeChange",function(t){if(this.x.intermediate)this.x.clearIntermediate();if(this.y.intermediate)this.y.clearIntermediate();if(this.z.intermediate)this.z.clearIntermediate()},this)},set:function(val){val=this.normalize(val);this.x.set(val.x);this.y.set(val.y);this.z.set(val.z);return this.toJSON()},get:function(){return new THREE.Vector3(this.x.get(),this.y.get(),this.z.get())},setIntermediateOrNot:function(val,time){var keyframeData=val&&val.x&&val.x.keys||val&&val.y&&val.y.keys||val&&val.z&&val.z.keys;if(!keyframeData&&this.isKeyFramed(time)){return this.setIntermediate(val,time)}else{return this.set(val)}},getAt:function(time){return new THREE.Vector3(this.x.getAt(time),this.y.getAt(time),this.z.getAt(time))},setAt:function(val,time){val=this.normalize(val);var addX=this.x.setAt(val.x,time);var addY=this.y.setAt(val.y,time);var addZ=this.z.setAt(val.z,time);if(addX||addY||addZ){var plug=this.plug();if(this.root!==plug){this.root.trigger("add:keyFrame",this.root,this.key,time)}plug.trigger("add:keyFrame",this.root,this.key,time)}return this.toJSON()},setProperty:function(val,key){if(key!=="x"&&key!=="y"&&key!=="z"){throw new Error("Vec3 property must be x,y or z: "+key)}this[key].set(val);return this.toJSON()},setPropertyAt:function(val,key,time){if(key!=="x"&&key!=="y"&&key!=="z"){throw new Error("Vec3 property must be x,y or z: "+key)}if(this[key].setAt(val,time)){var plug=this.plug();if(this.root!==plug){this.root.trigger("add:keyFrame",this.root,this.key,time)}plug.trigger("add:keyFrame",this.root,this.key,time)}return this.toJSON()},setIntermediate:function(val,time){val=this.normalize(val);this.x.setIntermediate(val.x,time);this.y.setIntermediate(val.y,time);this.z.setIntermediate(val.z,time);this.triggerChange(null,time)},setIntermediateProperty:function(val,key,time){this[key].setIntermediate(val,time)},removeKey:function(time){var removeX=this.x.removeKey(time);var removeY=this.y.removeKey(time);var removeZ=this.z.removeKey(time);if(removeX||removeY||removeZ){this.triggerChange("remove",time)}},removePropertyAt:function(key,time){if(key!=="x"&&key!=="y"&&key!=="z"){throw new Error("Vec3 property must be x,y or z: "+key)}if(this[key].removeKey(time)){this.triggerChange("remove",time)}},toJSON:function(){return{x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}},clearKeyFrames:function(){var result=this.x.clearKeyFrames();result=this.y.clearKeyFrames()&&result;result=this.z.clearKeyFrames()&&result;this.triggerChange("remove");return result},isKeyFramed:function(time){var result={x:this.x.isKeyFramed(time),y:this.y.isKeyFramed(time),z:this.z.isKeyFramed(time),isAll:function(type){return this.x.type===type&&this.y.type===type&&this.z.type===type}};result.key=result.isAll("key");return result.x||result.y||result.z?result:false},hasKeyFrames:function(time){return this.x.hasKeyFrames()+this.y.hasKeyFrames()+this.z.hasKeyFrames()},keyFrames:function(){return this.x.keyFrames().concat(this.y.keyFrames()).concat(this.z.keyFrames())},getKeyFrameTimes:function(){var x=this.x.getTimes();var y=this.y.getTimes();var z=this.z.getTimes();var times=x.concat(y).concat(z);times.sort(function(a,b){return a-b});return _.uniq(times)}}});exo.sceneGraph.primitives.Camera=function(options){options=options||{};this._dirty=true};_.extend(exo.sceneGraph.primitives.Camera.prototype,{isOrthographic:function(){return this.projection==="Orthographic"},getSize:function(){return this.size||this.computeCameraSize()},computeCameraSize:function(halfSize){var tangent=Math.tan(THREE.Math.degToRad(this.fieldOfView/2));var camHeight_half=tangent*this.orthoZoom;var camWidth_half=camHeight_half*this.aspectRatio;this.size={width:camWidth_half*2,height:camHeight_half*2};if(halfSize===true){return{width:camWidth_half,height:camHeight_half}}else{return this.size}},getWidth:function(){return this.getSize().width},getHeight:function(){return this.getSize().height}});exo.sceneGraph.primitives.Light=function(options){options=options||{}};_.extend(exo.sceneGraph.primitives.Light.prototype,{getType:function(){return this.lightType||"PointLight"}});exo.sceneGraph.primitives.Material=function(options){options=options||{};this.type="primitive";this.materials={};this.userData={};this.defaultColor=(new THREE.Color).setRGB(1,1,1);this.needPolyMeshUpdate=false;this.materialCounter=0};_.extend(exo.sceneGraph.primitives.Material.prototype,{createMaterial:function(materialType,materialMode,name,material,materialNode){return{type:materialType||"Standard",mode:materialMode||"ThreeJS",name:name,material:material,nodeID:materialNode?materialNode.attributes._id:null}},getMaterialNodeID:function(){return this.materials.nodeID},hasMaterial:function(){return this.materials&&this.materials.material?true:false},getMaterialCount:function(){return this.materialCounter},getMaterialProperties:function(mIndex){var materialObject=this.getMaterial(mIndex);return materialObject?materialObject.material:null},getMaterialType:function(){if(this.hasMaterial()){return this.materials.type}else{return""}},getMaterial:function(mIndex){if(!this.hasMaterial()){return null}if(mIndex===undefined){return this.materials}else if(mIndex>=0&&mIndex<this.getMaterialCount()){if(this.materials.type==="MultiID"){return this.materials.material[mIndex]}else{return this.materials}}return null},setMaterial:function(materialObject,numMaterials){this.materials=materialObject;this.materialCounter=numMaterials?numMaterials:1},setUserData:function(userData){this.userData=userData},getUserData:function(userData){return this.userData},getMaterialFromNode:function(materialNode,returnStandard,defaultColor){if(defaultColor){this.defaultColor=defaultColor}var returnStandardMat=returnStandard!==undefined?returnStandard:true;if(materialNode&&materialNode.material&&materialNode.material.hasMaterial()){return materialNode.material.getMaterial()}else if(returnStandardMat){return this.createMaterial("Standard","ThreeJS","Standard",{diffuseColor:defaultColor||this.defaultColor,ambientColor:defaultColor||this.defaultColor,specularColor:(new THREE.Color).setHex(0)})}else{return null}}});exo.sceneGraph.primitives.Properties=function(options){options=options||{};this.visible=true;this.selectable=true;this.renderable=true};_.extend(exo.sceneGraph.primitives.Properties.prototype,{});exo.sceneGraph.primitives.Environment=function(options){options=options||{}};_.extend(exo.sceneGraph.primitives.Environment.prototype,{});exo.sceneGraph.primitives.Texture=function(options){options=options||{}};_.extend(exo.sceneGraph.primitives.Texture.prototype,{});exo.sceneGraph.primitives.Timeline=function(options){options=options||{}};_.extend(exo.sceneGraph.primitives.Timeline.prototype,highbrow.Backbone.Events,highbrow.BindTo,{frameRateTypes:{film:24,hfrFilm:48,ntsc:29.97,pal:25,custom:0},getFramesPerSecond:function(){return this.frameRateTypes[this.frameRate]||this.customFramesPerSecond},getInterval:function(){return 1/this.getFramesPerSecond()*1e3},getDuration:function(){return this.animationEndFrame-this.animationStartFrame},getForward:function(){return this.playDirection==="forward"},framesToSeconds:function(frames){return exo.math.framesToSeconds(this.framesPerSecond,frames)},secondsToFrames:function(timeInSeconds){return exo.math.secondsToFrames(this.framesPerSecond,timeInSeconds)},nextFrame:function(currentFrame){if(this.getForward()){if(currentFrame<this.animationEndFrame){return currentFrame+this.playSpeed}if(this.looping){return this.animationStartFrame}}else{if(currentFrame>this.animationStartFrame){return currentFrame-this.playSpeed}if(this.looping){return this.animationEndFrame}}return false}});exo.sceneGraph.primitives.Transform=function(options){options=options||{};this.parentNode=options.parentNode;this._localTransform=options.localTransform||new THREE.Matrix4;this._dirty=true;this._translation=new THREE.Vector3;this._rotation=new THREE.Quaternion;this._scale=new THREE.Vector3;this._worldRotatePivot=new THREE.Vector3;this._worldScalePivot=new THREE.Vector3;this._flip=false};_.extend(exo.sceneGraph.primitives.Transform.prototype,{getLocalTransform:function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;return optionalResult.copy(this._localTransform)},getLocalTransformInverse:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;return optionalResult.getInverse(this.getLocalTransform(tmpMat))}}(),setLocalTransform:function(localTransform){this._localTransform=localTransform;this._dirty=true},getWorldTransform:function(){var tmpLocalTransform=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;var pNode=this.parentNode;if(pNode){return pNode.transform.getWorldTransform(optionalResult).multiply(this.getLocalTransform(tmpLocalTransform))}else{return this.getLocalTransform(optionalResult)}}}(),getWorldTransformInverse:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;return optionalResult.getInverse(this.getWorldTransform(tmpMat))}}(),needsFlip:function(){if(this._dirty)this._update();var pNode=this.parentNode;return pNode&&pNode.transform.needsFlip()?!this._flip:this._flip},getTranslation:function(optionalResult){if(this._dirty)this._update();optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(this._translation)},getWorldTranslation:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){if(this._dirty)this._update();optionalResult=optionalResult||new THREE.Vector3;optionalResult.getPositionFromMatrix(this.getWorldTransform(tmpMat));return optionalResult}}(),getRotation:function(){var tmpVec=new THREE.Vector3;return function(optionalResult){if(this._dirty)this._update();optionalResult=optionalResult||new THREE.Vector3;return exo.math.radianToDegree(optionalResult.setEulerFromQuaternion(this._rotation,"ZYX"),optionalResult)}}(),getRotationQuaternion:function(optionalResult){if(this._dirty)this._update();optionalResult=optionalResult||new THREE.Quaternion;return optionalResult.copy(this._rotation)},getScale:function(optionalResult){if(this._dirty)this._update();optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(this._scale)},getRotationMatrix:function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;return optionalResult.setRotationFromQuaternion(this._rotation)},getWorldRotationMatrix:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Matrix4;var pNode=this.parentNode;if(pNode){return pNode.transform.getWorldRotationMatrix(optionalResult).multiply(this.getRotationMatrix(tmpMat))}else{return this.getRotationMatrix(optionalResult)}}}(),getWorldRotatePivot:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(this._worldRotatePivot)}}(),getWorldScalePivot:function(){var tmpMat=new THREE.Matrix4;return function(optionalResult){optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(this._worldScalePivot)}}(),setWorldRotatePivot:function(worldRotatePivot){this._worldRotatePivot.copy(worldRotatePivot)},setWorldScalePivot:function(worldScalePivot){this._worldScalePivot.copy(worldScalePivot)},_update:function(){this._flip=this._localTransform.decompose(this._translation,this._rotation,this._scale)[3];this._dirty=false}});exo.sceneGraph.Operator=highbrow.extend(exo.sceneGraph.SchemaBase,"Operator",{constructor:function(attrs,options){if(!attrs||!attrs.name||!attrs.primitive){throw new Error("Operator must specify name and primitive")}this.operator=exo.sceneGraph.registry.operator(attrs.primitive,attrs.name);if(this.operator===undefined){throw new Error("Undefined operator: "+attrs.primitive+", "+attrs.name)}if(this.operator.initialize)this.operator.initialize(this);this.manipulations=_.extend({},this.operator.manipulations);_.each(this.manipulations,function(manipulator,name){manipulator=this.manipulations[name]=_.extend({},manipulator);manipulator.name=name;manipulator.operator=this},this);this.schema=_.extend({},this.schema,this.operator.schema);this.bindTo(this,"change:active",this.allOperatorsDirty,this);exo.sceneGraph.SchemaBase.call(this,attrs,options)},schema:{name:{type:"Text",hidden:true},primitive:{type:"Text",hidden:true},active:{type:"Boolean",hidden:true,defaultValue:true},manipulations:{type:"Boolean",hidden:true,defaultValue:false}},triggerDirty:function(){this.version++;this.dirty=true;var plug=this.plug();if(plug)plug.triggerDirty()},plug:function(){return this.collection&&this.collection.parent},node:function(){var plug=this.plug();return plug&&plug.node()},scene:function(){var node=this.node();return node&&node.scene()},editor:function(){var scene=this.scene();return scene?scene.editor:null},path:function(){return this.plug().path()+"/"+this.id},apiName:function(){return this.collection.parent.apiName()+":"+this.get("name")},sync:function(){},apply:function(state,time){this.setTime(time);var fn=this.operator.create||this.operator.modify||this.operator.apply;if(!this.get("active")){return state}else{var newResult=fn.call(this.operator,this,state,this.time);if(this.dirty){this.dirty=false;if(this.operator.changed){this.operator.changed(newResult)}else{var plug=this.plug();if(plug){plug.modified(newResult)}}}else{newResult.changed=state.changed}return newResult}},allOperatorsDirty:function(){var plug=this.plug();if(plug){plug.allOperatorsDirty();plug.triggerDirty()}},setSchema:function(schema){this.schema=new exo.sceneGraph.Schema(schema);this.schema.init(this.attributes);this.trigger("change:schema",schema)}});exo.sceneGraph.Operators=highbrow.extend("Collection","Operators",{model:exo.sceneGraph.Operator,clear:function(){this.remove(this.toArray().reverse())}});exo.sceneGraph.Plug=highbrow.extend(exo.sceneGraph.SchemaBase,"Plug",{schema:{type:{type:"Text",hidden:true}},initialize:function(attributes,options){this.bindTo(this.operators,"add",this.allOperatorsDirty,this);this.bindTo(this.operators,"add",this.checkExtend,this);this.bindTo(this.operators,"add",this.triggerDirty,this);this.bindTo(this.operators,"remove",this.allOperatorsDirty,this);this.bindTo(this.operators,"remove",this.checkExtend,this);this.bindTo(this.operators,"remove",this.triggerDirty,this);this.bindTo(this,"change",this.triggerDirty,this);this.bindTo(this,"timeChange",this.applyTimeChange,this);this.checkExtend()},setTime:function(time){if(this.time!==time){this.time=time;this.operators.each(function(operator){operator.setTime(time)});this.trigger("timeChange",time)}},trySet:function(attrs){_.each(attrs,function(val,key){var op=this.exists(key);if(op)op.ctx().set(key,val)},this)},set:function(key,value,options){if(!this.extensions)this.extensions={};var attrs,attr,val;var opData={};var plugData={};if(_.isObject(key)||!key){attrs=key;options=value}else{attrs={};attrs[key]=value}_.each(attrs,function(val,key){if(key==="_id"||key==="type"||key==="operators"){plugData[key]=val}else{var op=this.extensions[key];if(op){if(!opData[op.id])opData[op.id]={};opData[op.id][key]=val}else{}}},this);_.each(opData,function(attrs,id){this.operators.get(id).set(attrs)},this);exo.sceneGraph.SchemaBase.prototype.set.call(this,plugData,options)},exists:function(key){return this.extensions[key]},checkExtend:function(op){var extensions=this.extensions={};this.operators.each(function(op){_.each(op.operator.schema,function(value,key){extensions[key]=op})})},exec:function(method,args){if(!this.extensions[method])return;return this.extensions[method].apply(this,args)},canProvide:{},triggerDirty:function(){this.version++;this.trigger("dirty",this);var node=this.node();if(node)node.triggerDirty()},allOperatorsDirty:function(){this.operators.each(function(op,index){op.dirty=true},this)},update:function(){this.applyOperators()},sync:function(){},plug:function(){return this},node:function(){return this.collection&&this.collection.parent},scene:function(){var node=this.node();return node&&node.scene()},editor:function(){var scene=this.scene();return scene?scene.editor:null},path:function(){var node=this.node();if(node){return this.node().path()+":"+this.get("type")}return"(null node)"+":"+this.get("type")},apiName:function(){return this.node().apiName()+":"+this.get("type")},modified:function(){},createOperator:function(name,properties){var attrs=_.extend({primitive:this.get("type"),name:name},properties||{});var operator=new exo.sceneGraph.Operator(attrs);this.operators.add(operator);return operator},addOperator:function(name,properties){return this.createOperator(name,properties)},getOperator:function(name){var op=this.operators.where({name:name});if(op.length){return op[0]}else{throw new Error("Unknown operator: "+name)}},apply:function(plug,result,time){return _.reduce(this.schema,function(memo,attr,key){memo[key]=attr.get(time);return memo},{})},isAnimated:function(){var animated=exo.sceneGraph.SchemaBase.prototype.isAnimated.call(this);if(!animated){this.operators.each(function(operator){if(operator.isAnimated())animated=true})}return animated},applyTimeChange:function(){if(this.isAnimated()){var dirty=false;this.operators.each(function(op){if(op.isAnimated()||dirty){dirty=op.dirty=true}},this);this.triggerDirty()}},applyOperators:function(){var plugName="plug.apply."+this.get("type");exo.profiling.start(plugName);this._result=this.apply(this,this.attributes,this.time);this.operators.each(function(op){try{this._result=op.apply(this._result,this.time)}catch(e){var name=op.get("name");exo.reportError(e,"OP ("+name+")","Operator Error: "+name+"\nStack: "+(e.stack!==undefined?e.stack:"undefined"))}},this);exo.profiling.stop(plugName)},destroy:function(){for(var i=this.operators.length;i>=0;--i){this.operators.remove(this.operators.at(i))}},availableOperators:function(){var choices=_.values(exo.sceneGraph.registry.operators(this.get("type")));return _.filter(choices,this.filterChoices,this)},filterChoices:function(operator){return true}},{embedded_relations:{operators:exo.sceneGraph.Operators}});Object.defineProperty(exo.sceneGraph.Plug.prototype,"primitive",{get:function(){this._resultVersion=this._resultVersion||-1;if(this._resultVersion!=this.version){this.update();this._resultVersion=this.version}else{}return this._result}});exo.sceneGraph.Plugs=highbrow.extend("Collection","Plugs",{initialize:function(){this.bindTo(this,"add",function(plug){this[plug.get("type")]=plug},this);this.bindTo(this,"remove",function(plug){delete this[plug.get("type")]},this);this.bindTo(this,"reset",this.bindAllPlugAliases,this);this.bindAllPlugAliases()},bindAllPlugAliases:function(){this.each(function(plug){this[plug.get("type")]=plug},this)},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i])}options.previousModels=this.models;this._reset();this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger("reset",this,options);this.bindAllPlugAliases();return this},model:function(attrs,options){if(!exo.sceneGraph.plugs[attrs.type]){throw new Error("Unknown plug type: "+attrs.type)}return new exo.sceneGraph.plugs[attrs.type](attrs,options)}},{createPlug:function(type,operators){if(!exo.sceneGraph.plugs[type])throw new Error("Invalid plug type: "+type);var attrs={type:type};if(_.isString(operators)){attrs.operators={name:operators,primitive:type}}else{attrs.operators=_.map(operators,function(attrs,name){return _.extend(attrs,{name:name,primitive:type})})}return new exo.sceneGraph.plugs[type](attrs)}});_.extend(exo.sceneGraph.Plugs.prototype,highbrow.BindTo);exo.sceneGraph.plugs.Bone=exo.sceneGraph.Plug.extendWith("Bone",{apply:function(plug,result){return null}});exo.sceneGraph.plugs.Camera=exo.sceneGraph.Plug.extendWith("Camera",{apply:function(){return new exo.sceneGraph.primitives.Camera}});!function(){exo.sceneGraph.plugs.GeneralRenderer=exo.sceneGraph.Plug.extendWith("GeneralRenderer",{})}();exo.sceneGraph.plugs.Light=exo.sceneGraph.Plug.extendWith("Light",{apply:function(){return new exo.sceneGraph.primitives.Light}});exo.sceneGraph.plugs.Material=exo.sceneGraph.Plug.extendWith("Material",{apply:function(){return new exo.sceneGraph.primitives.Material},isCubeMap:function(){return this.operators.last().get("name")==="CubeMap"},isMultiID:function(){return this.operators.last().get("name")==="MultiID"},isMaterialMap:function(){return this.operators.last().operator.mode==="Map"},getLastReference:function(){var referenceOp=this.getLastReferenceOp();return referenceOp?referenceOp.get("reference"):null},getLastReferenceOp:function(){var referenceOp=_.last(this.operators.filter(function(op){return op.get("name")==="Reference"}));return referenceOp},filterChoices:function(operator){var node=this.node();return!node||node.get("type")==="Material"?true:operator.name==="Reference"}});!function(){var materialTypes={Lambert:"Lambert",Phong:"Phong"};var textureFilter=function(n){return n.get("type")==="Texture"};exo.sceneGraph.plugs.MaterialDefinition=exo.sceneGraph.Plug.extendWith("MaterialDefinition",{initialize:function(attrs){exo.sceneGraph.Plug.prototype.initialize.call(this,attrs)},schema:{materialType:{label:"Material type",type:"Options",values:["Lambert","Phong"],initialValue:"Lambert"},diffuseMap:{label:"Diffuse Map",type:"Image"},diffuseColor:{label:"Diffuse",type:"Color",initialValue:function(p){return p.get("diffuse_color")||16777215},animatable:true},enbaleDiffuseFactor:{label:"Diffuse Factor ",type:"Boolean",defaultValue:false},diffuseFactor:{label:"Diffuse Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},opacityMap:{label:"Opacity Map",type:"Node",filter:textureFilter},opacityColor:{label:"Opacity",type:"Color",defaultValue:16777215,animatable:true},enbaleOpacityFactor:{label:"Opacity Factor ",type:"Boolean",defaultValue:false},opacityFactor:{label:"Opacity Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},specularMap:{label:"Specular Map",type:"Node",filter:textureFilter},specularColor:{label:"Specular",type:"Color",defaultValue:16777215,animatable:true},enbaleSpecularFactor:{label:"Specular Factor ",type:"Boolean",defaultValue:false},specularFactor:{label:"Specular Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},glossiness:{label:"Glossiness",type:"Number",defaultValue:50,minValue:0,maxValue:1e3,step:1,animatable:true},ambientMap:{label:"Ambient Map",type:"Node",filter:textureFilter},ambientColor:{label:"Ambient",type:"Color",animatable:true,initialValue:function(p){return p.get("ambient_color")||0}},enbaleAmbientFactor:{label:"Ambient Factor ",type:"Boolean",defaultValue:false},ambientFactor:{label:"Ambient Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},emissiveMap:{label:"Emissive Map",type:"Node",filter:textureFilter},emissiveColor:{label:"Emissive",type:"Color",animatable:true,initialValue:function(p){return p.get("emissive_color")||0}},enbaleEmissiveFactor:{label:"Emissive Factor ",type:"Boolean",defaultValue:false},emissiveFactor:{label:"Emissive Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},bumpMap:{label:"Bump Map",type:"Node",filter:textureFilter},bumpFactor:{label:"Bump Factor",type:"Number",defaultValue:.03,maxValue:1,minValue:0,step:.001,animatable:true},normalMap:{label:"Normal Map",type:"Node",filter:textureFilter},normalFactor:{label:"Normal Factor",type:"Number",defaultValue:1,minValue:0,maxValue:100,step:.001,animatable:true},reflection:{label:"Reflection",type:"Number",defaultValue:0,minValue:0,maxValue:1,step:.01,animatable:true},refraction:{label:"Refraction Index",type:"Number",defaultValue:.98,minValue:.3,maxValue:3,step:.01,animatable:true},vertexColors:{label:"Vertex Colors",type:"Boolean",defaultValue:false},side:{label:"Double Sided",type:"Boolean",defaultValue:false}}},{})}();exo.sceneGraph.plugs.Null=highbrow.extend(exo.sceneGraph.Plug,"Null",{apply:function(plug,result){return{nullObj:{}}}});!function(){exo.sceneGraph.plugs.Pass=exo.sceneGraph.Plug.extendWith("Pass",{})}();exo.sceneGraph.plugs.PolyMesh=exo.sceneGraph.Plug.extendWith("PolyMesh",{apply:function(plug,result){return new exo.geometry.PolyMesh},modified:function(result){result.changed.positions=true;result.changed.faces=true}});exo.sceneGraph.plugs.Properties=exo.sceneGraph.Plug.extendWith("Properties",{apply:function(){return new exo.sceneGraph.primitives.Properties}});exo.sceneGraph.plugs.Renderer=exo.sceneGraph.Plug.extendWith("Renderer",{schema:{}});exo.sceneGraph.plugs.Environment=exo.sceneGraph.Plug.extendWith("Environment",{apply:function(plug,result){return new exo.sceneGraph.primitives.Environment}});exo.sceneGraph.plugs.Texture=exo.sceneGraph.Plug.extendWith("Texture",{apply:function(plug,result){return new exo.sceneGraph.primitives.Texture}});exo.sceneGraph.plugs.Timeline=exo.sceneGraph.Plug.extendWith("Timeline",{initialize:function(attributes,options){exo.sceneGraph.Plug.prototype.initialize.call(this,attributes,options);this.updating=false;this.on("change:playing",this.timeUpdate,this);this.playing=false;this.gotoTime(this.primitive.animationStartFrame)},apply:function(){return new exo.sceneGraph.primitives.Timeline},gotoTime:function(frame){if(frame<this.primitive.animationStartFrame){frame=this.primitive.animationStartFrame}if(frame>this.primitive.animationEndFrame){frame=this.primitive.animationEndFrame}if(this.currentFrame!==frame){this.currentFrame=frame;this.trigger("change:currentFrame",this,frame)}},setPlaying:function(playing){if(this.playing!==playing){this.playing=playing;this.trigger("change:playing",this,playing)}},play:function(frame){if(frame!==undefined)this.gotoTime(frame);this.setPlaying(true)},pause:function(){this.setPlaying(false)},stop:function(){this.setPlaying(false)},gotoPercentage:function(percentage){this.gotoTime(Math.ceil(percentage*this.primitive.getDuration()))},percentageComplete:function(){return this.currentFrame/this.primitive.getDuration()},timeUpdate:function(updateNextFrame){if(this.playing&&!this.updating||updateNextFrame){this.updating=true;var updateStart=new Date;var nextFrame=this.primitive.nextFrame(this.currentFrame);var updateDelta=new Date-updateStart;if(nextFrame!==false){if(this.previousTime){exo.stats.set("fps",1e3/(new Date-this.previousTime),"FPS")}this.previousTime=new Date;this.gotoTime(nextFrame);var delta=new Date-this.previousTime;var timeout=this.primitive.getInterval()-updateDelta-delta;if(timeout<=0){setZeroTimeout(this.timeUpdate.bind(this))}else{setTimeout(this.timeUpdate.bind(this),timeout)}}else{this.stop()}this.updating=false}}});!function(){exo.sceneGraph.plugs.Transform=exo.sceneGraph.Plug.extendWith("Transform",{apply:function(plug){var node=this.node();var parent=node&&node.parentNode();return new exo.sceneGraph.primitives.Transform({parentNode:parent&&parent.Transform?parent:null})},translate:function(translation){var op=this.extensions.translation;if(op){this.scene().getCtx()([op]).set({translation:op.get("translation").add(translation)})}},rotate:function(){var vec3_tmp1=new THREE.Vector3;var tmpQuatRot=new THREE.Quaternion;var tmpQuatOff=new THREE.Quaternion;var degToRad=Math.PI/180;var radToDeg=180/Math.PI;return function(offset){var op=this.extensions.rotation;if(!op)return;var rotation=op.get("rotation");rotation.multiplyScalar(degToRad);offset.multiplyScalar(degToRad);var quatRot=tmpQuatRot.setFromEuler(rotation,"ZYX");var quatOff=tmpQuatOff;if(offset.x){vec3_tmp1.set(1,0,0);quatOff.setFromAxisAngle(vec3_tmp1,offset.x);quatRot.multiplyQuaternions(quatOff,quatRot)}if(offset.y){vec3_tmp1.set(0,1,0);quatOff.setFromAxisAngle(vec3_tmp1,offset.y);quatRot.multiplyQuaternions(quatOff,quatRot)}if(offset.z){vec3_tmp1.set(0,0,1);quatOff.setFromAxisAngle(vec3_tmp1,offset.z);quatRot.multiplyQuaternions(quatOff,quatRot)}rotation.setEulerFromQuaternion(quatRot,"ZYX");rotation.multiplyScalar(radToDeg);this.scene().getCtx()([op]).set({rotation:rotation.clone()})}}(),scale:function(delta){var op=this.extensions.scale;if(op){this.scene().getCtx()([op]).set({scale:op.get("scale").multiply(delta)})}}})}();exo.sceneGraph.Nodes=highbrow.extend("Collection","Nodes",{schema:{indices:{type:"Object",hidden:true}},initialize:function(){exo.sceneGraph.SchemaBase.prototype.buildSchema.apply(this)},model:function(attrs,options){if(!exo.sceneGraph.nodes[attrs.type]){throw new Error("Unknown Node type: ",attrs.type)}return new exo.sceneGraph.nodes[attrs.type](attrs,options)},getBoundingBox:function(useHierarchy){var combinedAABB=new THREE.Box3;var findHierarchicalAABB=function(node){combinedAABB.union(node.getAABB());node.nodes.each(findAABB,this)};var findAABB=function(node){combinedAABB.union(node.getAABB())};this.each(useHierarchy?findHierarchicalAABB:findAABB,this);return combinedAABB},getCentroid:function(manipulator,ignoreRotatePivots){return this.reduce(function(centroid,node){centroid.add(node.transform.getWorldRotatePivot());return centroid},new THREE.Vector3).divideScalar(this.length)},values:function(){return this.toArray()},clear:function(){this.remove(this.toArray())},allChildrenDepthFirst:function(){var nodes=[];var visited={};this.each(function(node){node.each(function(n){if(!visited[n.id]){nodes.push(n);visited[n.id]=n}})});nodes.reverse();return nodes}});exo.sceneGraph.VirtualNode=highbrow.extend(exo.sceneGraph.SchemaBase,"Node",{schema:{name:{type:"Text",defaultValue:"VirtualNode"},type:{type:"Text",hidden:true,defaultValue:"Null"}},defaultPlugs:{},allowedChildren:[],selectable:false,removable:true,initialize:function(attributes,options){this.references={};
this.initPlugs(options||{});this.bindTo(this.plugs,"update",function(plug){this.trigger("update",this,plug);this.trigger("update:"+plug.get("type"),this,plug)},this);this.bindTo(this.plugs,"reset",function(plugs){this.plugs.each(function(plug){this[plug.get("type")]=plug},this)},this);this.bindTo(this.nodes,"add",function(node){this.triggerDirty();this.scene().trigger("addNode",node)},this);this.bindTo(this.nodes,"remove",function(node){node.trigger("removed",node);this.triggerDirty();this.scene().trigger("removeNode",node)},this);this.dirty=true},initPlugs:function(plugOperators){var aliasPlugResult=function(node,plug){var name=plug.get("type");name=name[0].toLowerCase()+name.slice(1);Object.defineProperty(node,name,{get:function(){return plug.primitive}})};this.plugs.each(function(plug){this[plug.get("type")]=plug;this.plugs[plug.get("type")]=plug;aliasPlugResult(this,plug)},this);if(_.isArray(this.defaultPlugs)){throw new Error("defaultPlugs must be an object")}_.each(this.defaultPlugs,function(defaultOperator,plugType){if(this[plugType])return;defaultOperator=plugOperators[plugType]||defaultOperator;var plug=exo.sceneGraph.Plugs.createPlug(plugType,defaultOperator);this[plugType]=plug;this.plugs[plugType]=plug;this.plugs.add(this[plugType]);aliasPlugResult(this,plug)},this)},triggerDirty:function(){this.dirty=true;this.version++;this.trigger("dirty",this);var parent=this.parentNode();if(parent)parent.triggerDirty()},setTime:function(time){exo.sceneGraph.SchemaBase.prototype.setTime.call(this,time);this.plugs.each(function(plug){plug.setTime(time)});this.nodes.each(function(n){n.setTime(time)})},node:function(){return this},each:function(iterator,context){iterator.call(context,this);this.nodes.each(function(n){n.each(iterator,context)},context)},filter:function(iterator,context){var result=iterator(this)?[this]:[];this.nodes.each(function(n){result=result.concat(n.filter(iterator))},context);return result},find:function(iterator,context){if(iterator(this))return this;var matched;this.nodes.find(function(n){matched=n.find(iterator);return matched},context);return matched},createNode:function(node,index){if(!(node instanceof exo.sceneGraph.Node)){node=exo.sceneGraph.Nodes.prototype.model.call(this.nodes,node)}if(index!==undefined&&index!==-1){this.nodes.add(node,{at:index})}else{this.nodes.add(node)}node.setParent(this.nodes);node.root=this.root;node.setTime(this.time);return node},searchForNode:function(name){return this.nodes.where({name:name})},addNode:function(name,primitive,plugs){if(!exo.sceneGraph.nodes[primitive]){throw new Error("Invalid primitive: "+primitive)}if(!_.include(this.allowedChildren,primitive)){throw new Error("Child of `"+this.get("type")+"` not allowed to be: "+primitive)}var n=new exo.sceneGraph.nodes[primitive]({name:name,type:primitive},plugs);this.createNode(n);return n},getNode:function(name){var result=this.find(function(n){return n.get("name")===name});this.$=result;return result},getNodeById:function(id){var node=this.find(function(n){return n.id===id});this.scene().$=node;return node},isCamera:function(){return this.get("type")==="Camera"},isLight:function(){return this.get("type")==="Light"},isMesh:function(){return this.get("type")==="PolyMesh"},isPolyMesh:function(){return this.get("type")==="PolyMesh"},isMaterial:function(){return this.get("type")==="Material"},isBone:function(){return this.get("type")==="Bone"},isNull:function(){return this.get("type")==="Null"},scene:function(){if(this.root)return this.root;this.root=this.collection?this.collection.parent.scene():null;return this.root},editor:function(){var scene=this.scene();return scene?scene._editor:null},parentNode:function(){return this.collection&&this.collection.parent},getAABB:function(){if(!this.polyMesh||!this.polyMesh.positions.length){var one=new THREE.Vector3(1,1,1);var translation=this.transform?this.transform.getTranslation():new THREE.Vector3(0,0,0);return new THREE.Box3((new THREE.Vector3).subVectors(translation,one),(new THREE.Vector3).addVectors(translation,one))}return(new THREE.Box3).setFromPoints(this.polyMesh.positions).applyMatrix4(this.transform.getWorldTransform())},path:function(){if(this.collection){return this.collection.parent.path()+"/"+this.id}return"(null parent)"+"/"+this.id},apiName:function(){return this.get("name")},lookup:function(nodes,plug,operator){if(nodes.length){var node=this.nodes.get(nodes.shift());return node?node.lookup(nodes,plug,operator):null}else{if(!plug)return this;if(!this[plug])return null;if(!operator)return this[plug];return this[plug].operators.get(operator)}},toJSON:function(){var json=highbrow.Model.prototype.toJSON.call(this);if(this.isNew()){json.nodes=this.nodes.toJSON()}return json},removeIdsFromJSON:function(json){delete json._id;_.each(json.nodes,this.removeIdsFromJSON,this);_.each(json.plugs,this.removeIdsFromJSON,this);_.each(json.operators,this.removeIdsFromJSON,this);return json},clone:function(parentNode){parentNode=parentNode||this.parentNode();var json=this.removeIdsFromJSON(this.toJSON());var n=new exo.sceneGraph.nodes[json.type](json,{root:this.root});n.setTime(this.time);parentNode.createNode(n);n.set("name",this.get("name")+" Copy");return n},cloneJSON:function(){var json=this.removeIdsFromJSON(this.toJSON());json.name=this.get("name")+" Copy";json._id=uuid.v4();return json},canAddChild:function(source){return source&&source!==this&&this!==source.parentNode()&&this.isChildAllowed(source)},isChildAllowed:function(child){return this.allowedChildren.indexOf(child.get("type"))!==-1&&!this.isAncestor(child)},isAncestor:function(source){var parent=this.parentNode();var isAncestor=false;while(parent&&!isAncestor){if(parent===source){isAncestor=true}else if(parent.parent){parent=parent.parentNode()}else{parent=null}}return isAncestor},allChildrenDepthFirst:function(){var nodes=[];this.each(function(n){nodes.push(n)});nodes.reverse();return nodes},destroy:function(){this.unbindAll();Backbone.Model.prototype.destroy.call(this)},destroyAll:function(){var nodes=this.allChildrenDepthFirst();_.each(nodes,function(n){n.destroy()})},isAnimated:function(){var animated=exo.sceneGraph.SchemaBase.prototype.isAnimated.call(this);if(!animated){this.plugs.each(function(plug){if(plug.isAnimated())animated=true})}if(!animated){this.nodes.each(function(node){if(node.isAnimated())animated=true})}return animated}},{embedded_relations:{plugs:exo.sceneGraph.Plugs},relations:{nodes:exo.sceneGraph.Nodes}});exo.sceneGraph.Node=highbrow.extend(exo.sceneGraph.VirtualNode,"Node",{type:"Node",schema:{name:{type:"Text",defaultValue:"Node"},type:{type:"Text",hidden:true,defaultValue:"Null"}},destroy:function(options){this.unbindAll();options=options?_.clone(options):{};this.trigger("destroy",this,this.collection,options)}});!function(){var commandError=function(name,err){exo.reportError(err,"EXEC ("+name+")","Error running command "+name);return err};var resolveOptions=function(options,callback){var optionPromises=_.filter(options,function(value,name){return Q.isPromise(value)});if(!optionPromises.length)return callback();Q.all(optionPromises).then(function(){_.each(options,function(value,key){if(Q.isPromise(value)){options[key]=value.inspect().value}});return callback()}).fail(callback).done()};var checkIndex=function(collection,node,newIndex){if(collection.indexOf(node)!==newIndex){collection.remove(node);collection.add(node,{at:newIndex})}};var operations={set:function(ctx,obj,attrs){obj.set(attrs)},add:function(ctx,obj,data){if(data.node){var node=obj.nodes.get(data.node._id);if(node){checkIndex(obj.nodes,node,data.index)}else{obj.createNode(data.node,data.index)}}else if(data.operator){var op=obj.operators.get(data.operator._id);if(op){checkIndex(obj.operators,op,data.index)}else{if(data.index!=null&&data.index!==-1){obj.operators.add(data.operator,{at:data.index})}else{obj.operators.add(data.operator)}}}},remove:function(ctx,parent,data){if(data.node){parent.nodes.remove(data.node)}else if(data.operator){parent.operators.remove(data.operator)}},reparent:function(ctx,destParent,data){var parent=ctx.scene.getByPath(data.parent);var source=parent.nodes.get(data.node);parent.nodes.remove(source);destParent.nodes.add(source,{at:data.index})},undoreparent:function(ctx,parent,data){var source=parent.nodes.get(data.node);var destParent=ctx.scene.getByPath(data.parent);parent.nodes.remove(source);destParent.nodes.add(source,{at:data.index})},addFile:function(ctx,scene,data){var file=scene.files.get(data._id);if(file)file.set({disabled:false})},undoaddFile:function(ctx,scene,data){var file=scene.files.get(data._id);if(file)file.set({disabled:true})},exec:function(ctx,obj,data){}};operations.undoset=operations.set;operations.undoadd=operations.remove;operations.undoremove=operations.add;var undoAttrsFor=function(obj,attrs){return _.reduce(attrs,function(memo,v,key){var k=key.indexOf(".")>=0?key.split(".")[0]:key;memo[k]=obj.attributes[k];return memo},{})};var clientOperations={set:function(ctx,obj,attrs){var undoAttrs=undoAttrsFor(obj,attrs);obj.set(attrs);var newAttrs=_.reduce(attrs,function(memo,val,key){memo[key]=obj.attributes[key];return memo},{});return{result:obj,operation:{op:"set",data:newAttrs,undo:undoAttrs}}},setAt:function(ctx,obj,data){var undoAttrs=undoAttrsFor(obj,data.attrs);var newAttrs={};_.each(data.attrs,function(val,key){obj.setAt(key,val,data.time);var k=key.indexOf(".")>=0?key.split(".")[0]:key;newAttrs[k]=obj.attributes[k]});return{result:obj,operation:{op:"set",data:newAttrs,undo:undoAttrs}}},removeKeyFrame:function(ctx,obj,options){var undoAttrs={};undoAttrs[options.key]=obj.attributeToJSON(options.key);var newAttrs={};obj.removeKeyFrame(options.key,options.time);newAttrs[options.key]=obj.attributeToJSON(options.key);return{result:obj,operation:{op:"set",data:newAttrs,undo:undoAttrs}}},addNode:function(ctx,obj,data){var result=obj.createNode(data);return{result:result,operation:{op:"add",data:{node:result.toJSON()},undo:{node:result.id}}}},addOperator:function(ctx,obj,operator){obj.operators.add(operator);var result=obj.operators.get(operator.id);return{result:result,operation:{op:"add",data:{operator:result.toJSON()},undo:{operator:result.id}}}},removeNode:function(ctx,parent,nodeId){var removed=parent.nodes.get(nodeId);var index=parent.nodes.indexOf(removed);parent.nodes.remove(nodeId);return{result:removed,operation:{op:"remove",data:{node:nodeId},undo:{node:removed.toJSON(),index:index}}}},removeOperator:function(ctx,plug,operatorId){var removed=plug.operators.get(operatorId);var index=plug.operators.indexOf(removed);plug.operators.remove(operatorId);return{result:removed,operation:{op:"remove",data:{operator:operatorId},undo:{operator:removed.toJSON(),index:index}}}},reparent:function(ctx,newParent,node){var parent=node.parentNode();var prevIndex=node.collection.indexOf(node);node.collection.remove(node);newParent.nodes.add(node);var newIndex=newParent.nodes.indexOf(node);var parentPath=parent.path();return{result:node,operation:{op:"reparent",data:{node:node.id,parent:parentPath,index:newIndex},undo:{node:node.id,parent:parentPath,index:prevIndex}}}},addFile:function(ctx,scene,file,params,change,updateProgress){var deferred=Q.defer();file=exo.sceneGraph.File.create(file,{context:ctx.scene.context});file.scene=ctx.scene;if(file.isNew()){file.save({},{success:function(file,info){scene.files.add(file);deferred.resolve(file)},error:function(file,xhr,info){log.error("Error saving file: "+file.get("name"));deferred.reject(file)},progress:function(amount){updateProgress(amount*100);deferred.notify(amount*100)}})}else{deferred.resolve(file)}return{promise:deferred.promise,operation:{op:"addFile",data:{_id:file.id},undo:{_id:file.id}}}},finishExecuting:function(ctx){if(ctx.editor){ctx.editor.executingCount--;if(ctx.editor.executingCount<=0){ctx.editor.executingCount=0;ctx.editor.set("loadingCommand",false)}}},exec:function(ctx,scene,attrs,params,change,updateProgress){var deferred=Q.defer();var command=params&&params.plugin?params.plugin.command:exo.api.pluginRegistry.getCommand(attrs.key);if(!command){exo.reportError(err,"EXEC ("+attrs.key+")","Error running command, command not found");deferred.reject(err);return}var options=params&&params.options||attrs.options||{};var childCtx=exo.api.makeContext(ctx.context,{parentChange:change});var clientOps=this;if(options.node){childCtx.node=options.node}setTimeout(function(){resolveOptions(options,function(err){if(err){exo.reportError(err,"EXEC ("+command.fullName+")","Error running command, option promise failed");deferred.reject(err);return}options=new command.Options(options);var valOrPromise;try{if(ctx.editor){ctx.editor.executingCount=ctx.editor.executingCount||0;ctx.editor.executingCount++;ctx.editor.set("loadingCommand",true)}valOrPromise=command.commandFunction(childCtx,options,attrs,change)}catch(err){exo.reportError(err,"EXEC ("+command.fullName+")","Error running command");deferred.reject(err)}if(!Q.isPromise(valOrPromise)){deferred.resolve(valOrPromise);clientOps.finishExecuting(ctx)}else{valOrPromise.then(function(result){deferred.resolve(result);clientOps.finishExecuting(ctx)}).fail(function(err){exo.reportError(err,"EXEC ("+command.fullName+")","Error running command");deferred.reject(err);clientOps.finishExecuting(ctx)}).progress(updateProgress).done()}})},0);return{promise:deferred.promise,operation:{op:"exec",data:attrs}}}};exo.sceneGraph.Change=highbrow.extend("Model","Change",{initialize:function(attributes,options){if(!this.id)this.set("_id",uuid.v4(),{silent:true});if(options){if(options.ctx)this.ctx=options.ctx;if(options.scene)this.root=options.scene}this._applied={};this._ops=[];this._description=""},getValue:function(){var val=this.get("value");if(val&&typeof val==="string"){val=JSON.parse(val);this.set({value:val},{silent:true})}return val},scene:function(){if(this.root)return this.root;this.root=this.collection?this.collection.scene():null;return this.root},defaults:{status:"pending",progress:0,undo:false,increment:0,version:0},toJSON:function(){var attrs=_.extend({},this.attributes);attrs.value=JSON.stringify(this.get("value"));return attrs},heirarchicalProgress:function(){if(!this.changes.length){return this.get("progress")/100}return this.changes.reduce(function(sum,c){return sum+c.heirarchicalProgress()},0)/this.changes.length},isPending:function(){return this.get("status")==="pending"},isOK:function(){return this.get("status")==="ok"},isFailed:function(){return this.get("status")==="fail"},isSyncing:function(){return this.get("progress")<100},isSynced:function(){return this.get("progress")===100},isSameAs:function(change){if(this.get("undo")!==change.get("undo")){return false}var thisval=this.getValue();var newval=change.getValue();if(!thisval||!newval||thisval.length!=newval.length){return false}var sameAs=_.all(thisval,function(opInfo,index){return opInfo.op==="set"&&opInfo.path===newval[index].path&&_.isEqual(_.keys(opInfo.data),_.keys(newval[index].data))});return sameAs},toApi:function(){return this._description},addDescriptor:function(key,info){var types={fn:function(info){var args=_.map(info.args,JSON.stringify);return _.str.sprintf(".%s(%s)",info.fn,args.join(", "))},selector:function(info){},init:function(info){return _.str.sprintf("ctx('%s')",info.selector)}};if(types[key]){this._description+=types[key](info)}},addOperation:function(node,op,data,options){this._ops.push({node:node,op:op,data:data,options:options})},hasOp:function(op){return _.find(this.getValue(),function(info){return info.op==="op"})},createNotification:function(ctx,command,options){this.notification=new exo.models.Notification({title:command.fullName,message:(command.notificationMessage?command.notificationMessage(ctx,options):command.description)||"Running command "+command.name,persist:true});ctx.editor.notifications.add(this.notification)},evaluate:function(options){if(!options)options={};this.deferred=Q.defer();var change=this;var changeSyncing=this;if(!this.ctx)this.ctx=this.scene().getCtx();var parentChange=this.ctx.options.parentChange;if(parentChange&&parentChange.deferredSync){parentChange.addAndSync()}var value=[];var progresses=_.map(this._ops,function(){return 0});var execOp=function(info,index){var deferred=Q.defer();var updateProgress=function(amount){progresses[index]=amount;var totalProgress=_.reduce(progresses,function(memo,num){return memo+num},0)/progresses.length;changeSyncing.set({progress:totalProgress})};try{var opReturns=clientOperations[info.op](change.ctx,info.node,info.data,info.options,change,updateProgress);if(opReturns.operation){var path=info.node.path();value.push(_.extend({path:path},opReturns.operation))}if(opReturns.promise){opReturns.promise.then(function(value){updateProgress(100);deferred.resolve(value)}).fail(function(err){deferred.reject(err)})}else{updateProgress(100);deferred.resolve(opReturns.result)}}catch(e){deferred.reject(e)}return deferred.promise};var opsList=_.map(this._ops,execOp);Q.all(opsList).then(function(results){changeSyncing.set({progress:100,status:"ok"});change.deferred.resolve(opsList.length===1?results[0]:results)}).fail(function(err){changeSyncing.set({progress:100,status:"fail"});change.deferred.reject(err)}).done();if(!options.skipSettingValue){this.set("value",value)}this._applied.increment=this.get("increment");this._applied.undo=this.get("undo");if(value.length){var addImmediately=parentChange||_.any(value,function(info){return info.op!=="exec"||info.data&&info.data.options});if(addImmediately){changeSyncing=this.addAndSync()}else{this.deferredSync=true}}return this.deferred.promise},addAndSync:function(){if(this.executingServerSideCommand)return this;var changeRoot=this.ctx.options.parentChange||this.ctx.scene;var changeToSync=changeRoot.changes.addOrSet(this);if(this.ctx.scene.changeQueue)this.ctx.scene.changeQueue.addChange(changeToSync);return changeToSync},parentChangeIds:function(){return this.get("parentChange").split(":").slice(0,-1)},apply:function(){if(this._applied.increment>=this.get("increment")&&this._applied.undo===this.get("undo")){return}var change=this;var undo=this.get("undo");if(!this.ctx)this.ctx=this.scene().getCtx();var ops=[].concat(this.getValue());if(undo)ops.reverse();_.each(ops,function(info){if(undo&&!info.undo)return;var op=undo?"undo"+info.op:info.op;var obj=this.scene().getByPath(info.path);if(obj){var dataCopy=JSON.parse(JSON.stringify(undo?info.undo:info.data));operations[op](change.ctx,obj,dataCopy,{},change)}else{if(this._applied.increment!==undefined&&op==="add"){throw new Error("Unknown object: "+info.path)}}},this);if(this.isPending())this.set({status:"ok"});this._applied.increment=this.get("increment");this._applied.undo=undo},increment:function(){return++this._applied.increment},notifyProgress:function(change,depth,isChange){if(this.collection.parent instanceof exo.sceneGraph.Change){this.collection.parent.notifyProgress(change,depth+1,isChange)}this.trigger("notifyProgress",change,isChange)}},{relations:{}})}();exo.sceneGraph.Changes=highbrow.extend("Collection","Changes",{model:exo.sceneGraph.Change,urlRoot:":parent/changes",initialize:function(){this.on("change:progress",function(change,amount,options){change.notifyProgress(change,0)},this);this.on("change:status",function(change,status,options){change.notifyProgress(change,0,true)},this);this.on("change:increment",function(change,value){change.apply()});this.on("change:undo",function(change,undo){change.apply()},this);this.on("add",function(change){change.apply();change.notifyProgress(change,0,true)},this);this.on("change",function(change,options){if(!options.nosync){this.notifyChangeChange(change)}},this)},scene:function(){if(this.parent){if(this.parent instanceof exo.sceneGraph.nodes.Scene){return this.parent}return this.parent.collection.scene()}return null},notifyChangeChange:function(change){if(change.changed.value||change.changed.increment)return;if(change.changed.version&&_.size(change.changed)===1)return;var changeQueue=this.scene().changeQueue;if(changeQueue)changeQueue.changeChange(change)},addOrSet:function(change){var last=this.last();if(last&&last.isSameAs(change)){var attrs={value:_.map(change.getValue(),function(info,index){return _.extend({},info,{undo:last.getValue()[index].undo})}),increment:last.increment(),status:change.get("status")};last.set(attrs);return last}else{change.set("version",last?last.get("version")+1:0,{silent:true});highbrow.Collection.prototype.add.call(this,change);return change}},undo:function(){var c;for(var i=this.models.length-1;i>=0;i--){c=this.at(i);if(!c.get("undo")){return c}}return null},redo:function(){if(!this.models.length)return null;for(var i=this.models.length-1;i>=0;i--){if(!this.at(i).get("undo")){if(i+1>=this.models.length){return null}else{return this.at(i+1)}}}if(this.at(0).get("undo")){return this.at(0)}return null},receiveChange:function(change){var prev=this.get(change.id);if(prev){if(prev.get("increment")>change.get("increment")&&!change.isFailed()){}else{prev.set(_.pick(change.attributes,"status","value","timestamp","version","increment","undo"))}}else{this.add([change],{remove:false})}}});exo.sceneGraph.File=highbrow.extend("Model","File",{defaults:{disabled:false},urlRoot:function(){return"/api/scenes/"+this.scene.id+"/files"},constructor:function(attrs,options){attrs=attrs||{};this._generatedId=uuid.v4();this.id=attrs._id=attrs._id||this._generatedId;highbrow.Model.call(this,attrs,options);if(attrs.internal)this.set({internal:attrs.internal})},initialize:function(attrs,options){if(options&&options.droppedFile){this.droppedFile=options.droppedFile}},isNew:function(){return this._generatedId===this.id},isAsset:function(){return this.get("sourceType")==="import"||this.get("sourceType")==="export"},isImage:function(){return!!this.get("type").match(/^image/)},isGeometry:function(){return this.get("type")==="application/json"},getFileType:function(){if((this.get("type")||"").match(/^image\/.*/)){return"Image"}var extension=this.extname().toLowerCase();return exo.sceneGraph.File.extensions[extension]||extension},fetchContentSync:function(notifyFn){var content=this.content||this.get("content");if(content)return content;this.fetchContent(function(err,content){if(err)return exo.reportError(err,"Content Loading Error");notifyFn(content)});return null},fetchContent:function(callback){var content=this.content||this.get("content");if(content)return callback(null,content);var file=this;if(this.droppedFile){this.readDroppedFile(function(err,content){file.set("content",content);file.droppedFile=null;callback(null,content)})}else{var file=this;this.fetchFile(function(err,content){if(err){log.error("Resource not found: "+file.assetURL());return}file.content=content;callback(null,content)})}},fetchFile:function(callback){if(this.collection)return this.collection.fetchFile(this,callback);exo.api.loadResource(this.assetURL(),callback)},getDataURL:function(callback){return this.dataURL||this.assetURL()},loadDataURL:function(callback){if(!this.droppedFile)return callback();var file=this;this.readDroppedFile(function(err,dataURL){file.dataURL=dataURL;callback()})},readDroppedFile:function(callback){var type=this.isImage()?"DataURL":"Text";if(this.extname()===".stl")type="ArrayBuffer";var reader=new FileReader;reader.onload=function(ev){callback(null,ev.target.result)};reader["readAs"+type](this.droppedFile)},imageType:function(){return(this.get("type")||"").replace("image/","")},assetURL:function(callback){if(!this.get("assetURL")){throw new Error("file not available: "+this.id)}if(callback)callback(null,this.get("assetURL"));return this.get("assetURL")},isLocal:false,splitPath:function(filename){var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;return splitPathRe.exec(this.get("name")).slice(1)},getName:function(){var splitPath=this.splitPath();return splitPath[2].replace(splitPath[3],"")},extname:function(){return this.splitPath()[3]},hash:function(callback){if(this.get("hash"))return callback.call(this,null);if(!highbrow.browser)throw new Error("not implemented");if(this.get("content")){this.fileString=JSON.stringify(this.get("content"));this.set("hash",SparkMD5.hash(this.fileString));this.set("size",this.fileString.length);return callback.call(this,null)}var file=this.droppedFile||this.file;var that=this;var chunkSize=2097152;var chunks=Math.ceil(file.size/chunkSize);var currentChunk=0;var spark=new SparkMD5.ArrayBuffer;var readerOnload=function(e){spark.append(e.target.result);currentChunk++;if(currentChunk<chunks){loadNext()}else{that.set("hash",spark.end());callback.call(that,null)}};var readerOnerror=function(err){callback.call(that,err)};var loadNext=function(){var fileReader=new FileReader;fileReader.onload=readerOnload;fileReader.onerror=readerOnerror;var start=currentChunk*chunkSize;var end=start+chunkSize>=file.size?file.size:start+chunkSize;fileReader.readAsArrayBuffer(file.slice(start,end))};loadNext(file)},sync:function(method,model,options){var file=this;if(method!=="create"||!highbrow.browser){return highbrow.Model.prototype.sync.call(this,method,model,options)}this.hash(function(err){if(err&&options.error){options.error(model,err);return}$.ajax({type:"POST",url:file.url(),data:_.pick(file.attributes,"name","hash","type","size","sceneId","sourceType","sourceId","_id")}).fail(function(){if(options.error)options.error.apply(null,arguments)}).done(function(response){if(!response.uploadURL){if(options.success)options.success(response);return}var formData=new FormData;_.each(response.uploadParams,function(val,name){formData.append(name,val)});formData.append("file",file.file||file.droppedFile||file.fileString);var xhr=new XMLHttpRequest;xhr.open("POST",response.uploadURL,true);xhr.setRequestHeader("Content-MD5",response.hash);xhr.onload=function(e){if(e.currentTarget.status===200||e.currentTarget.status===204){if(options.success){response.uploadResponse=e.currentTarget.status;$.ajax({type:"PUT",url:file.url()+"/"+response._id,data:response}).done(function(response2){options.success(response2)}).fail(function(){if(options.error)options.error.apply(null,arguments)})}}else{if(options.error){options.error(model,e)}}};xhr.upload.addEventListener("progress",function(e){if(options.progress&&e.lengthComputable){options.progress(e.loaded/e.total)}},false);xhr.send(formData)})})}},{create:function(file,options){if(file instanceof exo.sceneGraph.File)return file;if(typeof File!=="undefined"&&file instanceof File){return exo.sceneGraph.File.fromFile(file,options)}return new exo.sceneGraph.File(file,options)},fromFile:function(file,options){if(!options)options={};var attrs=_.pick(file,"name","size","type");attrs.sourceType="import";return new exo.sceneGraph.File(attrs,_.extend({droppedFile:file},options))},extensions:{".jpg":"Image",".jpeg":"Image",".png":"Image",".bmp":"Image",".tga":"Image",".mtl":"Material",".txt":"Credits",".fbx":"FBX",".obj":"Geometry",".dae":"Collada",".jsfbx":"FBX-json",".ijsfbx":"FBX-json",".stl":"STL"}});exo.sceneGraph.Files=highbrow.extend("Collection","Files",{urlRoot:":parent/files",model:exo.sceneGraph.File,initialize:function(){this._loading={};this._saving={};this._onAdd={};this._doneSavingCallbacks=[];this.on("add",this.added,this);this.on("reset",function(collection){collection.each(this.added,this)})},assets:function(){return this.filter(function(f){return!f.get("disabled")&&f.isAsset()})},doneLoading:function(){return _.isEmpty(this._loading)},isLoading:function(file){return this._loading[file.id]},numLoading:function(){return _.size(this._loading)},fetchFile:function(file,callback){var collection=this;if(this._loading[file.id]){this._loading[file.id].push(callback);return}else{this._loading[file.id]=[callback]}collection.trigger("loading",_.size(this._loading));exo.api.loadResource(file.assetURL(),function(err,content){_.each(collection._loading[file.id],function(cb){cb(err,content)});delete collection._loading[file.id];if(collection.doneLoading()){collection.trigger("doneLoading",collection)}})},isSaving:function(){return false},onAdd:function(id,callback){this._onAdd[id]=this._onAdd[id]||[];this._onAdd[id].push(callback)},added:function(file){if(this._onAdd[file.id]){_.each(this._onAdd[file.id],function(cb){cb(null,file)});delete this._onAdd[file.id]}},onDoneSaving:function(callback){callback()},handle:function(){if(this.context&&this.context.webSocket){this.collectionQueue=new exo.CollectionQueue(this.context.webSocket,this,this.url().slice(4))}},saveOnAdd:function(){var files=this;this.on("add",function(file,coll,options){if(file.isNew()){files._saving[file.id]=file;file.save({},{success:function(file,info){files.doneSaving(file)},error:function(file,xhr,info){files.doneSaving(file);log.error("Error saving file: "+file.get("name"),xhr,info)}})}})},isSaving:function(){return _.size(this._saving)},doneSaving:function(file){delete this._saving[file.id];if(_.isEmpty(this._saving)){this.trigger("doneSaving",this);_.each(this._doneSavingCallbacks,function(cb){cb()});this._doneSavingCallbacks=[]}},onDoneSaving:function(callback){if(!this.isSaving())return callback();this._doneSavingCallbacks.push(callback)}});exo.sceneGraph.nodes.Bone=exo.sceneGraph.Node.extendWith("Bone",{type:"Bone",schema:{name:{label:"Name",type:"Text",defaultValue:"Bone"},type:{type:"Text",defaultValue:"Bone",hidden:true}},defaultPlugs:{Bone:"Bone",Transform:"BoneTransform",Properties:"Default"},allowedChildren:["PolyMesh","Bone","Dummy","Null"],selectable:true,removable:true});!function(){exo.sceneGraph.nodes.Camera=exo.sceneGraph.Node.extendWith("Camera",{type:"Camera",schema:{name:{label:"Name",type:"Text",defaultValue:"Camera"},type:{type:"Text",defaultValue:"Camera",hidden:true}},defaultPlugs:{Camera:"Camera",Transform:"Transform",Properties:"Default"},allowedChildren:["PolyMesh","Camera","Light","Null"],selectable:true,removable:true,detachable:true,OrbitType:{WorldCenter:0,SelectionCenter:1,SubSelectionCenter:2,TargetCenter:3,ViewCenter:4},initializeFor:function(viewType,rect){var cameraSetting=cameraSettings[viewType];if(!cameraSetting)return;this.centerViewDirection=null;this.plugs.Properties.ctx().set({visible:false});if(viewType==="perspective"){this.plugs.Camera.ctx().set({zoomAxis:cameraSetting.zoomAxis,axisDirection:cameraSetting.axisDirection,aspectRatio:rect.width/rect.height,projection:"Perspective"})}else{this.plugs.Camera.ctx().set({zoomAxis:cameraSetting.zoomAxis,axisDirection:cameraSetting.axisDirection,aspectRatio:rect.width/rect.height,projection:"Orthographic",orthoZoom:5})}var Transform={translation:cameraSetting.translation,rotation:cameraSetting.rotation};if(viewType==="perspective"){var rotation=cameraSetting.rotation;var rotV=new THREE.Vector3(rotation[0],rotation[1],rotation[2]).multiplyScalar(Math.PI/180);var quat=(new THREE.Quaternion).setFromEuler(rotV);rotV.setEulerFromQuaternion(quat,"ZYX").multiplyScalar(180/Math.PI);Transform.rotation=[rotV.x,rotV.y,rotV.z]}this.plugs.Transform.ctx().set(Transform);this.ctx().set("name",_.str.humanize(viewType))},isOrthographic:function(){return this.camera.projection==="Orthographic"},hasOperators:function(){return this.plugs.Transform.operators.length&&this.plugs.Camera.operators.length},zoom:function(delta,viewport,displayScene,fixedSpeed){if(this.hasOperators()){var newCameraPos=new THREE.Vector3;if(this.camera.projection==="Orthographic"){this.plugs.Camera.ctx().set("orthoZoom",this.camera.orthoZoom-this.camera.orthoZoom*delta)}else{var origPosition=this.transform.getTranslation();var centerViewDirection;if(!this.centerViewDirection){centerViewDirection=this.createCenterViewTarget(viewport,displayScene);if(!centerViewDirection){return}this.centerViewDirection=centerViewDirection}else{centerViewDirection=this.centerViewDirection}var orbitPoint=centerViewDirection.clone().add(origPosition);var dv=orbitPoint.clone().sub(origPosition);var originMoveDist=dv.length()*delta;if(!fixedSpeed){originMoveDist*=origPosition.length()}newCameraPos.subVectors(orbitPoint,origPosition).normalize();
newCameraPos.multiplyScalar(originMoveDist).add(origPosition);if(newCameraPos.length()>=this.camera.farClip){return}if(!this.Transform.scene()){this.plugs.Transform.ctx().set("translation",newCameraPos)}else{newCameraPos.sub(origPosition);this.plugs.Transform.translate(newCameraPos)}}}},getOrthoAxis:function(){switch(this.camera.zoomAxis){case 0:return[2,1,0];case 1:return[0,2,1];case 2:return[0,1,2]}return null},pan:function(){var delta=new THREE.Vector3;var upVec=new THREE.Vector3;var rightVec=new THREE.Vector3;return function(deltaX,deltaY,viewport,displayScene){if(this.hasOperators()){var origPosition=this.transform.getTranslation();var orthoAxis=this.getOrthoAxis();if(this.camera.projection==="Orthographic"&&orthoAxis){if(orthoAxis){var axisDir=this.camera.axisDirection||[-1,1];var viewSize=viewport.getViewRect();var threeCamera=displayScene.getThreeCamera(viewport);var deltaPan=this.camera.getWidth()/viewSize.width;delta.setComponent(orthoAxis[0],axisDir[0]*-deltaX*deltaPan);delta.setComponent(orthoAxis[1],axisDir[1]*deltaY*deltaPan)}if(!this.Transform.scene()){this.plugs.Transform.ctx().set({translation:origPosition.add(delta)})}else{this.plugs.Transform.translate(delta)}}else{var orbitPoint=this.camera.target;var fov=THREE.Math.degToRad(this.camera.fieldOfView);var size=viewport.getViewRect();var fromFocusDist=delta.subVectors(origPosition,orbitPoint).length();var optimizedViewerDepth=-fromFocusDist*Math.tan(fov*.5);var rotQuat=this.transform.getRotationQuaternion();upVec.set(0,1,0).applyQuaternion(rotQuat);rightVec.set(-1,0,0).applyQuaternion(rotQuat);deltaX*=-1;deltaY*=-1;var focalDeltaX=deltaX/size.width;var focalDeltaY=deltaY/size.width;rightVec.multiplyScalar(focalDeltaX*optimizedViewerDepth);upVec.multiplyScalar(focalDeltaY*optimizedViewerDepth);delta.addVectors(rightVec,upVec);if(!this.Transform.scene()){this.plugs.Transform.ctx().set("translation",(new THREE.Vector3).addVectors(delta,origPosition));this.plugs.Camera.ctx().set("target",this.camera.target.clone().add(delta))}else{this.plugs.Transform.translate(delta);this.plugs.Camera.ctx().set("target",this.camera.target.clone().add(delta))}}}}}(),orbit:function(){var cloYawQuat=new THREE.Quaternion;var cloPitQuat=new THREE.Quaternion;var tmpAxis=new THREE.Vector3;var plane=new THREE.Plane;var viewCenterLine=new THREE.Line3;var viewCenterTarget=new THREE.Vector3;var normalView=new THREE.Vector3;var orbitPoint;var updateViewCenter=false;return function(deltaX,deltaY,orbitType,viewport,displayScene){if(this.hasOperators()){if(this.camera.isOrthographic()){return this.pan(deltaX,deltaY,viewport,displayScene)}this.centerViewDirection=null;var origPosition=this.transform.getTranslation();if(orbitType===this.OrbitType.SubSelectionCenter||orbitType===this.OrbitType.SelectionCenter||orbitType===this.OrbitType.WorldCenter){orbitPoint=displayScene.getCentroid();updateViewCenter=true}else if(orbitType===this.OrbitType.ViewCenter){if(updateViewCenter){orbitPoint=this.createCenterViewTarget(viewport,displayScene,origPosition);normalView.subVectors(origPosition,orbitPoint).normalize();var threeCamera=displayScene.getThreeCamera(viewport);viewCenterLine.set(origPosition,normalView.clone().negate().multiplyScalar(threeCamera.far));plane.setFromNormalAndCoplanarPoint(normalView,this.camera.target);if(plane.intersectLine(viewCenterLine,viewCenterTarget)){orbitPoint=viewCenterTarget;updateViewCenter=false}else{orbitPoint=this.camera.target}}else{orbitPoint=this.camera.target}}else if(orbitType===this.OrbitType.TargetCenter){orbitPoint=this.camera.target;updateViewCenter=true}else{orbitPoint=displayScene.getCentroid();updateViewCenter=true}if(origPosition.equals(orbitPoint))return;var fromFocus=this.transform.getRotation();fromFocus.subVectors(origPosition,orbitPoint);tmpAxis.set(0,1,0);var yawQuat=cloYawQuat.setFromAxisAngle(tmpAxis,THREE.Math.degToRad(-deltaX*.5));tmpAxis.set(1,0,0).applyQuaternion(this.transform.getRotationQuaternion());var pitchQuat=cloPitQuat.setFromAxisAngle(tmpAxis,THREE.Math.degToRad(-deltaY*.5));fromFocus=fromFocus.applyQuaternion(pitchQuat);fromFocus=fromFocus.applyQuaternion(yawQuat);tmpAxis.addVectors(orbitPoint,fromFocus);if(!this.Transform.scene()){this.plugs.Transform.ctx().set({translation:tmpAxis,rotation:exo.math.radianToDegree(fromFocus.setEulerFromQuaternion(yawQuat.multiply(pitchQuat.multiply(this.transform.getRotationQuaternion())),"ZYX"))});this.plugs.Camera.ctx().set("target",orbitPoint.clone())}else{tmpAxis.sub(origPosition);this.Transform.translate(tmpAxis);this.Transform.rotate(exo.math.radianToDegree(fromFocus.setEulerFromQuaternion(yawQuat.multiply(pitchQuat),"ZYX")))}}}}(),createCenterViewTarget:function(viewport,displayScene,originPoint){var projector=new THREE.Projector;var origin=new THREE.Vector3(0,0,-1);var target=new THREE.Vector3(0,0,1);var threeCamera=displayScene.getThreeCamera(viewport);projector.unprojectVector(origin,threeCamera);projector.unprojectVector(target,threeCamera);var centerView=new THREE.Vector3;if(!threeCamera){return centerView}centerView.subVectors(target,origin).normalize();if(originPoint){return centerView.add(originPoint)}else{return centerView}}});var cameraSettings={front:{translation:[0,0,15],rotation:[0,0,0],zoomAxis:2,axisDirection:[1,1]},back:{translation:[0,0,-15],rotation:[0,180,0],zoomAxis:2,axisDirection:[-1,1]},top:{translation:[0,15,0],rotation:[-90,0,0],zoomAxis:1,axisDirection:[1,-1]},bottom:{translation:[0,-15,0],rotation:[90,0,0],zoomAxis:1,axisDirection:[1,1]},left:{translation:[-15,0,0],rotation:[0,-90,0],zoomAxis:0,axisDirection:[1,1]},right:{translation:[15,0,0],rotation:[0,90,0],zoomAxis:0,axisDirection:[-1,1]},perspective:{translation:[4,4,4],rotation:[-45,33,29]}}}();exo.sceneGraph.nodes.Light=exo.sceneGraph.Node.extendWith("Light",{type:"Light",schema:{name:{label:"Name",type:"Text",defaultValue:"Light"},type:{type:"Text",defaultValue:"Light",hidden:true}},defaultPlugs:{Light:"PointLight",Transform:"Transform",Properties:"Default"},allowedChildren:["PolyMesh","Camera","Light","Null"],selectable:true,removable:true});exo.sceneGraph.nodes.Material=exo.sceneGraph.Node.extendWith("Material",{type:"Material",schema:{name:{label:"Name",type:"Text",defaultValue:"Material"},type:{type:"Text",defaultValue:"Material",hidden:true}},defaultPlugs:{Material:"Standard"},selectable:false,removable:true});exo.sceneGraph.nodes.MaterialLibrary=exo.sceneGraph.Node.extendWith("MaterialLibrary",{type:"MaterialLibrary",schema:{name:{label:"Name",type:"Text",defaultValue:"Material Library"},type:{type:"Text",defaultValue:"MaterialLibrary",hidden:true}},allowedChildren:["Material"],selectable:false,removable:false});exo.sceneGraph.nodes.Null=exo.sceneGraph.Node.extendWith("Null",{type:"Null",schema:{name:{label:"Name",type:"Text",defaultValue:"Null"},type:{type:"Text",defaultValue:"Null",hidden:true}},defaultPlugs:{Null:"Null",Transform:"Transform",Properties:"Default"},allowedChildren:["PolyMesh","Bone","Camera","Light","Null"],selectable:true,removable:true});exo.sceneGraph.nodes.Objects=highbrow.extend(exo.sceneGraph.Node,"Objects",{type:"Objects",schema:{name:{label:"Name",type:"Text",defaultValue:"Objects"},type:{type:"Text",defaultValue:"Objects",hidden:true}},allowedChildren:["PolyMesh","Bone","Camera","Light","Null"],selectable:false,removable:false,initObjects:function(){}});exo.sceneGraph.nodes.Pass=exo.sceneGraph.Node.extendWith("Pass",{type:"Pass",schema:{name:{label:"Name",type:"Text",defaultValue:"Pass"},type:{type:"Text",defaultValue:"Pass",hidden:true}},defaultPlugs:{Pass:"Pass"},allowedChildren:[],selectable:false,removable:true,userFlag:"render"});exo.sceneGraph.nodes.Passes=highbrow.extend(exo.sceneGraph.Node,"Passes",{type:"Passes",schema:{name:{label:"Name",type:"Text",defaultValue:"Passes"},type:{type:"Text",defaultValue:"Passes",hidden:true}},defaultPlugs:{GeneralRenderer:"GeneralRenderer"},allowedChildren:["Pass"],selectable:false,removable:false,userFlag:"render",initObjects:function(scene){}});exo.sceneGraph.nodes.PolyMesh=exo.sceneGraph.Node.extendWith("PolyMesh",{type:"PolyMesh",schema:{name:{label:"Name",type:"Text",defaultValue:"PolyMesh"},type:{type:"Text",defaultValue:"PolyMesh",hidden:true}},defaultPlugs:{PolyMesh:"Box",Transform:"Transform",Properties:"PolyMeshProperties",Material:"Reference"},allowedChildren:["PolyMesh","Camera","Light","Null"],selectable:true,subSelectable:{Vertex:true,Edge:true,Face:true},removable:true});exo.sceneGraph.nodes.Renderer=exo.sceneGraph.Node.extendWith("Renderer",{type:"Renderer",schema:{name:{label:"Name",type:"Text",defaultValue:"Renderer"},type:{type:"Text",defaultValue:"Renderer",hidden:true}},defaultPlugs:{Renderer:null},selectable:false,removable:true,userFlag:"render"});exo.sceneGraph.nodes.Renderers=highbrow.extend(exo.sceneGraph.Node,"Renderers",{type:"Renderers",schema:{name:{label:"Name",type:"Text",defaultValue:"Renderers"},type:{type:"Text",defaultValue:"Renderers",hidden:true}},allowedChildren:["Renderer"],selectable:false,removable:false,userFlag:"render",initObjects:function(){}});!function(){exo.sceneGraph.Scene=exo.sceneGraph.nodes.Scene=exo.sceneGraph.Node.extendWith("Scene",{type:"Scene",schema:{name:{label:"Name",type:"Text",defaultValue:"Untitled Scene"},type:{type:"Text",defaultValue:"Scene",hidden:true}},defaultPlugs:{Environment:"Environment",Timeline:"Timeline"},allowedChildren:["MaterialLibrary","Objects","Passes","Renderers"],constructor:function(){this.root=this;this.objectsLoaded=false;exo.sceneGraph.Node.apply(this,arguments)},initialize:function(){exo.sceneGraph.Node.prototype.initialize.call(this);this.bindTo(this.files,"doneLoading",function(){this.trigger("loaded",this)},this)},initObjects:function(){this.objectsRootNode=this.nodes.find(function(n){return n.get("type")==="Objects"});if(!this.objectsRootNode){this.objectsRootNode=this.addNode("Objects","Objects");this.objectsRootNode.initObjects()}this.defaultMaterialLibrary=this.nodes.find(function(n){return n.get("type")==="MaterialLibrary"});if(!this.defaultMaterialLibrary){this.defaultMaterialLibrary=this.addNode("Material Library","MaterialLibrary")}if(!this.nodes.find(function(n){return n.get("type")==="Renderers"})){var renderers=this.addNode("Renderers","Renderers");renderers.initObjects()}if(!this.nodes.find(function(n){return n.get("type")==="Passes"})){var passes=this.addNode("Passes","Passes");passes.initObjects(this)}this.objectsLoaded=true;this.trigger("objectsLoaded",this)},initMaterials:function(){this.defaultMaterialLibrary=this.nodes.find(function(n){return n.get("type")==="MaterialLibrary"});if(!this.defaultMaterialLibrary){this.defaultMaterialLibrary=this.addNode("Material Library","MaterialLibrary")}},selectable:false,removable:false,getCtx:function(){if(this._ctx)return this._ctx;this._ctx=exo.api.makeContext({editor:this._editor,scene:this},this.context);return this._ctx},textures:{},script:function(script){script=typeof script==="function"?script.toString():"function(){"+script+"}";var api={};api.scene=this;var code="with (api) { ("+script+").call(); }";var fn=new Function("api",code);fn(api)},path:function(){return this.id},getByPath:function(path,getParent){var parts=path.split(":");var nodes=(parts[0]||"").split("/");nodes=nodes.slice(1);if(getParent)nodes.pop();var rhs=(parts[1]||"").split("/");if(!nodes.length)return this;var node=this.nodes.get(nodes.shift());return node?node.lookup(nodes,rhs[0],rhs[1]):null},urlRoot:"/api/scenes",hasAccess:function(usernameOrEmail){if(this.get("owner")===usernameOrEmail)return true;var accessList=this.get("access")||[];return _.find(accessList,function(info){return info.username===usernameOrEmail||info.email===usernameOrEmail})},addAccess:function(info){var accessList=this.get("access")||[];this.set("access",null);this.set("access",accessList.concat([info]))},removeAccess:function(usernameOrEmail){var accessList=this.get("access")||[];accessList=_.reject(accessList,function(info){return info.username===usernameOrEmail||info.email===usernameOrEmail});this.set("access",null);this.set("access",accessList)},addPluginAccess:function(info){var accessList=this.get("pluginAccess")||[];this.set("pluginAccess",null);this.set("pluginAccess",accessList.concat([info]))},removePluginAccess:function(info){var accessList=this.get("pluginAccess")||[];accessList=_.reject(accessList,function(i){return info.pluginName===i.pluginName&&info.pluginType===i.pluginType});this.set("pluginAccess",null);this.set("pluginAccess",accessList)},handle:function(changeQueue){var options=_.extend({changeQueue:changeQueue},this.context);if(!options.changeQueue&&options.webSocket){options.changeQueue=new exo.ChangeQueue(options.webSocket,this)}this.changeQueue=options.changeQueue;this._ctx=exo.api.makeContext({editor:this._editor,scene:this},options);this.files.handle()},destroy:function(options){this.unbindAll();highbrow.Backbone.Model.prototype.destroy.call(this);options=options?_.clone(options):{};this.trigger("destroy",this,this.collection,options)},whenLoaded:function(callback){if(this.files.doneLoading())return callback();this.once("loaded",callback)}});exo.sceneGraph.nodes.Scene.relations.changes=exo.sceneGraph.Changes;exo.sceneGraph.nodes.Scene.relations.files=exo.sceneGraph.Files;exo.sceneGraph.Change.relations={scene:exo.sceneGraph.nodes.Scene,changes:exo.sceneGraph.Changes}}();exo.sceneGraph.nodes.Texture=exo.sceneGraph.Node.extendWith("Texture",{type:"Texture",schema:{name:{label:"Name",type:"Text",defaultValue:"Texture"},type:{type:"Text",defaultValue:"Texture",hidden:true}},defaultPlugs:{Texture:"Image"},selectable:false,removable:true});exo.sceneGraph.nodes.Textures=exo.sceneGraph.Node.extendWith("Textures",{type:"Textures",schema:{name:{label:"Name",type:"Text",defaultValue:"Textures"},type:{type:"Text",defaultValue:"Textures",hidden:true}},allowedChildren:["Texture"],selectable:false,removable:false});exo.sceneGraph.Scenes=highbrow.extend("Collection","Scenes",{urlRoot:"/api/scenes",model:exo.sceneGraph.Scene},{fetchByType:function(pluginType,callback){var scenes=new exo.sceneGraph.Scenes;scenes.fetch({data:{pluginType:pluginType},success:callback});return scenes},fetchByNameType:function(pluginName,pluginType,callback){var scenes=new exo.sceneGraph.Scenes;scenes.fetch({data:{pluginName:pluginName,pluginType:pluginType},success:callback});return scenes}});exo.models.AdminInfo=highbrow.extend("Model","AdminInfo",{urlRoot:"/api/admin/info"});exo.models.Application=highbrow.extend("Model","Application",{urlRoot:"/api/applications",validations:{required:["email"]}});exo.models.Applications=highbrow.extend("PaginatedCollection","Applications",{urlRoot:"/api/applications",model:exo.models.Application,perPage:5e3});exo.models.Command=highbrow.extend("Model","Command",{});exo.models.Commands=highbrow.extend("Collection","Commands",{model:exo.models.Command});exo.models.CommandOptions=highbrow.extend(exo.sceneGraph.SchemaBase,"CommandOptions",{progress:function(amount){this.trigger("progress",amount)}});exo.models.Err=highbrow.extend("Model","Err",{urlRoot:"/api/errors"},{create:function(message,user,statusCode){var model=new exo.models.Err({message:message,owner:user&&user.get("username"),title:exo.models.Err.errors[statusCode],status:statusCode});model.status=statusCode;return model},errors:{404:"Not Found",401:"Unauthorized",403:"Forbidden",500:"Error"}});exo.models.Errs=highbrow.extend("PaginatedCollection","Errs",{urlRoot:"/api/errors",model:exo.models.Err,perPage:20});exo.models.Layout=highbrow.extend("Model","Layout",{defaults:{leftCollapsed:false,leftWidth:200,rightCollapsed:false,rightWidth:275,bottomCollapsed:false,bottomHeight:200,active:{properties:true,script:true},tabs:{left:[],right:[],bottom:[]}},setResize:function(panel,size){var key=panel+(panel==="bottom"?"Height":"Width");if(size===undefined)size=this.get(key);if(size<this.COLLAPSE_UNDER){this.set(panel+"Collapsed",true)}else{this.set(key,size);this.set(panel+"Collapsed",false)}},TIMELINE_HEIGHT:28,COLLAPSED_WIDTH:20,COLLAPSE_UNDER:150},{views:{}});exo.models.Manipulator=function(options){options=options||{};this.defaultHandleInfo={x:true,y:true,z:true};this.editor=options.editor;this.Object=_.clone(this.Object);this.Vertex=_.clone(this.Vertex);this.Face=_.clone(this.Face);this.Edge=_.clone(this.Edge);this.Operator=_.clone(this.Operator);this.Object.editor=options.editor;this.Vertex.editor=options.editor;this.Face.editor=options.editor;this.Edge.editor=options.editor;this.Operator.editor=options.editor;this.Object.manipulator=this;this.Vertex.manipulator=this;this.Face.manipulator=this;this.Edge.manipulator=this;this.Operator.manipulator=this;this.initialize(options)};exo.models.Manipulator.extend=Backbone.Model.extend;_.extend(exo.models.Manipulator.prototype,{initialize:function(options){},Object:{manipulate:function(moveInfo,handleInfo){},confirm:function(moveInfo,handleInfo){this.manipulate(moveInfo,handleInfo)}},Vertex:{manipulate:function(moveInfo,handleInfo){},confirm:function(moveInfo,handleInfo){this.manipulate(moveInfo,handleInfo)}},Face:{manipulate:function(moveInfo,handleInfo){this.manipulator.Vertex.manipulate(moveInfo,handleInfo)},confirm:function(moveInfo,handleInfo){this.manipulator.Vertex.confirm(moveInfo,handleInfo)}},Edge:{manipulate:function(moveInfo,handleInfo){this.manipulator.Vertex.manipulate(moveInfo,handleInfo)},confirm:function(moveInfo,handleInfo){this.manipulator.Vertex.confirm(moveInfo,handleInfo)}},Operator:{manipulate:function(moveInfo,handleInfo,operator){},confirm:function(moveInfo,handleInfo,operator){this.manipulate(moveInfo,handleInfo,operator)}}});!function(){var Helper=exo.models.manipulators.Helper={};Helper.__proj=new THREE.Projector;Helper.__ll=new THREE.Vector3;Helper.__tr=new THREE.Vector3;Helper.__cx=new THREE.Vector3;Helper.__cy=new THREE.Vector3;Helper.__x=new THREE.Vector3(1,0,0);Helper.__y=new THREE.Vector3(0,1,0);Helper.__z=new THREE.Vector3(0,0,1);Helper.getAxialFactors=function(cameraDisplayNode,centroid){var threeCamera=cameraDisplayNode.camera;var camRot=(new THREE.Matrix4).extractRotation(threeCamera.matrixWorld);var depth=Helper.__proj.projectVector(centroid,threeCamera).z;var ll=Helper.__ll.set(-1,-1,depth).applyMatrix4(threeCamera.projectionMatrixInverse);var tr=Helper.__tr.set(1,1,depth).applyMatrix4(threeCamera.projectionMatrixInverse);var scrRight=Helper.__cx.set(1,0,0).applyMatrix4(camRot).multiplyScalar(tr.x-ll.x);var scrUp=Helper.__cy.set(0,-1,0).applyMatrix4(camRot).multiplyScalar(tr.y-ll.y);var x=Helper.__x,y=Helper.__y,z=Helper.__z;return{right:new THREE.Vector3(scrRight.dot(x),scrRight.dot(y),scrRight.dot(z)),up:new THREE.Vector3(scrUp.dot(x),scrUp.dot(y),scrUp.dot(z))}};Helper.addTransformOperator=function(subSelection,options){var node=subSelection.node();var plug=node.PolyMesh;plug.ctx().addOperator("TransformVertices",options)},Helper.transformOperatorExists=function(subSelection){var node=subSelection.node();var plug=node.PolyMesh;var operator=plug?plug.activeOperator||plug.operators.last():null;var indices=subSelection.getVertices();var oldOperatorIsTransform=operator?operator.get("name")==="TransformVertices":false;if(!oldOperatorIsTransform||oldOperatorIsTransform&&operator.get("vertexIndices")!==exo.geometry.GeometryUtils.arrayIndicesToString(indices)){return null}return operator};Helper.snapVector=function(model,key,gridSnapping,handleInfo,noZero){if(gridSnapping){var vector;model.operators.each(function(op){if(op.get(key))vector=op.get(key)});if(handleInfo.x){vector.x=gridSnapping*Math.round(vector.x/gridSnapping)}if(handleInfo.y){vector.y=gridSnapping*Math.round(vector.y/gridSnapping)}if(handleInfo.z){vector.z=gridSnapping*Math.round(vector.z/gridSnapping)}if(noZero){vector.x=vector.x||gridSnapping;vector.y=vector.y||gridSnapping;vector.z=vector.z||gridSnapping}model.ctx().set(key,vector)}}}();!function(){var proj=new THREE.Projector;var p=new THREE.Plane;var x=new THREE.Vector3;var y=new THREE.Vector3;var v1=new THREE.Vector3;var v2=new THREE.Vector3;var v3=new THREE.Vector3;var v4=new THREE.Vector3;var zeroVector=new THREE.Vector3;var tmpMat=new THREE.Matrix4;var X=1,Y=2,Z=4;var XY=X|Y;var XZ=X|Z;var YZ=Y|Z;var XYZ=X|Y|Z;exo.models.manipulators.Move=exo.models.Manipulator.extend({intialize:function(options){this.defaultHandleInfo={x:true,y:false,z:true}},Object:{manipulate:function(moveInfo,handleInfo){var deltaVector=this.manipulator.deltaVector(moveInfo,handleInfo);var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){v1.copy(deltaVector);var transform=node.Transform;var pNode=transform.primitive.parentNode;if(pNode){pNode.Transform.primitive.getWorldTransformInverse(tmpMat);v1.apply3x3InMatrix4(tmpMat)}transform.translate(v1)}).end()},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("moveSnapping");if(gridSnapping){var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){exo.models.manipulators.Helper.snapVector(node.Transform,"translation",gridSnapping,handleInfo)}).end()}}},Vertex:{manipulate:function(moveInfo,handleInfo){var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);var ctx=this.editor.getCtx();var options=this.manipulator.getTranformVertices(subSelection,moveInfo,handleInfo,operator);if(operator){ctx(operator).set(options)}else{operator=exo.models.manipulators.Helper.addTransformOperator(subSelection,options)}},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("moveSnapping");var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);if(gridSnapping&&operator){exo.models.manipulators.Helper.snapVector(operator,"translation",gridSnapping,handleInfo)}}},Operator:{manipulate:function(moveInfo,handleInfo,operator,callback){callback(operator,this.manipulator.deltaVector(moveInfo,handleInfo),this.editor.subSelection,moveInfo,handleInfo)}},getTranformVertices:function(subSelection,moveInfo,handleInfo,operator){var indices=subSelection.getVertices();var previousDelta=operator?operator.get("translation"):zeroVector;var currentDelta=this.deltaVector(moveInfo,handleInfo);subSelection.node().Transform.primitive.getWorldTransformInverse(tmpMat);currentDelta.apply3x3InMatrix4(tmpMat);currentDelta.add(previousDelta);return{vertexIndices:exo.geometry.GeometryUtils.arrayIndicesToString(indices),translation:currentDelta}},deltaVector:function(moveInfo,handleInfo){if(!moveInfo.deltaX&&!moveInfo.deltaY)return new THREE.Vector3(0,0,0);var selected=this.editor.selected;var viewport=this.editor.currentViewport;var camera=viewport.camera;var displayScene=this.editor.displayScene;handleInfo=handleInfo||_.clone(this.defaultHandleInfo);var activeManipulator=this.editor.currentManipulator();var cameraDisplayNode=displayScene.get(camera.id);var centroid=selected.getCentroid(activeManipulator);var axis=(handleInfo.x?X:0)|(handleInfo.y?Y:0)|(handleInfo.z?Z:0);if(!axis){return new THREE.Vector3(0,0,0)}var threeCamera=cameraDisplayNode.camera;var camRot=(new THREE.Matrix4).extractRotation(threeCamera.matrixWorld);if(!(threeCamera instanceof THREE.PerspectiveCamera)||axis===XYZ){v2.set(0,0,1).applyMatrix4(camRot)}else if(axis===XY||axis===X||axis===Y){v2.set(0,0,1)}else if(axis===XZ||axis===Z){v2.set(0,1,0)}else if(axis===YZ){v2.set(1,0,0)}p.setFromNormalAndCoplanarPoint(v2,centroid);var rect=viewport.get("rect");v3.set(moveInfo.deltaX*2/rect.width,-moveInfo.deltaY*2/rect.height,0);proj.projectVector(v1.copy(centroid),threeCamera);v1.add(v3);v3.copy(p.normal);v1.z=-1;v2.copy(v1).z=1;proj.unprojectVector(v1,threeCamera);proj.unprojectVector(v2,threeCamera);p.intersectLine(new THREE.Line3(v1,v2),v4);if(axis===X||axis===Y||axis===Z){if(axis===X){v2.set(0,1,0);if(Math.abs(v2.dot(v3))>1e-6){v2.set(0,0,1)}}else if(axis===Y){v2.set(1,0,0);if(Math.abs(v2.dot(v3))>1e-6){v2.set(0,0,1)}}else if(axis===Z){v2.set(1,0,0);if(Math.abs(v2.dot(v3))>1e-6){v2.set(0,1,0)}}p.setFromNormalAndCoplanarPoint(v2,centroid);p.intersectLine(new THREE.Line3(v1.copy(v4),v2.addVectors(v1,v2.multiplyScalar(p.distanceToPoint(v1)*-2))),v4)}v4.sub(centroid);return v4.clone()}})}();!function(){var rotVector=new THREE.Vector3;var zeroVector=new THREE.Vector3;var tmpMat=new THREE.Matrix4;exo.models.manipulators.Rotate=exo.models.Manipulator.extend({initialize:function(options){this.defaultHandleInfo={x:true,y:true,z:false};this.rotateFactor=1},Object:{manipulate:function(moveInfo,handleInfo){var viewport=this.editor.currentViewport;var rotateFactor=this.manipulator.rotateFactor;var delta=this.manipulator.deltaVector(moveInfo,handleInfo);var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){var rotation=rotVector.set(0,0,0);if(handleInfo.x){rotation.x=clampRotation(delta.x)}if(handleInfo.z){rotation.y=clampRotation(delta.y)}if(handleInfo.y){rotation.z=clampRotation(delta.z)}var transform=node.Transform;var pNode=transform.primitive.parentNode;if(pNode){pNode.Transform.primitive.getWorldTransformInverse(tmpMat);rotation.apply3x3InMatrix4(tmpMat)}transform.rotate(rotation)}).end()},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("rotateSnapping");if(gridSnapping){var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){exo.models.manipulators.Helper.snapVector(node.Transform,"rotation",gridSnapping,handleInfo)}).end()}}},Vertex:{manipulate:function(moveInfo,handleInfo){var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);var ctx=this.editor.getCtx();var options=this.manipulator.getTranformVertices(subSelection,moveInfo,handleInfo,operator);if(operator){ctx(operator).set(options)}else{operator=exo.models.manipulators.Helper.addTransformOperator(subSelection,options)}},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("rotateSnapping");var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);if(gridSnapping&&operator){exo.models.manipulators.Helper.snapVector(operator,"rotation",gridSnapping,handleInfo)}}},Operator:{manipulate:function(moveInfo,handleInfo,operator,callback){callback(operator,this.manipulator.deltaVector(moveInfo,handleInfo),this.editor.subSelection,moveInfo,handleInfo)}},getTranformVertices:function(subSelection,moveInfo,handleInfo,operator){var indices=subSelection.getVertices();var previousDelta=operator?operator.get("rotation"):zeroVector;var currentDelta=this.deltaVector(moveInfo,handleInfo);var rotation=new THREE.Vector3(0,0,0);if(handleInfo.x){rotation.x=currentDelta.x}if(handleInfo.z){rotation.y=currentDelta.y}if(handleInfo.y){rotation.z=currentDelta.z}subSelection.node().Transform.primitive.getWorldTransformInverse(tmpMat);rotation.apply3x3InMatrix4(tmpMat);rotation.add(previousDelta);return{vertexIndices:exo.geometry.GeometryUtils.arrayIndicesToString(indices),rotation:rotation}},deltaVector:function(moveInfo,handleInfo){if(!moveInfo.deltaX&&!moveInfo.deltaY)return new THREE.Vector3(0,0,0);return new THREE.Vector3(moveInfo.deltaX,moveInfo.deltaY,moveInfo.deltaX).multiplyScalar(this.rotateFactor)}});var clampRotation=function(rotation){if(rotation<-360){rotation+=360}else if(rotation>360){rotation-=360}return rotation}}();!function(){var oneVector=new THREE.Vector3(1,1,1);var tmpVec=new THREE.Vector3;var tmpMat=new THREE.Matrix4;var tmpRotMat=new THREE.Matrix4;exo.models.manipulators.Scale=exo.models.Manipulator.extend({initialize:function(options){},Object:{manipulate:function(moveInfo,handleInfo){var delta=this.manipulator.deltaVector(moveInfo,handleInfo);var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){node.Transform.scale(delta)}).end()},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("scaleSnapping");if(gridSnapping){var ctx=this.editor.getCtx();ctx(":selection").start().each(function(node){exo.models.manipulators.Helper.snapVector(node.Transform,"scale",gridSnapping,handleInfo,true)}).end()}}},Vertex:{manipulate:function(moveInfo,handleInfo){var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);var ctx=this.editor.getCtx();var options=this.manipulator.getTranformVertices(subSelection,moveInfo,handleInfo,operator);if(operator){ctx(operator).set(options)}else{operator=exo.models.manipulators.Helper.addTransformOperator(subSelection,options)}},confirm:function(moveInfo,handleInfo){var gridSnapping=this.editor.selectionProperties.get("scaleSnapping");var subSelection=this.editor.subSelection;var operator=exo.models.manipulators.Helper.transformOperatorExists(subSelection);if(gridSnapping&&operator){exo.models.manipulators.Helper.snapVector(operator,"scale",gridSnapping,handleInfo,true)}}},Operator:{manipulate:function(moveInfo,handleInfo,operator,callback){callback(operator,this.manipulator.deltaVector(moveInfo,handleInfo),this.editor.subSelection,moveInfo,handleInfo)}},getTranformVertices:function(subSelection,moveInfo,handleInfo,operator){var indices=subSelection.getVertices();var previousDelta=operator?operator.get("scale"):oneVector;var currentDelta=this.deltaVector(moveInfo,handleInfo).multiply(previousDelta);return{vertexIndices:exo.geometry.GeometryUtils.arrayIndicesToString(indices),scale:currentDelta}},deltaVector:function(moveInfo,handleInfo){if(!moveInfo.deltaX&&!moveInfo.deltaY)return new THREE.Vector3(0,0,0);var selected=this.editor.selected;var viewport=this.editor.currentViewport;var camera=viewport.camera;var displayScene=this.editor.displayScene;handleInfo=handleInfo||_.clone(this.defaultHandleInfo);var activeManipulator=this.editor.currentManipulator();var transCamera=displayScene.get(camera.id);var factors=exo.models.manipulators.Helper.getAxialFactors(transCamera,selected.getCentroid(activeManipulator));var avgx=(moveInfo.deltaX*factors.right.x+moveInfo.deltaY*factors.up.x)/2;var avgy=(moveInfo.deltaX*factors.right.y+moveInfo.deltaY*factors.up.y)/2;var avgz=(moveInfo.deltaX*factors.right.z+moveInfo.deltaY*factors.up.z)/2;var deltaX=handleInfo.x?avgx<0?.9:1.1:1;var deltaY=handleInfo.y?avgy<0?.9:1.1:1;var deltaZ=handleInfo.z?avgz<0?.9:1.1:1;if(handleInfo.x&&handleInfo.y){deltaY=deltaX}if(handleInfo.x&&handleInfo.z){deltaZ=deltaX}if(handleInfo.y&&handleInfo.z){deltaZ=deltaY}return new THREE.Vector3(deltaX,deltaY,deltaZ)}})}();exo.models.Notification=highbrow.extend("Model","Notification",{defaults:{title:"",message:"",type:"info",progress:0,showProgress:false,persist:false},initialize:function(){if(this.get("progress")>0){this.progress(this.get("progress"))}},progress:function(amount){if(amount<0){amount=0}if(amount>100){amount=100}this.set("showProgress",true);this.set("progress",amount)},close:function(){this.set("persist",false);this.trigger("closed",this)}});exo.models.Notifications=highbrow.extend("Collection","Notifications",{model:exo.models.Notification});exo.models.Script=highbrow.extend("Model","Script",{url:function(){if(this.parent&&this.parent.scriptUrl){return this.parent.scriptUrl()}else{return highbrow.Model.prototype.url.call(this)}},trySave:function(delay){delay=delay||2e3;if(this.saving){this.dirty=true;return}this.saving=true;var model=this;setTimeout(function(){model.dirty=false;model.save({},{success:function(){model.saving=false;if(model.dirty)model.trySave()}})},delay)}});exo.models.Plugin=highbrow.extend("Model","Plugin",{urlRoot:"/api/plugins",validations:{required:["name","version"]},defaults:{version:"0.0.1",content:"// Script goes here"},scriptUrl:function(){if(this.get("loadFromServer")){return this.get("url")+"plugins/"+this.get("name")}else{return highbrow.Model.prototype.url.call(this)}}},{relations:{script:exo.models.Script}});exo.models.Plugins=highbrow.extend("Collection","Plugins",{urlRoot:"/api/plugins",model:exo.models.Plugin});exo.models.Referral=highbrow.extend("Model","Referral",{urlRoot:"/api/referrals",validations:{required:["targetEmail"]}});
exo.models.Referrals=highbrow.extend("PaginatedCollection","Referrals",{urlRoot:"/api/referrals",model:exo.models.Referral,perPage:5e3});exo.models.Scripts=highbrow.extend("Collection","Scripts",{urlRoot:"/api/scripts",model:exo.models.Script});exo.models.SelectionProperties=highbrow.extend("Model","SelectionProperties",{defaults:{ignoreBackfacing:false,moveSnapping:0,rotateSnapping:0,scaleSnapping:0},schema:{ignoreBackfacing:{label:"Ignore Backfacing",type:"Boolean",defaultValue:false},moveSnapping:{label:"Move Snapping",type:"Number",minValue:0,step:1},rotateSnapping:{label:"Rotate Snapping",type:"Number",minValue:0,step:1},scaleSnapping:{label:"Scale Snapping",type:"Number",minValue:0,step:1}},initialize:function(){exo.sceneGraph.SchemaBase.prototype.buildSchema.apply(this)},editor:function(){return this.parent?this.parent:null},ctx:function(){if(!this._mockCtx){this._mockCtx=exo.sceneGraph.SchemaBase.prototype.createMockCtx.apply(this)}return this._mockCtx}});exo.models.Stats=highbrow.extend("Model","Stats",{});exo.models.SubSelectionProperty=highbrow.extend(exo.sceneGraph.SchemaBase,"SubSelectionProperty",{initialize:function(attrs,options){this.on("change",this.update)},detachable:true,detached:true,update:function(){},updateComponent:function(){},node:function(){var subSelection=this.subSelection();return subSelection?subSelection.node():null},editor:function(){var subSelection=this.subSelection();return subSelection?subSelection.parent:null},subSelection:function(){return this.parent&&this.parent.parent?this.parent.parent:null},scene:function(){var editor=this.editor();return editor?editor.scene:null},sceneRoot:function(){var scene=this.scene();return scene?scene.objectsRootNode:null},getPolyMeshPlug:function(){var node=this.node();if(!node){return null}var polyMeshPlug=node.plugs.PolyMesh;if(!polyMeshPlug){return null}return polyMeshPlug},getPolyMeshPlugCtx:function(selection){var node=this.node();if(!node){return null}var polyMeshPlug=node.plugs.PolyMesh;if(!polyMeshPlug){return null}return polyMeshPlug.ctx(selection)},addOperator:function(){var ctx=this.getPolyMeshPlugCtx();if(!ctx)return;ctx.addOperator.apply(ctx,arguments)},addOperatorWithIndices:function(operator,options,minIndices){var subSelection=this.subSelection();if(!subSelection||subSelection.getIndicesCount()<(minIndices?minIndices:1)){return}if(!options)options={};options.indices=subSelection.getIndicesAsString();this.addOperator(operator,options)},getPolyMesh:function(){var node=this.node();if(!node){return null}return node.polyMesh},arrayToString:function(arrayNumbers,sortOutput){var materialIDs=[];if(!arrayNumbers||arrayNumbers&&arrayNumbers.length<1){return""}for(var i=0,il=arrayNumbers.length;i<il;i++){materialIDs.push(arrayNumbers[i])}if(sortOutput){materialIDs.sort()}return materialIDs.join(", ")}});exo.models.ObjectProperties=highbrow.extend(exo.models.SubSelectionProperty,"ObjectProperties",{schema:{collapseButton:{text:"Collapse Operators",type:"Button"},symmetryButton:{text:"Symmetry",type:"Button"},mirrorButton:{text:"Mirror",type:"Button"},slicePlaneButton:{text:"Slice",type:"Button"},cutPlaneButton:{text:"Cut",type:"Button"},flipNormalsButton:{text:"Flip Normals",type:"Button"},editNormalsButton:{text:"Edit Normals",type:"Button"},uvMapButton:{text:"Apply UVs",type:"Button"},meshSmoothButton:{text:"MeshSmooth",type:"Button"},mergeButton:{text:"Merge Selected",type:"Button"},triangulateButton:{text:"Triangulate",type:"Button"},explodeFacesButton:{text:"Detach All Faces",type:"Button"},twistButton:{text:"Twist",type:"Button"},taperButton:{text:"Taper",type:"Button"},removeUnusedButton:{text:"Remove Unused Vertices",type:"Button"},autoScaleButton:{text:"Auto Scale",type:"Button"},uniformVertexColorsButton:{text:"Uniform Vertex Colors",type:"Button"},uvVertexColorsButton:{text:"Vertex Color Channel",type:"Button"}},initialize:function(attrs,options){exo.models.SubSelectionProperty.prototype.initialize.apply(this,arguments)},update:function(){},updateComponent:function(){},collapseButton:function(){var polyMeshPlug=this.getPolyMeshPlug();if(!polyMeshPlug){return}exo.geometry.PolyMeshUtilities.collapseMesh(polyMeshPlug)},symmetryButton:function(){this.addOperator("Symmetry")},mirrorButton:function(){this.addOperator("Symmetry",{slice:false})},slicePlaneButton:function(){this.addOperator("Slice",{cut:false})},cutPlaneButton:function(){this.addOperator("Slice",{cut:true})},flipNormalsButton:function(){this.addOperator("Normals",{flipfaces:true})},editNormalsButton:function(){this.addOperator("Normals",{flipfaces:false})},uvMapButton:function(){this.addOperator("UVMap")},mergeButton:function(){var node=this.node();var editor=this.editor();var mergeName=node?node.get("name")+"_Merged":"merged";exo.geometry.PolyMeshUtilities.mergeSelectedPolyMeshNodes(editor,mergeName)},twistButton:function(){this.addOperator("Twist")},taperButton:function(){this.addOperator("Taper")},meshSmoothButton:function(){this.addOperator("MeshSmooth")},autoScaleButton:function(){this.addOperator("AutoScale")},explodeFacesButton:function(){this.addOperator("ExplodeFaces")},triangulateButton:function(){this.addOperator("Triangulate")},removeUnusedButton:function(){this.addOperator("CleanPolyMesh",{componentType:"Vertex"})},uvVertexColorsButton:function(){this.addOperator("UVVertexColors")},uniformVertexColorsButton:function(){this.addOperator("UniformVertexColors")}});exo.models.FaceProperties=highbrow.extend(exo.models.SubSelectionProperty,"FaceProperties",{schema:{extrudeButton:{text:"Extrude",type:"Button"},slicePlaneButton:{text:"Slice Plane",type:"Button"},cutPlaneButton:{text:"Cut Plane",type:"Button"},detachButton:{text:"Detach",type:"Button"},deleteButton:{text:"Delete",type:"Button"},materialID:{label:"Material ID",type:"Integer",step:1,minValue:0,defaultValue:0},setIDButton:{text:"Set ID",type:"Button"},selectIDButton:{text:"Select ID",type:"Button"},uniqMaterialIDs:{label:"Material IDs",type:"TextArea",defaultValue:"",rows:1,display:"normalStyle",disabled:true}},initialize:function(attrs,options){exo.models.SubSelectionProperty.prototype.initialize.apply(this,arguments)},update:function(){},updateComponent:function(){this.displayUniqMaterialIDs()},displayUniqMaterialIDs:function(){var polyMesh=this.getPolyMesh();if(polyMesh){var matIDsString=this.arrayToString(polyMesh.getUniqMaterialIDs(),true);this.set("uniqMaterialIDs",matIDsString)}},extrudeButton:function(){this.addOperatorWithIndices("Extrude")},_getSliceCutOptions:function(isCut){var subSelection=this.subSelection();if(!subSelection||subSelection.getIndicesCount()<1){return null}var node=this.node();var centerSelection=node?subSelection.getCentroid():new THREE.Vector3;var directionNormal=new THREE.Vector3;directionNormal.subVectors(new THREE.Vector3,centerSelection).normalize();centerSelection=exo.geometry.TransformUtilities.getLocalPositionByNode(node,centerSelection);var options={center:centerSelection,normal:directionNormal,indices:subSelection.getIndicesAsString(),cut:isCut?true:false};return options},slicePlaneButton:function(){var options=this._getSliceCutOptions(false);if(options){this.addOperator("Slice",options)}},cutPlaneButton:function(){var options=this._getSliceCutOptions(true);if(options){this.addOperator("Slice",options)}},detachButton:function(){this.addOperatorWithIndices("Detach")},deleteButton:function(){this.addOperatorWithIndices("DeleteComponent",{componentType:"Face"})},setIDButton:function(){this.addOperatorWithIndices("MaterialIDs",{materialID:this.get("materialID")});this.displayUniqMaterialIDs()},selectIDButton:function(){var polyMeshPlug=this.getPolyMeshPlug();var subSelection=this.subSelection();var polyMesh=this.getPolyMesh();if(!polyMeshPlug||!subSelection||!polyMesh){return}subSelection.setIndices(polyMesh.getFacesbyMaterialID(this.get("materialID")))}});exo.models.EdgeProperties=highbrow.extend(exo.models.SubSelectionProperty,"EdgeProperties",{schema:{borderID:{label:"Border ID",type:"Integer",step:1,minValue:0,defaultValue:0},selectBorderButton:{text:"Select Border",type:"Button"},selectAllBordersButton:{text:"Select All Borders",type:"Button"},fillBordersButton:{text:"Fill Borders",type:"Button"},connectButton:{text:"Connect",type:"Button"},deleteButton:{text:"Delete",type:"Button"},removeButton:{text:"Remove",type:"Button"}},initialize:function(attrs,options){exo.models.SubSelectionProperty.prototype.initialize.apply(this,arguments)},update:function(){},updateComponent:function(){},selectBorderButton:function(){var polyMesh=this.getPolyMesh();var subSelection=this.subSelection();var borderID=this.get("borderID");if(!subSelection||!polyMesh){return}var borderEdges=exo.geometry.ComponentUtilities.getBorderEdges(polyMesh);var borderEdgesGroups=exo.geometry.ComponentUtilities.getConnectedEdges(borderEdges);if(borderID>=0&&borderID<borderEdgesGroups.length){subSelection.setIndices(borderEdgesGroups[borderID])}else{subSelection.clear()}},selectAllBordersButton:function(){var polyMesh=this.getPolyMesh();var subSelection=this.subSelection();if(!subSelection||!polyMesh){return}var borderEdges=exo.geometry.ComponentUtilities.getBorderEdges(polyMesh);subSelection.setIndices(borderEdges)},fillBordersButton:function(){var subSelection=this.subSelection();if(!subSelection){return}var selectedEdges=subSelection.getIndices();if(selectedEdges.length<2){return}this.addOperator("FillComponent",{edges:selectedEdges})},connectButton:function(){var subSelection=this.subSelection();if(!subSelection||subSelection.getIndicesCount()<1){return}this.addOperator("Connect",{edges:subSelection.getIndices(),componentType:"Edge"})},deleteButton:function(){var subSelection=this.subSelection();if(!subSelection||subSelection.getIndicesCount()<1){return}this.addOperator("DeleteComponent",{indices:subSelection.getVertexIndicesAsString(),componentType:"Edge"})},removeButton:function(){var subSelection=this.subSelection();if(!subSelection||subSelection.getIndicesCount()<1){return}this.addOperator("RemoveComponent",{edges:subSelection.getIndices(),componentType:"Edge"})}});exo.models.VertexProperties=highbrow.extend(exo.models.SubSelectionProperty,"VertexProperties",{schema:{weldButton:{text:"Weld",type:"Button"},connectButton:{text:"Connect",type:"Button"},deleteButton:{text:"Delete",type:"Button"},removeButton:{text:"Remove",type:"Button"},removeUnusedSelectionButton:{text:"Remove Selected Unused Vertices",type:"Button"}},initialize:function(attrs,options){exo.models.SubSelectionProperty.prototype.initialize.apply(this,arguments)},update:function(){},updateComponent:function(){},weldButton:function(){this.addOperatorWithIndices("Weld",{componentType:"Vertex"})},connectButton:function(){this.addOperatorWithIndices("Connect",{componentType:"Vertex"},2)},deleteButton:function(){this.addOperatorWithIndices("DeleteComponent",{componentType:"Vertex"})},removeButton:function(){this.addOperatorWithIndices("RemoveComponent",{componentType:"Vertex"})},removeUnusedSelectionButton:function(){this.addOperatorWithIndices("CleanPolyMesh",{componentType:"Vertex"})}});exo.models.SubSelectionProperties=highbrow.extend(exo.sceneGraph.SchemaBase,"SubSelectionProperties",{},{relations:{object:exo.models.ObjectProperties,face:exo.models.FaceProperties,vertex:exo.models.VertexProperties,edge:exo.models.EdgeProperties}});!function(){var subObjectTypes={Vertex:"positions",Face:"faces",Edge:"positions"};var smallBoxSize=new THREE.Vector3(.1,.1,.1);exo.models.SubSelection=highbrow.extend("Model","SubSelection",{defaults:{indices:[],type:"Object",convert:false},initialize:function(){this.createByIndex();this.on("change:indices",function(indices){this.createByIndex();if(indices.length){this.trigger("add",this,indices)}},this);this.on("change:type",this.subSelectionUpdate,this)},subSelectionUpdate:function(){if(this.getConvertFlag()){var previousType=this._getPreviousType();var newType=this.getType();var newIndices;if(previousType!==newType&&previousType!=="Object"&&newType!=="Object"){var ComponentUtils=exo.geometry.ComponentUtilities;var node=this.node();var polyMesh=node?node.polyMesh:null;if(polyMesh){var componentIndices=this.getIndices();if(previousType==="Face"){if(newType==="Edge"){newIndices=ComponentUtils.getEdgesByFaces(polyMesh,componentIndices)}else if(newType==="Vertex"){newIndices=ComponentUtils.getVerticesByFaces(polyMesh,componentIndices)}}else if(previousType==="Edge"){if(newType==="Face"){newIndices=ComponentUtils.getFacesByEdges(polyMesh,componentIndices)}else if(newType==="Vertex"){newIndices=ComponentUtils.getVerticesByEdges(componentIndices)}}else if(previousType==="Vertex"){if(newType==="Face"){newIndices=ComponentUtils.getFacesByVertices(polyMesh,componentIndices)}else if(newType==="Edge"){newIndices=ComponentUtils.getEdgesByVertices(polyMesh,componentIndices)}}}}}this.clear();if(newIndices&&newIndices.length>0){this.setIndices(newIndices)}this.setConvertFlag(false);var selectedComponent=this.properties[this.getType().toLowerCase()];if(selectedComponent){selectedComponent.updateComponent()}},add:function(index,other){var indices=this.get("indices");if(index instanceof Array){_.each(index,this.add,this);this.trigger("add",this,index)}else{var key=index;if(this.get("type")==="Edge"){key=index.createHashKey()}if(!this.byIndex[key]){indices.push(index);this.byIndex[key]=true;if(other===undefined){this.trigger("add",this,index)}}}},remove:function(index,other){var indices=this.get("indices");if(index instanceof Array){_.each(index,this.remove,this);this.trigger("remove",this,index)}else{var key=index;if(this.get("type")==="Edge"){key=index.createHashKey()}if(this.byIndex[key]){var place=-1;if(this.get("type")==="Edge"){place=index.getIndexOf(indices)}else{place=indices.indexOf(index)}delete this.byIndex[key];if(place>=0){indices.splice(place,1)}}if(other===undefined){this.trigger("remove",this,index)}}},getIndices:function(){return this.get("indices")},getIndicesCount:function(){var indices=this.get("indices");return indices?indices.length:0},setIndices:function(indices){if(indices){this.set("indices",indices)}},setConvertFlag:function(state){this.set("convert",state)},getConvertFlag:function(){return this.get("convert")},getIndicesAsString:function(){return exo.geometry.GeometryUtils.arrayIndicesToString(this.get("indices"))},getVertexIndicesAsString:function(){return exo.geometry.GeometryUtils.arrayIndicesToString(this.getVertices())},getType:function(){return this.get("type")},_getPreviousType:function(){return this.previous("type")},setType:function(componentType){if(componentType==="Face"||componentType==="Edge"||componentType==="Vertex"){return this.set("type",componentType)}},clear:function(){var indices=this.get("indices");if(indices.length){this.byIndex={};this.set("indices",[])}this.trigger("remove",this,indices)},createByIndex:function(){var indices=this.get("indices");this.byIndex={};_.each(indices,function(index){var key=index;if(this.get("type")==="Edge"){key=index.createHashKey()}this.byIndex[key]=true},this)},node:function(){return this.parent&&this.parent.selected?this.parent.selected.last()||null:null},values:function(){var node=this.node(),type=this.get("type"),values=null,polyMesh,indices,info;if(node&&subObjectTypes[type]&&node.polyMesh){indices=this.get("indices");values={};if(type==="Edge"){values=exo.geometry.CloneUtilities.copyObjectArray(indices)}else if(indices.length){info=node.polyMesh[subObjectTypes[type]];if(info&&info.length){_.each(indices,function(index){values[index]=info[index]})}}}return values},at:function(index){return this.get("indices")[index]},find:function(index){return this.get("indices").indexOf(index)},length:function(){return this.get("indices").length},checkAvailability:function(selectedLength){var node=this.node(),type=this.get("type"),selected=this.parent.selected;selectedLength=selectedLength===undefined?selected.length:selectedLength;if(!(node&&selectedLength===1&&node.subSelectable&&node.subSelectable[type])){this.set("type","Object")}},addAll:function(){var node=this.node(),type=this.get("type"),values=[],polyMesh,info;if(node&&subObjectTypes[type]&&node.polyMesh){if(type==="Edge"){values=exo.geometry.ComponentUtilities.getEdges(node.polyMesh)}else{values=Object.keys(node.polyMesh[subObjectTypes[type]])}}this.add(values)},available:function(){var node=this.node(),type=this.get("type"),values=[],polyMesh,info;if(node&&subObjectTypes[type]&&node.polyMesh){if(type==="Edge"){values=exo.geometry.ComponentUtilities.getEdges(node.polyMesh)}else{values=node.polyMesh[subObjectTypes[type]]}}return values},getUnselectedIndices:function(){var node=this.node();var typeSubObject=this.get("type");var indicesAll=[];if(node&&node.polyMesh){var indices=this.get("indices");var polyMesh=node.polyMesh;if(indices.length){if(typeSubObject==="Face"){for(var i=0,il=polyMesh.faces.length;i<il;++i){indicesAll.push(i)}return _.difference(indicesAll,indices)}else if(typeSubObject==="Edge"){var edgesAll=exo.geometry.ComponentUtilities.getEdges(polyMesh);var unselectedEdges=_.filter(edgesAll,function(edge){var isSelected=false;for(var i=0,il=indices.length;i<il;++i){if(edge.start===indices[i].start&&edge.end===indices[i].end){isSelected=true}}return!isSelected});return unselectedEdges}else if(typeSubObject==="Vertex"){for(var i=0,il=polyMesh.positions.length;i<il;++i){indicesAll.push(i)}return _.difference(indicesAll,indices)}}}return[]},getVertices:function(indices){var node=this.node(),type=this.get("type"),vertices=[],indices,info;var verticesFound={};var vertexIndex;if(node&&subObjectTypes[type]&&node.polyMesh){indices=indices||this.get("indices");var polyMesh=node.polyMesh;if(indices.length){info=polyMesh[subObjectTypes[type]];if(type==="Vertex"){for(var i=0,il=indices.length;i<il;++i){if(indices[i]<polyMesh.getVertexCount()){vertices.push(indices[i])}}}else if(type==="Face"){var facesCount=polyMesh.getFacesCount();for(var i=0,length=indices.length;i<length;++i){if(indices[i]>=facesCount){continue}var face=info[indices[i]];for(var j=0,jl=face.length;j<jl;++j){vertexIndex=face[j];if(!verticesFound[vertexIndex]){vertices.push(vertexIndex);verticesFound[vertexIndex]=true}}}}else if(type==="Edge"){_.each(indices,function(edge){if(!verticesFound[edge.start]){vertices.push(edge.start);verticesFound[edge.start]=true}if(!verticesFound[edge.end]){vertices.push(edge.end);verticesFound[edge.end]=true}})}}}return vertices},gePolyMesh:function(){var node=this.node();if(node){return node.polyMesh}return null},getBoundingBox:function(){var indicesCount=this.getIndicesCount();if(indicesCount>0){var boundingBox=new THREE.Box3;var node=this.node();var polyMesh;if(node){polyMesh=node.polyMesh}if(!polyMesh){return null}var vertices=polyMesh.getVertices(this.getVertices());if(indicesCount===1&&this.getType()==="Vertex"){boundingBox.setFromCenterAndSize(vertices[0],smallBoxSize)}else{boundingBox.setFromPoints(vertices);boundingBox.expandByScalar(smallBoxSize.x/2)}boundingBox.applyMatrix4(node.transform.getWorldTransform());return boundingBox}return null},getCentroid:function(){var node=this.node();var centroid=new THREE.Vector3;if(node){var polyMesh=node.polyMesh;if(polyMesh){var vertices=this.getVertices();if(vertices.length){var positions=[];_.each(vertices,function(index){if(index<polyMesh.getVertexCount()){centroid.add(polyMesh.positions[index])}});centroid.multiplyScalar(1/vertices.length)}centroid.applyMatrix4(node.transform.getWorldTransform())}}return centroid}},{relations:{properties:exo.models.SubSelectionProperties}})}();exo.models.User=highbrow.extend("Model","User",{urlRoot:"/api/users",validations:{required:["username","name","email"]},isA:function(role){return _.contains(this.get("flags"),role)},isAdmin:function(){return this.isA("admin")},isPlugins:function(){return this.isA("plugins")},isRender:function(){return this.isA("render")},isEnabled:function(){return this.get("enabled")}});exo.models.Users=highbrow.extend("PaginatedCollection","Users",{urlRoot:"/api/users",model:exo.models.User,findUser:function(id){var user=null;if(id&&id.length===24)user=this.get(id);if(!user)user=this.where({username:id})[0];return user},perPage:5e3});exo.sceneGraph.nodes.Scene.relations.ownerData=exo.models.Users;exo.models.Session=highbrow.extend("Model","Session",{url:"/api/session",validations:{required:["username","password"]}},{relations:{user:exo.models.User}});exo.models.Viewport=highbrow.extend("Model","Viewport",{defaults:{renderType:"realistic",viewType:"perspective",position:"topleft",edges:false,fullscreen:false,rect:{x:0,y:0,width:1,height:1},visible:true,gridVisible:true,statsVisible:false},initialize:function(){this.createDefaultCamera();this.on("change:rect",function(viewport,rect){if(viewport.camera.hasOperators()&&!viewport.camera.scene()){viewport.camera.Camera.ctx().set("aspectRatio",rect.width/rect.height);viewport.camera.Camera.applyOperators()}});this.on("change:viewType",function(viewport,viewType){if(viewType!=="camera"){this.camera=this.defaultCamera;this.camera.initializeFor(viewType,this.get("rect"));this.trigger("switch:camera",this.camera)}},this)},createDefaultCamera:function(){this.camera=this.defaultCamera=new exo.sceneGraph.nodes.Camera;this.defaultCamera.Properties.set("visible",false);this.camera.initializeFor(this.get("viewType"),this.get("rect"))},toJSON:function(){var json=highbrow.Model.prototype.toJSON.call(this);delete json.scene;delete json.camera;return json},getViewRect:function(){return this.get("rect")},setCamera:function(camera){if(this.camera&&this.camera.hasOperators()&&!camera.scene()){camera.plugs.Camera.ctx().set("aspectRatio",this.camera.camera.aspectRatio);camera.plugs.Camera.applyOperators()}this.camera=camera;this.set("viewType","camera");this.trigger("switch:camera",this.camera)},cameras:function(){var collection=new exo.sceneGraph.Nodes;var collectCameras=function(nodes){nodes.each(function(node){if(node.isCamera()){collection.add(node)}collectCameras(node.nodes)})};collectCameras(this.scene.nodes);return collection},frameTo:function(nodes,viewport,frameHierarchy,excludedTypes){if(!nodes||nodes.length<1){return}var cameraNode=this.camera;var camera=cameraNode.camera;var transform=cameraNode.transform;if(excludedTypes){nodes=new exo.sceneGraph.Nodes(nodes.filter(function(node){return excludedTypes.indexOf(node.get("type"))===-1}))}nodes=new exo.sceneGraph.Nodes(nodes.filter(function(node){return node.id!==cameraNode.id}));if(nodes.length<1)return;if(!this.camera.hasOperators())return;var _hasAnySubselection=viewport.editor.hasAnySubSelection();var boundingBox;if(_hasAnySubselection){boundingBox=viewport.editor.subSelection.getBoundingBox();if(!boundingBox){boundingBox=nodes.getBoundingBox(frameHierarchy)}}else{boundingBox=nodes.getBoundingBox(frameHierarchy)}var size=boundingBox.size();var centroid=boundingBox.center();var camPos=transform.getTranslation();if(this.camera.isOrthographic()){var boundingBoxLength;var orthoAxis=this.camera.getOrthoAxis();if(orthoAxis){var boundigX=size.getComponent(orthoAxis[0]);var boundigY=size.getComponent(orthoAxis[1]);boundingBoxLength=Math.max(boundigX,boundigY)}else{boundingBoxLength=size.length()}var camTarget=cameraNode.createCenterViewTarget(viewport.model,viewport.displayScene);if(camera.aspectRatio<1){boundingBoxLength/=camera.aspectRatio}var vFOV=camera.fieldOfView/2;var tangent=Math.tan(THREE.Math.degToRad(vFOV));var lengthToCenter=boundingBoxLength*.65/(tangent===0?exo.math.EPSILON:tangent);var newPos=new THREE.Vector3;if(viewport.isCameraDefault(cameraNode)){newPos=camTarget.clone().negate().multiplyScalar((camera.farClip-camera.nearClip)*.99)}else{newPos.subVectors(centroid,camTarget).normalize().multiplyScalar(lengthToCenter)}this.camera.plugs.Camera.ctx().set("orthoZoom",lengthToCenter);this.camera.plugs.Transform.ctx().set("translation",centroid.clone().add(newPos))}else{var camTarget=cameraNode.createCenterViewTarget(viewport.model,viewport.displayScene);var angle=camera.aspectRatio<1?camera.fieldOfView/2*camera.aspectRatio:camera.fieldOfView/2;var tangent=Math.tan(THREE.Math.degToRad(angle));var lengthToCenter=size.length()*.5/(tangent===0?exo.math.EPSILON:tangent);var newPos=camTarget.clone().negate().multiplyScalar(lengthToCenter);this.camera.plugs.Camera.ctx().set("target",centroid.clone());this.camera.plugs.Transform.ctx().set("translation",centroid.clone().add(newPos))}}},{relations:{scene:exo.sceneGraph.nodes.Scene,camera:exo.sceneGraph.nodes.Camera}});exo.models.Viewports=highbrow.extend("Collection","Viewports",{model:exo.models.Viewport});exo.models.Editor=highbrow.extend("Model","Editor",{defaults:{activeManipulator:"Move",version:13,webGLSupport:true,loadingCommand:false,assetsShown:true},initialize:function(){this.hotkeysBound={};this.callbacksWaiting=[];this.set("loadingCommand",false);this.initializeViewports();this.currentViewport=this.viewports.at(0);this.initializeManipulators();this.selected.on("remove",function(node){if(!this.selected.length){this.trigger("selected",this.scene)}},this);this.stats=new exo.models.Stats;this.commands={};_.each(this.commandPlaces,function(place){this.commands[place]=new exo.models.Commands([],{place:place})},this);this.on("change:loadingCommand",function(){if(!this.get("loadingCommand")){this.onCommandsLoaded()}},this);this.initializeCommands();this.bindTo(exo.api.pluginRegistry,"addCommand",this.addCommand,this)},initializeManipulators:function(){this.manipulators={};_.each(["Move","Rotate","Scale"],function(name){this.manipulators[name]=new exo.models.manipulators[name]({editor:this})},this)},initializeViewports:function(){var defaults=[["left","wireframe","topleft"],["perspective","realistic","topright"],["top","wireframe","bottomleft"],["front","wireframe","bottomright"]];if(!this.viewports.length){_.each(defaults,function(info){this.viewports.add(new exo.models.Viewport({scene:this.scene,viewType:info[0],renderType:info[1],position:info[2]}))},this)}else{this.viewports.each(function(viewport,index){if(viewport.get("viewType")==="camera"){viewport.set("viewType",defaults[index][0])}})}},getCtx:function(){return this.scene.getCtx()},setScene:function(scene){if(this.scene){this.scene.plugs.Timeline.off(null,null,this)}this.scene=scene=scene instanceof exo.sceneGraph.Scene?scene:new exo.sceneGraph.Scene(scene||{});this.scene._editor=this;this.bindTo(scene,"removeNode",function(node){this.deselect(node)},this);this.bindTo(scene.plugs.Timeline,"change:currentFrame",function(model,time){scene.setTime(time)},this);this.clearSelection();this.viewports.each(function(viewport){viewport.scene=this.scene},this);this.trigger("new",this.scene);return this.scene},select:function(node){this.subSelection.clear();if(node.selectable){this.subSelection.checkAvailability(this.selected.length+1);this.selected.add(node)}else{this.clearSelection();this.modelSelection=node;this.trigger("selected",this.modelSelection)}},deselect:function(node){this.selectManipulator(node,null);this.selected.remove(node);if(this.modelSelection===node){this.modelSelection=null}this.subSelection.clear();this.subSelection.checkAvailability()},selectionInvert:function(){var unselectedNodes=[];if(this.scene.objectsRootNode.nodes.length){this.scene.objectsRootNode.nodes.each(function(node){var isSelected=false;this.selected.each(function(selectedNode){if(selectedNode.id==node.id){isSelected=true;return}},this);if(!isSelected){unselectedNodes.push(node)}},this)}if(unselectedNodes.length){this.selected.clear();this.selected.add(unselectedNodes)}},toggleSelection:function(node){this.selected[this.selected.get(node.id)?"remove":"add"](node)},clearSelection:function(){this.selected.each(function(node){this.selectManipulator(node,null)},this);this.selected.remove(this.selected.toArray());this.subSelection.clear();this.subSelection.set("type","Object")},removeSelected:function(){var nodes=this.selected.allChildrenDepthFirst();this.clearSelection();_.each(nodes,function(node){node.destroy()},this)},getSelectedByType:function(nodeType,excludedNode){if(!this.selected||this.selected.length<1){return[]}if(excludedNode){return _.filter(this.selected.toArray(),function(node){return node.id!==excludedNode.id&&node.get("type")===nodeType})}else{return _.filter(this.selected.toArray(),function(node){return node.get("type")===nodeType})}},manipulate:function(moveInfo,handleInfo,confirm){var activeManipulator=this.currentManipulator();var manipulator=this.manipulators[activeManipulator];if(!manipulator)return;var subObjectType=this.subSelection.get("type");var indices=this.subSelection.get("indices");var isSubObject=subObjectType!=="Object";if(isSubObject&&indices.length===0)return;var lastSelection=this.selected.length===1?this.selected.last():null;handleInfo=handleInfo||_.clone(manipulator.defaultHandleInfo);if(!confirm){this.set("loadingCommand",true)}if(lastSelection&&lastSelection.selectedManipulator){var opManipulator=lastSelection.selectedManipulator;var operator=opManipulator.operator;var active=this.get("activeManipulator");var callback;if(confirm){callback=opManipulator.gizmo==="Transform"?opManipulator.manipulate[active]:opManipulator.manipulate;manipulator.Operator.manipulate(moveInfo,handleInfo,operator,callback)}else{callback=opManipulator.gizmo==="Transform"?opManipulator.confirm?opManipulator.confirm[active]:opManipulator.manipulate[active]:opManipulator.confirm||opManipulator.manipulate;manipulator.Operator.manipulate(moveInfo,handleInfo,operator,callback)}}else{if(confirm){manipulator[subObjectType].confirm(moveInfo,handleInfo)}else{manipulator[subObjectType].manipulate(moveInfo,handleInfo)}}if(confirm){this.set("loadingCommand",false)}},selectManipulator:function(node,operator,manipulatorName){var operatorManipulator=operator&&operator.manipulations&&manipulatorName?operator.manipulations[manipulatorName]||null:null;if(node.selectedManipulator)node.selectedManipulator.selected=false;node.selectedManipulator=operatorManipulator;if(node.selectedManipulator)node.selectedManipulator.selected=true;this.trigger("selectedManipulator",node,operatorManipulator)},currentManipulator:function(){var lastSelection=this.selected.length===1?this.selected.last():null;if(lastSelection&&lastSelection.selectedManipulator){if(lastSelection.selectedManipulator.gizmo==="Transform"){return this.get("activeManipulator")}else{return lastSelection.selectedManipulator.gizmo}}return this.get("activeManipulator")},getActiveManipulator:function(){return this.manipulators[this.currentManipulator()]},toJSON:function(){var json=highbrow.Model.prototype.toJSON.call(this);delete json.scene;return json},frameAll:function(viewport,excludedTypes){if(viewport){viewport.model.frameTo(this.scene.objectsRootNode.nodes,viewport,true,excludedTypes)}else{this.viewports.each(function(viewport){viewport.model.frameTo(this.scene.objectsRootNode.nodes,viewport,true,excludedTypes)},this)}},frameAllMeshes:function(viewport){this.frameAll(viewport,["Camera","Light"])},frameSelection:function(viewport){var nodes;var considerHierachy;if(this.hasSelection()){nodes=this.selected;considerHierachy=false}else{nodes=this.scene.objectsRootNode.nodes;considerHierachy=true}if(viewport){viewport.model.frameTo(nodes,viewport,considerHierachy)}else{this.viewports.each(function(viewport){viewport.model.frameTo(nodes,viewport,considerHierachy)})}},selection:function(){return this.subSelection.get("type")==="Object"?this.selected:this.subSelection},initializeCommands:function(){var byPlace={};_.each(exo.api.pluginRegistry.getCommands(),function(command){_.each(command.uiPlace,function(path,place){byPlace[place]=byPlace[place]||[];byPlace[place].push(new exo.models.Command(_.extend({command:command,path:path},command.uiState)))},this)},this);_.each(byPlace,function(commands,place){this.commands[place].reset(commands)},this)},addCommand:function(command){_.each(command.uiPlace,function(val,place){this.commands[place].add(new exo.models.Command(_.extend({command:command,path:command.uiPlace[place]},command.uiState)))},this);this.bindHotkey(command)
},bindHotkeys:function(){_.each(exo.api.pluginRegistry.getShortcuts(),this.bindHotkey,this)},bindHotkey:function(command){var editor=this;if(command.shortcut&&!this.hotkeysBound[command.shortcut]){var addShortcut=function(shortcut){Mousetrap.bind(shortcut,function(e){editor.getCtx().exec(command.fullName,{});e.preventDefault();e.stopPropagation();return false});editor.hotkeysBound[shortcut]=true};if(command.shortcut instanceof Array){_.each(command.shortcut,addShortcut)}else{addShortcut(command.shortcut)}}},callWhenDone:function(callback,context){var editor=this;return function(){if(editor.get("loadingCommand")){var existing=_.find(editor.callbacksWaiting,function(waiting){return waiting.callback===callback});if(!existing){editor.callbacksWaiting.push({callback:callback,context:context,args:arguments})}else{existing.context=context;existing.args=arguments}if(!editor.updatingUI){editor.updatingUI=true;setTimeout(function(){editor.onCommandsLoaded()},1e3)}}else{callback.apply(context,arguments)}}},onCommandsLoaded:function(){_.each(this.callbacksWaiting,function(waiting){waiting.callback.apply(waiting.context,waiting.args)},this);this.callbacksWaiting=[];this.updatingUI=false},hasAnySelection:function(){if(this.subSelection.get("type")==="Object"){return this.selected.length>0}else{return this.subSelection.length()>0}},hasAnySubSelection:function(){return this.subSelection.get("type")!=="Object"&&this.subSelection.length()>0},hasSubSelection:function(){return this.subSelection.get("type")!=="Object"},hasSelection:function(){return this.selected.length>0},commandPlaces:["menu","toolbar","manipulatorToolbar","subObjectToolbar","subObjects","viewportsContext","sceneExplorer","selection","objectSelection","faceSelection","edgeSelection","vertexSelection"]},{relations:{scene:exo.sceneGraph.Scene,selected:exo.sceneGraph.Nodes,selectionProperties:exo.models.SelectionProperties,subSelection:exo.models.SubSelection,notifications:exo.models.Notifications},embedded_relations:{viewports:exo.models.Viewports,layout:exo.models.Layout}});exo.math={TWO_PI:Math.PI*2,HALF_PI:Math.PI/2,PRECISION:6,EPSILON:1e-6,framesToSeconds:function(fps,frameNumber){return frameNumber/fps},secondsToFrames:function(fps,timeInSeconds){return timeInSeconds*fps},multiplyMatricesList:function(){var tmpMat=new THREE.Matrix4;return function(matricesList){if(matricesList.length<2){return null}var matrix=new THREE.Matrix4;matrix.copy(matricesList[0]);for(var i=1,il=matricesList.length;i<il;i++){tmpMat.copy(matrix);matrix=matrix.multiplyMatrices(tmpMat,matricesList[i])}return matrix}}(),makeShear:function(matrix,vector3Shear){var xy=vector3Shear.x;var xz=vector3Shear.y;var yz=vector3Shear.z;matrix.set(1,0,0,0,xy,1,0,0,xz,yz,1,0,0,0,0,1);return matrix},degreeToRadian:function(vectorDegree,optionalResult){optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(vectorDegree).multiplyScalar(Math.PI/180)},radianToDegree:function(vectorRadian,optionalResult){optionalResult=optionalResult||new THREE.Vector3;return optionalResult.copy(vectorRadian).multiplyScalar(180/Math.PI)},arrayToVector3:function(arrayInput){if(arrayInput instanceof Array){return new THREE.Vector3(arrayInput[0],arrayInput[1],arrayInput[2])}else{return null}},arrayToColor:function(arrayInput){return(new THREE.Color).setRGB(arrayInput[0],arrayInput[1],arrayInput[2])},approxEqualNumbers:function(a,b){return Math.abs(a-b)<exo.math.EPSILON},approxEqualVectors:function(v1,v2){var eps=exo.math.EPSILON;if(v1 instanceof THREE.Vector3){return Math.abs(v1.x-v2.x)<eps&&Math.abs(v1.y-v2.y)<eps&&Math.abs(v1.z-v2.z)<eps}else if(v1 instanceof THREE.Vector2){return Math.abs(v1.x-v2.x)<eps&&Math.abs(v1.y-v2.y)<eps}else if(v1 instanceof THREE.Color){return Math.abs(v1.r-v2.r)<eps&&Math.abs(v1.g-v2.g)<eps&&Math.abs(v1.b-v2.b)<eps}return false},getRotationFromDirection:function(v1,v2){var directionVector;if(v2){directionVector=(new THREE.Vector3).subVectors(v2,v1)}else{directionVector=v1}var xRot=directionVector.angleTo(new THREE.Vector3(1,0,0));var yRot=directionVector.angleTo(new THREE.Vector3(0,1,0));var zRot=directionVector.angleTo(new THREE.Vector3(0,0,1));return new THREE.Vector3(xRot,yRot,zRot)},isNaN:function(value){if(value instanceof THREE.Vector3){return isNaN(value.x)||isNaN(value.y)||isNaN(value.z)}else if(value instanceof THREE.Vector2){return isNaN(value.x)||isNaN(value.y)}else if(value instanceof THREE.Color){return isNaN(value.r)||isNaN(value.g)||isNaN(value.b)}else{return isNaN(value)}},subColors:function(color1,color2){if(color1 instanceof THREE.Color&&color2 instanceof THREE.Color){var outputColor=color1.clone();outputColor.r-=color2.r;outputColor.g-=color2.g;outputColor.b-=color2.b;return outputColor}return color1},perpendicularVectorToLine:function(line){var center=line.center();var vector=(new THREE.Vector3).subVectors(line.end,line.start);var zVal=-(center.x*vector.x+center.y*vector.y)/(vector.z===0?exo.math.EPSILON:vector.z);return new THREE.Vector3(center.x,center.y,zVal).normalize()},isIntersectionLine:function(plane,line,ingoreCoplanar){var startSign=plane.distanceToPoint(line.start);var endSign=plane.distanceToPoint(line.end);if(ingoreCoplanar){return startSign<0&&endSign>0||endSign<0&&startSign>0}else{return startSign<=0&&endSign>=0||endSign<=0&&startSign>=0}}};exo.api.loadPlugin=function(plugin,registrar){try{var fn=typeof plugin.get("content")==="function"?plugin.get("content"):new Function("registrar",plugin.get("content"));fn(registrar)}catch(e){var name=plugin.get("name");exo.reportError(e,"PLUGIN.load ("+name+")","Error loading plugin: "+name+"\bStack: "+(e.stack!==undefined?e.stack:"undefined"))}};exo.api.loadResource=function(url,callback){$.ajax({url:url,success:function(result,xhr){callback(null,result)},error:callback})};!function(){var PluginRegistrar=function(plugin,registry){this.pluginName=plugin.get("name");this.registry=registry};var waitForServerCommand=function(app,options,data,change){if(exo.clientOnly){throw new Error("Can not run server commands on standalone client")}var deferred=Q.defer();var resolveServerSideChange=function(c){if(c.get("status")==="ok"){change.off("change",resolveServerSideChange);deferred.notify(100);deferred.resolve(true)}else if(c.get("status")==="fail"){change.off("change",resolveServerSideChange);deferred.notify(100);deferred.reject("server side failure")}};change.on("change",resolveServerSideChange);return deferred.promise};_.extend(PluginRegistrar.prototype,{defineCommand:function(command){var name=this.pluginName+"/"+command.name;var invalid=function(message){throw new Error(message+". Invalid command specification, see console.log for details.")};command.fullName=name;if(!command.options)command.options={};if(!command.returns)command.returns={};if(!command.uiPlace)command.uiLocations={};if(!command.uiState)command.uiState={};if(!command.uiState.label)command.uiState.label=command.name;if(!command.uiState.enabled)command.uiState.enabled=true;if(!command.uiState.visible)command.uiState.visible=true;if(!command.uiState.fullName)command.uiState.fullName=command.fullName;if(command.shortcut)this.registry.shortcuts[command.shortcut]=command;if(command.execute){command.serverSideCommand=false;command.commandFunction=command.execute}else{if(command.executeServer)command.serverSideCommand=true;if(highbrow.server){command.commandFunction=command.executeServer}else{command.commandFunction=waitForServerCommand}}var jsName=name.replace(/\//,"_");command.Options=highbrow.extend(exo.models.CommandOptions,"OptionsFor"+jsName,{schema:command.options});this.registry.plugins[this.pluginName][command.name]=command;this.registry.commands[command.fullName]=command;this.registry.trigger("addCommand",command)},defineOperator:function(operator){operator.name=this.pluginName+"/"+operator.name;exo.sceneGraph.registry.addOperator(operator)},defineTranslator:function(translator){var namespace=translator.prototype.namespace;var type=translator.prototype.type;if(!exo.translators[namespace])exo.translators[namespace]={};if(type==="Scene"){exo.translators[namespace][type]=translator}else if(exo.translators[namespace].Scene){var registry=exo.translators[namespace].Scene.prototype.registry;registry.register(type,translator)}}});exo.api.PluginRegistry=function(user){this.models={};this.plugins={};this.commands={};this.shortcuts={};this.user=user;_.each(defaultPlugins,function(model){this.addPlugin(model)},this);this.addPlugin({name:"script",version:"0.0.1"})};_.extend(exo.api.PluginRegistry.prototype,{getPlugin:function(name){return this.plugins[name]},getPluginCommand:function(pluginName,commandName,options){if(pluginName.indexOf("/")!==-1){var parts=pluginName.split("/");pluginName=parts[0];options=commandName;commandName=parts[1]}var plugin=exo.api.pluginRegistry.getPlugin(pluginName);if(!plugin){return{error:"plugin"+pluginName+" not found."}}if(!plugin[commandName]){return{error:"command "+commandName+" not found."}}return{command:plugin[commandName],options:options||{}}},getCommand:function(name){return this.commands[name]},addPlugin:function(model){model=model instanceof exo.models.Plugin?model:new exo.models.Plugin(model);var name=model.get("name");if((!model.get("owner")||this.user.get("username")===model.get("owner"))&&(!model.get("userFlag")||this.user.isA(model.get("userFlag")))){this.models[name]=model;this.plugins[name]={};exo.api.loadPlugin(model,new PluginRegistrar(model,this))}},getCommands:function(){return _.values(this.commands)},getShortcuts:function(){return this.shortcuts},list:function(){return _.keys(this.models)},execScript:function(script,editor){var fn=typeof script==="function"?script:new Function("ctx","registrar",script);var plugin=this.models["script"];editor.set("loadingCommand",true);fn(editor.getCtx(),new PluginRegistrar(plugin,this));editor.set("loadingCommand",false)}},Backbone.Events);var defaultPlugins={};exo.api.definePlugin=function(name,options,script){if(typeof options==="string"){options={version:options}}defaultPlugins[name]=_.extend({name:name,modifiedAt:new Date,_id:uuid.v4(),content:script},options);if(exo.api.pluginRegistry)exo.api.pluginRegistry.addPlugin(defaultPlugins[name])};exo.api.loadPlugins=function(user,done,errorMessage){var plugins=new exo.models.Plugins;plugins.fetchWithFail(user,function(err){if(err)return done(err);plugins.each(function(model){exo.api.pluginRegistry.addPlugin(model)});done()},"Error Loading Plugins")}}();!function(){var pathToRegExp=function(query){if(query instanceof RegExp)return query;query=query.replace(/\*/g,"(.*)").replace(/^\"|\"$/g,"");return new RegExp("^"+query+"$","i")};var re={bareName:"^([^%[#:]*)*",type:"(?:%([^#:]*))*",filter:"(?::([^#:]*))*",plugName:"(?:#([^[]*))*",attrs:"(.*)"};var queryRegex=new RegExp(re.bareName+re.type+re.filter+re.plugName+re.attrs);var attrsRegex=/(?:\[([^\]]*)\])/g;var buildOperatorFilter=function(attrsString){var items,match;var queryObject={};while((match=attrsRegex.exec(attrsString))!==null){items=match[1].split("=");queryObject[items[0]]=items[1]}return function(plug){return plug.operators.find(function(op){return _.all(queryObject,function(v,k){if(v!==undefined){return op.get(k)===v}else{return op.schema[k]!==undefined}})})}};exo.api.selectors={buildQueryFromString:function(query){var matches=queryRegex.exec(query);var name=matches[1];var type=matches[2];var filter=matches[3];var plug=matches[4];var attrs=matches[5];var queryObject={};if(name){var nameRe=pathToRegExp(name);queryObject.name=function(n){return nameRe.exec(n.get("name"))}}if(type){var typeRe=pathToRegExp(type);queryObject.type=function(n){return typeRe.exec(n.get("type"))}}return{nodeFilter:function(n){return _.all(queryObject,function(matchFn){return matchFn(n)})},plug:plug,opFilter:attrs&&buildOperatorFilter(attrs)}}}}();!function(){var ctxExtensions={hasCommand:function(ctx){return function(pluginName,commandName){var plugin=exo.api.pluginRegistry.getPlugin(pluginName);return plugin&&plugin[commandName]}}};_.each(["exec","undo","redo","addFile","addFiles"],function(ctxFunctionName){ctxExtensions[ctxFunctionName]=function(ctx){return function(){var instance=ctx();return instance[ctxFunctionName].apply(instance,_.toArray(arguments))}}});exo.api.addCtxExtension=function(name,definitionFn){ctxExtensions[name]=definitionFn};var ctxExtend=function(ctx){_.each(ctxExtensions,function(definitionFn,name){ctx[name]=definitionFn(ctx)})};exo.api.makeContext=function(context,options){if(!options)options={};var ctx=function(selector){if(context.scene&&context.scene._ctxInstance&&context.scene._ctxInstance._change){return context.scene._ctxInstance.findSelector(selector)}var ctxInstance=new exo.api.Ctx(selector,context,options);if(context.scene){context.scene._ctxInstance=ctxInstance}return ctxInstance};ctx.options=options;ctx.context=context;ctx.scene=context.scene;ctx.editor=context.editor;ctxExtend(ctx);return ctx};var findNodes=function(ctx,selector,matched){if(selector instanceof exo.sceneGraph.SchemaBase){return[selector]}if(!_.isString(selector)){throw new Error("Expect selector to be a string")}var queryInfo=exo.api.selectors.buildQueryFromString(selector);var result=matched?_.filter(matched,queryInfo.nodeFilter):ctx.scene.filter(queryInfo.nodeFilter);if(queryInfo.plug){result=_.map(result,function(n){return n.plugs[queryInfo.plug]});if(queryInfo.opFilter){result=_.map(result,queryInfo.opFilter)}}return result};var applySelector=function(ctx,selector,matched){if(selector==="%Scene"){if(!ctx.scene)throw new Error("'%Scene' is null.\n"+(new Error).stack);return[ctx.scene]}else if(selector==="%Objects"){if(!ctx.scene.objectsRootNode)throw new Error("'%Objects' is null.\n"+(new Error).stack);return[ctx.scene.objectsRootNode]}else if(selector==="%MaterialLibrary"){if(!ctx.scene.defaultMaterialLibrary)throw new Error("'%MaterialLibrary' is null.\n"+(new Error).stack);return[ctx.scene.defaultMaterialLibrary]}else if(selector===":selection"){if(ctx.editor.selected.length>0){return ctx.editor.selected.toArray()}if(!ctx.editor.modelSelection)throw new Error("'ctx.editor.modelSelection' is null.\n"+(new Error).stack);return[ctx.editor.modelSelection]}else{return findNodes(ctx,selector,matched)}};var applySelectors=function(ctx,selectors){return _.reduce(selectors,function(memo,selector){return memo.concat(applySelector(ctx,selector))},[])};exo.api.Ctx=function(selector,context,options){this.context=context;this.options=options;_.extend(this,context||{});if(!this.scene)this.scene=this.editor&&this.editor.scene;this.displayScene=this.editor&&this.editor.displayScene;this._matched=[];if(selector!==undefined){this.findSelector(selector)}};var initChange=function(ctx,attrs){var parentChange=ctx.options.parentChange;var parentChangePath=parentChange?parentChange.get("parentChange")+parentChange.id+":":"";var owner=ctx.scene.context.currentUser.get("username");return new exo.sceneGraph.Change(_.extend({},attrs,{owner:owner,parentChange:parentChangePath}),{ctx:ctx,scene:ctx.scene})};_.extend(exo.api.Ctx.prototype,{findSelector:function(selector){this._matched=_.isArray(selector)?applySelectors(this,selector):applySelector(this,selector);return this},find:function(selector){this._matched=applySelector(this,selector,this._matched);return this},createScene:function(){return this.editor&&this.editor.setScene()},start:function(){this._change=initChange(this);return this},end:function(){var change=this._change;if(!change)return Q.fcall(function(){throw new Error("No Change to end")});delete this._change;if(this.scene)delete this.scene._ctxInstance;return change.evaluate()},exec:function(pluginName,commandName,options){var plugin=exo.api.pluginRegistry.getPluginCommand(pluginName,commandName,options);if(plugin.error){return Q.fcall(function(){throw new Error(plugin.error)})}var change=this._change||initChange(this);var data={};change.addOperation(this.scene,"exec",{key:plugin.command.fullName,runOnServer:plugin.command.serverSideCommand&&highbrow.browser,options:plugin.command.serverSideCommand&&options},{options:options,plugin:plugin});return this._change?this:change.evaluate()},get:function(key){if(!this.length)throw new Error("nothing matched");if(this.length>1)throw new Error("Can not get against multiple matched");return this._matched[0].get(key)},getAt:function(key,time){if(!this.length)throw new Error("nothing matched");if(this.length>1)throw new Error("Can not get against multiple matched");return this._matched[0].getAt(key,time)},set:function(key,value,options){if(!this.length)return;var attrs;if(_.isObject(key)||!key){attrs=key;options=value}else{attrs={};attrs[key]=value}var change=this._change||initChange(this);_.each(this._matched,function(n){change.addOperation(n,"set",attrs)});return this._change?this:change.evaluate()},setAt:function(key,value,time,interpolationType){if(!this.length)return;var attrs;if(_.isObject(key)||!key){attrs=key;time=value}else{attrs={};attrs[key]=value}var change=this._change||initChange(this);_.each(this._matched,function(n){change.addOperation(n,"setAt",{attrs:attrs,time:time,interpolationType:interpolationType})});return this._change?this:change.evaluate()},moveKeyFrame:function(key,oldTime,newTime){if(!this.length)return;var change=this._change||initChange(this);_.each(this._matched,function(n){var value=n.getAt(key,oldTime);var attrs={};attrs[key]=value;change.addOperation(n,"removeKeyFrame",{key:key,time:oldTime});change.addOperation(n,"setAt",{attrs:attrs,time:newTime})});return this._change?this:change.evaluate()},removeKeyFrame:function(key,time){if(!this.length)return;var change=this._change||initChange(this);_.each(this._matched,function(n){console.log(n,"removeKeyFrame",{key:key,time:time});change.addOperation(n,"removeKeyFrame",{key:key,time:time})});return this._change?this:change.evaluate()},addNode:function(name,primitive,plugs){var json;if(_.isObject(name)){json=name;primitive=json.type}if(!exo.sceneGraph.nodes[primitive]){throw new Error("Invalid primitive: "+primitive)}if(!this._matched&&!this._matched.length){throw new Error("No selected nodes")}var parent=this._matched[0];if(!parent){throw new Error("No parent defined")}if(!_.include(parent.allowedChildren,primitive)){throw new Error("Child of `"+parent.get("type")+"` not allowed to be: "+primitive)}var change=this._change||initChange(this);if(!json){var node=new exo.sceneGraph.nodes[primitive]({name:name,type:primitive},plugs);json=_.extend({_id:node.id},node.toJSON())}else{if(json.toJSON)json=json.toJSON()}change.addOperation(parent,"addNode",json);return this._change?this:change.evaluate()},addOperator:function(name,properties){var plug=this._matched[0];var change=this._change||initChange(this);var operator=new exo.sceneGraph.Operator(_.extend({primitive:plug.get("type"),name:name},properties||{}));change.addOperation(plug,"addOperator",operator);var user=this.options.user||{username:"testUser",email:"testUser@email",name:"testUser"};exo.trackEvent("Operator","Add",name,{userId:user.username,email:user.email,userName:user.name});return this._change?this:change.evaluate()},remove:function(){var change=this._change||initChange(this);if(!this._matched.length){return this}var removed={};_.each(this._matched,function(node){if(node instanceof exo.sceneGraph.Operator){change.addOperation(node.plug(),"removeOperator",node.id)}else if(node instanceof exo.sceneGraph.VirtualNode&&node.removable){var nodes=node.allChildrenDepthFirst();_.each(nodes,function(n){if(!removed[n.id]){change.addOperation(n.parentNode(),"removeNode",n.id);removed[n.id]=n}})}});return this._change?this:change.evaluate()},reparent:function(newParent){if(!newParent instanceof exo.sceneGraph.VirtualNode){throw new Error("New parent must be a Node")}var change=this._change||initChange(this);if(!this._matched.length){return this}_.each(this._matched,function(source){if(newParent.canAddChild(source)){if(source.transform){var world=source.transform.getWorldTransform();if(newParent.transform){var parentWorld=newParent.transform.getWorldTransform();world=world.multiply(parentWorld.getInverse(parentWorld))}var op=source.plugs.Transform.operators.find(function(op){return op.schema.translation!==undefined});if(op){change.addOperation(op,"set",{translation:(new THREE.Vector3).getPositionFromMatrix(world),scale:(new THREE.Vector3).getScaleFromMatrix(world),rotation:(new THREE.Vector3).setEulerFromRotationMatrix(world,"ZYX")})}}change.addOperation(newParent,"reparent",source)}});return this._change?this:change.evaluate()},addFile:function(file){var change=this._change||initChange(this);change.addOperation(this.scene,"addFile",file);return this._change?this:change.evaluate()},addFiles:function(files){var change=this._change||initChange(this);_.each(files,function(file){change.addOperation(this.scene,"addFile",file)},this);return this._change?this:change.evaluate()},undo:function(){var changeQueue=this.scene.changeQueue;var toggleUndo=function(change){for(var i=change.changes.length-1;i>=0;i--){toggleUndo(change.changes.at(i))}change.set({undo:true,status:"pending",increment:change.increment()});if(changeQueue)changeQueue.addChange(change)};var changeToUndo=this.scene.changes.undo();if(changeToUndo)toggleUndo(changeToUndo);return this},redo:function(){var changeQueue=this.scene.changeQueue;var toggleRedo=function(change){change.set({undo:false,status:"pending",increment:change.increment()});if(changeQueue)changeQueue.addChange(change);for(var i=0;i<change.changes.length;i++){toggleRedo(change.changes.at(i))}};var changeToRedo=this.scene.changes.redo();if(changeToRedo)toggleRedo(changeToRedo);return this},at:function(idx){return this._matched[idx]},select:function(){this.editor.clearSelection();this.each(function(n){this.editor.select(n.node())},this)}});Object.defineProperty(exo.api.Ctx.prototype,"length",{get:function(){return this._matched.length}});var thisMethods=["forEach","each","map","collect","detect","filter","initial","rest","tail","drop","without","shuffle"];var methods=["reduce","foldl","inject","reduceRight","foldr","every","all","some","any","include","contains","max","min","toArray","size","first","head","take","last","indexOf","lastIndexOf","isEmpty"];_.each(thisMethods,function(method){exo.api.Ctx.prototype[method]=function(){var args=[].slice.call(arguments);args.unshift(this._matched);this._matched=_[method].apply(_,args);return this}});_.each(methods,function(method){exo.api.Ctx.prototype[method]=function(){var args=[].slice.call(arguments);args.unshift(this._matched);return _[method].apply(_,args)}})}();exo.geometry.GeometryUtils=function(){};exo.geometry.GeometryUtils.orderedKey=function(a,b){return Math.min(a,b)+"_"+Math.max(a,b)};exo.geometry.GeometryUtils.stringIndicesToArray=function(){var regexNumber=/^\d+$/;var regexNumberRange=/^\d+-\d+$/;return function(stringIndices,maxIndex,handleImperfections){var i,il;var number;var _maxIndex=maxIndex!==undefined&&maxIndex>=0?maxIndex:Number.MAX_VALUE;handleImperfections=handleImperfections||false;var outIndices=[];if(stringIndices.length==0||!_.isString(stringIndices)||!_.isFunction(stringIndices.split)){return outIndices}var tokens=stringIndices.split(",");for(i=0,il=tokens.length;i<il;i++){var token=tokens[i];if(regexNumber.test(token)){number=parseInt(token);if(number<=_maxIndex){outIndices.push(number)}}else if(regexNumberRange.test(token)){var rangeTokens=token.split("-");var rangeStart=parseInt(rangeTokens[0]);var rangeEnd=parseInt(rangeTokens[1]);if(rangeEnd<rangeStart){console.log("Invalidate string indices. range invalid: "+token)}for(var j=rangeStart;j<=rangeEnd;j++){if(j<=_maxIndex){outIndices.push(j)}}}else{console.log("Invalidate string indices. Can't parse token: "+token)}}if(handleImperfections){outIndices.sort();var current=outIndices[0];var duplicatesRemoved=[current];for(i=1,il=outIndices.length;i<il;i++){var next=outIndices[i];if(current!==next){duplicatesRemoved.push(next)}current=next}outIndices=duplicatesRemoved}return outIndices}}();exo.geometry.GeometryUtils.arrayIndicesToString=function(arrayIndices,handleImperfections){handleImperfections=handleImperfections||false;if(arrayIndices.length==0){return""}if(handleImperfections){arrayIndices.sort()}var outStringTokens=[];var rangeStart=arrayIndices[0];var rangeEnd=rangeStart;for(var i=1,il=arrayIndices.length;i<il;i++){var current=arrayIndices[i];if(rangeStart<=current&&current<=rangeEnd){}else if(current==rangeEnd+1){rangeEnd++}else{if(rangeStart!==rangeEnd){outStringTokens.push(rangeStart+"-"+rangeEnd)}else{outStringTokens.push(rangeStart.toString())}rangeStart=rangeEnd=current}}if(rangeStart!==rangeEnd){outStringTokens.push(rangeStart+"-"+rangeEnd)}else{outStringTokens.push(rangeStart.toString())}return outStringTokens.join(",")};exo.geometry.GeometryUtils.computeEdgeFaces=function(geometry){var i,il,v1,v2,j,k,face,faceIndices,faceIndex,edge,hash,edgeFaceMap={};var orderedKey=exo.geometry.GeometryUtils.orderedKey;function mapEdgeHash(hash,i){if(edgeFaceMap[hash]===undefined){edgeFaceMap[hash]=[]}edgeFaceMap[hash].push(i)}for(i=0,il=geometry.faces.length;i<il;i++){face=geometry.faces[i];if(face instanceof THREE.Face3){hash=orderedKey(face.a,face.b);mapEdgeHash(hash,i);hash=orderedKey(face.b,face.c);mapEdgeHash(hash,i);hash=orderedKey(face.c,face.a);mapEdgeHash(hash,i)}else if(face instanceof THREE.Face4){hash=orderedKey(face.a,face.b);mapEdgeHash(hash,i);hash=orderedKey(face.b,face.c);mapEdgeHash(hash,i);hash=orderedKey(face.c,face.d);mapEdgeHash(hash,i);hash=orderedKey(face.d,face.a);mapEdgeHash(hash,i)}}return edgeFaceMap};exo.geometry.GeometryUtils.computeEdges=function(geometry){var getEdge=function(vertices,a,b){return{start:Math.min(a,b),end:Math.max(a,b)}};var i,il,v1,v2,j,k,face,edges=[],vertices=geometry.vertices;for(i=0,il=geometry.faces.length;i<il;i++){face=geometry.faces[i];if(face instanceof THREE.Face3){edges.push(getEdge(vertices,face.a,face.b));edges.push(getEdge(vertices,face.b,face.c));edges.push(getEdge(vertices,face.c,face.a))}else if(face instanceof THREE.Face4){edges.push(getEdge(vertices,face.a,face.b));edges.push(getEdge(vertices,face.b,face.c));edges.push(getEdge(vertices,face.c,face.d));edges.push(getEdge(vertices,face.d,face.a))}}return edges};exo.geometry.GeometryUtils.computeFacesFromEdges=function(geometry){var getEdgeFace=function(vertices,a,b){var start=Math.min(a,b);var end=Math.max(a,b);return new THREE.Face3(start,end,start)};var i,il,v1,v2,j,k,face,edges=[],vertices=geometry.vertices;for(i=0,il=geometry.faces.length;i<il;i++){face=geometry.faces[i];if(face instanceof THREE.Face3){edges.push(getEdgeFace(vertices,face.a,face.b));edges.push(getEdgeFace(vertices,face.b,face.c));edges.push(getEdgeFace(vertices,face.c,face.a))}else if(face instanceof THREE.Face4){edges.push(getEdgeFace(vertices,face.a,face.b));edges.push(getEdgeFace(vertices,face.b,face.c));edges.push(getEdgeFace(vertices,face.c,face.d));edges.push(getEdgeFace(vertices,face.d,face.a))}}return edges};exo.geometry.SubdivisionModifier=function(subdivisions){this.subdivisions=subdivisions===undefined?1:subdivisions;this.useOldVertexColors=false;this.supportUVs=true;this.debug=false};exo.geometry.SubdivisionModifier.prototype.modify=function(geometry){var repeats=this.subdivisions;while(repeats-->0){this.smooth(geometry)}};exo.geometry.SubdivisionModifier.prototype.smooth=function(oldGeometry){var newVertices=[],newFaces=[],newUVs=[];function v(x,y,z){newVertices.push(new THREE.Vector3(x,y,z))}var scope=this;var orderedKey=exo.geometry.GeometryUtils.orderedKey;var computeEdgeFaces=exo.geometry.GeometryUtils.computeEdgeFaces;function assert(){if(scope.debug&&console&&console.assert)console.assert.apply(console,arguments)}function debug(){if(scope.debug)console.log.apply(console,arguments)}function warn(){if(console)console.log.apply(console,arguments)}function f4(a,b,c,d,oldFace,orders,facei){var newFace=new THREE.Face4(a,b,c,d,null,oldFace.color,oldFace.materialIndex);if(scope.useOldVertexColors){newFace.vertexColors=[];var color,tmpColor,order;for(var i=0;i<4;i++){order=orders[i];color=new THREE.Color,color.setRGB(0,0,0);for(var j=0,jl=0;j<order.length;j++){tmpColor=oldFace.vertexColors[order[j]-1];color.r+=tmpColor.r;color.g+=tmpColor.g;color.b+=tmpColor.b}color.r/=order.length;color.g/=order.length;color.b/=order.length;newFace.vertexColors[i]=color}}newFaces.push(newFace);if(scope.supportUVs){var aUv=[getUV(a,""),getUV(b,facei),getUV(c,facei),getUV(d,facei)];if(!aUv[0])debug("a :( ",a+":"+facei);else if(!aUv[1])debug("b :( ",b+":"+facei);else if(!aUv[2])debug("c :( ",c+":"+facei);else if(!aUv[3])debug("d :( ",d+":"+facei);else newUVs.push(aUv)}}var originalPoints=oldGeometry.vertices;var originalFaces=oldGeometry.faces;var originalVerticesLength=originalPoints.length;var newPoints=originalPoints.concat();var facePoints=[],edgePoints={};var sharpEdges={},sharpVertices=[];var uvForVertices={};function debugCoreStuff(){console.log("facePoints",facePoints,"edgePoints",edgePoints);console.log("edgeFaceMap",edgeFaceMap,"vertexEdgeMap",vertexEdgeMap)}function getUV(vertexNo,oldFaceNo){var j,jl;var key=vertexNo+":"+oldFaceNo;var theUV=uvForVertices[key];if(!theUV){if(vertexNo>=originalVerticesLength&&vertexNo<originalVerticesLength+originalFaces.length){debug("face pt")}else{debug("edge pt")}warn("warning, UV not found for",key);return null}return theUV}function addUV(vertexNo,oldFaceNo,value){var key=vertexNo+":"+oldFaceNo;if(!(key in uvForVertices)){uvForVertices[key]=value}else{warn("dup vertexNo",vertexNo,"oldFaceNo",oldFaceNo,"value",value,"key",key,uvForVertices[key])}}var i,il,j,jl,face;var uvs=oldGeometry.faceVertexUvs[0];var abcd="abcd",vertice;debug("originalFaces, uvs, originalVerticesLength",originalFaces.length,uvs.length,originalVerticesLength);if(scope.supportUVs)for(i=0,il=uvs.length;i<il;i++){for(j=0,jl=uvs[i].length;j<jl;j++){vertice=originalFaces[i][abcd.charAt(j)];addUV(vertice,i,uvs[i][j])}}if(uvs.length===0)scope.supportUVs=false;var uvCount=0;for(var u in uvForVertices){uvCount++}if(!uvCount){scope.supportUVs=false;debug("no uvs")}var avgUv;for(i=0,il=originalFaces.length;i<il;i++){face=originalFaces[i];facePoints.push(face.centroid);newPoints.push(face.centroid);if(!scope.supportUVs)continue;avgUv=new THREE.Vector2;if(face instanceof THREE.Face3){avgUv.x=getUV(face.a,i).x+getUV(face.b,i).x+getUV(face.c,i).x;avgUv.y=getUV(face.a,i).y+getUV(face.b,i).y+getUV(face.c,i).y;avgUv.x/=3;avgUv.y/=3}else if(face instanceof THREE.Face4){avgUv.x=getUV(face.a,i).x+getUV(face.b,i).x+getUV(face.c,i).x+getUV(face.d,i).x;avgUv.y=getUV(face.a,i).y+getUV(face.b,i).y+getUV(face.c,i).y+getUV(face.d,i).y;avgUv.x/=4;avgUv.y/=4}addUV(originalVerticesLength+i,"",avgUv)}var edgeFaceMap=computeEdgeFaces(oldGeometry);var edge,faceIndexA,faceIndexB,avg;var edgeCount=0;var edgeVertex,edgeVertexA,edgeVertexB;var vertexEdgeMap={};var vertexFaceMap={};function addVertexEdgeMap(vertex,edge){if(vertexEdgeMap[vertex]===undefined){vertexEdgeMap[vertex]=[]}vertexEdgeMap[vertex].push(edge)}function addVertexFaceMap(vertex,face,edge){if(vertexFaceMap[vertex]===undefined){vertexFaceMap[vertex]={}}vertexFaceMap[vertex][face]=edge}for(i in edgeFaceMap){edge=edgeFaceMap[i];edgeVertex=i.split("_");edgeVertexA=edgeVertex[0];edgeVertexB=edgeVertex[1];addVertexEdgeMap(edgeVertexA,[edgeVertexA,edgeVertexB]);addVertexEdgeMap(edgeVertexB,[edgeVertexA,edgeVertexB]);for(j=0,jl=edge.length;j<jl;j++){face=edge[j];addVertexFaceMap(edgeVertexA,face,i);addVertexFaceMap(edgeVertexB,face,i)}if(edge.length<2){sharpEdges[i]=true;sharpVertices[edgeVertexA]=true;sharpVertices[edgeVertexB]=true}}for(i in edgeFaceMap){edge=edgeFaceMap[i];faceIndexA=edge[0];faceIndexB=edge[1];edgeVertex=i.split("_");edgeVertexA=edgeVertex[0];edgeVertexB=edgeVertex[1];avg=new THREE.Vector3;assert(edge.length>0,"an edge without faces?!");if(edge.length===1){avg.add(originalPoints[edgeVertexA]);avg.add(originalPoints[edgeVertexB]);avg.multiplyScalar(.5);sharpVertices[newPoints.length]=true}else{avg.add(facePoints[faceIndexA]);avg.add(facePoints[faceIndexB]);
avg.add(originalPoints[edgeVertexA]);avg.add(originalPoints[edgeVertexB]);avg.multiplyScalar(.25)}edgePoints[i]=originalVerticesLength+originalFaces.length+edgeCount;newPoints.push(avg);edgeCount++;if(!scope.supportUVs){continue}avgUv=new THREE.Vector2;avgUv.x=getUV(edgeVertexA,faceIndexA).x+getUV(edgeVertexB,faceIndexA).x;avgUv.y=getUV(edgeVertexA,faceIndexA).y+getUV(edgeVertexB,faceIndexA).y;avgUv.x/=2;avgUv.y/=2;addUV(edgePoints[i],faceIndexA,avgUv);if(edge.length>=2){assert(edge.length===2,"did we plan for more than 2 edges?");avgUv=new THREE.Vector2;avgUv.x=getUV(edgeVertexA,faceIndexB).x+getUV(edgeVertexB,faceIndexB).x;avgUv.y=getUV(edgeVertexA,faceIndexB).y+getUV(edgeVertexB,faceIndexB).y;avgUv.x/=2;avgUv.y/=2;addUV(edgePoints[i],faceIndexB,avgUv)}}debug("-- Step 2 done");var facePt,currentVerticeIndex;var hashAB,hashBC,hashCD,hashDA,hashCA;var abc123=["123","12","2","23"];var bca123=["123","23","3","31"];var cab123=["123","31","1","12"];var abc1234=["1234","12","2","23"];var bcd1234=["1234","23","3","34"];var cda1234=["1234","34","4","41"];var dab1234=["1234","41","1","12"];for(i=0,il=facePoints.length;i<il;i++){facePt=facePoints[i];face=originalFaces[i];currentVerticeIndex=originalVerticesLength+i;if(face instanceof THREE.Face3){hashAB=orderedKey(face.a,face.b);hashBC=orderedKey(face.b,face.c);hashCA=orderedKey(face.c,face.a);f4(currentVerticeIndex,edgePoints[hashAB],face.b,edgePoints[hashBC],face,abc123,i);f4(currentVerticeIndex,edgePoints[hashBC],face.c,edgePoints[hashCA],face,bca123,i);f4(currentVerticeIndex,edgePoints[hashCA],face.a,edgePoints[hashAB],face,cab123,i)}else if(face instanceof THREE.Face4){hashAB=orderedKey(face.a,face.b);hashBC=orderedKey(face.b,face.c);hashCD=orderedKey(face.c,face.d);hashDA=orderedKey(face.d,face.a);f4(currentVerticeIndex,edgePoints[hashAB],face.b,edgePoints[hashBC],face,abc1234,i);f4(currentVerticeIndex,edgePoints[hashBC],face.c,edgePoints[hashCD],face,bcd1234,i);f4(currentVerticeIndex,edgePoints[hashCD],face.d,edgePoints[hashDA],face,cda1234,i);f4(currentVerticeIndex,edgePoints[hashDA],face.a,edgePoints[hashAB],face,dab1234,i)}else{debug("face should be a face!",face)}}newVertices=newPoints;var F=new THREE.Vector3;var R=new THREE.Vector3;var n;for(i=0,il=originalPoints.length;i<il;i++){if(vertexEdgeMap[i]===undefined)continue;F.set(0,0,0);R.set(0,0,0);var newPos=new THREE.Vector3(0,0,0);var f=0;for(j in vertexFaceMap[i]){F.add(facePoints[j]);f++}var sharpEdgeCount=0;n=vertexEdgeMap[i].length;var boundary_case=f!==n;for(j=0;j<n;j++){if(sharpEdges[orderedKey(vertexEdgeMap[i][j][0],vertexEdgeMap[i][j][1])]){sharpEdgeCount++}}F.divideScalar(f);var boundary_edges=0;if(boundary_case){var bb_edge;for(j=0;j<n;j++){edge=vertexEdgeMap[i][j];bb_edge=edgeFaceMap[orderedKey(edge[0],edge[1])].length===1;if(bb_edge){var midPt=originalPoints[edge[0]].clone().add(originalPoints[edge[1]]).divideScalar(2);R.add(midPt);boundary_edges++}}R.divideScalar(4);assert(boundary_edges===2,"should have only 2 boundary edges")}else{for(j=0;j<n;j++){edge=vertexEdgeMap[i][j];var midPt=originalPoints[edge[0]].clone().add(originalPoints[edge[1]]).divideScalar(2);R.add(midPt)}R.divideScalar(n)}newPos.add(originalPoints[i]);if(boundary_case){newPos.divideScalar(2);newPos.add(R)}else{newPos.multiplyScalar(n-3);newPos.add(F);newPos.add(R.multiplyScalar(2));newPos.divideScalar(n)}newVertices[i]=newPos}var newGeometry=oldGeometry;newGeometry.vertices=newVertices;newGeometry.faces=newFaces;newGeometry.faceVertexUvs[0]=newUVs;delete newGeometry.__tmpVertices;newGeometry.computeCentroids();newGeometry.computeFaceNormals();newGeometry.computeVertexNormals()};exo.geometry.FrustumUtilities={containsAnyPoints:function(frustum,points,verticesFound){var planes=frustum.planes;var p0=planes[0];var p1=planes[1];var p2=planes[2];var p3=planes[3];var p4=planes[4];var p5=planes[5];for(var j=0,jl=points.length;j<jl;j++){var pt=points[j];if(p0.distanceToPoint(pt)>=0&&p1.distanceToPoint(pt)>=0&&p2.distanceToPoint(pt)>=0&&p3.distanceToPoint(pt)>=0&&p4.distanceToPoint(pt)>=0&&p5.distanceToPoint(pt)>=0){if(verticesFound){verticesFound.push(j)}else{return true}}}return!!(verticesFound&&verticesFound.length)},safePlaneIntersectLine:function(plane,start,end,optionalTarget){optionalTarget=optionalTarget||new THREE.Vector3;var normal=plane.normal;var dist=-plane.constant;var sx=start.x,sy=start.y,sz=start.z;var ex=end.x,ey=end.y,ez=end.z;var lx=ex-sx,ly=ey-sy,lz=ez-sz;var nx=normal.x,ny=normal.y,nz=normal.z;var px=nx*dist,py=ny*dist,pz=nz*dist;var den=lx*nx+ly*ny+lz*nz;if(Math.abs(den-0)<1e-6){return start}var num=(px-sx)*nx+(py-sy)*ny+(pz-sz)*nz;var factor=THREE.Math.clamp(num/den,0,1);return new THREE.Vector3(sx+factor*lx,sy+factor*ly,sz+factor*lz)},containsAnyFaces:function(frustum,vertices,faces,outputFacesFound){var faceResults=[];var faceResultsBool=[];var cachedVerts=[];var cachedVerts2=[];var planes=frustum.planes;var numPlanes=planes.length;var face=[];var isPolyMesh=false;var isIntersected=false;var _getIntersectedFace=function(face){cachedVerts.length=face.length;for(var v=0,numVerts=face.length;v<numVerts;++v){var vertIdx=face[v];cachedVerts[v]=(new THREE.Vector3).copy(vertices[vertIdx])}var considerFace=true;for(var p=0;p<numPlanes;++p){var plane=planes[p];var passingVertex=false;for(var v=0,numVerts=face.length;v<numVerts;++v){var vert=cachedVerts[v];if(plane.distanceToPoint(vert)>=0){passingVertex=true;break}}if(!passingVertex){considerFace=false;break}}if(considerFace){for(var p=0;p<numPlanes;++p){var plane=planes[p];var greatestResult=-1;for(var v=0,numVerts=cachedVerts.length;v<numVerts;++v){var vert=cachedVerts[v];var result;greatestResult=Math.max(greatestResult,result=faceResults[v]=plane.distanceToPoint(vert));faceResultsBool[v]=result>=0}if(greatestResult<0){break}else if(p===numPlanes-1){return true}else{cachedVerts2.length=0;for(var v=0,numVerts=cachedVerts.length;v<numVerts;++v){if(faceResultsBool[v]){cachedVerts2.push(cachedVerts[v])}else if(numVerts>1){var vert=cachedVerts[v];var prev=(v-1+numVerts)%numVerts;var next=(v+1)%numVerts;if(faceResultsBool[prev]){var prevVert=cachedVerts[prev];cachedVerts2.push(exo.geometry.FrustumUtilities.safePlaneIntersectLine(plane,vert,prevVert))}if(prev!==next&&faceResultsBool[next]){var nextVert=cachedVerts[next];cachedVerts2.push(exo.geometry.FrustumUtilities.safePlaneIntersectLine(plane,vert,nextVert))}}}cachedVerts.length=cachedVerts2.length;for(var v=0,numVerts=cachedVerts2.length;v<numVerts;++v){cachedVerts[v]=cachedVerts2[v]}}}}return false};for(var f=0,numFaces=faces.length;f<numFaces;++f){var _face=faces[f];if(_face instanceof THREE.Face3){face.length=3;face[0]=_face.a;face[1]=_face.b;face[2]=_face.c}else if(_face instanceof THREE.Face4){face.length=4;face[0]=_face.a;face[1]=_face.b;face[2]=_face.c;face[3]=_face.d}else if(_face instanceof Array){face=_.toArray(_face);isPolyMesh=true}if(isPolyMesh&&face.length>3){var triangles=exo.geometry.PolyMeshUtilities.triangulateFace(face);for(var i=0,il=triangles.length;i<il;++i){isIntersected=_getIntersectedFace(triangles[i]);if(isIntersected){break}}}else{isIntersected=_getIntersectedFace(face)}if(isIntersected){if(outputFacesFound){outputFacesFound.push(f)}else{return true}}}return outputFacesFound&&outputFacesFound.length>0},containsAnyEdges:function(frustum,vertices,edges,outputEdgesFound){var planes=frustum.planes;var numPlanes=planes.length;var plane;var isIntersected=false;var _getIntersectedEdge=function(edge){var startVertex=edge.getStartVertex(vertices);var endVertex=edge.getEndVertex(vertices);var distToStartV;var distToEndV;var considerEdge=false;for(var p=0;p<numPlanes;++p){plane=planes[p];distToStartV=plane.distanceToPoint(startVertex);distToEndV=plane.distanceToPoint(endVertex);if(distToStartV<0&&distToEndV<0){break}else{if(distToStartV>=0||distToEndV>=0){var intersection=exo.geometry.FrustumUtilities.safePlaneIntersectLine(plane,startVertex,endVertex);if(distToStartV>=0&&distToEndV<0){endVertex=intersection}else if(distToStartV<0&&distToEndV>=0){startVertex=intersection}}}if(p===numPlanes-1){return true}}return false};for(var i=0,il=edges.length;i<il;++i){isIntersected=_getIntersectedEdge(edges[i]);if(isIntersected){if(outputEdgesFound){outputEdgesFound.push(edges[i].clone())}else{return true}}}return outputEdgesFound&&outputEdgesFound.length>0},applyMatrix4:function(frustum,matrix,optionalNormalMatrix){optionalNormalMatrix=optionalNormalMatrix||(new THREE.Matrix3).getInverse(matrix).transpose();for(var i=0;i<6;i++){frustum.planes[i].applyMatrix4(matrix,optionalNormalMatrix)}return frustum}};exo.geometry.Frustumcaster=function(frustum){this.frustum=frustum!==undefined?frustum.clone():new THREE.Frustum};exo.geometry.Frustumcaster.prototype={set:function(frustum){frustum=frustum||new THREE.Frustum;this.frustum.copy(frustum);return this},intersectsPolyMesh:function(polyMesh,method,subObjects){var verticesFound=null,facesFound=null,edgesFound=null,objectFound=null;var localFrustum=this.frustum.clone();if(method==="Vertex"){verticesFound=subObjects?[]:null;objectFound=exo.geometry.FrustumUtilities.containsAnyPoints(localFrustum,polyMesh.positions,verticesFound)}else if(method==="Edge"){edgesFound=subObjects?[]:null;var edges=exo.geometry.ComponentUtilities.getEdges(polyMesh);objectFound=exo.geometry.FrustumUtilities.containsAnyEdges(localFrustum,polyMesh.positions,edges,edgesFound)}else if(method==="Face"){facesFound=subObjects?[]:null;objectFound=exo.geometry.FrustumUtilities.containsAnyFaces(localFrustum,polyMesh.positions,polyMesh.faces,facesFound)}if(subObjects){return objectFound?{vertices:verticesFound,faces:facesFound,edges:edgesFound,polyMesh:polyMesh}:null}else{return objectFound?{polyMesh:polyMesh}:null}},intersectObject:function(object,method,recursive,subObjects){return this.intersectObjects([object],method,recursive,subObjects)},intersectSingleObject:function(object,method,subObjects){var localFrustum=exo.geometry.FrustumUtilities.applyMatrix4(this.frustum.clone(),(new THREE.Matrix4).getInverse(object.matrixWorld));var verticesFound=null,facesFound=null,edgesFound=null,objectFound=null;if(localFrustum.intersectsSphere(object.geometry.boundingSphere)){if(method==="Vertex"){verticesFound=subObjects?[]:null;objectFound=exo.geometry.FrustumUtilities.containsAnyPoints(localFrustum,object.geometry.vertices,verticesFound)}else if(method==="Edge"){edgesFound=subObjects?[]:null;var edges=exo.geometry.GeometryUtils.computeEdges(object.geometry);objectFound=exo.geometry.FrustumUtilities.containsAnyEdges(localFrustum,object.geometry.vertices,edges,edgesFound)}else if(method==="Face"){facesFound=subObjects?[]:null;objectFound=exo.geometry.FrustumUtilities.containsAnyFaces(localFrustum,object.geometry.vertices,object.geometry.faces,facesFound)}}if(subObjects){return objectFound?{object:object,vertices:verticesFound,faces:facesFound,edges:edgesFound}:null}else{return objectFound?{object:object}:null}},intersectDescendants:function(object,method,intersects,subObjects){var descendants=object.getDescendants();for(var i=0,l=descendants.length;i<l;i++){var object=descendants[i];var result=this.intersectSingleObject(object,method,subObjects);if(result){intersects.push(result)}}},intersectObjects:function(objects,method,recursive,subObjects){method=method||"Face";if(method!=="Vertex"&&method!=="Face"&&method!=="Edge"){throw new Error("Invalid intersection method "+method+", valid methods are face, edge and vertex")}var intersects=[];var numObjects=objects.length;if(recursive){for(var i=0;i<numObjects;++i){this.intersectDescendants(objects[i],method,intersects,subObjects)}}for(var i=0;i<numObjects;++i){var object=objects[i];var result=this.intersectSingleObject(object,method,subObjects);if(result){intersects.push(result)}}return intersects}};!function(){var paths={textures:{checkerboard:"/img/textures/checkerboard.png"},cubeMaps:{packA:{},packB:{Bridge:"/img/textures/cubemaps/Bridge/",Park_Summer:"/img/textures/cubemaps/Park_Summer/",Park_Winter:"/img/textures/cubemaps/Park_Winter/",Swedish_Royal_Castle:"/img/textures/cubemaps/SwedishRoyalCastle/"}}};var gData={textureCube:{}};exo.geometry.MaterialUtilities={createTextureFile:function(_name,_url){return new exo.sceneGraph.File({url:_url,name:_name,type:"image",sourceType:"import"})},createCubeMapFiles:function(name,folderPath){return{map0:exo.geometry.MaterialUtilities.createTextureFile(name+"_posx.jpg",folderPath+"posx.jpg"),map1:exo.geometry.MaterialUtilities.createTextureFile(name+"_negx.jpg",folderPath+"negx.jpg"),map2:exo.geometry.MaterialUtilities.createTextureFile(name+"_posy.jpg",folderPath+"posy.jpg"),map3:exo.geometry.MaterialUtilities.createTextureFile(name+"_negy.jpg",folderPath+"negy.jpg"),map4:exo.geometry.MaterialUtilities.createTextureFile(name+"_posz.jpg",folderPath+"posz.jpg"),map5:exo.geometry.MaterialUtilities.createTextureFile(name+"_negz.jpg",folderPath+"negz.jpg")}},createCubeMapNode:function(scene,libraryCategory,name){var cubeMapFiles=exo.geometry.MaterialUtilities.cubeMapLibrary.getLibrary(libraryCategory,name);_.each(cubeMapFiles,function(file){scene.files.add(file)});return scene.defaultMaterialLibrary.addNode(name,"Material",{Material:{CubeMap:cubeMapFiles}})},getLibraryOptions:function(packs){var packOptions=[];_.each(packs,function(Info,key){packOptions.push(key)});return packOptions},setupLibrary:function(_textureCube){if(_textureCube){gData.textureCube=_textureCube}},getCubeMap:function(){return gData.textureCube},getLibrary:function(libraryType,libraryCategory,libraryName,options){var matProperties={};if(options.cubeMap){exo.geometry.MaterialUtilities.setupLibrary(options.cubeMap)}try{_.extend(matProperties,exo.geometry.MaterialUtilities.materialLibrary[libraryType][libraryCategory][libraryName])}catch(e){return{}}_.each(matProperties,function(matProperty,key){if(_.isFunction(matProperty)){matProperties[key]=matProperty()}});return matProperties}};exo.geometry.MaterialUtilities.textureLibrary={initialize:function(){_.each(paths.textures,function(filePath,key){exo.geometry.MaterialUtilities.textureLibrary[key]=exo.geometry.MaterialUtilities.createTextureFile(filePath)})},getLibrary:function(libraryCategory,libraryName){var texture;try{texture=exo.geometry.MaterialUtilities.textureLibrary[libraryCategory][libraryName]}catch(e){return{}}if(!texture){return null}return texture()}};exo.geometry.MaterialUtilities.cubeMapLibrary={initialize:function(){_.each(paths.cubeMaps,function(content,pack){exo.geometry.MaterialUtilities.cubeMapLibrary[pack]={};_.each(paths.cubeMaps[pack],function(folderPath,key){exo.geometry.MaterialUtilities.cubeMapLibrary[pack][key]=function(){return exo.geometry.MaterialUtilities.createCubeMapFiles(key,folderPath)}})})},getLibrary:function(libraryCategory,libraryName){var cubeMap;try{cubeMap=exo.geometry.MaterialUtilities.cubeMapLibrary[libraryCategory][libraryName]}catch(e){return{}}if(!cubeMap){return{}}return cubeMap()}};exo.geometry.MaterialUtilities.textureLibrary.initialize();exo.geometry.MaterialUtilities.cubeMapLibrary.initialize();exo.geometry.MaterialUtilities.materialLibrary={threeJS:{Polished_Metal:{Orange:{materialType:"Lambert",diffuseColor:16737792,ambientColor:16720384,cubeMap:function(){return gData.textureCube},blendCubeMap:"Mix",reflection:.3},Dark_Orange:{materialType:"Lambert",diffuseColor:16737792,ambientColor:16720384,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Blue:{materialType:"Lambert",diffuseColor:4403,ambientColor:4403,cubeMap:function(){return gData.textureCube},blendCubeMap:"Mix",reflection:.3},Dark_Blue:{materialType:"Lambert",diffuseColor:4403,ambientColor:8806,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Red:{materialType:"Lambert",diffuseColor:6684672,ambientColor:3342336,cubeMap:function(){return gData.textureCube},blendCubeMap:"Mix",reflection:.25},Dark_Red:{materialType:"Lambert",diffuseColor:7798784,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Dark_Green:{materialType:"Lambert",diffuseColor:30481,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},White:{materialType:"Lambert",diffuseColor:16777215,ambientColor:6710886,cubeMap:function(){return gData.textureCube},blendCubeMap:"Mix",reflection:.25},Carmine:{materialType:"Phong",diffuseColor:7798784,specularColor:16755370,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Gold:{materialType:"Phong",diffuseColor:11180356,specularColor:12298905,glossiness:50,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Bronze:{materialType:"Phong",diffuseColor:1377541,specularColor:15623680,glossiness:10,cubeMap:function(){return gData.textureCube},blendCubeMap:"Mix",reflection:.25},Chrome:{materialType:"Phong",diffuseColor:16777215,specularColor:16777215,cubeMap:function(){return gData.textureCube},blendCubeMap:"Multiply"},Pure_Chrome:{materialType:"Lambert",diffuseColor:16777215,cubeMap:function(){return gData.textureCube}},Dark_Chrome:{materialType:"Lambert",diffuseColor:4473924,cubeMap:function(){return gData.textureCube}},Darker_Chrome:{materialType:"Lambert",diffuseColor:2236962,cubeMap:function(){return gData.textureCube}}},Polished_Glass:{Black:{materialType:"Lambert",diffuseColor:1052694,cubeMap:function(){return gData.textureCube},opacityFactor:.975},Dark:{materialType:"Lambert",diffuseColor:1052742,cubeMap:function(){return gData.textureCube},opacityFactor:.25},Blue:{materialType:"Lambert",diffuseColor:6719641,cubeMap:function(){return gData.textureCube},opacityFactor:.75},Light:{materialType:"Lambert",diffuseColor:2241348,cubeMap:function(){return gData.textureCube},opacityFactor:.25,blendCubeMap:"Mix",reflection:.25}},Matte_Glass:{Red:{materialType:"Lambert",diffuseColor:16711680,opacityFactor:.5},Yellow:{materialType:"Lambert",diffuseColor:16777130,opacityFactor:.5},Orange:{materialType:"Lambert",diffuseColor:16759552,opacityFactor:.5}}},vray:{}}}();THREE.ColorConverter=function(){return this};THREE.ColorConverter.fromRGB=function(color,r,g,b){return color.setRGB(r,g,b)};THREE.ColorConverter.fromHex=function(color,hex){return color.setHex(hex)};THREE.ColorConverter.toHex=function(color){return color.getHex()};THREE.ColorConverter.toHexString=function(color){return color.getHexString(color)};THREE.ColorConverter.fromHSL=function(color,h,s,l){return color.setHSL(h,s,l)};THREE.ColorConverter.toHSL=function(color){return color.getHSL(color)};THREE.ColorConverter.fromHSV=function(color,h,s,v){return color.setHSL(h,s*v/((h=(2-s)*v)<1?h:2-h),h*.5)};THREE.ColorConverter.toHSV=function(){var hsv={h:0,s:0,v:0};return function(color){var hsl=color.getHSL();hsl.s*=hsl.l<.5?hsl.l:1-hsl.l;hsv.h=hsl.h;hsv.s=2*hsl.s/(hsl.l+hsl.s);hsv.v=hsl.l+hsl.s;return hsv}}();THREE.ColorConverter.fromStyle=function(color,style){return color.setStyle(style)};THREE.ColorConverter.toStyle=function(color){return color.getStyle(color)};exo.geometry.TransformUtilities={TransformCenterType:{SelectionCenter:0,WorldCenter:1,Pivot:2},RotateOrder:{XYZ:"XYZ",YZX:"YZX",ZXY:"ZXY",XZY:"XZY",YXZ:"YXZ",ZYX:"ZYX"},makeTransformByCenterType:function(polyMeshNode,polyMesh,translation,rotation,scale,transformCenterType,vertexIndices,rotateOrder){var matricesList=[];var tranlationM=new THREE.Matrix4;var rotationM=new THREE.Matrix4;var scalingM=new THREE.Matrix4;var _rotateOrder=rotateOrder?rotateOrder:this.RotateOrder.ZYX;tranlationM.makeTranslation(translation.x,translation.y,translation.z);rotationM.makeRotationFromEuler(exo.math.degreeToRadian(rotation),_rotateOrder);scalingM.makeScale(scale.x,scale.y,scale.z);if(transformCenterType===this.TransformCenterType.SelectionCenter){var pivot,worldTransform;var pivotM=new THREE.Matrix4;var pivotMInverse=new THREE.Matrix4;pivot=exo.geometry.ComponentUtilities.getCentroidByVertices(polyMesh,vertexIndices,worldTransform);pivotM.makeTranslation(pivot.x,pivot.y,pivot.z);pivotMInverse.getInverse(pivotM);matricesList=[tranlationM,pivotM,rotationM,scalingM,pivotMInverse]}else if(transformCenterType===this.TransformCenterType.WorldCenter){matricesList=[tranlationM,rotationM,scalingM]}else if(transformCenterType===this.TransformCenterType.Pivot){var pivotRotate,pivotScale;var pivotRotateM=new THREE.Matrix4;var pivotRotateMInverse=new THREE.Matrix4;var pivotScaleM=new THREE.Matrix4;var pivotScaleMInverse=new THREE.Matrix4;var transformPlug=polyMeshNode.plugs.Transform;if(transformPlug&&transformPlug.operators.last()){pivotRotate=transformPlug.operators.last().get("worldRotatePivot");pivotScale=transformPlug.operators.last().get("worldScalePivot")}if(!pivotRotate){pivotRotate=new THREE.Vector3}if(!pivotScale){pivotScale=new THREE.Vector3}pivotRotateM.makeTranslation(pivotRotate.x,pivotRotate.y,pivotRotate.z);pivotRotateMInverse.getInverse(pivotRotateM);pivotScaleM.makeTranslation(pivotScale.x,pivotScale.y,pivotScale.z);pivotScaleMInverse.getInverse(pivotScaleM);matricesList=[tranlationM,pivotRotateM,rotationM,pivotRotateMInverse,pivotScaleM,scalingM,pivotScaleMInverse]}if(matricesList.length<1){return new THREE.Matrix4}return exo.math.multiplyMatricesList(matricesList)},getLocalPositionByNode:function(node,positionVector){var positionLocal=positionVector.clone();if(node&&node.transform){var matrixWorld=node.transform.getWorldTransform();var inverseMatrix=(new THREE.Matrix4).getInverse(matrixWorld);positionLocal.applyMatrix4(inverseMatrix)}return positionLocal},getLocalPosition:function(worldMatrix,positionVector){var positionLocal=positionVector.clone();if(worldMatrix){var inverseMatrix=(new THREE.Matrix4).getInverse(worldMatrix);positionLocal.applyMatrix4(inverseMatrix)}return positionLocal}};!function(){exo.geometry.Raycaster=function(origin,direction,near,far){this.ray=new THREE.Ray(origin,direction);if(this.ray.direction.lengthSq()>0){this.ray.direction.normalize()}this.near=near||0;this.far=far||Number.MAX_VALUE;this.precision=.001};var sphere=new THREE.Sphere;var facePlane=new THREE.Plane;var intersectPoint=new THREE.Vector3;var matrixPosition=new THREE.Vector3;var inverseMatrix=new THREE.Matrix4;var descSort=function(a,b){return a.distance-b.distance};exo.geometry.Raycaster.prototype={intersectsPolyMesh:function(polyMesh){var vertices=polyMesh.positions;var a,b,c,d;var precision=this.precision;var localRay=this.ray.clone();var previousDistanceSq=Number.MAX_VALUE;var outputs=[];var _triangleContainsPoint=function(vertices,intersectPoint,triangleIndices){return THREE.Triangle.containsPoint(intersectPoint,vertices[triangleIndices[0]],vertices[triangleIndices[1]],vertices[triangleIndices[2]])};for(var f=0,fl=polyMesh.faces.length;f<fl;f++){var face=polyMesh.faces[f];var faceNormal=THREE.Triangle.normal(vertices[face[0]],vertices[face[1]],vertices[face[2]]);facePlane.setFromNormalAndCoplanarPoint(faceNormal,vertices[face[0]]);var planeDistance=localRay.distanceToPlane(facePlane);if(Math.abs(planeDistance)<precision)continue;if(planeDistance<0)continue;var planeSign=localRay.direction.dot(facePlane.normal);if(!(planeSign<0))continue;if(planeDistance<this.near||planeDistance>this.far)continue;intersectPoint=localRay.at(planeDistance,intersectPoint);if(face.length===3){if(!_triangleContainsPoint(vertices,intersectPoint,face)){continue}}else if(face.length>3){var triangles=exo.geometry.PolyMeshUtilities.triangulateFace(face);var containsAnyTriangle=false;for(var i=0,il=triangles.length;i<il;++i){var triangle=triangles[i];if(_triangleContainsPoint(vertices,intersectPoint,triangle)){containsAnyTriangle=true;break}}if(!containsAnyTriangle)continue}outputs.push({distance:planeDistance,point:this.ray.at(planeDistance),face:face,faceIndex:f})}return outputs},intersectPolyFace:function(polyMesh,inverseMatrix,faceIndex){var vertices=polyMesh.positions;var precision=this.precision;this.ray.direction.normalize();var localRay=new THREE.Ray;localRay.copy(this.ray).applyMatrix4(inverseMatrix);var intersectionFound=false;var intersectPt;var face=polyMesh.faces[faceIndex];var _triangleContainsPoint=function(vertices,_intersectPoint,triangleIndices){return THREE.Triangle.containsPoint(_intersectPoint,vertices[triangleIndices[0]],vertices[triangleIndices[1]],vertices[triangleIndices[2]])};var _getTriangleIntersectPoint=function(triangleFace){var faceNormal=THREE.Triangle.normal(vertices[triangleFace[0]],vertices[triangleFace[1]],vertices[triangleFace[2]]);var trianglePlane=new THREE.Plane;trianglePlane.setFromNormalAndCoplanarPoint(faceNormal,vertices[triangleFace[0]]);var _planeDistance=localRay.distanceToPlane(trianglePlane);if(Math.abs(_planeDistance)<precision){return null}if(_planeDistance<this.near||_planeDistance>this.far){return null}return{distance:_planeDistance,point:localRay.at(_planeDistance)}};if(face.length===3){intersectPt=_getTriangleIntersectPoint(face);if(intersectPt&&_triangleContainsPoint(vertices,intersectPt.point,face)){intersectionFound=true}}else if(face.length>3){var triangles=exo.geometry.PolyMeshUtilities.triangulateFace(face);for(var i=0,il=triangles.length;i<il;++i){var triangle=triangles[i];intersectPt=_getTriangleIntersectPoint(triangle);if(intersectPt&&_triangleContainsPoint(vertices,intersectPt.point,triangle)){intersectionFound=true;break}}}if(intersectionFound&&intersectPt){return{point:this.ray.at(intersectPt.distance),distance:intersectPt.distance}}else{return null}}}}();exo.geometry.CloneUtilities={copyIntRaggedArray:function(inputRaggedArray){var outputRaggedArray=[];if(!inputRaggedArray){return outputRaggedArray}for(var i=0;i<inputRaggedArray.length;i++){var inputInnerArray=inputRaggedArray[i];outputRaggedArray.push(inputInnerArray.slice())}return outputRaggedArray},copyIntArray:function(intArray){var newArray=[];if(!intArray){return newArray}for(var i=0;i<intArray.length;i++){newArray.push(intArray[i])}return newArray},copyObjectArray:function(srcArray){var outArray=[];if(!srcArray||srcArray.length<1){return outArray}var firstElement=srcArray[0];if(_.isObject(firstElement)&&_.isFunction(firstElement.clone)){for(var i=0,il=srcArray.length;i<il;i++){outArray.push(srcArray[i].clone())}return outArray}else{return _.clone(srcArray)}},appendArray:function(dstArray,srcArray,cloneData){if(!srcArray||!dstArray||srcArray.length<1){return false}var _appendClone=function(){for(var i=0,il=srcArray.length;i<il;i++){dstArray.push(srcArray[i].clone())}};var _append=function(){for(var i=0,il=srcArray.length;i<il;i++){dstArray.push(srcArray[i])}};if(cloneData){var firstElement=srcArray[0];if(_.isObject(firstElement)&&_.isFunction(firstElement.clone)){_appendClone()}else{_append()}}else{_append()}return true},appendArrayByOffset:function(dstArray,srcArray,offset){if(!srcArray||!dstArray||srcArray.length<1){return false}for(var i=0,il=srcArray.length;i<il;i++){dstArray.push(srcArray[i]+offset)}return true},createArray:function(size,initValue,cloneData){var outArray=[];var _initValue=initValue===undefined?0:initValue;if(size<1){return outArray}var _copyClone=function(){for(var i=0;i<size;i++){outArray.push(_initValue.clone())}};var _copy=function(){for(var i=0;i<size;i++){outArray.push(_initValue)}};if(cloneData){if(_.isObject(initValue)&&_.isFunction(initValue.clone)){_copyClone()}else{_copy()}}else{_copy()}return outArray},copyHomogenousFlatArray:function(inputFlatArray){if(!inputFlatArray||inputFlatArray.length===0){return[]}var firstElement=inputFlatArray[0];if(firstElement===undefined){return[]}if(_.isFunction(firstElement.clone)){var outputFlatArray=[];for(var i=0;i<inputFlatArray.length;i++){var nextFlatArray=inputFlatArray[i];if(Object.prototype.toString.call(nextFlatArray)==="[object Array]"){var newArray=[];for(var j=0;j<nextFlatArray.length;j++){newArray.push(nextFlatArray[j].clone())}outputFlatArray.push(newArray)}else{outputFlatArray.push(nextFlatArray.clone())}}return outputFlatArray}else if(_.isNumber(firstElement)){return inputFlatArray.slice()}throw Error("can not clone array with an element type of "+typeof firstElement)},copyArrayToReference:function(destArray,srcArray){if(!destArray||!srcArray||srcArray.length<1){return false}var firstElement=srcArray[0];if(firstElement===undefined){return false}destArray.length=0;if(_.isNumber(firstElement)){for(var i=0,il=srcArray.length;i<il;i++){destArray.push(srcArray[i])}}else if(_.isObject(firstElement)&&_.isFunction(firstElement.clone)){for(var i=0,il=srcArray.length;i<il;i++){destArray.push(srcArray[i].clone())}}else{return false}return true},copyIntRaggedArrayToReference:function(destArray,srcArray){if(!destArray||!srcArray||srcArray.length<1){return false}destArray.length=0;for(var i=0,il=srcArray.length;i<il;i++){destArray.push(srcArray[i].slice(0))}return true},cloneCamera:function(camera,farClip){if(camera instanceof THREE.OrthographicCamera){return new THREE.OrthographicCamera(camera.left,camera.right,camera.top,camera.bottom,camera.near,farClip!==undefined?farClip:camera.far)}else if(camera instanceof THREE.PerspectiveCamera){return new THREE.PerspectiveCamera(camera.fov,camera.aspect,camera.near,farClip!==undefined?farClip:camera.far)}return null},copyCamera:function(dstCamera,srcCamera,updateMatrix,farClip){if(srcCamera instanceof THREE.OrthographicCamera){dstCamera.left=srcCamera.left;dstCamera.right=srcCamera.right;dstCamera.top=srcCamera.top;dstCamera.bottom=srcCamera.bottom;dstCamera.near=srcCamera.near;dstCamera.far=farClip!==undefined?farClip:srcCamera.far;if(updateMatrix){dstCamera.updateProjectionMatrix()}}else if(srcCamera instanceof THREE.PerspectiveCamera){dstCamera.fov=srcCamera.fov;dstCamera.aspect=srcCamera.aspect;dstCamera.near=srcCamera.near;dstCamera.far=farClip!==undefined?farClip:srcCamera.far;if(updateMatrix){dstCamera.updateProjectionMatrix()}}},_hasCloneFunction:function(objectItem){return _.isFunction(objectItem.clone)||typeof objectItem.clone!==undefined||typeof objectItem.prototype.clone!==undefined}};exo.geometry.PolyMap=function(faces,values,cloneData){if(faces===undefined&&values===undefined){this.faces=[];this.values=[]}else{if(cloneData){this.faces=exo.geometry.CloneUtilities.copyIntRaggedArray(faces);this.values=exo.geometry.CloneUtilities.copyHomogenousFlatArray(values)}else{this.values=values;this.faces=faces}}};exo.geometry.PolyMap.prototype={constructor:exo.geometry.PolyMap,set:function(faces,values){this.faces=faces;this.values=values;return this},setValue:function(index,value){this.values[index]=value},empty:function(){return this.values.length===0},toExpandedValueArray:function(){return exo.geometry.PolyMeshUtilities.toExpandedValuesArray(this.faces,this.values)},deleteFaces:function(faceIndices){this.faces=exo.geometry.PolyMeshUtilities.deleteFromList(this.faces,faceIndices)},deleteVertices:function(vertexIndices){var result=exo.geometry.PolyMeshUtilities.deleteVertices(this.faces,this.values,vertexIndices);this.faces=result.faces;this.values=result.values},explodeFaces:function(){var result=exo.geometry.PolyMeshUtilities.toExplodedFaceValues(this.faces,this.values);this.faces=result.faces;this.values=result.values},removeOrphans:function(){var result=exo.geometry.PolyMeshUtilities.removeOrphans(this.faces,this.values);this.faces=result.faces;this.values=result.values},removeUnusedValues:function(optionalVertexIndices){exo.geometry.PolyMeshUtilities.removeUnusedValues(this.faces,this.values,optionalVertexIndices)},validate:function(polyMeshFaces,validateDeeply,mapName,exitOnFirstError){var errorList=[];if(polyMeshFaces){if(polyMeshFaces.length!==this.faces.length){errorList.push(mapName+": polyMeshFaces / faces are not the same length: "+polyMeshFaces.length+"/"+this.faces.length);if(exitOnFirstError)return errorList}else{for(var i=0;i<this.faces.length;i++){var face=this.faces[i];var polyMeshFace=polyMeshFaces[i];if(polyMeshFace.length!==face.length){errorList.push(mapName+": polyMeshFace["+i+"] / face["+i+"] are not the same length: "+polyMeshFace.length+"/"+face.length);if(exitOnFirstError)return errorList}}}}var localErrorList=exo.geometry.PolyMeshUtilities.validateTopology(this.faces,this.values,validateDeeply,mapName,exitOnFirstError);if(localErrorList.length>0){errorList.push(localErrorList);
if(exitOnFirstError)return errorList}return errorList},clone:function(){return new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(this.faces),exo.geometry.CloneUtilities.copyHomogenousFlatArray(this.values))}};exo.geometry.PolyMesh=function(faces,positions,cloneData){if(faces===undefined&&positions===undefined){this.faces=[];this.positions=[]}else{if(cloneData){this.faces=exo.geometry.CloneUtilities.copyIntRaggedArray(faces);this.positions=exo.geometry.CloneUtilities.copyHomogenousFlatArray(positions)}else{this.faces=faces;this.positions=positions}}this.materialIds=null;this.velocities=null;this.normalMap=null;this.colorMaps={};this.uvMaps={};this.changed={positions:false,faces:false,colors:false,normals:false,uvs:false,materials:false}};exo.geometry.PolyMesh.DEFAULT_MAP="default";exo.geometry.PolyMesh.prototype={constructor:exo.geometry.PolyMesh,set:function(faces,positions,normalMap,uvMaps,colorMaps,materialIDs,velocities){this.faces=faces;this.positions=positions;this.materialIds=materialIDs?materialIDs:null;this.velocities=velocities?velocities:null;this.normalMap=normalMap?normalMap:null;this.colorMaps=colorMaps?colorMaps:{};this.uvMaps=uvMaps?uvMaps:{};return this},empty:function(){return this.positions.length===0},clear:function(clearFaceVertices){if(clearFaceVertices){this.faces=[];this.positions=[]}this.materialIds=null;this.velocities=null;this.normalMap=null;this.colorMaps={};this.uvMaps={}},applyMatrix4:function(matrix){exo.geometry.PolyMeshUtilities.transformPoints(matrix,this.positions);if(this.hasNormalMap()){exo.geometry.PolyMeshUtilities.transformNormals(matrix,this.normalMap.values)}return this},validate:function(validateDeeply,exitOnFirstError){var errorList=[];var exitOnFirstError=exitOnFirstError===undefined?true:exitOnFirstError;var localErrorList=exo.geometry.PolyMeshUtilities.validateTopology(this.faces,this.positions,validateDeeply,"polyMesh",exitOnFirstError);if(localErrorList.length>0){errorList.push(localErrorList);if(exitOnFirstError)return errorList}if(this.materialIds){if(this.materialIds.length!==this.faces.length){errorList.push("materialIds / faces length mismatch: "+this.materialIds.length+" / "+this.faces.length);if(exitOnFirstError)return errorList}if(validateDeeply){for(var i=0,il=this.materialIds.length;i<il;i++){if(exo.math.isNaN(this.materialIds[i])||this.materialIds[i]<0){errorList.push("Invalid value found in materialIds: materialIds["+i+"] = "+this.materialIds[i]);if(exitOnFirstError)return errorList}}}}if(this.hasVelocity()){if(this.velocities.length!==this.positions.length){errorList.push("velocity / position length mismatch: "+this.velocities.length+" / "+this.positions.length);if(exitOnFirstError)return errorList}if(validateDeeply){for(var i=0,il=this.velocities.length;i<il;i++){if(exo.math.isNaN(this.velocities[i])){errorList.push("Invalid values found in velocities");if(exitOnFirstError)return errorList}}}}if(this.normalMap){var localErrorList=this.normalMap.validate(this.faces,validateDeeply,"normalMap",exitOnFirstError);if(localErrorList.length>0){errorList.push(localErrorList);if(exitOnFirstError)return errorList}}_.each(this.uvMaps,function(map,key){var localErrorList=map.validate(this.faces,validateDeeply,"uvMap["+key+"]",exitOnFirstError);if(localErrorList.length>0){errorList.push(localErrorList);if(exitOnFirstError)return errorList}},this);_.each(this.colorMaps,function(map,key){var localErrorList=map.validate(this.faces,validateDeeply,"colorMap["+key+"]",exitOnFirstError);if(localErrorList.length>0){errorList.push(localErrorList);if(exitOnFirstError)return errorList}},this);return errorList},boundingBox:function(optionalTarget){var result=optionalTarget||new THREE.Box3;return result.setFromPoints(this.positions)},shallowClone:function(optionalTarget){var result=optionalTarget||new exo.geometry.PolyMesh;result.faces=this.faces;result.positions=this.positions;result.materialIds=this.materialIds;result.velocities=this.velocities;result.normalMap=this.normalMap;result.colorMaps=this.colorMaps;result.uvMaps=this.uvMaps;return result},clone:function(deepCopy){var result=new exo.geometry.PolyMesh;var i;if(deepCopy===undefined||deepCopy){result.faces=exo.geometry.CloneUtilities.copyIntRaggedArray(this.faces);result.positions=exo.geometry.CloneUtilities.copyHomogenousFlatArray(this.positions);if(this.materialIds){result.materialIds=exo.geometry.CloneUtilities.copyIntArray(this.materialIds)}if(this.hasVelocity()){result.velocities=exo.geometry.CloneUtilities.copyHomogenousFlatArray(this.velocities)}result.normalMap=this.normalMap?this.normalMap.clone():null;_.each(this.uvMaps,function(map,key){result.uvMaps[key]=map.clone()},this);_.each(this.colorsMaps,function(map,key){result.colorsMaps[key]=map.clone()},this)}else{result.faces=this.faces;result.positions=this.positions;result.materialIds=this.materialIds;result.velocities=this.velocities;result.normalMap=this.normalMap;result.colorMaps=this.colorMaps;result.uvMaps=this.uvMaps}return result},toJSON:function(){return{faces:this.faces,positions:this.positions,materialIds:this.materialIds,velocities:this.velocities,normalMap:this.normalMap,colorMaps:this.colorMaps,uvMaps:this.uvMaps}},flipFaces:function(ignoreUpdatingNormals){var vertexIndices=this.faces;for(var i=0,il=vertexIndices.length;i<il;i++){vertexIndices[i].reverse()}if(!ignoreUpdatingNormals&&this.hasNormalMap()){var normals=this.normalMap.values;for(var i=0,il=normals.length;i<il;i++){normals[i].negate()}}var reverseFaceIndices=function(map,key){var faces=map.faces;for(var i=0,il=faces.length;i<il;i++){faces[i].reverse()}};_.each(this.uvMaps,reverseFaceIndices,this);_.each(this.colorMaps,reverseFaceIndices,this);if(this.normalMap){reverseFaceIndices(this.normalMap,this.normalMap.values)}},merge:function(_polyMeshTarget,targetToSrcTransform){if(!_polyMeshTarget||!(_polyMeshTarget instanceof exo.geometry.PolyMesh)||this.getVertexCount()<1||_polyMeshTarget.getVertexCount()<1){return}var polyMeshTarget=_polyMeshTarget.clone();var CloneUtils=exo.geometry.CloneUtilities;var verticesTarget=polyMeshTarget.positions;var facesTarget=polyMeshTarget.faces;var vertexOffset=this.getVertexCount();if(targetToSrcTransform){polyMeshTarget.applyMatrix4(targetToSrcTransform)}if(!this.hasNormalMap()&&polyMeshTarget.hasNormalMap()){this.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(this.faces,this.positions)}if(!polyMeshTarget.hasNormalMap()&&this.hasNormalMap()){polyMeshTarget.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMeshTarget.faces,polyMeshTarget.positions)}if(this.hasMaterialID()&&polyMeshTarget.hasMaterialID()){CloneUtils.appendArray(this.materialIds,polyMeshTarget.materialIds)}else if(this.hasMaterialID()){var matIDs=CloneUtils.createArray(polyMeshTarget.faces.length,0);CloneUtils.appendArray(this.materialIds,matIDs)}else if(polyMeshTarget.hasMaterialID()){this.setDefaultMaterialIDs();CloneUtils.appendArray(this.materialIds,polyMeshTarget.materialIds)}if(verticesTarget){for(var i=0,il=verticesTarget.length;i<il;i++){this.positions.push(verticesTarget[i].clone())}}if(facesTarget){for(var i=0,il=facesTarget.length;i<il;i++){var face=facesTarget[i];var newFace=[];for(var j=0,jl=face.length;j<jl;j++){newFace.push(face[j]+vertexOffset)}this.faces.push(newFace)}}if(this.hasNormalMap()&&polyMeshTarget.hasNormalMap()){var normalOffset=this.getNormalCount();var normalsTarget=polyMeshTarget.normalMap.values;var normalIndicesTarget=polyMeshTarget.normalMap.faces;for(var j=0,jl=normalsTarget.length;j<jl;j++){this.normalMap.values.push(normalsTarget[j].clone())}for(var i=0,il=normalIndicesTarget.length;i<il;i++){var normalIndices=normalIndicesTarget[i];var newNormalIndices=[];for(var j=0,jl=normalIndices.length;j<jl;j++){newNormalIndices.push(normalIndices[j]+normalOffset)}this.normalMap.faces.push(newNormalIndices)}}else{this.normalMap=null}_.each(this.uvMaps,function(uvMap,uvmapName){var uvs1=this.uvMaps[uvmapName];var uvs2=polyMeshTarget.uvMaps[uvmapName];if(uvs2){var uvsOffset=uvs1.values.length;for(i=0,il=uvs2.values.length;i<il;i++){uvs1.values.push(uvs2.values[i].clone())}for(i=0,il=uvs2.faces.length;i<il;i++){var uvIndices=uvs2.faces[i];var newUVs=[];for(var j=0,jl=uvIndices.length;j<jl;j++){newUVs.push(uvIndices[j]+uvsOffset)}uvs1.faces.push(newUVs)}}else{this.uvMaps={}}},this);_.each(this.colorMaps,function(colorMap,colorMapName){var colorMap1=this.colorMaps[colorMapName];var colorMap2=polyMeshTarget.colorMaps[colorMapName];if(colorMap2){var colorsOffset=colorMap1.values.length;for(i=0,il=colorMap2.values.length;i<il;i++){colorMap1.values.push(colorMap2.values[i].clone())}for(i=0,il=colorMap2.faces.length;i<il;i++){var colorIndices=colorMap2.faces[i];var newColors=[];for(var j=0,jl=colorIndices.length;j<jl;j++){newColors.push(colorIndices[j]+colorsOffset)}colorMap1.faces.push(newColors)}}else{this.colorMaps={}}},this)},explodeFaces:function(){if(this.hasNormalMap()){this.normalMap.explodeFaces()}_.each(this.uvMaps,function(map){map.explodeFaces()},this);_.each(this.colorMaps,function(map){map.explodeFaces()},this);if(this.hasVelocity()){this.velocities=exo.geometry.PolyMeshUtilities.toExpandedValuesArray(this.faces,this.velocities)}var result=exo.geometry.PolyMeshUtilities.toExplodedFaceValues(this.faces,this.positions);this.faces=result.faces;this.positions=result.values},deleteFaces:function(faceIndices){this.faces=exo.geometry.PolyMeshUtilities.deleteFromList(this.faces,faceIndices);if(this.materialIds){this.materialIds=exo.geometry.PolyMeshUtilities.deleteFromList(this.materialIds,faceIndices)}_.each(this.uvMaps,function(map){map.deleteFaces(faceIndices)},this);_.each(this.colorMaps,function(map){map.deleteFaces(faceIndices)},this);if(this.normalMap){this.normalMap.deleteFaces(faceIndices)}},deleteVertices:function(vertexIndices){var facesWithSubFaceIndices=[];var faceIndices=[];for(var i=0;i<vertexIndices.length;i++){for(var f=0;f<this.faces.length;f++){var subFaceIndex=this.faces[f].indexOf(vertexIndices[i]);if(subFaceIndex>=0){faceIndices.push(f);facesWithSubFaceIndices.push({faceIndex:f,subFaceIndex:subFaceIndex})}}}var result=exo.geometry.PolyMeshUtilities.deleteVertices(this.faces,this.positions,vertexIndices);this.faces=result.faces;this.positions=result.values;if(this.hasMaterialID()){this.materialIds=exo.geometry.PolyMeshUtilities.deleteFromList(this.materialIds,faceIndices)}if(this.hasVelocity()){this.velocities=exo.geometry.PolyMeshUtilities.deleteFromList(this.velocities,vertexIndices)}_.each(this.uvMaps,function(map){var mapVertexIndices=exo.geometry.PolyMeshUtilities.getValueIndicesFromSubFaceIndices(map.faces,facesWithSubFaceIndices);map.deleteVertices(mapVertexIndices)},this);_.each(this.colorMaps,function(map){var mapVertexIndices=exo.geometry.PolyMeshUtilities.getValueIndicesFromSubFaceIndices(map.faces,facesWithSubFaceIndices);map.deleteVertices(mapVertexIndices)},this);if(this.normalMap){var mapVertexIndices=exo.geometry.PolyMeshUtilities.getValueIndicesFromSubFaceIndices(this.normalMap.faces,facesWithSubFaceIndices);this.normalMap.deleteVertices(mapVertexIndices)}},deleteOrphanedVertices:function(){var result=exo.geometry.PolyMeshUtilities.removeOrphans(this.faces,this.positions);this.faces=result.faces;this.positions=result.values;if(this.normalMap){this.normalMap.removeOrphans()}_.each(this.uvMaps,function(uvMap){uvMap.removeOrphans()},this);_.each(this.colorMaps,function(colorMap){colorMap.removeOrphans()},this)},removeValuesAndFaces:function(faces,values,subFaceIndicesToRemove){var vertexIndices=[];var faceIndices=[];for(var i=0;i<subFaceIndicesToRemove.length;i++){var subFaceIndexSet=subFaceIndicesToRemove[i];vertexIndices.push(faces[subFaceIndexSet.faceIndex][subFaceIndexSet.subFaceIndex]);faceIndices.push(subFaceIndexSet.faceIndex)}vertexIndices=_.uniq(vertexIndices);faceIndices=_.uniq(faceIndices);faces=exo.geometry.PolyMeshUtilities.deleteFromList(faces,faceIndices);vertexIndices=exo.geometry.PolyMeshUtilities.deleteFromList(faces,vertexIndices)},getFacesbyMaterialID:function(material_ID){var materialIDs=this.materialIds;var faceIndices=[];if(materialIDs){for(var i=0,il=materialIDs.length;i<il;i++){if(materialIDs[i]===material_ID){faceIndices.push(i)}}}return faceIndices},triangulate:function(){var newFaces=[];var faces=this.faces;var polygonFace;if(!faces||faces.length<1){return this}var polyMeshTri=new exo.geometry.PolyMesh;polyMeshTri.setVertices(this.positions,true);for(var i=0,il=faces.length;i<il;++i){var face=faces[i];if(face.length>=3){var newFaces=exo.geometry.PolyMeshUtilities.triangulateFace(face);for(var j=0,jl=newFaces.length;j<jl;++j){polygonFace=new exo.geometry.PolygonFace(newFaces[j]);polyMeshTri.addFace(polygonFace)}}}return polyMeshTri},detachFacesToElement:function(ifaceIndices,keepVertexDuplicates,optionalBorderPtIndices){var faces=this.faces;var positions=this.positions;var faceIndices,vertex,newIndex,indexCounter,newFace;var detachedFaces=[],borderPtIndices=[];var newIndicesKeys={};var facesKeyMap={};var ComponentUtils=exo.geometry.ComponentUtilities;if(!faces||!positions||faces.length<2||faces.length===ifaceIndices.length){return[]}if(optionalBorderPtIndices){borderPtIndices=optionalBorderPtIndices}else{var selectedEdges=ComponentUtils.getBorderEdges(this,ifaceIndices);borderPtIndices=ComponentUtils.getVerticesByEdges(selectedEdges)}if(!keepVertexDuplicates){facesKeyMap=exo.geometry.ComponentUtilities.createUsedIndicesHashKeys(this)}var updateFaceIndices=function(_updateFaceIndices,_newIndicesKeys){for(var i=0,il=ifaceIndices.length;i<il;i++){elementIndices=_updateFaceIndices[ifaceIndices[i]];for(var j=0,jLen=elementIndices.length;j<jLen;j++){newIndex=_newIndicesKeys[elementIndices[j]];if(newIndex){elementIndices[j]=newIndex}}}};for(var i=0,il=borderPtIndices.length;i<il;i++){indexCounter=facesKeyMap[borderPtIndices[i]];if(keepVertexDuplicates||indexCounter>1){vertex=positions[borderPtIndices[i]];newIndicesKeys[borderPtIndices[i]]=positions.length;positions.push(vertex.clone())}}updateFaceIndices(this.faces,newIndicesKeys);return ifaceIndices},extrudeFaces:function(ifaceIndices,extrudeType,length){var faces=this.faces;var positions=this.positions;var detachedFaceIndices,polyVertices,polyVertexIndices,face,vertex,edgeBottom,edgeTop,groupNormal;var updatedVertexKeyMap={};var borderEdgesBottom,borderEdgesTop;var ComponentUtils=exo.geometry.ComponentUtilities;if(!faces||!positions){return detachedFaceIndices}groupNormal=exo.geometry.PolyMeshUtilities.computeFacesAverageNormal(this,ifaceIndices);borderEdgesBottom=ComponentUtils.getBorderEdges(this,ifaceIndices);detachedFaceIndices=this.detachFacesToElement(ifaceIndices,true);borderEdgesTop=ComponentUtils.getBorderEdges(this,detachedFaceIndices);for(var i=0;i<detachedFaceIndices.length;i++){face=faces[detachedFaceIndices[i]];for(var j=0;j<face.length;j++){if(!updatedVertexKeyMap[face[j]]){vertex=positions[face[j]];vertex.add(groupNormal.clone().multiplyScalar(length));updatedVertexKeyMap[face[j]]=true}}}updatedVertexKeyMap={};if(borderEdgesTop.length==borderEdgesBottom.length){for(var i=0;i<borderEdgesBottom.length;i++){edgeBottom=borderEdgesBottom[i];edgeTop=borderEdgesTop[i];polyVertexIndices=[edgeBottom.start,edgeBottom.end,edgeTop.end,edgeTop.start];var polyFace=new exo.geometry.PolygonFace(polyVertexIndices);this.addFace(polyFace)}}return detachedFaceIndices},hasFace:function(){return this.faces.length>0},getFacesByIndices:function(ifaceIndices){var selectedFaces=[];for(var i=0,il=ifaceIndices.length;i<il;i++){selectedFaces.push(this.faces[ifaceIndices[i]].slice(0))}return selectedFaces},sliceFaces:function(plane,faceList,cutPolyMesh){var firstIndexOfVector=function(vector,vectorList){for(var i=0,il=vectorList.length;i<il;i++){if(exo.math.approxEqualVectors(vector,vectorList[i])){return i}}return-1};var searchAndAdd=function(newValue,storedFacesValues,newStoredFaceValues,newStoredFaceIndices,ignoreSameIndex){var itemlPos=firstIndexOfVector(newValue,storedFacesValues);if(itemlPos<0){itemlPos=firstIndexOfVector(newValue,newStoredFaceValues);if(itemlPos>=0){itemlPos+=storedFacesValues.length}}if(itemlPos>=0){if(!ignoreSameIndex||_.find(newStoredFaceIndices,function(num){return num==itemlPos})==undefined){newStoredFaceIndices.push(itemlPos);return itemlPos}}else{var newIndex=storedFacesValues.length+newStoredFaceValues.length;newStoredFaceIndices.push(storedFacesValues.length+newStoredFaceValues.length);newStoredFaceValues.push(newValue);return newIndex}return-1};var intersections=[];var ComponentUtils=exo.geometry.ComponentUtilities;var sliceAllFaces=!(faceList&&faceList.length);var faces=this.faces;var vertices=this.positions;var normalMap=this.normalMap;var materialIDs=this.materialIds;var uvMaps=this.uvMaps;var neighborFacesKeys={};if(!faces||!vertices){return intersections}if(!sliceAllFaces){var borderEdges=ComponentUtils.getBorderEdges(this,faceList);var borderEdgesKeys=ComponentUtils.createSelectedEdgesHashKeys(borderEdges);var plusNeighborFaces=ComponentUtils.getFacesByEdges(this,borderEdges,borderEdgesKeys);var selectedFaces=_.difference(plusNeighborFaces,faceList);neighborFacesKeys=ComponentUtils.createVertexIndicesHashKeys(selectedFaces)}var faceListKeys=sliceAllFaces?null:ComponentUtils.createVertexIndicesHashKeys(faceList);var outFaces=[];var outVertices=[];var outNormalMap=normalMap?{faces:[],values:[]}:null;var outuvMaps={};var outMaterialIDs=materialIDs?[]:null;var vertexPos,normalPos,uvPos;_.each(uvMaps,function(uvMap,key){outuvMaps[key]={faces:[],values:[]}});for(var step=0,istep=cutPolyMesh?2:1;step<istep;step++){for(var faceIndex=0,iface=faces.length;faceIndex<iface;faceIndex++){var applySlice=sliceAllFaces||faceListKeys[faceIndex]!==undefined;if(step==1&&!applySlice){continue}var faceVertexIndices=faces[faceIndex];var normalIndices=outNormalMap?normalMap.faces[faceIndex]:[];var newface=[];var newNormalIndices=[];var newUvIndices=[];var newNormals=[];var newUVs={};var newVertices=[];_.each(uvMaps,function(uvMap,key){newUVs[key]=[]});var normal;for(var edgeIndex=0,edgeIndexLen=faceVertexIndices.length;edgeIndex<edgeIndexLen;edgeIndex++){var edgeIndexEnd=edgeIndex+1==edgeIndexLen?0:edgeIndex+1;var vertexIndex1=faceVertexIndices[edgeIndex];var vertexIndex2=faceVertexIndices[edgeIndexEnd];var vertex1=vertices[vertexIndex1];var vertex2=vertices[vertexIndex2];var line=new THREE.Line3(vertex1,vertex2);var distToV1=plane.distanceToPoint(vertex1);if(!applySlice||neighborFacesKeys[faceIndex]||step==0&&distToV1<=0||step==1&&distToV1>0){var vertexAdded=searchAndAdd(vertex1.clone(),outVertices,newVertices,newface,true);if(vertexAdded>=0){if(outNormalMap){normal=normalMap.values[normalIndices[edgeIndex]];searchAndAdd(normal.clone(),outNormalMap.values,newNormals,newNormalIndices)}_.each(outuvMaps,function(outuvMap,key){var uvIndices=uvMaps[key].faces[faceIndex];var uv=uvMaps[key].values[uvIndices[edgeIndex]];searchAndAdd(uv.clone(),outuvMaps[key].values,newUVs[key],newUvIndices)})}}if((applySlice||neighborFacesKeys[faceIndex])&&exo.math.isIntersectionLine(plane,line)){if(neighborFacesKeys[faceIndex]){if(!ComponentUtils.isEdge(vertexIndex1,vertexIndex2,borderEdgesKeys)){continue}}var intersect=plane.intersectLine(line);if(intersect!==undefined){intersected=true;var vertexAdded=searchAndAdd(intersect.clone(),outVertices,newVertices,newface,true);if(vertexAdded>=0){intersections.push(vertexAdded);if(outNormalMap){var normalEdgeLeft=normalMap.values[normalIndices[edgeIndex]];var normalEdgeRight=normalMap.values[normalIndices[edgeIndexEnd]];normal=(new THREE.Vector3).addVectors(normalEdgeLeft,normalEdgeRight).normalize();searchAndAdd(normal,outNormalMap.values,newNormals,newNormalIndices)}var distVertex12=vertex1.distanceTo(vertex2);var distVertex1=vertex1.distanceTo(intersect)/distVertex12;_.each(outuvMaps,function(outuvMap,key){var uvIndices=uvMaps[key].faces[faceIndex];var uvStart=uvMaps[key].values[uvIndices[edgeIndex]];var uvEnd=uvMaps[key].values[uvIndices[edgeIndexEnd]];var newUV=(new THREE.Vector2).addVectors(uvStart,(new THREE.Vector2).subVectors(uvEnd,uvStart).multiplyScalar(distVertex1));searchAndAdd(newUV,outuvMaps[key].values,newUVs[key],newUvIndices)})}}}}if(newface.length>2){outFaces.push(newface);for(var i=0,il=newVertices.length;i<il;i++){outVertices.push(newVertices[i])}if(materialIDs){outMaterialIDs.push(materialIDs[faceIndex])}if(normalMap&&newNormalIndices.length>2){outNormalMap.faces.push(newNormalIndices);for(var i=0,il=newNormals.length;i<il;i++){outNormalMap.values.push(newNormals[i])}}if(!_.isEmpty(outuvMaps)&&newUvIndices.length){_.each(outuvMaps,function(outuvMap,key){outuvMaps[key].faces.push(newUvIndices);for(var i=0,il=newUVs[key].length;i<il;i++){outuvMaps[key].values.push(newUVs[key][i])}})}}}}this.faces=outFaces;this.positions=outVertices;if(normalMap&&outNormalMap){this.normalMap=new exo.geometry.PolyMap(outNormalMap.faces,outNormalMap.values)}else{this.normalMap=null}if(outMaterialIDs&&outMaterialIDs.length){this.materialIds=outMaterialIDs}else{this.materialIds=null}if(!_.isEmpty(outuvMaps)){this.uvMaps={};_.each(outuvMaps,function(outuvMap,key){this.uvMaps[key]=new exo.geometry.PolyMap(outuvMap.faces,outuvMap.values)},this)}else{this.uvMaps={}}this.colorMaps={};this.velocities=null;return _.uniq(intersections)},weldVertices:function(vertexIndices,threshold){var weldStatus=false;var SubUtils=exo.geometry.ComponentUtilities;var allEdgesKeys=SubUtils.createEdgesHashKeys(this);var selectedEdges=SubUtils.getEdgesByVertices(this,vertexIndices,allEdgesKeys,true,threshold);var virtualBorderEdges=SubUtils.getVirtualBorderEdgesByVertices(this,vertexIndices,allEdgesKeys,threshold);if(virtualBorderEdges.length){selectedEdges=selectedEdges.concat(virtualBorderEdges)}if(selectedEdges.length<1){return false}var selectedEdgesGroups=SubUtils.getConnectedEdges(selectedEdges);for(var i=0,il=selectedEdgesGroups.length;i<il;i++){var gWeldResult=this.weldEdges(selectedEdgesGroups[i]);if(gWeldResult.status){if(i+1<il){SubUtils.updateConnectedEdgesIndices(selectedEdgesGroups,gWeldResult.vertexIndicesKeys,i+1)}weldStatus=gWeldResult.status}}return weldStatus},weldEdges:function(edges){var vertices=this.positions;var faces=this.faces;var normalMap=this.normalMap;var colorMaps=this.colorMaps;var uvMaps=this.uvMaps;var vertexAverage,vertex,face,vertexIndex,deletedFaces,destinationIndex,faceSize,unusedVertexIndex;var newVertices=[],newFaces=[],newFace=[],possibleUnusedVertices=[],faceOrder=[];var newIndicesMap={},newFaceMap={},temporaryFaceMap={};var output={status:false,vertexIndicesKeys:{}};if(edges.length<1){return{status:false,faceIndices:{}}}if(!(edges[0]instanceof exo.geometry.Edge)){console.log("The inputs are not instances of Edge data type");return output}var SubUtils=exo.geometry.ComponentUtilities;var PolyUtils=exo.geometry.PolyMeshUtilities;var vertexIndices=SubUtils.getVerticesByEdges(edges);var vertexAverage=PolyUtils.computeAverageVertex(this,vertexIndices);var faceConverter=new exo.geometry.FaceConverter;var delVertexIndicesKeys=SubUtils.createVertexIndicesHashKeys(vertexIndices);destinationIndex=newVertices.length;newVertices.push(vertexAverage);for(var i=0,il=vertices.length;i<il;i++){if(delVertexIndicesKeys[i]){newIndicesMap[i]=destinationIndex}else{newIndicesMap[i]=newVertices.length;newVertices.push(vertices[i])}}for(var f=0,fl=faces.length;f<fl;f++){face=faces[f];newFace=[];subFaceIndices=[];temporaryFaceMap={};faceSize=0;for(var i=0,il=face.length;i<il;i++){vertexIndex=newIndicesMap[face[i]];if(temporaryFaceMap[vertexIndex]===undefined){temporaryFaceMap[vertexIndex]=i;newFace.push(vertexIndex);subFaceIndices.push(faceConverter.createSubFaceIndex(f,i));faceSize=faceSize+1}}if(faceSize>2){newFaces.push(newFace);_.extend(newFaceMap,temporaryFaceMap);faceConverter.addFaceFlag(subFaceIndices)}else{faceConverter.removeFaceFlag();for(var i=0,il=face.length;i<il;i++){vertexIndex=newIndicesMap[face[i]];if(newFaceMap[vertexIndex]===undefined){possibleUnusedVertices.push(vertexIndex)}}}}deletedFaces=faceConverter.getRemovedFaceIndices();if(this.materialIds){this.materialIds=PolyUtils.deleteFromList(this.materialIds,deletedFaces)}if(this.normalMap){faceConverter.convert(this.normalMap.faces,this.normalMap.values)}_.each(this.uvMaps,function(map){faceConverter.convert(map.faces,map.values)},this);_.each(this.colorMaps,function(map){faceConverter.convert(map.faces,map.values)},this);this.positions=newVertices;this.faces=newFaces;this.removeUnusedValues(possibleUnusedVertices);output.status=true;output.vertexIndicesKeys=newIndicesMap;return output},removeUnusedValues:function(optionalVertexIndices,optionalMapValueIndices){exo.geometry.PolyMeshUtilities.removeUnusedValues(this.faces,this.positions,optionalVertexIndices);if(this.normalMap){this.normalMap.removeUnusedValues(optionalMapValueIndices)}_.each(this.uvMaps,function(uvMap){uvMap.removeUnusedValues(optionalMapValueIndices)},this);_.each(this.colorMaps,function(colorMap){colorMap.removeUnusedValues(optionalMapValueIndices)},this)},addFace:function(polygonFace){if(!polygonFace){return-1}var faceNormal,normalIndex,matID,normalIndices=[];var faceIndex=this.faces.length;var vertexIndices=polygonFace.getVertexIndices();if(!vertexIndices){return-1}this.faces.push(vertexIndices);if(this.hasNormalMap()){normalIndices=polygonFace.getNormalsIndices();if(normalIndices){this.addNormalIndices(normalIndices)}else{this.addDefaultFaceNormals(vertexIndices)}}if(this.hasMaterialID()){matID=polygonFace.getMaterialID();this.addMaterialID(matID<0?0:matID)}if(this.hasUVMap()){if(polygonFace.getUVMapsCount()>0){_.each(polygonFace.getUVMaps(),function(uvMapIndices,mapName){this.addUVIndices(uvMapIndices,mapName)},this)}else{this.addDefaultFaceUvs(vertexIndices.length)}}if(this.hasColorMap()){if(polygonFace.getColorMapsCount()>0){_.each(polygonFace.getColorMaps(),function(colorMapIndices,mapName){this.addVertexColorIndices(colorMapIndices,mapName)},this)}else{this.addDefaultFaceColors(vertexIndices.length)}}return faceIndex},updateFace:function(faceIndex,polygonFace){if(!polygonFace||faceIndex<0||faceIndex>=this.faces.length){return false}var vertexIndices=polygonFace.getVertexIndices();if(!vertexIndices){return-1}exo.geometry.CloneUtilities.copyArrayToReference(this.faces[faceIndex],vertexIndices);if(this.hasNormalMap()){var normalIndices=polygonFace.getNormalsIndices();if(normalIndices){exo.geometry.CloneUtilities.copyArrayToReference(this.normalMap.faces[faceIndex],normalIndices)}}if(this.hasMaterialID()){var matID=polygonFace.getMaterialID();if(matID>0){this.setMaterialID(matID,faceIndex)}}if(this.hasUVMap()){if(polygonFace.getUVMapsCount()>0){_.each(polygonFace.getUVMaps(),function(uvMapIndices,mapName){exo.geometry.CloneUtilities.copyArrayToReference(this.uvMaps[mapName].faces[faceIndex],uvMapIndices)},this)}}if(this.hasColorMap()){if(polygonFace.getColorMapsCount()>0){_.each(polygonFace.getColorMaps(),function(colorMapIndices,mapName){exo.geometry.CloneUtilities.copyArrayToReference(this.colorMaps[mapName].faces[faceIndex],colorMapIndices)},this)}}return true},removeVertices:function(vertexIndices){var status=false;if(!vertexIndices||this.getFacesCount()<1||this.getVertexCount()<1){return status}var vIndices=vertexIndices.slice(0);for(var i=0,il=vIndices.length;i<il;i++){var removeStatus=exo.geometry.PolyMeshUtilities.removeVertex(this,vIndices[i])}this.removeUnusedValues();return status},removeEdges:function(edges){var edge;if(this.getFacesCount()<1||this.getVertexCount()<1||!edges||edges.length<1){return false}for(var i=0,il=edges.length;i<il;i++){exo.geometry.PolyMeshUtilities.removeEdge(this,edges[i])}this.removeUnusedValues();return true},getFacesCount:function(){return this.faces.length},hasVertex:function(){return this.positions.length>0},addVertex:function(vertex){var faceIndex=this.positions.length;this.positions.push(vertex);return faceIndex},setVertices:function(vertexValues,cloneVertices){if(cloneVertices){this.positions=exo.geometry.CloneUtilities.copyHomogenousFlatArray(vertexValues)}else{this.positions=vertexValues}},setVertexIndex:function(face,faceCornerIndex,vertexIndex){this.faces[face][faceCornerIndex]=vertexIndex},getVertexCount:function(){return this.positions.length},getVertices:function(vertexIndices){var vertices=this.positions;if(vertexIndices){var selectedVertices=[];for(var i=0,il=vertexIndices.length;i<il;i++){selectedVertices.push(vertices[vertexIndices[i]])}return selectedVertices}else{return vertices}},hasNormalMap:function(){return this.normalMap!=null},setNormalMap:function(polyMap){this.normalMap=polyMap},addNormal:function(normal){var normalIndex=this.normalMap.values.length;this.normalMap.values.push(normal);return normalIndex},addNormalIndices:function(normalIndices){var normalFaceIndex=this.normalMap.faces.length;this.normalMap.faces.push(normalIndices);return normalFaceIndex},addDefaultFaceNormals:function(faceVertexIndices){var normalIndices=[];var normalIndex,faceNormal;if(faceVertexIndices.length<3||this.positions.length<1){return-1}faceNormal=exo.geometry.PolyMeshUtilities.computeNormal(faceVertexIndices,this.positions);normalIndex=this.addNormal(faceNormal);for(var i=0,il=faceVertexIndices.length;i<il;i++){normalIndices.push(normalIndex)}this.addNormalIndices(normalIndices);return normalIndex},getNormalIndex:function(face,faceCornerIndex,normalIndex){return this.normalMap.faces[face][faceIndex]},setNormalIndex:function(face,faceCornerIndex,normalIndex){this.normalMap.faces[face][faceIndex]=normalIndex},getNormalCount:function(){return this.hasNormalMap()&&this.normalMap.values?this.normalMap.values.length:0},hasUVMap:function(channel){return channel?channel in this.uvMaps:!_.isEmpty(this.uvMaps)},setUVMap:function(polyMap,channel){if(!this.uvMaps){this.uvMaps={}}this.uvMaps[channel?channel:exo.geometry.PolyMesh.DEFAULT_MAP]=polyMap},addUV:function(uv,channel){var uvIndex;if(channel){uvIndex=this.uvMaps[channel].values.length;this.uvMaps[channel].values.push(uv)}else{_.each(this.uvMaps,function(uvMap,mapName){uvIndex=uvMap.values.length;uvMap.values.push(uv)})}return uvIndex},addUVIndices:function(uvIndices,channel){var uvFaceIndex;if(channel){uvFaceIndex=this.uvMaps[channel].faces.length;this.uvMaps[channel].faces.push(uvIndices)}else{_.each(this.uvMaps,function(uvMap,mapName){uvFaceIndex=uvMap.faces.length;uvMap.faces.push(uvIndices)})}return uvFaceIndex},addDefaultFaceUvs:function(faceSize,defaultVec2UV){if(faceSize<1){return-1}var uvIndex=defaultVec2UV&&defaultVec2UV instanceof THREE.Vector2?this.addUV(defaultVec2UV):this.addUV(new THREE.Vector2(0,0));var uvIndices=[];for(var i=0,il=faceSize;i<il;i++){uvIndices.push(uvIndex)}this.addUVIndices(uvIndices);return uvIndex},hasColorMap:function(channel){return channel?channel in this.colorMaps:!_.isEmpty(this.colorMaps)},setColorMap:function(polyMap,channel){if(!this.colorMaps){this.colorMaps={}}this.colorMaps[channel?channel:exo.geometry.PolyMesh.DEFAULT_MAP]=polyMap},setDefaultColorMap:function(channel,defaultColor){if(!this.colorMaps){this.colorMaps={}}var colorIndices=[],colorFaceIndices=[];var face,color;var color=defaultColor&&defaultColor instanceof THREE.Color?defaultColor:new THREE.Color;for(var i=0,il=this.faces;i<il;i++){face=this.faces[i];colorFaceIndices=[];for(var j=0,jl=face.length;j<jl;j++){colorFaceIndices.push(0)}colorIndices.push(colorFaceIndices)}this.colorMaps[channel?channel:exo.geometry.PolyMesh.DEFAULT_MAP]=new exo.geometry.PolyMap(colorIndices,color)},addVertexColor:function(color,channel){var colorIndex;if(channel){colorIndex=this.colorMaps[channel].values.length;this.colorMaps[channel].values.push(color)}else{_.each(this.colorMaps,function(colorMap,mapName){colorIndex=colorMap.values.length;colorMap.values.push(color)})}return colorIndex},addVertexColorIndices:function(vertexColorIndices,channel){var colorFaceIndex;if(channel){colorFaceIndex=this.colorMaps[channel].faces.length;this.colorMaps[channel].faces.push(vertexColorIndices)}else{_.each(this.colorMaps,function(colorMap,mapName){colorFaceIndex=colorMap.faces.length;
colorMap.faces.push(vertexColorIndices)})}return colorFaceIndex},addDefaultFaceColors:function(faceSize,defaultColor){if(faceSize<1){return-1}var colorIndex=defaultColor&&defaultColor instanceof THREE.Color?this.addVertexColor(defaultColor):this.addVertexColor(new THREE.Color);var colorIndices=[];for(var i=0,il=faceSize;i<il;i++){colorIndices.push(colorIndex)}this.addVertexColorIndices(colorIndices);return colorIndex},hasMaterialID:function(){return this.materialIds&&this.materialIds.length>0},addMaterialID:function(matID){var materialIndex=this.materialIds.length;this.materialIds.push(matID);return materialIndex},getMaterialIDs:function(){return this.materialIds},getMaterialID:function(faceIndex){if(this.materialIds&&faceIndex<this.materialIds.length){return this.materialIds[faceIndex]}return-1},getMaterialIDsCount:function(){return this.materialIds?this.materialIds.length:0},getUniqMaterialIDsCount:function(){return this.materialIds?_.uniq(this.materialIds).length:0},getUniqMaterialIDs:function(){return this.materialIds?_.uniq(this.materialIds):[]},setMaterialID:function(material_ID,faceIndex){if(this.materialIds&&faceIndex<this.materialIds.length){this.materialIds[faceIndex]=material_ID}},setMaterialIDs:function(material_ID,startFace,endFace){var faces=this.faces;var start=startFace!==undefined?startFace:0;var end=endFace!==undefined?endFace:faces.length-1;var materialID;this.setDefaultMaterialIDs();var materialIDs=this.materialIds;for(var i=start,il=end;i<=il;i++){materialIDs[i]=material_ID}},setDefaultMaterialIDs:function(){var hasIDs=this.hasMaterialID();if(!hasIDs||this.getFacesCount()!==this.getMaterialIDsCount()){var matIDs=[];for(var i=0,il=this.faces.length;i<il;i++){matIDs.push(0)}this.materialIds=matIDs}},hasVelocity:function(){return this.velocities!=null||this.velocities&&this.velocities.length>0},clearChanged:function(){for(var key in this.changed){if(this.changed.hasOwnProperty(key)){this.changed[key]=false}}}};exo.geometry.PolyMesh.fromJSON=function(geometry){var positions=_.map(geometry.positions,function(v){return new THREE.Vector3(v.x,v.y,v.z)});var mesh=new exo.geometry.PolyMesh(exo.geometry.CloneUtilities.copyIntRaggedArray(geometry.faces),positions);if(geometry.velocities&&geometry.velocities.length>0){mesh.velocities=_.map(geometry.velocities,function(v){return new THREE.Vector3(v.x,v.y,v.z)})}if(geometry.materialIds&&geometry.materialIds.length>0){mesh.materialIds=geometry.materialIds.slice(0)}if(geometry.normalMap){var normals=_.map(geometry.normalMap.values,function(v){return new THREE.Vector3(v.x,v.y,v.z)});mesh.normalMap=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(geometry.normalMap.faces),normals)}_.each(geometry.colorMaps,function(colorMap,key){var colorMapNew=_.map(colorMap.values,function(v){return(new THREE.Color).setRGB(v.r,v.g,v.b)});mesh.colorMaps[key]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(colorMap.faces),colorMapNew)});_.each(geometry.uvMaps,function(uvMap,key){var uvMapNew=_.map(uvMap.values,function(v){return new THREE.Vector2(v.x,v.y)});mesh.uvMaps[key]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(uvMap.faces),uvMapNew)});return mesh};exo.geometry.Edge=function(indexV1,indexV2){this.start=indexV1!==undefined?indexV1:0;this.end=indexV2!==undefined?indexV2:0;return this};exo.geometry.Edge.prototype={constructor:exo.geometry.Edge,set:function(start,end){this.start=start;this.end=end;return this},copy:function(edge){this.start=edge.start;this.end=edge.end;return this},createHashKey:function(){return Math.min(this.start,this.end)+"_"+Math.max(this.start,this.end)},isConnected:function(connectedEdge){if(this.end===connectedEdge.start||this.start===connectedEdge.end||this.start===connectedEdge.start||this.end===connectedEdge.end){return true}return false},isConnectedCW:function(connectedEdge){return this.end===connectedEdge.start},isConnectedCCW:function(connectedEdge){return this.start===connectedEdge.end},distance:function(vertexValues){return vertexValues[this.start].distanceTo(vertexValues[this.end])},equals:function(edge){return edge.start===this.start&&edge.end===this.end||edge.end===this.start&&edge.start===this.end},getStartVertex:function(vertexValues){return vertexValues[this.start]},getEndVertex:function(vertexValues){return vertexValues[this.end]},updateIndices:function(indicesHashKeys){if(indicesHashKeys[this.start]!==undefined){this.start=indicesHashKeys[this.start]}if(indicesHashKeys[this.end]!==undefined){this.end=indicesHashKeys[this.end]}},split:function(numSegments,vertexValues,offset){var newVertices=[];var vectorEdge;var _offset=offset==undefined?0:offset/100;if(numSegments<1){return[]}for(var i=1,iLen=numSegments+1;i<iLen;i++){vectorEdge=(new THREE.Vector3).subVectors(vertexValues[this.end],vertexValues[this.start]);if(_offset>=0){vectorEdge.multiplyScalar(i*((1-_offset)/iLen))}else{vectorEdge.multiplyScalar(1-i*((1+_offset)/iLen))}vectorEdge.add(vertexValues[this.start]);newVertices.push(vectorEdge)}return newVertices},reverse:function(){var temp=this.start;this.start=this.end;this.end=temp},getReverse:function(){var revEdge=this.clone();revEdge.reverse();return revEdge},getIndexOf:function(edges){for(var i=0,il=edges.length;i<il;i++){if(this.equals(edges[i])){return i}}return-1},getLine3:function(vertexValues){return new THREE.Line3(vertexValues[this.start],vertexValues[this.end])},clone:function(){return(new exo.geometry.Edge).copy(this)}};exo.geometry.FaceConverter=function(){this.faceConverter=[];this._offset=0;return this};exo.geometry.FaceConverter.prototype={constructor:exo.geometry.FaceConverter,addFaceFlag:function(subFaceIndices){if(subFaceIndices){if(subFaceIndices.length>0){this.faceConverter.push(subFaceIndices)}else{var face=[];for(var i=0,il=subFaceIndices.length;i<il;i++){face.push(null)}this.faceConverter.push(face)}}else{this.removeFaceFlag()}},createSubFaceIndex:function(faceIndex,faceCornerIndex){return{f:faceIndex,i:faceCornerIndex}},_getValueBySubFaceIndex:function(faces,subFaceIndex){return faces[subFaceIndex.f][subFaceIndex.i]},removeFaceFlag:function(){this.faceConverter.push(null)},_isFaceRemoved:function(faceIndex){return this.faceConverter[faceIndex]?false:true},_getConvertedFace:function(faceIndex,faces,newAddedIndices,newAddedIndicesOffset){var ifaceConverter=this.faceConverter[faceIndex];var newFace=[];if(ifaceConverter){for(var i=0,il=ifaceConverter.length;i<il;i++){if(ifaceConverter[i]==undefined||ifaceConverter[i]<0){newFace.push(newAddedIndicesOffset+newAddedIndices[this._offset]);this._offset++}else{newFace.push(this._getValueBySubFaceIndex(faces,ifaceConverter[i]))}}}return newFace},getRemovedFaceIndices:function(){var removedFaces=[];for(var f=0,fl=this.faceConverter.length;f<fl;f++){if(!this.faceConverter[f]){removedFaces.push(f)}}return removedFaces},convertFace:function(faceIndices,values,newAddedValues,newAddedIndices,removeUnusedValues){var convertedFace=[];var newIndicesMap={};var faceConverter=this.faceConverter;this._offset=0;var newValIndicesOffset=values.length;if(newAddedValues){for(var i=0,il=newAddedValues.length;i<il;i++){values.push(newAddedValues)}}if(faceConverter.length>0){if(faceConverter[0]){convertedFace=this._getConvertedFace(0,[faceIndices],newAddedIndices,newValIndicesOffset)}}else{return false}if(removeUnusedValues){exo.geometry.PolyMeshUtilitie.removeUnusedValues(convertedFaces,values)}faceIndices.length=0;for(var i=0,il=convertedFace.length;i<il;i++){faceIndices.push(convertedFace[i])}return true},convert:function(faces,values,newAddedValues,newAddedIndices,removeUnusedValues){if(!faces||!values){return false}var convertedFaces=[];var newIndicesMap={};var faceConverter=this.faceConverter;this._offset=0;var newValIndicesOffset=values.length;if(newAddedValues){for(var i=0,il=newAddedValues.length;i<il;i++){values.push(newAddedValues)}}for(var f=0,fl=faceConverter.length;f<fl;f++){if(faceConverter[f]){convertedFaces.push(this._getConvertedFace(f,faces,newAddedIndices,newValIndicesOffset))}}if(removeUnusedValues){exo.geometry.PolyMeshUtilities.removeUnusedValues(convertedFaces,values)}exo.geometry.CloneUtilities.copyIntRaggedArrayToReference(faces,convertedFaces);return true}};exo.geometry.FaceConverter2=function(){this.faceConverter={};return this};exo.geometry.FaceConverter2.prototype={constructor:exo.geometry.FaceConverter2,updateFaceFlag:function(faceIndex,subFaceIndices){if(!faceIndex){return}if(subFaceIndices){if(subFaceIndices.length>2){if(this.faceConverter[faceIndex]!=undefined){var newSubFaceIndices=[];var previousSubFaces=faceConverter[faceIndex];for(var i=0,il=subFaceIndices.length;i<il;i++){for(var j=0,jl=previousSubFaces.length;j<jl;j++){if(subFaceIndices[i].equals(previousSubFaces[i])){newSubFaceIndices.push(subFaceIndices[i]);break}}}if(newSubFaceIndices.length>2){this.faceConverter[faceIndex]=newSubFaceIndices}}else{this.faceConverter[faceIndex]=subFaceIndices}}else{this.removeFaceFlag(faceIndex)}}else{this.removeFaceFlag(faceIndex)}},removeFaceFlag:function(faceIndex){this.faceConverter[faceIndex]=null},removeFacesFlag:function(faceIndices){for(var f=0,fl=faceIndices.length;f<fl;f++){this.faceConverter[faceIndices[f]]=null}},_isFaceRemoved:function(faceIndex){return faceIndex in this.faceConverter&&!this.faceConverter[faceIndex]?true:false},_getConvertedFace:function(faceIndex,faces){var ifaceConverter=this.faceConverter[faceIndex];var newFace=[];if(ifaceConverter){for(var i=0,il=ifaceConverter.length;i<il;i++){newFace.push(ifaceConverter[i].getIndex(faces))}}return newFace},getRemovedFaceIndices:function(){var removedFaces=[];_.each(this.faceConverter,function(indices,faceIndex){if(!indices){removedFaces.push(faceIndex)}});return removedFaces},convert:function(faces,values,removeUnusedValues){var convertedFaces=[];var faceConverter=this.faceConverter;var faceChanged;if(!faces){return false}for(var f=0,fl=faces.length;f<fl;f++){faceChanged=faceConverter[f];if(f in faceConverter){if(faceChanged){convertedFaces.push(this._getConvertedFace(f,faces))}}else{convertedFaces.push(faces[f].slice(0))}}if(removeUnusedValues&&values){exo.geometry.PolyMeshUtilities.removeUnusedValues(convertedFaces,values)}exo.geometry.CloneUtilities.copyIntRaggedArrayToReference(faces,convertedFaces);return true},convertPolyMaps:function(polyMaps,removeUnusedValues){if(!polyMaps){return false}var status=false;_.each(polyMaps,function(polyMap){var result=this.convert(polyMap.faces,polyMap.values,removeUnusedValues);if(result){status=result}},this);return status},convertPolyMap:function(polyMap,removeUnusedValues){if(!polyMap){return false}return this.convert(polyMap.faces,polyMap.values,removeUnusedValues)},convertIndexList:function(indices){var faceConverter=this.faceConverter;var pIndex,faceChanged,newIndex;var convertedList=[];if(!indices||indices.length<1){return false}for(var i=0,il=indices.length;i<il;i++){pIndex=indices[i];faceChanged=faceConverter[i];if(i in faceConverter){if(faceChanged){newIndex=indices[faceChanged.f];convertedList.push(newIndex?newIndex:0)}}else{convertedList.push(pIndex)}}exo.geometry.CloneUtilities.copyArrayToReference(indices,convertedList);return true},convertPolyMesh:function(polyMesh,ignoreFaceConversion,removeUnusedValues){if(!polyMesh){return}if(!ignoreFaceConversion){this.convert(polyMesh.faces,polyMesh.positions,removeUnusedValues)}this.convertPolyMap(polyMesh.normalMap,removeUnusedValues);this.convertPolyMaps(polyMesh.uvMaps,removeUnusedValues);this.convertPolyMaps(polyMesh.colorMaps,removeUnusedValues);this.convertIndexList(polyMesh.materialIds)}};!function(){exo.geometry.PolygonFace=function(vertexIndices){if(!vertexIndices||vertexIndices.length<3){return null}this.face=vertexIndices;this.materialID=-1;this.velocities=null;this.normalIndices=null;this.colorMapsIndices={};this.uvMapsIndices={};return this};exo.geometry.PolygonFace.prototype={constructor:exo.geometry.PolygonFace,setVertexIndices:function(indices){if(indices.length>0){this.face=indices}},getVertexIndices:function(){return this.face},setNormalIndices:function(indices){if(indices.length>0){this.normalIndices=indices}},getNormalsIndices:function(){return this.normalIndices},setUVIndices:function(indices,channel){if(indices.length>0){if(channel){this.uvMapsIndices[channel]=indices}else{this.uvMapsIndices[exo.geometry.PolyMesh.DEFAULT_MAP]=indices}}},getUVIndices:function(channel){return channel?this.uvMapsIndices[channel]:this.uvMapsIndices[exo.geometry.PolyMesh.DEFAULT_MAP]},getUVMaps:function(){return this.uvMapsIndices},getUVMapsCount:function(){return _.size(this.uvMapsIndices)},setVertexColorsIndices:function(indices,channel){if(indices.length>0){if(channel){this.colorMapsIndices[channel]=indices}else{this.colorMapsIndices[exo.geometry.PolyMesh.DEFAULT_MAP]=indices}}},getVertexColorsIndices:function(channel){return channel?this.colorMapsIndices[channel]:this.colorMapsIndices[exo.geometry.PolyMesh.DEFAULT_MAP]},getColorMaps:function(){return this.colorMapsIndices},getColorMapsCount:function(){return _.size(this.colorMapsIndices)},setMaterialID:function(matID){if(matID>=0){this.materialID=matID}},getMaterialID:function(){return this.materialID},setPolyMapsBySubFaces:function(polyMesh,subFaceIndices){if(!polyMesh||!subFaceIndices){return}this.setNormalIndicesBySubFaces(polyMesh,polyMesh.normalMap,subFaceIndices);this.setUVIndicesBySubFaces(polyMesh,polyMesh.uvMaps,subFaceIndices);this.setVertexColorsIndicesBySubFaces(polyMesh,polyMesh.colorMaps,subFaceIndices)},setNormalIndicesBySubFaces:function(polyMesh,normalMap,subFaceIndices){if(!polyMesh||!normalMap||!subFaceIndices){return}if(polyMesh.hasNormalMap()){this.setNormalIndices(exo.geometry.SubFaceUtilities.getIndicesFromSubFaces(normalMap.faces,subFaceIndices))}},setUVIndicesBySubFaces:function(polyMesh,uvMaps,subFaceIndices,channel){if(!polyMesh||!uvMaps||!subFaceIndices){return}if(polyMesh.hasUVMap()){if(channel){this.setUVIndices(exo.geometry.SubFaceUtilities.getIndicesFromSubFaces(uvMaps[channel].faces,subFaceIndices),channel)}else{_.each(polyMesh.uvMaps,function(uvMap,mapName){this.setUVIndices(exo.geometry.SubFaceUtilities.getIndicesFromSubFaces(uvMaps[mapName].faces,subFaceIndices),mapName)},this)}}},setVertexColorsIndicesBySubFaces:function(polyMesh,colorMaps,subFaceIndices,channel){if(!polyMesh||!colorMaps||!subFaceIndices){return}if(polyMesh.hasColorMap()){if(channel){this.setVertexColorsIndices(exo.geometry.SubFaceUtilities.getIndicesFromSubFaces(colorMaps[channel].faces,subFaceIndices),channel)}else{_.each(polyMesh.colorMaps,function(colorMap,mapName){this.setVertexColorsIndices(exo.geometry.SubFaceUtilities.getIndicesFromSubFaces(colorMaps[mapName].faces,subFaceIndices),mapName)},this)}}}}}();exo.geometry.SubFace=function(faceIndex,subFaceIndex){this.f=faceIndex;this.i=subFaceIndex;return this};exo.geometry.SubFace.prototype={constructor:exo.geometry.SubFace,setFaceIndex:function(faceIndex){this.f=faceIndex},setSubFaceIndex:function(subFaceIndex){this.i=subFaceIndex},getFaceIndex:function(){return this.f},getSubFaceIndex:function(){return this.i},getIndex:function(faces){return faces[this.f][this.i]},getValue:function(faces,values){return values[faces[this.f][this.i]]},setValue:function(faces,values,newValue){values[faces[this.f][this.i]]=newValue},setPolyMapValue:function(polyMap,newValue){polyMap.setValue(polyMap.faces[this.f][this.i],newValue)},equals:function(subFace){return this.f===subFace.f&&this.i===subFace.i},clone:function(){return new exo.geometry.SubFace(this.f,this.i)}};exo.geometry.SubFaceUtilities={getSubFacesByVertices:function(polyMesh,faceIndices,vertexIndices,opVertexIndicesHashKeys){if(!polyMesh||!polyMesh.faces||!vertexIndices&&!opVertexIndicesHashKeys){return subFaceIndices}var subFaceIndices=[];var vIndex;var faces=polyMesh.faces;var subfaces;var subFaceMap=this.createSubFaceHashKeys(polyMesh,faceIndices);for(var i=0,il=vertexIndices.length;i<il;i++){vIndex=vertexIndices[i];if(vIndex in subFaceMap){subfaces=subFaceMap[vIndex];var vSubFaces=[];for(var j=0,jl=subfaces.length;j<jl;j++){vSubFaces.push(subfaces[j])}subFaceIndices.push(vSubFaces)}else{subFaceIndices.push([new exo.geometry.SubFace(faceIndices[0],0)])}}return subFaceIndices},getIndicesFromSubFaces:function(faces,subFaceIndices){var outIndices=[];var subFace,face;if(!faces||!subFaceIndices){return outIndices}for(var i=0,il=subFaceIndices.length;i<il;i++){subFace=subFaceIndices[i];outIndices.push(faces[subFace.f][subFace.i])}return outIndices},createSubFaceHashKeys:function(polyMesh,ifaceIndices){var SubFaceKeys={};var vertexIndex;if(!polyMesh||!polyMesh.faces||!ifaceIndices){return SubFaceKeys}var faces=polyMesh.faces;var _addHashKeySubFace=function(faceIndex,face){for(var j=0,jl=face.length;j<jl;j++){vertexIndex=face[j];if(SubFaceKeys[vertexIndex]===undefined){SubFaceKeys[vertexIndex]=[]}SubFaceKeys[vertexIndex].push(new exo.geometry.SubFace(faceIndex,j))}};if(ifaceIndices){for(var i=0,il=ifaceIndices.length;i<il;i++){_addHashKeySubFace(ifaceIndices[i],faces[ifaceIndices[i]])}}else{for(var i=0,il=faces.length;i<il;i++){_addHashKeySubFace(i,faces[i])}}return SubFaceKeys},computeAverageBySubFaces:function(faces,values,subFaces){var averageVal;if(!faces||!values||values.length<1||!subFaces||subFaces.length<1){return averageVal}var firstValue=values[0];if(firstValue instanceof THREE.Vector3){averageVal=new THREE.Vector3}else if(firstValue instanceof THREE.Vector2){averageVal=new THREE.Vector2}else if(firstValue instanceof THREE.Color){averageVal=new THREE.Color}else{return averageVal}for(var i=0,il=subFaces.length;i<il;i++){averageVal.add(subFaces[i].getValue(faces,values))}return averageVal.multiplyScalar(1/subFaces.length)}};!function(){exo.geometry.ComponentUtilities={ExcludeEdges:{Border:0,NonBorder:1},isEdge:function(vIndex1,vIndex2,edgeListHashKeys){var edge=new exo.geometry.Edge(vIndex1,vIndex2);return edgeListHashKeys[edge.createHashKey()]===undefined?false:true},createEdgesHashKeys:function(polyMesh,ifaceIndices){var allEdges={};if(!polyMesh){return allEdges}var faces=polyMesh.faces;if(!faces||faces.length<1){return allEdges}var getFaceEdges=function(faceIndices){var edge;for(var j=0,jLen=faceIndices.length;j<jLen;j++){edge=new exo.geometry.Edge(faceIndices[j],faceIndices[(j+1)%jLen]);this._createEdgeHashKey(edge,allEdges)}};if(ifaceIndices){for(var i=0,il=ifaceIndices.length;i<il;i++){getFaceEdges.call(this,faces[ifaceIndices[i]])}}else{for(var i=0,il=faces.length;i<il;i++){getFaceEdges.call(this,faces[i])}}return allEdges},createEdgesHashKeysInArray:function(polyMesh,ifaceIndices){var listFaceEdgesKeys=[];if(!polyMesh){return listFaceEdgesKeys}var faces=polyMesh.faces;var edge;if(!faces){return listFaceEdgesKeys}var getFaceEdgesKeysInArray=function(vertexIndices){var edge;var faceEdgesKeys=[];for(var j=0,jLen=vertexIndices.length;j<jLen;j++){edge=new exo.geometry.Edge(vertexIndices[j],vertexIndices[(j+1)%jLen]);faceEdgesKeys.push({key:edge.createHashKey(),edge:edge})}return faceEdgesKeys};if(ifaceIndices){for(var i=0,il=ifaceIndices.length;i<il;i++){listFaceEdgesKeys.push(getFaceEdgesKeysInArray(faces[ifaceIndices[i]]))}}else{for(var i=0,il=faces.length;i<il;i++){listFaceEdgesKeys.push(getFaceEdgesKeysInArray(faces[i]))}}return listFaceEdgesKeys},createSelectedEdgesHashKeys:function(edges){var edgesKeys={};if(!edges){return edgesKeys}for(var i=0,il=edges.length;i<il;i++){this._createEdgeHashKey(edges[i],edgesKeys)}return edgesKeys},createVerticesHashKeys:function(polyMesh,vertexIndices,optionalPrecision){var vertexKeys={};if(!polyMesh){return vertexKeys}var positions=polyMesh.positions;if(!positions){return vertexKeys}var addVertexHashKey=function(vertexHashKeys,newVertexKey,vertexIndex){var newVertex=vertexHashKeys[newVertexKey];if(newVertex){newVertex.counter=newVertex.counter+1}else{newVertex={counter:1,index:vertexIndex}}};if(vertexIndices){for(var i=0,il=vertexIndices.length;i<il;i++){addVertexHashKey(vertexKeys,this.createVertexHashKey(positions[vertexIndices[i]],optionalPrecision),vertexIndices[i])}}else{for(var i=0,il=positions.length;i<il;i++){addVertexHashKey(vertexKeys,this.createVertexHashKey(positions[i],optionalPrecision),i)}}return vertexKeys},createVertexHashKey:function(vertex,optionalPrecision){if(!vertex){return""}var vertexWithPrecision=function(vertex,optionalPrecision){return vertex.x.toFixed(optionalPrecision)+"_"+vertex.y.toFixed(optionalPrecision)+"_"+vertex.z.toFixed(optionalPrecision)};var vertexWithoutPrecision=function(vertex,optionalPrecision){return vertex.x+"_"+vertex.y+"_"+vertex.z};var getVectorHashKey=optionalPrecision===undefined?vertexWithoutPrecision:vertexWithPrecision;return getVectorHashKey(vertex,optionalPrecision)},createVertexIndicesHashKeys:function(vertexIndices){var vertexIndicesKeys={};if(!vertexIndices){return vertexIndicesKeys}for(var i=0,il=vertexIndices.length;i<il;i++){vertexIndicesKeys[vertexIndices[i]]=true}return vertexIndicesKeys},createUsedIndicesHashKeys:function(polyMesh,ifaceIndices){var faceKeyMap={};if(!polyMesh||!polyMesh.faces){return faceKeyMap}var vertexIndex;var faces=polyMesh.faces;var _addHashKeyCounter=function(faceIndex,face){for(var j=0,jl=face.length;j<jl;j++){vertexIndex=face[j];if(vertexIndex in faceKeyMap){faceKeyMap[vertexIndex]=faceKeyMap[vertexIndex]+1}else{faceKeyMap[vertexIndex]=1}}};if(ifaceIndices){for(var i=0,il=ifaceIndices.length;i<il;i++){_addHashKeyCounter(ifaceIndices[i],faces[ifaceIndices[i]])}}else{for(var i=0,il=faces.length;i<il;i++){_addHashKeyCounter(i,faces[i])}}return faceKeyMap},getEdges:function(polyMesh,ifaceIndices,onlyBorderEdges,optionalEdgesHashKeys){var edges=[];if(!polyMesh){return edges}var allEdges=optionalEdgesHashKeys?optionalEdgesHashKeys:this.createEdgesHashKeys(polyMesh,ifaceIndices);if(onlyBorderEdges){_.each(allEdges,function(edgeInfo){if(edgeInfo.counter==1){edges.push(edgeInfo.edge.clone())}})}else{_.each(allEdges,function(edgeInfo){edges.push(edgeInfo.edge.clone())})}return edges},getBorderEdges:function(polyMesh,ifaceIndices,optionalEdgesHashKeys){return this.getEdges(polyMesh,ifaceIndices,true,optionalEdgesHashKeys)},getEdgesByFaces:function(polyMesh,ifaceIndices,optionalEdgesHashKeys){return this.getEdges(polyMesh,ifaceIndices,false,optionalEdgesHashKeys)},getEdgesByVertices:function(polyMesh,vertexIndices,edgesHashKeys,checkBothEndpoints,optionalMaxEdgeLength){var connectedEdges=[];var edge;if(!polyMesh||!vertexIndices){return connectedEdges}var positions=polyMesh.positions;var allEdgesKeys=edgesHashKeys?edgesHashKeys:this.createEdgesHashKeys(polyMesh);if(vertexIndices.length<1||positions.length<1){return connectedEdges}var vertexIndicesKeys=this.createVertexIndicesHashKeys(vertexIndices);_.each(allEdgesKeys,function(edgeInfo){edge=edgeInfo.edge;if(checkBothEndpoints){if(vertexIndicesKeys[edge.start]&&vertexIndicesKeys[edge.end]){this._addEdgeToList(connectedEdges,edge,true,optionalMaxEdgeLength,polyMesh.positions)}}else{if(vertexIndicesKeys[edge.start]||vertexIndicesKeys[edge.end]){this._addEdgeToList(connectedEdges,edge,true,optionalMaxEdgeLength,polyMesh.positions)}}},this);return connectedEdges},getEdgesByVerticesKeys:function(polyMesh,vertexIndices,edgesHashKeys,checkBothEndpoints,optionalMaxEdgeLength){var connectedEdges={};var edge;if(!polyMesh||!vertexIndices||!edgesHashKeys){return connectedEdges}var positions=polyMesh.positions;if(vertexIndices.length<1||positions.length<1){return connectedEdges}var vertexIndicesKeys=this.createVertexIndicesHashKeys(vertexIndices);_.each(edgesHashKeys,function(edgeInfo,edgeKey){edge=edgeInfo.edge;if(checkBothEndpoints){if(vertexIndicesKeys[edge.start]&&vertexIndicesKeys[edge.end]){this._addEdgeKeyToList(connectedEdges,edge,edgeKey,true,optionalMaxEdgeLength,polyMesh.positions)}}else{if(vertexIndicesKeys[edge.start]||vertexIndicesKeys[edge.end]){this._addEdgeKeyToList(connectedEdges,edge,edgeKey,true,optionalMaxEdgeLength,polyMesh.positions)}}},this);return connectedEdges},getVirtualBorderEdgesByVertices:function(polyMesh,vertexIndices,optionalEdgesHashKeys,optionalMaxEdgeLength){var virtualEdges=[];var validVertexIndices=[];var vertexIndex1,vertexIndex2,edge;if(!polyMesh||!vertexIndices){return virtualEdges}var allEdgesKeys=optionalEdgesHashKeys?optionalEdgesHashKeys:this.createEdgesHashKeys(polyMesh);var borderVertices=this.getBorderVertices(this,0,allEdgesKeys);var borderVerticesKeys=this.createVertexIndicesHashKeys(borderVertices);for(var i=0,il=vertexIndices.length;i<il;i++){if(borderVerticesKeys[vertexIndices[i]]!==undefined){validVertexIndices.push(vertexIndices[i])}}for(var i=0,il=validVertexIndices.length;i<il;i++){vertexIndex1=validVertexIndices[i];for(var j=i+1,jl=validVertexIndices.length;j<jl;j++){vertexIndex2=validVertexIndices[j];edge=new exo.geometry.Edge(vertexIndex1,vertexIndex2);if(!allEdgesKeys[edge.createHashKey()]){this._addEdgeToList(virtualEdges,edge,false,optionalMaxEdgeLength,polyMesh.positions)}}}return virtualEdges},excludeEdges:function(polyMesh,edges,excludeEdgesType){var newEdges=[];var borderEdges=this.getBorderEdges(polyMesh);var borderEdgesKeys=this.createSelectedEdgesHashKeys(borderEdges);if(excludeEdgesType===this.ExcludeEdges.Border){for(var i=0,il=edges.length;i<il;i++){if(borderEdgesKeys[edges[i].createHashKey()]===undefined){newEdges.push(edges[i])}}}else if(excludeEdgesType===this.ExcludeEdges.NonBorder){for(var i=0,il=edges.length;i<il;i++){if(borderEdgesKeys[edges[i].createHashKey()]!==undefined){newEdges.push(edges[i])}}}return newEdges},getFacesByVertices:function(polyMesh,vertexIndices,vIndicesKeys,minVertsInFace,maxVertsInFace){var selectedFaces=[];var faces=polyMesh.faces;var face,counter;if(vertexIndices.length<1||faces.length<1){return selectedFaces}var _maxVerts=maxVertsInFace===undefined||maxVertsInFace<1?Number.MAX_VALUE:maxVertsInFace;var _minVerts=minVertsInFace===undefined||minVertsInFace<1?1:minVertsInFace;var minVerts=minVertsInFace!==undefined?minVertsInFace:1;var vertexIndicesKeys=vIndicesKeys?vIndicesKeys:this.createVertexIndicesHashKeys(vertexIndices);for(var i=0,il=faces.length;i<il;i++){face=faces[i];counter=0;for(var j=0,jl=face.length;j<jl;j++){if(vertexIndicesKeys[face[j]]!==undefined){counter++}}if(counter<=_maxVerts&&counter>=_minVerts){selectedFaces.push(i)}}return selectedFaces},getFacesByEdges:function(polyMesh,edges,optionalSelectedEdgesHKeys,optionalEdgesHKeysInArray,minSharedEdges,maxSharedEdges){var edgesKeys,counter,face;var selectedFaces=[];if(!polyMesh||!edges){return selectedFaces}var faces=polyMesh.faces;var _maxSharedEdges=maxSharedEdges===undefined||maxSharedEdges<1?Number.MAX_VALUE:maxSharedEdges;var _minSharedEdges=minSharedEdges===undefined||minSharedEdges<1?1:minSharedEdges;var selectedEdgesKeys=optionalSelectedEdgesHKeys?optionalSelectedEdgesHKeys:this.createSelectedEdgesHashKeys(edges);var facesEdgeKeys=optionalEdgesHKeysInArray?optionalEdgesHKeysInArray:this.createEdgesHashKeysInArray(polyMesh);if(!faces||!facesEdgeKeys||facesEdgeKeys.length!==faces.length){return selectedFaces}for(var f=0,fl=faces.length;f<fl;f++){face=faces[f];edgesKeys=facesEdgeKeys[f];counter=0;for(var i=0,il=face.length;i<il;i++){if(selectedEdgesKeys[edgesKeys[i].key]){counter++}}if(counter<=_maxSharedEdges&&counter>=_minSharedEdges){selectedFaces.push(f)}}return selectedFaces},createFacesByEdges:function(edges){var polygons=[];if(!edges){return polygons}var vertices=this.getVerticesByEdges(edges,true);var sharedVerticesKeys=this.getSharedVerticesKeysByEdges(edges);var sharedVertex,vIndex,_findVertex;var _getPolyRecursively=function(startIndex,findVertex){_findVertex=findVertex;for(var i=startIndex,il=vertices.length;i<il;i++){vIndex=vertices[i];if(sharedVerticesKeys[vIndex]>1){if(vIndex===_findVertex){polygons.push(vertices.splice(startIndex,i-startIndex+1));sharedVerticesKeys[vIndex]--;_getPolyRecursively(startIndex,_findVertex);break}else{_findVertex=vIndex}}}};for(var i=0,il=vertices.length;i<il;i++){if(sharedVerticesKeys[vertices[i]]!==undefined){_getPolyRecursively(i+1,vertices[i]);break}}polygons.push(vertices.slice(0));vertices.length=0;return polygons},getVerticesByEdges:function(edges,keepDuplicates){var vertexIndices=[];if(!edges||edges.length<1){return vertexIndices}if(keepDuplicates){for(var i=0,il=edges.length;i<il;i++){vertexIndices.push(edges[i].start)}var lastIndex=edges[edges.length-1].end;if(lastIndex!==edges[0].start){vertexIndices.push(lastIndex)}return vertexIndices}else{_.each(edges,function(edge){vertexIndices.push(edge.start,edge.end)});return _.uniq(vertexIndices)}},getSharedVerticesKeysByEdges:function(edges){var sharedVertices={};var vertexCounterKeys={};if(!edges||edges.length<1){return sharedVertices}_.each(edges,function(edge){if(vertexCounterKeys[edge.start]===undefined){vertexCounterKeys[edge.start]=1}else{vertexCounterKeys[edge.start]++}if(vertexCounterKeys[edge.end]===undefined){vertexCounterKeys[edge.end]=1}else{vertexCounterKeys[edge.end]++}});_.each(vertexCounterKeys,function(counter,vertexKey){if(counter>2){sharedVertices[vertexKey]=counter-2}});return sharedVertices},getVerticesByFaces:function(polyMesh,ifaceIndices){var selectedVertices=[];var face;if(!polyMesh||!polyMesh.faces||!ifaceIndices||ifaceIndices.length<1){return selectedVertices}var faces=polyMesh.faces;for(var i=0,il=ifaceIndices.length;i<il;i++){face=faces[ifaceIndices[i]];for(var j=0,jl=face.length;j<jl;j++){selectedVertices.push(face[j])}}return _.uniq(selectedVertices)},getBorderVertices:function(polyMesh,ifaceIndices,optionalEdgesHashKeys){var borderElements=[];if(!polyMesh){return borderElements}var allEdgesKeys=optionalEdgesHashKeys?optionalEdgesHashKeys:this.createEdgesHashKeys(polyMesh,ifaceIndices);_.each(allEdgesKeys,function(edgeInfo){if(edgeInfo.counter==1){borderElements.push(edgeInfo.edge.start)}});return _.uniq(borderElements)},getConnectedEdgeIndices:function(selectedEdges){var connectedEdges=[];var groupConnectedEdges=[];var addedEdgesKeys={};var firstEdge;if(!selectedEdges||selectedEdges.length<1){return connectedEdges}var _getGroupEdgesRecusively=function(currentEdge,groupEdges){var nextEdge;for(var j=0,jl=selectedEdges.length;j<jl;j++){nextEdge=selectedEdges[j];if(!addedEdgesKeys[j]){if(currentEdge.isConnected(nextEdge)){groupEdges.push(j);addedEdgesKeys[j]=true;_getGroupEdgesRecusively(nextEdge,groupEdges)}}}};for(var i=0,il=selectedEdges.length;i<il;i++){firstEdge=selectedEdges[i];if(!addedEdgesKeys[i]){groupConnectedEdges=[i];addedEdgesKeys[i]=true;_getGroupEdgesRecusively(firstEdge,groupConnectedEdges);connectedEdges.push(groupConnectedEdges)}}return connectedEdges},getConnectedEdges:function(selectedEdges,sortEdges){var edgesGroupIndices,connectedEdges=[],edgesGroup=[];if(!selectedEdges||selectedEdges.length<1){return connectedEdges}var _sortEdges=sortEdges==undefined?true:sortEdges;var connectedEdgesGroups=this.getConnectedEdgeIndices(selectedEdges);if(connectedEdgesGroups.length<1){return connectedEdges}for(var i=0,il=connectedEdgesGroups.length;i<il;i++){edgesIndices=connectedEdgesGroups[i];edgesGroup=[];for(var j=0,jl=edgesIndices.length;j<jl;j++){edgesGroup.push(selectedEdges[edgesIndices[j]])}if(_sortEdges){edgesGroup=this.sortConnectedEdges(edgesGroup)}connectedEdges.push(edgesGroup)}return connectedEdges},sortConnectedEdges:function(edges){return _.flatten(this.sortNestedConnectedEdges(edges))},sortNestedConnectedEdges:function(edges){var curEdge,nextEdge;var allSortedEdges=[];var addedEdges={};if(!edges||edges.length<1){return allSortedEdges}var _findNextGroup=function(){if(allSortedEdges.length===0){return 0}if(_.keys(addedEdges).length>=edges.length){return-1}for(var i=0,il=edges.length;i<il;i++){if(!addedEdges[i]){return i}}return-1};var pos=0;var sortedEdges;while(pos>=0){sortedEdges=[];curEdge=edges[pos];sortedEdges.push(curEdge);addedEdges[pos]=true;this._sortCWRecusively(edges,curEdge,sortedEdges,addedEdges);if(!sortedEdges[sortedEdges.length-1].isConnectedCW(sortedEdges[0])){this._sortCCWRecusively(edges,curEdge,sortedEdges,addedEdges)}if(sortedEdges.length){allSortedEdges.push(sortedEdges)
}pos=_findNextGroup()}return allSortedEdges},updateConnectedEdgesIndices:function(connectedEdges,vertexIndicesKeys,startIndex){var edges;var start=startIndex===undefined?0:startIndex;if(!connectedEdges||!vertexIndicesKeys){return}for(var i=start,il=connectedEdges.length;i<il;i++){edges=connectedEdges[i];for(var j=0,jl=edges.length;j<jl;j++){edges[j].updateIndices(vertexIndicesKeys)}}},getCentroidByVertices:function(polyMesh,vertexIndices,worldTransform){var centroid=new THREE.Vector3;if(vertexIndices&&vertexIndices.length>0&&polyMesh&&polyMesh.positions.length>0){_.each(vertexIndices,function(vIndex){centroid.add(polyMesh.positions[vIndex])});centroid.multiplyScalar(1/vertexIndices.length)}if(worldTransform){centroid.applyMatrix4(worldTransform)}return centroid},convertJsonToEdges:function(objEdges){var edges=[];if(!objEdges||objEdges.length<1){return edges}if(objEdges[0]instanceof exo.geometry.Edge){return objEdges}else{if(objEdges[0].start!=undefined&&objEdges[0].end!=undefined){for(var i=0,il=objEdges.length;i<il;i++){edges.push(new exo.geometry.Edge(objEdges[i].start,objEdges[i].end))}}}return edges},_addEdgeToList:function(outputEdgeList,edge,cloneEdge,maxEdgeLength,allVertices){if(maxEdgeLength==undefined){outputEdgeList.push(cloneEdge?edge.clone():edge)}else{if(edge.distance(allVertices)<=maxEdgeLength){outputEdgeList.push(cloneEdge?edge.clone():edge)}}},_addEdgeKeyToList:function(outputEdgeKeys,edge,edgeKey,cloneEdge,maxEdgeLength,allVertices){if(maxEdgeLength==undefined){outputEdgeKeys[edgeKey]=cloneEdge?edge.clone():edge}else{if(edge.distance(allVertices)<=maxEdgeLength){outputEdgeKeys[edgeKey]=cloneEdge?edge.clone():edge}}},_createEdgeHashKey:function(edge,outputEdgeKeys){var keyEdge=edge.createHashKey();var edgeKey={};if(outputEdgeKeys){if(outputEdgeKeys[keyEdge]){outputEdgeKeys[keyEdge].counter=outputEdgeKeys[keyEdge].counter+1}else{outputEdgeKeys[keyEdge]={counter:1,edge:edge.clone()}}return outputEdgeKeys}else{edgeKey[keyEdge]=edge.clone();return edgeKey}},_sortCWRecusively:function(edges,curEdge,sortedEdges,addedEdges){var nextEdge;for(var j=1,jl=edges.length;j<jl;j++){if(!addedEdges[j]){nextEdge=edges[j];if(curEdge.isConnectedCW(nextEdge)){sortedEdges.push(nextEdge);addedEdges[j]=true;this._sortCWRecusively(edges,nextEdge,sortedEdges,addedEdges);return}}}},_sortCCWRecusively:function(edges,curEdge,sortedEdges,addedEdges){var nextEdge;for(var j=1,jl=edges.length;j<jl;j++){if(!addedEdges[j]){nextEdge=edges[j];if(curEdge.isConnectedCCW(nextEdge)){sortedEdges.splice(0,0,nextEdge);addedEdges[j]=true;this._sortCCWRecusively(edges,nextEdge,sortedEdges,addedEdges);return}}}}}}();exo.geometry.GeometryToPolyMesh=exo.geometry.PolyMeshFactory||{};exo.geometry.GeometryToPolyMesh.convert=function(geometry){var faces=[];var normals=[];var colors=[];var materialIDs=[];var isVertexNormals=false;var isVertexColors=false;var isMaterialIDs=false;for(var i=0,il=geometry.faces.length;i<il;i++){var face=geometry.faces[i];var faceIndices;if(face instanceof THREE.Face3){faceIndices=[face.a,face.b,face.c]}else if(face instanceof THREE.Face4){faceIndices=[face.a,face.b,face.c,face.d]}else{throw new Error("should not get here.")}if(face.vertexNormals.length>0){isVertexNormals=true;for(var j=0,jl=face.vertexNormals.length;j<jl;j++){normals[faceIndices[j]]=face.vertexNormals[j]}}else{if(isVertexNormals){throw new Error("some faces have vertex normals, others don't")}}if(face.materialIndex!==undefined){isMaterialIDs=true;materialIDs.push(face.materialIndex)}else{if(isMaterialIDs){throw new Error("some faces have material IDs, others don't")}}if(face.vertexColors.length>0){isVertexColors=true;for(var j=0,jl=face.vertexColors.length;j<jl;j++){colors[faceIndices[j]]=face.vertexColors[j]}}else{if(isVertexColors){throw new Error("some faces have colors, others don't")}}faces.push(faceIndices)}var positions=geometry.vertices;var polyMesh=new exo.geometry.PolyMesh(faces,positions);if(isVertexNormals){for(var i=0,il=normals.length;i<il;i++){if(!normals[i]){normals[i]=new THREE.Vector3}}polyMesh.normalMap=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(faces),normals)}if(isVertexColors){for(var i=0,il=colors.length;i<il;i++){if(!colors[i]){colors[i]=new THREE.Color}}polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(faces),colors)}if(isMaterialIDs){polyMesh.materialIds=materialIDs}if(geometry.faceVertexUvs.length&&geometry.faceVertexUvs[0].length&&geometry.faceVertexUvs[0][0]!==undefined){var uvFaces=[];var nextUVVertex=0;for(var f=0,fl=geometry.faces.length;f<fl;f++){var face=geometry.faces[f];if(face instanceof THREE.Face3){uvFaces.push([nextUVVertex++,nextUVVertex++,nextUVVertex++])}else if(face instanceof THREE.Face4){uvFaces.push([nextUVVertex++,nextUVVertex++,nextUVVertex++,nextUVVertex++])}else{throw new Error("should not get here.")}}for(var i=0,il=geometry.faceVertexUvs.length;i<il;i++){var mapName=i===0?exo.geometry.PolyMesh.DEFAULT_MAP:"map"+i;var uvFaceSet=geometry.faceVertexUvs[i];var uvValues=[];for(var f=0,fl=geometry.faces.length;f<fl;f++){var uvFace=uvFaceSet[f];for(var u=0,ul=uvFace.length;u<ul;u++){uvValues.push(uvFace[u])}}polyMesh.uvMaps[mapName]=new exo.geometry.PolyMap(uvFaces,uvValues)}}if(polyMesh.validate().length>0){console.log("WARNING: invalid PolyMesh")}return polyMesh};!function(){var ComponentUtils=exo.geometry.ComponentUtilities;exo.geometry.PolyMeshUtilities={transformPoints:function(matrix,points){for(var i=0,il=points.length;i<il;i++){points[i].applyMatrix4(matrix)}},transformNormals:function(matrix,normals,optionalNormalsMatrix){var m0=optionalNormalsMatrix||this.__m0.getInverse(matrix).transpose();for(var i=0,il=normals.length;i<il;i++){normals[i].applyMatrix3(m0).normalize()}},toExpandedValuesArray:function(faces,values){var expandedValues=[];var faceIndices;if(!faces||!values){return values}if(values[0]&&_.isFunction(values[0].clone)){for(var i=0,il=faces.length;i<il;i++){faceIndices=faces[i];for(var j=0,jl=faceIndices.length;j<jl;j++){expandedValues.push(values[faceIndices[j]].clone())}}}else{for(var j=0,jl=faceIndices.length;j<jl;j++){expandedValues.push(values[faceIndices[j]])}}return expandedValues},toExplodedFaceValues:function(originalFaces,originalValues){var explodedFaces=[];var explodedValues=[];if(!originalFaces||!originalValues){return{faces:originalFaces,values:originalValues}}for(var i=0,il=originalFaces.length;i<il;i++){var originalFaceIndices=originalFaces[i];var explodedFaceIndices=[];for(var j=0,jl=originalFaceIndices.length;j<jl;j++){explodedFaceIndices.push(explodedValues.length);explodedValues.push(originalValues[originalFaceIndices[j]].clone())}explodedFaces.push(explodedFaceIndices)}return{faces:explodedFaces,values:explodedValues}},validateTopology:function(faces,values,validateDeeply,mapName,exitOnFirstError){var errorList=[];if(faces===undefined||values===undefined){errorList.push(mapName+": faces or values is undefined");if(exitOnFirstError)return errorList}if(faces.length===0!==(values.length===0)){errorList.push(mapName+": faces or values is of length 0 and the other isn't, face.length = "+faces.length+", values.length = "+values.length);if(exitOnFirstError)return errorList}var faceIndices,valuesLength=values.length,faceIndicesLength;for(var i=0,il=faces.length;i<il;i++){faceIndices=faces[i];faceIndicesLength=faceIndices.length;if(faceIndices.length===0){errorList.push(mapName+": faceIndices is of length 0");if(exitOnFirstError)return errorList}for(var j=0;j<faceIndicesLength;j++){var faceIndex=faceIndices[j];if(faceIndex<0||faceIndex>=valuesLength||faceIndex===undefined){errorList.push(mapName+": faceIndex '"+faceIndex+"' is out of expected range [0,"+valuesLength+"].");if(exitOnFirstError)return errorList}}}if(validateDeeply){for(var i=0,il=values.length;i<il;i++){if(exo.math.isNaN(values[i])){errorList.push(mapName+": Invalid or NaN values are found");if(exitOnFirstError)return errorList}}}return errorList},polygonCount:function(node){var count=0;if(!node){return 0}if(node.get("type")==="Scene"){node.each(function(childNode){if(!childNode.polyMesh){return}count+=childNode.polyMesh.faces.length});return count}else{return node.polyMesh?node.polyMesh.faces.length:0}},vertexCount:function(node){var count=0;var vertices;if(!node){return 0}if(node.get("type")==="Scene"){node.each(function(childNode){if(!childNode.polyMesh){return}count+=childNode.polyMesh.positions.length});return count}else{return node.polyMesh?node.polyMesh.positions.length:0}},flatNormalMap:function(faces,positions){var faceIndices=[];var vertexNormals=[];var faceIndices,faceNormal;for(var i=0,il=faces.length;i<il;i++){var face=faces[i];var base=vertexNormals.length;var indices=[];for(var j=0;j<face.length;j++){indices.push(base+j)}faceIndices.push(indices);var faceNormal=exo.geometry.PolyMeshUtilities.computeNormal(face,positions);for(var j=0,jl=face.length;j<jl;j++){vertexNormals.push(faceNormal.clone())}}return new exo.geometry.PolyMap(faceIndices,vertexNormals)},simpleNormalMap:function(faces,positions){var vertexNormals=[];for(var i=0,il=positions.length;i<il;i++){vertexNormals.push(new THREE.Vector3)}var faceIndices,faceNormal;for(var i=0,il=faces.length;i<il;i++){faceIndices=faces[i];faceNormal=exo.geometry.PolyMeshUtilities.computeNormal(faceIndices,positions);for(var j=0,jl=faceIndices.length;j<jl;j++){vertexNormals[j].add(faceNormal.clone())}}for(var i=0,il=vertexNormals.length;i<il;i++){vertexNormals[i].normalize()}return new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(faces),vertexNormals)},areaWeightedNormalMap:function(faces,positions){var vertexNormals=[];for(var i=0,il=positions.length;i<il;i++){vertexNormals.push(new THREE.Vector3)}var nextK,prevK;var vNext,vPrev,fNext,fPrev;var v0vNLengthSq,v0vPLengthSq;var faceIndices,kLen;var v0,f0;var v0vP=new THREE.Vector3;var v0vN=new THREE.Vector3;var tmp=new THREE.Vector3;for(var i=0,il=faces.length;i<il;i++){faceIndices=faces[i];kLen=faceIndices.length-1;for(var k=0,kl=faceIndices.length;k<kl;k++){nextK=k===kLen?0:k+1;prevK=k===0?kLen:k-1;fPrev=faceIndices[prevK];f0=faceIndices[k];fNext=faceIndices[nextK];vPrev=positions[fPrev];v0=positions[f0];vNext=positions[fNext];v0vN.subVectors(vNext,v0);v0vP.subVectors(vPrev,v0);v0vPLengthSq=v0vP.lengthSq();v0vNLengthSq=v0vN.lengthSq();vertexNormals[f0].add(tmp.copy(v0vN).cross(v0vP).multiplyScalar(1/(v0vNLengthSq*v0vPLengthSq)))}}for(var i=0,il=vertexNormals.length;i<il;i++){vertexNormals[i].normalize()}return new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(faces),vertexNormals)},computeFacesAverageNormal:function(polyMesh,ifaceIndices){var faces=polyMesh.faces;var positions=polyMesh.positions;var faceNormal=new THREE.Vector3;if(!polyMesh||!ifaceIndices||!faces||!positions||faces.length<1){return null}for(var i=0,il=ifaceIndices.length;i<il;i++){var faceIndices=faces[ifaceIndices[i]];faceNormal.add(exo.geometry.PolyMeshUtilities.computeNormal(faceIndices,positions))}faceNormal.divideScalar(ifaceIndices.length);faceNormal.normalize();return faceNormal},__m0:new THREE.Matrix3,removeOrphans:function(faces,values){console.log("DEPRECATED: use removeUnusedValues() instead of removeOrphans()");var mapOldValuesOntoNew=[];for(var i=0;i<values.length;i++){mapOldValuesOntoNew.push(-1)}var newFaces=[];var nextValueIndex=0;for(var f=0;f<faces.length;f++){var nextFace=faces[f];var newFace=[];newFaces.push(newFace);for(var i=0;i<nextFace.length;i++){var valueIndex=nextFace[i];if(mapOldValuesOntoNew[valueIndex]===-1){mapOldValuesOntoNew[valueIndex]=nextValueIndex++}newFace.push(mapOldValuesOntoNew[valueIndex])}}var newValues=[];for(var i=0;i<nextValueIndex;i++){newValues.push(-1)}for(var i=0;i<mapOldValuesOntoNew.length;i++){var newIdx=mapOldValuesOntoNew[i];if(newIdx===-1){continue}newValues[newIdx]=values[i]}return{faces:newFaces,values:newValues}},getValueIndicesFromSubFaceIndices:function(faces,subFaceIndices){var valueIndices=[];for(var i=0;i<subFaceIndices.length;i++){var f=subFaceIndices[i].faceIndex;var sfi=subFaceIndices[i].subFaceIndex;valueIndices.push(faces[f][sfi])}return valueIndices},deleteVertices:function(faces,values,vertexIndices){var deletedVertexMap={};for(var i=0;i<vertexIndices.length;i++){deletedVertexMap[vertexIndices[i]]=true}var oldValuesToNewValues=[];var nextNewIndex=0;var newValues=[];for(var i=0;i<values.length;i++){if(!deletedVertexMap[i]){oldValuesToNewValues[i]=nextNewIndex;nextNewIndex++;newValues.push(values[i])}}var newFaces=[];for(var f=0;f<faces.length;f++){var face=faces[f];var deletedVertexCount=0;for(var i=0;i<face.length;i++){if(deletedVertexMap[face[i]]){deletedVertexCount++}}if(deletedVertexCount===0){var newFace=[];for(var i=0;i<face.length;i++){newFace.push(oldValuesToNewValues[face[i]])}newFaces.push(newFace)}}return{faces:newFaces,values:newValues}},deleteFromList:function(list,indices){var newArray=[];var deletedMap={};var i,length;for(i=0,length=indices.length;i<length;++i){deletedMap[indices[i]]=true}for(i=0,length=list.length;i<length;++i){if(!deletedMap[i]){newArray.push(list[i])}}return newArray},add:function(polyMesh,toAdd,transform){console.log("DEPRECATED: use merge() functions instead of add()");var normalMatrix;toAdd=toAdd.clone();exo.geometry.PolyMeshUtilities.concatFaces(polyMesh,toAdd);if(transform){exo.geometry.PolyMeshUtilities.transformPoints(transform,toAdd.positions);if(polyMesh.normalMap&&toAdd.normalMap){normalMatrix=(new THREE.Matrix3).getInverse(transform);normalMatrix.transpose();for(var i=0,il=toAdd.normalMap.values.length;i<il;++i){toAdd.normalMap.values[i].applyMatrix3(normalMatrix).normalize()}}}polyMesh.positions=polyMesh.positions.concat(toAdd.positions);if(polyMesh.normalMap&&toAdd.normalMap){polyMesh.normalMap=exo.geometry.PolyMeshUtilities.concatPolyMap(polyMesh.normalMap,toAdd.normalMap)}else{polyMesh.normalMap=null}exo.geometry.PolyMeshUtilities.copyPolyMaps(polyMesh.uvMaps,toAdd.uvMaps);exo.geometry.PolyMeshUtilities.copyPolyMaps(polyMesh.colorMaps,toAdd.colorMaps)},concatFaces:function(polyMesh,toAdd){var faceCount=polyMesh.faces.length,vertexCount=polyMesh.positions.length;polyMesh.faces=polyMesh.faces.concat(toAdd.faces);for(var i=faceCount,il=polyMesh.faces.length;i<il;++i){var face=polyMesh.faces[i];face[0]+=vertexCount;face[1]+=vertexCount;face[2]+=vertexCount;if(face.length>3)face[3]+=vertexCount}},copyPolyMaps:function(polyMaps,toAdd){_.each(toAdd,function(polyMap,key){if(polyMaps[key]){polyMaps[key]=exo.geometry.PolyMeshUtilities.concatPolyMap(polyMaps[key],polyMap)}})},concatPolyMap:function(polyMap,toAdd){if(toAdd){polyMap=polyMap?polyMap.clone():new exo.geometry.PolyMap;var faceCount=polyMap.faces.length,valueCount=polyMap.values.length;polyMap.values=polyMap.values.concat(toAdd.values);polyMap.faces=polyMap.faces.concat(toAdd.faces);for(var i=faceCount,il=polyMap.faces.length;i<il;++i){var face=polyMap.faces[i];face[0]+=valueCount;face[1]+=valueCount;face[2]+=valueCount;if(face.length>3)face[3]+=valueCount}}return polyMap},computeAverageVertex:function(polyMesh,vertexIndices){var averageVertices=new THREE.Vector3;if(vertexIndices.length<1||!polyMesh||polyMesh.positions.length<1){return averageVertices}for(var i=0,il=vertexIndices.length;i<il;i++){averageVertices.add(polyMesh.positions[vertexIndices[i]])}return averageVertices.multiplyScalar(1/vertexIndices.length)},removeUnusedValues:function(faces,values,optionalValueIndices){var valueIndex;var usedValues={};var isolatedValues={};var newValues=[];var passedIndicesKeys={};if(!values||!faces){return false}var oldNumValues=values.length;if(optionalValueIndices){passedIndicesKeys=exo.geometry.ComponentUtilities.createVertexIndicesHashKeys(optionalValueIndices)}var addValue=function(index,newValuesList){usedValues[index]=newValuesList.length;newValuesList.push(values[index])};for(var f=0,fl=faces.length;f<fl;f++){face=faces[f];for(var i=0,il=face.length;i<il;i++){valueIndex=face[i];if(usedValues[valueIndex]===undefined){usedValues[valueIndex]=valueIndex}}}for(var i=0,il=values.length;i<il;i++){if(usedValues[i]!==undefined){addValue(i,newValues)}else{if(optionalValueIndices&&passedIndicesKeys[i]===undefined){addValue(i,newValues)}}}if(oldNumValues==newValues.length){return false}for(var f=0,fl=faces.length;f<fl;f++){face=faces[f];for(var i=0,il=face.length;i<il;i++){face[i]=usedValues[face[i]]}}values.length=0;for(var i=0,il=newValues.length;i<il;i++){values.push(newValues[i])}return true},computeMapValueAtIntersection:function(polyMesh,polyMap,faceIndex,mapStartIndex,mapEndIndex,edge,intersectPt){var mapIndices=polyMap.faces[faceIndex];var mapValueStart=polyMap.values[mapIndices[mapStartIndex]];var mapValueEnd=polyMap.values[mapIndices[mapEndIndex]];var startVertex=edge.getStartVertex(polyMesh.positions);var edgeLength=edge.distance(polyMesh.positions);var distIntersectRatio=startVertex.distanceTo(intersectPt)/edgeLength;return mapValueStart.clone().lerp(mapValueEnd,distIntersectRatio)},connectEdges:function(polyMesh,edges,numSegments,offset){var faces=polyMesh.faces;var normalMap=polyMesh.normalMap;var colorMaps=polyMesh.colorMaps;var uvMaps=polyMesh.uvMaps;var vertices=polyMesh.positions;var newFace=[],newVertexIndices=[],newFaceNormalIndices=[],subFaceIndices=[],newVertexIndicesKeys={},newVertexKeys={};var polyFace,normalIndices,newFaceUVsIndices,newFaceColorsIndices;var face,faceEdgesKeys,edgeKey,curEdgeInfo,vertexIndex,vCounter,edgeSplitCounter;var newEdgeVertices,vertexIndex,oldVertexIndex,startIndex,faceIndex,newEdgeEndPt;var newFaceSide1,newFaceSide2,newFaceMiddle,newMapValue;var doReverse;var nSegments=numSegments>=1?numSegments:1;if(edges.length<1||vertices.length<3||faces.length<1){return false}var edgesKeys=ComponentUtils.createSelectedEdgesHashKeys(edges);var facesEdgeKeys=ComponentUtils.createEdgesHashKeysInArray(polyMesh);var selectedFaces=ComponentUtils.getFacesByEdges(polyMesh,edges,edgesKeys,facesEdgeKeys,2,2);if(selectedFaces.length<1){return false}var neighborSelectedFaces=ComponentUtils.getFacesByEdges(polyMesh,edges,edgesKeys,facesEdgeKeys,1,1);var selectedFaces=_.union(selectedFaces,neighborSelectedFaces);var _getIndicesFromSubFaces=function(indicesList,subFaceIndices){var mapIndices=[];for(var i=0,il=subFaceIndices.length;i<il;i++){mapIndices.push(indicesList[subFaceIndices[i]])}return mapIndices};var _updateNormalMap=function(polyMesh,polyFace,newFaceNormalIndices,subFaceIndices){if(polyMesh.hasNormalMap()){polyFace.setNormalIndices(_getIndicesFromSubFaces(newFaceNormalIndices,subFaceIndices))}};var _updateUVMaps=function(polyMesh,polyFace,uvIndicesWithChannels,subFaceIndices){if(polyMesh.hasUVMap()){_.each(polyMesh.uvMaps,function(uvMap,mapName){polyFace.setUVIndices(_getIndicesFromSubFaces(uvIndicesWithChannels[mapName],subFaceIndices),mapName)})}};var _updateColorMaps=function(polyMesh,polyFace,colorIndicesWithChannels,subFaceIndices){if(polyMesh.hasColorMap()){_.each(polyMesh.colorMaps,function(colorMap,mapName){polyFace.setVertexColorsIndices(_getIndicesFromSubFaces(colorIndicesWithChannels[mapName],subFaceIndices),mapName)})}};for(var f=0,fl=selectedFaces.length;f<fl;f++){faceIndex=selectedFaces[f];face=faces[faceIndex];faceEdgesKeys=facesEdgeKeys[faceIndex];newVertexIndices=[];newFace=[];newFaceNormalIndices=[];newFaceUVsIndices={};newFaceColorsIndices={};vCounter=0;edgeSplitCounter=0;if(face.length!==faceEdgesKeys.length){continue}if(polyMesh.hasUVMap()){_.each(uvMaps,function(uvMap,mapName){newFaceUVsIndices[mapName]=[]})}if(polyMesh.hasColorMap()){_.each(colorMaps,function(colorMap,mapName){newFaceColorsIndices[mapName]=[]})}for(var i=0,il=faceEdgesKeys.length;i<il;i++){curEdgeInfo=faceEdgesKeys[i];newFace.push(curEdgeInfo.edge.start);if(polyMesh.hasNormalMap()){normalIndices=normalMap.faces[faceIndex];newFaceNormalIndices.push(normalIndices[i])}if(polyMesh.hasUVMap()){_.each(uvMaps,function(uvMap,mapName){var uvIndices=uvMap.faces[faceIndex];newFaceUVsIndices[mapName].push(uvIndices[i])})}if(polyMesh.hasColorMap()){_.each(colorMaps,function(colorMap,mapName){var colorIndices=colorMap.faces[faceIndex];newFaceColorsIndices[mapName].push(colorIndices[i])})}if(edgesKeys[curEdgeInfo.key]){newEdgeVertices=curEdgeInfo.edge.split(nSegments,vertices);edgeSplitCounter++;for(var j=0,jl=newEdgeVertices.length;j<jl;j++){vertexKey=ComponentUtils.createVertexHashKey(newEdgeVertices[j],5);oldVertexIndex=newVertexKeys[vertexKey];if(oldVertexIndex===undefined){vertexIndex=polyMesh.addVertex(newEdgeVertices[j]);newVertexKeys[vertexKey]=vertexIndex}else{vertexIndex=oldVertexIndex}newVertexIndicesKeys[vertexIndex]=vCounter;newVertexIndices.push(vertexIndex);newFace.push(vertexIndex);vCounter++}if(polyMesh.hasNormalMap()){for(var j=0,jl=newEdgeVertices.length;j<jl;j++){newMapValue=this.computeMapValueAtIntersection(polyMesh,normalMap,faceIndex,i,(i+1)%il,curEdgeInfo.edge,newEdgeVertices[j]);newFaceNormalIndices.push(polyMesh.addNormal(newMapValue))}}if(polyMesh.hasUVMap()){_.each(uvMaps,function(uvMap,mapName){for(var j=0,jl=newEdgeVertices.length;j<jl;j++){newMapValue=this.computeMapValueAtIntersection(polyMesh,uvMap,faceIndex,i,(i+1)%il,curEdgeInfo.edge,newEdgeVertices[j]);newFaceUVsIndices[mapName].push(polyMesh.addUV(newMapValue))}},this)}if(polyMesh.hasColorMap()){_.each(colorMaps,function(colorMap,mapName){for(var j=0,jl=newEdgeVertices.length;j<jl;j++){newMapValue=this.computeMapValueAtIntersection(polyMesh,colorMap,faceIndex,i,(i+1)%il,curEdgeInfo.edge,newEdgeVertices[j]);newFaceColorsIndices[mapName].push(polyMesh.addVertexColor(newMapValue))}},this)}}}if(edgeSplitCounter==1){subFaceIndices=[];for(var i=0,il=newFace.length;i<il;i++){subFaceIndices.push(i)}if(newFace.length>2){polyFace=new exo.geometry.PolygonFace(newFace);_updateNormalMap(polyMesh,polyFace,newFaceNormalIndices,subFaceIndices);_updateUVMaps(polyMesh,polyFace,newFaceUVsIndices,subFaceIndices);_updateColorMaps(polyMesh,polyFace,newFaceColorsIndices,subFaceIndices);polyMesh.updateFace(faceIndex,polyFace)}continue}else if(vCounter<2||vCounter%2!==0){continue}newFaceSide1=[];subFaceIndices=[];for(var i=0,il=newFace.length;i<il;i++){vertexIndex=newFace[i];newFaceSide1.push(vertexIndex);subFaceIndices.push(i);if(newVertexIndicesKeys[vertexIndex]!==undefined){startIndex=newFace.indexOf(newVertexIndices[vCounter-1]);if(startIndex<0){break}for(var j=startIndex,jl=newFace.length;j<jl;j++){newFaceSide1.push(newFace[j]);subFaceIndices.push(j)}break}}if(newFaceSide1.length>2){polyFace=new exo.geometry.PolygonFace(newFaceSide1);_updateNormalMap(polyMesh,polyFace,newFaceNormalIndices,subFaceIndices);_updateUVMaps(polyMesh,polyFace,newFaceUVsIndices,subFaceIndices);_updateColorMaps(polyMesh,polyFace,newFaceColorsIndices,subFaceIndices);polyFace.setMaterialID(polyMesh.getMaterialID(faceIndex));polyMesh.updateFace(faceIndex,polyFace)}newFaceSide2=[];subFaceIndices=[];startIndex=newFace.indexOf(newVertexIndices[vCounter/2-1]);endIndex=newFace.indexOf(newVertexIndices[vCounter/2]);if(startIndex>=0){for(var i=startIndex,il=newFace.length;i<il&&i<=endIndex;i++){vertexIndex=newFace[i];newFaceSide2.push(vertexIndex);subFaceIndices.push(i)}if(newFaceSide2.length>2){polyFace=new exo.geometry.PolygonFace(newFaceSide2);_updateNormalMap(polyMesh,polyFace,newFaceNormalIndices,subFaceIndices);_updateUVMaps(polyMesh,polyFace,newFaceUVsIndices,subFaceIndices);_updateColorMaps(polyMesh,polyFace,newFaceColorsIndices,subFaceIndices);polyFace.setMaterialID(polyMesh.getMaterialID(faceIndex));polyMesh.addFace(polyFace)}}if(nSegments>1){for(var i=0,il=newVertexIndices.length/2-1;i<il;i++){newFaceMiddle=[];subFaceIndices=[];newEdgeEndPt=vCounter-1-i;newFaceMiddle.push(newVertexIndices[i],newVertexIndices[i+1]);newFaceMiddle.push(newVertexIndices[newEdgeEndPt-1],newVertexIndices[newEdgeEndPt]);for(var j=0,jl=newFaceMiddle.length;j<jl;j++){var itemIndex=newFace.indexOf(newFaceMiddle[j]);subFaceIndices.push(itemIndex)}if(newFaceMiddle.length>2){polyFace=new exo.geometry.PolygonFace(newFaceMiddle);_updateNormalMap(polyMesh,polyFace,newFaceNormalIndices,subFaceIndices);_updateUVMaps(polyMesh,polyFace,newFaceUVsIndices,subFaceIndices);_updateColorMaps(polyMesh,polyFace,newFaceColorsIndices,subFaceIndices);polyFace.setMaterialID(polyMesh.getMaterialID(faceIndex));polyMesh.addFace(polyFace)}}}}polyMesh.velocities=null;return true},connectVertices:function(polyMesh,vertexIndices){var polyFace,face;var newVertices,selectedVertices;var faces=polyMesh.faces;var vIndicesKeys=ComponentUtils.createVertexIndicesHashKeys(vertexIndices);var selectedFaces=ComponentUtils.getFacesByVertices(polyMesh,vertexIndices,vIndicesKeys,2);var facesEdges=ComponentUtils.getEdges(polyMesh,selectedFaces,false);var facesEdgesKeys=ComponentUtils.createSelectedEdgesHashKeys(facesEdges);var _getSelectedVerticesKeys=function(face,allEdges){var vertsKeys={};var verts=[];var next,lastPos;var edgeCounter=0;for(var i=0,il=face.length;i<il;i++){if(vIndicesKeys[face[i]]!==undefined){verts.push(i)}}if(verts.length>1){lastPos=verts.length-1;var newEdges={};var newEdgeKey;next=1;for(var i=0,iLen=verts.length-1;i<iLen;i++){if(next>iLen){break}newEdgeKey=new exo.geometry.Edge(face[verts[i]],face[verts[next]]).createHashKey();if(allEdges[newEdgeKey]===undefined&&newEdges[newEdgeKey]===undefined){vertsKeys[verts[i]]=verts[next];vertsKeys[verts[next]]=null;newEdges[newEdgeKey]=true;edgeCounter++;break}else if(i!=lastPos){i=i-1}next++}}return{indices:vertsKeys,counter:edgeCounter}};var _createPolyFace=function(faceIndex,face,startIndex,updateFace,_addedVerts){var next,vIndex,newFace=[];var addCounter=0;var polyFace;var subFaceIndices=[];for(var i=startIndex,il=face.length;i<il;++i){vIndex=face[i];newFace.push(vIndex);subFaceIndices.push(new exo.geometry.SubFace(faceIndex,i));if(_addedVerts[vIndex]!==undefined){addCounter++;if(addCounter<2){continue}else{break}}_addedVerts[vIndex]=true;next=selectedVertices[i];if(next!=undefined){if(next==0){break}i=next-1;continue}}if(newFace.length>2){polyFace=new exo.geometry.PolygonFace(newFace);polyFace.setPolyMapsBySubFaces(polyMesh,subFaceIndices);polyFace.setMaterialID(polyMesh.getMaterialID(faceIndex))}return polyFace};var addedVerts;var faceIndex,vIndex,edgeCounter,next;var faceConverter=new exo.geometry.FaceConverter2;var polyFaceList=[];var polyFaces,poly;for(var f=0,fl=selectedFaces.length;f<fl;++f){faceIndex=selectedFaces[f];face=faces[selectedFaces[f]];polyFaces=[];var sVerts=_getSelectedVerticesKeys(face,facesEdgesKeys);selectedVertices=sVerts.indices;edgeCounter=sVerts.counter;if(edgeCounter<1){polyFaceList.push(polyFaces);continue}addedVerts={};poly=_createPolyFace(faceIndex,face,0,false,addedVerts);if(poly){polyFaces.push(poly)}for(var i=0,il=face.length;i<il;++i){next=face[(i+1)%il];if(addedVerts[next]!==undefined){continue}poly=_createPolyFace(faceIndex,face,i,false,addedVerts);if(poly){polyFaces.push(poly)}}polyFaceList.push(polyFaces)}for(var i=0,il=polyFaceList.length;i<il;++i){poly=polyFaceList[i];for(var j=0,jl=poly.length;j<jl;++j){if(j===0){polyMesh.updateFace(selectedFaces[i],poly[j])}else{polyMesh.addFace(poly[j])}}}},triangulateFace:function(face){var newFaces=[];if(!face||face.length<3){return newFaces}var firstPositionIndex=face[0];for(var i=0,il=face.length-2;i<il;++i){var positionIndex=face[i+1];var nextPositionIndex=face[i+2];newFaces.push([firstPositionIndex,positionIndex,nextPositionIndex])}return newFaces},computeNormal:function(vertexIndices,meshVertices){var normal=new THREE.Vector3(0,0,0);var j,vertex1,vertex2;if(!vertexIndices||!meshVertices||meshVertices.length<1){return null}for(var i=0,ilen=vertexIndices.length;i<ilen;i++){j=(i+1)%ilen;vertex1=meshVertices[vertexIndices[i]];vertex2=meshVertices[vertexIndices[j]];normal.x+=(vertex1.y-vertex2.y)*(vertex1.z+vertex2.z);normal.y+=(vertex1.z-vertex2.z)*(vertex1.x+vertex2.x);normal.z+=(vertex1.x-vertex2.x)*(vertex1.y+vertex2.y)}return normal.normalize()},createPlane:function(width,height,noMaterialIDs,noUVs,noNormalMap,noVertexColors){width=width==undefined||width<=0?1:width;height=height==undefined||height<=0?1:height;var faces=[[0,1,2,3]];var vertices=[new THREE.Vector3(width,0,height),new THREE.Vector3(-width,0,height),new THREE.Vector3(-width,0,-height),new THREE.Vector3(width,0,-height)];var polyMesh=new exo.geometry.PolyMesh(faces,vertices);if(!noNormalMap){var normals=[new THREE.Vector3(0,1,0)];var normalIndices=[[0,0,0,0]];polyMesh.setNormalMap(new exo.geometry.PolyMap(normalIndices,normals))}if(!noUVs){var uvs=[new THREE.Vector2(1,0),new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1)];var uvsIndices=[[0,1,2,3]];polyMesh.setUVMap(new exo.geometry.PolyMap(uvsIndices,uvs))}if(!noVertexColors){var colors=[(new THREE.Color).setRGB(1,1,1),(new THREE.Color).setRGB(1,1,0)];var colorIndices=[[0,1,0,1]];polyMesh.setColorMap(new exo.geometry.PolyMap(colorIndices,colors))}if(!noMaterialIDs){polyMesh.setDefaultMaterialIDs()}return polyMesh},mergePolyMeshNodes:function(nodes){var srcTransform,toMeshTransform,mergedPolyMeshes,polyMesh,transform;if(!nodes||!nodes.length||nodes.length<2){return null}polyMesh=nodes[0].polyMesh;if(!polyMesh||!nodes[0].transform){return null}transform=nodes[0].transform.getWorldTransform();mergedPolyMeshes=polyMesh.clone();if(transform){mergedPolyMeshes.applyMatrix4(transform)}for(var i=1,il=nodes.length;i<il;i++){var targetNode=nodes[i];if(!targetNode){continue}if(targetNode.transform){toSrcTransform=targetNode.transform.getWorldTransform()}if(targetNode.polyMesh){mergedPolyMeshes.merge(targetNode.polyMesh,toSrcTransform)}}return mergedPolyMeshes},mergeSelectedPolyMeshNodes:function(editor,mergeName){if(!editor){return}var ctx=editor.getCtx();var scene=editor.scene;var objectsRootNode=scene?scene.objectsRootNode:null;var selectedNodes=editor.getSelectedByType("PolyMesh");if(selectedNodes.length<2){return}var mergedMeshes=exo.geometry.PolyMeshUtilities.mergePolyMeshNodes(selectedNodes);if(mergedMeshes){ctx(":selection").remove();if(objectsRootNode){ctx(objectsRootNode).addNode(mergeName?mergeName:"Merged_Meshes","PolyMesh",{PolyMesh:{}}).then(function(polyMeshNode){ctx(polyMeshNode.plugs.PolyMesh).addFile({name:mergeName+".json",content:mergedMeshes,type:"application/json",sourceType:"import",internal:true}).then(function(blob){ctx(polyMeshNode.plugs.PolyMesh).addOperator("Mesh",{geometry:blob})})})}}},mergeFaces:function(polyMesh,faceIndices,faceConverter){if(!polyMesh||!faceIndices||faceIndices.length<2){return false}var SubFaceUtils=exo.geometry.SubFaceUtilities;var borderEdges=ComponentUtils.getBorderEdges(polyMesh,faceIndices);var connectedEdgesGroups=ComponentUtils.getConnectedEdgeIndices(borderEdges);var _faceConverter=faceConverter&&faceConverter instanceof exo.geometry.FaceConverter2?faceConverter:new exo.geometry.FaceConverter2;var borderEdgesGroups=ComponentUtils.getConnectedEdges(borderEdges);if(borderEdgesGroups.length===1){var borderVertices=ComponentUtils.getVerticesByEdges(borderEdgesGroups[0]);var subFaceIndicesLists=SubFaceUtils.getSubFacesByVertices(polyMesh,faceIndices,borderVertices);var polyFace=new exo.geometry.PolygonFace(borderVertices);var subFaceIndices=[];var subFaceList;for(var i=0,il=subFaceIndicesLists.length;i<il;i++){subFaceList=subFaceIndicesLists[i];subFaceIndices.push(subFaceList[0]);if(subFaceList.length>1&&polyMesh.hasNormalMap()){var avgNormal=SubFaceUtils.computeAverageBySubFaces(polyMesh.normalMap.faces,polyMesh.normalMap.values,subFaceList);if(avgNormal!=undefined){subFaceList[0].setPolyMapValue(polyMesh.normalMap,avgNormal.normalize())}}}polyFace.setPolyMapsBySubFaces(polyMesh,subFaceIndices);polyFace.setMaterialID(polyMesh.getMaterialID(faceIndices[0]));var newFaceIndex=polyMesh.addFace(polyFace);_faceConverter.removeFacesFlag(faceIndices);_faceConverter.updateFaceFlag(newFaceIndex,subFaceIndices);if(!faceConverter){!_faceConverter.convertPolyMesh(polyMesh)}}else{return false}return true},removeVerticesFromFaces:function(polyMesh,faceIndices,vertexIndices,faceConverter){var faces=polyMesh.faces;var face,faceIndex;
var subFaceIndices;if(!faceIndices||!faces||faces.length<1||faceIndices.length<1||!vertexIndices){return false}var vertexIndicesKeys=ComponentUtils.createVertexIndicesHashKeys(vertexIndices);var _faceConverter=faceConverter&&faceConverter instanceof exo.geometry.FaceConverter2?faceConverter:new exo.geometry.FaceConverter2;for(var i=0,il=faceIndices.length;i<il;i++){faceIndex=faceIndices[i];face=faces[faceIndex];subFaceIndices=[];for(var j=0,jl=face.length;j<jl;j++){if(vertexIndicesKeys[face[j]]===undefined){subFaceIndices.push(new exo.geometry.SubFace(faceIndex,j))}}_faceConverter.updateFaceFlag(faceIndex,subFaceIndices)}if(!faceConverter){_faceConverter.convertPolyMesh(polyMesh)}return true},removeVertex:function(polyMesh,vertexIndex,faceConverter){var status=false;var edge;if(!polyMesh||vertexIndex==undefined){return status}var selectedFaces=ComponentUtils.getFacesByVertices(polyMesh,[vertexIndex]);if(selectedFaces.length>=2){var selectedFacesEdgesKeys=ComponentUtils.createEdgesHashKeys(polyMesh,selectedFaces);var selectedEdgesKeys=ComponentUtils.getEdgesByVerticesKeys(polyMesh,[vertexIndex],selectedFacesEdgesKeys);var numEdges=_.size(selectedEdgesKeys);if(numEdges>0){var doMergeFaces=false;_.each(selectedEdgesKeys,function(edge,edgeKey){if(doMergeFaces){return}if(selectedFacesEdgesKeys[edgeKey]!==undefined&&selectedFacesEdgesKeys[edgeKey].counter!==numEdges){doMergeFaces=true}});if(doMergeFaces){status=this.mergeFaces(polyMesh,selectedFaces,faceConverter)}else{status=this.removeVerticesFromFaces(polyMesh,selectedFaces,[vertexIndex],faceConverter)}}}else if(selectedFaces.length==1){status=this.removeVerticesFromFaces(polyMesh,selectedFaces,[vertexIndex],faceConverter)}return status},removeEdge:function(polyMesh,edge){if(!polyMesh||!edge){return false}var selectedFaces=exo.geometry.ComponentUtilities.getFacesByEdges(polyMesh,[edge]);return this.mergeFaces(polyMesh,selectedFaces)},fillBorders:function(polyMesh,edges){if(!polyMesh||!edges){return false}var newEdges=ComponentUtils.excludeEdges(polyMesh,edges,ComponentUtils.ExcludeEdges.NonBorder);var edgesGroups=ComponentUtils.getConnectedEdges(newEdges,false);var edgesVertices,polyFace,newFaceIndex;for(var i=0,il=edgesGroups.length;i<il;i++){var polyGroupEdges=ComponentUtils.sortNestedConnectedEdges(edgesGroups[i]);for(var j=0,jl=polyGroupEdges.length;j<jl;j++){var polygons=ComponentUtils.createFacesByEdges(polyGroupEdges[j]);for(var p=0,pl=polygons.length;p<pl;p++){edgesVertices=polygons[p];edgesVertices.reverse();polyFace=new exo.geometry.PolygonFace(edgesVertices);newFaceIndex=polyMesh.addFace(polyFace)}}}},mirrorFaces:function(polyMesh,plane){var polyMeshClone;if(!polyMesh||!plane){return polyMeshClone}polyMeshClone=polyMesh.clone();var normal=plane.normal.clone();var mirrorAxis=new THREE.Vector3(1,0,0);var angle,axis;var rotationMatrix=new THREE.Matrix4;if(Math.abs(normal.dot(mirrorAxis))!==1){angle=mirrorAxis.angleTo(normal);axis=(new THREE.Vector3).crossVectors(normal,mirrorAxis).normalize();rotationMatrix=(new THREE.Matrix4).makeRotationAxis(axis,-angle)}var projectedCenter=plane.projectPoint(new THREE.Vector3(0,0,0));projectedCenter.multiplyScalar(-2);var translationMatrix=(new THREE.Matrix4).makeTranslation(projectedCenter.x,projectedCenter.y,projectedCenter.z);var mirrorMatrix=(new THREE.Matrix4).makeScale(-1,1,1);var matrices=[rotationMatrix,mirrorMatrix,(new THREE.Matrix4).getInverse(rotationMatrix),translationMatrix];polyMeshClone.applyMatrix4(exo.math.multiplyMatricesList(matrices));polyMeshClone.flipFaces(true);return polyMeshClone},symmetry:function(polyMesh,plane,weldSeam,weldThreshold,isMirror){var borderVertices,borderVerticesHalf;var lengthHalf,polyMeshMirror;if(!isMirror){borderVerticesHalf=polyMesh.sliceFaces(plane,null,false)}lengthHalf=polyMesh.getVertexCount();polyMeshMirror=this.mirrorFaces(polyMesh,plane);polyMesh.merge(polyMeshMirror);if(weldSeam&&borderVerticesHalf){borderVertices=borderVerticesHalf.slice(0);exo.geometry.CloneUtilities.appendArrayByOffset(borderVertices,borderVerticesHalf,lengthHalf);borderVerticesHalf=[];if(borderVertices.length>1){polyMesh.weldVertices(borderVertices,weldThreshold==undefined?.01:weldThreshold)}}},collapseMesh:function(polyMeshPlug){if(!polyMeshPlug){return}var polyMesh=polyMeshPlug.primitive;if(!polyMesh){return}polyMeshPlug.ctx().addFile({name:polyMeshPlug.node().get("name")+".json",content:polyMesh,type:"application/json",sourceType:"import",internal:true}).then(function(blob){polyMeshPlug.ctx(polyMeshPlug.operators.toArray()).remove();polyMeshPlug.ctx().addOperator("Mesh",{geometry:blob})})}}}();!function(){var UVMapping=exo.geometry.UVMapping={PLANAR:0,BOX:1,CYLINDRICAL:2,SPHERICAL:3,X:0,Y:1,Z:2,MATH_2PI:Math.PI*2,MATH_HALF_PI:Math.PI/2};exo.geometry.PolyMeshUVUtilities={applyUVMap:function(polyMesh,uvMapOptions){var DEFAULT_MAP=exo.geometry.PolyMesh.DEFAULT_MAP;var rotation=uvMapOptions.rotation||new THREE.Vector3;var scale=uvMapOptions.scale||new THREE.Vector3(1,1,1);var center=uvMapOptions.center||new THREE.Vector3;var uvMode=uvMapOptions.uvMode||UVMapping.PLANAR;var uvAxis=uvMapOptions.uvAxis!==undefined?uvMapOptions.uvAxis:UVMapping.Y;var mapChannel=uvMapOptions.mapChannel!==undefined?uvMapOptions.mapChannel:DEFAULT_MAP;var cap=uvMapOptions.cap!==undefined?uvMapOptions.cap:false;var wrap_w=uvMapOptions.wrap_w||scale.x;var wrap_h=uvMapOptions.wrap_h||scale.y;var faces=polyMesh.faces;var positions=polyMesh.positions;var s,t,u,v;var vertex,newVertex;var rotationRad=new THREE.Vector3(THREE.Math.degToRad(rotation.x),THREE.Math.degToRad(rotation.y),THREE.Math.degToRad(rotation.z));var matrixRotation=(new THREE.Matrix4).makeRotationFromEuler(rotationRad,"ZYX");var uvmapName="";if(mapChannel===DEFAULT_MAP){uvmapName=DEFAULT_MAP}else{uvmapName=mapChannel}var uvFaces=[];var uvValues=[];var posValues=[];for(var i=0,il=faces.length;i<il;i++){var faceIndices=faces[i];var newFaceIndices=[];var faceNormal;if(faceIndices.length>=3&&uvMapOptions.uvMode===UVMapping.BOX){faceNormal=exo.geometry.PolyMeshUtilities.computeNormal(faceIndices,positions)}for(var j=0,jl=faceIndices.length;j<jl;j++){var vertex=positions[faceIndices[j]];var newVertex=vertex.clone();newVertex.sub(center);newVertex.applyMatrix4(matrixRotation);var newUV=new THREE.Vector2;switch(uvMapOptions.uvMode){case UVMapping.PLANAR:this.planarUVMap(newVertex,uvAxis,scale,newUV);break;case UVMapping.BOX:this.boxUVMap(newVertex,faceNormal,scale,newUV);break;case UVMapping.CYLINDRICAL:this.cylindricalUVMap(newVertex,uvAxis,1,scale,newUV);break;case UVMapping.SPHERICAL:this.sphericalUVMap(newVertex,uvAxis,wrap_w,wrap_h,newUV);break;default:newUV.set(0,0);break}newFaceIndices.push(uvValues.length);uvValues.push(newUV)}uvFaces.push(newFaceIndices)}polyMesh.uvMaps[uvmapName]=new exo.geometry.PolyMap(uvFaces,uvValues);if(uvMapOptions.uvMode===UVMapping.CYLINDRICAL||uvMapOptions.uvMode===UVMapping.SPHERICAL){this.cleanSteamUVMap(polyMesh,scale,polyMesh.uvMaps[uvmapName])}return polyMesh.uvMaps},cleanSteamUVMap:function(polyMesh,scale,uv){var faces=polyMesh.faces;var uvVec1=new THREE.Vector2;var uvVec2=new THREE.Vector2;var difference,nextj;var uv1,uv2;for(var i=0,il=uv.faces.length;i<il;i++){var uvfaceIndices=uv.faces[i];for(var j=0,jl=uvfaceIndices.length;j<jl;j++){nextj=j+1;if(nextj===jl){nextj=0}uv1=uv.values[uvfaceIndices[j]];uv2=uv.values[uvfaceIndices[nextj]];var difference=Math.abs(uv1.x-uv2.x);if(difference>.25){if(uv1.x<uv2.x){uv1.x+=scale.x}else{uv2.x+=scale.x}}}}return true},cylindricalUVMap:function(vertex,cylinderAxis,wrap_width,scale,uv){var lon;var t;switch(cylinderAxis){case UVMapping.X:lon=this.xyz_to_longitude(vertex.z,vertex.x,-vertex.y);t=-vertex.x/scale.x+.5;break;case UVMapping.Y:lon=this.xyz_to_longitude(-vertex.x,vertex.y,vertex.z);t=-vertex.y/scale.y+.5;break;case UVMapping.Z:lon=this.xyz_to_longitude(-vertex.x,vertex.z,-vertex.y);t=-vertex.z/scale.z+.5;break}lon=1-lon/UVMapping.MATH_2PI;if(wrap_width!==1){lon=lon*wrap_width}uv.set(lon,t);return uv},boxUVMap:function(vertex,normal,scale,uv){var s,t;var x=vertex.x,y=vertex.y,z=vertex.z;var nx=Math.abs(normal.x),ny=Math.abs(normal.y),nz=Math.abs(normal.z);if(nx>=ny&&nx>=nz){s=z/scale.z+.5;t=y/scale.y+.5}if(ny>=nx&&ny>=nz){s=-x/scale.x+.5;t=z/scale.z+.5}if(nz>=nx&&nz>=ny){s=-x/scale.x+.5;t=y/scale.y+.5}if(normal.x>0){s=-s}if(normal.y<0){s=-s}if(normal.z>0){s=-s}uv.set(s,t);return uv},sphericalUVMap:function(vertex,sphereAxis,wrap_width,wrap_height,uv){var lonlat;var newVertex=vertex.clone();var lat,lon;switch(sphereAxis){case UVMapping.X:lonlat=this.xyz_to_longitudelatitude(newVertex.z,newVertex.x,-newVertex.y);break;case UVMapping.Y:lonlat=this.xyz_to_longitudelatitude(newVertex.x,-newVertex.y,newVertex.z);break;case UVMapping.Z:lonlat=this.xyz_to_longitudelatitude(-newVertex.x,newVertex.z,-newVertex.y);break}lon=1-lonlat.lon/UVMapping.MATH_2PI;lat=.5-lonlat.lat/Math.PI;if(wrap_width!==1){lon=lon*wrap_width}if(wrap_height!==1){lat=lat*wrap_height}uv.set(lon,lat);return uv},planarUVMap:function(vertex,planeAxis,scale,uv){var s=planeAxis===UVMapping.X?vertex.z/scale.z+.5:-vertex.x/scale.x+.5;var t=planeAxis===UVMapping.Y?vertex.z/scale.z+.5:vertex.y/scale.y+.5;var u=s;var v=t;uv.set(u,v);return uv},xyz_to_longitude:function(x,y,z){var lon;if(x===0&&z===0){lon=0}else{lon=-Math.atan2(x,z)}return lon},xyz_to_longitudelatitude:function(x,y,z){var lo,la;if(x===0&&z===0){lo=0;if(y!==0){la=y<0?-UVMapping.MATH_HALF_PI:UVMapping.MATH_HALF_PI}else{la=0}}else{lo=-Math.atan2(x,z);var h=Math.sqrt(x*x+z*z);la=Math.atan2(y,h)}return{lon:lo,lat:la}},getFraction:function(value){var x=Math.abs(value);return x>=0&&x<=1?x:x%Math.floor(x)}}}();exo.geometry.PolyMeshToGeometry=function(polyMesh){THREE.Geometry.call(this);var positions=polyMesh.positions;for(var i=0,il=positions.length;i<il;i++){this.vertices.push(positions[i])}var colorMap=polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP];var colorValues=colorMap?colorMap.values:undefined;var colorFaces=colorMap?colorMap.faces:undefined;var materialIDs=polyMesh.materialIds;var normalMap=polyMesh.normalMap;var normalValues=normalMap?normalMap.values:undefined;var normalFaces=normalMap?normalMap.faces:undefined;var uvMapKeys=Object.keys(polyMesh.uvMaps);while(this.faceVertexUvs.length<uvMapKeys.length){this.faceVertexUvs.push([])}for(var i=0,il=polyMesh.faces.length;i<il;i++){var positionIndices=polyMesh.faces[i];var faceNormal=THREE.Triangle.normal(positions[positionIndices[0]],positions[positionIndices[1]],positions[positionIndices[2]]);if(positionIndices.length===4){var face=new THREE.Face4(positionIndices[0],positionIndices[1],positionIndices[2],positionIndices[3]);face.originalIndex=i;face.normal.copy(faceNormal);if(normalFaces){var normalIndices=normalFaces[i];face.vertexNormals=[normalValues[normalIndices[0]],normalValues[normalIndices[1]],normalValues[normalIndices[2]],normalValues[normalIndices[3]]]}else{face.vertexNormals=[faceNormal,faceNormal,faceNormal,faceNormal]}if(colorFaces){var colorIndices=colorFaces[i];face.vertexColors=[colorValues[colorIndices[0]],colorValues[colorIndices[1]],colorValues[colorIndices[2]],colorValues[colorIndices[3]]]}if(materialIDs){face.materialIndex=materialIDs[i]}this.faces.push(face);for(var k=0,kl=uvMapKeys.length;k<kl;k++){var key=uvMapKeys[k];var uvFace=polyMesh.uvMaps[key].faces[i];var uvValues=polyMesh.uvMaps[key].values;this.faceVertexUvs[k].push([uvValues[uvFace[0]],uvValues[uvFace[1]],uvValues[uvFace[2]],uvValues[uvFace[3]]])}}else{for(var j=0,jl=positionIndices.length-2;j<jl;j++){var face=new THREE.Face3(positionIndices[0],positionIndices[j+1],positionIndices[j+2]);face.originalIndex=i;face.normal.copy(faceNormal);if(normalFaces){var normalIndices=normalFaces[i];face.vertexNormals=[normalValues[normalIndices[0]],normalValues[normalIndices[j+1]],normalValues[normalIndices[j+2]]]}else{face.vertexNormals=[faceNormal,faceNormal,faceNormal]}if(colorFaces){var colorIndices=colorFaces[i];face.vertexColors=[colorValues[colorIndices[0]],colorValues[colorIndices[j+1]],colorValues[colorIndices[j+2]]]}if(materialIDs){face.materialIndex=materialIDs[i]}this.faces.push(face);for(var k=0,kl=uvMapKeys.length;k<kl;k++){var key=uvMapKeys[k];var uvFace=polyMesh.uvMaps[key].faces[i];var uvValues=polyMesh.uvMaps[key].values;this.faceVertexUvs[k].push([uvValues[uvFace[0]],uvValues[uvFace[j+1]],uvValues[uvFace[j+2]]])}}}}this.computeCentroids()};exo.geometry.PolyMeshToGeometry.prototype=Object.create(THREE.Geometry.prototype);exo.geometry.PolyMeshToGeometry.prototype.clone=function(){var clone=THREE.Geometry.prototype.clone.call(this);for(var i=0;i<clone.faces.length;++i){clone.faces[i].originalIndex=this.faces[i].originalIndex}return clone};exo.geometry.convertToThreeUVs=function(uvMaps){var uvMapKeys=Object.keys(uvMaps);var faceVertexUvs=[];while(faceVertexUvs.length<uvMapKeys.length){faceVertexUvs.push([])}for(var k=0,kl=uvMapKeys.length;k<kl;k++){var key=uvMapKeys[k];var uvValues=uvMaps[key].values;for(var i=0,il=uvMaps[key].faces.length;i<il;i++){var uvFace=uvMaps[key].faces[i];if(uvFace.length===4){faceVertexUvs[k].push([uvValues[uvFace[0]],uvValues[uvFace[1]],uvValues[uvFace[2]],uvValues[uvFace[3]]])}else{for(var j=0,jl=uvFace.length-2;j<jl;j++){faceVertexUvs[k].push([uvValues[uvFace[0]],uvValues[uvFace[j+1]],uvValues[uvFace[j+2]]])}}}}return faceVertexUvs};exo.geometry.convertToThreeNormals=function(polyMesh,geometry){var normalValues=polyMesh.normalMap.values;var normalFaces=polyMesh.normalMap.faces;var positions=polyMesh.positions;var faces=polyMesh.faces;var threeFaces=geometry.faces;for(var i=0,il=threeFaces.length;i<il;i++){var face=faces[i];var threeFace=threeFaces[i];var faceNormal=THREE.Triangle.normal(positions[face[0]],positions[face[1]],positions[face[2]]);if(threeFace instanceof THREE.Face4){threeFace.normal.copy(faceNormal);if(normalFaces){var normalIndices=normalFaces[i];threeFace.vertexNormals=[normalValues[normalIndices[0]],normalValues[normalIndices[1]],normalValues[normalIndices[2]],normalValues[normalIndices[3]]]}else{threeFace.vertexNormals=[faceNormal,faceNormal,faceNormal,faceNormal]}}else{for(var j=0,jl=threeFace.length-2;j<jl;j++){threeFace.normal.copy(faceNormal);if(normalFaces){var normalIndices=normalFaces[i];face.vertexNormals=[normalValues[normalIndices[0]],normalValues[normalIndices[j+1]],normalValues[normalIndices[j+2]]]}else{face.vertexNormals=[faceNormal,faceNormal,faceNormal]}}}}};exo.geometry.convertToThreeColors=function(colorMap,threeFaces){var colorValues=colorMap?colorMap.values:undefined;var colorFaces=colorMap?colorMap.faces:undefined;for(var i=0,il=threeFaces.length;i<il;i++){var face=threeFaces[i];if(face instanceof THREE.Face4){if(colorFaces){var colorIndices=colorFaces[i];face.vertexColors=[colorValues[colorIndices[0]],colorValues[colorIndices[1]],colorValues[colorIndices[2]],colorValues[colorIndices[3]]]}}else{for(var j=0,jl=face.length-2;j<jl;j++){if(colorFaces){var colorIndices=colorFaces[i];face.vertexColors=[colorValues[colorIndices[0]],colorValues[colorIndices[j+1]],colorValues[colorIndices[j+2]]]}}}}};exo.geometry.PolyMeshToWireGeometry=function(polyMesh){console.log("DEPRECATED: use convertPolyMeshToLines() instead of PolyMeshToWireGeometry()");THREE.Geometry.call(this);var positions=polyMesh.positions;var edges=exo.geometry.ComponentUtilities.getEdges(polyMesh);for(var i=0,il=positions.length;i<il;i++){this.vertices.push(positions[i])}for(var i=0,il=edges.length;i<il;i++){var edge=edges[i];var faceNormal=THREE.Triangle.normal(positions[edge.start],positions[edge.end],positions[edge.start]);var face=new THREE.Face3(edge.start,edge.end,edge.start);face.normal.copy(faceNormal);this.faces.push(face)}this.computeCentroids()};exo.geometry.PolyMeshToWireGeometry.prototype=Object.create(THREE.Geometry.prototype);exo.geometry.SphereLatheGeometry=function(radius,widthSegments,heightSegments,phiStart,phiLength,thetaStart,thetaLength){radius=radius||50;widthSegments=Math.max(3,Math.floor(widthSegments||8));heightSegments=Math.max(2,Math.floor(heightSegments||6));phiStart=THREE.Math.clamp(phiStart||0,0,Math.PI*2);phiLength=THREE.Math.clamp(phiLength||Math.PI*2,0,Math.PI*2-phiStart);thetaStart=THREE.Math.clamp(thetaStart||0,0,Math.PI);thetaLength=THREE.Math.clamp(thetaLength||Math.PI,0,Math.PI-thetaStart);var inverseHeightSegments=1/heightSegments;var points=[];for(var i=0,il=heightSegments;i<=il;i++){var theta=thetaStart+i*inverseHeightSegments*thetaLength;var pt=new THREE.Vector3(radius*Math.sin(theta),0,-radius*Math.cos(theta));points.push(pt)}THREE.LatheGeometry.call(this,points,widthSegments,phiStart,phiLength);this.radius=radius;this.widthSegments=widthSegments;this.heightSegments=heightSegments;this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};exo.geometry.SphereLatheGeometry.prototype=Object.create(THREE.Geometry.prototype);exo.geometry.TorusLatheGeometry=function(radius,tube,radialSegments,tubularSegments,phiStart,phiLength,thetaStart,thetaLength){radius=radius||100;tube=tube||40;radialSegments=Math.max(radialSegments||8,3);tubularSegments=Math.max(tubularSegments||6,3);phiStart=THREE.Math.clamp(phiStart||0,0,Math.PI*2);phiLength=THREE.Math.clamp(phiLength||Math.PI*2,0,Math.PI*2-phiStart);thetaStart=THREE.Math.clamp(thetaStart||0,0,Math.PI*2);thetaLength=THREE.Math.clamp(thetaLength||Math.PI*2,0,Math.PI*2-thetaStart);var inverseTubularSegments=1/tubularSegments;var points=[];for(var i=0,il=tubularSegments;i<=il;i++){var theta=thetaStart+i*inverseTubularSegments*thetaLength;var pt=new THREE.Vector3(radius+tube*Math.cos(theta),0,tube*Math.sin(theta));points.push(pt)}THREE.LatheGeometry.call(this,points,radialSegments,phiStart,phiLength);this.radius=radius;this.tube=tube;this.radialSegments=radialSegments;this.tubularSegments=tubularSegments;this.phiStart=phiStart;this.phiLength=phiLength;this.thetaStart=thetaStart;this.thetaLength=thetaLength;this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius+tube)};exo.geometry.TorusLatheGeometry.prototype=Object.create(THREE.Geometry.prototype);exo.geometry.CapsuleGeometry=function(radius,height,radiusSegments,heightSegments){radiusSegments=radiusSegments||12;heightSegments=heightSegments||12;height=height||1;THREE.CylinderGeometry.call(this,radius,radius,height,radiusSegments,heightSegments,true);var upperSphere=new THREE.Mesh(new exo.geometry.SphereLatheGeometry(radius,radiusSegments,heightSegments,0,Math.PI*2,0,Math.PI/2));var lowerSphere=new THREE.Mesh(new exo.geometry.SphereLatheGeometry(radius,radiusSegments,heightSegments,0,Math.PI*2,Math.PI/2,Math.PI/2));upperSphere.rotation.set(Math.PI/2,0,Math.PI/2);lowerSphere.rotation.set(Math.PI/2,0,Math.PI/2);upperSphere.position.set(0,height/2,0);lowerSphere.position.set(0,-height/2,0);THREE.GeometryUtils.merge(this,upperSphere);THREE.GeometryUtils.merge(this,lowerSphere);this.mergeVertices();this.radius=radius;this.height=height;this.radiusSegments=radiusSegments;this.heightSegments=heightSegments};exo.geometry.CapsuleGeometry.prototype=Object.create(THREE.Geometry.prototype);!function(){exo.geometry.BoneUtils={boneCounter:0,createHumanSkeleton:function(sceneNode,options,callback,ctx){ctx=ctx||sceneNode.getCtx();var _boneLength=2;var rotLeft=new THREE.Vector3(-45,0,0);var rotRight=new THREE.Vector3(45,0,0);var rotDown=new THREE.Vector3(90,0,0);var rotUp=new THREE.Vector3(-90,0,0);var pos=new THREE.Vector3(0,0,_boneLength);var posZero=new THREE.Vector3(0,0,0);var rootBone,childBone1,childBone2,childBone3,childBone4,spinBone1,spinBone2,headBone1,handBone1,handBone2,handBone3,handBone4;var toLoad=12;var onLoaded=function(next){return function(){toLoad--;if(next)next();if(!toLoad)callback(root)}};var loadRoot=function(){exo.geometry.BoneUtils.createNodeBone(sceneNode,{boneLength:_boneLength},function(bone){rootBone=bone;ctx(rootBone.Transform).set({translation:posZero,rotation:rotDown});onLoaded(loadChild1)},ctx)};var loadChild1=function(){exo.geometry.BoneUtils.createNodeBone(rootBone,{boneLength:_boneLength},function(bone){childBone1=bone;ctx(childBone1.Transform).set({translation:pos,rotation:rotRight});onLoaded(loadChild2)},ctx)};var loadChild2=function(){exo.geometry.BoneUtils.createNodeBone(childBone1,{boneLength:_boneLength},function(bone){childBone2=bone;ctx(childBone2.Transform).set("translation",pos);onLoaded(loadChild3)},ctx)};var loadChild3=function(){exo.geometry.BoneUtils.createNodeBone(rootBone,{boneLength:_boneLength},function(bone){childBone3=bone;ctx(childBone3.Transform).set({translation:pos,rotation:rotLeft});onLoaded(loadChild4)},ctx)};var loadChild4=function(){exo.geometry.BoneUtils.createNodeBone(childBone3,{boneLength:_boneLength},function(bone){childBone4=bone;ctx(childBone4.Transform).set("translation",pos);onLoaded(loadSpinBone1)},ctx)};var loadSpinBone1=function(){_boneLength=1;pos.set(0,0,_boneLength);exo.geometry.BoneUtils.createNodeBone(rootBone,{boneLength:_boneLength},function(bone){spinBone1=bone;ctx(spinBone1.Transform).set({translation:posZero,rotation:new THREE.Vector3(180,0,0)});onLoaded(loadSpinBone2)},ctx)};var loadSpinBone2=function(){exo.geometry.BoneUtils.createNodeBone(spinBone1,{boneLength:_boneLength},function(bone){spinBone2=bone;ctx(spinBone2.Transform).set("translation",pos);pos.set(0,0,_boneLength);_boneLength=2;onLoaded(loadHeadBone)},ctx)};var loadHeadBone=function(){exo.geometry.BoneUtils.createNodeBone(spinBone2,{boneLength:_boneLength},function(bone){headBone1=bone;ctx(headBone1.Transform).set("translation",pos);onLoaded(loadHandBone1)},ctx)};var loadHandBone1=function(){exo.geometry.BoneUtils.createNodeBone(spinBone2,{boneLength:_boneLength},function(bone){handBone1=bone;ctx(handBone1.Transform).set({translation:pos,rotation:rotUp});onLoaded(loadHandBone2)},ctx)};var loadHandBone2=function(){exo.geometry.BoneUtils.createNodeBone(handBone1,{boneLength:_boneLength},function(bone){handBone2=bone;ctx(handBone2.Transform).set("translation",pos);onLoaded(loadHandBone3)},ctx)};var loadHandBone3=function(){exo.geometry.BoneUtils.createNodeBone(spinBone2,{boneLength:_boneLength},function(bone){handBone3=bone;ctx(handBone3.Transform).set({translation:pos,rotation:rotDown});onLoaded(loadHandBone4)},ctx)};var loadHandBone4=function(){exo.geometry.BoneUtils.createNodeBone(handBone3,{boneLength:_boneLength},function(bone){handBone4=bone;ctx(handBone4.Transform).set("translation",pos);onLoaded()},ctx)};loadRoot()},createNodeBone:function(parentNode,options,name,callback,ctx){ctx=ctx||parentNode.scene().getCtx();var nameBone;if(!name){nameBone="Bone-"+exo.geometry.BoneUtils}else{nameBone=name}ctx(parentNode).addNode(nameBone,"Bone",{Bone:{}}).then(function(boneNode){ctx(boneNode.plugs.Bone).addOperator("Bone",options).then(function(operator){exo.geometry.BoneUtils.boneCounter++;callback(boneNode)})})},insertBone:function(parentNode,scene,options,name,callback,ctx){if(!parentNode||parentNode.get("type")==="Objects"){exo.geometry.BoneUtils.createNodeBone(scene,options,name,callback,ctx)}else{exo.geometry.BoneUtils.createNodeBone(parentNode,options,name,callback,ctx)}}}}();exo.geometry.BoneData=function(boneUuid,poseSkinToPoseBoneTransform,poseBoneToWorldTransform,vertexIndices,vertexWeights){this.uuid=boneUuid;this.poseSkinToPoseBoneTransform=poseSkinToPoseBoneTransform;this.poseBoneToWorldTransform=poseBoneToWorldTransform;this.vertexIndices=vertexIndices;this.vertexWeights=vertexWeights};exo.geometry.BoneData.prototype={constructor:exo.geometry.BoneData};exo.geometry.BoneDataUtils={constructBoneDataFromSkeleton:function(selectedBoneNodes,poseSkinPolyMesh,poseSkinToWorldTransform){var boneDataList=[];_.each(selectedBoneNodes,function(boneNode){var poseBoneToWorldTransform=boneNode.transform.getWorldTransform();var poseSkinToPoseBoneTransform=(new THREE.Matrix4).multiplyMatrices((new THREE.Matrix4).getInverse(poseBoneToWorldTransform),poseSkinToWorldTransform);var results=exo.geometry.BoneDataUtils.getVertexWeightCapsule(poseSkinPolyMesh,poseSkinToPoseBoneTransform,boneNode);if(!results){return}var boneData=new exo.geometry.BoneData(boneNode.id,poseSkinToPoseBoneTransform,poseBoneToWorldTransform,results.vertexIndices,results.vertexWeights);boneDataList.push(boneData)});return boneDataList},constructBoneDataFromInput:function(scene,skinInfo){var boneDataList=[];var poseSkinToWorldTransform=null;_.each(skinInfo,function(boneInfo,boneUID){var boneName=boneInfo.name;var boneNode=scene.find(function(m){return m.get("type")==="Bone"&&m.get("name")===boneName&&m.fbxUID===boneUID});if(!boneNode){return}var positionBoneBind=exo.math.arrayToVector3(boneInfo.TransformLinkMatrix.position);var rotateQuatBoneBind=(new THREE.Quaternion).setFromEuler(exo.math.degreeToRadian(exo.math.arrayToVector3(boneInfo.TransformLinkMatrix.rotation)),"ZYX");var scaleBoneBind=exo.math.arrayToVector3(boneInfo.TransformLinkMatrix.scale);var poseBoneToWorldTransform=(new THREE.Matrix4).makeFromPositionQuaternionScale(positionBoneBind,rotateQuatBoneBind,scaleBoneBind);if(!poseSkinToWorldTransform){var positionMeshBind=exo.math.arrayToVector3(boneInfo.TransformMatrix.position);var rotateQuatMeshBind=(new THREE.Quaternion).setFromEuler(exo.math.degreeToRadian(exo.math.arrayToVector3(boneInfo.TransformMatrix.rotation)),"ZYX");var scaleMeshBind=exo.math.arrayToVector3(boneInfo.TransformMatrix.scale);poseSkinToWorldTransform=(new THREE.Matrix4).makeFromPositionQuaternionScale(positionMeshBind,rotateQuatMeshBind,scaleMeshBind)}var poseSkinToPoseBoneTransform=(new THREE.Matrix4).multiplyMatrices((new THREE.Matrix4).getInverse(poseBoneToWorldTransform),poseSkinToWorldTransform);var boneData=new exo.geometry.BoneData(boneNode.id,poseSkinToPoseBoneTransform,poseBoneToWorldTransform,boneInfo.indices,boneInfo.weights);boneDataList.push(boneData)});return{boneDataList:boneDataList,bindMesh:poseSkinToWorldTransform}},createFinalTransforms:function(skinToWorldTransform,scene,boneDataList){var worldToSkinTransform=(new THREE.Matrix4).getInverse(skinToWorldTransform);var finalTransforms=[];for(var i=0,il=boneDataList.length;i<il;i++){var boneData=boneDataList[i];var boneNode=scene.getNodeById(boneData.uuid);if(boneNode){var boneToWorldTransform=boneNode.transform.getWorldTransform();var boneToSkinTransform=(new THREE.Matrix4).multiplyMatrices(worldToSkinTransform,boneToWorldTransform);var finalTransform=(new THREE.Matrix4).multiplyMatrices(boneToSkinTransform,boneData.poseSkinToPoseBoneTransform);finalTransforms.push(finalTransform)}}return finalTransforms},getVertexWeightCapsule:function(skinPolyMesh,skinToPoseBoneTransform,boneNode){var distance;var positions=skinPolyMesh.positions;var operatorB=boneNode.plugs.Bone.operators.first();if(!operatorB){return null}var boneStart=boneNode.transform.getTranslation();var boneLength=operatorB.get("boneLength");var capSizeStart=operatorB.get("capSizeStart");var capSizeEnd=operatorB.get("capSizeEnd");var falloff=operatorB.get("falloff");var vertexIndiceslist=[];var vertexWeightslist=[];var inner=capSizeEnd;var outer=falloff;if(outer===0){outer=1e-5}var boneDirection=operatorB.get("boneDirection").clone();var line=new THREE.Line3(new THREE.Vector3(0,0,0),boneDirection.multiplyScalar(boneLength));for(var i=0;i<positions.length;i++){var weight=0;var positionInPoseBoneSpace=positions[i].clone().applyMatrix4(skinToPoseBoneTransform);var lv=line.closestPointToPoint(positionInPoseBoneSpace,true);distance=lv.distanceTo(positionInPoseBoneSpace);var lv2=line.closestPointToPoint(positionInPoseBoneSpace,false);if(lv.equals(lv2)){weight=1}else{if(distance<=outer){weight=1-distance/outer}else{weight=0}}if(weight!==0){vertexWeightslist.push(weight);vertexIndiceslist.push(i)}}return{vertexWeights:vertexWeightslist,vertexIndices:vertexIndiceslist}},normalizeWeights:function(boneDataList,numVertices){var totalVertexWeights=[];for(var i=0;i<numVertices;i++){totalVertexWeights[i]=0}for(var i=0,il=boneDataList.length;i<il;i++){var boneData=boneDataList[i];for(var k=0,kl=boneData.vertexWeights.length;k<kl;k++){var vi=boneData.vertexIndices[k];var vw=boneData.vertexWeights[k];totalVertexWeights[vi]+=vw}}for(var i=0,il=boneDataList.length;i<il;i++){var boneData=boneDataList[i];for(var k=0,kl=boneData.vertexWeights.length;k<kl;k++){var vi=boneData.vertexIndices[k];if(totalVertexWeights[vi]!==0){boneData.vertexWeights[k]/=totalVertexWeights[vi]}}}},setColorBasedOnWeights:function(polyMesh,selectedBoneData){var vertexColors,colorLength=0;var vertexIndices;var vertexWeights;if(selectedBoneData){vertexIndices=selectedBoneData.vertexIndices;vertexWeights=selectedBoneData.vertexWeights}else{return}if(!polyMesh.colorMaps||polyMesh.colorMaps&&!polyMesh.colorMaps.values){var colors=[];colorLength=polyMesh.positions.length;colors.length=colorLength;polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(polyMesh.faces),colors)}var vertexColorsIndices=polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP].faces;vertexColors=polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP].values;colorLength=vertexColors.length;for(var i=0,il=colorLength;i<il;i++){vertexColors[i]=(new THREE.Color).setRGB(1,0,0)}for(var i=0,il=vertexIndices.length;i<il;i++){vertexColors[vertexIndices[i]].setRGB(vertexWeights[i],vertexWeights[i],vertexWeights[i])}}};exo.geometry.SkinInformation=function(boneData){this.boneData=boneData};exo.geometry.SkinInformation.prototype={constructor:exo.geometry.SkinInformation,deform:function(finalTransforms,positions){var deformedPositions=[];var untouchedVertices=[];if(!positions||!positions.length){return deformedPositions}for(var i=0,iLen=positions.length;i<iLen;i++){deformedPositions[i]=new THREE.Vector3;untouchedVertices[i]=true}var v1=new THREE.Vector3;var deformedPos;if(positions.length!==0){_.each(this.boneData,function(boneData,index){var indices=boneData.vertexIndices;var weights=boneData.vertexWeights;var finalTransform=finalTransforms[index];for(var i=0,il=indices.length;i<il;++i){var positionIndex=indices[i];v1.copy(positions[positionIndex]);v1.applyMatrix4(finalTransform);v1.multiplyScalar(weights[i]);untouchedVertices[positionIndex]=false;deformedPos=deformedPositions[positionIndex];deformedPos.addVectors(deformedPos,v1)}});for(var i=0,iLen=positions.length;i<iLen;i++){if(untouchedVertices[i]){deformedPositions[i]=positions[i]}}}return deformedPositions}};exo.operators.Mesh={name:"Mesh",target:"PolyMesh",category:"Creation",schema:{geometry:{type:"JSON",hidden:true}},create:function(operator,polyMesh){var geometry=operator.get("geometry");if(!geometry)return polyMesh;if(operator.dirty){var json=geometry.fetchContentSync(function(){operator.triggerDirty()});if(!json)return polyMesh;if(typeof json==="string"){json=JSON.parse(json)}operator.polyMesh=exo.geometry.PolyMesh.fromJSON(json)}if(operator.polyMesh){polyMesh=operator.polyMesh.clone()}return polyMesh}};exo.operators.Box={name:"Box",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{depth:{type:"Number",label:"Depth",defaultValue:1,minValue:.1,animatable:true},width:{type:"Number",label:"Width",defaultValue:1,minValue:.1,animatable:true},height:{type:"Number",label:"Height",defaultValue:1,minValue:.1,animatable:true},depthSegments:{type:"Number",label:"Depth Segments",defaultValue:1,minValue:1,isInteger:true,animatable:true,i18n:{en:{},xn:{label:"XXX"},hn:{label:"DX"}}},widthSegments:{type:"Number",label:"Width Segments",defaultValue:1,minValue:1,isInteger:true,animatable:true},heightSegments:{type:"Number",label:"Height Segments",defaultValue:1,minValue:1,isInteger:true,animatable:true}},create:function(operator){var width=operator.get("width");var height=operator.get("height");var depth=operator.get("depth");var widthSegments=Math.floor(operator.get("widthSegments"));var heightSegments=Math.floor(operator.get("heightSegments"));var depthSegments=Math.floor(operator.get("depthSegments"));var geometry=new THREE.CubeGeometry(width,height,depth,widthSegments,heightSegments,depthSegments);var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);
return polyMesh}};exo.operators.Sphere={name:"Sphere",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Radius",type:"Number",defaultValue:.5,minValue:.1,step:.1,animatable:true},widthSegments:{label:"Longitudinal Segments",type:"Integer",defaultValue:24,minValue:3,maxValue:200,step:1,animatable:true},heightSegments:{label:"Latitudinal Segments",type:"Integer",defaultValue:24,minValue:3,maxValue:200,step:1,animatable:true},phiStart:{label:"Phi Start",type:"Number",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},phiLength:{label:"Phi Length",type:"Number",defaultValue:360,minValue:0,maxValue:360,step:10,animatable:true},thetaStart:{label:"Theta Start",type:"Number",defaultValue:0,minValue:0,maxValue:180,step:10,animatable:true},thetaLength:{label:"Theta Length",type:"Number",defaultValue:180,minValue:0,maxValue:180,step:10,animatable:true}},create:function(operator){var radius=operator.get("radius");var widthSegments=operator.get("widthSegments");var heightSegments=operator.get("heightSegments");var phiStart=operator.get("phiStart");var phiLength=operator.get("phiLength");var thetaStart=operator.get("thetaStart");var thetaLength=operator.get("thetaLength");var geometry=new exo.geometry.SphereLatheGeometry(radius,widthSegments,heightSegments,THREE.Math.degToRad(phiStart),THREE.Math.degToRad(phiLength),THREE.Math.degToRad(thetaStart),THREE.Math.degToRad(thetaLength));geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.areaWeightedNormalMap(polyMesh.faces,polyMesh.positions);var matrix=(new THREE.Matrix4).makeRotationX(Math.PI/2);polyMesh.applyMatrix4(matrix);return polyMesh}};exo.operators.Cone={name:"Cone",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{base:{type:"Number",label:"Base Radius",defaultValue:.5,minValue:.1,animatable:true},height:{type:"Number",label:"Height",defaultValue:1,minValue:.1,animatable:true},radiusSegments:{label:"Radial Segments",type:"Integer",defaultValue:12,minValue:3,maxValue:200,animatable:true},heightSegments:{label:"Height Segments",type:"Integer",defaultValue:1,minValue:1,maxValue:200,animatable:true},openEnded:{label:"Open Base",type:"Boolean",defaultValue:false,animatable:true}},create:function(operator){var radiusTop=0;var radiusBottom=operator.get("base");var height=operator.get("height");var radiusSegments=operator.get("radiusSegments");var heightSegments=operator.get("heightSegments");var openEnded=operator.get("openEnded");var geometry=new THREE.CylinderGeometry(radiusTop,radiusBottom,height,radiusSegments,heightSegments,openEnded);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Cylinder={name:"Cylinder",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radiusTop:{type:"Number",label:"Top Radius",defaultValue:.5,minValue:.1,step:.1,animatable:true},radiusBottom:{type:"Number",label:"Bottom Radius",defaultValue:.5,minValue:.1,step:.1,animatable:true},height:{type:"Number",label:"Height",defaultValue:1,minValue:.1,step:.1,animatable:true},radiusSegments:{label:"Radial Segments",type:"Integer",defaultValue:24,minValue:3,maxValue:200,animatable:true},heightSegments:{label:"Height Segments",type:"Integer",defaultValue:1,minValue:1,maxValue:200,animatable:true},openEnded:{label:"Open Ended",type:"Boolean",defaultValue:false,animatable:true}},create:function(operator){var radiusTop=operator.get("radiusTop");var radiusBottom=operator.get("radiusBottom");var height=operator.get("height");var radiusSegments=operator.get("radiusSegments");var heightSegments=operator.get("heightSegments");var openEnded=operator.get("openEnded");var geometry=new THREE.CylinderGeometry(radiusTop,radiusBottom,height,radiusSegments,heightSegments,openEnded);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Plane={name:"Plane",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{width:{label:"Width",type:"Number",defaultValue:4,minValue:.01,step:1,animatable:true},height:{label:"Height",type:"Number",defaultValue:4,minValue:.01,step:1,animatable:true},widthSegments:{type:"Number",label:"Width Segments",defaultValue:1,minValue:1,isInteger:true,animatable:true},heightSegments:{type:"Number",label:"Height Segments",defaultValue:1,minValue:1,isInteger:true,animatable:true}},create:function(operator){var width=operator.get("width");var height=operator.get("height");var widthSegments=Math.floor(operator.get("widthSegments"));var heightSegments=Math.floor(operator.get("heightSegments"));var geometry=new THREE.PlaneGeometry(width,height,widthSegments,heightSegments);geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);return polyMesh}};exo.operators.Torus={name:"Torus",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Radius",type:"Number",defaultValue:.3,minValue:.1,step:.1,animatable:true},tube:{label:"Tube Radius",type:"Number",defaultValue:.2,minValue:.1,step:.1,animatable:true},radialSegments:{label:"Longitudinal Segments",type:"Integer",defaultValue:24,minValue:3,step:1,animatable:true},tubularSegments:{label:"Latitudinal Segments",type:"Integer",defaultValue:24,minValue:3,step:1,animatable:true},phiStart:{label:"Phi Start",type:"Number",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},phiLength:{label:"Phi Length",type:"Number",defaultValue:360,minValue:0,maxValue:360,step:10,animatable:true},thetaStart:{label:"Theta Start",type:"Number",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},thetaLength:{label:"Theta Length",type:"Number",defaultValue:360,minValue:0,maxValue:360,step:10,animatable:true}},create:function(operator){var radius=operator.get("radius");var tube=operator.get("tube");var radialSegments=operator.get("radialSegments");var tubularSegments=operator.get("tubularSegments");var phiStart=operator.get("phiStart");var phiLength=operator.get("phiLength");var thetaStart=operator.get("thetaStart");var thetaLength=operator.get("thetaLength");var geometry=new exo.geometry.TorusLatheGeometry(radius,tube,radialSegments,tubularSegments,THREE.Math.degToRad(phiStart),THREE.Math.degToRad(phiLength),THREE.Math.degToRad(thetaStart),THREE.Math.degToRad(thetaLength));geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.areaWeightedNormalMap(polyMesh.faces,polyMesh.positions);var matrix=(new THREE.Matrix4).makeRotationX(Math.PI/2);polyMesh.applyMatrix4(matrix);return polyMesh}};exo.operators.TorusKnot={name:"TorusKnot",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Inner Radius",type:"Number",defaultValue:.35,minValue:.01,animatable:true},tube:{label:"Outer Radius",type:"Number",defaultValue:.15,minValue:.01,animatable:true},radialSegments:{label:"Longitudinal Segments",type:"Integer",defaultValue:40,minValue:3,maxValue:200,animatable:true},tubularSegments:{label:"Latitudinal Segments",type:"Integer",defaultValue:12,minValue:2,maxValue:200,animatable:true},p:{type:"Number",label:"P",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},q:{type:"Number",label:"Q",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},heightScale:{type:"Number",label:"Height Scale",defaultValue:0,minValue:0,animatable:true}},create:function(operator){var radius=operator.get("radius");var tube=operator.get("tube");var radialSegments=operator.get("radialSegments");var tubularSegments=operator.get("tubularSegments");var p=operator.get("p");var q=operator.get("q");var heightScale=operator.get("heightScale");var geometry=new THREE.TorusKnotGeometry(radius,tube,radialSegments,tubularSegments,THREE.Math.degToRad(p),THREE.Math.degToRad(q),heightScale);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.areaWeightedNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Text={name:"Text",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{text:{label:"Text",type:"Text",defaultValue:"text",animatable:true},font:{label:"Font Family",type:"Text",type:"Options",display:"Dropdown",values:["helvetiker"],labels:["Helvetiker"],defaultValue:"helvetiker",animatable:true},size:{label:"Font Size",type:"Number",defaultValue:1,minValue:.1,step:.1,animatable:true},bold:{label:"Bold",type:"Boolean",defaultValue:false,animatable:true},italic:{label:"Italic",type:"Boolean",defaultValue:false,animatable:true},depth:{label:"Extrude Depth",type:"Number",defaultValue:.1,minValue:.01,maxValue:100,step:.1,animatable:true},curveSegments:{label:"Curve Segments",type:"Number",defaultValue:2,minValue:1,maxValue:100,animatable:true},bevelEnabled:{label:"Bevel",type:"Boolean",defaultValue:false,animatable:true},bevelThickness:{label:"Bevel Thickness",type:"Number",defaultValue:.05,minValue:.01,step:.1,animatable:true},bevelSize:{label:"Bevel Size",type:"Number",defaultValue:.05,minValue:.01,step:.1,animatable:true},bevelSegments:{label:"Bevel Segments",type:"Integer",defaultValue:1,minValue:1,step:1,maxValue:10,animatable:true}},create:function(operator){var text=operator.get("text");var bold=operator.get("bold");var italic=operator.get("italic");var parameters={};parameters.size=operator.get("size");parameters.font=operator.get("font");parameters.height=operator.get("depth");parameters.curveSegments=operator.get("curveSegments");parameters.weight=bold?"bold":"normal";parameters.bevelEnabled=operator.get("bevelEnabled");parameters.bevelThickness=operator.get("bevelThickness");parameters.bevelSize=operator.get("bevelSize");parameters.bevelSegments=operator.get("bevelSegments");var polyMesh=null;try{var geometry=new THREE.TextGeometry(text,parameters);polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry)}catch(e){log.error("Can not create Text Geometry using Font: "+parameters.font+", "+parameters.weight);polyMesh=new exo.geometry.PolyMesh}polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Tetrahedron={name:"Tetrahedron",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Radius",type:"Number",defaultValue:.5,minValue:.01,step:.1,animatable:true},detail:{label:"Detail Level",type:"Integer",defaultValue:0,minValue:0,maxValue:3,animatable:true}},create:function(operator){var radius=operator.get("radius");var detail=operator.get("detail");var geometry=new THREE.TetrahedronGeometry(radius,detail);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Octahedron={name:"Octahedron",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Radius",type:"Number",defaultValue:.5,minValue:.01,step:.1,animatable:true},detail:{label:"Detail Level",type:"Integer",defaultValue:0,minValue:0,maxValue:3,animatable:true}},create:function(operator){var radius=operator.get("radius");var detail=operator.get("detail");var geometry=new THREE.OctahedronGeometry(radius,detail);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Icosahedron={name:"Icosahedron",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{label:"Radius",type:"Number",defaultValue:.5,minValue:.01,step:.1,animatable:true},detail:{label:"Detail Level",type:"Integer",defaultValue:0,minValue:0,maxValue:3,step:1,animatable:true}},create:function(operator){var radius=operator.get("radius");var detail=operator.get("detail");var geometry=new THREE.IcosahedronGeometry(radius,detail);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh}};exo.operators.Circle={name:"Circle",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{type:"Number",label:"Radius",defaultValue:.5,minValue:.01,step:.1,animatable:true},segments:{type:"Integer",label:"Segments",defaultValue:12,minValue:3,maxValue:200,animatable:true},thetaStart:{label:"Theta Start",type:"Number",defaultValue:0,minValue:0,maxValue:360,step:10,animatable:true},thetaLength:{label:"Theta Length",type:"Number",defaultValue:360,minValue:0,maxValue:360,step:10,animatable:true}},create:function(operator){var radius=operator.get("radius");var segments=operator.get("segments");var thetaStart=operator.get("thetaStart");var thetaLength=operator.get("thetaLength");var geometry=new THREE.CircleGeometry(radius,segments,THREE.Math.degToRad(thetaStart),THREE.Math.degToRad(thetaLength));return exo.geometry.GeometryToPolyMesh.convert(geometry)}};exo.operators.Capsule={name:"Capsule",target:"PolyMesh",provideDefaultUVs:true,category:"Creation",schema:{radius:{type:"Number",label:"Radius",defaultValue:.5,minValue:.1,step:.1},height:{type:"Number",label:"Height",defaultValue:1,minValue:.1,step:.1},radiusSegments:{label:"Radial Segments",type:"Integer",defaultValue:12,minValue:4,maxValue:100},heightSegments:{label:"Height Segments",type:"Integer",defaultValue:10,minValue:1,maxValue:100}},create:function(operator){var radius=operator.get("radius");var height=operator.get("height");var radiusSegments=operator.get("radiusSegments");var heightSegments=operator.get("heightSegments");var geometry=new exo.geometry.CapsuleGeometry(radius,height,radiusSegments,heightSegments);geometry.mergeVertices();var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);return polyMesh}};!function(){var axisTypes={x:new THREE.Vector3(1,0,0),y:new THREE.Vector3(0,1,0),z:new THREE.Vector3(0,0,1)};exo.operators.Twist={name:"Twist",schema:{angle:{label:"Angle",type:"Number",defaultValue:60,step:10,minValue:-3600,maxValue:3600,animatable:true},twistAxis:{label:"Axis",type:"Options",defaultValue:"y",values:["x","y","z"]},center:{label:"Center",type:"Vec3",defaultValue:new THREE.Vector3(0,0,0),animatable:true}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"axisX",getOptions:function(){return{twistAxis:"x",angle:10}}},{name:"axisY",getOptions:function(){return{twistAxis:"y",angle:20}}},{name:"axisZ",getOptions:function(){return{twistAxis:"z",angle:30}}}],changed:function(result){result.changed.positions=true},modify:function(operator,polyMesh){var angle=operator.get("angle");if(angle){angle=THREE.Math.degToRad(angle);var twistAxis=axisTypes[operator.get("twistAxis")];var center=operator.get("center");var positions=polyMesh.positions;var boundingBox=(new THREE.Box3).setFromPoints(positions);var dv=boundingBox.size().multiplyScalar(.5).length();var d=-twistAxis.dot(center);var dd,i,length;for(i=0,length=positions.length;i<length;++i){var position=positions[i];var newAngle=(position.dot(twistAxis)+d)/dv*angle;this.twistPoint(newAngle,twistAxis,position)}}return polyMesh},twistPoint:function(angle,twistAxis,position){var sAng=Math.sin(angle);var cAng=Math.cos(angle);var ncAng=1-cAng;var x=twistAxis.x,y=twistAxis.y,z=twistAxis.z;var posX=position.x,posY=position.y,posZ=position.z;var xy=x*y*ncAng,yz=y*z*ncAng,zx=z*x*ncAng;var xsAng=x*sAng,ysAng=y*sAng,zsAng=z*sAng;position.x=posX*(cAng+x*x*ncAng)+posY*(xy-zsAng)+posZ*(zx+ysAng);position.y=posX*(xy+zsAng)+posY*(cAng+y*y*ncAng)+posZ*(yz-xsAng);position.z=posX*(zx-ysAng)+posY*(yz+xsAng)+posZ*(cAng+z*z*ncAng)},manipulations:{Center:{gizmo:"Move",manipulate:function(operator,deltaVector,subSelection){var center=operator.get("center");operator.ctx().set("center",deltaVector.add(center))},getCentroid:function(operator){return operator.get("center")}}}}}();exo.operators.AutoScale={name:"AutoScale",targets:["PolyMesh"],hidden:true,schema:{center:{type:"Boolean",defaultValue:true,animatable:true},scale:{type:"Boolean",defaultValue:true,animatable:true},factor:{type:"Number",defaultValue:5,minValue:.001,animatable:true}},category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}},{name:"variation",getOptions:function(){return{center:false,scale:false,factor:1}}}],changed:function(result){result.changed.positions=true},modify:function(operator,polyMesh){var positions=polyMesh.positions;var boundingBox=(new THREE.Box3).setFromPoints(positions);var middle=boundingBox.center();var size=boundingBox.size();var maxDimension=Math.max(size.x,Math.max(size.y,size.z));var center=operator.get("center");var scale=operator.get("scale");var factor=operator.get("factor");if(maxDimension){var scaleFactor=1/maxDimension*factor;var temp=new THREE.Vector3;_.each(positions,function(position,index){if(center){position.sub(middle)}if(scale){position.multiplyScalar(scaleFactor)}})}return polyMesh}};exo.operators.Collapse={name:"Collapse",targets:["PolyMesh"],noButton:true,schema:{polyMesh:{type:"Object",hidden:true}},category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{polyMesh:exo.geometry.PolyMeshUtilitie.createPlane(1,1)}}}],modify:function(operator,polyMesh){console.log("DEPRECATED: use Mesh operator or call collapseMesh() function");var newPolyMesh=operator.get("polyMesh");if(newPolyMesh){if(newPolyMesh.clone&&newPolyMesh instanceof exo.geometry.PolyMesh){polyMesh=newPolyMesh.clone()}else{polyMesh=exo.geometry.PolyMesh.fromJSON(newPolyMesh)}}return polyMesh}};exo.operators.Noise={name:"Noise",schema:{force:{type:"Number",defaultValue:0,animatable:true},seed:{type:"Number",defaultValue:0,animatable:true}},targets:["PolyMesh"],category:"Model",changed:function(result){result.changed.positions=true},modify:function(operator,polyMesh){var force=operator.get("force");if(force){var positions=polyMesh.positions;var randomizer=new Alea(operator.get("seed"));_.each(positions,function(position,index){position.set(position.x+randomizer()*force-force/2,position.y+randomizer()*force-force/2,position.z+randomizer()*force-force/2)})}return polyMesh}};!function(){var xzPlane=new THREE.Vector3(1,0,1);var yAxis=new THREE.Vector3(0,1,0);var one=new THREE.Vector3(1,1,1);exo.operators.Taper={name:"Taper",schema:{amount:{type:"Number",defaultValue:1,step:.1,animatable:true},curve:{type:"Number",defaultValue:1,step:.1,minValue:.1,animatable:true}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}},{name:"level1",getOptions:function(){return{amount:1}}}],changed:function(result){result.changed.positions=true},modify:function(operator,polyMesh){var amount=operator.get("amount");var curve=operator.get("curve");if(curve){curve=1/curve}var positions=polyMesh.positions;_.each(positions,function(position,index){var ar=position.clone().multiply(yAxis);var sc=amount*Math.pow(ar.length(),curve);var temp=new THREE.Vector3(xzPlane.x,xzPlane.y,xzPlane.z).multiplyScalar(sc).add(one);position.multiply(temp)});return polyMesh}}}();exo.operators.Normals={name:"Normals",schema:{normalTypes:{label:"normal type",type:"Options",display:"Dropdown",values:["Default","Flat","Average"],defaultValue:"Default"},flipfaces:{label:"flip faces",type:"Boolean",defaultValue:false}},targets:["PolyMesh"],NormalTypes:{Default:-1,Average:0,Flat:1},category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}},{name:"flat",getOptions:function(){return{Options:"Flat"}}},{name:"averaged",getOptions:function(){return{Options:"Average"}}},{name:"flipped",getOptions:function(){return{flipfaces:true}}}],changed:function(result){result.changed.normals=true},modify:function(operator,polyMesh){var normalTypes=this.NormalTypes[operator.get("normalTypes")];var flipfaces=operator.get("flipfaces");if(flipfaces){polyMesh.flipFaces()}if(normalTypes===this.NormalTypes.Flat){polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions)}else if(normalTypes===this.NormalTypes.Average){polyMesh.normalMap=exo.geometry.PolyMeshUtilities.areaWeightedNormalMap(polyMesh.faces,polyMesh.positions)}else if(normalTypes===this.NormalTypes.Default){}return polyMesh}};exo.operators.MeshSmooth={name:"MeshSmooth",shouldCache:true,schema:{subdivisions:{type:"Number",defaultValue:1,minValue:0,maxValue:4}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}},{name:"level1",getOptions:function(){return{subdivisions:1}}}],modify:function(operator,polyMesh){var subdivisions=operator.get("subdivisions");if(subdivisions){var threeGeometry=new exo.geometry.PolyMeshToGeometry(polyMesh);var modifier=new exo.geometry.SubdivisionModifier(subdivisions);modifier.modify(threeGeometry);polyMesh=exo.geometry.GeometryToPolyMesh.convert(threeGeometry)}return polyMesh}};exo.operators.Slice={name:"Slice",type:"Edit",schema:{center:{label:"Center",type:"Vec3",defaultValue:new THREE.Vector3(0,0,0),step:.01,animatable:true},normal:{label:"Normal",type:"Vec3",defaultValue:new THREE.Vector3(1,0,0),minValue:-1,maxValue:1,step:.1,animatable:true},cut:{label:"Cut",type:"Boolean",defaultValue:false},flip:{label:"Flip",type:"Boolean",defaultValue:false},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"sliceNoCut",getOptions:function(){return{cut:false}}},{name:"sliceCut",getOptions:function(){return{cut:true}}},{name:"sliceFace",getOptions:function(){return{cut:false,indices:"0"}}},{name:"sliceFaceFlip",getOptions:function(){return{cut:false,flip:true,indices:"0"}}}],modify:function(operator,polyMesh){var normal=operator.get("normal").clone().normalize();var center=operator.get("center");var cut=operator.get("cut");var flip=operator.get("flip");var faceIndices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getFacesCount()-1);if(flip){normal.negate()}var plane=(new THREE.Plane).setFromNormalAndCoplanarPoint(normal,center);polyMesh.sliceFaces(plane,faceIndices.length?faceIndices:null,cut);return polyMesh},selectedManipulator:"Normal",manipulations:{Center:{gizmo:"Move",manipulate:function(operator,deltaVector,subSelection){var center=operator.get("center");operator.ctx().set("center",deltaVector.add(center))},getCentroid:function(operator){return operator.get("center")}},Normal:{gizmo:"Move",customGizmo:{parts:{plane:{primitive:{type:"plane",material:{opacity:.5,color:[1,1,0]},bordered:true}}},defaultScale:.5,adjustWithCamera:false,update:function(operator,displayNode){var normal=operator.get("normal").clone().normalize();var center=operator.get("center");this.created.plane.lookAt(normal)}},manipulate:function(operator,deltaVector,subSelection,moveInfo,handleInfo){var normal=operator.get("normal");operator.ctx().set("normal",deltaVector.add(normal))},getCentroid:function(operator){return operator.get("center")}}}};exo.operators.ExplodeFaces={name:"ExplodeFaces",shouldCache:true,schema:{text:{label:"explode",type:"Text",defaultValue:"Explode Modifier"}},targets:["PolyMesh"],category:"Model",modify:function(operator,polyMesh){if(polyMesh.faces){polyMesh.explodeFaces()}return polyMesh}};exo.operators.UVMap={name:"UVMap",schema:{center:{type:"Vec3",step:.1,defaultValue:new THREE.Vector3(0,0,0),animatable:true},rotation:{type:"Vec3",step:1,minValue:-360,maxValue:360,defaultValue:new THREE.Vector3(0,0,0),animatable:true},scale:{type:"Vec3",minValue:.01,step:.1,defaultValue:new THREE.Vector3(1,1,1),animatable:true},uvProjectionMode:{label:"Projection",type:"Options",display:"Dropdown",values:["PLANAR","BOX","CYLINDRICAL","SPHERICAL"],labels:["Planar","Box","Cylindrical","Spherical"],defaultValue:"PLANAR"},xAxis:{label:"XYZ-Align",type:"Options",display:"Dropdown",values:["X","Y","Z"],defaultValue:"Y"},uvMapChannel:{label:"channel",type:"Text",defaultValue:exo.geometry.PolyMesh.DEFAULT_MAP}},targets:["PolyMesh"],category:"Render",testConfigurations:[{name:"planar",getOptions:function(){return{uvProjectionMode:"PLANAR",xAxis:"X"}}},{name:"box",getOptions:function(){return{uvProjectionMode:"BOX",xAxis:"Y"}}},{name:"cylindrical",getOptions:function(){return{uvProjectionMode:"CYLINDRICAL",xAxis:"Z"}}},{name:"spherical",getOptions:function(){return{uvProjectionMode:"SPHERICAL",xAxis:"X"}}}],changed:function(result){result.changed.uvs=true},modify:function(operator,polyMesh){var options={};options.center=operator.get("center");options.scale=operator.get("scale");options.rotation=operator.get("rotation");options.cap=operator.get("capCylinder");options.uvAxis=exo.geometry.UVMapping[operator.get("xAxis")];options.uvMode=exo.geometry.UVMapping[operator.get("uvProjectionMode")];options.mapChannel=operator.get("uvMapChannel");exo.geometry.PolyMeshUVUtilities.applyUVMap(polyMesh,options);return polyMesh}};exo.operators.UniformVertexColors={name:"UniformVertexColors",schema:{color:{type:"Color",defaultValue:"#777777",animatable:true},channel:{type:"Text",defaultValue:exo.geometry.PolyMesh.DEFAULT_MAP}},targets:["PolyMesh"],category:"Render",changed:function(result){result.changed.colors=true},modify:function(operator,polyMesh){var color=operator.get("color");var channel=operator.get("channel");var map=polyMesh.colorMaps[channel];if(map&&polyMesh.positions.length===map.values.length){var colors=map.values;var numVerts=colors.length;for(var i=0;i<numVerts;++i){colors[i].copy(color.clone())}}else{var colors=[];var map=polyMesh.colorMaps[channel]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(polyMesh.faces),colors);var numVerts=polyMesh.positions.length;colors.length=numVerts;for(var i=0;i<numVerts;++i){colors[i]=color.clone()}}return polyMesh}};!function(){var __tm=new THREE.Matrix3;var __tv=new THREE.Vector3;exo.operators.UVVertexColors={name:"UVVertexColors",schema:{mapping:{type:"Text",defaultValue:"UV0"},uvChannel:{label:"uv channel",type:"Text",defaultValue:exo.geometry.PolyMesh.DEFAULT_MAP},colorChannel:{label:"color channel",type:"Text",defaultValue:exo.geometry.PolyMesh.DEFAULT_MAP}},targets:["PolyMesh"],category:"Render",changed:function(result){result.changed.colors=true},modify:function(operator,polyMesh){var mapping=operator.get("mapping").toLowerCase();var uvChannel=operator.get("uvChannel");var colorChannel=operator.get("colorChannel");var uvMap=polyMesh.uvMaps[uvChannel];var colorMap=polyMesh.colorMaps[colorChannel];if(!uvMap){console.log("could not find uv channel "+uvChannel+"on mesh, skipping color application...");return polyMesh}if(mapping.replace("u","").replace("v","").replace("0","").length!==0){console.log("invalid mapping "+mapping+", skipping color application...");return polyMesh}var m0=mapping[0],m1=mapping[1],m2=mapping[2];var u=function(m){return m==="u"?1:0};var v=function(m){return m==="v"?1:0};var off=function(m){return m==="0"?1:0};__tm.set(u(m0),v(m0),off(m0),u(m1),v(m1),off(m1),u(m2),v(m2),off(m2));if(colorMap&&colorMap.values.length===uvMap.values.length){var colors=colorMap.values;var uvs=uvMap.values;var numVerts=colors.length;for(var i=0;i<numVerts;++i){var uv=uvs[i];__tv.set(uv.x,uv.y,0);__tv.applyMatrix3(__tm);colors[i].setRGB(__tv.x,__tv.y,__tv.z)}}else{var colors=[];var colorMap=polyMesh.colorMaps[colorChannel]=new exo.geometry.PolyMap(exo.geometry.CloneUtilities.copyIntRaggedArray(uvMap.faces),colors);var uvs=uvMap.values;var numVerts=uvMap.values.length;colors.length=numVerts;for(var i=0;i<numVerts;++i){var uv=uvs[i];__tv.set(uv.x,uv.y,0);__tv.applyMatrix3(__tm);colors[i]=(new THREE.Color).setRGB(__tv.x,__tv.y,__tv.z)}}return polyMesh}}}();!function(){exo.operators.MeshLight={name:"Light",schema:{intensity:{type:"Number",defaultValue:1,step:.1,minValue:.1,maxValue:5,animatable:true},distance:{type:"Integer",defaultValue:1e3,minValue:0,animatable:true},falloffExponent:{label:"falloff exponent",type:"Number",defaultValue:2,minValue:0,maxValue:3,step:1}},targets:["PolyMesh"],category:"Render",modify:function(operator,polyMesh){var light={};light.intensity=operator.get("intensity");light.distance=operator.get("distance");light.falloffExponent=operator.get("falloffExponent");polyMesh.light=light;return polyMesh}}}();!function(){var targetFilter=function(n){return n.get("type")==="PolyMesh"};exo.operators.Reference={name:"Reference",schema:{target:{type:"Node",label:"Target",filter:targetFilter}},targets:["PolyMesh"],category:"Model",modify:function(operator,polyMesh){var target=operator.get("target"),source;if(target&&target.polyMesh){source=target.polyMesh;polyMesh=new exo.geometry.PolyMesh(source.faces,source.positions);if(source.normalMap){polyMesh.normalMap=source.normalMap.clone()}if(source.uvMaps.default){polyMesh.uvMap=new exo.geometry.PolyMap(source.uvMaps.default.faces,source.uvMaps.default.values)}if(source.velocities){polyMesh.velocities=source.velocities.slice(0)}if(source.materialIds){polyMesh.materialIds=source.materialIds.slice(0)}}return polyMesh}}}();!function(){exo.operators.Skin={name:"Skin",schema:{displayBoneIndex:{type:"Integer",defaultValue:-1,minValue:-1},updateWeights:{type:"Button",label:"Update Weights"},boneDataList:{type:"Object",hidden:true},poseSkinToWorldTransform:{type:"Object",hidden:true},boneNodeList:{type:"NodeList",label:"Select Bones"}},targets:["PolyMesh"],category:"Model",changed:function(result){result.changed.positions=true;result.changed.colors=true},updateWeights:function(operator,polyMesh){polyMesh=polyMesh||operator.node().polyMesh;var boneDataList=null;var boneNodeList=operator.get("boneNodeList");if(boneNodeList.length){boneDataList=exo.geometry.BoneDataUtils.constructBoneDataFromSkeleton(boneNodeList,polyMesh,poseSkinToWorldTransform);exo.geometry.BoneDataUtils.normalizeWeights(boneDataList,polyMesh.positions.length)}if(!boneDataList||boneDataList.length<1){return}operator.ctx().set("boneDataList",boneDataList);var poseSkinToWorldTransform=operator.node().transform.getWorldTransform();operator.ctx().set("poseSkinToWorldTransform",poseSkinToWorldTransform)},modify:function(operator,polyMesh){exo.profiling.start("skin");var boneDataList=operator.get("boneDataList");var poseSkinToWorldTransform=operator.get("poseSkinToWorldTransform");if(!polyMesh.positions||!boneDataList||!poseSkinToWorldTransform){return polyMesh}var displayBoneIndex=operator.get("displayBoneIndex");var scene=operator.scene();if(displayBoneIndex>=0&&boneDataList&&displayBoneIndex<boneDataList.length){exo.geometry.BoneDataUtils.setColorBasedOnWeights(polyMesh,boneDataList[displayBoneIndex])}var skinInfo=new exo.geometry.SkinInformation(boneDataList);var finalBoneMatrices=exo.geometry.BoneDataUtils.createFinalTransforms(poseSkinToWorldTransform,operator.scene(),boneDataList);if(finalBoneMatrices.length){polyMesh.positions=skinInfo.deform(finalBoneMatrices,polyMesh.positions)}exo.profiling.stop("skin");return polyMesh}}}();!function(){var TransformUtils=exo.geometry.TransformUtilities;var TransCenter=TransformUtils.TransformCenterType;exo.operators.TransformVertices={name:"TransformVertices",targets:["PolyMesh"],schema:{translation:{label:"Translation",type:"Vec3",step:.1,defaultValue:[0,0,0],animatable:true},rotation:{label:"Rotation",type:"Vec3",step:1,defaultValue:[0,0,0],animatable:true},scale:{label:"Scale",type:"Vec3",minValue:1e-4,step:.1,defaultValue:[1,1,1],animatable:true},centerType:{label:"Center",type:"Options",display:"Dropdown",labels:["Selection Center","World Center","Pivot"],values:["SelectionCenter","WorldCenter","Pivot"],defaultValue:"SelectionCenter"},vertexIndices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},category:"Model",changed:function(result){result.changed.positions=true
},modify:function(operator,polyMesh){var indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("vertexIndices"),polyMesh.getVertexCount()-1);var rotateOrder="ZYX";var translation=operator.get("translation");var rotation=operator.get("rotation");var scale=operator.get("scale");var centerType=TransCenter[operator.get("centerType")];var polyMeshNode=operator.node();var transform=exo.geometry.TransformUtilities.makeTransformByCenterType(polyMeshNode,polyMesh,translation,rotation,scale,centerType,indices,TransformUtils.RotateOrder.ZYX);for(var i=0,length=indices.length;i<length;++i){var vertex=polyMesh.positions[indices[i]];if(vertex){vertex.applyMatrix4(transform)}}return polyMesh},manipulations:{Transform:{gizmo:"Transform",manipulate:{Move:function(operator,deltaVector,subSelection){var translation=operator.get("translation");operator.ctx().set("translation",deltaVector.add(translation))},Rotate:function(operator,deltaVector,subSelection){var rotation=operator.get("rotation");operator.ctx().set("rotation",deltaVector.add(rotation))},Scale:function(operator,deltaVector,subSelection){var scale=operator.get("scale");operator.ctx().set("scale",deltaVector.add(scale))}},getCentroid:function(operator){return operator.get("translation")}}}}}();exo.operators.Merge={name:"Merge",schema:{nodeList:{type:"NodeList",label:"Select PolyMesh",filter:function(n){return n.id!==this.node().id&&n.get("type")==="PolyMesh"}}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"mergedTwoPlanes",getOptions:function(scene){if(scene&&scene.objectsRootNode){var polyMeshPlane1=exo.geometry.PolyMeshUtilities.createPlane(1,1);var polyMeshPlane2=exo.geometry.PolyMeshUtilities.createPlane(2,2);var node1=scene.objectsRootNode.addNode("Merged_Meshes","PolyMesh",{PolyMesh:{Collapse:{polyMesh:polyMeshPlane1}}});var node2=scene.objectsRootNode.addNode("Merged_Meshes","PolyMesh",{PolyMesh:{Collapse:{polyMesh:polyMeshPlane2}}});return{nodeList:[node1,node2]}}else{return{}}}}],modify:function(operator,polyMesh){var nodeList=operator.get("nodeList");var node=operator.node();var transform=null;if(!nodeList||nodeList.length<1||!polyMesh||!node){return polyMesh}var polyMeshMerged=polyMesh.clone();if(node.transform){transform=node.transform.getWorldTransform();transformInverse=node.transform.getWorldTransformInverse()}for(var i=0,il=nodeList.length;i<il;i++){var targetNode=nodeList[i];var transformTarget=null;if(targetNode.transform){transformTarget=(new THREE.Matrix4).multiplyMatrices(transformInverse,targetNode.transform.getWorldTransform())}if(targetNode.polyMesh){polyMeshMerged.merge(targetNode.polyMesh,transformTarget)}}if(polyMeshMerged){polyMesh=polyMeshMerged}return polyMesh}};exo.operators.MaterialIDs={name:"MaterialIDs",targets:["PolyMesh"],schema:{materialID:{label:"Material ID",type:"Integer",step:1,minValue:0,defaultValue:0},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},category:"Render",testConfigurations:[{name:"default",getOptions:function(){return{materialID:1,indices:"0"}}}],changed:function(result){result.changed.materials=true},modify:function(operator,polyMesh){var materialID=operator.get("materialID");var faceIndices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getFacesCount()-1);if(faceIndices.length<1){return polyMesh}polyMesh.setDefaultMaterialIDs();for(var i=0,il=faceIndices.length;i<il;++i){polyMesh.setMaterialID(materialID,faceIndices[i])}return polyMesh}};exo.operators.Extrude={name:"Extrude",schema:{extrudeLength:{label:"Length",type:"Number",step:.01,defaultValue:1,animatable:true},extrudeType:{label:"Extrude Type",type:"Options",display:"Dropdown",labels:["Group - Average Normal","Individual Polygons"],values:["PolygonGroup","Polygons"],defaultValue:"PolygonGroup"},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"extrudeTypeGroup",getOptions:function(){return{extrudeType:"PolygonGroup",extrudeLength:1,indices:"0"}}},{name:"extrudeTypePolygons",getOptions:function(){return{extrudeType:"Polygons",extrudeLength:1,indices:"0"}}}],modify:function(operator,polyMesh){var extrudeLength=operator.get("extrudeLength");var extrudeType=operator.get("extrudeType");var faceIndices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getFacesCount()-1);var subFaceIndices;if(faceIndices.length===0){return polyMesh}if(extrudeType=="PolygonGroup"){polyMesh.extrudeFaces(faceIndices,extrudeType,extrudeLength)}else if(extrudeType=="PolygonGroupNormals"){}else if(extrudeType=="Polygons"){for(var i=0;i<faceIndices.length;i++){subFaceIndices=[faceIndices[i]];polyMesh.extrudeFaces(subFaceIndices,extrudeType,extrudeLength)}}return polyMesh}};exo.operators.Detach={name:"Detach",schema:{removeDuplicatedVertex:{label:"Remove Duplicated Vertex",type:"Boolean",defaultValue:true},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"detachDuplicatedVertex",getOptions:function(){return{removeDuplicatedVertex:false,indices:"0"}}},{name:"detachNoDuplicatedVertex",getOptions:function(){return{removeDuplicatedVertex:true,indices:"0"}}}],modify:function(operator,polyMesh){var removeDuplicatedVertex=operator.get("removeDuplicatedVertex");var faceIndices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getFacesCount()-1);if(faceIndices.length===0){return polyMesh}var faces=polyMesh.faces;var detachedFaceIndices=polyMesh.detachFacesToElement(faceIndices,!removeDuplicatedVertex);return polyMesh}};exo.operators.Symmetry={name:"Symmetry",schema:{center:{label:"Center",type:"Vec3",defaultValue:new THREE.Vector3(0,0,0),step:.1,animatable:true},normal:{label:"Normal",type:"Vec3",defaultValue:new THREE.Vector3(1,0,0),minValue:-1,maxValue:1,step:.1,animatable:true},flip:{label:"Flip Mirroring",type:"Boolean",defaultValue:true},slice:{label:"Slice",type:"Boolean",defaultValue:true},weldSeam:{label:"Weld Seam",type:"Boolean",defaultValue:true},weldThreshold:{label:"Weld Threshold",type:"Number",defaultValue:.01,minValue:0,step:.01,animatable:true}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"symmetryFlipTrue",getOptions:function(){return{symmetryFlip:false,weldSeam:true,slice:true}}},{name:"symmetryNoSlice",getOptions:function(){return{symmetryFlip:true,weldSeam:true,slice:false}}},{name:"symmetryNoWeld",getOptions:function(){return{symmetryFlip:true,weldSeam:false,weldThreshold:.01,slice:true}}}],modify:function(operator,polyMesh){var normal=operator.get("normal").clone().normalize();var center=operator.get("center");var flip=operator.get("flip");var cut=operator.get("cut");var slice=operator.get("slice");var weldSeam=operator.get("weldSeam");var weldThreshold=operator.get("weldThreshold");if(flip){normal.negate()}var plane=(new THREE.Plane).setFromNormalAndCoplanarPoint(normal,center);exo.geometry.PolyMeshUtilities.symmetry(polyMesh,plane,weldSeam,weldThreshold,!slice);return polyMesh},manipulations:{Center:{gizmo:"Move",manipulate:function(operator,deltaVector,subSelection){var center=operator.get("center");operator.ctx().set("center",deltaVector.add(center))},getCentroid:function(operator){return operator.get("center")}},Normal:{gizmo:"Move",manipulate:function(operator,deltaVector,subSelection){var normal=operator.get("normal");operator.ctx().set("normal",deltaVector.add(normal))},getCentroid:function(operator){return operator.get("center")}}}};exo.operators.Weld={name:"Weld",schema:{weldThreshold:{label:"Threshold",type:"Number",defaultValue:.1,minValue:0,step:.01,animatable:true},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"},componentType:{type:"Object",hidden:true,defaultValue:"Vertex"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"weld",getOptions:function(){return{weldThreshold:1e4,indices:"0-1"}}}],modify:function(operator,polyMesh){var weldThreshold=operator.get("weldThreshold");var indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getVertexCount()-1);if(indices.length<2){return polyMesh}polyMesh.weldVertices(indices,weldThreshold);return polyMesh}};exo.operators.CleanPolyMesh={name:"CleanPolyMesh",schema:{indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"},componentType:{type:"Object",hidden:true,defaultValue:"Vertex"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"defaultCleanPolyMesh",getOptions:function(){return{}}},{name:"cleanPolyMeshSelected",getOptions:function(){return{indices:"0-1"}}}],modify:function(operator,polyMesh){var indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getVertexCount()-1);var componentType=operator.get("componentType");if(indices.length<1){polyMesh.removeUnusedValues()}else{polyMesh.removeUnusedValues(indices)}return polyMesh}};exo.operators.DeleteComponent={name:"DeleteComponent",schema:{removeOrphans:{label:"Remove Unused Values",type:"Boolean",defaultValue:false},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"},componentType:{type:"Object",hidden:true,defaultValue:"Vertex"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}},{name:"deleteVertex",getOptions:function(){return{componentType:"Vertex",indices:"0",removeOrphans:true}}},{name:"deleteEdge",getOptions:function(){return{componentType:"Edge",indices:"0-1",removeOrphans:true}}},{name:"deleteFace",getOptions:function(){return{componentType:"Face",indices:"0",removeOrphans:true}}}],modify:function(operator,polyMesh){var indices;var componentType=operator.get("componentType");if(componentType==="Vertex"||componentType==="Edge"){indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getVertexCount()-1);polyMesh.deleteVertices(indices)}else if(componentType==="Face"){indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getFacesCount()-1);polyMesh.deleteFaces(indices)}if(operator.get("removeOrphans")){polyMesh.removeUnusedValues()}return polyMesh}};exo.operators.Connect={name:"Connect",schema:{numSegments:{label:"Segments",type:"Integer",step:1,minValue:1,defaultValue:1,animatable:true},edges:{type:"Object",hidden:true,defaultValue:[]},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"},componentType:{type:"Object",hidden:true,defaultValue:"Edge"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{edges:[new exo.geometry.Edge(0,1),new exo.geometry.Edge(1,2)]}}},{name:"moreSegments",getOptions:function(){return{numSegments:4,edges:[new exo.geometry.Edge(0,1),new exo.geometry.Edge(1,2)]}}},{name:"JsonEdges",getOptions:function(){return{numSegments:1,edges:[{start:0,end:1},{start:1,end:2}]}}}],modify:function(operator,polyMesh){var numSegments=operator.get("numSegments");var componentType=operator.get("componentType");var offset=operator.get("offset");if(componentType=="Edge"){var edges=exo.geometry.ComponentUtilities.convertJsonToEdges(operator.get("edges"));if(!edges||edges.length<1){return polyMesh}exo.geometry.PolyMeshUtilities.connectEdges(polyMesh,edges,numSegments,offset)}else if(componentType=="Vertex"){var vIndices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getVertexCount()-1);if(vIndices.length===0){return polyMesh}exo.geometry.PolyMeshUtilities.connectVertices(polyMesh,vIndices)}return polyMesh}};exo.operators.RemoveComponent={name:"RemoveComponent",type:"Edit",schema:{componentType:{type:"Object",hidden:true,defaultValue:"Vertex"},edges:{type:"Object",hidden:true,defaultValue:[]},indices:{label:"Selection",type:"TextArea",defaultValue:"",display:"indexStyle"}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{componentType:"Vertex",indices:"0"}}}],modify:function(operator,polyMesh){var componentType=operator.get("componentType");if(componentType==="Vertex"){var indices=exo.geometry.GeometryUtils.stringIndicesToArray(operator.get("indices"),polyMesh.getVertexCount()-1);if(indices&&indices.length>0){polyMesh.removeVertices(indices)}}else if(componentType==="Edge"){var edges=exo.geometry.ComponentUtilities.convertJsonToEdges(operator.get("edges"));if(!edges||edges.length<1){return polyMesh}polyMesh.removeEdges(edges)}return polyMesh}};exo.operators.Triangulate={name:"Triangulate",schema:{},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"default",getOptions:function(){return{}}}],modify:function(operator,polyMesh){polyMesh=polyMesh.triangulate();return polyMesh}};exo.operators.FillComponent={name:"FillComponent",schema:{edges:{type:"Object",hidden:true,defaultValue:[]}},targets:["PolyMesh"],category:"Model",testConfigurations:[{name:"fill",getOptions:function(){return{}}}],modify:function(operator,polyMesh){var edges=exo.geometry.ComponentUtilities.convertJsonToEdges(operator.get("edges"));if(!edges||edges.length<1){return polyMesh}exo.geometry.PolyMeshUtilities.fillBorders(polyMesh,edges);return polyMesh}};exo.operators.DirectionalLight={name:"DirectionalLight",target:"Light",schema:{color:{label:"Color",type:"Color",defaultValue:(new THREE.Color).setHex(16777215),animatable:true},intensity:{label:"Intensity",type:"Number",defaultValue:1,step:.1,minValue:0,maxValue:5,animatable:true},castShadow:{label:"Cast Shadow",type:"Boolean",defaultValue:false},shadowBias:{label:"Shadow Bias",type:"Number",defaultValue:2e-4,step:1e-4,animatable:true},shadowSize:{label:"Shadow Map Size",type:"Number",defaultValue:512,step:1,minValue:64},shadowCameraSize:{label:"Shadow Camera Size",type:"Number",defaultValue:500,step:1,minValue:1},shadowNearClip:{label:"Shadow Near Clip",type:"Number",step:.01,defaultValue:.1,minValue:.01},shadowFarClip:{label:"Shadow Far Clip",type:"Number",defaultValue:1e3,step:1,minValue:1e-5,maxValue:1e6},shadowDarkness:{label:"Shadow Darkness",type:"Number",defaultValue:.7,step:.01,minValue:0,maxValue:1},showShadowCamera:{label:"Show Shadow Frustum",type:"Boolean",defaultValue:false}},create:function(operator,light){_.each(this.schema,function(attr,key){light[key]=operator.get(key)});light.lightType=this.name;return light}};exo.operators.PointLight={name:"PointLight",target:"Light",schema:{color:{label:"Color",type:"Color",defaultValue:(new THREE.Color).setHex(16777215),animatable:true},intensity:{label:"Intensity",type:"Number",defaultValue:1,step:.1,minValue:0,maxValue:5,animatable:true},distance:{label:"Distance",type:"Integer",defaultValue:1e4,minValue:0,animatable:true},falloffExponent:{label:"Falloff Exponent",type:"Number",defaultValue:2,minValue:0,maxValue:3,step:1},castShadow:{label:"Cast Shadow",type:"Boolean",defaultValue:false}},create:function(operator,light){light.color=operator.get("color");light.distance=operator.get("distance");light.intensity=operator.get("intensity");light.falloffExponent=operator.get("falloffExponent");light.castShadow=operator.get("castShadow");light.lightType=this.name;return light}};exo.operators.SpotLight={name:"SpotLight",target:"Light",schema:{color:{label:"Color",type:"Color",defaultValue:(new THREE.Color).setHex(16777215),animatable:true},intensity:{label:"Intensity",type:"Number",defaultValue:1,step:.1,minValue:0,maxValue:5,animatable:true},distance:{label:"Cutoff Distance",type:"Integer",defaultValue:1e3,minValue:0,animatable:true},coneAngle:{label:"Cone Angle",type:"Number",defaultValue:60,minValue:0,maxValue:360,animatable:true},falloffExponent:{label:"Falloff Exponent",type:"Number",defaultValue:2,minValue:0,maxValue:1e4,step:1},castShadow:{label:"Cast Shadow",type:"Boolean",defaultValue:false},shadowBias:{label:"Shadow Bias",type:"Number",defaultValue:2e-4,step:1e-4,animatable:true},shadowSize:{label:"ShadowMap Size",type:"Number",defaultValue:512,step:1,minValue:64},shadowNearClip:{label:"Shadow Near Clip",type:"Number",step:.01,defaultValue:.1,minValue:.01},shadowFarClip:{label:"Shadow Far Clip",type:"Number",defaultValue:1e3,step:1,minValue:1e-5,maxValue:1e6},shadowDarkness:{label:"Shadow Darkness",type:"Number",defaultValue:.7,step:.01,minValue:0,maxValue:1},showShadowCamera:{label:"Show Shadow Frustum",type:"Boolean",defaultValue:false}},create:function(operator,light){_.each(this.schema,function(attr,key){light[key]=operator.get(key)});light.lightType=this.name;return light}};exo.operators.Camera={name:"Camera",target:"Camera",schema:{targeted:{label:"Enable Look Target",type:"Boolean",defaultValue:false},target:{label:"Look At Target",type:"Vec3",defaultValue:new THREE.Vector3(0,0,0)},focalDepth:{label:"Focal Depth",type:"Number",defaultValue:100,minValue:.001,animatable:true,hidden:true},axisDirection:{type:"Object",hidden:true},zoomAxis:{type:"Object",hidden:true},size:{type:"Object",hidden:true},projection:{label:"Projection",type:"Options",defaultValue:"Perspective",values:["Perspective","Orthographic"]},fieldOfView:{label:"Field of View",type:"Number",defaultValue:45,minValue:5,maxValue:179,animatable:true},aspectRatio:{label:"Aspect Ratio",type:"Number",defaultValue:16/9,step:.01,minValue:.01,maxValue:10},nearClip:{label:"Near Clip",type:"Number",step:.01,defaultValue:.1,minValue:.01},farClip:{label:"Far Clip",type:"Number",defaultValue:5e4,step:1,minValue:1e-5,maxValue:1e6},orthoZoom:{label:"Ortho Zoom",type:"Number",defaultValue:1,minValue:.01,step:.1},showFrustum:{label:"Show Frustum",type:"Boolean",defaultValue:false},showClipping:{label:"Show Clipping",type:"Boolean",defaultValue:false}},provides:["zoomAxis","axisDirection","projection","orthoZoom","size","target"],create:function(operator,camera){_.each(this.schema,function(attr,key){camera[key]=operator.get(key)});return camera}};exo.operators.Null={name:"Null",target:"Null",schema:{size:{label:"Size",type:"Number",defaultValue:1,step:.1,minValue:.1,animatable:true},color:{label:"Color",type:"Color",defaultValue:(new THREE.Color).setHex(16776960),animatable:true}},create:function(operator){var nullObj={};nullObj.size=operator.get("size");nullObj.color=operator.get("color");return nullObj}};exo.operators.DefaultProperties={name:"Default",target:"Properties",schema:{visible:{label:"Visible",type:"Boolean",defaultValue:true,animatable:true},renderable:{label:"Renderable",type:"Boolean",defaultValue:true},selectable:{label:"Selectable",type:"Boolean",defaultValue:true}},provides:["visible","renderable","selectable"],create:function(operator,primitive){primitive.visible=operator.get("visible");primitive.renderable=operator.get("renderable");primitive.selectable=operator.get("selectable");return primitive}};exo.operators.License={name:"License",targets:["Properties"],schema:{licenseType:{label:"License Type",type:"Options",defaultValue:"None",values:["None","Custom","CC BY","CC BY-SA","CC BY-ND","CC BY-NC","CC BY-NC-SA","CC BY-NC-ND","CC0","MIT","Apache 2","Affero GPL","Artistic 2","GPL 2","GPL 3"]},ownerName:{label:"Owner Name",type:"Text",defaultValue:""},ownerContact:{label:"Owner Contact",type:"Text",defaultValue:""},source:{label:"Source",type:"Text",defaultValue:""},comments:{label:"Comments",type:"Text",defaultValue:""}},category:"Information",modify:function(operator,state){return state}};!function(){var typeDefaults={Text:"",Vec3:new THREE.Vector3(0,0,0),Number:0,Color:(new THREE.Color).setRGB(1,1,1),Boolean:true};exo.operators.MetaData={name:"MetaData",schema:{key:{label:"Name",type:"Text",defaultValue:""},value:{label:"Value",type:"Text",defaultValue:""}},targets:["Properties"],typeDefaults:typeDefaults,category:"Information",modify:function(operator,state){return state}}}();exo.operators.PolyMeshProperties={name:"PolyMeshProperties",target:"Properties",schema:{visible:{label:"Visible",type:"Boolean",defaultValue:true,animatable:true},renderable:{label:"Renderable",type:"Boolean",defaultValue:true},selectable:{label:"Selectable",type:"Boolean",defaultValue:true},castShadow:{label:"Cast Shadow",type:"Boolean",defaultValue:true},receiveShadow:{label:"Receive Shadow",type:"Boolean",defaultValue:true}},provides:["visible","renderable","selectable","castShadow","receiveShadow"],create:function(operator,primitive){primitive.visible=operator.get("visible");primitive.renderable=operator.get("renderable");primitive.selectable=operator.get("selectable");primitive.castShadow=operator.get("castShadow");primitive.receiveShadow=operator.get("receiveShadow");return primitive}};!function(){var cubeMapsPackB=exo.geometry.MaterialUtilities.cubeMapLibrary.packB;var cubeMapsOptions=exo.geometry.MaterialUtilities.getLibraryOptions(cubeMapsPackB);exo.operators.CubeMap={name:"CubeMap",target:"Material",mode:"Map",schema:{map0:{label:"Map ( x)",type:"Image"},map1:{label:"Map (-x)",type:"Image"},map2:{label:"Map ( y)",type:"Image"},map3:{label:"Map (-y)",type:"Image"},map4:{label:"Map ( z)",type:"Image"},map5:{label:"Map (-z)",type:"Image"}},provides:[],create:function(operator,material){var materialOutput={};materialOutput.maps=[];for(var i=0;i<6;i++){materialOutput.maps[i]=operator.get("map"+i);if(!materialOutput.maps[i]){materialOutput.maps[i]=exo.geometry.MaterialUtilities.textureLibrary.checkerboard}}var materialMap=material.createMaterial("CubeMap","Map",operator.plug().name,materialOutput,operator.node());material.setMaterial(materialMap);return material}}}();!function(){var filterMaterial=function(n){var materialPlug=n.plugs.Material;if(!materialPlug||!materialPlug.operators.last()){return false}return n.isMaterial()&&!materialPlug.isMultiID()&&!materialPlug.isMaterialMap()};exo.operators.MaterialMultiID={name:"MultiID",target:"Material",schema:{defaultColor:{label:"Default Color",type:"Color",defaultValue:function(){var randomizer=new Alea;return new THREE.Color(randomizer()*16777215)},animatable:true},material0:{type:"Node",label:"Material ID 0",filter:filterMaterial},material1:{type:"Node",label:"Material ID 1",filter:filterMaterial},material2:{type:"Node",label:"Material ID 2",filter:filterMaterial},material3:{type:"Node",label:"Material ID 3",filter:filterMaterial},material4:{type:"Node",label:"Material ID 4",filter:filterMaterial},material5:{type:"Node",label:"Material ID 5",filter:filterMaterial},material6:{type:"Node",label:"Material ID 6",filter:filterMaterial},material7:{type:"Node",label:"Material ID 7",filter:filterMaterial},material8:{type:"Node",label:"Material ID 8",filter:filterMaterial},material9:{type:"Node",label:"Material ID 9",filter:filterMaterial}},provides:[],create:function(operator,material){var defaultColor=operator.get("defaultColor");var subMaterials={};var materialNode;for(var i=0;i<10;i++){materialNode=operator.get("material"+i);subMaterials[i]=material.getMaterialFromNode(materialNode,true,defaultColor)}material.setMaterial(material.createMaterial("MultiID","ThreeJS",operator.plug().name,subMaterials,operator.node()),subMaterials.length);return material}}}();!function(){var filterMaterial=function(n){var materialPlug=n.plugs.Material;if(!materialPlug||!materialPlug.operators.last()){return false}return n.isMaterial()&&!materialPlug.isMaterialMap()};exo.operators.MaterialReference={name:"Reference",target:"Material",schema:{defaultColor:{label:"Default Color",type:"Color",defaultValue:function(){var randomizer=new Alea;return new THREE.Color(randomizer()*16777215)},animatable:true},reference:{type:"Node",label:"Material",filter:filterMaterial}},provides:[],create:function(operator,material){var materialNode=operator.get("reference");var defaultColor=operator.get("defaultColor");material.setMaterial(material.getMaterialFromNode(materialNode,true,defaultColor));return material}}}();!function(){var cubeMapFilter=function(n){var materialPlug=n.plugs.Material;if(!materialPlug||!materialPlug.operators.last()){return false}return n.isMaterial()&&materialPlug.isCubeMap()};exo.operators.MaterialDefault={name:"Standard",target:"Material",schema:{materialType:{label:"Material type",type:"Options",values:["Lambert","Phong"],initialValue:"Lambert"},diffuseMap:{label:"Diffuse Map",type:"Image"},diffuseColor:{label:"Diffuse",type:"Color",initialValue:function(p){return p.get("diffuse_color")||16777215},animatable:true},enbaleDiffuseFactor:{label:"Diffuse Factor ",type:"Boolean",defaultValue:false},diffuseFactor:{label:"Diffuse Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},opacityMap:{label:"Opacity Map",type:"Image"},opacityColor:{label:"Opacity",type:"Color",defaultValue:16777215,animatable:true},opacityFactor:{label:"Opacity Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},specularMap:{label:"Specular Map",type:"Image"},specularColor:{label:"Specular",type:"Color",defaultValue:16777215,animatable:true},specularFactor:{label:"Specular Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},glossiness:{label:"Glossiness",type:"Number",defaultValue:50,minValue:0,maxValue:1e3,step:1,animatable:true},ambientMap:{label:"Ambient Map",type:"Image"},ambientColor:{label:"Ambient",type:"Color",animatable:true,initialValue:function(p){return p.get("ambient_color")||0}},ambientFactor:{label:"Ambient Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},emissiveMap:{label:"Emissive Map",type:"Image"},emissiveColor:{label:"Emissive",type:"Color",animatable:true,initialValue:function(p){return p.get("emissive_color")||0}},emissiveFactor:{label:"Emissive Factor",type:"Number",defaultValue:1,maxValue:1,minValue:0,step:.01,animatable:true},bumpMap:{label:"Bump Map",type:"Image"},bumpFactor:{label:"Bump Factor",type:"Number",defaultValue:.03,maxValue:1,minValue:0,step:.001,animatable:true},normalMap:{label:"Normal Map",type:"Image"},normalFactor:{label:"Normal Factor",type:"Number",defaultValue:1,minValue:0,maxValue:100,step:.001,animatable:true},reflection:{label:"Reflection",type:"Number",defaultValue:1,minValue:0,maxValue:1,step:.01,animatable:true},refraction:{label:"Refraction Index",type:"Number",defaultValue:.98,minValue:.3,maxValue:3,step:.01,animatable:true},cubeMap:{label:"CubeMap",type:"Node",filter:cubeMapFilter},blendCubeMap:{label:"Blend CubeMap",type:"Options",values:["Normal","Multiply","Mix","Add"],initialValue:"Normal"},vertexColors:{label:"Vertex Colors",type:"Boolean",defaultValue:false},side:{label:"Double Sided",type:"Boolean",defaultValue:false}},provides:[],create:function(operator,material){var materialOutput={};var materialNode;_.each(this.schema,function(attr,key){materialOutput[key]=operator.get(key)});var standardMaterial=material.createMaterial("Standard","ThreeJS",operator.plug().name,materialOutput,operator.node());material.setMaterial(standardMaterial);return material}}}();exo.operators.TextureImage={name:"Image",target:"Texture",schema:{image:{label:"Image",type:"Image"}},provides:["image"],apply:function(op,primitive){primitive.image=op.get("image");return primitive}};exo.operators.Timeline={name:"Timeline",target:"Timeline",schema:{animationStartFrame:{label:"Animation Start Frame",type:"Integer",defaultValue:0,minValue:0},animationEndFrame:{label:"Animation End Frame",type:"Integer",defaultValue:200,minValue:0},looping:{label:"Loop Animation",type:"Boolean",defaultValue:true},frameRate:{label:"Frame Rate",type:"Options",display:"Dropdown",values:["film","hfrFilm","ntsc","pal","custom"],labels:["Film","HFRFilm","NTSC","PAL","Custom"],defaultValue:"ntsc"},customFramesPerSecond:{label:"Custom Frame Rate",type:"Number",defaultValue:30,minValue:0},playSpeed:{label:"Playback Speed",type:"Number",defaultValue:1,minValue:1e-4,step:.5},playDirection:{label:"Playback Direction",type:"Options",display:"Radio",values:["forward","reverse"],labels:["Forward","Reverse"],defaultValue:"forward"},playRealtime:{label:"Force Real-time Playback",type:"Boolean",defaultValue:false},playing:{type:"Boolean",hidden:true}},frameRateTypes:{film:24,hfrFilm:48,ntsc:29.97,pal:25,custom:0},framesPerSecond:function(){return this.frameRateTypes[this.operator.get("frameRate")]||this.operator.get("customFramesPerSecond")},framesToSeconds:function(frames){return exo.math.framesToSeconds(this.framesPerSecond(),frames)},secondsToFrames:function(timeInSeconds){return exo.math.secondsToFrames(this.framesPerSecond(),timeInSeconds)},modify:function(operator,timeline){_.each(this.schema,function(info,key){timeline[key]=operator.get(key)});return timeline}};!function(){var cubeMapFilter=function(n){var materialPlug=n.plugs.Material;if(!materialPlug||!materialPlug.operators.last())return false;return n.get("type")==="Material"&&materialPlug.operators.last().get("name")==="CubeMap"};exo.operators.Environment={name:"Environment",target:"Environment",schema:{cubeMap:{label:"Cube Map",type:"Node",initialValue:null,filter:cubeMapFilter},cubeMapVisible:{label:"Show Cube Map",type:"Boolean",defaultValue:true},ambientLight:{label:"Ambient Light",type:"Color",defaultValue:0}},modify:function(operator,skybox){_.each(this.schema,function(info,key){skybox[key]=operator.get(key)});return skybox}}}();!function(){var mat1=new THREE.Matrix4;var mat2=new THREE.Matrix4;var vec1=new THREE.Vector3;var vec2=new THREE.Vector3;var targetFilter=function(n){return n.Transform!==undefined};var AXIS_LIST={1:" X",2:" Y",3:" Z",4:"-X",5:"-Y",6:"-Z"};var ROT_FROM_Z_TO={1:(new THREE.Matrix4).makeRotationY(Math.PI*.5),2:(new THREE.Matrix4).makeRotationX(Math.PI*-.5),3:(new THREE.Matrix4).makeRotationY(Math.PI),4:(new THREE.Matrix4).makeRotationY(Math.PI*-.5),5:(new THREE.Matrix4).makeRotationX(Math.PI*.5),6:null};var LookAt={name:"LookAt",target:"Transform",schema:{target:{type:"Node",label:"Look Target",filter:targetFilter},up:{type:"Vec3",label:"Up Vector",defaultValue:new THREE.Vector3(0,1,0),animatable:true},upTarget:{type:"Node",label:"Up Target",filter:targetFilter},twist:{type:"Number",label:"Twist",minValue:-180,maxValue:180,defaultValue:0},LookAtAxis:{type:"Options",label:"LookAt axis",defaultValue:"6",values:Object.keys(AXIS_LIST),labels:AXIS_LIST}},apply:function(operator,transform){var target_node=operator.get("target");var xform=transform;if(!target_node)return xform;var parent=operator.node().parentNode();mat1=parent.transform.getWorldTransform();parent=parent&&parent.Transform?mat2.getInverse(mat1):null;var up_node=operator.get("upTarget");var up_vector=null;if(!up_node){up_vector=operator.get("up")}else{mat1=up_node.transform.getWorldTransform();var up_target=mat1;if(parent)up_target.multiplyMatrices(parent,up_target);var target_elem=up_target.elements;up_vector=vec2.set(target_elem[12],target_elem[13],target_elem[14]).sub(xform.translation)}mat1=target_node.transform.getWorldTransform();var target_mat=mat1;if(parent)target_mat.multiplyMatrices(parent,target_mat);var target_elem=target_mat.elements;mat2.lookAt(xform.translation,vec1.set(target_elem[12],target_elem[13],target_elem[14]),up_vector);if(up_node===undefined&&operator.get("twist")!==0){mat2.multiply(mat1.rotateZ(operator.get("twist")*Math.PI/180))}if(operator.get("LookAtAxis")!==6){mat2.multiply(ROT_FROM_Z_TO[operator.get("LookAtAxis")])}xform.rotation.setEulerFromRotationMatrix(mat2,"ZYX").multiplyScalar(180/Math.PI);xform.scale.set(1,1,1);return xform}}}();exo.operators.SimpleTransform={name:"Simple",target:"Transform",schema:{translation:{label:"Translation",type:"Vec3",step:.1,defaultValue:[0,0,0],animatable:true},rotation:{label:"Rotation",type:"Vec3",step:1,defaultValue:[0,0,0],animatable:true},scale:{label:"Scale",type:"Vec3",step:.1,defaultValue:[1,1,1],animatable:true}},apply:function(operator,transform){var translation=operator.get("translation");var rotation=operator.get("rotation");var scale=operator.get("scale");var lTranslationM=new THREE.Matrix4;lTranslationM.makeTranslation(translation.x,translation.y,translation.z);var lRotationM=new THREE.Matrix4;lRotationM.makeRotationFromEuler(exo.math.degreeToRadian(rotation),"ZYX");
var lScalingM=new THREE.Matrix4;lScalingM.makeScale(scale.x,scale.y,scale.z);transform.setLocalTransform(exo.math.multiplyMatricesList([lTranslationM,lRotationM,lScalingM]));return transform}};!function(){var zeroVector=new THREE.Vector3(0,0,0);var vec3_tmp1=new THREE.Vector3;var mat1=new THREE.Matrix4;var mat2=new THREE.Matrix4;var tmpQuatPar=new THREE.Quaternion;var tmpQuatRot=new THREE.Quaternion;var tmpQuatOff=new THREE.Quaternion;var parentWorldMatrix=new THREE.Matrix4;var _rotateOrder={XYZ:"XYZ",YZX:"YZX",ZXY:"ZXY",XZY:"XZY",YXZ:"YXZ",ZYX:"ZYX"};exo.operators.Transform={name:"Transform",target:"Transform",schema:{translation:{label:"Translation",type:"Vec3",step:.1,defaultValue:[0,0,0],animatable:true},rotation:{label:"Rotation",type:"Vec3",step:1,defaultValue:[0,0,0],animatable:true},rotationOffset:{label:"Rotation Offset",type:"Vec3",step:1,defaultValue:[0,0,0]},scale:{label:"Scale",type:"Vec3",step:.1,defaultValue:[1,1,1],animatable:true},shear:{label:"Shear",type:"Vec3",minValue:0,step:.1,defaultValue:[0,0,0]},rotateOrder:{label:"Rotate Order",type:"Options",display:"Dropdown",values:["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],defaultValue:"ZYX"},preRotation:{label:"Pre-Rotation",type:"Vec3",step:1,defaultValue:[0,0,0]},rotateAxis:{label:"Rotate Axis",type:"Vec3",step:1,defaultValue:[0,0,0]},rotatePivotOffset:{label:"Rotate Pivot Offset",type:"Vec3",step:.1,defaultValue:[0,0,0]},scalePivotOffset:{label:"Scale Pivot Offset",type:"Vec3",step:.1,defaultValue:[0,0,0]},localRotatePivot:{label:"Local Rotate Pivot",type:"Vec3",step:.1,defaultValue:[0,0,0]},localScalePivot:{label:"Local Scale Pivot",type:"Vec3",step:.1,defaultValue:[0,0,0]},resetPivots:{label:"Reset Pivots",type:"Button"}},initialize:function(operator){operator.bindTo(operator,"change:rotationOffset",function(){var offset=operator.get("rotationOffset");this.rotate(operator,offset);offset.copy(zeroVector)},this)},apply:function(operator,transform){transform.setLocalTransform(this.local(operator));this.updatePivots(operator,transform);return transform},resetPivots:function(operator){operator.ctx().set("localRotatePivot",zeroVector.clone());operator.ctx().set("rotatePivotOffset",zeroVector.clone());operator.ctx().set("localScalePivot",zeroVector.clone());operator.ctx().set("scalePivotOffset",zeroVector.clone())},updatePivots:function(operator,transform){transform.setWorldRotatePivot(this.computeWorldRotatePivot(operator));transform.setWorldScalePivot(this.computeWorldScalePivot(operator))},parentQuaternion:function(operator,parent){if(parent&&parent.transform){var invWorldRotationMatrix=(new THREE.Matrix4).getInverse(parent.transform.getWorldRotationMatrix());var quatPar=tmpQuatPar.setFromRotationMatrix(invWorldRotationMatrix);return quatPar}return null},translate:function(operator,offset){var translation=operator.get("translation");var q=this.parentQuaternion(operator,operator.node().parentNode());if(q)offset.applyQuaternion(q);operator.ctx().set("translation",(new THREE.Vector3).addVectors(translation,offset))},rotate:function(operator,offset){var rotation=operator.get("rotation");rotation=exo.math.degreeToRadian(rotation);offset=exo.math.degreeToRadian(offset);var quatRot=tmpQuatRot.setFromEuler(rotation,"ZYX");var quatOff=tmpQuatOff;var q=this.parentQuaternion(operator,operator.node().parentNode());if(offset.x){vec3_tmp1.set(1,0,0);if(q)vec3_tmp1.applyQuaternion(q);quatOff.setFromAxisAngle(vec3_tmp1,offset.x);quatRot.multiplyQuaternions(quatOff,quatRot)}if(offset.y){vec3_tmp1.set(0,1,0);if(q)vec3_tmp1.applyQuaternion(q);quatOff.setFromAxisAngle(vec3_tmp1,offset.y);quatRot.multiplyQuaternions(quatOff,quatRot)}if(offset.z){vec3_tmp1.set(0,0,1);if(q)vec3_tmp1.applyQuaternion(q);quatOff.setFromAxisAngle(vec3_tmp1,offset.z);quatRot.multiplyQuaternions(quatOff,quatRot)}rotation.setEulerFromQuaternion(quatRot,"ZYX");rotation=exo.math.radianToDegree(rotation);operator.ctx().set("rotation",rotation.clone())},local:function(operator){var localTransform;var translation=operator.get("translation");var rotation=operator.get("rotation");var scale=operator.get("scale");var shear=operator.get("shear");var rotateOrder=operator.get("rotateOrder");var preRotation=operator.get("preRotation");var postRotation=operator.get("rotateAxis");var rotatePivotOffset=operator.get("rotatePivotOffset");var scalePivotOffset=operator.get("scalePivotOffset");var localRotatePivot=operator.get("localRotatePivot");var localScalePivot=operator.get("localScalePivot");var lScalingPivotMInverse=new THREE.Matrix4,lRotationPivotMInverse=new THREE.Matrix4,lTranlationM=new THREE.Matrix4,lRotationPivotOffsetM=new THREE.Matrix4,lRotationPivotM=new THREE.Matrix4,lPreRotationM=new THREE.Matrix4,lRotationM=new THREE.Matrix4,lPostRotationM=new THREE.Matrix4,lScalingPivotOffsetM=new THREE.Matrix4,lScalingPivotM=new THREE.Matrix4,lScalingM=new THREE.Matrix4,lScalingShearM=new THREE.Matrix4;var matricesList=[lTranlationM,lRotationPivotOffsetM,lRotationPivotM,lPreRotationM,lRotationM,lPostRotationM,lRotationPivotMInverse,lScalingPivotOffsetM,lScalingPivotM,lScalingM,lScalingShearM,lScalingPivotMInverse];if(localScalePivot){lScalingPivotM.makeTranslation(localScalePivot.x,localScalePivot.y,localScalePivot.z);lScalingPivotMInverse.getInverse(lScalingPivotM)}if(scalePivotOffset){lScalingPivotOffsetM.makeTranslation(scalePivotOffset.x,scalePivotOffset.y,scalePivotOffset.z)}if(shear){lScalingShearM=exo.math.makeShear(lScalingShearM,shear)}if(rotatePivotOffset){lRotationPivotOffsetM.makeTranslation(rotatePivotOffset.x,rotatePivotOffset.y,rotatePivotOffset.z)}if(localRotatePivot){lRotationPivotM.makeTranslation(localRotatePivot.x,localRotatePivot.y,localRotatePivot.z);lRotationPivotMInverse.getInverse(lRotationPivotM)}if(preRotation){lPreRotationM.makeRotationFromEuler(exo.math.degreeToRadian(preRotation),rotateOrder)}if(postRotation){lPostRotationM.makeRotationFromEuler(exo.math.degreeToRadian(postRotation),rotateOrder)}lTranlationM.makeTranslation(translation.x,translation.y,translation.z);lRotationM.makeRotationFromEuler(exo.math.degreeToRadian(rotation),rotateOrder);lScalingM.makeScale(scale.x,scale.y,scale.z);localTransform=exo.math.multiplyMatricesList(matricesList);return localTransform},computeWorldRotatePivot:function(operator){var pivot=(new THREE.Vector3).add(operator.get("translation")).add(operator.get("rotatePivotOffset")).add(operator.get("localRotatePivot"));var parent=operator.node().parentNode();if(parent&&parent.transform){return pivot.applyMatrix4(parent.transform.getWorldTransform(parentWorldMatrix))}else{return pivot}},computeWorldScalePivot:function(operator){var pivot=(new THREE.Vector3).add(operator.get("translation")).add(operator.get("scalePivotOffset")).add(operator.get("localScalePivot"));var parent=operator.node().parentNode();if(parent&&parent.transform){return pivot.applyMatrix4(parent.transform.getWorldTransform(parentWorldMatrix))}else{return pivot}},rotationMatrixLocal:function(operator,mat){mat=mat||new THREE.Matrix4;return mat.makeRotationFromEuler(exo.math.degreeToRadian(operator.get("rotation")),"ZYX")},rotationMatrixWorld:function(operator,transform){var cloMat=new THREE.Matrix4;return function(matA,matB){var parent=operator.node().parentNode();if(parent&&parent.Transform){matA=matA||new THREE.Matrix4;matB=matB||cloMat;return parent.transform.rotationMatrixWorld(matA,matB).multiply(this.rotationMatrixLocal(matB))}else{return this.rotationMatrixLocal(matA)}}}()}}();!function(){var zeroVector=new THREE.Vector3(0,0,0);var vec3_tmp1=new THREE.Vector3;var mat1=new THREE.Matrix4;var mat2=new THREE.Matrix4;var tmpQuatPar=new THREE.Quaternion;var tmpQuatRot=new THREE.Quaternion;var tmpQuatOff=new THREE.Quaternion;exo.operators.BoneTransform=_.extend({},exo.operators.Transform,{name:"BoneTransform",target:"Transform",schema:{translation:{label:"Translation",type:"Vec3",step:.1,defaultValue:[0,0,0],animatable:true},rotation:{label:"Rotation",type:"Vec3",step:1,defaultValue:[0,0,0],animatable:true},rotationOffset:{label:"Rotation Offset",type:"Vec3",step:1,defaultValue:[0,0,0]},scale:{label:"Scale",type:"Vec3",step:.1,defaultValue:[1,1,1],animatable:true},rotateOrder:{label:"Rotate Order",type:"Options",display:"Dropdown",values:["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],defaultValue:"ZYX"},preRotation:{label:"Pre-Rotation",type:"Vec3",step:1,defaultValue:[0,0,0]},rotateAxis:{label:"Rotate Axis",type:"Vec3",step:1,defaultValue:[0,0,0]}},initialize:function(operator){exo.operators.Transform.initialize.call(this,operator)},apply:function(operator,transform){transform.setLocalTransform(this.local(operator));return transform},local:function(operator){var localTransform;var parent=operator.node().parentNode();var translation=operator.get("translation");var rotation=operator.get("rotation");var scale=operator.get("scale");var rotateOrder=operator.get("rotateOrder");var preRotation=operator.get("preRotation");var postRotation=operator.get("rotateAxis");var scaleParent;var lParentScaleMInverse=new THREE.Matrix4,lTranlationM=new THREE.Matrix4,lPreRotationM=new THREE.Matrix4,lRotationM=new THREE.Matrix4,lPostRotationM=new THREE.Matrix4,lScalingM=new THREE.Matrix4;var matricesList=[lTranlationM,lParentScaleMInverse,lPreRotationM,lRotationM,lPostRotationM,lScalingM];if(preRotation){lPreRotationM.makeRotationFromEuler(exo.math.degreeToRadian(preRotation),rotateOrder)}if(postRotation){lPostRotationM.makeRotationFromEuler(exo.math.degreeToRadian(postRotation),rotateOrder)}lTranlationM.makeTranslation(translation.x,translation.y,translation.z);lRotationM.makeRotationFromEuler(exo.math.degreeToRadian(rotation),rotateOrder);lScalingM.makeScale(scale.x,scale.y,scale.z);if(parent&&parent.Transform){scaleParent=parent.Transform.get("scale");lParentScaleMInverse.getInverse(lScalingM)}localTransform=exo.math.multiplyMatricesList(matricesList);return localTransform},provides:["translation","rotation","rotationOffset","scale","rotateOrder","preRotation","rotateAxis"]})}();exo.operators.Bone={name:"Bone",target:"Bone",schema:{width:{label:"Width",type:"Number",defaultValue:.1,step:.1,minValue:.1},height:{label:"Height",type:"Number",defaultValue:.3,step:.1,minValue:.1},boneLength:{label:"Length",type:"Number",step:.1,minValue:.1,defaultValue:2},capSizeStart:{label:"Cap Start",type:"Number",defaultValue:1,step:.1,minValue:0},capSizeEnd:{label:"Cap End",type:"Number",defaultValue:1,step:.1,minValue:0},falloff:{label:"Falloff",type:"Number",defaultValue:.5,step:.1,minValue:0},shapeType:{label:"Shape Type",type:"Options",display:"Dropdown",values:["Box","Cylinder","Human"],defaultValue:"Cylinder"},color:{label:"Color",type:"Color",defaultValue:12632256},boneDirection:{label:"Direction",type:"Vec3",defaultValue:[1,0,0],hidden:true}},ShapeType:{Box:0,Cylinder:1,Human:2},create:function(operator){var bone={};bone.width=operator.get("width");bone.height=operator.get("height");bone.color=operator.get("color");bone.boneLength=operator.get("boneLength");bone.capSizeStart=operator.get("capSizeStart");bone.capSizeEnd=operator.get("capSizeEnd");bone.shapeType=this.ShapeType[operator.get("shapeType")];bone.boneDirection=operator.get("boneDirection");return bone}};!function(){var targetFilter=function(n){return n.get("type")==="Pass"};var RES_LIST={0:"[ Custom ]",1:"HD 720",2:"HD 1080",3:"640x480",4:"Full 1024",5:"1k Square",6:"2k Square",7:"Retina"};var RES_VALS={1:{w:1280,h:720},2:{w:1920,h:1080},3:{w:640,h:480},4:{w:1024,h:768},5:{w:1024,h:1024},6:{w:2048,h:2048},7:{w:2048,h:1536}};exo.operators.GeneralRenderer={name:"GeneralRenderer",target:"GeneralRenderer",schema:{res:{label:"Resolution",type:"Options",defaultValue:"1",values:Object.keys(RES_LIST),labels:RES_LIST},res_w:{label:"Width",type:"Number",defaultValue:1280,minValue:100,isInteger:true},res_h:{label:"Height",type:"Number",defaultValue:720,minValue:100,isInteger:true},output_dir:{label:"Output directory",type:"Text"},curPass:{label:"Current Pass",type:"Node",filter:targetFilter},frm_start:{label:"Start Frame",type:"Number",defaultValue:1},frm_last:{label:"Last Frame",type:"Number",defaultValue:24},frm_by:{label:"By Frame",type:"Number",defaultValue:1},ren_start:{label:"Start number",type:"Number",defaultValue:1,isInteger:true},ren_by:{label:"By Frame",type:"Number",defaultValue:1,isInteger:true},frm_pad:{label:"Frame padding",type:"Number",defaultValue:1,minValue:0,maxValue:10,isInteger:true}},provides:[],create:function(operator,gen){var res=operator.get("res");if(res===0){gen.res_h=operator.get("res_h");gen.res_w=operator.get("res_w")}else{var vals=RES_VALS[res];gen.res_h=vals.h;gen.res_w=vals.w}gen.output_dir=operator.get("output_dir");gen.curPass=operator.get("curPass");gen.frm_start=operator.get("frm_start");gen.frm_last=operator.get("frm_last");gen.frm_by=operator.get("frm_by");gen.ren_start=operator.get("ren_start");gen.ren_by=operator.get("ren_by");gen.frm_pad=operator.get("frm_pad");return gen}}}();!function(){var targetCam=function(n){return n.get("type")==="Camera"};var targetRen=function(n){return n.get("type")==="Renderer"};exo.operators.Pass={name:"Pass",target:"Pass",schema:{activated:{label:"Activated",type:"Boolean",defaultValue:true},filename:{label:"Filename",type:"Text",defaultValue:null},fileFormat:{label:"File Format",type:"Text",defaultValue:null},over_res:{label:"Override resolution",type:"Boolean",defaultValue:false},over_res_x:{label:"Resolution Width",type:"Number",defaultValue:1280,isInteger:true},over_res_y:{label:"Resolution Height",type:"Number",defaultValue:720,isInteger:true},render_cam:{type:"Node",label:"Camera",filter:targetCam},render_red:{type:"Node",label:"Renderer",filter:targetRen}},provides:[],create:function(operator,pass){pass.activated=operator.get("activated");pass.filename=operator.get("filename");pass.fileFormat=operator.get("fileFormat");pass.over_res=operator.get("over_res");pass.over_res_x=operator.get("over_res_x");pass.over_res_y=operator.get("over_res_y");pass.render_cam=operator.get("render_cam");pass.render_red=operator.get("render_red");return pass}}}();THREE.BinaryLoader=function(showStatus){THREE.Loader.call(this,showStatus)};THREE.BinaryLoader.prototype=Object.create(THREE.Loader.prototype);THREE.BinaryLoader.prototype.load=function(url,callback,texturePath,binaryPath){texturePath=texturePath&&typeof texturePath==="string"?texturePath:this.extractUrlBase(url);binaryPath=binaryPath&&typeof binaryPath==="string"?binaryPath:this.extractUrlBase(url);var callbackProgress=this.showProgress?THREE.Loader.prototype.updateProgress:null;this.onLoadStart();this.loadAjaxJSON(this,url,callback,texturePath,binaryPath,callbackProgress)};THREE.BinaryLoader.prototype.loadAjaxJSON=function(context,url,callback,texturePath,binaryPath,callbackProgress){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===0){var json=JSON.parse(xhr.responseText);context.loadAjaxBuffers(json,callback,binaryPath,texturePath,callbackProgress)}else{console.error("THREE.BinaryLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}};xhr.open("GET",url,true);xhr.send(null)};THREE.BinaryLoader.prototype.loadAjaxBuffers=function(json,callback,binaryPath,texturePath,callbackProgress){var xhr=new XMLHttpRequest,url=binaryPath+"/"+json.buffers;var length=0;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===0){var buffer=xhr.response;if(buffer===undefined)buffer=new Uint8Array(xhr.responseBody).buffer;THREE.BinaryLoader.prototype.createBinModel(buffer,callback,texturePath,json.materials)}else{console.error("THREE.BinaryLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}else if(xhr.readyState===3){if(callbackProgress){if(length===0){length=xhr.getResponseHeader("Content-Length")}callbackProgress({total:length,loaded:xhr.responseText.length})}}else if(xhr.readyState===2){length=xhr.getResponseHeader("Content-Length")}};xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.send(null)};THREE.BinaryLoader.prototype.createBinModel=function(data,callback,texturePath,jsonMaterials){var Model=function(texturePath){var scope=this,currentOffset=0,md,normals=[],uvs=[],start_tri_flat,start_tri_smooth,start_tri_flat_uv,start_tri_smooth_uv,start_quad_flat,start_quad_smooth,start_quad_flat_uv,start_quad_smooth_uv,tri_size,quad_size,len_tri_flat,len_tri_smooth,len_tri_flat_uv,len_tri_smooth_uv,len_quad_flat,len_quad_smooth,len_quad_flat_uv,len_quad_smooth_uv;THREE.Geometry.call(this);md=parseMetaData(data,currentOffset);currentOffset+=md.header_bytes;tri_size=md.vertex_index_bytes*3+md.material_index_bytes;quad_size=md.vertex_index_bytes*4+md.material_index_bytes;len_tri_flat=md.ntri_flat*tri_size;len_tri_smooth=md.ntri_smooth*(tri_size+md.normal_index_bytes*3);len_tri_flat_uv=md.ntri_flat_uv*(tri_size+md.uv_index_bytes*3);len_tri_smooth_uv=md.ntri_smooth_uv*(tri_size+md.normal_index_bytes*3+md.uv_index_bytes*3);len_quad_flat=md.nquad_flat*quad_size;len_quad_smooth=md.nquad_smooth*(quad_size+md.normal_index_bytes*4);len_quad_flat_uv=md.nquad_flat_uv*(quad_size+md.uv_index_bytes*4);len_quad_smooth_uv=md.nquad_smooth_uv*(quad_size+md.normal_index_bytes*4+md.uv_index_bytes*4);currentOffset+=init_vertices(currentOffset);currentOffset+=init_normals(currentOffset);currentOffset+=handlePadding(md.nnormals*3);currentOffset+=init_uvs(currentOffset);start_tri_flat=currentOffset;start_tri_smooth=start_tri_flat+len_tri_flat+handlePadding(md.ntri_flat*2);start_tri_flat_uv=start_tri_smooth+len_tri_smooth+handlePadding(md.ntri_smooth*2);start_tri_smooth_uv=start_tri_flat_uv+len_tri_flat_uv+handlePadding(md.ntri_flat_uv*2);start_quad_flat=start_tri_smooth_uv+len_tri_smooth_uv+handlePadding(md.ntri_smooth_uv*2);start_quad_smooth=start_quad_flat+len_quad_flat+handlePadding(md.nquad_flat*2);start_quad_flat_uv=start_quad_smooth+len_quad_smooth+handlePadding(md.nquad_smooth*2);start_quad_smooth_uv=start_quad_flat_uv+len_quad_flat_uv+handlePadding(md.nquad_flat_uv*2);init_triangles_flat_uv(start_tri_flat_uv);init_triangles_smooth_uv(start_tri_smooth_uv);init_quads_flat_uv(start_quad_flat_uv);init_quads_smooth_uv(start_quad_smooth_uv);init_triangles_flat(start_tri_flat);init_triangles_smooth(start_tri_smooth);init_quads_flat(start_quad_flat);init_quads_smooth(start_quad_smooth);this.computeCentroids();this.computeFaceNormals();function handlePadding(n){return n%4?4-n%4:0}function parseMetaData(data,offset){var metaData={signature:parseString(data,offset,12),header_bytes:parseUChar8(data,offset+12),vertex_coordinate_bytes:parseUChar8(data,offset+13),normal_coordinate_bytes:parseUChar8(data,offset+14),uv_coordinate_bytes:parseUChar8(data,offset+15),vertex_index_bytes:parseUChar8(data,offset+16),normal_index_bytes:parseUChar8(data,offset+17),uv_index_bytes:parseUChar8(data,offset+18),material_index_bytes:parseUChar8(data,offset+19),nvertices:parseUInt32(data,offset+20),nnormals:parseUInt32(data,offset+20+4*1),nuvs:parseUInt32(data,offset+20+4*2),ntri_flat:parseUInt32(data,offset+20+4*3),ntri_smooth:parseUInt32(data,offset+20+4*4),ntri_flat_uv:parseUInt32(data,offset+20+4*5),ntri_smooth_uv:parseUInt32(data,offset+20+4*6),nquad_flat:parseUInt32(data,offset+20+4*7),nquad_smooth:parseUInt32(data,offset+20+4*8),nquad_flat_uv:parseUInt32(data,offset+20+4*9),nquad_smooth_uv:parseUInt32(data,offset+20+4*10)};return metaData}function parseString(data,offset,length){var charArray=new Uint8Array(data,offset,length);var text="";for(var i=0;i<length;i++){text+=String.fromCharCode(charArray[offset+i])}return text}function parseUChar8(data,offset){var charArray=new Uint8Array(data,offset,1);return charArray[0]}function parseUInt32(data,offset){var intArray=new Uint32Array(data,offset,1);return intArray[0]}function init_vertices(start){var nElements=md.nvertices;var coordArray=new Float32Array(data,start,nElements*3);var i,x,y,z;for(i=0;i<nElements;i++){x=coordArray[i*3];y=coordArray[i*3+1];z=coordArray[i*3+2];vertex(scope,x,y,z)}return nElements*3*Float32Array.BYTES_PER_ELEMENT}function init_normals(start){var nElements=md.nnormals;if(nElements){var normalArray=new Int8Array(data,start,nElements*3);var i,x,y,z;for(i=0;i<nElements;i++){x=normalArray[i*3];y=normalArray[i*3+1];z=normalArray[i*3+2];normals.push(x/127,y/127,z/127)}}return nElements*3*Int8Array.BYTES_PER_ELEMENT}function init_uvs(start){var nElements=md.nuvs;if(nElements){var uvArray=new Float32Array(data,start,nElements*2);var i,u,v;for(i=0;i<nElements;i++){u=uvArray[i*2];v=uvArray[i*2+1];uvs.push(u,v)}}return nElements*2*Float32Array.BYTES_PER_ELEMENT}function init_uvs3(nElements,offset){var i,uva,uvb,uvc,u1,u2,u3,v1,v2,v3;var uvIndexBuffer=new Uint32Array(data,offset,3*nElements);for(i=0;i<nElements;i++){uva=uvIndexBuffer[i*3];uvb=uvIndexBuffer[i*3+1];uvc=uvIndexBuffer[i*3+2];u1=uvs[uva*2];v1=uvs[uva*2+1];u2=uvs[uvb*2];v2=uvs[uvb*2+1];u3=uvs[uvc*2];v3=uvs[uvc*2+1];uv3(scope.faceVertexUvs[0],u1,v1,u2,v2,u3,v3)}}function init_uvs4(nElements,offset){var i,uva,uvb,uvc,uvd,u1,u2,u3,u4,v1,v2,v3,v4;var uvIndexBuffer=new Uint32Array(data,offset,4*nElements);for(i=0;i<nElements;i++){uva=uvIndexBuffer[i*4];uvb=uvIndexBuffer[i*4+1];uvc=uvIndexBuffer[i*4+2];uvd=uvIndexBuffer[i*4+3];u1=uvs[uva*2];v1=uvs[uva*2+1];u2=uvs[uvb*2];v2=uvs[uvb*2+1];u3=uvs[uvc*2];v3=uvs[uvc*2+1];u4=uvs[uvd*2];v4=uvs[uvd*2+1];uv4(scope.faceVertexUvs[0],u1,v1,u2,v2,u3,v3,u4,v4)}}function init_faces3_flat(nElements,offsetVertices,offsetMaterials){var i,a,b,c,m;var vertexIndexBuffer=new Uint32Array(data,offsetVertices,3*nElements);var materialIndexBuffer=new Uint16Array(data,offsetMaterials,nElements);for(i=0;i<nElements;i++){a=vertexIndexBuffer[i*3];b=vertexIndexBuffer[i*3+1];c=vertexIndexBuffer[i*3+2];m=materialIndexBuffer[i];f3(scope,a,b,c,m)}}function init_faces4_flat(nElements,offsetVertices,offsetMaterials){var i,a,b,c,d,m;var vertexIndexBuffer=new Uint32Array(data,offsetVertices,4*nElements);var materialIndexBuffer=new Uint16Array(data,offsetMaterials,nElements);for(i=0;i<nElements;i++){a=vertexIndexBuffer[i*4];b=vertexIndexBuffer[i*4+1];c=vertexIndexBuffer[i*4+2];d=vertexIndexBuffer[i*4+3];m=materialIndexBuffer[i];f4(scope,a,b,c,d,m)}}function init_faces3_smooth(nElements,offsetVertices,offsetNormals,offsetMaterials){var i,a,b,c,m;var na,nb,nc;var vertexIndexBuffer=new Uint32Array(data,offsetVertices,3*nElements);var normalIndexBuffer=new Uint32Array(data,offsetNormals,3*nElements);var materialIndexBuffer=new Uint16Array(data,offsetMaterials,nElements);for(i=0;i<nElements;i++){a=vertexIndexBuffer[i*3];b=vertexIndexBuffer[i*3+1];c=vertexIndexBuffer[i*3+2];na=normalIndexBuffer[i*3];nb=normalIndexBuffer[i*3+1];nc=normalIndexBuffer[i*3+2];m=materialIndexBuffer[i];f3n(scope,normals,a,b,c,m,na,nb,nc)}}function init_faces4_smooth(nElements,offsetVertices,offsetNormals,offsetMaterials){var i,a,b,c,d,m;var na,nb,nc,nd;var vertexIndexBuffer=new Uint32Array(data,offsetVertices,4*nElements);var normalIndexBuffer=new Uint32Array(data,offsetNormals,4*nElements);var materialIndexBuffer=new Uint16Array(data,offsetMaterials,nElements);for(i=0;i<nElements;i++){a=vertexIndexBuffer[i*4];b=vertexIndexBuffer[i*4+1];c=vertexIndexBuffer[i*4+2];d=vertexIndexBuffer[i*4+3];na=normalIndexBuffer[i*4];nb=normalIndexBuffer[i*4+1];nc=normalIndexBuffer[i*4+2];nd=normalIndexBuffer[i*4+3];m=materialIndexBuffer[i];f4n(scope,normals,a,b,c,d,m,na,nb,nc,nd)}}function init_triangles_flat(start){var nElements=md.ntri_flat;if(nElements){var offsetMaterials=start+nElements*Uint32Array.BYTES_PER_ELEMENT*3;init_faces3_flat(nElements,start,offsetMaterials)}}function init_triangles_flat_uv(start){var nElements=md.ntri_flat_uv;if(nElements){var offsetUvs=start+nElements*Uint32Array.BYTES_PER_ELEMENT*3;var offsetMaterials=offsetUvs+nElements*Uint32Array.BYTES_PER_ELEMENT*3;init_faces3_flat(nElements,start,offsetMaterials);init_uvs3(nElements,offsetUvs)}}function init_triangles_smooth(start){var nElements=md.ntri_smooth;if(nElements){var offsetNormals=start+nElements*Uint32Array.BYTES_PER_ELEMENT*3;var offsetMaterials=offsetNormals+nElements*Uint32Array.BYTES_PER_ELEMENT*3;init_faces3_smooth(nElements,start,offsetNormals,offsetMaterials)}}function init_triangles_smooth_uv(start){var nElements=md.ntri_smooth_uv;if(nElements){var offsetNormals=start+nElements*Uint32Array.BYTES_PER_ELEMENT*3;var offsetUvs=offsetNormals+nElements*Uint32Array.BYTES_PER_ELEMENT*3;var offsetMaterials=offsetUvs+nElements*Uint32Array.BYTES_PER_ELEMENT*3;init_faces3_smooth(nElements,start,offsetNormals,offsetMaterials);init_uvs3(nElements,offsetUvs)}}function init_quads_flat(start){var nElements=md.nquad_flat;if(nElements){var offsetMaterials=start+nElements*Uint32Array.BYTES_PER_ELEMENT*4;init_faces4_flat(nElements,start,offsetMaterials)}}function init_quads_flat_uv(start){var nElements=md.nquad_flat_uv;if(nElements){var offsetUvs=start+nElements*Uint32Array.BYTES_PER_ELEMENT*4;var offsetMaterials=offsetUvs+nElements*Uint32Array.BYTES_PER_ELEMENT*4;init_faces4_flat(nElements,start,offsetMaterials);init_uvs4(nElements,offsetUvs)}}function init_quads_smooth(start){var nElements=md.nquad_smooth;if(nElements){var offsetNormals=start+nElements*Uint32Array.BYTES_PER_ELEMENT*4;var offsetMaterials=offsetNormals+nElements*Uint32Array.BYTES_PER_ELEMENT*4;init_faces4_smooth(nElements,start,offsetNormals,offsetMaterials)}}function init_quads_smooth_uv(start){var nElements=md.nquad_smooth_uv;if(nElements){var offsetNormals=start+nElements*Uint32Array.BYTES_PER_ELEMENT*4;var offsetUvs=offsetNormals+nElements*Uint32Array.BYTES_PER_ELEMENT*4;var offsetMaterials=offsetUvs+nElements*Uint32Array.BYTES_PER_ELEMENT*4;init_faces4_smooth(nElements,start,offsetNormals,offsetMaterials);init_uvs4(nElements,offsetUvs)}}};function vertex(scope,x,y,z){scope.vertices.push(new THREE.Vector3(x,y,z))}function f3(scope,a,b,c,mi){scope.faces.push(new THREE.Face3(a,b,c,null,null,mi))}function f4(scope,a,b,c,d,mi){scope.faces.push(new THREE.Face4(a,b,c,d,null,null,mi))}function f3n(scope,normals,a,b,c,mi,na,nb,nc){var nax=normals[na*3],nay=normals[na*3+1],naz=normals[na*3+2],nbx=normals[nb*3],nby=normals[nb*3+1],nbz=normals[nb*3+2],ncx=normals[nc*3],ncy=normals[nc*3+1],ncz=normals[nc*3+2];scope.faces.push(new THREE.Face3(a,b,c,[new THREE.Vector3(nax,nay,naz),new THREE.Vector3(nbx,nby,nbz),new THREE.Vector3(ncx,ncy,ncz)],null,mi))}function f4n(scope,normals,a,b,c,d,mi,na,nb,nc,nd){var nax=normals[na*3],nay=normals[na*3+1],naz=normals[na*3+2],nbx=normals[nb*3],nby=normals[nb*3+1],nbz=normals[nb*3+2],ncx=normals[nc*3],ncy=normals[nc*3+1],ncz=normals[nc*3+2],ndx=normals[nd*3],ndy=normals[nd*3+1],ndz=normals[nd*3+2];scope.faces.push(new THREE.Face4(a,b,c,d,[new THREE.Vector3(nax,nay,naz),new THREE.Vector3(nbx,nby,nbz),new THREE.Vector3(ncx,ncy,ncz),new THREE.Vector3(ndx,ndy,ndz)],null,mi))}function uv3(where,u1,v1,u2,v2,u3,v3){where.push([new THREE.Vector2(u1,v1),new THREE.Vector2(u2,v2),new THREE.Vector2(u3,v3)])}function uv4(where,u1,v1,u2,v2,u3,v3,u4,v4){where.push([new THREE.Vector2(u1,v1),new THREE.Vector2(u2,v2),new THREE.Vector2(u3,v3),new THREE.Vector2(u4,v4)])}Model.prototype=Object.create(THREE.Geometry.prototype);var geometry=new Model(texturePath);var materials=this.initMaterials(jsonMaterials,texturePath);if(this.needsTangents(materials))geometry.computeTangents();callback(geometry,materials)};THREE.ColladaLoader=function(){var COLLADA=null;var scene=null;var daeScene;var readyCallbackFunc=null;var sources={};var images={};var animations={};var controllers={};var geometries={};var materials={};var effects={};var cameras={};var lights={};var animData;var visualScenes;var baseUrl;var morphs;var skins;var flip_uv=true;var preferredShading=THREE.SmoothShading;var options={centerGeometry:false,convertUpAxis:true,subdivideFaces:true,upAxis:"Y",defaultEnvMap:null,loadTextures:false};var colladaUnit=1;var colladaUp="Y";var upConversion=null;function load(url,readyCallback,progressCallback){var length=0;if(document.implementation&&document.implementation.createDocument){var request=new XMLHttpRequest;request.onreadystatechange=function(){if(request.readyState===4){if(request.status===0||request.status===200){if(request.responseXML){readyCallbackFunc=readyCallback;parse(request.responseXML,undefined,url)}else if(request.responseText){readyCallbackFunc=readyCallback;var xmlParser=new DOMParser;var responseXML=xmlParser.parseFromString(request.responseText,"application/xml");parse(responseXML,undefined,url)}else{console.error("ColladaLoader: Empty or non-existing file ("+url+")")}}}else if(request.readyState===3){if(progressCallback){if(length===0){length=request.getResponseHeader("Content-Length")}progressCallback({total:length,loaded:request.responseText.length})}}};request.open("GET",url,true);request.send(null)}else{alert("Don't know how to parse XML!")}}function parse(doc,callBack,url){COLLADA=doc;callBack=callBack||readyCallbackFunc;if(url!==undefined){var parts=url.split("/");parts.pop();baseUrl=(parts.length<1?".":parts.join("/"))+"/"}parseAsset();setUpConversion();images=parseLib("//dae:library_images/dae:image",_Image,"image");materials=parseLib("//dae:library_materials/dae:material",Material,"material");effects=parseLib("//dae:library_effects/dae:effect",Effect,"effect");geometries=parseLib("//dae:library_geometries/dae:geometry",Geometry,"geometry");cameras=parseLib(".//dae:library_cameras/dae:camera",Camera,"camera");lights=parseLib(".//dae:library_lights/dae:light",Light,"light");controllers=parseLib("//dae:library_controllers/dae:controller",Controller,"controller");animations=parseLib("//dae:library_animations/dae:animation",Animation,"animation");visualScenes=parseLib(".//dae:library_visual_scenes/dae:visual_scene",VisualScene,"visual_scene");morphs=[];skins=[];daeScene=parseScene();scene=new THREE.Object3D;for(var i=0;i<daeScene.nodes.length;i++){scene.add(createSceneGraph(daeScene.nodes[i]))}createAnimations();var result={scene:scene,morphs:morphs,skins:skins,animations:animData,dae:{images:images,materials:materials,cameras:cameras,effects:effects,geometries:geometries,controllers:controllers,animations:animations,visualScenes:visualScenes,scene:daeScene}};if(callBack){callBack(result)}return result}function setPreferredShading(shading){preferredShading=shading}function parseAsset(){var elements=COLLADA.evaluate("//dae:asset",COLLADA,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var element=elements.iterateNext();if(element&&element.childNodes){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"unit":var meter=child.getAttribute("meter");if(meter){colladaUnit=parseFloat(meter)}break;case"up_axis":colladaUp=child.textContent.charAt(0);break}}}}function parseLib(q,classSpec,prefix){var elements=COLLADA.evaluate(q,COLLADA,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var lib={};var element=elements.iterateNext();var i=0;while(element){var daeElement=(new classSpec).parse(element);if(!daeElement.id||daeElement.id.length===0)daeElement.id=prefix+i++;lib[daeElement.id]=daeElement;element=elements.iterateNext()}return lib}function parseScene(){var sceneElement=COLLADA.evaluate(".//dae:scene/dae:instance_visual_scene",COLLADA,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(sceneElement){var url=sceneElement.getAttribute("url").replace(/^#/,"");return visualScenes[url.length>0?url:"visual_scene0"]}else{return null}}function createAnimations(){animData=[];recurseHierarchy(scene)}function recurseHierarchy(node){var n=daeScene.getChildById(node.name,true),newData=null;if(n&&n.keys){newData={fps:60,hierarchy:[{node:n,keys:n.keys,sids:n.sids}],node:node,name:"animation_"+node.name,length:0};animData.push(newData);for(var i=0,il=n.keys.length;i<il;i++){newData.length=Math.max(newData.length,n.keys[i].time)}}else{newData={hierarchy:[{keys:[],sids:[]}]}}for(var i=0,il=node.children.length;i<il;i++){var d=recurseHierarchy(node.children[i]);for(var j=0,jl=d.hierarchy.length;j<jl;j++){newData.hierarchy.push({keys:[],sids:[]})}}return newData}function calcAnimationBounds(){var start=1e6;
var end=-start;var frames=0;for(var id in animations){var animation=animations[id];for(var i=0;i<animation.sampler.length;i++){var sampler=animation.sampler[i];sampler.create();start=Math.min(start,sampler.startTime);end=Math.max(end,sampler.endTime);frames=Math.max(frames,sampler.input.length)}}return{start:start,end:end,frames:frames}}function createMorph(geometry,ctrl){var morphCtrl=ctrl instanceof InstanceController?controllers[ctrl.url]:ctrl;if(!morphCtrl||!morphCtrl.morph){console.log("could not find morph controller!");return}var morph=morphCtrl.morph;for(var i=0;i<morph.targets.length;i++){var target_id=morph.targets[i];var daeGeometry=geometries[target_id];if(!daeGeometry.mesh||!daeGeometry.mesh.primitives||!daeGeometry.mesh.primitives.length){continue}var target=daeGeometry.mesh.primitives[0].geometry;if(target.vertices.length===geometry.vertices.length){geometry.morphTargets.push({name:"target_1",vertices:target.vertices})}}geometry.morphTargets.push({name:"target_Z",vertices:geometry.vertices})}function createSkin(geometry,ctrl,applyBindShape){var skinCtrl=controllers[ctrl.url];if(!skinCtrl||!skinCtrl.skin){console.log("could not find skin controller!");return}if(!ctrl.skeleton||!ctrl.skeleton.length){console.log("could not find the skeleton for the skin!");return}var skin=skinCtrl.skin;var skeleton=daeScene.getChildById(ctrl.skeleton[0]);var hierarchy=[];applyBindShape=applyBindShape!==undefined?applyBindShape:true;var bones=[];geometry.skinWeights=[];geometry.skinIndices=[];if(applyBindShape){for(var i=0;i<geometry.vertices.length;i++){geometry.vertices[i].applyMatrix4(skin.bindShapeMatrix)}}}function setupSkeleton(node,bones,frame,parent){node.world=node.world||new THREE.Matrix4;node.world.copy(node.matrix);if(node.channels&&node.channels.length){var channel=node.channels[0];var m=channel.sampler.output[frame];if(m instanceof THREE.Matrix4){node.world.copy(m)}}if(parent){node.world.multiplyMatrices(parent,node.world)}bones.push(node);for(var i=0;i<node.nodes.length;i++){setupSkeleton(node.nodes[i],bones,frame,node.world)}}function setupSkinningMatrices(bones,skin){for(var i=0;i<bones.length;i++){var bone=bones[i];var found=-1;if(bone.type!=="JOINT")continue;for(var j=0;j<skin.joints.length;j++){if(bone.sid===skin.joints[j]){found=j;break}}if(found>=0){var inv=skin.invBindMatrices[found];bone.invBindMatrix=inv;bone.skinningMatrix=new THREE.Matrix4;bone.skinningMatrix.multiplyMatrices(bone.world,inv);bone.weights=[];for(var j=0;j<skin.weights.length;j++){for(var k=0;k<skin.weights[j].length;k++){var w=skin.weights[j][k];if(w.joint===found){bone.weights.push(w)}}}}else{throw"ColladaLoader: Could not find joint '"+bone.sid+"'."}}}function applySkin(geometry,instanceCtrl,frame){var skinController=controllers[instanceCtrl.url];frame=frame!==undefined?frame:40;if(!skinController||!skinController.skin){console.log("ColladaLoader: Could not find skin controller.");return}if(!instanceCtrl.skeleton||!instanceCtrl.skeleton.length){console.log("ColladaLoader: Could not find the skeleton for the skin. ");return}var animationBounds=calcAnimationBounds();var skeleton=daeScene.getChildById(instanceCtrl.skeleton[0],true)||daeScene.getChildBySid(instanceCtrl.skeleton[0],true);var i,j,w,vidx,weight;var v=new THREE.Vector3,o,s;for(i=0;i<geometry.vertices.length;i++){geometry.vertices[i].applyMatrix4(skinController.skin.bindShapeMatrix)}for(frame=0;frame<animationBounds.frames;frame++){var bones=[];var skinned=[];for(i=0;i<geometry.vertices.length;i++){skinned.push(new THREE.Vector3)}setupSkeleton(skeleton,bones,frame);setupSkinningMatrices(bones,skinController.skin);for(i=0;i<bones.length;i++){if(bones[i].type!=="JOINT")continue;for(j=0;j<bones[i].weights.length;j++){w=bones[i].weights[j];vidx=w.index;weight=w.weight;o=geometry.vertices[vidx];s=skinned[vidx];v.x=o.x;v.y=o.y;v.z=o.z;v.applyMatrix4(bones[i].skinningMatrix);s.x+=v.x*weight;s.y+=v.y*weight;s.z+=v.z*weight}}geometry.morphTargets.push({name:"target_"+frame,vertices:skinned})}}function createSceneGraph(node,parent){var obj=new THREE.Object3D;var skinned=false;var skinController;var morphController;var i,j;for(i=0;i<node.controllers.length;i++){var controller=controllers[node.controllers[i].url];switch(controller.type){case"skin":if(geometries[controller.skin.source]){var inst_geom=new InstanceGeometry;inst_geom.url=controller.skin.source;inst_geom.instance_material=node.controllers[i].instance_material;node.geometries.push(inst_geom);skinned=true;skinController=node.controllers[i]}else if(controllers[controller.skin.source]){var second=controllers[controller.skin.source];morphController=second;if(second.morph&&geometries[second.morph.source]){var inst_geom=new InstanceGeometry;inst_geom.url=second.morph.source;inst_geom.instance_material=node.controllers[i].instance_material;node.geometries.push(inst_geom)}}break;case"morph":if(geometries[controller.morph.source]){var inst_geom=new InstanceGeometry;inst_geom.url=controller.morph.source;inst_geom.instance_material=node.controllers[i].instance_material;node.geometries.push(inst_geom);morphController=node.controllers[i]}console.log("ColladaLoader: Morph-controller partially supported.");break;default:break}}var double_sided_materials={};for(i=0;i<node.geometries.length;i++){var instance_geometry=node.geometries[i];var instance_materials=instance_geometry.instance_material;var geometry=geometries[instance_geometry.url];var used_materials={};var used_materials_array=[];var num_materials=0;var first_material;if(geometry){if(!geometry.mesh||!geometry.mesh.primitives)continue;if(obj.name.length===0){obj.name=geometry.id}if(instance_materials){for(j=0;j<instance_materials.length;j++){var instance_material=instance_materials[j];var mat=materials[instance_material.target];var effect_id=mat.instance_effect.url;var shader=effects[effect_id].shader;var material3js=shader.material;if(geometry.doubleSided){if(!(material3js in double_sided_materials)){var _copied_material=material3js.clone();_copied_material.side=THREE.DoubleSide;double_sided_materials[material3js]=_copied_material}material3js=double_sided_materials[material3js]}material3js.opacity=!material3js.opacity?1:material3js.opacity;used_materials[instance_material.symbol]=num_materials;used_materials_array.push(material3js);first_material=material3js;first_material.name=mat.name===null||mat.name===""?mat.id:mat.name;num_materials++}}var mesh;var material=first_material||new THREE.MeshLambertMaterial({color:14540253,shading:THREE.FlatShading,side:geometry.doubleSided?THREE.DoubleSide:THREE.FrontSide});var geom=geometry.mesh.geometry3js;if(num_materials>1){material=new THREE.MeshFaceMaterial(used_materials_array);for(j=0;j<geom.faces.length;j++){var face=geom.faces[j];face.materialIndex=used_materials[face.daeMaterial]}}if(skinController!==undefined){applySkin(geom,skinController);material.morphTargets=true;mesh=new THREE.SkinnedMesh(geom,material,false);mesh.skeleton=skinController.skeleton;mesh.skinController=controllers[skinController.url];mesh.skinInstanceController=skinController;mesh.name="skin_"+skins.length;skins.push(mesh)}else if(morphController!==undefined){createMorph(geom,morphController);material.morphTargets=true;mesh=new THREE.Mesh(geom,material);mesh.name="morph_"+morphs.length;morphs.push(mesh)}else{mesh=new THREE.Mesh(geom,material)}if(node.geometries.length>1){obj.add(mesh)}else{obj=mesh}}}for(i=0;i<node.cameras.length;i++){var instance_camera=node.cameras[i];var cparams=cameras[instance_camera.url];obj=new THREE.PerspectiveCamera(cparams.fov,cparams.aspect_ratio,cparams.znear,cparams.zfar)}for(i=0;i<node.lights.length;i++){var instance_light=node.lights[i];var lparams=lights[instance_light.url];var LightType=THREE[lparams.type]||THREE.PointLight;obj=new LightType;obj.color=lparams.color||(new THREE.Color).setRGB(1,1,1);obj.distance=lparams.distance||100;obj.intensity=lparams.intensity||1}obj.name=node.name||node.id||"";obj.matrix=node.matrix;var props=node.matrix.decompose();obj.position=props[0];obj.quaternion=props[1];obj.useQuaternion=true;obj.scale=props[2];if(options.centerGeometry&&obj.geometry){var delta=THREE.GeometryUtils.center(obj.geometry);delta.multiply(obj.scale);delta.applyQuaternion(obj.quaternion);obj.position.sub(delta)}for(i=0;i<node.nodes.length;i++){obj.add(createSceneGraph(node.nodes[i],node))}return obj}function getJointId(skin,id){for(var i=0;i<skin.joints.length;i++){if(skin.joints[i]===id){return i}}}function getLibraryNode(id){return COLLADA.evaluate(".//dae:library_nodes//dae:node[@id='"+id+"']",COLLADA,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext()}function getChannelsForNode(node){var channels=[];var startTime=1e6;var endTime=-1e6;for(var id in animations){var animation=animations[id];for(var i=0;i<animation.channel.length;i++){var channel=animation.channel[i];var sampler=animation.sampler[i];var id=channel.target.split("/")[0];if(id===node.id){sampler.create();channel.sampler=sampler;startTime=Math.min(startTime,sampler.startTime);endTime=Math.max(endTime,sampler.endTime);channels.push(channel)}}}if(channels.length){node.startTime=startTime;node.endTime=endTime}return channels}function calcFrameDuration(node){var minT=1e7;for(var i=0;i<node.channels.length;i++){var sampler=node.channels[i].sampler;for(var j=0;j<sampler.input.length-1;j++){var t0=sampler.input[j];var t1=sampler.input[j+1];minT=Math.min(minT,t1-t0)}}return minT}function calcMatrixAt(node,t){var animated={};var i,j;for(i=0;i<node.channels.length;i++){var channel=node.channels[i];animated[channel.sid]=channel}var matrix=new THREE.Matrix4;for(i=0;i<node.transforms.length;i++){var transform=node.transforms[i];var channel=animated[transform.sid];if(channel!==undefined){var sampler=channel.sampler;var value;for(j=0;j<sampler.input.length-1;j++){if(sampler.input[j+1]>t){value=sampler.output[j];break}}if(value!==undefined){if(value instanceof THREE.Matrix4){matrix.multiplyMatrices(matrix,value)}else{matrix.multiplyMatrices(matrix,transform.matrix)}}else{matrix.multiplyMatrices(matrix,transform.matrix)}}else{matrix.multiplyMatrices(matrix,transform.matrix)}}return matrix}function bakeAnimations(node){if(node.channels&&node.channels.length){var keys=[],sids=[];for(var i=0,il=node.channels.length;i<il;i++){var channel=node.channels[i],fullSid=channel.fullSid,sampler=channel.sampler,input=sampler.input,transform=node.getTransformBySid(channel.sid),member;if(channel.arrIndices){member=[];for(var j=0,jl=channel.arrIndices.length;j<jl;j++){member[j]=getConvertedIndex(channel.arrIndices[j])}}else{member=getConvertedMember(channel.member)}if(transform){if(sids.indexOf(fullSid)===-1){sids.push(fullSid)}for(var j=0,jl=input.length;j<jl;j++){var time=input[j],data=sampler.getData(transform.type,j),key=findKey(keys,time);if(!key){key=new Key(time);var timeNdx=findTimeNdx(keys,time);keys.splice(timeNdx===-1?keys.length:timeNdx,0,key)}key.addTarget(fullSid,transform,member,data)}}}for(var i=0;i<sids.length;i++){var sid=sids[i];for(var j=0;j<keys.length;j++){var key=keys[j];if(!key.hasTarget(sid)){interpolateKeys(keys,key,j,sid)}}}node.keys=keys;node.sids=sids}}function findKey(keys,time){var retVal=null;for(var i=0,il=keys.length;i<il&&retVal===null;i++){var key=keys[i];if(key.time===time){retVal=key}else if(key.time>time){break}}return retVal}function findTimeNdx(keys,time){var ndx=-1;for(var i=0,il=keys.length;i<il&&ndx===-1;i++){var key=keys[i];if(key.time>=time){ndx=i}}return ndx}function interpolateKeys(keys,key,ndx,fullSid){var prevKey=getPrevKeyWith(keys,fullSid,ndx?ndx-1:0),nextKey=getNextKeyWith(keys,fullSid,ndx+1);if(prevKey&&nextKey){var scale=(key.time-prevKey.time)/(nextKey.time-prevKey.time),prevTarget=prevKey.getTarget(fullSid),nextData=nextKey.getTarget(fullSid).data,prevData=prevTarget.data,data;if(prevTarget.type==="matrix"){data=prevData}else if(prevData.length){data=[];for(var i=0;i<prevData.length;++i){data[i]=prevData[i]+(nextData[i]-prevData[i])*scale}}else{data=prevData+(nextData-prevData)*scale}key.addTarget(fullSid,prevTarget.transform,prevTarget.member,data)}}function getNextKeyWith(keys,fullSid,ndx){for(;ndx<keys.length;ndx++){var key=keys[ndx];if(key.hasTarget(fullSid)){return key}}return null}function getPrevKeyWith(keys,fullSid,ndx){ndx=ndx>=0?ndx:ndx+keys.length;for(;ndx>=0;ndx--){var key=keys[ndx];if(key.hasTarget(fullSid)){return key}}return null}function _Image(){this.id="";this.init_from=""}_Image.prototype.parse=function(element){this.id=element.getAttribute("id");for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeName==="init_from"){this.init_from=child.textContent}}return this};function Controller(){this.id="";this.name="";this.type="";this.skin=null;this.morph=null}Controller.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");this.type="none";for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"skin":this.skin=(new Skin).parse(child);this.type=child.nodeName;break;case"morph":this.morph=(new Morph).parse(child);this.type=child.nodeName;break;default:break}}return this};function Morph(){this.method=null;this.source=null;this.targets=null;this.weights=null}Morph.prototype.parse=function(element){var sources={};var inputs=[];var i;this.method=element.getAttribute("method");this.source=element.getAttribute("source").replace(/^#/,"");for(i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"source":var source=(new Source).parse(child);sources[source.id]=source;break;case"targets":inputs=this.parseInputs(child);break;default:console.log(child.nodeName);break}}for(i=0;i<inputs.length;i++){var input=inputs[i];var source=sources[input.source];switch(input.semantic){case"MORPH_TARGET":this.targets=source.read();break;case"MORPH_WEIGHT":this.weights=source.read();break;default:break}}return this};Morph.prototype.parseInputs=function(element){var inputs=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"input":inputs.push((new Input).parse(child));break;default:break}}return inputs};function Skin(){this.source="";this.bindShapeMatrix=null;this.invBindMatrices=[];this.joints=[];this.weights=[]}Skin.prototype.parse=function(element){var sources={};var joints,weights;this.source=element.getAttribute("source").replace(/^#/,"");this.invBindMatrices=[];this.joints=[];this.weights=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"bind_shape_matrix":var f=_floats(child.textContent);this.bindShapeMatrix=getConvertedMat4(f);break;case"source":var src=(new Source).parse(child);sources[src.id]=src;break;case"joints":joints=child;break;case"vertex_weights":weights=child;break;default:console.log(child.nodeName);break}}this.parseJoints(joints,sources);this.parseWeights(weights,sources);return this};Skin.prototype.parseJoints=function(element,sources){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"input":var input=(new Input).parse(child);var source=sources[input.source];if(input.semantic==="JOINT"){this.joints=source.read()}else if(input.semantic==="INV_BIND_MATRIX"){this.invBindMatrices=source.read()}break;default:break}}};Skin.prototype.parseWeights=function(element,sources){var v,vcount,inputs=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"input":inputs.push((new Input).parse(child));break;case"v":v=_ints(child.textContent);break;case"vcount":vcount=_ints(child.textContent);break;default:break}}var index=0;for(var i=0;i<vcount.length;i++){var numBones=vcount[i];var vertex_weights=[];for(var j=0;j<numBones;j++){var influence={};for(var k=0;k<inputs.length;k++){var input=inputs[k];var value=v[index+input.offset];switch(input.semantic){case"JOINT":influence.joint=value;break;case"WEIGHT":influence.weight=sources[input.source].data[value];break;default:break}}vertex_weights.push(influence);index+=inputs.length}for(var j=0;j<vertex_weights.length;j++){vertex_weights[j].index=i}this.weights.push(vertex_weights)}};function VisualScene(){this.id="";this.name="";this.nodes=[];this.scene=new THREE.Object3D}VisualScene.prototype.getChildById=function(id,recursive){for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i].getChildById(id,recursive);if(node){return node}}return null};VisualScene.prototype.getChildBySid=function(sid,recursive){for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i].getChildBySid(sid,recursive);if(node){return node}}return null};VisualScene.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");this.nodes=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"node":this.nodes.push((new Node).parse(child));break;default:break}}return this};function Node(){this.id="";this.name="";this.sid="";this.nodes=[];this.controllers=[];this.transforms=[];this.geometries=[];this.channels=[];this.matrix=new THREE.Matrix4}Node.prototype.getChannelForTransform=function(transformSid){for(var i=0;i<this.channels.length;i++){var channel=this.channels[i];var parts=channel.target.split("/");var id=parts.shift();var sid=parts.shift();var dotSyntax=sid.indexOf(".")>=0;var arrSyntax=sid.indexOf("(")>=0;var arrIndices;var member;if(dotSyntax){parts=sid.split(".");sid=parts.shift();member=parts.shift()}else if(arrSyntax){arrIndices=sid.split("(");sid=arrIndices.shift();for(var j=0;j<arrIndices.length;j++){arrIndices[j]=parseInt(arrIndices[j].replace(/\)/,""),10)}}if(sid===transformSid){channel.info={sid:sid,dotSyntax:dotSyntax,arrSyntax:arrSyntax,arrIndices:arrIndices};return channel}}return null};Node.prototype.getChildById=function(id,recursive){if(this.id===id){return this}if(recursive){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(id,recursive);if(n){return n}}}return null};Node.prototype.getChildBySid=function(sid,recursive){if(this.sid===sid){return this}if(recursive){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(sid,recursive);if(n){return n}}}return null};Node.prototype.getTransformBySid=function(sid){for(var i=0;i<this.transforms.length;i++){if(this.transforms[i].sid===sid)return this.transforms[i]}return null};Node.prototype.parse=function(element){var url;this.id=element.getAttribute("id");this.sid=element.getAttribute("sid");this.name=element.getAttribute("name");this.type=element.getAttribute("type");this.type=this.type==="JOINT"?this.type:"NODE";this.nodes=[];this.transforms=[];this.geometries=[];this.cameras=[];this.controllers=[];this.lights=[];this.matrix=new THREE.Matrix4;for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"node":this.nodes.push((new Node).parse(child));break;case"instance_camera":this.cameras.push((new InstanceCamera).parse(child));break;case"instance_controller":this.controllers.push((new InstanceController).parse(child));break;case"instance_geometry":this.geometries.push((new InstanceGeometry).parse(child));break;case"instance_light":this.lights.push((new InstanceLight).parse(child));break;case"instance_node":url=child.getAttribute("url").replace(/^#/,"");var iNode=getLibraryNode(url);if(iNode){this.nodes.push((new Node).parse(iNode))}break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new Transform).parse(child));break;case"extra":break;default:console.log(child.nodeName);break}}this.channels=getChannelsForNode(this);bakeAnimations(this);this.updateMatrix();return this};Node.prototype.updateMatrix=function(){this.matrix.identity();for(var i=0;i<this.transforms.length;i++){this.transforms[i].apply(this.matrix)}};function Transform(){this.sid="";this.type="";this.data=[];this.obj=null}Transform.prototype.parse=function(element){this.sid=element.getAttribute("sid");this.type=element.nodeName;this.data=_floats(element.textContent);this.convert();return this};Transform.prototype.convert=function(){switch(this.type){case"matrix":this.obj=getConvertedMat4(this.data);break;case"rotate":fixCoords(this.data,-1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);this.angle=THREE.Math.degToRad(this.data[3]);break;case"translate":fixCoords(this.data,-1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":fixCoords(this.data,1);this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type);break}};Transform.prototype.apply=function(){var m1=new THREE.Matrix4;return function(matrix){switch(this.type){case"matrix":matrix.multiply(this.obj);break;case"translate":matrix.multiply(m1.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":matrix.multiply(m1.makeRotationAxis(this.obj,this.angle));break;case"scale":matrix.scale(this.obj);break}}}();Transform.prototype.update=function(data,member){var members=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!member){this.obj.copy(data)}else if(member.length===1){switch(member[0]){case 0:this.obj.n11=data[0];this.obj.n21=data[1];this.obj.n31=data[2];this.obj.n41=data[3];break;case 1:this.obj.n12=data[0];this.obj.n22=data[1];this.obj.n32=data[2];this.obj.n42=data[3];break;case 2:this.obj.n13=data[0];this.obj.n23=data[1];this.obj.n33=data[2];this.obj.n43=data[3];break;case 3:this.obj.n14=data[0];this.obj.n24=data[1];this.obj.n34=data[2];this.obj.n44=data[3];break}}else if(member.length===2){var propName="n"+(member[0]+1)+(member[1]+1);this.obj[propName]=data}else{console.log("Incorrect addressing of matrix in transform.")}break;case"translate":case"scale":if(Object.prototype.toString.call(member)==="[object Array]"){member=members[member[0]]}switch(member){case"X":this.obj.x=data;break;case"Y":this.obj.y=data;break;case"Z":this.obj.z=data;break;default:this.obj.x=data[0];this.obj.y=data[1];this.obj.z=data[2];break}break;case"rotate":if(Object.prototype.toString.call(member)==="[object Array]"){member=members[member[0]]}switch(member){case"X":this.obj.x=data;break;case"Y":this.obj.y=data;break;case"Z":this.obj.z=data;break;case"ANGLE":this.angle=THREE.Math.degToRad(data);break;default:this.obj.x=data[0];this.obj.y=data[1];this.obj.z=data[2];this.angle=THREE.Math.degToRad(data[3]);break}break}};function InstanceController(){this.url="";this.skeleton=[];this.instance_material=[]}InstanceController.prototype.parse=function(element){this.url=element.getAttribute("url").replace(/^#/,"");this.skeleton=[];this.instance_material=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"skeleton":this.skeleton.push(child.textContent.replace(/^#/,""));break;case"bind_material":var instances=COLLADA.evaluate(".//dae:instance_material",child,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(instances){var instance=instances.iterateNext();while(instance){this.instance_material.push((new InstanceMaterial).parse(instance));instance=instances.iterateNext()}}break;case"extra":break;default:break}}return this};function InstanceMaterial(){this.symbol="";this.target=""}InstanceMaterial.prototype.parse=function(element){this.symbol=element.getAttribute("symbol");this.target=element.getAttribute("target").replace(/^#/,"");return this};function InstanceGeometry(){this.url="";this.instance_material=[]}InstanceGeometry.prototype.parse=function(element){this.url=element.getAttribute("url").replace(/^#/,"");this.instance_material=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;if(child.nodeName==="bind_material"){var instances=COLLADA.evaluate(".//dae:instance_material",child,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(instances){var instance=instances.iterateNext();while(instance){this.instance_material.push((new InstanceMaterial).parse(instance));instance=instances.iterateNext()}}break}}return this};function InstanceLight(){this.url=""}InstanceLight.prototype.parse=function(element){this.url=element.getAttribute("url").replace(/^#/,"");return this};function Light(){this.id=""}Light.prototype.parse=function(element){this.id=element.getAttribute("id");for(var i=0;i<element.childNodes.length;i++){var technique=element.childNodes[i];if(technique.nodeType!==1)continue;this.technique=technique.nodeName;for(var j=0;j<technique.childNodes.length;j++){var lightType=technique.childNodes[j];if(lightType.nodeType!==1)continue;this.type=lightType.nodeName.substr(0,1).toUpperCase()+lightType.nodeName.substr(1).toLowerCase()+"Light";for(var k=0;k<lightType.childNodes.length;k++){var child=lightType.childNodes[k];if(child.nodeType!==1)continue;switch(child.nodeName){case"color":var rgba=_floats(child.textContent);this.color=(new THREE.Color).setRGB(rgba[0],rgba[1],rgba[2]);break;default:this[child.nodeName]=parseFloat(child.textContent);break}}}}return this};function Geometry(){this.id="";this.mesh=null}Geometry.prototype.parse=function(element){this.id=element.getAttribute("id");extractDoubleSided(this,element);for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"mesh":this.mesh=new Mesh(this).parse(child);break;case"extra":break;default:break}}return this};function Mesh(geometry){this.geometry=geometry.id;this.primitives=[];this.vertices=null;this.geometry3js=null}Mesh.prototype.parse=function(element){this.primitives=[];var i,j;for(i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"source":_source(child);break;case"vertices":this.vertices=(new Vertices).parse(child);break;case"triangles":this.primitives.push((new Triangles).parse(child));break;case"polygons":this.primitives.push((new Polygons).parse(child));break;case"polylist":this.primitives.push((new Polylist).parse(child));break;default:break}}this.geometry3js=new THREE.Geometry;var vertexData=sources[this.vertices.input["POSITION"].source].data;for(i=0;i<vertexData.length;i+=3){this.geometry3js.vertices.push(getConvertedVec3(vertexData,i).clone())}for(i=0;i<this.primitives.length;i++){var primitive=this.primitives[i];primitive.setVertices(this.vertices);this.handlePrimitive(primitive,this.geometry3js)}this.geometry3js.computeCentroids();this.geometry3js.computeFaceNormals();if(this.geometry3js.calcNormals){this.geometry3js.computeVertexNormals();delete this.geometry3js.calcNormals}this.geometry3js.computeBoundingBox();return this};Mesh.prototype.handlePrimitive=function(primitive,geom){var j,k,pList=primitive.p,inputs=primitive.inputs;var input,index,idx32;var source,numParams;var vcIndex=0,vcount=3,maxOffset=0;var texture_sets=[];for(j=0;j<inputs.length;j++){input=inputs[j];var offset=input.offset+1;maxOffset=maxOffset<offset?offset:maxOffset;switch(input.semantic){case"TEXCOORD":texture_sets.push(input.set);break}}for(var pCount=0;pCount<pList.length;++pCount){var p=pList[pCount],i=0;while(i<p.length){var vs=[];var ns=[];var ts=null;var cs=[];if(primitive.vcount){vcount=primitive.vcount.length?primitive.vcount[vcIndex++]:primitive.vcount}else{vcount=p.length/maxOffset}for(j=0;j<vcount;j++){for(k=0;k<inputs.length;k++){input=inputs[k];source=sources[input.source];index=p[i+j*maxOffset+input.offset];numParams=source.accessor.params.length;idx32=index*numParams;switch(input.semantic){case"VERTEX":vs.push(index);break;case"NORMAL":ns.push(getConvertedVec3(source.data,idx32));break;case"TEXCOORD":ts=ts||{};if(ts[input.set]===undefined)ts[input.set]=[];ts[input.set].push(new THREE.Vector2(source.data[idx32],source.data[idx32+1]));break;case"COLOR":cs.push((new THREE.Color).setRGB(source.data[idx32],source.data[idx32+1],source.data[idx32+2]));break;default:break}}}if(ns.length===0){input=this.vertices.input.NORMAL;if(input){source=sources[input.source];numParams=source.accessor.params.length;for(var ndx=0,len=vs.length;ndx<len;ndx++){ns.push(getConvertedVec3(source.data,vs[ndx]*numParams))}}else{geom.calcNormals=true}}if(!ts){ts={};input=this.vertices.input.TEXCOORD;if(input){texture_sets.push(input.set);source=sources[input.source];numParams=source.accessor.params.length;for(var ndx=0,len=vs.length;ndx<len;ndx++){idx32=vs[ndx]*numParams;if(ts[input.set]===undefined)ts[input.set]=[];ts[input.set].push(new THREE.Vector2(source.data[idx32],1-source.data[idx32+1]))}}}if(cs.length===0){input=this.vertices.input.COLOR;if(input){source=sources[input.source];numParams=source.accessor.params.length;for(var ndx=0,len=vs.length;ndx<len;ndx++){idx32=vs[ndx]*numParams;cs.push((new THREE.Color).setRGB(source.data[idx32],source.data[idx32+1],source.data[idx32+2]))}}}var face=null,faces=[],uv,uvArr;if(vcount===3){faces.push(new THREE.Face3(vs[0],vs[1],vs[2],ns,cs.length?cs:new THREE.Color))}else if(vcount===4){faces.push(new THREE.Face4(vs[0],vs[1],vs[2],vs[3],ns,cs.length?cs:new THREE.Color))}else if(vcount>4&&options.subdivideFaces){var clr=cs.length?cs:new THREE.Color,vec1,vec2,vec3,v1,v2,norm;for(k=1;k<vcount-1;){faces.push(new THREE.Face3(vs[0],vs[k],vs[k+1],[ns[0],ns[k++],ns[k]],clr))}}if(faces.length){for(var ndx=0,len=faces.length;ndx<len;ndx++){face=faces[ndx];face.daeMaterial=primitive.material;geom.faces.push(face);for(k=0;k<texture_sets.length;k++){uv=ts[texture_sets[k]];if(vcount>4){uvArr=[uv[0],uv[ndx+1],uv[ndx+2]]}else if(vcount===4){uvArr=[uv[0],uv[1],uv[2],uv[3]]}else{uvArr=[uv[0],uv[1],uv[2]]}if(!geom.faceVertexUvs[k]){geom.faceVertexUvs[k]=[]}geom.faceVertexUvs[k].push(uvArr)}}}else{console.log("dropped face with vcount "+vcount+" for geometry with id: "+geom.id)}i+=maxOffset*vcount}}};function Polygons(){this.material="";this.count=0;this.inputs=[];this.vcount=null;this.p=[];this.geometry=new THREE.Geometry}Polygons.prototype.setVertices=function(vertices){for(var i=0;i<this.inputs.length;i++){if(this.inputs[i].source===vertices.id){this.inputs[i].source=vertices.input["POSITION"].source}}};Polygons.prototype.parse=function(element){this.material=element.getAttribute("material");this.count=_attr_as_int(element,"count",0);for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"input":this.inputs.push((new Input).parse(element.childNodes[i]));break;case"vcount":this.vcount=_ints(child.textContent);break;case"p":this.p.push(_ints(child.textContent));break;case"ph":console.warn("polygon holes not yet supported!");break;default:break}}return this};function Polylist(){Polygons.call(this);this.vcount=[]}Polylist.prototype=Object.create(Polygons.prototype);function Triangles(){Polygons.call(this);this.vcount=3}Triangles.prototype=Object.create(Polygons.prototype);function Accessor(){this.source="";this.count=0;this.stride=0;this.params=[]}Accessor.prototype.parse=function(element){this.params=[];this.source=element.getAttribute("source");this.count=_attr_as_int(element,"count",0);this.stride=_attr_as_int(element,"stride",0);for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeName==="param"){var param={};param["name"]=child.getAttribute("name");param["type"]=child.getAttribute("type");this.params.push(param)}}return this};function Vertices(){this.input={}}Vertices.prototype.parse=function(element){this.id=element.getAttribute("id");for(var i=0;i<element.childNodes.length;i++){if(element.childNodes[i].nodeName==="input"){var input=(new Input).parse(element.childNodes[i]);this.input[input.semantic]=input}}return this};function Input(){this.semantic="";this.offset=0;this.source="";this.set=0}Input.prototype.parse=function(element){this.semantic=element.getAttribute("semantic");
this.source=element.getAttribute("source").replace(/^#/,"");this.set=_attr_as_int(element,"set",-1);this.offset=_attr_as_int(element,"offset",0);if(this.semantic==="TEXCOORD"&&this.set<0){this.set=0}return this};function Source(id){this.id=id;this.type=null}Source.prototype.parse=function(element){this.id=element.getAttribute("id");for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"bool_array":this.data=_bools(child.textContent);this.type=child.nodeName;break;case"float_array":this.data=_floats(child.textContent);this.type=child.nodeName;break;case"int_array":this.data=_ints(child.textContent);this.type=child.nodeName;break;case"IDREF_array":case"Name_array":this.data=_strings(child.textContent);this.type=child.nodeName;break;case"technique_common":for(var j=0;j<child.childNodes.length;j++){if(child.childNodes[j].nodeName==="accessor"){this.accessor=(new Accessor).parse(child.childNodes[j]);break}}break;default:break}}return this};Source.prototype.read=function(){var result=[];var param=this.accessor.params[0];switch(param.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var j=0;j<this.data.length;j+=16){var s=this.data.slice(j,j+16);var m=getConvertedMat4(s);result.push(m)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+param.type+".");break}return result};function Material(){this.id="";this.name="";this.instance_effect=null}Material.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");for(var i=0;i<element.childNodes.length;i++){if(element.childNodes[i].nodeName==="instance_effect"){this.instance_effect=(new InstanceEffect).parse(element.childNodes[i]);break}}return this};function ColorOrTexture(){this.color=new THREE.Color(0);var randomizer=new Alea;this.color.setRGB(randomizer(),randomizer(),randomizer());this.color.a=1;this.texture=null;this.texcoord=null;this.texOpts=null}ColorOrTexture.prototype.isColor=function(){return this.texture===null};ColorOrTexture.prototype.isTexture=function(){return this.texture!==null};ColorOrTexture.prototype.parse=function(element){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"color":var rgba=_floats(child.textContent);this.color=new THREE.Color(0);this.color.setRGB(rgba[0],rgba[1],rgba[2]);this.color.a=rgba[3];break;case"texture":this.texture=child.getAttribute("texture");this.texcoord=child.getAttribute("texcoord");this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1};this.parseTexture(child);break;default:break}}return this};ColorOrTexture.prototype.parseTexture=function(element){if(!element.childNodes)return this;if(element.childNodes[1]&&element.childNodes[1].nodeName==="extra"){element=element.childNodes[1];if(element.childNodes[1]&&element.childNodes[1].nodeName==="technique"){element=element.childNodes[1]}}for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];switch(child.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[child.nodeName]=parseFloat(child.textContent);break;case"wrapU":case"wrapV":this.texOpts[child.nodeName]=parseInt(child.textContent,10);break;default:this.texOpts[child.nodeName]=child.textContent;break}}return this};function Shader(type,effect){this.type=type;this.effect=effect;this.material=null}Shader.prototype.parse=function(element){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[child.nodeName]=(new ColorOrTexture).parse(child);break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var f=evaluateXPath(child,".//dae:float");if(f.length>0)this[child.nodeName]=parseFloat(f[0].textContent);break;default:break}}this.create();return this};Shader.prototype.create=function(){var props={};var transparent=this["transparency"]!==undefined&&this["transparency"]<1;for(var prop in this){switch(prop){case"ambient":case"emission":case"diffuse":case"specular":var cot=this[prop];if(cot instanceof ColorOrTexture){if(cot.isTexture()){var samplerId=cot.texture;var surfaceId=this.effect.sampler[samplerId].source;if(surfaceId){var surface=this.effect.surface[surfaceId];var image=images[surface.init_from];if(image){if(options.loadTextures){var texture=THREE.ImageUtils.loadTexture(baseUrl+image.init_from);texture.wrapS=cot.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;texture.wrapT=cot.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;texture.offset.x=cot.texOpts.offsetU;texture.offset.y=cot.texOpts.offsetV;texture.repeat.x=cot.texOpts.repeatU;texture.repeat.y=cot.texOpts.repeatV;props["map"]=texture}else{props[prop+"TextureFile"]=image.init_from}if(prop==="emission")props["emissive"]=16777215}}}else if(prop==="diffuse"||!transparent){if(prop==="emission"){props["emissive"]=cot.color.getHex()}else{props[prop]=cot.color.getHex()}}}break;case"shininess":props[prop]=this[prop];break;case"reflectivity":props[prop]=this[prop];if(props[prop]>0)props["envMap"]=options.defaultEnvMap;props["combine"]=THREE.MixOperation;break;case"index_of_refraction":props["refractionRatio"]=this[prop];if(this[prop]!==1)props["envMap"]=options.defaultEnvMap;break;case"transparency":if(transparent){props["transparent"]=true;props["opacity"]=this[prop];transparent=true}break;default:break}}props["shading"]=preferredShading;props["side"]=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide;switch(this.type){case"constant":if(props.emissive!==undefined)props.color=props.emissive;this.material=new THREE.MeshBasicMaterial(props);break;case"phong":case"blinn":if(props.diffuse!==undefined)props.color=props.diffuse;this.material=new THREE.MeshPhongMaterial(props);break;case"lambert":default:if(props.diffuse!==undefined)props.color=props.diffuse;this.material=new THREE.MeshLambertMaterial(props);break}this.material.diffuseTextureFile=props.diffuseTextureFile;this.material.ambientTextureFile=props.ambientTextureFile;this.material.specularTextureFile=props.specularTextureFile;this.material.emissionTextureFile=props.emissionTextureFile;return this.material};function Surface(effect){this.effect=effect;this.init_from=null;this.format=null}Surface.prototype.parse=function(element){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"init_from":this.init_from=child.textContent;break;case"format":this.format=child.textContent;break;default:console.log("unhandled Surface prop: "+child.nodeName);break}}return this};function Sampler2D(effect){this.effect=effect;this.source=null;this.wrap_s=null;this.wrap_t=null;this.minfilter=null;this.magfilter=null;this.mipfilter=null}Sampler2D.prototype.parse=function(element){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"source":this.source=child.textContent;break;case"minfilter":this.minfilter=child.textContent;break;case"magfilter":this.magfilter=child.textContent;break;case"mipfilter":this.mipfilter=child.textContent;break;case"wrap_s":this.wrap_s=child.textContent;break;case"wrap_t":this.wrap_t=child.textContent;break;default:console.log("unhandled Sampler2D prop: "+child.nodeName);break}}return this};function Effect(){this.id="";this.name="";this.shader=null;this.surface={};this.sampler={}}Effect.prototype.create=function(){if(this.shader===null){return null}};Effect.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");extractDoubleSided(this,element);this.shader=null;for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(child));break;default:break}}return this};Effect.prototype.parseNewparam=function(element){var sid=element.getAttribute("sid");for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"surface":this.surface[sid]=new Surface(this).parse(child);break;case"sampler2D":this.sampler[sid]=new Sampler2D(this).parse(child);break;case"extra":break;default:console.log(child.nodeName);break}}};Effect.prototype.parseProfileCOMMON=function(element){var technique;for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"profile_COMMON":this.parseProfileCOMMON(child);break;case"technique":technique=child;break;case"newparam":this.parseNewparam(child);break;case"image":var _image=(new _Image).parse(child);images[_image.id]=_image;break;case"extra":break;default:console.log(child.nodeName);break}}return technique};Effect.prototype.parseTechnique=function(element){for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new Shader(child.nodeName,this).parse(child);break;default:break}}};function InstanceEffect(){this.url=""}InstanceEffect.prototype.parse=function(element){this.url=element.getAttribute("url").replace(/^#/,"");return this};function Animation(){this.id="";this.name="";this.source={};this.sampler=[];this.channel=[]}Animation.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");this.source={};for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"animation":var anim=(new Animation).parse(child);for(var src in anim.source){this.source[src]=anim.source[src]}for(var j=0;j<anim.channel.length;j++){this.channel.push(anim.channel[j]);this.sampler.push(anim.sampler[j])}break;case"source":var src=(new Source).parse(child);this.source[src.id]=src;break;case"sampler":this.sampler.push(new Sampler(this).parse(child));break;case"channel":this.channel.push(new Channel(this).parse(child));break;default:break}}return this};function Channel(animation){this.animation=animation;this.source="";this.target="";this.fullSid=null;this.sid=null;this.dotSyntax=null;this.arrSyntax=null;this.arrIndices=null;this.member=null}Channel.prototype.parse=function(element){this.source=element.getAttribute("source").replace(/^#/,"");this.target=element.getAttribute("target");var parts=this.target.split("/");var id=parts.shift();var sid=parts.shift();var dotSyntax=sid.indexOf(".")>=0;var arrSyntax=sid.indexOf("(")>=0;if(dotSyntax){parts=sid.split(".");this.sid=parts.shift();this.member=parts.shift()}else if(arrSyntax){var arrIndices=sid.split("(");this.sid=arrIndices.shift();for(var j=0;j<arrIndices.length;j++){arrIndices[j]=parseInt(arrIndices[j].replace(/\)/,""),10)}this.arrIndices=arrIndices}else{this.sid=sid}this.fullSid=sid;this.dotSyntax=dotSyntax;this.arrSyntax=arrSyntax;return this};function Sampler(animation){this.id="";this.animation=animation;this.inputs=[];this.input=null;this.output=null;this.strideOut=null;this.interpolation=null;this.startTime=null;this.endTime=null;this.duration=0}Sampler.prototype.parse=function(element){this.id=element.getAttribute("id");this.inputs=[];for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"input":this.inputs.push((new Input).parse(child));break;default:break}}return this};Sampler.prototype.create=function(){for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i];var source=this.animation.source[input.source];switch(input.semantic){case"INPUT":this.input=source.read();break;case"OUTPUT":this.output=source.read();this.strideOut=source.accessor.stride;break;case"INTERPOLATION":this.interpolation=source.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(input.semantic);break}}this.startTime=0;this.endTime=0;this.duration=0;if(this.input.length){this.startTime=1e8;this.endTime=-1e8;for(var i=0;i<this.input.length;i++){this.startTime=Math.min(this.startTime,this.input[i]);this.endTime=Math.max(this.endTime,this.input[i])}this.duration=this.endTime-this.startTime}};Sampler.prototype.getData=function(type,ndx){var data;if(type==="matrix"&&this.strideOut===16){data=this.output[ndx]}else if(this.strideOut>1){data=[];ndx*=this.strideOut;for(var i=0;i<this.strideOut;++i){data[i]=this.output[ndx+i]}if(this.strideOut===3){switch(type){case"rotate":case"translate":fixCoords(data,-1);break;case"scale":fixCoords(data,1);break}}else if(this.strideOut===4&&type==="matrix"){fixCoords(data,-1)}}else{data=this.output[ndx]}return data};function Key(time){this.targets=[];this.time=time}Key.prototype.addTarget=function(fullSid,transform,member,data){this.targets.push({sid:fullSid,member:member,transform:transform,data:data})};Key.prototype.apply=function(opt_sid){for(var i=0;i<this.targets.length;++i){var target=this.targets[i];if(!opt_sid||target.sid===opt_sid){target.transform.update(target.data,target.member)}}};Key.prototype.getTarget=function(fullSid){for(var i=0;i<this.targets.length;++i){if(this.targets[i].sid===fullSid){return this.targets[i]}}return null};Key.prototype.hasTarget=function(fullSid){for(var i=0;i<this.targets.length;++i){if(this.targets[i].sid===fullSid){return true}}return false};Key.prototype.interpolate=function(nextKey,time){for(var i=0;i<this.targets.length;++i){var target=this.targets[i],nextTarget=nextKey.getTarget(target.sid),data;if(target.transform.type!=="matrix"&&nextTarget){var scale=(time-this.time)/(nextKey.time-this.time),nextData=nextTarget.data,prevData=target.data;if(scale<0||scale>1){console.log("Key.interpolate: Warning! Scale out of bounds:"+scale);scale=scale<0?0:1}if(prevData.length){data=[];for(var j=0;j<prevData.length;++j){data[j]=prevData[j]+(nextData[j]-prevData[j])*scale}}else{data=prevData+(nextData-prevData)*scale}}else{data=target.data}target.transform.update(data,target.member)}};function Camera(){this.id="";this.name="";this.technique=""}Camera.prototype.parse=function(element){this.id=element.getAttribute("id");this.name=element.getAttribute("name");for(var i=0;i<element.childNodes.length;i++){var child=element.childNodes[i];if(child.nodeType!==1)continue;switch(child.nodeName){case"optics":this.parseOptics(child);break;default:break}}return this};Camera.prototype.parseOptics=function(element){for(var i=0;i<element.childNodes.length;i++){if(element.childNodes[i].nodeName==="technique_common"){var technique=element.childNodes[i];for(var j=0;j<technique.childNodes.length;j++){this.technique=technique.childNodes[j].nodeName;if(this.technique==="perspective"){var perspective=technique.childNodes[j];for(var k=0;k<perspective.childNodes.length;k++){var param=perspective.childNodes[k];switch(param.nodeName){case"yfov":this.yfov=param.textContent;break;case"xfov":this.xfov=param.textContent;break;case"znear":this.znear=param.textContent;break;case"zfar":this.zfar=param.textContent;break;case"aspect_ratio":this.aspect_ratio=param.textContent;break}}}else if(this.technique==="orthographic"){var orthographic=technique.childNodes[j];for(var k=0;k<orthographic.childNodes.length;k++){var param=orthographic.childNodes[k];switch(param.nodeName){case"xmag":this.xmag=param.textContent;break;case"ymag":this.ymag=param.textContent;break;case"znear":this.znear=param.textContent;break;case"zfar":this.zfar=param.textContent;break;case"aspect_ratio":this.aspect_ratio=param.textContent;break}}}}}}return this};function InstanceCamera(){this.url=""}InstanceCamera.prototype.parse=function(element){this.url=element.getAttribute("url").replace(/^#/,"");return this};function _source(element){var id=element.getAttribute("id");if(sources[id]!==undefined){return sources[id]}sources[id]=new Source(id).parse(element);return sources[id]}function _nsResolver(nsPrefix){if(nsPrefix==="dae"){return"http://www.collada.org/2005/11/COLLADASchema"}return null}function _bools(str){var raw=_strings(str);var data=[];for(var i=0,l=raw.length;i<l;i++){data.push(raw[i]==="true"||raw[i]==="1"?true:false)}return data}function _floats(str){var raw=_strings(str);var data=[];for(var i=0,l=raw.length;i<l;i++){data.push(parseFloat(raw[i]))}return data}function _ints(str){var raw=_strings(str);var data=[];for(var i=0,l=raw.length;i<l;i++){data.push(parseInt(raw[i],10))}return data}function _strings(str){return str.length>0?_trimString(str).split(/\s+/):[]}function _trimString(str){return str.replace(/^\s+/,"").replace(/\s+$/,"")}function _attr_as_float(element,name,defaultValue){if(element.hasAttribute(name)){return parseFloat(element.getAttribute(name))}else{return defaultValue}}function _attr_as_int(element,name,defaultValue){if(element.hasAttribute(name)){return parseInt(element.getAttribute(name),10)}else{return defaultValue}}function _attr_as_string(element,name,defaultValue){if(element.hasAttribute(name)){return element.getAttribute(name)}else{return defaultValue}}function _format_float(f,num){if(f===undefined){var s="0.";while(s.length<num+2){s+="0"}return s}num=num||2;var parts=f.toString().split(".");parts[1]=parts.length>1?parts[1].substr(0,num):"0";while(parts[1].length<num){parts[1]+="0"}return parts.join(".")}function evaluateXPath(node,query){var instances=COLLADA.evaluate(query,node,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var inst=instances.iterateNext();var result=[];while(inst){result.push(inst);inst=instances.iterateNext()}return result}function extractDoubleSided(obj,element){obj.doubleSided=false;var node=COLLADA.evaluate(".//dae:extra//dae:double_sided",element,_nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(node){node=node.iterateNext();if(node&&parseInt(node.textContent,10)===1){obj.doubleSided=true}}}function setUpConversion(){if(!options.convertUpAxis||colladaUp===options.upAxis){upConversion=null}else{switch(colladaUp){case"X":upConversion=options.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":upConversion=options.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":upConversion=options.upAxis==="X"?"ZtoX":"ZtoY";break}}}function fixCoords(data,sign){if(!options.convertUpAxis||colladaUp===options.upAxis){return}switch(upConversion){case"XtoY":var tmp=data[0];data[0]=sign*data[1];data[1]=tmp;break;case"XtoZ":var tmp=data[2];data[2]=data[1];data[1]=data[0];data[0]=tmp;break;case"YtoX":var tmp=data[0];data[0]=data[1];data[1]=sign*tmp;break;case"YtoZ":var tmp=data[1];data[1]=sign*data[2];data[2]=tmp;break;case"ZtoX":var tmp=data[0];data[0]=data[1];data[1]=data[2];data[2]=tmp;break;case"ZtoY":var tmp=data[1];data[1]=data[2];data[2]=sign*tmp;break}}function getConvertedVec3(data,offset){var arr=[data[offset],data[offset+1],data[offset+2]];fixCoords(arr,-1);return new THREE.Vector3(arr[0],arr[1],arr[2])}function getConvertedMat4(data){if(options.convertUpAxis){var arr=[data[0],data[4],data[8]];fixCoords(arr,-1);data[0]=arr[0];data[4]=arr[1];data[8]=arr[2];arr=[data[1],data[5],data[9]];fixCoords(arr,-1);data[1]=arr[0];data[5]=arr[1];data[9]=arr[2];arr=[data[2],data[6],data[10]];fixCoords(arr,-1);data[2]=arr[0];data[6]=arr[1];data[10]=arr[2];arr=[data[0],data[1],data[2]];fixCoords(arr,-1);data[0]=arr[0];data[1]=arr[1];data[2]=arr[2];arr=[data[4],data[5],data[6]];fixCoords(arr,-1);data[4]=arr[0];data[5]=arr[1];data[6]=arr[2];arr=[data[8],data[9],data[10]];fixCoords(arr,-1);data[8]=arr[0];data[9]=arr[1];data[10]=arr[2];arr=[data[3],data[7],data[11]];fixCoords(arr,-1);data[3]=arr[0];data[7]=arr[1];data[11]=arr[2]}return new THREE.Matrix4(data[0],data[1],data[2],data[3],data[4],data[5],data[6],data[7],data[8],data[9],data[10],data[11],data[12],data[13],data[14],data[15])}function getConvertedIndex(index){if(index>-1&&index<3){var members=["X","Y","Z"],indices={X:0,Y:1,Z:2};index=getConvertedMember(members[index]);index=indices[index]}return index}function getConvertedMember(member){if(options.convertUpAxis){switch(member){case"X":switch(upConversion){case"XtoY":case"XtoZ":case"YtoX":member="Y";break;case"ZtoX":member="Z";break}break;case"Y":switch(upConversion){case"XtoY":case"YtoX":case"ZtoX":member="X";break;case"XtoZ":case"YtoZ":case"ZtoY":member="Z";break}break;case"Z":switch(upConversion){case"XtoZ":member="X";break;case"YtoZ":case"ZtoX":case"ZtoY":member="Y";break}break}}return member}return{load:load,parse:parse,setPreferredShading:setPreferredShading,applySkin:applySkin,geometries:geometries,options:options}};THREE.JSONLoader=function(showStatus){THREE.Loader.call(this,showStatus);this.withCredentials=false};THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype);THREE.JSONLoader.prototype.load=function(url,callback,texturePath){var scope=this;texturePath=texturePath&&typeof texturePath==="string"?texturePath:this.extractUrlBase(url);this.onLoadStart();this.loadAjaxJSON(this,url,callback,texturePath)};THREE.JSONLoader.prototype.loadAjaxJSON=function(context,url,callback,texturePath,callbackProgress){var xhr=new XMLHttpRequest;var length=0;xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE){if(xhr.status===200||xhr.status===0){if(xhr.responseText){var json=JSON.parse(xhr.responseText);var result=context.parse(json,texturePath);callback(result.geometry,result.materials)}else{console.warn("THREE.JSONLoader: ["+url+"] seems to be unreachable or file there is empty")}context.onLoadComplete()}else{console.error("THREE.JSONLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}else if(xhr.readyState===xhr.LOADING){if(callbackProgress){if(length===0){length=xhr.getResponseHeader("Content-Length")}callbackProgress({total:length,loaded:xhr.responseText.length})}}else if(xhr.readyState===xhr.HEADERS_RECEIVED){length=xhr.getResponseHeader("Content-Length")}};xhr.open("GET",url,true);xhr.withCredentials=this.withCredentials;xhr.send(null)};THREE.JSONLoader.prototype.parse=function(json,texturePath){var scope=this,geometry=new THREE.Geometry,scale=json.scale!==undefined?1/json.scale:1;parseModel(scale);parseSkin();parseMorphing(scale);geometry.computeCentroids();geometry.computeFaceNormals();function parseModel(scale){function isBitSet(value,position){return value&1<<position}var i,j,fi,offset,zLength,nVertices,colorIndex,normalIndex,uvIndex,materialIndex,type,isQuad,hasMaterial,hasFaceUv,hasFaceVertexUv,hasFaceNormal,hasFaceVertexNormal,hasFaceColor,hasFaceVertexColor,vertex,face,color,normal,uvLayer,uvs,u,v,faces=json.faces,vertices=json.vertices,normals=json.normals,colors=json.colors,nUvLayers=0;for(i=0;i<json.uvs.length;i++){if(json.uvs[i].length)nUvLayers++}for(i=0;i<nUvLayers;i++){geometry.faceUvs[i]=[];geometry.faceVertexUvs[i]=[]}offset=0;zLength=vertices.length;while(offset<zLength){vertex=new THREE.Vector3;vertex.x=vertices[offset++]*scale;vertex.y=vertices[offset++]*scale;vertex.z=vertices[offset++]*scale;geometry.vertices.push(vertex)}offset=0;zLength=faces.length;while(offset<zLength){type=faces[offset++];isQuad=isBitSet(type,0);hasMaterial=isBitSet(type,1);hasFaceUv=isBitSet(type,2);hasFaceVertexUv=isBitSet(type,3);hasFaceNormal=isBitSet(type,4);hasFaceVertexNormal=isBitSet(type,5);hasFaceColor=isBitSet(type,6);hasFaceVertexColor=isBitSet(type,7);if(isQuad){face=new THREE.Face4;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];face.d=faces[offset++];nVertices=4}else{face=new THREE.Face3;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];nVertices=3}if(hasMaterial){materialIndex=faces[offset++];face.materialIndex=materialIndex}fi=geometry.faces.length;if(hasFaceUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];geometry.faceUvs[i][fi]=new THREE.Vector2(u,v)}}if(hasFaceVertexUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvs=[];for(j=0;j<nVertices;j++){uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];uvs[j]=new THREE.Vector2(u,v)}geometry.faceVertexUvs[i][fi]=uvs}}if(hasFaceNormal){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.normal=normal}if(hasFaceVertexNormal){for(i=0;i<nVertices;i++){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.vertexNormals.push(normal)}}if(hasFaceColor){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.color=color}if(hasFaceVertexColor){for(i=0;i<nVertices;i++){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.vertexColors.push(color)}}geometry.faces.push(face)}}function parseSkin(){var i,l,x,y,z,w,a,b,c,d;if(json.skinWeights){for(i=0,l=json.skinWeights.length;i<l;i+=2){x=json.skinWeights[i];y=json.skinWeights[i+1];z=0;w=0;geometry.skinWeights.push(new THREE.Vector4(x,y,z,w))}}if(json.skinIndices){for(i=0,l=json.skinIndices.length;i<l;i+=2){a=json.skinIndices[i];b=json.skinIndices[i+1];c=0;d=0;geometry.skinIndices.push(new THREE.Vector4(a,b,c,d))}}geometry.bones=json.bones;geometry.animation=json.animation}function parseMorphing(scale){if(json.morphTargets!==undefined){var i,l,v,vl,dstVertices,srcVertices;for(i=0,l=json.morphTargets.length;i<l;i++){geometry.morphTargets[i]={};geometry.morphTargets[i].name=json.morphTargets[i].name;geometry.morphTargets[i].vertices=[];dstVertices=geometry.morphTargets[i].vertices;srcVertices=json.morphTargets[i].vertices;for(v=0,vl=srcVertices.length;v<vl;v+=3){var vertex=new THREE.Vector3;vertex.x=srcVertices[v]*scale;vertex.y=srcVertices[v+1]*scale;vertex.z=srcVertices[v+2]*scale;dstVertices.push(vertex)}}}if(json.morphColors!==undefined){var i,l,c,cl,dstColors,srcColors,color;for(i=0,l=json.morphColors.length;i<l;i++){geometry.morphColors[i]={};geometry.morphColors[i].name=json.morphColors[i].name;geometry.morphColors[i].colors=[];dstColors=geometry.morphColors[i].colors;srcColors=json.morphColors[i].colors;for(c=0,cl=srcColors.length;c<cl;c+=3){color=new THREE.Color(16755200);color.setRGB(srcColors[c],srcColors[c+1],srcColors[c+2]);dstColors.push(color)}}}}if(json.materials===undefined){return{geometry:geometry}}else{var materials=this.initMaterials(json.materials,texturePath);if(this.needsTangents(materials)){geometry.computeTangents()}return{geometry:geometry,materials:materials}}};exo.resources.importers.loaders.LoaderUtilities={sceneObjToScene:function(sceneObj){var scene=new THREE.Scene;scene.name=sceneObj.name;_.each(sceneObj.children,function(child){scene.add(child)});return scene}};THREE.PDBLoader=function(showStatus){THREE.Loader.call(this,showStatus)};THREE.PDBLoader.prototype=new THREE.Loader;THREE.PDBLoader.prototype.constructor=THREE.PDBLoader;THREE.PDBLoader.prototype.supr=THREE.Loader.prototype;THREE.PDBLoader.prototype.load=function(url,callback){var worker,scope=this;this.onLoadStart();this.loadAjaxPDB(this,url,callback)};THREE.PDBLoader.prototype.loadAjaxPDB=function(context,url,callback,callbackProgress){var xhr=new XMLHttpRequest;var length=0;xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE){if(xhr.status===200||xhr.status===0){if(xhr.responseText){var json=context.parsePDB(xhr.responseText);context.createModel(json,callback)}else{console.warn("THREE.PDBLoader: ["+url+"] seems to be unreachable or file there is empty")}context.onLoadComplete()}else{console.error("THREE.PDBLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}else if(xhr.readyState===xhr.LOADING){if(callbackProgress){if(length===0){length=xhr.getResponseHeader("Content-Length")}callbackProgress({total:length,loaded:xhr.responseText.length})}}else if(xhr.readyState===xhr.HEADERS_RECEIVED){length=xhr.getResponseHeader("Content-Length")}};xhr.open("GET",url,true);if(xhr.overrideMimeType)xhr.overrideMimeType("text/plain; charset=x-user-defined");xhr.setRequestHeader("Content-Type","text/plain");xhr.send(null)};THREE.PDBLoader.prototype.parsePDB=function(text){function trim(text){return text.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function capitalize(text){return text.charAt(0).toUpperCase()+text.substr(1).toLowerCase()}function hash(s,e){return"s"+Math.min(s,e)+"e"+Math.max(s,e)}function parseBond(start,length){var eatom=parseInt(lines[i].substr(start,length),10);if(eatom){var h=hash(satom,eatom);if(bhash[h]===undefined){bonds.push([satom-1,eatom-1,1]);bhash[h]=bonds.length-1}else{}}}var CPK={h:[255,255,255],he:[217,255,255],li:[204,128,255],be:[194,255,0],b:[255,181,181],c:[144,144,144],n:[48,80,248],o:[255,13,13],f:[144,224,80],ne:[179,227,245],na:[171,92,242],mg:[138,255,0],al:[191,166,166],si:[240,200,160],p:[255,128,0],s:[255,255,48],cl:[31,240,31],ar:[128,209,227],k:[143,64,212],ca:[61,255,0],sc:[230,230,230],ti:[191,194,199],v:[166,166,171],cr:[138,153,199],mn:[156,122,199],fe:[224,102,51],co:[240,144,160],ni:[80,208,80],cu:[200,128,51],zn:[125,128,176],ga:[194,143,143],ge:[102,143,143],as:[189,128,227],se:[255,161,0],br:[166,41,41],kr:[92,184,209],rb:[112,46,176],sr:[0,255,0],y:[148,255,255],zr:[148,224,224],nb:[115,194,201],mo:[84,181,181],tc:[59,158,158],ru:[36,143,143],rh:[10,125,140],pd:[0,105,133],ag:[192,192,192],cd:[255,217,143],"in":[166,117,115],sn:[102,128,128],sb:[158,99,181],te:[212,122,0],i:[148,0,148],xe:[66,158,176],cs:[87,23,143],ba:[0,201,0],la:[112,212,255],ce:[255,255,199],pr:[217,255,199],nd:[199,255,199],pm:[163,255,199],sm:[143,255,199],eu:[97,255,199],gd:[69,255,199],tb:[48,255,199],dy:[31,255,199],ho:[0,255,156],er:[0,230,117],tm:[0,212,82],yb:[0,191,56],lu:[0,171,36],hf:[77,194,255],ta:[77,166,255],w:[33,148,214],re:[38,125,171],os:[38,102,150],ir:[23,84,135],pt:[208,208,224],au:[255,209,35],hg:[184,184,208],tl:[166,84,77],pb:[87,89,97],bi:[158,79,181],po:[171,92,0],at:[117,79,69],rn:[66,130,150],fr:[66,0,102],ra:[0,125,0],ac:[112,171,250],th:[0,186,255],pa:[0,161,255],u:[0,143,255],np:[0,128,255],pu:[0,107,255],am:[84,92,242],cm:[120,92,227],bk:[138,79,227],cf:[161,54,212],es:[179,31,212],fm:[179,31,186],md:[179,13,166],no:[189,13,135],lr:[199,0,102],rf:[204,0,89],db:[209,0,79],sg:[217,0,69],bh:[224,0,56],hs:[230,0,46],mt:[235,0,38],ds:[235,0,38],rg:[235,0,38],cn:[235,0,38],uut:[235,0,38],uuq:[235,0,38],uup:[235,0,38],uuh:[235,0,38],uus:[235,0,38],uuo:[235,0,38]};var atoms=[];var bonds=[];var histogram={};var bhash={};var lines=text.split("\n");var x,y,z,e;for(var i=0,il=lines.length;i<il;++i){if(lines[i].substr(0,4)==="ATOM"||lines[i].substr(0,6)==="HETATM"){x=parseFloat(lines[i].substr(30,7));y=parseFloat(lines[i].substr(38,7));z=parseFloat(lines[i].substr(46,7));e=trim(lines[i].substr(76,2)).toLowerCase();if(e==="")e=trim(lines[i].substr(12,2)).toLowerCase();atoms.push([x,y,z,CPK[e],capitalize(e)]);if(histogram[e]===undefined)histogram[e]=1;else histogram[e]+=1}else if(lines[i].substr(0,6)==="CONECT"){var satom=parseInt(lines[i].substr(6,5),10);parseBond(11,5);parseBond(16,5);parseBond(21,5);parseBond(26,5)}}return{ok:true,atoms:atoms,bonds:bonds,histogram:histogram}};THREE.PDBLoader.prototype.createModel=function(json,callback){var scope=this,geometryAtoms=new THREE.Geometry,geometryBonds=new THREE.Geometry;geometryAtoms.elements=[];var atoms=json.atoms;var bonds=json.bonds;for(var i=0;i<atoms.length;i++){var atom=atoms[i];var x=atom[0];var y=atom[1];var z=atom[2];var position=new THREE.Vector3(x,y,z);geometryAtoms.vertices.push(position);var r=atom[3][0]/255;var g=atom[3][1]/255;var b=atom[3][2]/255;var color=new THREE.Color;color.setRGB(r,g,b);geometryAtoms.colors.push(color);geometryAtoms.elements.push(atom[4])}for(var i=0;i<bonds.length;i++){var bond=bonds[i];var start=bond[0];var end=bond[1];var vertex1=geometryAtoms.vertices[start];var vertex2=geometryAtoms.vertices[end];geometryBonds.vertices.push(vertex1.clone());geometryBonds.vertices.push(vertex2.clone())}callback(geometryAtoms,geometryBonds)};THREE.STLLoader=function(){};THREE.STLLoader.prototype={constructor:THREE.STLLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent};
THREE.STLLoader.prototype.load=function(url,callback){var scope=this;var xhr=new XMLHttpRequest;function onloaded(event){if(event.target.status===200||event.target.status===0){var geometry=scope.parse(event.target.response||event.target.responseText);scope.dispatchEvent({type:"load",content:geometry});if(callback)callback(geometry)}else{scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]",response:event.target.responseText})}}xhr.addEventListener("load",onloaded,false);xhr.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);xhr.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);xhr.overrideMimeType("text/plain; charset=x-user-defined");xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.send(null)};THREE.STLLoader.prototype.parse=function(data){var isBinary=function(){var expect,face_size,n_faces,reader;reader=new DataView(binData);face_size=32/8*3+32/8*3*3+16/8;n_faces=reader.getUint32(80,true);expect=80+32/8+n_faces*face_size;return expect===reader.byteLength};var binData=this.ensureBinary(data);return isBinary()?this.parseBinary(binData):this.parseASCII(this.ensureString(data))};THREE.STLLoader.prototype.parseBinary=function(data){var face,geometry,n_faces,reader,length,normal,i,dataOffset,faceLength,start,vertexstart;reader=new DataView(data);n_faces=reader.getUint32(80,true);geometry=new THREE.Geometry;dataOffset=84;faceLength=12*4+2;for(face=0;face<n_faces;face++){start=dataOffset+face*faceLength;normal=new THREE.Vector3(reader.getFloat32(start,true),reader.getFloat32(start+4,true),reader.getFloat32(start+8,true));for(i=1;i<=3;i++){vertexstart=start+i*12;geometry.vertices.push(new THREE.Vector3(reader.getFloat32(vertexstart,true),reader.getFloat32(vertexstart+4,true),reader.getFloat32(vertexstart+8,true)))}length=geometry.vertices.length;geometry.faces.push(new THREE.Face3(length-3,length-2,length-1,normal))}geometry.computeCentroids();geometry.computeBoundingSphere();return geometry};THREE.STLLoader.prototype.parseASCII=function(data){var geometry,length,normal,patternFace,patternNormal,patternVertex,result,text;geometry=new THREE.Geometry;patternFace=/facet([\s\S]*?)endfacet/g;while((result=patternFace.exec(data))!==null){text=result[0];patternNormal=/normal[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;while((result=patternNormal.exec(text))!==null){normal=new THREE.Vector3(parseFloat(result[1]),parseFloat(result[3]),parseFloat(result[5]))}patternVertex=/vertex[\s]+([\-+]?[0-9]+\.?[0-9]*([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+[\s]+([\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?)+/g;while((result=patternVertex.exec(text))!==null){geometry.vertices.push(new THREE.Vector3(parseFloat(result[1]),parseFloat(result[3]),parseFloat(result[5])))}length=geometry.vertices.length;geometry.faces.push(new THREE.Face3(length-3,length-2,length-1,normal))}geometry.computeCentroids();geometry.computeBoundingBox();geometry.computeBoundingSphere();return geometry};THREE.STLLoader.prototype.ensureString=function(buf){if(typeof buf!=="string"){var array_buffer=new Uint8Array(buf);var str="";for(var i=0;i<buf.byteLength;i++){str+=String.fromCharCode(array_buffer[i])}return str}else{return buf}};THREE.STLLoader.prototype.ensureBinary=function(buf){if(typeof buf==="string"){var array_buffer=new Uint8Array(buf.length);for(var i=0;i<buf.length;i++){array_buffer[i]=buf.charCodeAt(i)&255}return array_buffer.buffer||array_buffer}else{return buf}};if(typeof this.DataView==="undefined"){this.DataView=function(buffer,byteOffset,byteLength){this.buffer=buffer;this.byteOffset=byteOffset||0;this.byteLength=byteLength||buffer.byteLength||buffer.length;this._isString=typeof buffer==="string"};this.DataView.prototype={_getCharCodes:function(buffer,start,length){start=start||0;length=length||buffer.length;var end=start+length;var codes=[];for(var i=start;i<end;i++){codes.push(buffer.charCodeAt(i)&255)}return codes},_getBytes:function(length,byteOffset,littleEndian){var result;if(littleEndian===undefined){littleEndian=this._littleEndian}if(byteOffset===undefined){byteOffset=this.byteOffset}else{byteOffset=this.byteOffset+byteOffset}if(length===undefined){length=this.byteLength-byteOffset}if(typeof byteOffset!=="number"){throw new TypeError("DataView byteOffset is not a number")}if(length<0||byteOffset+length>this.byteLength){throw new Error("DataView length or (byteOffset+length) value is out of bounds")}if(this.isString){result=this._getCharCodes(this.buffer,byteOffset,byteOffset+length)}else{result=this.buffer.slice(byteOffset,byteOffset+length)}if(!littleEndian&&length>1){if(!(result instanceof Array)){result=Array.prototype.slice.call(result)}result.reverse()}return result},getFloat64:function(byteOffset,littleEndian){var b=this._getBytes(8,byteOffset,littleEndian),sign=1-2*(b[7]>>7),exponent=((b[7]<<1&255)<<3|b[6]>>4)-((1<<10)-1),mantissa=(b[6]&15)*Math.pow(2,48)+b[5]*Math.pow(2,40)+b[4]*Math.pow(2,32)+b[3]*Math.pow(2,24)+b[2]*Math.pow(2,16)+b[1]*Math.pow(2,8)+b[0];if(exponent===1024){if(mantissa!==0){return NaN}else{return sign*Infinity}}if(exponent===-1023){return sign*mantissa*Math.pow(2,-1022-52)}return sign*(1+mantissa*Math.pow(2,-52))*Math.pow(2,exponent)},getFloat32:function(byteOffset,littleEndian){var b=this._getBytes(4,byteOffset,littleEndian),sign=1-2*(b[3]>>7),exponent=(b[3]<<1&255|b[2]>>7)-127,mantissa=(b[2]&127)<<16|b[1]<<8|b[0];if(exponent===128){if(mantissa!==0){return NaN}else{return sign*Infinity}}if(exponent===-127){return sign*mantissa*Math.pow(2,-126-23)}return sign*(1+mantissa*Math.pow(2,-23))*Math.pow(2,exponent)},getInt32:function(byteOffset,littleEndian){var b=this._getBytes(4,byteOffset,littleEndian);return b[3]<<24|b[2]<<16|b[1]<<8|b[0]},getUint32:function(byteOffset,littleEndian){return this.getInt32(byteOffset,littleEndian)>>>0},getInt16:function(byteOffset,littleEndian){return this.getUint16(byteOffset,littleEndian)<<16>>16},getUint16:function(byteOffset,littleEndian){var b=this._getBytes(2,byteOffset,littleEndian);return b[1]<<8|b[0]},getInt8:function(byteOffset){return this.getUint8(byteOffset)<<24>>24},getUint8:function(byteOffset){return this._getBytes(1,byteOffset)[0]}}}THREE.SceneLoader=function(){this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){};this.callbackSync=function(){};this.callbackProgress=function(){};this.geometryHandlerMap={};this.hierarchyHandlerMap={};this.addGeometryHandler("ascii",THREE.JSONLoader)};THREE.SceneLoader.prototype.constructor=THREE.SceneLoader;THREE.SceneLoader.prototype.load=function(url,callbackFinished){var scope=this;var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===0){var json=JSON.parse(xhr.responseText);scope.parse(json,callbackFinished,url)}else{console.error("THREE.SceneLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}};xhr.open("GET",url,true);xhr.send(null)};THREE.SceneLoader.prototype.addGeometryHandler=function(typeID,loaderClass){this.geometryHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.addHierarchyHandler=function(typeID,loaderClass){this.hierarchyHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.parse=function(json,callbackFinished,url){var scope=this;var urlBase=THREE.Loader.prototype.extractUrlBase(url);var geometry,material,camera,fog,texture,images,color,light,hex,intensity,counter_models=0,counter_textures=0,total_models=0,total_textures=0,result;var target_array=[];var data=json;for(var typeID in this.geometryHandlerMap){var loaderClass=this.geometryHandlerMap[typeID]["loaderClass"];this.geometryHandlerMap[typeID]["loaderObject"]=new loaderClass}for(var typeID in this.hierarchyHandlerMap){var loaderClass=this.hierarchyHandlerMap[typeID]["loaderClass"];this.hierarchyHandlerMap[typeID]["loaderObject"]=new loaderClass}counter_models=0;counter_textures=0;result={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}};if(data.transform){var position=data.transform.position,rotation=data.transform.rotation,scale=data.transform.scale;if(position)result.scene.position.set(position[0],position[1],position[2]);if(rotation)result.scene.rotation.set(rotation[0],rotation[1],rotation[2]);if(scale)result.scene.scale.set(scale[0],scale[1],scale[2]);if(position||rotation||scale){result.scene.updateMatrix();result.scene.updateMatrixWorld()}}function get_url(source_url,url_type){if(url_type==="relativeToHTML"){return source_url}else{return urlBase+"/"+source_url}}function handle_objects(){handle_children(result.scene,data.objects)}function handle_children(parent,children){var mat,dst,pos,rot,scl,quat;for(var objID in children){if(result.objects[objID]===undefined){var objJSON=children[objID];var object=null;if(objJSON.type&&objJSON.type in scope.hierarchyHandlerMap){if(objJSON.loading===undefined){var reservedTypes={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1};var loaderParameters={};for(var parType in objJSON){if(!(parType in reservedTypes)){loaderParameters[parType]=objJSON[parType]}}material=result.materials[objJSON.material];objJSON.loading=true;var loader=scope.hierarchyHandlerMap[objJSON.type]["loaderObject"];if(loader.options){loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON))}else{loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON),loaderParameters)}}}else if(objJSON.geometry!==undefined){geometry=result.geometries[objJSON.geometry];if(geometry){var needsTangents=false;material=result.materials[objJSON.material];needsTangents=material instanceof THREE.ShaderMaterial;pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;mat=objJSON.matrix;quat=objJSON.quaternion;if(!objJSON.material){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial&&material.materials.length===0){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial){for(var i=0;i<material.materials.length;i++){needsTangents=needsTangents||material.materials[i]instanceof THREE.ShaderMaterial}}if(needsTangents){geometry.computeTangents()}if(objJSON.skin){object=new THREE.SkinnedMesh(geometry,material)}else if(objJSON.morph){object=new THREE.MorphAnimMesh(geometry,material);if(objJSON.duration!==undefined){object.duration=objJSON.duration}if(objJSON.time!==undefined){object.time=objJSON.time}if(objJSON.mirroredLoop!==undefined){object.mirroredLoop=objJSON.mirroredLoop}if(material.morphNormals){geometry.computeMorphNormals()}}else{object=new THREE.Mesh(geometry,material)}object.name=objID;if(mat){object.matrixAutoUpdate=false;object.matrix.set(mat[0],mat[1],mat[2],mat[3],mat[4],mat[5],mat[6],mat[7],mat[8],mat[9],mat[10],mat[11],mat[12],mat[13],mat[14],mat[15])}else{object.position.set(pos[0],pos[1],pos[2]);if(quat){object.quaternion.set(quat[0],quat[1],quat[2],quat[3]);object.useQuaternion=true}else{object.rotation.set(rot[0],rot[1],rot[2])}object.scale.set(scl[0],scl[1],scl[2])}object.visible=objJSON.visible;object.castShadow=objJSON.castShadow;object.receiveShadow=objJSON.receiveShadow;parent.add(object);result.objects[objID]=object}}else if(objJSON.type==="DirectionalLight"||objJSON.type==="PointLight"||objJSON.type==="AmbientLight"){hex=objJSON.color!==undefined?objJSON.color:16777215;intensity=objJSON.intensity!==undefined?objJSON.intensity:1;if(objJSON.type==="DirectionalLight"){pos=objJSON.direction;light=new THREE.DirectionalLight(hex,intensity);light.position.set(pos[0],pos[1],pos[2]);if(objJSON.target){target_array.push({object:light,targetName:objJSON.target});light.target=null}}else if(objJSON.type==="PointLight"){pos=objJSON.position;dst=objJSON.distance;light=new THREE.PointLight(hex,intensity,dst);light.position.set(pos[0],pos[1],pos[2])}else if(objJSON.type==="AmbientLight"){light=new THREE.AmbientLight(0)}parent.add(light);light.name=objID;result.lights[objID]=light;result.objects[objID]=light}else if(objJSON.type==="PerspectiveCamera"||objJSON.type==="OrthographicCamera"){if(objJSON.type==="PerspectiveCamera"){camera=new THREE.PerspectiveCamera(objJSON.fov,objJSON.aspect,objJSON.near,objJSON.far)}else if(objJSON.type==="OrthographicCamera"){camera=new THREE.OrthographicCamera(objJSON.left,objJSON.right,objJSON.top,objJSON.bottom,objJSON.near,objJSON.far)}pos=objJSON.position;camera.position.set(pos[0],pos[1],pos[2]);parent.add(camera);camera.name=objID;result.cameras[objID]=camera;result.objects[objID]=camera}else{pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;quat=objJSON.quaternion;object=new THREE.Object3D;object.name=objID;object.position.set(pos[0],pos[1],pos[2]);if(quat){object.quaternion.set(quat[0],quat[1],quat[2],quat[3]);object.useQuaternion=true}else{object.rotation.set(rot[0],rot[1],rot[2])}object.scale.set(scl[0],scl[1],scl[2]);object.visible=objJSON.visible!==undefined?objJSON.visible:false;parent.add(object);result.objects[objID]=object;result.empties[objID]=object}if(object){if(objJSON.userData!==undefined){for(var key in objJSON.userData){var value=objJSON.userData[key];object.userData[key]=value}}if(objJSON.groups!==undefined){for(var i=0;i<objJSON.groups.length;i++){var groupID=objJSON.groups[i];if(result.groups[groupID]===undefined){result.groups[groupID]=[]}result.groups[groupID].push(objID)}}if(objJSON.children!==undefined){handle_children(object,objJSON.children)}}}}}function handle_mesh(geo,mat,id){result.geometries[id]=geo;result.face_materials[id]=mat;handle_objects()}function handle_hierarchy(node,id,parent,material,obj){var p=obj.position;var r=obj.rotation;var q=obj.quaternion;var s=obj.scale;node.position.set(p[0],p[1],p[2]);if(q){node.quaternion.set(q[0],q[1],q[2],q[3]);node.useQuaternion=true}else{node.rotation.set(r[0],r[1],r[2])}node.scale.set(s[0],s[1],s[2]);if(material){node.traverse(function(child){child.material=material})}var visible=obj.visible!==undefined?obj.visible:true;node.traverse(function(child){child.visible=visible});parent.add(node);node.name=id;result.objects[id]=node;handle_objects()}function create_callback_geometry(id){return function(geo,mat){geo.name=id;handle_mesh(geo,mat,id);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_hierachy(id,parent,material,obj){return function(event){var result;if(event.content){result=event.content}else if(event.dae){result=event.scene}else{result=event}handle_hierarchy(result,id,parent,material,obj);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_embed(id){return function(geo,mat){geo.name=id;result.geometries[id]=geo;result.face_materials[id]=mat;counter_models-=1;async_callback_gate()}}function async_callback_gate(){var progress={totalModels:total_models,totalTextures:total_textures,loadedModels:total_models-counter_models,loadedTextures:total_textures-counter_textures};if(scope.skipTextureLoading){counter_textures=0}scope.callbackProgress(progress,result);scope.onLoadProgress();if(counter_models===0&&counter_textures===0){finalize();callbackFinished(result)}}function finalize(){for(var i=0;i<target_array.length;i++){var ta=target_array[i];var target=result.objects[ta.targetName];if(target){ta.object.target=target}else{ta.object.target=new THREE.Object3D;result.scene.add(ta.object.target)}ta.object.target.userData.targetInverse=ta.object}}var callbackTexture=function(count){counter_textures-=count;async_callback_gate();scope.onLoadComplete()};var generateTextureCallback=function(count){return function(){callbackTexture(count)}};var fogID,fogJSON;for(fogID in data.fogs){fogJSON=data.fogs[fogID];if(fogJSON.type==="linear"){fog=new THREE.Fog(0,fogJSON.near,fogJSON.far)}else if(fogJSON.type==="exp2"){fog=new THREE.FogExp2(0,fogJSON.density)}color=fogJSON.color;fog.color.setRGB(color[0],color[1],color[2]);result.fogs[fogID]=fog}var geoID,geoJSON;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type in this.geometryHandlerMap){counter_models+=1;scope.onLoadStart()}}var objID,objJSON;for(objID in data.objects){objJSON=data.objects[objID];if(objJSON.type&&objJSON.type in this.hierarchyHandlerMap){counter_models+=1;scope.onLoadStart()}}counter_models+=Object.keys(data.embeds).length;total_models=counter_models;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type==="cube"){geometry=new THREE.CubeGeometry(geoJSON.width,geoJSON.height,geoJSON.depth,geoJSON.widthSegments,geoJSON.heightSegments,geoJSON.depthSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="plane"){geometry=new THREE.PlaneGeometry(geoJSON.width,geoJSON.height,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="sphere"){geometry=new THREE.SphereGeometry(geoJSON.radius,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="cylinder"){geometry=new THREE.CylinderGeometry(geoJSON.topRad,geoJSON.botRad,geoJSON.height,geoJSON.radSegs,geoJSON.heightSegs);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="torus"){geometry=new THREE.TorusGeometry(geoJSON.radius,geoJSON.tube,geoJSON.segmentsR,geoJSON.segmentsT);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="icosahedron"){geometry=new THREE.IcosahedronGeometry(geoJSON.radius,geoJSON.subdivisions);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type in this.geometryHandlerMap){var loaderParameters={};for(var parType in geoJSON){if(parType!=="type"&&parType!=="url"){loaderParameters[parType]=geoJSON[parType]}}var loader=this.geometryHandlerMap[geoJSON.type]["loaderObject"];loader.load(get_url(geoJSON.url,data.urlBaseType),create_callback_geometry(geoID),loaderParameters)}else if(geoJSON.type==="embedded"){var modelJson=data.embeds[geoJSON.id],texture_path="";modelJson.metadata=data.metadata;if(modelJson){var jsonLoader=this.geometryHandlerMap["ascii"]["loaderObject"];var model=jsonLoader.parse(modelJson,texture_path);create_callback_embed(geoID)(model.geometry,model.materials)}}}var textureID,textureJSON;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.url instanceof Array){counter_textures+=textureJSON.url.length;for(var n=0;n<textureJSON.url.length;n++){scope.onLoadStart()}}else{counter_textures+=1;scope.onLoadStart()}}total_textures=counter_textures;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.mapping!==undefined&&THREE[textureJSON.mapping]!==undefined){textureJSON.mapping=new THREE[textureJSON.mapping]}if(textureJSON.url instanceof Array){var count=textureJSON.url.length;var url_array=[];for(var i=0;i<count;i++){url_array[i]=get_url(textureJSON.url[i],data.urlBaseType)}var isCompressed=/\.dds$/i.test(url_array[0]);if(!scope.skipTextureLoading){if(isCompressed){texture=THREE.ImageUtils.loadCompressedTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}else{texture=THREE.ImageUtils.loadTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}}else{texture=new THREE.Texture;texture.sourceFile=fullUrl}}else{var isCompressed=/\.dds$/i.test(textureJSON.url);var fullUrl=get_url(textureJSON.url,data.urlBaseType);var textureCallback=generateTextureCallback(1);if(!scope.skipTextureLoading){if(isCompressed){texture=THREE.ImageUtils.loadCompressedTexture(fullUrl,textureJSON.mapping,textureCallback)}else{texture=THREE.ImageUtils.loadTexture(fullUrl,textureJSON.mapping,textureCallback)}}else{texture=new THREE.Texture;texture.sourceFile=fullUrl}if(THREE[textureJSON.minFilter]!==undefined)texture.minFilter=THREE[textureJSON.minFilter];if(THREE[textureJSON.magFilter]!==undefined)texture.magFilter=THREE[textureJSON.magFilter];if(textureJSON.anisotropy)texture.anisotropy=textureJSON.anisotropy;if(textureJSON.repeat){texture.repeat.set(textureJSON.repeat[0],textureJSON.repeat[1]);if(textureJSON.repeat[0]!==1)texture.wrapS=THREE.RepeatWrapping;if(textureJSON.repeat[1]!==1)texture.wrapT=THREE.RepeatWrapping}if(textureJSON.offset){texture.offset.set(textureJSON.offset[0],textureJSON.offset[1])}if(textureJSON.wrap){var wrapMap={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if(wrapMap[textureJSON.wrap[0]]!==undefined)texture.wrapS=wrapMap[textureJSON.wrap[0]];if(wrapMap[textureJSON.wrap[1]]!==undefined)texture.wrapT=wrapMap[textureJSON.wrap[1]]}}result.textures[textureID]=texture}var matID,matJSON;var parID;for(matID in data.materials){matJSON=data.materials[matID];for(parID in matJSON.parameters){if(parID==="envMap"||parID==="map"||parID==="lightMap"||parID==="bumpMap"){matJSON.parameters[parID]=result.textures[matJSON.parameters[parID]]}else if(parID==="shading"){matJSON.parameters[parID]=matJSON.parameters[parID]==="flat"?THREE.FlatShading:THREE.SmoothShading}else if(parID==="side"){if(matJSON.parameters[parID]==="double"){matJSON.parameters[parID]=THREE.DoubleSide}else if(matJSON.parameters[parID]==="back"){matJSON.parameters[parID]=THREE.BackSide}else{matJSON.parameters[parID]=THREE.FrontSide}}else if(parID==="blending"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.NormalBlending}else if(parID==="combine"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.MultiplyOperation}else if(parID==="vertexColors"){if(matJSON.parameters[parID]==="face"){matJSON.parameters[parID]=THREE.FaceColors}else if(matJSON.parameters[parID]){matJSON.parameters[parID]=THREE.VertexColors}}else if(parID==="wrapRGB"){var v3=matJSON.parameters[parID];matJSON.parameters[parID]=new THREE.Vector3(v3[0],v3[1],v3[2])}}if(matJSON.parameters.opacity!==undefined&&matJSON.parameters.opacity<1){matJSON.parameters.transparent=true}if(matJSON.parameters.normalMap){var shader=THREE.ShaderLib["normalmap"];var uniforms=THREE.UniformsUtils.clone(shader.uniforms);var diffuse=matJSON.parameters.color;var specular=matJSON.parameters.specular;var ambient=matJSON.parameters.ambient;var shininess=matJSON.parameters.shininess;uniforms["tNormal"].value=result.textures[matJSON.parameters.normalMap];if(matJSON.parameters.normalScale){uniforms["uNormalScale"].value.set(matJSON.parameters.normalScale[0],matJSON.parameters.normalScale[1])}if(matJSON.parameters.map){uniforms["tDiffuse"].value=matJSON.parameters.map;uniforms["enableDiffuse"].value=true}if(matJSON.parameters.envMap){uniforms["tCube"].value=matJSON.parameters.envMap;uniforms["enableReflection"].value=true;uniforms["uReflectivity"].value=matJSON.parameters.reflectivity}if(matJSON.parameters.lightMap){uniforms["tAO"].value=matJSON.parameters.lightMap;uniforms["enableAO"].value=true}if(matJSON.parameters.specularMap){uniforms["tSpecular"].value=result.textures[matJSON.parameters.specularMap];uniforms["enableSpecular"].value=true}if(matJSON.parameters.displacementMap){uniforms["tDisplacement"].value=result.textures[matJSON.parameters.displacementMap];uniforms["enableDisplacement"].value=true;uniforms["uDisplacementBias"].value=matJSON.parameters.displacementBias;uniforms["uDisplacementScale"].value=matJSON.parameters.displacementScale}uniforms["uDiffuseColor"].value.setHex(diffuse);uniforms["uSpecularColor"].value.setHex(specular);uniforms["uAmbientColor"].value.setHex(ambient);uniforms["uShininess"].value=shininess;if(matJSON.parameters.opacity){uniforms["uOpacity"].value=matJSON.parameters.opacity}var parameters={fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uniforms,lights:true,fog:true};material=new THREE.ShaderMaterial(parameters)}else{material=new THREE[matJSON.type](matJSON.parameters)}material.name=matID;result.materials[matID]=material}for(matID in data.materials){matJSON=data.materials[matID];if(matJSON.parameters.materials){var materialArray=[];for(var i=0;i<matJSON.parameters.materials.length;i++){var label=matJSON.parameters.materials[i];materialArray.push(result.materials[label])}result.materials[matID].materials=materialArray}}handle_objects();if(result.cameras&&data.defaults.camera){result.currentCamera=result.cameras[data.defaults.camera]}if(result.fogs&&data.defaults.fog){result.scene.fog=result.fogs[data.defaults.fog]}scope.callbackSync(result);async_callback_gate()};!function(){THREE.UTF8Loader=function(){};THREE.UTF8Loader.prototype.load=function(jsonUrl,callback,options){this.downloadModelJson(jsonUrl,options,callback)};THREE.UTF8Loader.BufferGeometryCreator=function(){};THREE.UTF8Loader.BufferGeometryCreator.prototype.create=function(attribArray,indexArray){var ntris=indexArray.length/3;var geometry=new THREE.BufferGeometry;var positionArray=new Float32Array(3*3*ntris);var normalArray=new Float32Array(3*3*ntris);var uvArray=new Float32Array(2*3*ntris);var i,j,offset;var x,y,z;var u,v;var end=attribArray.length;var stride=8;j=0;offset=0;for(i=offset;i<end;i+=stride){x=attribArray[i];y=attribArray[i+1];z=attribArray[i+2];positionArray[j++]=x;positionArray[j++]=y;positionArray[j++]=z}j=0;offset=3;for(i=offset;i<end;i+=stride){u=attribArray[i];v=attribArray[i+1];uvArray[j++]=u;uvArray[j++]=v}j=0;offset=5;for(i=offset;i<end;i+=stride){x=attribArray[i];y=attribArray[i+1];z=attribArray[i+2];normalArray[j++]=x;normalArray[j++]=y;normalArray[j++]=z}var attributes=geometry.attributes;attributes["index"]={itemSize:1,array:indexArray,numItems:indexArray.length};attributes["position"]={itemSize:3,array:positionArray,numItems:positionArray.length};attributes["normal"]={itemSize:3,array:normalArray,numItems:normalArray.length};attributes["uv"]={itemSize:2,array:uvArray,numItems:uvArray.length};geometry.offsets=[{start:0,count:indexArray.length,index:0}];geometry.computeBoundingSphere();return geometry};THREE.UTF8Loader.GeometryCreator=function(){};THREE.UTF8Loader.GeometryCreator.prototype={create:function(attribArray,indexArray){var geometry=new THREE.Geometry;this.init_vertices(geometry,attribArray,8,0);var uvs=this.init_uvs(attribArray,8,3);var normals=this.init_normals(attribArray,8,5);this.init_faces(geometry,normals,uvs,indexArray);geometry.computeCentroids();geometry.computeFaceNormals();return geometry},init_vertices:function(scope,data,stride,offset){var i,x,y,z;var end=data.length;for(i=offset;i<end;i+=stride){x=data[i];y=data[i+1];z=data[i+2];this.addVertex(scope,x,y,z)}},init_normals:function(data,stride,offset){var normals=[];var i,x,y,z;var end=data.length;for(i=offset;i<end;i+=stride){x=data[i];y=data[i+1];z=data[i+2];normals.push(x,y,z)}return normals},init_uvs:function(data,stride,offset){var uvs=[];var i,u,v;var end=data.length;for(i=offset;i<end;i+=stride){u=data[i];v=data[i+1];uvs.push(u,v)}return uvs},init_faces:function(scope,normals,uvs,indices){var i,a,b,c,u1,v1,u2,v2,u3,v3;var end=indices.length;var m=0;for(i=0;i<end;i+=3){a=indices[i];b=indices[i+1];c=indices[i+2];this.f3n(scope,normals,a,b,c,m,a,b,c);u1=uvs[a*2];v1=uvs[a*2+1];u2=uvs[b*2];v2=uvs[b*2+1];u3=uvs[c*2];v3=uvs[c*2+1];this.uv3(scope.faceVertexUvs[0],u1,v1,u2,v2,u3,v3)}},addVertex:function(scope,x,y,z){scope.vertices.push(new THREE.Vector3(x,y,z))},f3n:function(scope,normals,a,b,c,mi,nai,nbi,nci){var nax=normals[nai*3],nay=normals[nai*3+1],naz=normals[nai*3+2],nbx=normals[nbi*3],nby=normals[nbi*3+1],nbz=normals[nbi*3+2],ncx=normals[nci*3],ncy=normals[nci*3+1],ncz=normals[nci*3+2];var na=new THREE.Vector3(nax,nay,naz),nb=new THREE.Vector3(nbx,nby,nbz),nc=new THREE.Vector3(ncx,ncy,ncz);scope.faces.push(new THREE.Face3(a,b,c,[na,nb,nc],null,mi))},uv3:function(where,u1,v1,u2,v2,u3,v3){var uv=[];uv.push(new THREE.Vector2(u1,v1));uv.push(new THREE.Vector2(u2,v2));uv.push(new THREE.Vector2(u3,v3));where.push(uv)}};var DEFAULT_DECODE_PARAMS={decodeOffsets:[-4095,-4095,-4095,0,0,-511,-511,-511],decodeScales:[1/8191,1/8191,1/8191,1/1023,1/1023,1/1023,1/1023,1/1023]};THREE.UTF8Loader.prototype.decompressAttribsInner_=function(str,inputStart,inputEnd,output,outputStart,stride,decodeOffset,decodeScale){var prev=0;for(var j=inputStart;j<inputEnd;j++){var code=str.charCodeAt(j);prev+=code>>1^-(code&1);output[outputStart]=decodeScale*(prev+decodeOffset);outputStart+=stride}};THREE.UTF8Loader.prototype.decompressIndices_=function(str,inputStart,numIndices,output,outputStart){var highest=0;for(var i=0;i<numIndices;i++){var code=str.charCodeAt(inputStart++);output[outputStart++]=highest-code;if(code===0){highest++}}};THREE.UTF8Loader.prototype.decompressAABBs_=function(str,inputStart,numBBoxen,decodeOffsets,decodeScales){var numFloats=6*numBBoxen;var inputEnd=inputStart+numFloats;var outputStart=0;var bboxen=new Float32Array(numFloats);for(var i=inputStart;i<inputEnd;i+=6){var minX=str.charCodeAt(i+0)+decodeOffsets[0];var minY=str.charCodeAt(i+1)+decodeOffsets[1];var minZ=str.charCodeAt(i+2)+decodeOffsets[2];var radiusX=str.charCodeAt(i+3)+1>>1;var radiusY=str.charCodeAt(i+4)+1>>1;var radiusZ=str.charCodeAt(i+5)+1>>1;bboxen[outputStart++]=decodeScales[0]*(minX+radiusX);bboxen[outputStart++]=decodeScales[1]*(minY+radiusY);bboxen[outputStart++]=decodeScales[2]*(minZ+radiusZ);bboxen[outputStart++]=decodeScales[0]*radiusX;bboxen[outputStart++]=decodeScales[1]*radiusY;bboxen[outputStart++]=decodeScales[2]*radiusZ}return bboxen};THREE.UTF8Loader.prototype.decompressMesh=function(str,meshParams,decodeParams,name,idx,callback){var stride=decodeParams.decodeScales.length;var decodeOffsets=decodeParams.decodeOffsets;var decodeScales=decodeParams.decodeScales;var attribStart=meshParams.attribRange[0];var numVerts=meshParams.attribRange[1];var inputOffset=attribStart;var attribsOut=new Float32Array(stride*numVerts);for(var j=0;j<stride;j++){var end=inputOffset+numVerts;var decodeScale=decodeScales[j];if(decodeScale){this.decompressAttribsInner_(str,inputOffset,end,attribsOut,j,stride,decodeOffsets[j],decodeScale)}inputOffset=end}var indexStart=meshParams.indexRange[0];var numIndices=3*meshParams.indexRange[1];var indicesOut=new Uint16Array(numIndices);this.decompressIndices_(str,inputOffset,numIndices,indicesOut,0);var bboxen;var bboxOffset=meshParams.bboxes;if(bboxOffset){bboxen=this.decompressAABBs_(str,bboxOffset,meshParams.names.length,decodeOffsets,decodeScales)}callback(name,idx,attribsOut,indicesOut,bboxen,meshParams)};THREE.UTF8Loader.prototype.copyAttrib=function(stride,attribsOutFixed,lastAttrib,index){for(var j=0;j<stride;j++){lastAttrib[j]=attribsOutFixed[stride*index+j]}};THREE.UTF8Loader.prototype.decodeAttrib2=function(str,stride,decodeOffsets,decodeScales,deltaStart,numVerts,attribsOut,attribsOutFixed,lastAttrib,index){for(var j=0;j<5;j++){var code=str.charCodeAt(deltaStart+numVerts*j+index);var delta=code>>1^-(code&1);lastAttrib[j]+=delta;attribsOutFixed[stride*index+j]=lastAttrib[j];attribsOut[stride*index+j]=decodeScales[j]*(lastAttrib[j]+decodeOffsets[j])}};THREE.UTF8Loader.prototype.accumulateNormal=function(i0,i1,i2,attribsOutFixed,crosses){var p0x=attribsOutFixed[8*i0];var p0y=attribsOutFixed[8*i0+1];var p0z=attribsOutFixed[8*i0+2];var p1x=attribsOutFixed[8*i1];var p1y=attribsOutFixed[8*i1+1];var p1z=attribsOutFixed[8*i1+2];var p2x=attribsOutFixed[8*i2];var p2y=attribsOutFixed[8*i2+1];var p2z=attribsOutFixed[8*i2+2];p1x-=p0x;p1y-=p0y;p1z-=p0z;p2x-=p0x;p2y-=p0y;p2z-=p0z;p0x=p1y*p2z-p1z*p2y;p0y=p1z*p2x-p1x*p2z;p0z=p1x*p2y-p1y*p2x;crosses[3*i0]+=p0x;crosses[3*i0+1]+=p0y;crosses[3*i0+2]+=p0z;crosses[3*i1]+=p0x;crosses[3*i1+1]+=p0y;crosses[3*i1+2]+=p0z;crosses[3*i2]+=p0x;crosses[3*i2+1]+=p0y;crosses[3*i2+2]+=p0z};THREE.UTF8Loader.prototype.decompressMesh2=function(str,meshParams,decodeParams,name,idx,callback){var MAX_BACKREF=96;
var stride=decodeParams.decodeScales.length;var decodeOffsets=decodeParams.decodeOffsets;var decodeScales=decodeParams.decodeScales;var deltaStart=meshParams.attribRange[0];var numVerts=meshParams.attribRange[1];var codeStart=meshParams.codeRange[0];var codeLength=meshParams.codeRange[1];var numIndices=3*meshParams.codeRange[2];var indicesOut=new Uint16Array(numIndices);var crosses=new Int32Array(3*numVerts);var lastAttrib=new Uint16Array(stride);var attribsOutFixed=new Uint16Array(stride*numVerts);var attribsOut=new Float32Array(stride*numVerts);var highest=0;var outputStart=0;for(var i=0;i<numIndices;i+=3){var code=str.charCodeAt(codeStart++);var max_backref=Math.min(i,MAX_BACKREF);if(code<max_backref){var winding=code%3;var backref=i-(code-winding);var i0,i1,i2;switch(winding){case 0:i0=indicesOut[backref+2];i1=indicesOut[backref+1];i2=indicesOut[backref+0];break;case 1:i0=indicesOut[backref+0];i1=indicesOut[backref+2];i2=indicesOut[backref+1];break;case 2:i0=indicesOut[backref+1];i1=indicesOut[backref+0];i2=indicesOut[backref+2];break}indicesOut[outputStart++]=i0;indicesOut[outputStart++]=i1;code=str.charCodeAt(codeStart++);var index=highest-code;indicesOut[outputStart++]=index;if(code===0){for(var j=0;j<5;j++){var deltaCode=str.charCodeAt(deltaStart+numVerts*j+highest);var prediction=(deltaCode>>1^-(deltaCode&1))+attribsOutFixed[stride*i0+j]+attribsOutFixed[stride*i1+j]-attribsOutFixed[stride*i2+j];lastAttrib[j]=prediction;attribsOutFixed[stride*highest+j]=prediction;attribsOut[stride*highest+j]=decodeScales[j]*(prediction+decodeOffsets[j])}highest++}else{this.copyAttrib(stride,attribsOutFixed,lastAttrib,index)}this.accumulateNormal(i0,i1,index,attribsOutFixed,crosses)}else{var index0=highest-(code-max_backref);indicesOut[outputStart++]=index0;if(code===max_backref){this.decodeAttrib2(str,stride,decodeOffsets,decodeScales,deltaStart,numVerts,attribsOut,attribsOutFixed,lastAttrib,highest++)}else{this.copyAttrib(stride,attribsOutFixed,lastAttrib,index0)}code=str.charCodeAt(codeStart++);var index1=highest-code;indicesOut[outputStart++]=index1;if(code===0){this.decodeAttrib2(str,stride,decodeOffsets,decodeScales,deltaStart,numVerts,attribsOut,attribsOutFixed,lastAttrib,highest++)}else{this.copyAttrib(stride,attribsOutFixed,lastAttrib,index1)}code=str.charCodeAt(codeStart++);var index2=highest-code;indicesOut[outputStart++]=index2;if(code===0){for(var j=0;j<5;j++){lastAttrib[j]=(attribsOutFixed[stride*index0+j]+attribsOutFixed[stride*index1+j])/2}this.decodeAttrib2(str,stride,decodeOffsets,decodeScales,deltaStart,numVerts,attribsOut,attribsOutFixed,lastAttrib,highest++)}else{this.copyAttrib(stride,attribsOutFixed,lastAttrib,index2)}this.accumulateNormal(index0,index1,index2,attribsOutFixed,crosses)}}for(var i=0;i<numVerts;i++){var nx=crosses[3*i];var ny=crosses[3*i+1];var nz=crosses[3*i+2];var norm=511/Math.sqrt(nx*nx+ny*ny+nz*nz);var cx=str.charCodeAt(deltaStart+5*numVerts+i);var cy=str.charCodeAt(deltaStart+6*numVerts+i);var cz=str.charCodeAt(deltaStart+7*numVerts+i);attribsOut[stride*i+5]=norm*nx+(cx>>1^-(cx&1));attribsOut[stride*i+6]=norm*ny+(cy>>1^-(cy&1));attribsOut[stride*i+7]=norm*nz+(cz>>1^-(cz&1))}callback(name,idx,attribsOut,indicesOut,undefined,meshParams)};THREE.UTF8Loader.prototype.downloadMesh=function(path,name,meshEntry,decodeParams,callback){var loader=this;var idx=0;function onprogress(req,e){while(idx<meshEntry.length){var meshParams=meshEntry[idx];var indexRange=meshParams.indexRange;if(indexRange){var meshEnd=indexRange[0]+3*indexRange[1];if(req.responseText.length<meshEnd)break;loader.decompressMesh(req.responseText,meshParams,decodeParams,name,idx,callback)}else{var codeRange=meshParams.codeRange;var meshEnd=codeRange[0]+codeRange[1];if(req.responseText.length<meshEnd)break;loader.decompressMesh2(req.responseText,meshParams,decodeParams,name,idx,callback)}++idx}}getHttpRequest(path,function(req,e){if(req.status===200||req.status===0){onprogress(req,e)}},onprogress)};THREE.UTF8Loader.prototype.downloadMeshes=function(path,meshUrlMap,decodeParams,callback){for(var url in meshUrlMap){var meshEntry=meshUrlMap[url];this.downloadMesh(path+url,url,meshEntry,decodeParams,callback)}};THREE.UTF8Loader.prototype.createMeshCallback=function(materialBaseUrl,loadModelInfo,allDoneCallback){var nCompletedUrls=0;var nExpectedUrls=0;var expectedMeshesPerUrl={};var decodedMeshesPerUrl={};var modelParts={};var meshUrlMap=loadModelInfo.urls;for(var url in meshUrlMap){expectedMeshesPerUrl[url]=meshUrlMap[url].length;decodedMeshesPerUrl[url]=0;nExpectedUrls++;modelParts[url]=new THREE.Object3D}var model=new THREE.Object3D;var materialCreator=new THREE.MTLLoader.MaterialCreator(materialBaseUrl,loadModelInfo.options);materialCreator.setMaterials(loadModelInfo.materials);materialCreator.preload();var geometryCreator=new THREE.UTF8Loader.GeometryCreator;var bufferGeometryCreator=new THREE.UTF8Loader.BufferGeometryCreator;var meshCallback=function(name,idx,attribArray,indexArray,bboxen,meshParams){var useBuffers=loadModelInfo.options.useBuffers!==undefined?loadModelInfo.options.useBuffers:true;var geometry;if(useBuffers){geometry=bufferGeometryCreator.create(attribArray,indexArray)}else{geometry=geometryCreator.create(attribArray,indexArray)}var material=materialCreator.create(meshParams.material);var mesh=new THREE.Mesh(geometry,material);modelParts[name].add(mesh);decodedMeshesPerUrl[name]++;if(decodedMeshesPerUrl[name]===expectedMeshesPerUrl[name]){nCompletedUrls++;model.add(modelParts[name]);if(nCompletedUrls===nExpectedUrls){allDoneCallback(model)}}};return meshCallback};THREE.UTF8Loader.prototype.downloadModel=function(geometryBase,materialBase,model,callback){var meshCallback=this.createMeshCallback(materialBase,model,callback);this.downloadMeshes(geometryBase,model.urls,model.decodeParams,meshCallback)};THREE.UTF8Loader.prototype.downloadModelJson=function(jsonUrl,options,callback){getJsonRequest(jsonUrl,function(loaded){if(!loaded.decodeParams){if(options&&options.decodeParams){loaded.decodeParams=options.decodeParams}else{loaded.decodeParams=DEFAULT_DECODE_PARAMS}}loaded.options=options;var geometryBase=jsonUrl.substr(0,jsonUrl.lastIndexOf("/")+1);var materialBase=geometryBase;if(options&&options.geometryBase){geometryBase=options.geometryBase;if(geometryBase.charAt(geometryBase.length-1)!=="/"){geometryBase=geometryBase+"/"}}if(options&&options.materialBase){materialBase=options.materialBase;if(materialBase.charAt(materialBase.length-1)!=="/"){materialBase=materialBase+"/"}}this.downloadModel(geometryBase,materialBase,loaded,callback)}.bind(this))};function getHttpRequest(url,onload,opt_onprogress){var LISTENERS={load:function(e){onload(req,e)},progress:function(e){opt_onprogress(req,e)}};var req=new XMLHttpRequest;addListeners(req,LISTENERS);req.open("GET",url,true);req.send(null)}function getJsonRequest(url,onjson){getHttpRequest(url,function(e){onjson(JSON.parse(e.responseText))},function(){})}function addListeners(dom,listeners){for(var key in listeners){dom.addEventListener(key,listeners[key])}}}();THREE.VTKLoader=function(){THREE.EventDispatcher.call(this)};THREE.VTKLoader.prototype={constructor:THREE.VTKLoader,load:function(url,callback){var scope=this;var request=new XMLHttpRequest;request.addEventListener("load",function(event){var geometry=scope.parse(event.target.responseText);scope.dispatchEvent({type:"load",content:geometry});if(callback)callback(geometry)},false);request.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);request.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);request.open("GET",url,true);request.send(null)},parse:function(data){var geometry=new THREE.Geometry;function vertex(x,y,z){geometry.vertices.push(new THREE.Vector3(x,y,z))}function face3(a,b,c){geometry.faces.push(new THREE.Face3(a,b,c))}function face4(a,b,c,d){geometry.faces.push(new THREE.Face4(a,b,c,d))}var pattern,result;pattern=/([\+|\-]?[\d]+[\.][\d|\-|e]+)[ ]+([\+|\-]?[\d]+[\.][\d|\-|e]+)[ ]+([\+|\-]?[\d]+[\.][\d|\-|e]+)/g;while((result=pattern.exec(data))!==null){vertex(parseFloat(result[1]),parseFloat(result[2]),parseFloat(result[3]))}pattern=/3[ ]+([\d]+)[ ]+([\d]+)[ ]+([\d]+)/g;while((result=pattern.exec(data))!==null){face3(parseInt(result[1],10),parseInt(result[2],10),parseInt(result[3],10))}pattern=/4[ ]+([\d]+)[ ]+([\d]+)[ ]+([\d]+)[ ]+([\d]+)/g;while((result=pattern.exec(data))!==null){face4(parseInt(result[1],10),parseInt(result[2],10),parseInt(result[3],10),parseInt(result[4],10))}geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();geometry.computeBoundingSphere();return geometry}};exo.resources.importers.jsfbx=exo.resources.importers.FBXImporter={extensions:["jsfbx"],importFile:function(file,ctx,deferred,onLoaded){file.fetchContent(function(err,fileContents){var importerInstance=new exo.resources.importers.FBXLoader(fileContents,ctx,function(){if(ctx.editor&&!_.isFunction(ctx.editor)){ctx.editor.frameAllMeshes()}onLoaded()},file.get("name"),deferred)})}};!function(){exo.resources.importers.FBXLoader=function(contents,ctx,onCompleted,fileName,notification){var data=JSON.parse(contents);var importer=this;this.data=data;var materials=data.materials;this.ctx=ctx;this.nodeParent=ctx("%Scene").first();this.onLoaded=onLoaded;this.loadAnimations=true;this.loadSkins=true;var loaded={materials:0,multiMaterials:0,objects:0,skins:0};if(this.loadAnimations){this.loadTimeLine()}notification.notify(10);_.each(data.materials,function(material,key){material.uid=key});var standardMaterials=_.filter(data.materials,function(material){return material.type!=="MeshFaceMaterial"});var multiMaterials=_.filter(data.materials,function(material){return material.type==="MeshFaceMaterial"});var onLoaded=function(type,length,next){return function(){loaded[type]++;if(loaded[type]===length){next()}}};var loadStandardMaterials=function(){if(!standardMaterials.length)loadMultiMaterials();_.each(standardMaterials,function(material,key){importer.loadMaterial(material,material.uid,onLoaded("materials",standardMaterials.length,loadMultiMaterials))},importer)};var loadMultiMaterials=function(){notification.notify(30);if(!multiMaterials.length)loadObjects();_.each(multiMaterials,function(material,key){importer.loadMaterialNode(material,material.uid,onLoaded("multiMaterials",multiMaterials.length,loadObjects))},importer)};var objectsLength=function(objects){var amount=0;_.each(objects,function addChild(obj){amount++;_.each(obj.children,addChild)});return amount};var loadObjects=function(){notification.notify(60);var length=objectsLength(data.objects);if(!length)loadSkins();_.each(data.objects,function(obj,key){importer.loadChildren(importer.nodeParent.objectsRootNode,obj,key,onLoaded("objects",length,loadSkins))},importer)};var loadSkins=function(){notification.notify(80);var length=data.skin?_.keys(data.skin).length:0;if(importer.loadSkins&&length){_.each(data.skin,function(skin,key){importer.loadSkin(skin,key,onLoaded("skins",length,complete))},importer)}else{complete()}};var complete=function(){notification.notify(90);onCompleted();if(importer.loadAnimations){importer.importAnimations(importer.nodeParent.scene().objectsRootNode)}};loadStandardMaterials()};exo.resources.importers.FBXLoader.prototype={constructor:exo.resources.importers.FBXLoader,loadChildren:function(nodeParent,child,childUID,callback){var data=this.data;var loadAnimations=this.loadAnimations;var object=child;var options={};var color,intensity,position,rotation,scale,target;var polyMesh,childNode;var transform=object.transform;var importer=this;var onLoaded=function(childNode){if(object.children!==undefined&&childNode){_.each(object.children,function(newChild,newChildUID){importer.loadChildren(childNode,newChild,newChildUID,callback)})}callback()};options.transform={};_.each(transform,function(itemTransform,key){options.transform[key]=exo.math.arrayToVector3(itemTransform)},this);if(object.geometry!==undefined){polyMesh=this.loadPolyMesh(data.geometries[object.geometry]);if(polyMesh&&polyMesh.validate(true).length===0){this.loadPolyMeshNode(nodeParent,polyMesh,options,object.material,childUID,onLoaded)}else{onLoaded()}}else if(object.type==="DirectionalLight"||object.type==="PointLight"||object.type==="AmbientLight"||object.type==="SpotLight"){options.color=object.color!==undefined?object.color:16777215;options.intensity=object.intensity!==undefined?object.intensity:1;options.type=object.type;if(object.target&&object.target.length){target=data.objects[object.target];options.targeted=true}else{options.targeted=false}if(object.type==="DirectionalLight"){}else if(object.type==="PointLight"){if(object.distanceEnableFar){options.distance=object.distanceFar}}else if(object.type==="SpotLight"){if(object.distanceEnableFar){options.distance=object.distanceFar}options.angle=object.angle;options.exponent=object.exponent}else if(object.type==="AmbientLight"){}this.loadLightNode(nodeParent,options,childUID,onLoaded)}else if(object.type==="PerspectiveCamera"||object.type==="OrthographicCamera"){options.nearClip=object.near;options.farClip=object.far;if(object.target&&object.target.length){target=data.objects[object.target];options.targeted=true}else{options.targeted=false}if(object.type==="PerspectiveCamera"){options.projection="Perspective";options.fieldOfView=object.fov;options.aspectRatio=object.aspect;options.focalDepth=object.focalDepth}else if(object.type==="OrthographicCamera"){options.projection="Orthographic";options.size={width:object.right-object.left,height:object.bottom-object.top};options.orthoZoom=object.orthoZoom}childNode=this.loadCameraNode(nodeParent,options,childUID,onLoaded)}else if(object.fbx_type==="Skeleton"){this.loadBoneNode(nodeParent,options,childUID,onLoaded)}else if(object.fbx_type==="Null"){this.loadNullNode(nodeParent,options,childUID,onLoaded)}else{onLoaded()}},loadTimeLine:function(){if(!this.data.timeline)return;var fps,startFrame,endFrame;var data=this.data;var nodeParent=this.nodeParent;var scene=nodeParent.scene();var timeline=scene.Timeline.operators.first();var ctx=this.ctx;fps=data.timeline.fps;startFrame=data.timeline.end*fps;endFrame=data.timeline.end*fps;var currentStart=timeline.get("animationStartFrame");var currentEnd=timeline.get("animationEndFrame");if(startFrame<currentStart){ctx(timeline).set("animationStartFrame",startFrame)}if(endFrame>currentEnd){ctx(timeline).set("animationEndFrame",endFrame)}},importAnimations:function(scene){var data=this.data;var options={};options.transform={};var keyChildName="";_.each(data.animations,function(animationObj,keyChildUID){keyChildName=this.getNameFromUID(keyChildUID);var childNode=scene.find(function(m){return m.fbxUID===keyChildUID&&m.get("name")===keyChildName});if(childNode){this.loadTransformAnimations(childNode,keyChildUID)}},this)},loadTransformAnimations:function(node,inputNodeUID){var fps,startFrame,endFrame;var data=this.data;var animationStack=data.animations[inputNodeUID];var ctx=this.ctx;var transformOperator=node.plugs.Transform.operators.first();fps=data.timeline.fps;if(!animationStack){return 0}_.each(animationStack,function(layers){_.each(layers,function(layer){var positionFBX=layer.position;var rotationFBX=layer.rotation;var scaleFBX=layer.scale;var value,time,interpolationType,axis;var xyz=["x","y","z"];for(var kAxis=0;kAxis<xyz.length;kAxis++){axis=xyz[kAxis];if(positionFBX[axis].value){for(var i=0,il=positionFBX[axis].value.length;i<il;i++){value=positionFBX[axis].value[i];time=positionFBX[axis].time[i];interpolationType=positionFBX[axis].interpolation[i];time=Math.round(time*fps);ctx(transformOperator).setAt("translation."+axis,value,time,interpolationType)}}}for(var kAxis=0;kAxis<xyz.length;kAxis++){axis=xyz[kAxis];if(rotationFBX[axis].value){for(var i=0,il=rotationFBX[axis].value.length;i<il;i++){value=rotationFBX[axis].value[i];time=rotationFBX[axis].time[i];interpolationType=rotationFBX[axis].interpolation[i];time=Math.round(time*fps);ctx(transformOperator).setAt("rotation."+axis,value,time,interpolationType)}}}for(var kAxis=0;kAxis<xyz.length;kAxis++){axis=xyz[kAxis];if(scaleFBX[axis].value){for(var i=0,il=scaleFBX[axis].value.length;i<il;i++){value=scaleFBX[axis].value[i];time=scaleFBX[axis].time[i];interpolationType=scaleFBX[axis].interpolation[i];time=Math.round(time*fps);ctx(transformOperator).setAt("scale."+axis,value,time,interpolationType)}}}},this)},this)},loadPolyMesh:function(geometry){var data=this.data;var polyMesh;if(geometry.type!=="embedded"){return null}var geometryData=data.embeds[geometry.id];var info=geometryData.metadata;var faces=geometryData.faces;var faceSize=geometryData.faceSize;var vertices=geometryData.vertices;var normals=geometryData.normals;var colors=geometryData.colors;var uvs=geometryData.uvs;var nUvLayers=0;var nColorLayers=1;var colorlayersSupported=false;var newUVs=[],newColors=[],newNormals=[];var vertex,normal,normalIndex,uvLayer,colorLayer,uvIndex,uVal,vVal,colorIndex,color,uvName,colorName;var outputVertices=[],outputFaces=[],outputUVs={},outputMaterialIDs=[],outputColors={},outputNormals=[],outputNormalIndices=[];var type,isQuad,hasMaterial,hasFaceUv,hasFaceVertexUv,hasFaceNormal,hasFaceVertexNormal,hasFaceColor,hasFaceVertexColor;for(var i=0;i<uvs.length;i++){if(uvs[i].length){nUvLayers++}}for(var i=0,il=vertices.length;i<il;i+=3){vertex=new THREE.Vector3(vertices[i],vertices[i+1],vertices[i+2]);outputVertices.push(vertex)}var offset=0;var zLength=faces.length;var faceCounter=0;while(offset<zLength){type=faces[offset];offset++;var newFace=[];var nVertices=faceSize[faceCounter];isQuad=this.isBitSet(type,0);hasMaterial=this.isBitSet(type,1);hasFaceUv=this.isBitSet(type,2);hasFaceVertexUv=this.isBitSet(type,3);hasFaceNormal=this.isBitSet(type,4);hasFaceVertexNormal=this.isBitSet(type,5);hasFaceColor=this.isBitSet(type,6);hasFaceVertexColor=this.isBitSet(type,7);for(var j=0,jl=faceSize[faceCounter];j<jl;j++){newFace.push(faces[offset]);offset++}faceCounter++;outputFaces.push(newFace);if(hasMaterial){if(faces[offset]<10){outputMaterialIDs.push(faces[offset])}else{outputMaterialIDs.push(0)}offset++}if(hasFaceUv){for(var i=0;i<nUvLayers;i++){offset++}}if(hasFaceVertexUv){for(var i=0;i<nUvLayers;i++){newUVs=[];uvName="map"+i;if(!outputUVs[uvName]){outputUVs[uvName]=[];outputUVs[uvName].values=[];outputUVs[uvName].faces=[]}for(j=0;j<nVertices;j++){uvIndex=faces[offset];offset++;newUVs.push(uvIndex)}outputUVs[uvName].faces.push(newUVs)}}if(hasFaceNormal){offset++}if(hasFaceVertexNormal){newNormals=[];for(var i=0;i<nVertices;i++){normalIndex=faces[offset];offset++;newNormals.push(normalIndex)}outputNormalIndices.push(newNormals)}if(hasFaceColor){offset++}if(hasFaceVertexColor){for(var i=0;i<nColorLayers;i++){newColors=[];colorName="map"+i;if(!outputColors[colorName]){outputColors[colorName]=[];outputColors[colorName].values=[];outputColors[colorName].faces=[]}for(var i=0;i<nVertices;i++){colorIndex=faces[offset];offset++;newColors.push(colorIndex)}outputColors[colorName].faces.push(newColors)}}}for(var i=0,il=normals.length;i<il;i+=3){outputNormals.push(new THREE.Vector3(normals[i],normals[i+1],normals[i+2]))}for(var i=0;i<nUvLayers;i++){uvLayer=uvs[i];uvName="map"+i;for(var i=0,il=uvLayer.length;i<il;i+=2){outputUVs[uvName].values.push(new THREE.Vector2(uvLayer[i],uvLayer[i+1]))}}for(var i=0;i<nColorLayers;i++){colorLayer=colorlayersSupported?colors[i]:colors;colorName="map"+i;for(var i=0,il=colorLayer.length;i<il;i+=3){outputColors[colorName].values.push((new THREE.Color).setRGB(colorLayer[i],colorLayer[i+1],colorLayer[i+2]))}}if(geometryData&&outputFaces.length){polyMesh=new exo.geometry.PolyMesh(outputFaces,outputVertices);if(outputNormals&&outputNormals.length){polyMesh.normalMap=new exo.geometry.PolyMap(outputNormalIndices,outputNormals)}else{polyMesh.normalMap=null}if(outputUVs){_.each(outputUVs,function(outUVs,key){var mapName=key;if(key==="map0"){mapName=exo.geometry.PolyMesh.DEFAULT_MAP}polyMesh.uvMaps[mapName]=new exo.geometry.PolyMap(outUVs.faces,outUVs.values)})}else{polyMesh.uvMaps={}}if(outputColors){_.each(outputColors,function(outColors,key){var mapName=key;if(key==="map0"){mapName=exo.geometry.PolyMesh.DEFAULT_MAP}polyMesh.colorMaps[mapName]=new exo.geometry.PolyMap(outColors.faces,outColors.values)})}else{polyMesh.colorMaps={}}if(outputMaterialIDs&&outputMaterialIDs.length){polyMesh.materialIds=outputMaterialIDs}else{polyMesh.materialIds=null}}return polyMesh},loadMaterial:function(material,materialUID,callback){var mat=material.parameters;var mOptions={diffuseColor:15658734,opacityFactor:1,materialType:"Phong"};mOptions.materialType=material.type;_.each(["diffuse","ambient","specular","opacity"],function(type){if(mat[type+"_color"]!==undefined){mOptions[type+"Color"]=mat[type+"_color"]}});_.each(["opacity","diffuse","specular","ambient","emissive","bump"],function(type){if(mat[type+"_factor"]!==undefined){mOptions[type+"Factor"]=mat[type+"_factor"]}});if(mat.reflection_factor!==undefined){mOptions.glossiness=mat.reflection_factor}if(mat.reflectivity!==undefined){mOptions.reflection=mat.reflectivity}mOptions.vertexColors=mat.vertexColors===THREE.VertexColors;mOptions.side=mat.side===THREE.DoubleSide;if(mat.diffuse_map!==undefined){mOptions.diffuseMap=mat.diffuse_map}if(mat.specular_map!==undefined){mOptions.specularMap=mat.specular_map}if(mat.ambient_map!==undefined){mOptions.ambientMap=mat.ambient_map}if(mat.emissive_map!==undefined){mOptions.emissiveMap=mat.emissive_map}if(mat.bump_map!==undefined){mOptions.bumpMap=mat.bump_map}if(mat.normal_map!==undefined){mOptions.normalMap=mat.normal_map}this.loadMaterialNode(mOptions,materialUID,callback)},loadSkin:function(skin,geoemetryUID,callback){var data=this.data;var nodeParent=this.nodeParent;var rootBoneNode;var geoemetryName=this.getNameFromUID(geoemetryUID);var ctx=this.ctx;var polyMeshNode=nodeParent.find(function(m){return m.get("type")==="PolyMesh"&&m.get("name")===geoemetryName&&m.fbxUID===geoemetryUID});var bonesInfo={};if(!polyMeshNode){return callback()}var skinsLoaded=0,skinAmount=skin?_.keys(skin).length:0;var finish=function(){if(++skinsLoaded===skinAmount){callback()}};if(skinAmount===0)return callback();_.each(skin,function(skinInfo){var boneDataFromInput=exo.geometry.BoneDataUtils.constructBoneDataFromInput(nodeParent,skinInfo);var newBoneDataList=boneDataFromInput.boneDataList;var bindMesh=boneDataFromInput.bindMesh;if(!newBoneDataList||!bindMesh){return finish()}var boneList_IDs=[];for(var i=0,il=newBoneDataList.length;i<il;i++){boneList_IDs.push(newBoneDataList[i].uuid)}ctx(polyMeshNode.plugs.PolyMesh).addOperator("Skin",{boneDataList:newBoneDataList,poseSkinToWorldTransform:bindMesh}).then(function(operatorSkin){ctx(operatorSkin).set("boneNodeList",boneList_IDs);finish();skinsLoaded++;if(skinsLoaded===skinAmount){callback()}})})},loadMaterialNode:function(options,materialUID,callback){var ctx=this.ctx;var newOptions={};var name=this.getNameFromUID(materialUID);var importer=this;ctx("%MaterialLibrary").addNode(name,"Material",{Material:{}}).then(function(material){if(!material){return callback(null)}material.fbxUID=materialUID;var materialType=options.type||options.materialType;if(materialType==="MeshFaceMaterial"){var materialList=options.parameters.materials;ctx(material.plugs.Material).addOperator("MultiID",{}).then(function(MultiIDOperator){for(var i=0,il=materialList.length;i<il;i++){var materialNode=importer.nodeParent.scene().find(function(n){return n.get("type")==="Material"&&n.fbxUID===materialList[i]});if(materialNode){ctx(MultiIDOperator).set("material"+i,materialNode)}else{console.log("Missing material ID"+i)}}callback(material)})}else if(materialType==="Unknown"){callback()}else{_.extend(newOptions,options);_.each(["diffuse","opacity","specular","ambient","emissive","bump","normal"],function(type){var name=type+"Map";var textureMap=importer.getTextureByPropertyname(options,name);if(textureMap){newOptions[name]=textureMap}else{delete newOptions[name]}},importer);newOptions.materialType="Phong";ctx(material.plugs.Material).addOperator("Standard",newOptions).then(function(operator){callback(material)})}})},getTextureByPropertyname:function(options,texturePropertyName){var texture,textureName;var textureNode=null;var textures=this.data.textures;var textureInfo=textures[options[texturePropertyName]];var textureUID=options[texturePropertyName];if(textureInfo){var textureName=textureInfo.name;var textureNode=this.nodeParent.scene().files.find(function(n){return n.isAsset()&&n.isImage()&&n.get("name")===textureName})}return textureNode},loadLightNode:function(parent,options,lightUID,callback){var ctx=this.ctx;var importer=this;ctx(parent).addNode(this.getNameFromUID(lightUID),"Light",{Light:{}}).then(function(lightNode){lightNode.fbxUID=lightUID;ctx(lightNode.plugs.Light).addOperator(options.type,options).then(function(operator){importer.setTransformation(lightNode,options.transform);callback(lightNode)})})},loadBoneNode:function(parent,options,boneUID,callback){var ctx=this.ctx;var boneNode;var name=this.getNameFromUID(boneUID);var importer=this;var onBoneLoaded=function(boneNode){boneNode.fbxUID=boneUID;importer.setTransformation(boneNode,options.transform);callback(boneNode)};if(parent.get("type")==="Bone"){exo.geometry.BoneUtils.insertBone(parent,this.nodeParent.objectsRootNode,options,name,onBoneLoaded,ctx)}else{exo.geometry.BoneUtils.insertBone(parent,this.nodeParent.objectsRootNode,options,name,onBoneLoaded,ctx)}},loadNullNode:function(parent,options,nullUID,callback){var ctx=this.ctx;var importer=this;ctx(parent).addNode(this.getNameFromUID(nullUID),"Null",{Null:{}}).then(function(nullNode){nullNode.fbxUID=nullUID;ctx(nullNode.plugs.Null).addOperator("Null",options).then(function(operator){importer.setTransformation(nullNode,options.transform);callback(nullNode)})})},loadCameraNode:function(parent,options,cameraUID,callback){var ctx=this.ctx;var importer=this;ctx(parent).addNode(this.getNameFromUID(cameraUID),"Camera",{Camera:{}}).then(function(cameraNode){cameraNode.fbxUID=cameraUID;ctx(cameraNode.plugs.Camera).addOperator("Camera",options).then(function(operator){importer.setTransformation(cameraNode,options.transform);callback(cameraNode)})})},loadPolyMeshNode:function(parent,polyMesh,options,materialUID,polyMeshUID,callback){var ctx=this.ctx;var importer=this;var name=this.getNameFromUID(polyMeshUID);this.setGeometricTransform(polyMesh,options.transform);ctx.addFile({name:name+".json",content:polyMesh,type:"application/json",sourceType:"import",internal:true}).then(function(blob){ctx(parent).addNode(name,"PolyMesh",{PolyMesh:{Mesh:{geometry:blob}}}).then(function(polyMeshNode){polyMeshNode.fbxUID=polyMeshUID;importer.setTransformation(polyMeshNode,options.transform);var materialName=importer.getNameFromUID(materialUID);var material=importer.nodeParent.find(function(m){return m.get("type")==="Material"&&m.fbxUID===materialUID&&m.get("name")===materialName});if(material&&material.id){ctx(polyMeshNode).find("#Material[reference]").set({reference:material.id})}callback(polyMeshNode)})})},isBitSet:function(value,position){return value&1<<position},getRotationFromDirection:function(v1,v2){var directionVector;if(v2){directionVector=(new THREE.Vector3).subVectors(v2,v1)}else{directionVector=v1}var xRot=directionVector.angleTo(new THREE.Vector3(1,0,0));var yRot=directionVector.angleTo(new THREE.Vector3(0,1,0));var zRot=directionVector.angleTo(new THREE.Vector3(0,0,1));return new THREE.Vector3(xRot,yRot,zRot)},setTransformation:function(node,properties){var rotatePivotOffset=properties.fbxRotationOffset;var localRotatePivot=properties.fbxRotationPivot;var translation=properties.fbxLclTranslation;var rotation=properties.fbxLclRotation;var scale=properties.fbxLclScaling;var preRotation=properties.fbxPreRotation;var postRotation=properties.fbxPostRotation.clone();var scalePivotOffset=properties.fbxScalingOffset;var localScalePivot=properties.fbxScalingPivot;var rotateOrder="ZYX";var transformProps={};var transformOperator=node.plugs.Transform.operators.first();transformProps.translation=translation;transformProps.rotation=rotation;transformProps.scale=scale;if(node.get("type")==="Camera"){postRotation.add(new THREE.Vector3(0,90,0))}else if(node.get("type")==="Light"){postRotation.add(new THREE.Vector3(90,0,0))}transformProps.preRotation=preRotation;transformProps.rotateAxis=postRotation;transformProps.rotatePivotOffset=rotatePivotOffset;transformProps.scalePivotOffset=scalePivotOffset;transformProps.localRotatePivot=localRotatePivot;transformProps.localScalePivot=localScalePivot;transformProps.rotateOrder=rotateOrder;this.ctx(transformOperator).set(transformProps)},setGeometricTransform:function(polyMesh,properties,callback){var geometricScaling=properties.fbxGeometricScaling;if(geometricScaling){var signCounter=0;if(geometricScaling.x<0){signCounter++}if(geometricScaling.y<0){signCounter++}if(geometricScaling.z<0){signCounter++}if(signCounter==1||signCounter==3){polyMesh.flipFaces()}}},getNameFromUID:function(nodeUID){var index=nodeUID.indexOf("#")+1;return index>=0?nodeUID.substr(index):""}}}();exo.resources.importers.obj=exo.resources.importers.ObjImporter={extensions:["obj"],importFile:function(file,ctx,deferred,callback){file.fetchContent(function(err,fileContents){var onLoaded=function(){callback();if(ctx.editor&&!_.isFunction(ctx.editor)){ctx.editor.frameAllMeshes()}};var importerInstance=new exo.resources.importers.ObjLoader(fileContents,ctx,onLoaded,file.get("name"),deferred)})}};!function(){exo.resources.importers.ObjLoader=function(fileContents,ctx,onLoaded,fileName,notification){this.nodeInformation={};this.ctx=ctx;this.nodeParent=ctx("%Scene").first();var nodeParent=this.nodeParent;this.offsetVertex=0;this.offsetNormal=0;this.offsetUV=0;this.materials={};var currentGroup="",previousGroup="";var lines=fileContents.split("\n");var vertexCounter=0;var groupCounter=0;var groupCreated=false;var data=null;var that=this;this.nVertex=0;this.nNormal=0;this.nUV=0;this.nVertex=0;this.nMaterialIDs=0;var createGroup=function(){var defaults={name:fileName.split(".")[0],objectNames:[],groupNames:[],vertices:[],faces:[],faceCount:3,UVs:[],uvIndices:[],normals:[],normalIndices:[],material:[],materialID:{}};groupCounter++;previousGroup=currentGroup;currentGroup=fileName.split(".")[0]+"_"+groupCounter;that.nodeInformation[currentGroup]={};_.extend(that.nodeInformation[currentGroup],defaults);that.nodeInformation[currentGroup].name=fileName.split(".")[0]+"_"+groupCounter;data=that.nodeInformation[currentGroup];if(groupCounter===1){previousGroup=currentGroup}that.offsetVertex=that.nVertex;that.offsetNormal=that.nNormal;that.offsetUV=that.nUV;that.nMaterialIDs=0;groupCreated=true};createGroup();var index=-1;var line="";var length=lines.length;var percentage=Math.floor(length/100);var parseNextLine=function(){++index;for(;index<length;++index){line=lines[index].trim();var elements=line.split(/\s+/g);if(elements[0]==="v"){if(vertexCounter===0&&!groupCreated){createGroup()}that.loadVertices(data.vertices,elements);vertexCounter++}else if(elements[0]==="o"){if(elements[1]){that.nodeInformation[currentGroup].objectName=elements[1]}}else if(elements[0]==="g"){if(elements[1]){that.nodeInformation[currentGroup].groupNames.push(elements[1])}}else if(elements[0]==="f"){that.loadFaces(elements,currentGroup);vertexCounter=0;groupCreated=false}else if(elements[0]==="vt"){that.loadUVs(data.UVs,elements)}else if(elements[0]==="vn"){that.loadNormals(data.normals,elements)}else if(elements[0]==="usemtl"){var materialObj=that.loadMaterial(elements,that.nodeInformation[currentGroup].faces.length);if(materialObj){that.nodeInformation[currentGroup].material.push(materialObj)}}if(index%(percentage*10)===0){break}}if(index<length){notification.notify(index/length*100);setTimeout(parseNextLine,1)}else{notification.notify(100);setTimeout(onCompleted,1)}};var checkIndices=function(indices){var hasIndices=!!(indices&&indices.length);
if(hasIndices){for(var i=0;i<indices.length&&hasIndices;++i){var list=indices[i];if(list===undefined)hasIndices=false;for(var j=0;j<list.length&&hasIndices;++j){if(list[j]===undefined||list[j]<0)hasIndices=false}}}return hasIndices};var onCompleted=function(){_.each(that.nodeInformation,function(information,group){if(information.faces.length){var name=this.getName(information);var mesh=new exo.geometry.PolyMesh(information.faces,information.vertices,true);if(information.normals&&information.normals.length&&checkIndices(information.normalIndices)){mesh.normalMap=new exo.geometry.PolyMap(information.normalIndices,information.normals,true)}if(information.UVs&&information.UVs.length&&checkIndices(information.uvIndices)){mesh.uvMaps[exo.geometry.PolyMesh.DEFAULT_MAP]=new exo.geometry.PolyMap(information.uvIndices,information.UVs,true)}var errorList=mesh.validate(false);if(errorList.length===0){this.loadNode(onLoaded,nodeParent,mesh,information.material,name)}else{console.log("Loading Obj file with errors: \n"+errorList.join("\n"))}}},that)};parseNextLine()};exo.resources.importers.ObjLoader.prototype={constructor:THREE.ObjLoader,loadVertices:function(originalVertices,elements){originalVertices.push((new THREE.Vector3).set(parseFloat(elements[1]),parseFloat(elements[2]),parseFloat(elements[3])));this.nVertex++},getName:function(groupInfo){var name="";if(groupInfo.objectNames.length){name=groupInfo.objectNames[0]}else if(groupInfo.groupNames.length===1){name=groupInfo.groupNames[0]}else{name=groupInfo.name}return name},loadFaces:function(elements,currentGroup){var offsetVertex=this.offsetVertex;var offsetUV=this.offsetUV;var offsetNormal=this.offsetNormal;var values=elements.slice(1);if(values.length>this.nodeInformation[currentGroup].faceCount){this.nodeInformation[currentGroup].faceCount=values.length}var face=[],uvIndex=[],normalIndex=[];var uvs=this.nodeInformation[currentGroup].UVs;var normals=this.nodeInformation[currentGroup].normals;if(values[0].indexOf("/")!==-1){_.each(values,function(value,index){if(value){var values2=value.split("/");face[index]=parseInt(values2[0]-1-offsetVertex,10);if(uvs.length){if(values2[1]!==undefined){uvIndex[index]=parseInt(values2[1]-1-offsetUV,10)}else{uvIndex[index]=-1}}if(normals.length){if(values2.length>2){if(values2[2]!==undefined){normalIndex[index]=parseInt(values2[2]-1-offsetNormal,10)}}}}})}else{_.each(values,function(value,index){if(value){face[index]=parseInt(value-1,10)}})}this.nodeInformation[currentGroup].faces.push(face);if(uvIndex.length){this.nodeInformation[currentGroup].uvIndices.push(uvIndex)}if(normalIndex.length){this.nodeInformation[currentGroup].normalIndices.push(normalIndex)}},loadUVs:function(originalUVs,elements){originalUVs.push((new THREE.Vector2).set(parseFloat(elements[1]),parseFloat(elements[2])));this.nUV++},loadNormals:function(originalNormals,elements){originalNormals.push((new THREE.Vector3).set(parseFloat(elements[1]),parseFloat(elements[2]),parseFloat(elements[3])));this.nNormal++},createUniqueMaterial:function(matNode,matID){return{node:matNode,matID:matID}},loadMaterial:function(elements,faceIndex){var material;var materialName="";var matID=this.nMaterialIDs;var nodeParent=this.nodeParent;if(elements[1]){materialName=elements[1];var materialCached=this.materials[materialName];if(materialCached){material=materialCached.node;matID=materialCached.matID}else{material=nodeParent.find(function(m){return m.get("type")==="Material"&&m.get("name")===materialName});this.materials[materialName]=this.createUniqueMaterial(material,matID)}if(!material){return null}}this.nMaterialIDs++;return{material:material,name:materialName,matID:matID,faceIndex:faceIndex}},translateNormals:function(normalIndices,originalNormals,group){if(originalNormals.length){_.each(normalIndices,function(indices){var normal=[];_.each(indices,function(index){normal.push(originalNormals[index].clone())});this.nodeInformation[group].normals.push(normal)},this);if(!this.nodeInformation[group].normals.length){this.nodeInformation[group].normals=null}}},loadMaterialIDs:function(polyMesh,materialList){if(materialList.length<2){return[]}var materialIDs=[];var nextItem,startFace,endFace;for(var i=0,il=materialList.length;i<il;i++){nextItem=i+1;startFace=materialList[i].faceIndex;endFace=nextItem>=il?polyMesh.getFacesCount():materialList[nextItem].faceIndex-1;polyMesh.setMaterialIDs(materialList[i].matID,startFace,endFace)}return polyMesh.materialIds},createMaterials:function(nodeParent,materialList,callback){var materialModelList=[];var ctx=this.ctx;var loaded=0;var materialModels=this.materialModels;if(!materialList.length){callback(materialModelList)}else{materialList=this.uniqueMaterialList(materialList);_.each(materialList,function(material){material=material.material;var name=material.name;if(materialModels[name]){loaded++;if(loaded===materialList.length){callback(materialModelList)}}else if(material instanceof exo.sceneGraph.nodes.Material){materialModels[name]=material;materialModelList.push(material);loaded++;if(loaded===materialList.length){callback(materialModelList)}}else{materialModels[name]=true;ctx("%MaterialLibrary").addNode(material.name,"Material",material.plug).then(function(materialModel){materialModels[name]=material;materialModelList.push(materialModel);loaded++;if(loaded===materialList.length){callback(materialModelList)}})}})}},uniqueMaterialList:function(materialList){var materials={};_.each(materialList,function(material){var faceIndex=material.faceIndex;var name=material.material.name;if(materials[name]){material=materials[name]}else{materials[name]=material}material.faceIndices=material.faceIndices||{};material.faceIndices[faceIndex]=true});return _.toArray(materials)},loadMultiMaterialNode:function(nodeParent,materialModelList,name,callback){var ctx=this.ctx;var options={};var matID;for(var i=0,il=materialModelList.length;i<il;i++){matID=materialModelList[i].matID;if(matID>9){continue}var materialName="material"+matID;options[materialName]=materialModelList[i].material.id}var matNodePromise=ctx("%MaterialLibrary").addNode(name,"Material",{Material:{}});matNodePromise.then(function(material){var multiIDPromise=ctx(material).find("#Material").addOperator("MultiID",options);multiIDPromise.then(function(){callback(material)});multiIDPromise.fail(function(material){callback()})});matNodePromise.fail(function(material){callback()})},loadNode:function(onLoaded,nodeParent,polyMesh,materialList,name){var ctx=this.ctx;var loader=this;var onCompleted=function(material){ctx.addFile({name:name+".json",content:polyMesh,type:"application/json",sourceType:"import",internal:true}).then(function(blob){ctx("%Objects").addNode(name,"PolyMesh",{PolyMesh:{Mesh:{geometry:blob}}}).then(function(node){if(material){ctx(node).find("#Material[reference]").set({reference:material.id})}onLoaded()})})};if(materialList.length===1){onCompleted(materialList[0].material)}else if(materialList.length>1){loader.loadMaterialIDs(polyMesh,materialList);loader.loadMultiMaterialNode(nodeParent,materialList,"MultiID_"+name,onCompleted)}else{onCompleted()}}}}();exo.resources.importers.mtl=exo.resources.importers.MtlImporter={extensions:["mtl"],importFile:function(file,ctx,deferred,callback){var mtl=this;file.fetchContent(function(err,fileContents){mtl.importContents(fileContents,ctx,callback,deferred)})},importContents:function(fileContents,ctx,callback,notification){var lines=fileContents.split("\n");var illumination=2;var mat={};var texture;var scene=ctx("%Scene").first();var numLines=lines.length;var materialList=[];this.numMaterialsLoaded=0;_.each(lines,function(line,indexLine){line=line.trim();var elements=line.split(new RegExp("\\s+"));if(elements.length>1){var tag=elements[0];if(tag==="newmtl"){mat={};materialList.push({material:mat,name:elements[1]})}else if(tag==="Ka"||tag==="Kd"||tag==="Ks"||tag==="Ke"&&elements.length>3){var value=[parseFloat(elements[1]),parseFloat(elements[2]),parseFloat(elements[3])];if(tag==="Ka"){mat.ambientColor=exo.math.arrayToColor(value)}else if(tag==="Kd"){mat.diffuseColor=exo.math.arrayToColor(value)}else if(tag==="Ks"){mat.specularColor=exo.math.arrayToColor(value)}else if(tag==="Ke"){mat.emissiveColor=exo.math.arrayToColor(value)}}else if(tag==="d"){mat.opacityFactor=elements[1]}else if(tag==="map_Kd"){texture=exo.resources.importers.mtl.getTexture(scene,_.last(elements));if(texture){mat.diffuseMap=texture}}else if(tag==="map_Ka"){texture=exo.resources.importers.mtl.getTexture(scene,_.last(elements));if(texture){mat.ambientMap=texture}}else if(tag==="map_Ks"){texture=exo.resources.importers.mtl.getTexture(scene,_.last(elements));if(texture){mat.specularMap=texture}}else if(tag==="map_bump"||tag==="bump"){texture=exo.resources.importers.mtl.getTexture(scene,_.last(elements));if(texture){mat.bumpMap=texture}}else if(tag==="Ns"){mat.glossiness=elements[1]}else if(tag==="Ni"){mat.refraction=elements[1]}else if(tag==="bm"){mat.bumpFactor=elements[1]}else if(tag==="illum"){illumination=elements[1]}}notification.notify(indexLine/numLines*100)});var onComplete=function(){notification.notify(100);callback()};this.createMaterial(ctx,materialList,0,onComplete)},createMaterial:function(ctx,materialsInfo,matIndex,onComplete){var properties=materialsInfo[matIndex].material;var name=materialsInfo[matIndex].name;properties.materialType="Phong";var plug={Material:{Standard:properties}};var _createNextMaterial=function(){var nextMatIndex=matIndex+1;if(nextMatIndex>=materialsInfo.length){onComplete()}else{exo.resources.importers.mtl.createMaterial(ctx,materialsInfo,nextMatIndex,onComplete)}};ctx("%MaterialLibrary").addNode(name,"Material",plug).then(function(){_createNextMaterial()},function(err){_createNextMaterial()})},getTexture:function(scene,textureFileName){return scene.files.find(function(f){return f.get("name")===textureFileName})}};exo.resources.importers.stl={extensions:["stl"],importFile:function(file,ctx,deferred,onLoaded){var nodeParent=ctx("%Scene").first();file.fetchContent(function(err,fileContents){var stlLoader=new THREE.STLLoader;var geometry=stlLoader.parse(fileContents);var mesh=new THREE.Mesh(geometry);var fileName=file.get("name");mesh.name=fileName.substr(0,fileName.indexOf("."));exo.translators.three.SceneConverter.convert(mesh,nodeParent.objectsRootNode,ctx,function(model){if(ctx.editor)ctx.editor.frameAllMeshes();onLoaded()})})}};exo.resources.importers.json=exo.resources.importers.ThreeJSON={extensions:["json"],importFile:function(file,ctx,deferred,onLoaded){var nodeParent=ctx("%Scene").first();file.fetchContent(function(err,fileContents){var sceneLoader=new THREE.SceneLoader;sceneLoader.skipTextureLoading=true;var directory=".";var notification=deferred;sceneLoader.callbackProgress=function(progress){var progressAmount=progress.totalModels?progress.loadedModels/progress.totalModels*100:100;notification.notify(progressAmount)};sceneLoader.parse(JSON.parse(fileContents),function(result){result.scene.isScene=true;exo.translators.three.SceneConverter.convert(result.scene,nodeParent,ctx,function(sceneModel){if(ctx.editor)ctx.editor.frameAllMeshes();onLoaded()})},directory)})}};!function(){exo.resources.exporters.obj=exo.resources.exporters.ObjExporter={exportFile:function(root,options,context){var exporterInstance=new exo.resources.exporters.ObjSaver(root);return exporterInstance.fileString}};var empty=function(){};exo.resources.exporters.ObjSaver=function(node,ignoreChildren,noTransform){this.UVs=[];this.geometryUVs=[];this.normals=[];this.geometryNormals=[];this.groupNames=[];this.groupCount=0;this.fileString="# Exported from "+exo.conf.applicationName;this.vertexCount=0;this.UVCount=0;this.normalCount=0;this.exportNode(node,ignoreChildren,noTransform)};exo.resources.exporters.ObjSaver.prototype={constructor:THREE.ObjSaver,exportNode:function(node,ignoreChildren,noTransform){var scene=node.scene();var translation,rotation,scale,polyMesh,material;var name=node.get("name");var type=node.get("type");if(type==="PolyMesh"){polyMesh=node.polyMesh;material=node.plugs.Material.getLastReference();if(material){this.fileString+="\nusemtl "+material.id+"_#"+material.get("name")}if(this.groupNames.indexOf(name)!==-1){name+=this.groupCount}this.groupNames.push(name);this.fileString+="\ng "+name;if(polyMesh&&polyMesh.positions){this.saveFaces(polyMesh,noTransform?new THREE.Matrix4:node.transform.getWorldTransform())}this.groupCount++}if(!ignoreChildren){node.nodes.each(function(childNode,key){this.exportNode(childNode)},this)}return node},saveUVs:function(uvs){_.each(uvs,function(uv,index){this.fileString+="\nvt ";this.fileString+=uv.x+" "+uv.y;this.UVCount++},this);this.fileString+="\n"},saveVertices:function(vertices,transformMatrix){_.each(vertices,function(vertex,index){var newVertex=vertex.clone().applyMatrix4(transformMatrix);newVertex=[newVertex.x,newVertex.y,newVertex.z];var stringToConCat="\nv "+newVertex.join(" ");this.fileString+=stringToConCat;this.vertexCount++},this);this.fileString+="\n"},saveNormals:function(normals){_.each(normals,function(normal,index){this.fileString+="\nvn ";this.fileString+=normal.x+" "+normal.y+" "+normal.z;this.normalCount++},this);this.fileString+="\n"},saveFaces:function(polyMesh,transformMatrix){var vertices=polyMesh.positions;var faces=polyMesh.faces;var uvMap=polyMesh.uvMaps["default"];var uvFaces=uvMap?uvMap.faces:null;var normalMap=polyMesh.normalMap;var normalFaces=polyMesh.normalMap?polyMesh.normalMap.faces:null;var uvs;var vertexCount=this.vertexCount;var newUVCount=this.UVCount;var newNormalCount=this.normalCount;this.saveVertices(vertices,transformMatrix);if(normalMap&&normalMap.values&&normalMap.values.length>0){var normals=normalMap.values;this.saveNormals(normals)}if(uvMap&&uvMap.values&&uvMap.values.length>0){uvs=uvMap.values;this.saveUVs(uvs)}_.each(faces,function(face,index){this.fileString+="\nf ";var uv=uvFaces?uvFaces[index]||[0,0,0]:null;var normalFace=normalFaces?normalFaces[index]||[0,0,0]:null;var faceSize=face.length-1;_.each(face,function(element,faceIndex){this.fileString+=element+1+vertexCount;if(uvFaces){this.fileString+="/"+(uv[faceIndex]+1+newUVCount)}if(normalFaces){this.fileString+="/"+(normalFace[faceIndex]+1+newNormalCount)}if(faceIndex<faceSize){this.fileString+=" "}},this)},this)}}}();!function(){exo.resources.exporters.dae=exo.resources.exporters.ColladaExporter={exportFile:function(root,options,context){var exporterInstance=new exo.resources.exporters.ColladaSaver(root);return exporterInstance.fileString}};var nodeTypes={PolyMesh:true,Camera:true,Light:true,Null:true};exo.resources.exporters.ColladaSaver=function(root){this.scene=root.scene();this.textures={};this.meshes={};this.materials={};this.nodes=[];this.saveNode(root);this.buildFile(root)};exo.resources.exporters.ColladaSaver.prototype={buildFile:function(root){var allModel={cameras:[],lights:[],images:[],materials:[],effects:[],meshes:[],nodes:[],toolName:exo.conf.applicationName,date:(new Date).toString(),sceneName:root.get("name")};_.each(this.meshes,function(mesh,key){allModel.meshes.push(this.buildMeshModel(key,mesh))},this);_.each(this.materials,function(material,key){allModel.materials.push({id:key,name:material.get("name")});allModel.effects.push(this.buildEffectsModel(key,material))},this);_.each(this.textures,function(texture,key){allModel.images.push(this.buildTextureModel(key,texture))},this);_.each(this.nodes,function(node,key){if(nodeTypes[node.type]){allModel.nodes.push(this.buildNodeModel(node));if(node.type==="Camera"){allModel.cameras.push(this.buildCameraModel(node))}else if(node.type==="Light"){allModel.lights.push(this.buildLightModel(node))}}},this);this.fileString=nct.render("editor/collada",allModel)},buildTextureModel:function(key,texture){var filename=texture.get("name");return{fileName:filename,fileId:filename.replace(".","-")}},buildEffectsModel:function(key,materialNode){var materialPrimitive=materialNode.material;var material=materialPrimitive.getMaterialProperties();var texture=material.diffuseMap;var hasTexture=!!texture;return{color:toColor(material.diffuseColor),specular:toColor(material.specularColor),opacity:material.opacity||1,hasTexture:hasTexture,id:key,fileName:hasTexture?texture.get("name"):"",fileId:hasTexture?texture.get("name").replace(".","-"):""}},buildCameraModel:function(node){return _.extend(node,node.camera)},buildLightModel:function(node){var light=node.light;node=_.extend(node,node.light);node.color=toColor(light.color);if(node.intensity!==undefined){node.intensity=""+node.intensity}if(node.distance!==undefined){node.distance=""+node.distance}node.lightType=light.lightType.replace("Light","").toLowerCase();return node},buildNodeModel:function(node){var children=_.map(node.children,function(child){return this.buildNodeModel(child)},this);return{name:node.name,id:node.id,children:children,mesh:node.mesh||"",rotationX:""+(node.rotation?node.rotation.x:0),rotationY:""+(node.rotation?node.rotation.y:0),rotationZ:""+(node.rotation?node.rotation.z:0),materialId:node.materialId,position:node.position?joinVector3(node.position," "):"",scale:node.scale?joinVector3(node.scale," "):"",hasTextures:!!node.materialId,isCamera:node.type==="Camera",isLight:node.type==="Light"}},buildMeshModel:function(name,mesh){var vertices=mesh.positions;var faces=mesh.faces;var normals=mesh.normalMap?mesh.normalMap.values:null;var uvs=mesh.uvMaps[exo.geometry.PolyMesh.DEFAULT_MAP]||null;if(uvs){uvs=uvs.values}return{name:name,vertices:joinEach(vertices," "),positionLength:vertices.length,positionFullLength:vertices.length*3,faceLength:faces.length,faces:packFaces(mesh),normals:normals?joinEach(normals," "):"",normalsLength:normals?normals.length:0,normalsFullLength:normals?normals.length*3:0,uvs:uvs?joinEach(uvs," "):"",uvsLength:uvs?uvs.length:0,uvsFullLength:uvs?uvs.length*2:0}},saveNode:function(node,isChild){var originalNode=node;var creationOperator=node[node.get("type")]&&node[node.get("type")].operators.length?node[node.get("type")].operators.at(0).operator:null;var transform=originalNode.transform;var material=originalNode.material;var reference=originalNode.Material?originalNode.Material.getLastReference():null;node={name:originalNode.get("name"),type:originalNode.get("type"),id:originalNode.id,parentId:originalNode.parentNode()?originalNode.parentNode().id:"",children:[],material:material,materialId:reference?reference.id:"",mesh:originalNode.polyMesh,creationOperatorName:creationOperator?creationOperator.name:originalNode.type,position:transform?transform.getTranslation():null,rotation:transform?transform.getRotation():null,scale:transform?transform.getScale():null,light:node.light,camera:node.camera};if(node.type==="Material"){this.materials[node.id]=originalNode}if(node.type==="Texture"){this.textures[node.id]=originalNode}this.cacheMesh(node,node.mesh);originalNode.nodes.each(function(childNode,key){node.children.push(this.saveNode(childNode,node.type!=="Scene"&&node.type!=="Objects"))},this);if(!isChild||node.type==="Texture"||node.type==="Material"){this.nodes.push(node)}return node},cacheMesh:function(node,mesh){if(mesh){var name=mesh.name||node.name||node.id;mesh=mesh.clone().triangulate();if(!this.meshes[name]){this.meshes[name]=mesh}else if(!_.isEqual(this.meshes[name].positions,mesh.positions)||!_.isEqual(this.meshes[name].faces,mesh.faces)){name+=node.id;this.meshes[name]=mesh}node.mesh=name}}};var joinEach=function(arr,seperator){var str="";_.each(arr,function(innerArray,index){if(innerArray[0]&&innerArray[0].length){str+=joinEach(innerArray,seperator)}else if(innerArray instanceof THREE.Vector3){str+=joinVector3(innerArray,seperator)}else if(innerArray instanceof THREE.Vector2){str+=joinVector2(innerArray,seperator)}else if(innerArray.length){str+=Array.prototype.join.call(innerArray,seperator)}if(index<arr.length-1){str+=seperator}});return str};var joinVector2=function(vec,seperator){return vec.x+seperator+vec.y};var joinVector3=function(vec,seperator){return vec.x+seperator+vec.y+seperator+vec.z};var packFaces=function(mesh){var str="";var uvFaces=mesh.uvMaps[exo.geometry.PolyMesh.DEFAULT_MAP];if(uvFaces){uvFaces=uvFaces.faces}var normalFaces=mesh.normalMap?mesh.normalMap.faces:null;var faces=mesh.faces;_.each(faces,function(face,index){_.each(face,function(facePart,index2){str+=facePart;if(normalFaces){str+=" "+normalFaces[index][index2]}if(uvFaces){if(!normalFaces){str+=" 0"}str+=" "+uvFaces[index][index2]}str+=" "})});return str.trim()};var toColor=function(colour){var str="";if(colour){str+=colour.r+" "+colour.g+" "+colour.b}return str}}();THREE.SceneExporter=function(){};THREE.SceneExporter.prototype={constructor:THREE.SceneExporter,parse:function(scene){var position=Vector3String(scene.position);var rotation=Vector3String(scene.rotation);var scale=Vector3String(scene.scale);var nobjects=0;var ngeometries=0;var nmaterials=0;var ntextures=0;var nembeds=0;var objectsArray=[];var geometriesArray=[];var materialsArray=[];var texturesArray=[];var fogsArray=[];var embedsMap={};var geometriesMap={};var materialsMap={};var texturesMap={};var TRIANGLE=0,QUAD=1,FACE_MATERIAL=2,FACE_UV=4,FACE_VERTEX_UV=8,FACE_NORMAL=16,FACE_VERTEX_NORMAL=32,FACE_COLOR=64,FACE_VERTEX_COLOR=128;function isBitSet(value,position){return value&1<<position}var checkTexture=function(map){if(!map)return;if(!(map.id in texturesMap)){texturesMap[map.id]=true;texturesArray.push(TextureString(map));ntextures+=1}};var linesArray=[];function createObjectsList(object,pad){var childMap={};for(var i=0;i<object.children.length;i++){var node=object.children[i];if(node instanceof THREE.Mesh){linesArray.push(MeshString(node,pad,childMap));nobjects+=1;if(!(node.geometry.id in geometriesMap)){geometriesMap[node.geometry.id]=true;geometriesArray.push(GeometryString(node.geometry));ngeometries+=1}if(!(node.material.id in materialsMap)){materialsMap[node.material.id]=true;materialsArray.push(MaterialString(node.material));nmaterials+=1;checkTexture(node.material.map);checkTexture(node.material.envMap);checkTexture(node.material.lightMap);checkTexture(node.material.specularMap);checkTexture(node.material.bumpMap);checkTexture(node.material.normalMap)}}else if(node instanceof THREE.Light){linesArray.push(LightString(node,pad,childMap));nobjects+=1}else if(node instanceof THREE.Camera){linesArray.push(CameraString(node,pad,childMap));nobjects+=1}else if(node instanceof THREE.Object3D){linesArray.push(ObjectString(node,pad,childMap));nobjects+=1}if(node.children.length>0){linesArray.push(PaddingString(pad+1)+'		"children" : {')}createObjectsList(node,pad+2);if(node.children.length>0){linesArray.push(PaddingString(pad+1)+"		}")}linesArray.push(PaddingString(pad)+"		}"+(i<object.children.length-1?",\n":""))}}createObjectsList(scene,0);var objects=linesArray.join("\n");if(scene.fog){fogsArray.push(FogString(scene.fog))}var geometries=generateMultiLineString(geometriesArray,",\n\n	");var materials=generateMultiLineString(materialsArray,",\n\n	");var textures=generateMultiLineString(texturesArray,",\n\n	");var fogs=generateMultiLineString(fogsArray,",\n\n	");var activeCamera=null;scene.traverse(function(node){if(node instanceof THREE.Camera&&node.userData&&node.userData.active){activeCamera=node}});var defcamera=LabelString(activeCamera?getObjectName(activeCamera):"");var deffog=LabelString(scene.fog?getFogName(scene.fog):"");function Vector2String(v){return"["+v.x+","+v.y+"]"}function Vector3String(v){return"["+v.x+","+v.y+","+v.z+"]"}function ColorString(c){return"["+c.r.toFixed(3)+","+c.g.toFixed(3)+","+c.b.toFixed(3)+"]"}function LabelString(s,id,map){if(map&&map[s]){s+=id}return'"'+s+'"'}function NumConstantString(c){var constants=["NearestFilter","NearestMipMapNearestFilter","NearestMipMapLinearFilter","LinearFilter","LinearMipMapNearestFilter","LinearMipMapLinearFilter"];for(var i=0;i<constants.length;i++){if(THREE[constants[i]]===c)return LabelString(constants[i])}return""}function PaddingString(n){var output="";for(var i=0;i<n;i++)output+="	";return output}function LightString(o,n,childMap){var output;if(o instanceof THREE.AmbientLight){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"  : "AmbientLight",','  "color" : '+o.color.getHex()+(o.children.length?",":"")]}else if(o instanceof THREE.DirectionalLight){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"      : "DirectionalLight",','  "color"     : '+o.color.getHex()+",",'  "intensity" : '+o.intensity+",",'  "direction" : '+Vector3String(o.position)+",",'  "target"    : '+LabelString(getObjectName(o.target))+(o.children.length?",":"")]}else if(o instanceof THREE.PointLight){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"      : "PointLight",','  "color"     : '+o.color.getHex()+",",'  "intensity" : '+o.intensity+",",'  "position"  : '+Vector3String(o.position)+",",'  "distance"  : '+o.distance+(o.children.length?",":"")]}else if(o instanceof THREE.SpotLight){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"      : "SpotLight",','  "color"     : '+o.color.getHex()+",",'  "intensity" : '+o.intensity+",",'  "position"  : '+Vector3String(o.position)+",",'  "distance"  : '+o.distance+",",'  "angle"     : '+o.angle+",",'  "exponent"  : '+o.exponent+",",'  "target"    : '+LabelString(getObjectName(o.target))+(o.children.length?",":"")]}else if(o instanceof THREE.HemisphereLight){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"        : "HemisphereLight",','  "skyColor"    : '+o.color.getHex()+",",'  "groundColor" : '+o.groundColor.getHex()+",",'  "intensity"   : '+o.intensity+",",'  "position"    : '+Vector3String(o.position)+(o.children.length?",":"")]}else{output=[]}return generateMultiLineString(output,"\n		",n)}function CameraString(o,n,childMap){var output;if(o instanceof THREE.PerspectiveCamera){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"     : "PerspectiveCamera",','  "fov"      : '+o.fov+",",'  "aspect"   : '+o.aspect+",",'  "near"     : '+o.near+",",'  "far"      : '+o.far+",",'  "position" : '+Vector3String(o.position)+(o.children.length?",":"")]}else if(o instanceof THREE.OrthographicCamera){output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "type"     : "OrthographicCamera",','  "left"     : '+o.left+",",'  "right"    : '+o.right+",",'  "top"      : '+o.top+",",'  "bottom"   : '+o.bottom+",",'  "near"     : '+o.near+",",'  "far"      : '+o.far+",",'  "position" : '+Vector3String(o.position)+(o.children.length?",":"")]}else{output=[]}return generateMultiLineString(output,"\n		",n)}function ObjectString(o,n,childMap){var output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "position" : '+Vector3String(o.position)+",",'  "rotation" : '+Vector3String(o.rotation)+",",'  "scale"     : '+Vector3String(o.scale)+",",'  "visible"  : '+o.visible+(o.children.length?",":"")];return generateMultiLineString(output,"\n		",n)}function MeshString(o,n,childMap){var output=["		"+LabelString(getObjectName(o),o.id,childMap)+" : {",'  "geometry" : '+LabelString(getGeometryName(o.geometry))+",",'  "material" : '+LabelString(getMaterialName(o.material))+",",'  "position" : '+Vector3String(o.position)+",",'  "rotation" : '+Vector3String(o.rotation)+",",'  "scale"     : '+Vector3String(o.scale)+",",'  "visible"  : '+o.visible+(o.children.length?",":"")];return generateMultiLineString(output,"\n		",n)}function GeometryString(g){var output;if(g instanceof THREE.SphereGeometry){output=["	"+LabelString(getGeometryName(g))+": {",'  "type"    : "sphere",','  "radius"  : '+g.radius+",",'  "widthSegments"  : '+g.widthSegments+",",'  "heightSegments" : '+g.heightSegments,"}"]}else if(g instanceof THREE.CubeGeometry){output=["	"+LabelString(getGeometryName(g))+": {",'  "type"    : "cube",','  "width"  : '+g.width+",",'  "height"  : '+g.height+",",'  "depth"  : '+g.depth+",",'  "widthSegments"  : '+g.widthSegments+",",'  "heightSegments" : '+g.heightSegments+",",'  "depthSegments" : '+g.depthSegments,"}"]}else if(g instanceof THREE.PlaneGeometry){output=["	"+LabelString(getGeometryName(g))+": {",'  "type"    : "plane",','  "width"  : '+g.width+",",'  "height"  : '+g.height+",",'  "widthSegments"  : '+g.widthSegments+",",'  "heightSegments" : '+g.heightSegments,"}"]}else if(g instanceof THREE.Geometry){if(g.sourceType==="ascii"||g.sourceType==="ctm"||g.sourceType==="stl"||g.sourceType==="vtk"){output=["	"+LabelString(getGeometryName(g))+": {",'  "type" : '+LabelString(g.sourceType)+",",'  "url"  : '+LabelString(g.sourceFile),"}"]}else{output=["	"+LabelString(getGeometryName(g))+": {",'  "type" : '+'"embedded"'+",",'  "id"  : '+g.id,"}"];if(!embedsMap[g.id]){embedsMap[g.id]=ConvertEmbeddedGeometry(g);nembeds++}}}else{output=[]}return generateMultiLineString(output,"\n		")}function ConvertEmbeddedGeometry(g){var vertices=[];var faces=[];var normals=[];var uvs=[];var faceVertexUvs=g.faceVertexUvs&&g.faceVertexUvs.length?g.faceVertexUvs[0]:null;g=g.clone();g.materials=g.materials||[];for(var i=0,length=g.vertices.length;i<length;++i){var vertex=g.vertices[i];vertices.push(vertex.x);vertices.push(vertex.y);vertices.push(vertex.z)}for(var i=0,length=g.faces.length;i<length;++i){var face=g.faces[i];var faceVertexUv=faceVertexUvs[i];var mask=DetermineFaceMask(face,faceVertexUv);var isQuad=isBitSet(mask,0),hasMaterial=isBitSet(mask,1),hasFaceUv=isBitSet(mask,2),hasFaceVertexUv=isBitSet(mask,3),hasFaceNormal=isBitSet(mask,4),hasFaceVertexNormal=isBitSet(mask,5),hasFaceColor=isBitSet(mask,6),hasFaceVertexColor=isBitSet(mask,7);faces.push(mask);faces.push(face.a);faces.push(face.b);faces.push(face.c);if(isQuad)faces.push(face.d);if(hasFaceVertexUv){faces.push(uvs.length/2);uvs.push(faceVertexUv[0].x);uvs.push(faceVertexUv[0].y);faces.push(uvs.length/2);uvs.push(faceVertexUv[1].x);uvs.push(faceVertexUv[1].y);faces.push(uvs.length/2);uvs.push(faceVertexUv[2].x);uvs.push(faceVertexUv[2].y);if(isQuad){faces.push(uvs.length/2);uvs.push(faceVertexUv[3].x);uvs.push(faceVertexUv[3].y)}}if(hasFaceVertexNormal){faces.push(normals.length/3);normals.push(face.vertexNormals[0].x);normals.push(face.vertexNormals[0].y);normals.push(face.vertexNormals[0].z);faces.push(normals.length/3);normals.push(face.vertexNormals[1].x);normals.push(face.vertexNormals[1].y);normals.push(face.vertexNormals[1].z);faces.push(normals.length/3);normals.push(face.vertexNormals[2].x);normals.push(face.vertexNormals[2].y);normals.push(face.vertexNormals[2].z);if(isQuad){faces.push(normals.length/3);if(isQuad)normals.push(face.vertexNormals[3].x);if(isQuad)normals.push(face.vertexNormals[3].y);if(isQuad)normals.push(face.vertexNormals[3].z)}}}g.vertices=vertices;g.faces=faces;g.normals=normals;g.uvs=[uvs];delete g.faceVertexUvs;return g}function DetermineFaceMask(face,faceUVs){var mask=TRIANGLE;if(face.d!==undefined)mask|=QUAD;if(faceUVs)mask|=FACE_VERTEX_UV;if(face.vertexNormals&&face.vertexNormals.length)mask|=FACE_VERTEX_NORMAL;return mask}function MaterialString(m){var output;if(m instanceof THREE.MeshBasicMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshBasicMaterial",','  "parameters"  : {','    "color"  : '+m.color.getHex()+",",m.map?'    "map" : '+LabelString(getTextureName(m.map))+",":"",m.envMap?'    "envMap" : '+LabelString(getTextureName(m.envMap))+",":"",m.specularMap?'    "specularMap" : '+LabelString(getTextureName(m.specularMap))+",":"",m.lightMap?'    "lightMap" : '+LabelString(getTextureName(m.lightMap))+",":"",'    "reflectivity"  : '+m.reflectivity+",",'    "transparent" : '+m.transparent+",",'    "opacity" : '+m.opacity+",",'    "wireframe" : '+m.wireframe+",",'    "wireframeLinewidth" : '+m.wireframeLinewidth,"  }","}"]}else if(m instanceof THREE.MeshLambertMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshLambertMaterial",','  "parameters"  : {','    "color"  : '+m.color.getHex()+",",'    "ambient"  : '+m.ambient.getHex()+",",'    "emissive"  : '+m.emissive.getHex()+",",m.map?'    "map" : '+LabelString(getTextureName(m.map))+",":"",m.envMap?'    "envMap" : '+LabelString(getTextureName(m.envMap))+",":"",m.specularMap?'    "specularMap" : '+LabelString(getTextureName(m.specularMap))+",":"",m.lightMap?'    "lightMap" : '+LabelString(getTextureName(m.lightMap))+",":"",'    "reflectivity"  : '+m.reflectivity+",",'    "transparent" : '+m.transparent+",",'    "opacity" : '+m.opacity+",",'    "wireframe" : '+m.wireframe+",",'    "wireframeLinewidth" : '+m.wireframeLinewidth,"  }","}"]
}else if(m instanceof THREE.MeshPhongMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshPhongMaterial",','  "parameters"  : {','    "color"  : '+m.color.getHex()+",",'    "ambient"  : '+m.ambient.getHex()+",",'    "emissive"  : '+m.emissive.getHex()+",",'    "specular"  : '+m.specular.getHex()+",",'    "shininess" : '+m.shininess+",",m.map?'    "map" : '+LabelString(getTextureName(m.map))+",":"",m.envMap?'    "envMap" : '+LabelString(getTextureName(m.envMap))+",":"",m.specularMap?'    "specularMap" : '+LabelString(getTextureName(m.specularMap))+",":"",m.lightMap?'    "lightMap" : '+LabelString(getTextureName(m.lightMap))+",":"",m.normalMap?'    "normalMap" : '+LabelString(getTextureName(m.normalMap))+",":"",m.bumpMap?'    "bumpMap" : '+LabelString(getTextureName(m.bumpMap))+",":"",'    "bumpScale"  : '+m.bumpScale+",",'    "reflectivity"  : '+m.reflectivity+",",'    "transparent" : '+m.transparent+",",'    "opacity" : '+m.opacity+",",'    "wireframe" : '+m.wireframe+",",'    "wireframeLinewidth" : '+m.wireframeLinewidth,"  }","}"]}else if(m instanceof THREE.MeshDepthMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshDepthMaterial",','  "parameters"  : {','    "transparent" : '+m.transparent+",",'    "opacity" : '+m.opacity+",",'    "wireframe" : '+m.wireframe+",",'    "wireframeLinewidth" : '+m.wireframeLinewidth,"  }","}"]}else if(m instanceof THREE.MeshNormalMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshNormalMaterial",','  "parameters"  : {','    "transparent" : '+m.transparent+",",'    "opacity" : '+m.opacity+",",'    "wireframe" : '+m.wireframe+",",'    "wireframeLinewidth" : '+m.wireframeLinewidth,"  }","}"]}else if(m instanceof THREE.MeshFaceMaterial){output=["	"+LabelString(getMaterialName(m))+": {",'  "type"    : "MeshFaceMaterial",','  "parameters"  : {}',"}"]}return generateMultiLineString(output,"\n		")}function TextureString(t){var output=["	"+LabelString(getTextureName(t))+": {",'  "url"    : "'+t.sourceFile+'",','  "repeat" : '+Vector2String(t.repeat)+",",'  "offset" : '+Vector2String(t.offset)+",",'  "magFilter" : '+NumConstantString(t.magFilter)+",",'  "minFilter" : '+NumConstantString(t.minFilter)+",",'  "anisotropy" : '+t.anisotropy,"}"];return generateMultiLineString(output,"\n		")}function FogString(f){var output;if(f instanceof THREE.Fog){output=["	"+LabelString(getFogName(f))+": {",'  "type"  : "linear",','  "color" : '+ColorString(f.color)+",",'  "near"  : '+f.near+",",'  "far"   : '+f.far,"}"]}else if(f instanceof THREE.FogExp2){output=["	"+LabelString(getFogName(f))+": {",'  "type"    : "exp2",','  "color"   : '+ColorString(f.color)+",",'  "density" : '+f.density,"}"]}else{output=[]}return generateMultiLineString(output,"\n		")}function generateMultiLineString(lines,separator,padding){var cleanLines=[];for(var i=0;i<lines.length;i++){var line=lines[i];if(line){if(padding)line=PaddingString(padding)+line;cleanLines.push(line)}}return cleanLines.join(separator)}function getObjectName(o){return o.name?o.name:"Object_"+o.id}function getGeometryName(g){return g.name?g.name:"Geometry_"+g.id}function getMaterialName(m){return m.name?m.name:"Material_"+m.id}function getTextureName(t){return t.name?t.name:"Texture_"+t.id}function getFogName(f){return f.name?f.name:"Default fog"}var output=["{",'  "metadata": {','    "formatVersion" : 3.2,','    "type"    : "scene",','    "generatedBy"  : "SceneExporter",','    "objects"       : '+nobjects+",",'    "geometries"    : '+ngeometries+",",'    "materials"     : '+nmaterials+",",'    "embeds"     : '+nembeds+",",'    "textures"      : '+ntextures,"  },","",'  "urlBaseType": "relativeToScene",',"",'  "objects" :',"  {",objects,"  },","",'  "geometries" :',"  {","	"+geometries,"  },","",'  "materials" :',"  {","	"+materials,"  },","",'  "textures" :',"  {","	"+textures,"  },","",'  "fogs" :',"  {","	"+fogs,"  },","",'  "transform" :',"  {",'    "position"  : '+position+",",'    "rotation"  : '+rotation+",",'    "scale"     : '+scale,"  },","",'  "defaults" :',"  {",'    "camera"  : '+defcamera+",",'    "fog"      : '+deffog,"  },",'  "embeds" : '+JSON.stringify(embedsMap),"","}"].join("\n");return JSON.parse(output)}};!function(){exo.resources.exporters.json=exo.resources.exporters.JSONExporter={exportFile:function(root,options,context){var displayScene=context.displayScene;var threeScene=recreateScene(displayScene.threeScene);var exporter=new THREE.SceneExporter;var sceneObject=exporter.parse(threeScene);var fileString=JSON.stringify(sceneObject);return fileString}};var recreateScene=function(oldScene){var scene=new THREE.Scene;var children=oldScene.children||[];var nodesUsed={};var namesUsed={};children.forEach(function(obj){if(!obj.isHelper){addObjectCheck(cloneObject(obj),scene,nodesUsed,namesUsed)}});return scene};var addObjectCheck=function(obj,parent,nodesUsed,namesUsed){var children=obj.children||[];obj.children=[];if(obj.owner&&obj.owner.model&&obj.owner.model.scene()&&!nodesUsed[obj.owner.model.id]){var type=obj.owner.model.get("type");if(type==="PolyMesh"){if(children.length){var mesh=cloneObject(obj.owner.mesh);if(children.length>1){children=children.splice(1)}else{children=[]}copyTransform(obj,mesh);parent.add(mesh);parent=mesh;mesh.name=findName(obj.owner.model.get("name"),namesUsed);var materialPlug=obj.owner.model.Material;var referenceOp=materialPlug?materialPlug.getLastReference():null;if(referenceOp){mesh.material.name=referenceOp.get("name")}nodesUsed[obj.owner.model.id]=mesh;if(obj.owner.model.properties){mesh.visible=obj.owner.model.properties.visible}}}else if(type==="Light"&&obj instanceof THREE.Light||type==="Camera"&&obj instanceof THREE.Camera){parent.add(obj);parent=obj;obj.name=findName(obj.owner.model.get("name"),namesUsed);nodesUsed[obj.owner.model.id]=obj;if(obj.owner.model.properties){obj.visible=obj.owner.model.properties.visible}}}children.forEach(function(child){if(!child.isHelper){addObjectCheck(child,parent,nodesUsed,namesUsed)}})};var findName=function(name,namesUsed){var objName=name,num=0;while(namesUsed[objName]){objName=name+num++}namesUsed[objName]=true;return objName};var cloneObject=function(obj){var clone;var children=obj.children||[];if(obj instanceof THREE.PointLight){clone=_.extend(new THREE.PointLight,obj)}else if(obj instanceof THREE.SpotLight){clone=_.extend(new THREE.SpotLight,obj)}else if(obj instanceof THREE.DirectionalLight){clone=_.extend(new THREE.SpotLight,obj)}else if(obj instanceof THREE.PerspectiveCamera){clone=_.extend(new THREE.PerspectiveCamera,obj)}else if(obj instanceof THREE.OrthographicCamera){clone=_.extend(new THREE.OrthographicCamera,obj)}else{clone=obj.clone()}clone.children=[];clone.owner=obj.owner||null;clone.isHelper=obj.isHelper||false;children.forEach(function(child){clone.add(cloneObject(child))});return clone};var copyTransform=function(source,dest){dest.position=source.position;dest.rotation=source.rotation;dest.quaternion=source.quaternion;dest.useQuaternion=source.useQuaternion}}();exo.resources.exporters.jsfbx=exo.resources.exporters.FBXExporter={exportFile:function(rootNode,options,context){var exporterInstance=new exo.resources.exporters.FBXSaver(rootNode,options);return exporterInstance.fileString}};!function(){exo.resources.exporters.FBXSaver=function(rootNode,options){this.fileString="";this.rootNode=rootNode;this.exporAnimations=true;this.exportSkins=true;this.embeddedTextures=true;this.prettyPrint=true;this.recursiveSave=rootNode.get("type")==="Scene"?true:false;var objectsOutput={},materialsOutput={},timelineOutput={},texturesOutput={},skinsOutput={},bindPoseOutput={},animationsOutput={};var scene=rootNode.scene();if(!scene){return}var objNodes=scene.objectsRootNode;if(this.exporAnimations){timelineOutput=this.saveTimeLine()}this.saveTexture(scene,texturesOutput);scene.each(function(nodeMaterial){if(nodeMaterial.get("type")==="Material"){this.saveMaterial(nodeMaterial,materialsOutput)}},this);objNodes.nodes.each(function(node){this.saveObjectsChildren(node,objectsOutput)},this);if(this.exportSkins){objNodes.each(function(node){this.saveSkins(scene,node,skinsOutput,bindPoseOutput)},this);this.saveBindPoseParents(scene,bindPoseOutput)}if(this.exporAnimations){objNodes.each(function(node){this.saveKeyFrames(node,animationsOutput)},this)}var finalOutput={metadata:{file:"Exported from "+exo.conf.applicationName,type:exo.conf.applicationName+" to FBX",embeddedTextures:true},timeline:timelineOutput,objects:objectsOutput,materials:materialsOutput,textures:texturesOutput,skins:skinsOutput,bindPose:bindPoseOutput,animations:animationsOutput};if(this.prettyPrint){this.fileString=JSON.stringify(finalOutput,null,"	")}else{this.fileString=JSON.stringify(finalOutput)}};exo.resources.exporters.FBXSaver.prototype={constructor:exo.resources.exporters.FBXSaver,saveTimeLine:function(){var timeline=this.rootNode.scene().timeline;if(!timeline){console.log("Timeline is not found! Exporting a default FPS...");return{startFrame:0,endFrame:100,fps:29.97}}return{startFrame:timeline.animationStartFrame,endFrame:timeline.animationEndFrame,fps:timeline.getFramesPerSecond()}},saveObjectsChildren:function(node,output){var properties={};var materials=[];var transformLocal={};var nodeType=node.get("type");var counter=0;var operatorsActiveState=[];var disableOperators=false;if(nodeType==="PolyMesh"){var polyMeshPlug=node.PolyMesh;transformLocal=this.saveTransformation(node);var materialOperator=node.Material.operators.last();if(materialOperator){var materialRef=materialOperator.get("reference");if(materialRef&&materialRef.id){materials.push(materialRef.id)}}operatorsActiveState=[];if(this.exportSkins){disableOperators=false;polyMeshPlug.operators.each(function(operator){operatorsActiveState.push(operator.get("active"));if(operator.get("name")==="Skin"){disableOperators=true}if(disableOperators){operator.ctx().set("active",false)}});polyMeshPlug.applyOperators()}output[node.id]={fbx_type:"eMesh",name:node.get("name"),polymesh:node.polyMesh,materials:materials,transform:transformLocal};if(this.exportSkins&&disableOperators){counter=0;polyMeshPlug.operators.each(function(operator){operator.ctx().set("active",operatorsActiveState[counter]);counter++});polyMeshPlug.applyOperators()}}else if(nodeType==="Light"){var light=node.light;var lightType=light.lightType;properties.color=light.color;properties.intensity=light.intensity;properties.type=lightType;properties.target={};transformLocal=this.saveTransformation(node);if(lightType==="DirectionalLight"){}else if(lightType==="PointLight"){properties.distance=light.distance;properties.exponent=light.falloffExponent}else if(lightType==="SpotLight"){properties.distance=light.distance;properties.coneAngle=light.coneAngle;properties.exponent=light.falloffExponent}output[node.id]={fbx_type:"eLight",name:node.get("name"),properties:properties,transform:transformLocal}}else if(nodeType==="Camera"){var camera=node.camera;var cameraType=camera.projection==="Orthographic"?"OrthographicCamera":"PerspectiveCamera";properties.nearClip=camera.nearClip;properties.farClip=camera.farClip;properties.type=cameraType;properties.target={};transformLocal=this.saveTransformation(node);if(cameraType==="PerspectiveCamera"){properties.fieldOfView=camera.fieldOfView;properties.aspectRatio=camera.aspectRatio;properties.focalDepth=camera.focalDepth}else if(cameraType==="OrthographicCamera"){properties.size=camera.size;properties.orthoZoom=camera.orthoZoom;properties.axisDirection=camera.axisDirection;properties.zoomAxis=camera.zoomAxis}output[node.id]={fbx_type:"eCamera",name:node.get("name"),properties:properties,transform:transformLocal}}else if(nodeType==="Bone"){transformLocal=this.saveTransformation(node,true);output[node.id]={fbx_type:"eSkeleton",name:node.get("name"),properties:properties,transform:transformLocal}}else if(nodeType==="Null"){transformLocal=this.saveTransformation(node);output[node.id]={fbx_type:"eNull",name:node.get("name"),properties:properties,transform:transformLocal}}if(output[node.id]){output[node.id].children={};if(this.recursiveSave&&node){node.nodes.each(function(nodeChild){this.saveObjectsChildren(nodeChild,output[node.id].children)},this)}}},saveBindPose:function(node,bindPoseOutput,optionalBindPoseMatrix){var transformGlobal;if(!bindPoseOutput||!node){return false}var nodeFound=_.find(bindPoseOutput,function(keyNodeID){return keyNodeID===node.id});if(nodeFound){return false}if(optionalBindPoseMatrix){transformGlobal=optionalBindPoseMatrix}else if(node.Transform){transformGlobal=node.transform.getWorldTransform()}else{return false}bindPoseOutput[node.id]={name:node.get("name"),transform:this.getTRS(transformGlobal)};return true},saveBindPoseParents:function(scene,bindPoseOutput){if(!bindPoseOutput){return false}_.each(bindPoseOutput,function(bindPoseID){var node=scene.find(function(n){return n.id===bindPoseID});if(node&&node.get("type")==="Bone"){var parentNode=node.parentNode();if(parentNode&&parentNode.Transform){var parentBindPose=node.transform.getWorldTransform();var result=this.saveBindPose(parentBindPose,bindPoseOutput,parentBindPose);if(result){this.saveBindPoseParents(scene,bindPoseOutput)}}}},this);return true},saveSkins:function(scene,node,output,bindPoseOutput){var skinsOutput={};if(!node||!node.PolyMesh||!node.PolyMesh.operators){return false}var skinCounter=0;var skinName="";node.PolyMesh.operators.each(function(operator){if(operator.get("name")!=="Skin"){return}skinName="skin"+skinCounter;skinsOutput[skinName]={};var boneDataList=operator.get("boneDataList");if(!boneDataList){return}for(var i=0;i<boneDataList.length;i++){var boneData=boneDataList[i];var boneNode=scene.find(function(m){return m.id===boneData.uuid});if(boneNode){skinsOutput[skinName][boneNode.id]={name:boneNode.get("name"),indices:boneData.vertexIndices,weights:boneData.vertexWeights,transformMatrix:this.getTRS(operator.get("poseSkinToWorldTransform")),transformLinkMatrix:this.getTRS(boneData.poseBoneToWorldTransform)};this.saveBindPose(boneNode,bindPoseOutput,operator.get("poseSkinToWorldTransform"))}}if(boneDataList.length){this.saveBindPose(node,bindPoseOutput,operator.get("poseSkinToWorldTransform"))}skinCounter++},this);if(!_.isEmpty(skinsOutput)){output[node.id]={name:node.get("name"),skins:skinsOutput}}},saveKeyFrames:function(node,output){var transformLocal={};var extraTransform={};if(!node.Transform||!node.Transform.isAnimated()){return}var transformOperator=node.Transform.operators.last();if(!transformOperator){console.log("No transform operator is found!");return}var transformKeys=transformOperator.toJSON();var TRS=["translation","rotation","scale"];for(var i=0;i<TRS.length;i++){var channel=TRS[i];var keyFramed=transformOperator.isKeyFramed(channel);if(keyFramed.x||keyFramed.y||keyFramed.z){transformLocal[channel]={}}if(keyFramed.x){transformLocal[channel].x=transformKeys[channel].x.keys}if(keyFramed.y){transformLocal[channel].y=transformKeys[channel].y.keys}if(keyFramed.z){transformLocal[channel].z=transformKeys[channel].z.keys}}output[node.id]={name:node.get("name"),transform:transformLocal}},saveMaterial:function(materialNode,output){var material,properties;var materialOperator=materialNode.Material.operators.last();var materialPrimitive=materialNode.material;if(!materialOperator){return}var material=materialPrimitive.getMaterialProperties();var numMaterials=10;var materialType=materialPrimitive.getMaterialType();if(materialType==="MultiID"&&materialOperator.get("name")==="MultiID"){var materialList=[];var numMaxIDs=0;var subMaterialNode;for(var i=0;i<numMaterials;i++){subMaterialNode=materialOperator.get("material"+i);if(subMaterialNode&&subMaterialNode.id){numMaxIDs=numMaxIDs+1}}for(var i=0;i<numMaxIDs;i++){subMaterialNode=materialOperator.get("material"+i);if(subMaterialNode&&subMaterialNode.id){materialList.push(subMaterialNode.id)}else{materialList.push("default")}}properties={materials:materialList}}else if(materialType==="Standard"&&materialOperator.get("name")==="Standard"){properties={type:material.materialType,diffuseColor:material.diffuseColor,diffuseMap:material.diffuseMap?material.diffuseMap.id:"",diffuseFactor:material.diffuseFactor,specularColor:material.specularColor,specularMap:material.specularMap?material.specularMap.id:"",specularFactor:material.specularFactor,opacityColor:material.opacityColor,opacityMap:material.opacityMap?material.opacityMap.id:"",opacityFactor:material.opacityFactor,bumpMap:material.bumpMap?material.bumpMap.id:"",bumpFactor:material.bumpFactor,ambientColor:material.ambientColor,ambientMap:material.ambientMap?material.ambientMap.id:"",emissiveColor:material.emissiveColor,emissiveMap:material.emissiveMap?material.emissiveMap.id:"",emissiveFactor:material.emissiveFactor,normalMap:material.normalMap?material.normalMap.id:"",reflection:material.reflection,refraction:material.refraction,glossiness:material.glossiness}}else{return}output[materialNode.id]={name:materialNode.get("name"),type:materialType,properties:properties}},saveTexture:function(scene,output){_.each(scene.files.assets(),function(textureFile){if(textureFile.isImage()){output[textureFile.id]={name:textureFile.getName(),path:textureFile.get("hash")+"/"+textureFile.get("name"),url:textureFile.assetURL(),hash:textureFile.get("hash")}}})},saveTransformation:function(node,ignorePivots){var transformLocal={};var rotateOrder=0;var transformOperator=node.Transform.operators.last();if(!transformOperator){console.log("No transform operator is found!");return transformLocal}transformLocal.rotateOrder=transformOperator.get("rotateOrder");transformLocal.translation=transformOperator.get("translation");transformLocal.rotation=transformOperator.get("rotation");transformLocal.scale=transformOperator.get("scale");transformLocal.preRotation=transformOperator.get("preRotation")?transformOperator.get("preRotation").clone():null;transformLocal.postRotation=transformOperator.get("rotateAxis")?transformOperator.get("rotateAxis").clone():null;if(transformLocal.postRotation){if(node.get("type")==="Camera"){transformLocal.postRotation.add(new THREE.Vector3(0,-90,0))}else if(node.get("type")==="Light"){transformLocal.postRotation.add(new THREE.Vector3(-90,0,0))}}if(!ignorePivots){transformLocal.rotatePivotOffset=transformOperator.get("rotatePivotOffset");transformLocal.scalePivotOffset=transformOperator.get("scalePivotOffset");transformLocal.localRotatePivot=transformOperator.get("localRotatePivot");transformLocal.localScalePivot=transformOperator.get("localScalePivot")}return transformLocal},getTRS:function(matrix){var translation=(new THREE.Vector3).getPositionFromMatrix(matrix);var rotation=exo.math.radianToDegree((new THREE.Vector3).setEulerFromRotationMatrix(matrix,"ZYX"));var scale=(new THREE.Vector3).getScaleFromMatrix(matrix);return{translation:translation,rotation:rotation,scale:scale}}}}();!function(){exo.resources.exporters.stl=exo.resources.exporters.STLExporter={exportFile:function(root,options,context){var exporterInstance=new exo.resources.exporters.STLSaver(root,options,context);return exporterInstance.fileString}};exo.resources.exporters.STLSaver=function(root,options,context){this.fileString="";this.saveBinary=false;this.dv=undefined;this.buf=undefined;this.binHeader=undefined;this.binFaceData=undefined;if(this.saveBinary){this.writeNode=this.writeBinaryNode.bind(this);this.binFaceData=[]}else{this.writeNode=this.writeAsciiNode.bind(this)}this.writeHeader(root.get("name"));this.exportNode(root,false);this.writeFooter(root.get("name"));return};exo.resources.exporters.STLSaver.prototype={exportNode:function(node,ignoreChildren,noTransform){var type=node.get("type");if(type==="PolyMesh"){var polyMesh=node.polyMesh.clone().triangulate();this.writeNode(polyMesh,noTransform?new THREE.Matrix4:node.transform.getWorldTransform())}if(!ignoreChildren){node.nodes.each(function(childNode,key){this.exportNode(childNode,ignoreChildren,noTransform)},this)}},writeBinaryNode:function(mesh,transform){for(var index=0;index<mesh.faces.length;index++){var faceBuffer=new ArrayBuffer(50);var faceView=new DataView(faceBuffer);var normal=new THREE.Vector3;var face=mesh.faces[index];faceView.setUint32(0,normal.x);faceView.setUint32(4,normal.y);faceView.setUint32(8,normal.z);var offset=12;for(var vertIndex=0;vertIndex<3;vertIndex++){var position=mesh.positions[face[vertIndex]].clone().applyMatrix4(transform);faceView.setUint32(offset,position.x);offset+=4;faceView.setUint32(offset,position.y);offset+=4;faceView.setUint32(offset,position.z);offset+=4}faceView.setUint16(offset,0);this.binFaceData.push(faceBuffer)}},writeBinaryHeader:function(name){var header="Exported by "+exo.conf.applicationName+": "+name;this.binHeader=new ArrayBuffer(80);var bufView=new Uint8Array(this.binHeader);for(var i=0;i<80;i++){bufView[i]=header.charCodeAt(i)||"-"}},writeBinaryFooter:function(name){var bufLength=84+50*this.binFaceData.length;var bufView=new DataView(this.binHeader);for(var charIndex=0;charIndex<80;charIndex++){this.fileString+=String.fromCharCode(bufView.getUint8(charIndex))}var triBuf=new ArrayBuffer(4);var triDV=new DataView(triBuf);triDV.setUint32(0,bufLength);for(charIndex=0;charIndex<4;charIndex++){this.fileString+=String.fromCharCode(triDV.getUint8(charIndex))}var faceView;for(var faceIndex=0;faceIndex<this.binFaceData.length;faceIndex++){faceView=new DataView(this.binFaceData[faceIndex]);for(var byteIndex=0;byteIndex<50;byteIndex+=4){this.fileString+=String.fromCharCode(faceView.getUint8(byteIndex))}}},writeAsciiHeader:function(name){this.fileString="solid "+name+"\n"},writeAsciiFooter:function(name){this.fileString+="endsolid "+name+"\n"},writeAsciiNode:function(mesh,transform){var normals=mesh.normalMap.values;var faceString="";for(var index=0;index<mesh.faces.length;index++){var normal=new THREE.Vector3;var face=mesh.faces[index];faceString="  facet normal "+normal.x+" "+normal.y+" "+normal.z+"\n";faceString+="    outer loop\n";for(var vertIndex=0;vertIndex<3;vertIndex++){var position=mesh.positions[face[vertIndex]].clone().applyMatrix4(transform);this.positionString="      vertex "+position.x+" "+position.y+" "+position.z+"\n";faceString+=this.positionString}faceString+="    end loop\n  endfacet\n";this.fileString+=faceString}},writeHeader:function(name){if(this.saveBinary){return this.writeBinaryHeader(name)}else{return this.writeAsciiHeader(name)}},writeFooter:function(name){if(this.saveBinary){return this.writeBinaryFooter(name)}else{return this.writeAsciiFooter(name)}}}}();!function(){exo.resources.renderer={RES_LIST:{0:"[ Custom ]",1:"HD 720",2:"HD 1080",3:"640x480",4:"Full 1024",5:"1k Square",6:"2k Square",7:"Retina"},RES_VALS:{1:{w:1280,h:720},2:{w:1920,h:1080},3:{w:640,h:480},4:{w:1024,h:768},5:{w:1024,h:1024},6:{w:2048,h:2048},7:{w:2048,h:1536}},extractGeneralSettings:function(app){var scene=app.scene;if(scene.getNode("Renderers").nodes.length===0){throw new Error("No renderer defined. Need at least one.")}var passes=scene.getNode("Passes");if(passes.nodes.length===0){throw new Error("No pass defined. Need at least one.")}return passes.GeneralRenderer.result},validatePass:function(pass){var pass_res=pass.result;if(pass_res.render_cam===undefined){throw new Error("No camera assigned to pass "+pass.attributes.name+", pass ignored!")}if(pass_res.render_red===undefined){throw new Error("No renderer assigned to pass "+pass.attributes.name+", pass ignored!")}if(pass_res.render_red.Renderer.result===undefined){throw new Error("Renderer "+pass.attributes.name+" has no creator operator assigned to it!")}if(pass_res.render_red.Renderer.result.exportScene===undefined){throw new Error("Renderer "+pass.attributes.name+" has no exportScene function!")}return true},renderSinglePass:function(app,pass,pass_name,generalSettings,ignoreActivatedFlag){var deferred=Q.defer();var promises=[];var pass_res=pass.result;var RES_VALS=null;if(ignoreActivatedFlag===undefined&&!pass_res.activated)return true;this.validatePass(pass);var this_scene_prop=_.clone(generalSettings);if(pass_res.over_res){this_scene_prop.res_w=pass_res.over_res_x;this_scene_prop.res_h=pass_res.over_res_y}else{var res=RES_VALS[this_scene_prop.res];this_scene_prop.res_w=res.w;this_scene_prop.res_h=res.h}this_scene_prop.res=undefined;return pass_res.render_red.Renderer.result.exportScene(app,this_scene_prop,pass,pass_name)},currentPass:function(app,options){app.scene.setTime(options.get("currentTime"));var general=this.extractGeneralSettings(app);if(!general)return false;if(!general.curPass){throw new Error("No current pass selected!")}return this.renderSinglePass(app,general.curPass.Pass,general.curPass.attributes.name,general,true)},allPasses:function(app,options){app.scene.setTime(options.get("currentTime"));var general=this.extractGeneralSettings(app);var passes=app.scene.getNode("Passes");var deferred=Q.defer();Q.all(passes.nodes.map(function(model){return this.renderSinglePass(app,model.Pass,model.attributes.name,general)},this)).then(function(files){deferred.resolve(_.flatten(files))});return deferred.promise}}}();exo.resources.importers.Image={importFile:function(file,ctx,options,callback){ctx.addFile(file).then(function(f){callback()})}};_.extend(exo.resources,{organizeResources:function(files){var resources=[[],[],[],[]];var resourceMap={FBX:3,Image:0,Material:1,other:2,Geometry:2};_.each(files,function(file){if(file.get("name")==="Thumbs.db")return;var index=resourceMap[file.getFileType()];resources[index===undefined?2:index].push(file)});return resources},importFile:function(file,scene,onLoad,notification){var extension=file.extname().replace(/\./,"");var fileType=file.getFileType();var importer=exo.resources.importers[extension]||exo.resources.importers[fileType];if(importer){importer.importFile(file,scene,onLoad,".","",notification)}else{console.log("importer not found for ",file.get("name"));onLoad()}},exportFile:function(resource,extension,options,context){var exporter=exo.resources.exporters[extension];var fileString="";if(exporter){context=context||{};fileString=exporter.exportFile(resource,options,context)}return fileString},supportedImporterExtensions:function(){var extensions=["jpg","jpeg","png","gif","fbx"];_.each(exo.resources.importers,function(importer){if(importer.extensions){extensions=extensions.concat(importer.extensions)}});return _.unique(extensions)}});!function(){var convertAttribute=function(attr){var attrs=[];for(var key in attr)attrs=attrs.concat([" ",key,'="',attr[key],'"']);return attrs.join("")};var convertObject=function(obj,parent,depth){depth=depth||"";if(obj instanceof Array){var tags=[];for(var i=0;i<obj.length;++i)tags.push(convertObject(obj[i],parent,depth));return tags.join("")}else{var tag=[depth,"<",parent];var subs=[];if(obj["@"]!==undefined)tag.push(convertAttribute(obj["@"]));var newDepth=depth+"	";for(var key in obj){if(key==="@")continue;var value=obj[key];if(typeof value==="object"){subs.push(convertObject(value,key,newDepth))}else{subs=subs.concat([depth,"	<",key,">",value,"</",key,">\n"])}}if(subs.length===0){tag.push("/>\n")}else{tag.push(">\n");tag=tag.concat(subs,[depth,"</",parent,">\n"])}return tag.join("")}};exo.resources.json2xml=function(json){var xml=['<?xml version="1.0" ?>\n'];for(var key in json){var value=json[key];if(typeof value==="object"){xml.push(convertObject(json[key],key))}else{xml=xml.concat(["<",key,">",value,"</",key,">\n"])}}return xml.join("")}}();exo.shapes.Rectangle=function(x,y,width,height){this.x=x!==undefined?x:0;this.y=y!==undefined?y:0;this.width=width!==undefined?width:1;this.height=height!==undefined?height:1;return this};exo.shapes.Rectangle.prototype={constructor:exo.shapes.Rectangle,copy:function(rect){this.x=rect.x;this.y=rect.y;this.width=rect.width;this.height=rect.height},clone:function(){return(new exo.shapes.Rectangle).copy(this)}};exo.translators.Registry=function(typeMap){this.translatorTypeMap=typeMap||{}};exo.translators.Registry.prototype={create:function(model,sceneTranslator){var TranslatorType=this.get(model.get("type"));var proto=model.__proto__;while(!TranslatorType&&proto){TranslatorType=this.get(proto.type);proto=proto.__proto__}return TranslatorType?new TranslatorType(model,sceneTranslator):null},get:function(type){return this.translatorTypeMap[type]},register:function(typeName,classType){this.translatorTypeMap[typeName]=classType}};exo.translators.Plug=function(plug,nodeTranslator){this.plug=plug;this.node=nodeTranslator;this.version=-1;this.bindTo(this.plug,"dirty",this.triggerDirty,this);this.initialize.apply(this,arguments)};exo.translators.Plug.extend=Backbone.Model.extend;_.extend(exo.translators.Plug.prototype,highbrow.Backbone.Events,highbrow.BindTo,{initialize:function(){},setDirty:function(){this.plug.version++},triggerDirty:function(){if(this.version===this.plug.version)return;this.doUpdate();if(!this.node.parent&&this.node.scene){this.node.scene.version++;this.node.scene.update()}},doUpdate:function(){if(this.version===this.plug.version)return;this.version=this.plug.version;this.update(this.plug,this.plug.primitive)},update:function(plug,result){},destroy:function(){this.unbindAll()}});exo.translators.Node=function(model,sceneTranslator,options){if(!model){throw new Error("Translator model must exist for a translator to work")}sceneTranslator=sceneTranslator||this;if(!(sceneTranslator instanceof exo.translators.Scene)){throw new Error("Translator scene root must be an instance of exo.translators.Scene.")}this.options=options||{};this.scene=sceneTranslator;this.model=this.node=model;this.parent=null;this.version=-1;this.children={};this.plugs={};if(sceneTranslator===this){this.initializeScene()}this.scene.translatorMap[model.id]=this;this.initialize(this.options);this.bindTo(this.model.nodes,"add",defer(1,this.updateParent,this));this.bindTo(this.model.nodes,"remove",defer(1,this.updateParent,this));this.bindTo(this.model,"dirty",this.update,this)};exo.translators.Node.extend=Backbone.Model.extend;_.extend(exo.translators.Node.prototype,highbrow.Backbone.Events,highbrow.BindTo,{type:"Node",initialize:function(options){this.plugs={}},updateChildren:function(addedChildren,removedChildren){},updateProperties:function(){_.each(this.plugs,function(plug){plug.doUpdate()},this)},updateParent:function(){if(this.parent){this.parent.update()}else if(this.model&&this.model.parentNode()){this.scene.get(this.model.parentNode().id).update()}else{this.update()}},update:function(){var updateCount=0;if(this.version===this.model.version){return updateCount}var nodeChildren=this.model.nodes;var oldChildren=this.children;var removedChildren=[];var addedChildren=[];this.children={};for(var i=0,il=nodeChildren.length;i<il;i++){var nodeChild=nodeChildren.at(i);var nodeTranslatorChild=this.scene.get(nodeChild.id);if(!nodeTranslatorChild||nodeTranslatorChild.hasTypeChanged()){if(nodeTranslatorChild){removedChildren.push(nodeTranslatorChild)}nodeTranslatorChild=this.scene.registry.create(nodeChild,this.scene);this.scene.translatorMap[nodeChild.id]=nodeTranslatorChild;if(nodeTranslatorChild){addedChildren.push(nodeTranslatorChild)}}if(nodeTranslatorChild){if(!oldChildren[nodeChild.id]){addedChildren.push(nodeTranslatorChild)}this.children[nodeChild.id]=nodeTranslatorChild;updateCount+=nodeTranslatorChild.update()}}for(var id in oldChildren){if(!this.children[id]){removedChildren.push(oldChildren[id]);this.scene.translatorMap[id]=undefined}}this.updateProperties();if(addedChildren.length||removedChildren.length){_.each(removedChildren,function(child){child.parent=null},this);_.each(addedChildren,function(child){child.parent=this},this);this.updateChildren(addedChildren,removedChildren)}updateCount++;this.version=this.model.version;return updateCount},destroy:function(){this.unbindAll();_.each(this.plugs,function(plug){plug.destroy()})},each:function(iterator,context){_.each(this.children,function(displayNode){iterator.call(context||displayNode,displayNode);displayNode.each(iterator,context)})},map:function(iterator,context){var result=[iterator.call(context,this)];
return result.concat(_.map(this.children,function(dn){return dn.map(iterator,context)},context))},filter:function(iterator,context){var result=iterator.call(context,this)?[this]:[];_.each(this.children,function(n){result=result.concat(n.filter(iterator,context))},context);return result},hasTypeChanged:function(){var TranslatorType=this.scene.registry.get(this.model.get("type"));return TranslatorType&&!(this instanceof TranslatorType)},adjustForDisplay:function(viewport,camera){_.each(this.plugs,function(plug){if(plug.adjustForDisplay){plug.adjustForDisplay(viewport,camera)}})}});exo.translators.Scene=exo.translators.Node.extend({type:"Scene",initializeScene:function(options){this.translatorMap={}},registry:new exo.translators.Registry,get:function(id){return this.translatorMap[id]},update:function(){this.startUpdateTime=new Date;var count=exo.translators.Node.prototype.update.call(this);if(count){this.render()}return count},render:function(){}});exo.translators.three.generators={initDisplay:function(){exo.translators.three.generators.wireMaterial=new THREE.MeshBasicMaterial({color:16777215,wireframe:true});exo.translators.three.generators.lineMaterial=new THREE.LineBasicMaterial({color:16777215})},hasNormals:function(scope){return scope.normals.length},buildMesh:function(polyMesh){var meshMaterial=new THREE.MeshPhongMaterial({ambient:8355711,dynamic:true});var wireMaterials=new THREE.LineBasicMaterial({color:16777215,dynamic:true});var geometry=new exo.geometry.PolyMeshToGeometry(polyMesh);geometry.computeCentroids();var wireframe=exo.translators.three.generators.convertPolyMeshToLines(polyMesh);var object3D=new THREE.Object3D;object3D.add(new THREE.Mesh(geometry,meshMaterial));object3D.add(wireframe);return object3D},buildWireframe:function(polyMesh,optionalMaterial){return exo.translators.three.generators.convertPolyMeshToLines(polyMesh,optionalMaterial)},buildGeometry:function(vertices,faces,normals,uvs){var geometry=new THREE.Geometry;_.each(vertices,function(vertex){geometry.vertices.push(new THREE.Vector3(vertex.x,vertex.y,vertex.z))});_.each(faces,function(face){geometry.faces.push(face.length===4?new THREE.Face4(face[0],face[1],face[2],face[3]):new THREE.Face3(face[0],face[1],face[2]))});geometry.dynamic=true;geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();if(this.hasNormals(geometry))geometry.computeTangents();return geometry},generators:{circle:function(options){options.points=[];options.faces=[];options.endDivision=options.endDivision||1;options.divisions=options.divisions||24;var TWO_PI=Math.PI*2;var backwards=false;var angle=TWO_PI/options.endDivision/options.divisions;for(var i=0;!(i===0&&backwards);backwards?--i:++i){if(i>=options.divisions){backwards=true}options.points.push([-(angle/2)+Math.cos(angle*i),-(angle/2)+Math.sin(angle*i),.5]);options.faces.push([i,i+1,i+1])}return exo.translators.three.generators.buildGeometry(options.points,options.faces)},line:function(options){var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(0,-.5,0));geometry.vertices.push(new THREE.Vector3(0,.5,0));return geometry},box:function(options){options.size=options.size||1;return new THREE.CubeGeometry(options.size,options.size,options.size,1,1,1)},cylinder:function(options){return new THREE.CylinderGeometry(1,1,.5,16)},cone:function(options){options.radius=options.radius||.5;options.height=options.height||1;return new THREE.CylinderGeometry(0,options.radius,options.height,16,1)},sphere:function(options){return new THREE.SphereGeometry(1,24,24)},plane:function(options){return new THREE.PlaneGeometry(1,1,1,1)},torus:function(options){var phiLength=360;options.tubularSegments=options.tubeSegs||24;options.radialSegments=options.radialSegs||24;options.innerRadius=options.innerRadius||.75;options.outerRadius=options.outerRadius||1;return new THREE.TorusGeometry(options.innerRadius,options.outerRadius,options.radialSegments,options.tubularSegments,THREE.Math.degToRad(phiLength))},text:function(options){return new THREE.TextGeometry(options.label,{size:.2,height:.02,curveSegments:1})}},generatePrimitive:function(options){options=options||{};var originalOptions=_.clone(options);options.wireMaterial=options.wireMaterial||exo.translators.three.generators.wireMaterial;options.name=options.name||options.type;var sceneObject;if(options.material){options.material.color=this.toColor(options.material.color);options.material=new THREE.MeshBasicMaterial(options.material)}else{options.material=new THREE.MeshBasicMaterial({color:16777215})}options.material.transparent=true;options.material.side=THREE.DoubleSide;if(options.wireMaterial){options.wireMaterial.color=this.toColor(options.wireMaterial.color);if(options.type==="line"){options.wireMaterial=new THREE.LineBasicMaterial(options.wireMaterial)}else{options.wireMaterial.wireframe=true;options.wireMaterial=new THREE.MeshBasicMaterial(options.wireMaterial)}}if(!this.generators[options.type]){throw new Error("Unknown primitive: "+options.type)}var geometry=this.generators[options.type](options);if(options.type==="line"){sceneObject=new THREE.Line(geometry,options.wireMaterial||this.lineMaterial)}else{sceneObject=new THREE.Mesh(geometry,options.wireframe?options.wireMaterial:options.material)}sceneObject.position=options.position?this.toVector(options.position):new THREE.Vector3;sceneObject.rotation=options.rotation?this.toRotation(options.rotation):new THREE.Vector3;sceneObject.scale=options.scale?this.toVector(options.scale):new THREE.Vector3(1,1,1);sceneObject.bordered=options.bordered;sceneObject.wireMaterial=options.wireMaterial;sceneObject.forceWireframe=options.wireframe;if(options.bordered){sceneObject.add(this.createBorder(originalOptions))}return sceneObject},createBorder:function(options){var wireframeChild=_.clone(options);wireframeChild.wireframe=true;wireframeChild.wireMaterial={color:options.borderColor?options.borderColor:[1,1,1]};wireframeChild.bordered=false;delete wireframeChild.position;delete wireframeChild.scale;delete wireframeChild.rotation;return this.generatePrimitive(wireframeChild)},toColor:function(arr){if(arr instanceof Array){var color=new THREE.Color;color.setRGB(arr[0],arr[1],arr[2]);return color}else if(arr){return arr}else{return new THREE.Color}},toVector:function(arr){if(arr instanceof Array){return new THREE.Vector3(arr[0],arr[1],arr[2])}else{return arr}},toRad:function(deg){return deg*Math.PI/180},toRotation:function(arr){if(arr instanceof Array){return new THREE.Vector3(this.toRad(arr[0]),this.toRad(arr[1]),this.toRad(arr[2]))}else{return arr}},chooseUVProjectionMode:function(type){type=type.toLowerCase();var projectionMode="cubic";if(type==="sphere"){projectionMode="spherical"}else if(type==="plane"){projectionMode="planar"}else if(type==="cylinder"||type==="cone"||type==="torus"){projectionMode="spherical"}return projectionMode},boundingBoxDisplay:function(lineMaterial){var geometry=new THREE.Geometry;var gap=.514;var lineGap=.25;var createLines=function(x,y,z){geometry.vertices.push(new THREE.Vector3(gap*x,gap*y,gap*z),new THREE.Vector3(gap*x,lineGap*y,gap*z),new THREE.Vector3(gap*x,gap*y,gap*z),new THREE.Vector3(lineGap*x,gap*y,gap*z),new THREE.Vector3(gap*x,gap*y,gap*z),new THREE.Vector3(gap*x,gap*y,lineGap*z))};createLines(1,1,1);createLines(-1,1,1);createLines(-1,-1,1);createLines(-1,-1,-1);createLines(1,-1,1);createLines(1,1,-1);createLines(1,-1,-1);createLines(-1,1,-1);return new THREE.Line(geometry,lineMaterial,THREE.LinePieces)},convertPolyMeshToLines:function(polyMesh,optionalMaterial,storeEdgeKeys){var geometry=new THREE.Geometry;var edges=exo.geometry.ComponentUtilities.getEdges(polyMesh);var positions=polyMesh.positions;var edge;if(storeEdgeKeys){if(!geometry.clara_io){geometry.clara_io={}}geometry.clara_io.polyMeshEdges={}}var vLength;var edgeKey;for(var i=0,il=edges.length;i<il;i++){edge=edges[i];if(storeEdgeKeys){vLength=geometry.vertices.length;edgeKey=edge.createHashKey();geometry.clara_io.polyMeshEdges[vLength]=edgeKey;geometry.clara_io.polyMeshEdges[vLength+1]=edgeKey}geometry.vertices.push(positions[edge.start]);geometry.vertices.push(positions[edge.end])}var lines=new THREE.Line(geometry,optionalMaterial,THREE.LinePieces);return lines}};!function(){var AreaPick=.03;var AreaPickVertex=.04;var createRayCaster=function(vector,threeCamera,useSubSelection){var projector=new THREE.Projector;vector.z=-1;var end=new THREE.Vector3(vector.x,vector.y,1);projector.unprojectVector(vector,threeCamera);projector.unprojectVector(end,threeCamera);end.sub(vector).normalize();return useSubSelection?new exo.geometry.Raycaster(vector,end):new THREE.Raycaster(vector,end)};var createAreaPicker=function(screenRect,threeCamera){var left=screenRect.x,right=left+screenRect.width,bottom=screenRect.y,top=bottom+screenRect.height;var proj=new THREE.Projector;var unproject=proj.unprojectVector.bind(proj);var V3=THREE.Vector3;var P=THREE.Plane;var ntl=unproject(new V3(left,top,-1),threeCamera);var ntr=unproject(new V3(right,top,-1),threeCamera);var nbl=unproject(new V3(left,bottom,-1),threeCamera);var nbr=unproject(new V3(right,bottom,-1),threeCamera);var ftl=unproject(new V3(left,top,1),threeCamera);var ftr=unproject(new V3(right,top,1),threeCamera);var fbl=unproject(new V3(left,bottom,1),threeCamera);var fbr=unproject(new V3(right,bottom,1),threeCamera);var tp=(new P).setFromCoplanarPoints(ftr,ntr,ftl);var bp=(new P).setFromCoplanarPoints(fbl,nbr,fbr);var lp=(new P).setFromCoplanarPoints(ftl,nbl,fbl);var rp=(new P).setFromCoplanarPoints(fbr,ntr,ftr);var np=(new P).setFromCoplanarPoints(nbr,ntl,ntr);var fp=(new P).setFromCoplanarPoints(fbl,ftr,ftl);var frustum=new THREE.Frustum;frustum.set(tp,bp,lp,rp,np,fp);var caster=new exo.geometry.Frustumcaster;caster.set(frustum);return caster};var selectablesToObjects=function(selectables){var meshes=_.map(selectables,function(selectable){return selectable.meshes});var objects=[];_.each(meshes,function(mesh){objects=objects.concat(mesh)});return objects};var picked=function(results,selectables){return _.reduce(results,function(memo,intersection){_.each(selectables,function(selectable){if(intersection.object!==undefined){if(selectable.meshes.indexOf(intersection.object)!==-1){memo.push(selectable)}}else{if(selectable.meshes.indexOf(intersection)!==-1){memo.push(selectable)}}});return memo},[])};var ignoreBackfacingFaces=function(resultPick,cameraPosition){var faces=resultPick.faces;var polyMesh=resultPick.polyMesh;var newFaces=[];if(!faces||faces.length<1){return}_.each(faces,function(face){if(!ignoreBackfacingFace(polyMesh,polyMesh.faces[face],cameraPosition)){newFaces.push(face)}});resultPick.faces=newFaces};var ignoreBackfacingFace=function(polyMesh,face,cameraPosition){_ignoreFace=function(triangleFace){var vertices=polyMesh.positions;var posA=vertices[triangleFace[0]],posB=vertices[triangleFace[1]],posC=vertices[triangleFace[2]];var cameraToFace=cameraPosition.clone().sub(posA).normalize();var faceNormal=THREE.Triangle.normal(posA,posB,posC);return cameraToFace.dot(faceNormal)<=0};if(face.length>3){var triangles=exo.geometry.PolyMeshUtilities.triangulateFace(face);var triangle;for(var i=0,il=triangles.length;i<il;++i){if(!_ignoreFace(triangles[i])){return false}}return true}else if(face.length===3){return _ignoreFace(face)}return false};var ignoreBackfacingEdges=function(resultPick,cameraPostition){var edges=resultPick.edges;var polyMesh=resultPick.polyMesh;var ComponentUtils=exo.geometry.ComponentUtilities;var faceIndex,edgeKey;var newEdges=[];if(!edges||edges.length<1){return}var faceIndices=ComponentUtils.getFacesByEdges(polyMesh,edges);var fIndices=getBackfacingResult(polyMesh,faceIndices,cameraPostition);var validEdges=ComponentUtils.getEdgesByFaces(polyMesh,fIndices);var validEdgesKeys=ComponentUtils.createSelectedEdgesHashKeys(validEdges);for(var i=0,il=edges.length;i<il;i++){edgeKey=edges[i].createHashKey();if(validEdgesKeys[edgeKey]!==undefined){newEdges.push(edges[i])}}resultPick.edges=newEdges};var ignoreBackfacingVertices=function(resultPick,cameraPostition){var newVertices=[];var polyMesh=resultPick.polyMesh;var vertices=resultPick.vertices;var faceIndex;var validFaceIndices=[];if(!vertices||vertices.length<1){return}var faceIndices=exo.geometry.ComponentUtilities.getFacesByVertices(polyMesh,vertices);var fIndices=getBackfacingResult(polyMesh,faceIndices,cameraPostition);var vIndicesKeys=exo.geometry.ComponentUtilities.createUsedIndicesHashKeys(polyMesh,fIndices);for(var i=0,il=vertices.length;i<il;i++){if(vIndicesKeys[vertices[i]]!==undefined){newVertices.push(vertices[i])}}resultPick.vertices=newVertices};var getBackfacingResult=function(polyMesh,faceIndices,cameraPostition){var validFaceIndices=[];for(var i=0,il=faceIndices.length;i<il;i++){faceIndex=faceIndices[i];if(!ignoreBackfacingFace(polyMesh,polyMesh.faces[faceIndex],cameraPostition)){validFaceIndices.push(faceIndex)}}return validFaceIndices};var getNodeFromSelectable=function(selectable){if(selectable){var node=null;_.each(selectable.meshes,function(mesh){if(!node){node=mesh.owner&&mesh.owner.node?mesh.owner.node:null}});return node}return null};var subObjectList={Vertex:"vertices",Edge:"edges",Face:"faces"};exo.translators.three.pickers={point:function(area,selectables,threeCamera,firstOnly){var caster=createRayCaster(new THREE.Vector3(area.x,area.y,-1),threeCamera);var objects=selectablesToObjects(selectables);var results=caster.intersectObjects(objects,true);var _firstOnly=firstOnly!==undefined?firstOnly:true;if(_firstOnly){if(results&&results.length>1){results=[results[0]]}}return picked(results,selectables)},area:function(area,selectables,threeCamera){if(!exo.translators.three.pickers.validatAreaRect(area,false)){return[]}var caster=createAreaPicker(area,threeCamera);var objects=selectablesToObjects(selectables);var results=caster.intersectObjects(objects);return picked(results,selectables)},sub:{point:function(area,selectables,threeCamera,method,ignoreBackfacing){var ignoreBackface=ignoreBackfacing===undefined?true:ignoreBackfacing;var results=this.fallbackToArea(area,selectables,threeCamera,method,method==="Vertex"?AreaPickVertex:AreaPick,ignoreBackface);return results},area:function(area,selectables,threeCamera,method,ignoreBackfacing){if(!exo.translators.three.pickers.validatAreaRect(area,false)){return[]}var caster=createAreaPicker(area,threeCamera);var selectable=selectables[0];var node=getNodeFromSelectable(selectable);var matrixWorld=node.transform.getWorldTransform();var inverseMatrix=(new THREE.Matrix4).getInverse(matrixWorld);var cameraPosition=threeCamera.position.clone().applyMatrix4(inverseMatrix);caster.frustum=exo.geometry.FrustumUtilities.applyMatrix4(caster.frustum,inverseMatrix);var result=node.polyMesh?caster.intersectsPolyMesh(node.polyMesh,method,true):null;if(result){result.cameraPosition=cameraPosition;result.inverseMatrix=inverseMatrix;if(ignoreBackfacing){if(method==="Face"){ignoreBackfacingFaces(result,cameraPosition);if(result.faces.length<1){result=null}}else if(method==="Edge"){ignoreBackfacingEdges(result,cameraPosition);if(result.edges.length<1){result=null}}else if(method==="Vertex"){ignoreBackfacingVertices(result,cameraPosition);if(result.vertices.length<1){result=null}}}}return result?[result]:[]},sortListByDistances:function(list,distances,ascending){var indices=[];var sortedList=[];for(var i=0,il=list.length;i<il;i++){indices.push(i)}var ascendingOrderFn;var _ascending=ascending!==undefined?ascending:true;if(_ascending){ascendingOrderFn=function(a,b){return distances[a]-distances[b]}}else{ascendingOrderFn=function(a,b){return distances[b]-distances[a]}}indices.sort(ascendingOrderFn);for(var i=0,il=list.length;i<il;i++){sortedList.push(list[indices[i]])}return sortedList},sortEdgesByRay:function(area,pickingResult,threeCamera){var sortedEdges=[];var edges=pickingResult.edges;var vertices=pickingResult.polyMesh.positions;var cameraPosition=pickingResult.cameraPosition;var intersection;if(!edges||edges.length<2||!vertices){return null}var rayCaster=createRayCaster(new THREE.Vector3(area.x,area.y,-1),threeCamera,true);var rayLine=new THREE.Line3(rayCaster.ray.origin.clone(),rayCaster.ray.at(1));var randomPoint=exo.math.perpendicularVectorToLine(rayLine);var plane=(new THREE.Plane).setFromCoplanarPoints(rayLine.start,rayLine.end,randomPoint);plane.applyMatrix4(pickingResult.inverseMatrix);var distances=[];for(var i=0,il=edges.length;i<il;i++){intersection=plane.intersectLine(edges[i].getLine3(vertices));if(intersection){distances.push(cameraPosition.distanceToSquared(intersection))}else{distances.push(Number.MAX_VALUE)}}return this.sortListByDistances(edges,distances,true)},sortVerticesByRay:function(pickingResult){var vertices=pickingResult.vertices;var positions=pickingResult.polyMesh.positions;var cameraPosition=pickingResult.cameraPosition;var distances=[];var indices=[];var sortedVerts=[];if(!vertices||vertices.length<2){return null}for(var i=0,il=vertices.length;i<il;i++){distances.push(cameraPosition.distanceToSquared(positions[vertices[i]]))}return this.sortListByDistances(vertices,distances,true)},sortFacesByRay:function(area,pickingResult,threeCamera){var sortedFaces=[];var polyMesh=pickingResult.polyMesh;var faceIndices=pickingResult.faces;var PolyUtils=exo.geometry.PolyMeshUtilities;var indices=[];var faceDistances=[];var rayIntersection;if(!faceIndices||faceIndices.length<2){return null}var rayCaster=createRayCaster(new THREE.Vector3(area.x,area.y,-1),threeCamera,true);for(var i=0,il=faceIndices.length;i<il;i++){rayIntersection=rayCaster.intersectPolyFace(polyMesh,pickingResult.inverseMatrix,faceIndices[i]);if(rayIntersection){faceDistances.push(rayIntersection.distance)}else{faceDistances.push(Number.MAX_VALUE)}}return this.sortListByDistances(faceIndices,faceDistances,true)},fallbackToArea:function(area,selectables,threeCamera,method,size,ignoreBackfacing,returnFirstOnly){var halfSize=size/2;var newArea={x:area.x-halfSize,y:area.y-halfSize,width:size,height:size};if(!exo.translators.three.pickers.validatAreaRect(newArea,false)){return[]}var _returnFirstOnly=returnFirstOnly!==undefined?returnFirstOnly:true;var resultsPicking=this.area(newArea,selectables,threeCamera,method,ignoreBackfacing);if(!_returnFirstOnly){return resultsPicking}_.each(resultsPicking,function(resultPick){var sorted;if(method==="Face"){sorted=this.sortFacesByRay(area,resultPick,threeCamera);if(sorted){resultPick.faces=[sorted[0]]}}else if(method==="Edge"){sorted=this.sortEdgesByRay(area,resultPick,threeCamera);if(sorted){resultPick.edges=[sorted[0]]}}else if(method==="Vertex"){sorted=this.sortVerticesByRay(resultPick);if(sorted){resultPick.vertices=[sorted[0]]}}},this);return resultsPicking}},validatAreaRect:function(rect,fixError){var validationStatus=true;if(rect.width===0){if(fixError){rect.width=exo.math.EPSILON}validationStatus=false}if(rect.height===0){if(fixError){rect.height=exo.math.EPSILON}validationStatus=false}return validationStatus}}}();exo.translators.three.objectUtils={setVisibility:function(sceneObject,visible){var owner=sceneObject.owner;sceneObject.each(function(obj){if(!owner||!obj.owner||obj.owner===owner){obj.visible=obj.forceVisible=visible}})},getBoundingSphere:function(object3D){if(!object3D.geometry)return new THREE.Sphere;return(new THREE.Sphere).setFromCenterAndPoints(new THREE.Vector3,object3D.geometry.vertices).applyMatrix4(object3D.matrixWorld)},getMeshes:function(sceneObject,checkVisibility,checkSelectable){checkVisibility=checkVisibility===undefined?true:checkVisibility;checkSelectable=checkSelectable===undefined?true:checkSelectable;var meshes=[];var owner=sceneObject.owner;var checkFn=function(object3D){if(object3D.owner===owner&&!(object3D.unselectable&&checkSelectable)){if(!checkVisibility||object3D.forceVisible!==false){if(object3D.geometry&&!(object3D.geometry instanceof THREE.Line)&&object3D.geometry.faces&&object3D.geometry.vertices){meshes.push(object3D)}if(object3D.helper){object3D.helper.each(checkFn)}}}};sceneObject.each(checkFn);return meshes},setMaterialsToWireframe:function(sceneObject,wireframe){sceneObject.each(function(node){if(!node.isHelper){if(node.material){var newWireframe=node.forceWireframe||wireframe;var isMultiMaterials=node.material&&node.material instanceof THREE.MeshFaceMaterial;if(isMultiMaterials&&newWireframe||node.material.wireframe!==undefined&&newWireframe!==node.material.wireframe){node.originalVisible=node.visible;node.visible=false}else{node.visible=node.forceVisible}}if(node.geometry&&node.geometry.materials){for(var j=0;j<node.geometry.materials.length;j++){node.geometry.materials[j].wireframe=wireframe}}}})},threeSceneString:function(sceneObject){var s="";var i;sceneObject.each(function(obj,level){for(i=0;i<level;i++){s+="  "}s+="- "+obj.name+"\n"});return s}};THREE.Scene.prototype.updateMaterials=function(){var iterate=function(nodes){for(var i=0;i<nodes.length;++i){var node=nodes[i];if(node.material){node.material.needsUpdate=true;var materials=node.material.materials;if(materials){for(var j=0;j<materials.length;j++){materials[j].needsUpdate=true}}}if(node.geometry&&node.geometry.materials){for(var j=0;j<node.geometry.materials.length;j++){node.geometry.materials[j].needsUpdate=true}}iterate(node.children)}};iterate(this.children)};if(THREE.Object3D.prototype.each===undefined){THREE.Object3D.prototype.each=function(iterator,context,level){level=level||0;iterator.call(context||this,this,level);level++;_.each(this.children,function(obj){obj.each(iterator,context,level)});level--}}exo.translators.three.Selection=function(editor,displayScene){this.editor=editor;this.displayScene=displayScene;this.selected=[];this.selectedById={};this.editor.on("change:activeManipulator",function(node,manipulator){this.setWidget(manipulator)},this)};exo.translators.three.Selection.prototype={selectNode:function(node){var displayNode=this.displayScene.get(node.id);if(!displayNode)return;displayNode.setSelected(true);this.selected.push(displayNode);this.displayScene.trigger("dirty",node);this.selectedById[node.id]=displayNode},deselectNode:function(node){var displayNode=this.displayScene.get(node.id);this.selected=_.reject(this.selected,function(selection){return selection.node.id===node.id});this.selectedById[node.id]=undefined;if(!displayNode)return;displayNode.setSelected(false);this.displayScene.trigger("dirty",node)},isSelected:function(node){return!!this.selectedById[node.id]},setWidget:function(widget){},get length(){return this.selected.length},getCentroid:function(manipulator,ignoreRotatePivots){var count=0,pos=new THREE.Vector3(0,0,0);_.each(this.selected,function(displayNode){var node=displayNode.node;if(node&&node.transform){if(ignoreRotatePivots||manipulator===undefined){pos.add(node.transform.getWorldTranslation())}else if(manipulator==="Move"||manipulator==="Rotate"){pos.add(node.transform.getWorldRotatePivot())}else if(manipulator==="Scale"){pos.add(node.transform.getWorldScalePivot())}++count}},this);return count?pos.multiplyScalar(1/count):pos}};exo.translators.three.Selectable=function(options){_.extend(this,options||{})};exo.translators.three.Selectable.prototype.toString=function(){return"[Selectable "+this.displayNode&&this.displayNode.model?this.displayNode.model.get("id")+" ":""+this.sphere.toString()+" "+this.mesh.toString()+"]"};exo.translators.three.Gizmo=function(options){options=options||{};this.visible=options.visible!==undefined?options.visible:true;this.parts=this.parts||options.parts||{};this.created={};this.initialize(options);this.scene=options.parent||new THREE.Scene;this.center=options.parent||new THREE.Object3D;this.defaultScale=options.defaultScale||this.defaultScale||1;this.adjustWithCamera=options.adjustWithCamera!==undefined?options.adjustWithCamera:true;if(options.update){this.update=options.update.bind(this)}if(!options.parent){this.scene.add(this.center)}if(options.create){options.create.call(this)}_.each(this.parts,function(part,name){part.name=name;this.addWidgetPart(part,this.center)},this)};exo.translators.three.Gizmo.extend=Backbone.Model.extend;_.extend(exo.translators.three.Gizmo.prototype,{initialize:function(){},render:function(renderer,camera,options){this.scene.camera=camera;this.adjustForDisplay(options);if(options.cameraNode.isOrthographic()){var hidden=this.hideOrthoAxis(options.cameraNode.camera.zoomAxis)}renderer.render(this.scene,camera);if(options.cameraNode.isOrthographic()){this.showOrthoAxis(hidden)}},hideOrthoAxis:function(cameraAxis){var hidden=[];this.center.each(function(sceneObject){if(this.isHiddenOnAxis(cameraAxis,sceneObject)&&sceneObject.visible){sceneObject.visible=false;hidden.push(sceneObject)}},this);return hidden},isHiddenOnAxis:function(cameraAxis,part){var axisToHide;switch(cameraAxis){case 0:axisToHide="x";break;case 1:axisToHide="y";break;case 2:axisToHide="z";break}return part.hideOnAxis&&part.hideOnAxis[axisToHide]?true:false},showOrthoAxis:function(toShow){_.each(toShow,function(hiddenObj){hiddenObj.visible=true})},setVisibility:function(visible){exo.translators.three.objectUtils.setVisibility(this.scene,visible);this.visible=visible},addWidgetPart:function(part,parent){part=_.clone(part);part.primitive=_.clone(part.primitive);var sceneObject=exo.translators.three.generators.generatePrimitive(part.primitive);sceneObject.name=name;if(part.axis){part.handle=part.axis}sceneObject.axis=sceneObject.handle=part.handle;if(part.hideOnAxis){sceneObject.hideOnAxis=part.hideOnAxis}sceneObject.part=part;sceneObject.deselectedMaterial=sceneObject.material.clone();if(sceneObject.bordered){_.each(sceneObject.children,function(child){if(child.wireMaterial){child.deselectedWireMaterial=child.wireMaterial.clone();child.hideOnAxis=sceneObject.hideOnAxis}})}if(!part.selectedMaterial){part.selectedMaterial={color:this.toColor([1,1,0])}}sceneObject.selectedMaterial=new THREE.MeshBasicMaterial(part.selectedMaterial);parent.add(sceneObject);if(part.primitive.type==="torus"&&part.primitive.wireframe){this.attachThickerTorus(part,sceneObject,parent)}if(part.attachLine){this.attachWidgetLine(part,sceneObject)}if(part.label){this.attachLabel(part,sceneObject)}this.created[part.name]=sceneObject;return sceneObject},attachThickerTorus:function(part,sceneObject,parent){part={primitive:{innerRadius:part.primitive.innerRadius,outerRadius:part.primitive.outerRadius*100,type:"torus",position:_.clone(part.primitive.position),rotation:_.clone(part.primitive.rotation),scale:_.clone(part.primitive.scale)},axis:_.clone(part.axis),hideOnAxis:_.clone(part.hideOnAxis)};var thickTorus=this.addWidgetPart(part,parent);thickTorus.visible=false},attachWidgetLine:function(part,sceneObject){var linePart=this.getWidgetLine(part);this.addWidgetPart(linePart,sceneObject);if(linePart.axis){linePart=this.getWidgetLine(part);linePart.primitive.type="cylinder";linePart.primitive.scale=[linePart.primitive.scale[0]*4,linePart.primitive.scale[1]*2,linePart.primitive.scale[2]*4];var thickLine=this.addWidgetPart(linePart,sceneObject);thickLine.visible=false}},getWidgetLine:function(part){var properties=part.attachLine;var name=part.name+"Line";var linePart={name:name,primitive:{type:"line",material:part.primitive.material,selectedMaterial:part.selectedMaterial,wireMaterial:{color:part.primitive.material?part.primitive.material.color:part.primitive.wireMaterial?part.primitive.material.color:null},position:properties.position||[0,0,0],scale:properties.scale||[1,1,1],rotation:properties.rotation||[0,0,0]},axis:part.axis,hideOnAxis:part.hideOnAxis};part.line=linePart;return linePart},attachLabel:function(part,sceneObject){var labelPart={name:part.name+"Label",primitive:{type:"text",label:part.label.text,material:part.primitive.material,selectedMaterial:part.selectedMaterial,wireMaterial:{color:part.primitive.material?part.primitive.material.color:part.primitive.wireMaterial?part.primitive.material.color:null},position:part.label.position||[0,0,0],scale:[1,1,1],rotation:part.label.rotation||[0,0,0]},axis:part.axis,hideOnAxis:{x:true,y:true,z:true},isLabel:true};part.label=labelPart;this.addWidgetPart(labelPart,sceneObject)},adjustForDisplay:function(options){var centroid=this.toVector(options.centroid);if(this.adjustWithCamera){var cameraNode=options.cameraNode;var camWidth=Math.max(cameraNode.camera.getWidth(),0);var viewportWidth=options.viewSize.width;var viewportScale=600/viewportWidth;if(viewportScale>1)viewportScale=1;var orthoZoomFactor=500;var cameraTranslation=cameraNode.transform.getTranslation();var amount=Math.max(1e-4,cameraNode.isOrthographic()?orthoZoomFactor*camWidth/viewportWidth:cameraTranslation.distanceTo(centroid)*viewportScale);var newScale=amount*this.defaultScale;this.center.scale.set(newScale,newScale,newScale)}this.center.visible=true;this.center.position=centroid;if(options.updateMatrix){this.scene.updateMatrixWorld()}},getSelectables:function(camera){var selectables=[];this.scene.each(function(sceneObject){if(sceneObject.handle){if(camera.isOrthographic()&&this.isHiddenOnAxis(camera.camera.zoomAxis,sceneObject)){return}selectables.push(new exo.translators.three.Selectable({sphere:exo.translators.three.objectUtils.getBoundingSphere(sceneObject),meshes:exo.translators.three.objectUtils.getMeshes(sceneObject,false),gizmo:this,handle:sceneObject.handle}))}},this);return selectables},highlight:function(handle){this.scene.each(function(sceneObject){if(!sceneObject.selectedMaterial)return;if(_.isEqual(sceneObject.handle,handle)){sceneObject.material.color=sceneObject.selectedMaterial.color;sceneObject.material.opacity=sceneObject.selectedMaterial.opacity;if(sceneObject.bordered){_.each(sceneObject.children,function(child){if(child.wireMaterial)child.wireMaterial.color=sceneObject.selectedMaterial.color})}}else{sceneObject.material.color=sceneObject.deselectedMaterial.color;sceneObject.material.opacity=sceneObject.deselectedMaterial.opacity;if(sceneObject.bordered){_.each(sceneObject.children,function(child){if(child.wireMaterial)child.wireMaterial.color=child.deselectedWireMaterial.color})}}})},unhighlight:function(handle){this.scene.each(function(sceneObject){if(!sceneObject.selectedMaterial)return;sceneObject.material.color=sceneObject.deselectedMaterial.color;sceneObject.material.opacity=sceneObject.deselectedMaterial.opacity;if(sceneObject.bordered){_.each(sceneObject.children,function(child){if(child.wireMaterial)child.wireMaterial.color=child.deselectedWireMaterial.color})}})},toColor:function(arr){if(arr instanceof Array){var color=new THREE.Color;color.setRGB(arr[0],arr[1],arr[2]);return color}else{return arr}},toVector:function(v){if(v instanceof THREE.Vector3){return v}else if(v instanceof Array){return new THREE.Vector3(v[0],v[1],v[2])}else{return new THREE.Vector3(v.x,v.y,v.z)}}});exo.translators.three.Grid=exo.translators.three.Gizmo.extend({initialize:function(options){var segments=options.segments||40,cellLength=options.cellLength||1,thickMaterial={color:[0,0,0]},lineMaterial={color:[.1,.1,.1]},partsDescriptor={},scale=[1,segments*cellLength,1],thickScale=[segments*cellLength,.02,.02],horizontalRotation=[90,0,0],verticalRotation=[90,0,90],emptyPosition=[0,0,0];partsDescriptor.thickLineHori={primitive:{type:"plane",position:emptyPosition,rotation:horizontalRotation,scale:thickScale,material:thickMaterial}};partsDescriptor.thickLineVert={primitive:{type:"plane",position:emptyPosition,rotation:verticalRotation,scale:thickScale,material:thickMaterial}};for(var i=0,iend=segments+1;i<iend;++i){for(var j=0;j<2;++j){var position,rotation;if(j===0){position=[i*cellLength-segments*cellLength*.5,0,0];rotation=horizontalRotation}else{position=[0,0,i*cellLength-segments*cellLength*.5];rotation=verticalRotation}partsDescriptor["line"+i+"-"+j]={primitive:{type:"line",position:position,scale:scale,rotation:rotation,wireframe:true,wireMaterial:lineMaterial}}}}this.parts=partsDescriptor},adjustForDisplay:function(options){var rotation=[0,0,0];var scale=1;var camera=options.cameraNode;if(camera.isOrthographic()){rotation[2-camera.camera.zoomAxis]=Math.PI/2;
scale=.25}this.center.scale=new THREE.Vector3(scale,scale,scale);this.center.rotation=new THREE.Vector3(rotation[0],rotation[1],rotation[2]);this.center.visible=this.visible}});!function(){var material;var defaultEdgeColor=new THREE.Color(16777215);var highlightedEdgeColor=(new THREE.Color).setRGB(1,0,0);exo.translators.three.gizmos.Edge=exo.translators.three.Gizmo.extend({initialize:function(options){if(options.parent){this.polyMesh=options.object3D.owner.node.polyMesh;options.parent.Edge=this.buildEdges(this.polyMesh,material);options.parent.Edge.isHelper=true;options.parent.Edge.type=this.type="Edge";options.parent.add(options.parent.Edge);options.parent=options.parent.Edge}},buildEdges:function(polyMesh,material){var wireframe=exo.translators.three.generators.convertPolyMeshToLines(polyMesh,material,true);wireframe.geometry.colors=exo.geometry.CloneUtilities.createArray(wireframe.geometry.vertices.length,defaultEdgeColor,true);return wireframe},updateGeometry:function(geometry){var otherGeometry=this.center.geometry;otherGeometry.vertices=geometry.vertices;otherGeometry.verticesNeedUpdate=true},update:function(geometry,object3D,subSelection){if(subSelection){this.highlightEdges(subSelection)}},highlightEdges:function(subSelection){var vertices=this.center.geometry.vertices;var polyData=this.center.geometry.clara_io?this.center.geometry.clara_io.polyMeshEdges:null;var colors=this.center.geometry.colors;if(!polyData){return}for(var i=0,il=vertices.length;i<il;i++){if(subSelection.byIndex[polyData[i]]){colors[i].copy(highlightedEdgeColor)}else{colors[i].copy(defaultEdgeColor)}}this.center.geometry.colorsNeedUpdate=true}});exo.translators.three.gizmos.Edge.initDisplay=function(){material=new THREE.LineBasicMaterial({color:defaultEdgeColor,vertexColors:THREE.VertexColors})}}();!function(){var material;var highlightedColor=(new THREE.Color).setRGB(1,0,0);exo.translators.three.gizmos.Face=exo.translators.three.Gizmo.extend({initialize:function(options){if(options.parent){this.polyMesh=options.object3D.owner.node.polyMesh;options.parent.Face=this.buildSelectedFaces(options.subselection);options.parent.Face.isHelper=true;options.parent.Face.type=this.type="Face";options.parent.add(options.parent.Face);options.parent=options.parent.Face}},buildSelectedFaces:function(subSelection){if(!subSelection){return new THREE.Mesh(new THREE.Geometry,material)}var newFaces=[];var polyMeshSelected=this.polyMesh.clone();for(var i=0,il=polyMeshSelected.faces.length;i<il;++i){if(subSelection.byIndex[i]!==undefined){newFaces.push(polyMeshSelected.faces[i])}}polyMeshSelected.faces=newFaces;var geometry=new exo.geometry.PolyMeshToGeometry(polyMeshSelected);geometry.computeCentroids();return new THREE.Mesh(geometry,material)},updateGeometry:function(geometry){var otherGeometry=this.center.Face.geometry;otherGeometry.vertices=geometry.vertices;otherGeometry.verticesNeedUpdate=true},update:function(geometry,object3D,subSelection){}});exo.translators.three.gizmos.Face.initDisplay=function(){material=new THREE.MeshBasicMaterial({color:highlightedColor,shading:THREE.FlatShading,transparent:true,opacity:.5})}}();!function(){var lineProperties={position:[0,-1,0],scale:[.05,2.8,.05]};var red=[1,0,0],green=[0,1,0],blue=[0,0,1],yellow=[1,1,0],magenta=[1,0,1],cyan=[0,1,1];exo.translators.three.gizmos.Move=exo.translators.three.Gizmo.extend({parts:{xCone:{primitive:{type:"cone",position:[3,0,0],rotation:[0,0,-90],scale:[1,1,1],material:{color:red},radius:.2,height:.8},axis:{x:true,y:false,z:false},hideOnAxis:{x:true,y:false,z:false},attachLine:lineProperties,label:{text:"X",position:[.1,.7,0],rotation:[0,0,90]}},yCone:{primitive:{type:"cone",position:[0,3,0],rotation:[0,0,0],scale:[1,1,1],material:{color:green},radius:.2,height:.8},axis:{x:false,y:true,z:false},hideOnAxis:{x:false,y:true,z:false},attachLine:lineProperties,label:{text:"Y",position:[-.075,.7,0]}},zCone:{primitive:{type:"cone",position:[0,0,3],rotation:[90,0,0],scale:[1,1,1],material:{color:blue},radius:.2,height:.8},axis:{x:false,y:false,z:true},hideOnAxis:{x:false,y:false,z:true},attachLine:lineProperties,label:{text:"Z",position:[0,.7,-.1],rotation:[90,90,0]}},xyPlane:{primitive:{type:"plane",position:[.45,.45,0],rotation:[0,0,0],scale:[.88,.88,.88],material:{opacity:.5,color:yellow},bordered:true,borderColor:yellow},axis:{x:true,y:true,z:false},hideOnAxis:{x:true,y:true,z:false}},xzPlane:{primitive:{type:"plane",position:[.45,0,.45],rotation:[90,0,0],scale:[.88,.88,.88],material:{opacity:.5,color:magenta},bordered:true,borderColor:magenta},axis:{x:true,y:false,z:true},hideOnAxis:{x:true,y:false,z:true}},yzPlane:{primitive:{type:"plane",position:[0,.45,.45],rotation:[0,90,0],scale:[.88,.88,.88],material:{opacity:.5,color:cyan},bordered:true,borderColor:cyan},axis:{x:false,y:true,z:true},hideOnAxis:{x:false,y:true,z:true}}},defaultScale:.075})}();!function(){var red=[1,0,0],green=[0,1,0],blue=[0,0,1],yellow=[1,1,0],magenta=[1,0,1],cyan=[0,1,1],gray=[.8,.8,.8];var transparent={opacity:0};exo.translators.three.gizmos.Rotate=exo.translators.three.Gizmo.extend({parts:{xTorus:{primitive:{type:"torus",rotation:[0,90,0],scale:[1,1,1],tubeSegs:64,radialSegs:6,innerRadius:.801,outerRadius:.001,wireframe:true,wireMaterial:{color:red}},axis:{x:true,y:false,z:false}},yTorus:{primitive:{type:"torus",rotation:[90,0,0],scale:[1,1,1],tubeSegs:64,radialSegs:6,innerRadius:.801,outerRadius:.001,wireframe:true,wireMaterial:{color:green}},axis:{x:false,y:false,z:true}},zTorus:{primitive:{type:"torus",rotation:[0,0,0],scale:[1,1,1],tubeSegs:64,radialSegs:6,innerRadius:.801,outerRadius:.001,wireframe:true,wireMaterial:{color:blue}},axis:{x:false,y:true,z:false}},centerSphere:{primitive:{type:"sphere",position:[0,0,0],rotation:[0,0,0],scale:[.15,.15,.15],material:{color:gray}},axis:{x:true,y:true,z:true}}},defaultScale:.2})}();!function(){var lineProperties={position:[0,-1,0],scale:[.05,2.5,.05]};var red=[1,0,0],green=[0,1,0],blue=[0,0,1],yellow=[1,1,0],magenta=[1,0,1],cyan=[0,1,1],gray=[.8,.8,.8];exo.translators.three.gizmos.Scale=exo.translators.three.Gizmo.extend({parts:{xBox:{primitive:{type:"box",position:[3,0,0],rotation:[0,0,-90],scale:[1,1,1],material:{color:red},size:.5},axis:{x:true,y:false,z:false},hideOnAxis:{x:true,y:false,z:false},attachLine:lineProperties,label:{text:"X",position:[.1,.7,0],rotation:[0,0,90]}},yBox:{primitive:{type:"box",position:[0,3,0],rotation:[0,0,0],scale:[1,1,1],material:{color:green},size:.5},axis:{x:false,y:true,z:false},hideOnAxis:{x:false,y:true,z:false},attachLine:lineProperties,label:{text:"Y",position:[-.075,.7,0]}},zBox:{primitive:{type:"box",position:[0,0,3],rotation:[90,0,0],scale:[1,1,1],material:{color:blue},size:.5},axis:{x:false,y:false,z:true},hideOnAxis:{x:false,y:false,z:true},attachLine:lineProperties,label:{text:"Z",position:[0,.7,-.1],rotation:[90,90,0]}},xyPlane:{primitive:{type:"plane",position:[.45,.45,0],rotation:[0,0,0],scale:[.88,.88,.88],material:{opacity:.5,color:yellow},bordered:true,borderColor:yellow},axis:{x:true,y:true,z:false},hideOnAxis:{x:true,y:true,z:false}},xzPlane:{primitive:{type:"plane",position:[.45,0,.45],rotation:[90,0,0],scale:[.88,.88,.88],material:{opacity:.5,color:magenta},bordered:true,borderColor:magenta},axis:{x:true,y:false,z:true},hideOnAxis:{x:true,y:false,z:true}},yzPlane:{primitive:{type:"plane",position:[0,.45,.45],rotation:[0,90,0],scale:[.88,.88,.88],material:{opacity:.5,color:cyan},bordered:true,borderColor:cyan},axis:{x:false,y:true,z:true},hideOnAxis:{x:false,y:true,z:true}},centerSphere:{primitive:{type:"sphere",position:[0,0,0],rotation:[0,0,0],scale:[.5,.5,.5],material:{color:gray}},axis:{x:true,y:true,z:true}}},defaultScale:.075})}();!function(){var VertexShader="varying float sel;"+"attribute float selected;"+"void main()"+"{"+"sel=selected;"+"gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);"+"gl_PointSize= 4.0;"+"}";var FragmentShader="varying float sel;"+"void main()"+"{"+"  vec4 colour;"+"  if (sel > 0.99 ) {"+"  colour = vec4(0.2, 0.2, 1.0, 1.0); "+"  } else {"+"  colour = vec4(1.0, 0.0, 0.0, 1.0); "+"  }"+"  gl_FragColor   = colour;"+"}";exo.translators.three.gizmos.Vertex=exo.translators.three.Gizmo.extend({initialize:function(options){if(options.parent){this.attributes={selected:{type:"f",value:[]}};this.shaderMaterial=new THREE.ShaderMaterial({attributes:this.attributes,vertexShader:VertexShader,fragmentShader:FragmentShader});var pGeometry=new THREE.Geometry;var particleCount=options.geometry.vertices.length;var selValues=this.attributes.selected.value;for(var i=0;i<particleCount;i++){pGeometry.vertices.push(options.geometry.vertices[i]);selValues.push(true)}options.parent.Vertex=new THREE.ParticleSystem(pGeometry,this.shaderMaterial);options.parent.Vertex.isHelper=true;options.parent.Vertex.type="Vertex";options.parent.add(options.parent.Vertex);options.parent=options.parent.Vertex}},update:function(geometry,object3D,subSelection){if(subSelection){this.highlight(subSelection)}},highlight:function(subSelection){var attributes=this.attributes;for(var i=0,length=attributes.selected.value.length;i<length;i++){attributes.selected.value[i]=1;attributes.selected.needsUpdate=true}for(var i=0,length=subSelection.attributes.indices.length;i<length;i++){attributes.selected.value[subSelection.attributes.indices[i]]=0}}})}();!function(){var white,lineMaterial,box,boundingBoxDisplay;exo.translators.three.Node=exo.translators.Node.extend({initialize:function(options){this.create(options);if(this.model.Transform){this.setObject(this.defaultMesh());this.plugs.Transform=new exo.translators.three.plugs.Transform(this.model.Transform,this)}else{this.setObject(new THREE.Object3D)}this.type=this.model.get("type")},defaultMesh:function(){var object3D=new THREE.Object3D;var primitive={type:"box",wireframe:true,wireMaterial:new THREE.MeshBasicMaterial({color:65280})};this.mesh=exo.translators.three.generators.generatePrimitive(primitive);object3D.forceVisible=object3D.visible=true;this.mesh.forceVisible=this.mesh.visible=true;object3D.add(this.mesh);return object3D},create:function(options){this.visible=false;this.subObjectType="Object";this.plugs={}},setObject:function(obj){var parentObject=null;if(this.object3D&&this.object3D!==obj){obj.position=this.object3D.position||new THREE.Vector3;obj.quaternion=this.object3D.quaternion||new THREE.Quaternion;obj.useQuaternion=this.object3D.useQuaternion||true;obj.scale=this.object3D.scale||new THREE.Vector3(1,1,1);parentObject=this.object3D.parent}if(parentObject){this.object3D.parent.remove(this.object3D)}this.object3D=obj;this.object3D.name=this.model.get("name");this.object3D.each(function(obj){if(!obj.owner){obj.owner=this}},this);if(this.helper){this.helper.each(function(obj){if(!obj.owner){obj.owner=this}},this)}if(parentObject){parentObject.add(this.object3D)}if(this.model.properties){exo.translators.three.objectUtils.setVisibility(this.object3D,this.model.properties.visible)}},updateChildren:function(addedChildren,removedChildren){_.each(removedChildren,function(child){this.object3D.remove(child.object3D)},this);_.each(addedChildren,function(child){this.object3D.add(child.object3D)},this)},addDefaultLight:function(){this.scene.threeScene.add(this.scene.threeScene.defaultLight);this.scene.threeScene.updateMaterials()},removeDefaultLight:function(){this.scene.threeScene.remove(this.scene.threeScene.defaultLight)},setSelected:function(selected){this.isSelected=selected},isSelectable:function(){var props=this.model.properties;return props&&props.visible&&props.selectable&&this.object3D.visible},getBoundingSphere:function(){return exo.translators.three.objectUtils.getBoundingSphere(this.object3D)},getBoundingBox:function(){return this.boundingBox?this.boundingBox:this.createBoundingBox()},createBoundingBox:function(){if(!this.mesh)return null;var geometry=this.mesh.geometry;geometry.computeBoundingBox();this.boundingBox=geometry.boundingBox;return this.boundingBox},getMeshes:function(){var subSelection=this.subSelection;var type=subSelection?subSelection.get("type"):"";return exo.translators.three.objectUtils.getMeshes(this.object3D,type==="Object")},getAABB:function(){var bb=this.getBoundingBox();return bb&&bb.clone().applyMatrix4(this.object3D.matrixWorld)},getColor:function(){return white},renderBoundingBox:function(threeScene,selectedOnly){if(!selectedOnly||selectedOnly&&this.scene.selection.isSelected(this.model)){var tempBoundingBox=selectedOnly?boundingBoxDisplay:box;var object3D=this.object3D;var color=this.getColor()||white;var aabb=this.getAABB();if(!aabb)return;var min=aabb.min;var max=aabb.max;var diagonal=new THREE.Vector3(max.x-min.x,max.y-min.y,max.z-min.z);var middle=new THREE.Vector3(min.x+diagonal.x/2,min.y+diagonal.y/2,min.z+diagonal.z/2);if(!selectedOnly){tempBoundingBox.material=tempBoundingBox.material.clone();tempBoundingBox.material.color=color.clone();var mesh=object3D.owner&&object3D.owner.mesh||object3D.children[0];tempBoundingBox.visible=mesh?mesh.forceVisible:false}tempBoundingBox.scale=diagonal;tempBoundingBox.position=middle;tempBoundingBox.updateMatrixWorld();threeScene.add(tempBoundingBox.clone())}},eachObject:function(threeObj,iterator,context){iterator.call(context,threeObj);_.each(threeObj.children||[],function(obj){this.eachObject(obj,iterator,context)},this)},createSubObjects:function(subSelection){if(this.object3D&&this.object3D.parent&&this.model.PolyMesh&&this.subObjectType!=="Object"){if(subSelection){this.subSelection=subSelection}var type=this.subObjectType;if(this.subObjects){this.object3D.parent.remove(this.subObjects)}else{this.subObjects=new THREE.Object3D;this.subObjects.position=this.object3D.position;this.subObjects.quaternion=this.object3D.quaternion;this.subObjects.useQuaternion=this.object3D.useQuaternion;this.subObjects.rotation=this.object3D.rotation;this.subObjects.visible=this.subObjects.forceVisible=true}if(exo.translators.three.gizmos[type]){var dynamic=this.model.PolyMesh.dynamicUpdate;if(dynamic&&this.subObjectGizmo&&type===this.subObjectGizmo.type&&this.subObjectGizmo.updateGeometry){this.subObjectGizmo.updateGeometry(this.mesh.geometry)}else{if(this.subObjectGizmo){this.subObjects.remove(this.subObjectGizmo.center)}this.subObjectGizmo=new exo.translators.three.gizmos[type]({parent:this.subObjects,object3D:this.object3D,geometry:this.mesh.geometry,subselection:this.subSelection});this.subObjectGizmo.setVisibility(true)}if(this.subSelection){this.subObjectGizmo.update(this.mesh.geometry,this.object3D,this.subSelection)}}this.object3D.parent.add(this.subObjects)}},updateSubObjects:function(subSelection){var node=subSelection.node();var type=subSelection.get("type");var isObject=type==="Object";this.subObjectType=type;if(node===this.model){if(!this.subObjects||!this.subObjects[type]){this.createSubObjects()}if(this.subObjects){if(isObject){exo.translators.three.objectUtils.setVisibility(this.subObjects,false);if(this.wireframe){this.wireframe.forceVisible=this.wireframe.visible=this.model.properties.visible}}else{_.each(this.subObjects.children,function(child){exo.translators.three.objectUtils.setVisibility(child,node===this.model&&child.type===type)},this);if(this.wireframe){this.wireframe.forceVisible=this.wireframe.visible=type!=="Edge"}}}if(!isObject&&this.mesh&&this.subObjectGizmo){if(type==="Face"){this.createSubObjects(subSelection)}else{this.subObjectGizmo.update(this.mesh.geometry,this.object3D,subSelection)}}}else{if(this.wireframe){this.wireframe.forceVisible=this.wireframe.visible=this.model.properties.visible}if(this.mesh){this.mesh.forceVisible=this.mesh.visible=this.model.properties.visible}if(this.subObjects){exo.translators.three.objectUtils.setVisibility(this.subObjects,false)}}this.scene.render()},adjustHelperForDisplay:function(viewport,camera,helper,defaultScale){defaultScale=defaultScale||1;var centroid=(new THREE.Vector3).getPositionFromMatrix(helper.matrixWorld);var rect=viewport.get("rect");var cameraNode=camera.node;var camWidth=Math.max(cameraNode.camera.getWidth(),0);var viewportWidth=rect.width;var viewportScale=600/viewportWidth;if(viewportScale>1)viewportScale=1;var orthoZoomFactor=500;var cameraTranslation=cameraNode.transform.getTranslation();var amount=Math.max(1e-7,cameraNode.isOrthographic()?orthoZoomFactor*camWidth/viewportWidth:cameraTranslation.distanceTo(centroid)*viewportScale);var newScale=amount*defaultScale;helper.scale.set(newScale,newScale,newScale);helper.updateMatrix()}});exo.translators.three.Node.initDisplay=function(){white=(new THREE.Color).setHex(16777215);box=exo.translators.three.generators.generatePrimitive({type:"box",wireframe:true,wireMaterial:new THREE.MeshBasicMaterial({color:16777215,shininess:0,ambient:8355711})});lineMaterial=new THREE.LineBasicMaterial(16777215);boundingBoxDisplay=exo.translators.three.generators.boundingBoxDisplay(lineMaterial)}}();exo.translators.three.nodes.Bone=exo.translators.three.Node.extend({type:"Bone",initialize:function(options){this.create(options);this.mesh=null;this.object3D=new THREE.Object3D;this.plugs={Bone:new exo.translators.three.plugs.Bone(this.model.Bone,this),Transform:new exo.translators.three.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.three.plugs.Properties(this.model.Properties,this)}}});exo.translators.three.nodes.Camera=exo.translators.three.Node.extend({type:"Camera",hasHelpers:true,initialize:function(options){this.create(options);this.mesh=null;this.camera=null;this.object3D=new THREE.Object3D;this.plugs={Camera:new exo.translators.three.plugs.Camera(this.model.Camera,this),Transform:new exo.translators.three.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.three.plugs.Properties(this.model.Properties,this)}}});exo.translators.three.nodes.Light=exo.translators.three.Node.extend({type:"Light",hasHelpers:true,initialize:function(options){this.create(options);this.light=null;this.setObject(new THREE.Object3D);this.plugs={Light:new exo.translators.three.plugs.Light(this.model.Light,this),Transform:new exo.translators.three.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.three.plugs.Properties(this.model.Properties,this)}}});exo.translators.three.nodes.Null=exo.translators.three.Node.extend({type:"Null",initialize:function(options){this.create(options);this.mesh=null;this.setObject(new THREE.Object3D);this.plugs={Null:new exo.translators.three.plugs.Null(this.model.Null,this),Transform:new exo.translators.three.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.three.plugs.Properties(this.model.Properties,this)}}});exo.translators.three.nodes.PolyMesh=exo.translators.three.Node.extend({type:"PolyMesh",initialize:function(options){this.create(options);this.meshes=new THREE.Object3D;this.subObjects=new THREE.Object3D;this.mesh=null;this.wireframe=null;this.setObject(new THREE.Object3D);this.plugs={PolyMesh:new exo.translators.three.plugs.PolyMesh(this.model.PolyMesh,this),Transform:new exo.translators.three.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.three.plugs.Properties(this.model.Properties,this),Material:new exo.translators.three.plugs.Material(this.model.Material,this)}},updateChildren:function(addedChildren,removedChildren){_.each(removedChildren,function(child){this.object3D.remove(child.object3D)},this);this.object3D.add(this.subObjects);this.object3D.add(this.meshes);_.each(addedChildren,function(child){this.object3D.add(child.object3D)},this)},defaultMesh:function(){var object3D=new THREE.Object3D;var primitive={type:"box",wireframe:true};object3D.add(exo.translators.three.generators.generatePrimitive(primitive));object3D.add(exo.translators.three.generators.generatePrimitive(primitive));return object3D}});!function(){exo.translators.three.Scene=exo.translators.Scene.extend({initialize:function(options){this.editor=options.editor;this.renderer=options.renderer;this.gl=this.renderer.getContext();this.clearColor=(new THREE.Color).setRGB(0,0,0);this.defaultLightCount=0;if(!this.model.objectsLoaded){this.bindTo(this.model,"objectsLoaded",this.onObjectsLoaded,this)}else{this.onObjectsLoaded()}this.initDisplay();this.threeScene=new THREE.Scene;this.threeScene.name="Three Scene: "+this.model.get("name");this.threeScene.camera=new THREE.PerspectiveCamera;this.initAmbientLight();this.initDefaultLight();this.threeScene.isRendering=false;this.grid=new exo.translators.three.Grid({visible:true});this.gizmos={};_.each(exo.translators.three.gizmos,function(Gizmo,name){this.gizmos[name]=new Gizmo},this);this.object3D=new THREE.Object3D;this.object3D.name="SceneRoot";this.object3D.node=this;this.threeScene.add(this.object3D);this.initEvents(this.editor);this.editor.viewports.each(function(viewport,index){this.scene.registry.create(viewport.camera,this)},this);this.selection=new exo.translators.three.Selection(this.editor,this);this.initSelectionEvents();this.enableShadow=true;this.update()},onObjectsLoaded:function(){this.plugs={Environment:new exo.translators.three.plugs.Environment(this.model.Environment,this)};this.version++;this.update()},initDisplay:function(){exo.translators.three.plugs.Material.clearCache();exo.translators.three.generators.initDisplay();exo.translators.three.gizmos.Edge.initDisplay();exo.translators.three.gizmos.Face.initDisplay();exo.translators.three.Node.initDisplay()},registry:new exo.translators.Registry({Scene:exo.translators.three.Scene,Node:exo.translators.three.Node,Objects:exo.translators.three.Node,PolyMesh:exo.translators.three.nodes.PolyMesh,Null:exo.translators.three.nodes.Null,Bone:exo.translators.three.nodes.Bone,Light:exo.translators.three.nodes.Light,Camera:exo.translators.three.nodes.Camera}),initAmbientLight:function(){this.ambientLight=new THREE.AmbientLight(0);this.threeScene.add(this.ambientLight);this.defaultLightCount++},initDefaultLight:function(){this.light=this.threeScene.defaultLight=new THREE.DirectionalLight(16777215);this.light.name="Default Light";this.light.intensity=1.1;this.light.position.x=.5;this.light.position.y=1;this.light.position.z=.5;this.light.position.normalize();this.threeScene.add(this.light);this.defaultLightCount++},initEvents:function(editor){this.bindTo(editor.scene,"dirty",function(){this.trigger("dirty",this)},this);this.bindTo(editor.scene,"immediateUpdate",function(){this.updateNextFrame()},this);this.bindTo(this,"dirty",defer(0,this.update,this));this.bindTo(editor,"change:activeManipulator",this.triggerDirty,this)},initSelectionEvents:function(){this.bindTo(this.editor.subSelection,"change:type",defer(1,this.createSubSelection,this));this.bindTo(this.editor.subSelection,"add",defer(1,this.updateSubSelection,this));this.bindTo(this.editor.subSelection,"remove",defer(1,this.updateSubSelection,this));this.bindTo(this.editor.selected,"add",defer(1,this.onSelected,this));this.bindTo(this.editor.selected,"remove",defer(1,this.onDeselected,this));this.bindTo(this.editor,"selectedManipulator",defer(1,this.onManipulatorSelected,this))},updateChildren:exo.translators.three.Node.prototype.updateChildren,updateProperties:exo.translators.three.Node.prototype.updateProperties,onSelected:function(node){this.selection.selectNode(node);this.onSelection(node)},onDeselected:function(node){this.selection.deselectNode(node);this.onSelection(node)},onSelection:function(otherNode){var node=this.editor.selected.length===1?this.editor.selected.last():null;if(node&&node.selectedManipulator){this.onManipulatorSelected(node,node.selectedManipulator)}else{this.onManipulatorSelected(node,null)}this.updateSubSelection(otherNode);this.render()},onManipulatorSelected:function(node,manipulator){if(this.editor.selected.length!==1)manipulator=null;if(manipulator){if(!this.operatorGizmo||this.operatorGizmo&&this.operatorGizmo.manipulator!==manipulator){if(this.operatorGizmo)this.operatorGizmo.operator.off("change",this.updateOperatorGizmo,this);this.operatorGizmo=new exo.translators.three.Gizmo(_.clone(manipulator.customGizmo));this.operatorGizmo.manipulator=manipulator;this.operatorGizmo.operator=manipulator.operator;this.operatorGizmo.node=manipulator.operator.node();if(this.operatorGizmo.update){this.updateOperatorGizmo();this.operatorGizmo.operator.on("change",this.updateOperatorGizmo,this)}}}else{if(this.operatorGizmo)this.operatorGizmo.operator.off("change",this.updateOperatorGizmo,this);this.operatorGizmo=null}},updateOperatorGizmo:function(){if(this.operatorGizmo.update){var selected=this.editor.selected.last();var displayNode=this.selection.selectedById[selected.id];this.operatorGizmo.update(this.operatorGizmo.operator,displayNode)}},triggerDirty:function(){this.trigger("dirty",this)},destroy:function(){this.unbindAll();_.each(this.translatorMap,function(translator){if(translator&&translator!==this)translator.destroy()},this)},getSelectables:function(excludedThreeIDs){var selectables=[];this.each(function(displayNode){if(displayNode.isSelectable()&&excludedThreeIDs.indexOf(displayNode.object3D.id)<0){selectables.push(new exo.translators.three.Selectable({sphere:displayNode.getBoundingSphere(),meshes:displayNode.getMeshes(),displayNode:displayNode}))}});return selectables},useCamera:function(uuid,renderType){var cameraDisplayNode=this.get(uuid);if(!cameraDisplayNode){throw new Error("Unknown camera:"+uuid)}if(!cameraDisplayNode.camera){cameraDisplayNode.update()}this.threeScene.camera=cameraDisplayNode.camera;this.currentCamera=cameraDisplayNode;this.updateDefaultLight(cameraDisplayNode.camera,renderType);return cameraDisplayNode.model},isCurrentCameraDefault:function(viewport){if(!viewport.camera.scene()){return true}return false},showViewportCamera:function(viewport,visible){var oldStatus;if(!this.isCurrentCameraDefault(viewport)){oldStatus=this.currentCamera.object3D.visible;exo.translators.three.objectUtils.setVisibility(this.currentCamera.object3D,visible)}return oldStatus},updateDefaultLight:function(camera){var light=this.threeScene.defaultLight;if(light){light.position.set(camera.position.x+1,camera.position.y+3,camera.position.z);if(camera.quaternion){light.quaternion.copy(camera.quaternion)}else{light.rotation.copy(camera.rotation)}if(light.distance!==undefined){light.distance=camera.far}}},preRenderSolid:function(){if(this.gl){this.gl.polygonOffset(1,1);this.gl.enable(this.gl.POLYGON_OFFSET_FILL)}},postRenderSolid:function(){if(this.gl){this.gl.disable(this.gl.POLYGON_OFFSET_FILL)}},renderBoundingBoxes:function(selectedOnly){var scene=new THREE.Scene;this.each(function(displayNode){displayNode.renderBoundingBox(scene,selectedOnly)});this.renderer.render(scene,this.threeScene.camera)},renderShaded:function(){var oldLights=this.threeScene.__lights.slice(0);_.each(this.threeScene.__lights,function(light){this.threeScene.remove(light)},this);this.threeScene.add(this.threeScene.defaultLight);this.threeScene.updateMaterials();this.renderer.render(this.threeScene,this.threeScene.camera);this.threeScene.remove(this.threeScene.defaultLight);_.each(oldLights,function(light){this.threeScene.add(light)},this);this.threeScene.updateMaterials()},renderShadow:function(enableShadow,enableCascade){var shadowOk=enableShadow;if(enableShadow){var lights=this.editor.scene.filter(function(node){return node.get("type")==="Light"&&node.light&&node.light.castShadow&&node.light.showShadowCamera!==undefined});shadowOk=lights&&lights.length>0?true:false}this.renderer.physicallyBasedShading=true;this.renderer.shadowMapEnabled=shadowOk;if(shadowOk){this.renderer.shadowMapType=THREE.PCFSoftShadowMap;if(enableCascade){this.renderer.shadowMapCascade=enableCascade}}},setshadowMapType:function(shadowMapType){this.renderer.shadowMapType=shadowMapType},enableShadow:function(_enableShadow){this.enableShadow=_enableShadow},render:function(){if(!this.isUpdating){this.isUpdating=true;requestAnimationFrame(this.renderNextFrame.bind(this))}},cacheTransforms:function(){this.threeScene.doTransform()},renderNextFrame:function(){this.isUpdating=true;this.renderer.setClearColor(this.clearColor,0);this.renderer.clear();var isStatsVisible=false;this.editor.viewports.each(function(viewport){if(viewport.get("visible")){this.updateViewport(viewport);this.adjustHelpersForDisplay(viewport);var cameraVisibilityOld=this.showViewportCamera(viewport,false);this.renderScene(viewport.get("renderType"),viewport.get("edges"),viewport);if(cameraVisibilityOld!==undefined){this.showViewportCamera(viewport,cameraVisibilityOld)}}if(viewport.get("statsVisible")){isStatsVisible=true}},this);this.isUpdating=false;var updateTime=new Date-this.startUpdateTime;if(updateTime&&!this.model.Timeline.playing){exo.stats.set("fps",1e3/updateTime,"FPS")}if(isStatsVisible){var selectedNode=this.editor.selected.length?this.editor.selected.last():this.editor.scene;exo.stats.set("Polygons",exo.geometry.PolyMeshUtilities.polygonCount(selectedNode));exo.stats.set("Vertices",exo.geometry.PolyMeshUtilities.vertexCount(selectedNode))}},adjustHelpersForDisplay:function(viewport){_.each(this.translatorMap,function(translator){if(translator&&translator.hasHelpers){translator.adjustForDisplay(viewport,this.currentCamera)}},this)},updateViewport:function(viewport){var rect=viewport.get("rect");this.useCamera(viewport.camera.id,viewport.get("renderType"));if(viewport.get("gridVisible")!==this.grid.visible){this.grid.setVisibility(viewport.get("gridVisible"))}this.renderer.setViewport(rect.x,rect.y,rect.width,rect.height)},addDefaultLight:exo.translators.three.Node.prototype.addDefaultLight,removeDefaultLight:exo.translators.three.Node.prototype.removeDefaultLight,update:function(){var count=exo.translators.Scene.prototype.update.call(this);if(this.threeScene.__lights.length<this.defaultLightCount){this.addDefaultLight()}else if(this.threeScene.__lights.length>this.defaultLightCount&&this.light.parent){this.removeDefaultLight()}return count},renderScene:function(renderType,showEdges,viewport){if(this.skyboxPlug&&this.skyboxPlug.visible){this.skyboxPlug.render(this.renderer,this.threeScene.camera,this.currentCamera.node,viewport)}this.grid.render(this.renderer,this.threeScene.camera,{cameraNode:this.currentCamera.model});this.preRenderSolid();exo.translators.three.objectUtils.setMaterialsToWireframe(this.threeScene,false);this.renderShadow(this.enableShadow&&renderType==="realistic"?true:false);if(renderType==="realistic"){this.renderer.render(this.threeScene,this.threeScene.camera)}else if(renderType==="shaded"){this.renderShaded()}else if(renderType==="boundingBox"){this.renderBoundingBoxes()}this.postRenderSolid();if((renderType==="wireframe"||showEdges)&&renderType!=="boundingBox"){exo.translators.three.objectUtils.setMaterialsToWireframe(this.threeScene,true);this.renderer.render(this.threeScene,this.threeScene.camera)}this.renderBoundingBoxes(true);if(this.operatorGizmo){this.renderGizmo(viewport,this.operatorGizmo)}if(this.isGizmoVisible()){this.renderGizmo(viewport)}},findGizmos:function(vector,viewport){var activeGizmo=this.editor.currentManipulator();var gizmo=this.gizmos[activeGizmo];var parts=[];if(gizmo&&this.selection.length){var selectables=gizmo.getSelectables(viewport.camera);if(selectables.length){this.updateViewport(viewport);gizmo.adjustForDisplay({updateMatrix:true,centroid:this.getCentroid(activeGizmo),cameraNode:this.currentCamera.model,viewSize:viewport.getViewRect()});parts=exo.translators.three.pickers.point(vector,selectables,this.threeScene.camera)||[];if(this.operatorGizmo){selectables=this.operatorGizmo.getSelectables(viewport.camera);if(selectables.length){this.operatorGizmo.adjustForDisplay({updateMatrix:true,centroid:this.getCentroid(activeGizmo),cameraNode:this.currentCamera.model,viewSize:viewport.getViewRect()});parts=parts.concat(exo.translators.three.pickers.point(vector,selectables,this.threeScene.camera));console.log(parts)}}}}return parts.length?parts[0]:null},findNodesInArea:function(area,cameraUuid){var cameraDisplayNode=this.get(cameraUuid);var excludeSlections=[cameraDisplayNode.camera.id];return exo.translators.three.pickers.area(area,this.getSelectables(excludeSlections),cameraDisplayNode.camera)
},findNodes:function(vector,cameraUuid){var cameraDisplayNode=this.get(cameraUuid);if(!cameraDisplayNode.camera)return[];var excludeSlections=[cameraDisplayNode.camera.id];return exo.translators.three.pickers.point(vector,this.getSelectables(excludeSlections),cameraDisplayNode.camera)},renderGizmo:function(viewport,gizmo){var activeGizmo=this.editor.currentManipulator();gizmo=gizmo||this.gizmos[activeGizmo];if(gizmo){var selectionCentroid=this.getCentroid(activeGizmo);if(this.gl){this.gl.clear(this.gl.DEPTH_BUFFER_BIT)}gizmo.render(this.renderer,this.threeScene.camera,{centroid:selectionCentroid,cameraNode:this.currentCamera.model,viewSize:viewport.getViewRect()})}},getCentroid:function(activeGizmo){var node=this.editor.subSelection.node();var selectedManipulator=node?node.selectedManipulator:null;if(selectedManipulator&&selectedManipulator.getCentroid){return this.selection.getCentroid(activeGizmo).add(selectedManipulator.getCentroid(selectedManipulator.operator))}else if(this.editor.subSelection.get("type")==="Object"){return this.selection.getCentroid(activeGizmo)}else{return this.editor.subSelection.getCentroid()}},highlightGizmoParts:function(handle){var gizmo=this.gizmos[this.editor.currentManipulator()];if(gizmo&&this.selection.length)gizmo.highlight(handle);this.render()},unhighlightGizmoParts:function(handle){var gizmo=this.gizmos[this.editor.currentManipulator()];if(gizmo&&this.selection.length)gizmo.unhighlight(handle);this.render()},isGizmoVisible:function(){if(this.selection.length>0&&this.editor.hasAnySelection()){return true}return false},getThreeCamera:function(viewport){var cameraNode=this.get(viewport.camera.id);return cameraNode?cameraNode.camera:null},updateSubSelection:function(otherNode){var node=this.editor.subSelection.node();var displayNode;if(node){displayNode=this.get(node.id);if(displayNode){displayNode.updateSubObjects(this.editor.subSelection)}}if(node!==otherNode&&otherNode&&otherNode.id){displayNode=this.get(otherNode.id);if(displayNode){displayNode.updateSubObjects(this.editor.subSelection)}}},createSubSelection:function(otherNode){var node=this.editor.subSelection.node();var displayNode;if(node){displayNode=this.get(node.id);if(displayNode){displayNode.createSubObjects(this.editor.subSelection)}}if(node!==otherNode&&otherNode&&otherNode.id){displayNode=this.get(otherNode.id);if(displayNode){displayNode.createSubObjects(this.editor.subSelection)}}},findInSubObjectGizmo:function(vector,viewport,isArea,method){var node=this.editor.subSelection.node(),displayNode,parts=[];var type=this.editor.subSelection.get("type");var cameraDisplayNode=this.get(viewport.camera.id);if(node&&cameraDisplayNode){displayNode=this.get(node.id);if(displayNode){var selectables=[new exo.translators.three.Selectable({sphere:displayNode.getBoundingSphere(),meshes:displayNode.getMeshes(),displayNode:displayNode})];var ignoreBackfacing=this.editor.selectionProperties.get("ignoreBackfacing");if(isArea){parts=exo.translators.three.pickers.sub.area(vector,selectables,cameraDisplayNode.camera,type,ignoreBackfacing)}else{parts=exo.translators.three.pickers.sub.point(vector,selectables,cameraDisplayNode.camera,type,ignoreBackfacing)}}}return parts}});var toVector=function(v){if(v instanceof THREE.Vector3){return v}else if(v instanceof Array){return new THREE.Vector3(v[0],v[1],v[2])}else{return new THREE.Vector3(v.x,v.y,v.z)}}}();exo.translators.three.plugs.Bone=exo.translators.Plug.extend({initialize:function(){if(this.node.node.Transform){}this.update()},createBone:function(result){var geometry,polyMesh;var length=result.boneLength;var newCenter;if(result.shapeType===exo.operators.Bone.ShapeType.Box){newCenter=new THREE.Vector3(0,0,length/2);geometry=new THREE.CubeGeometry(result.width,result.height,length,1,1,1);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(newCenter.x,newCenter.y,newCenter.z));geometry.applyMatrix((new THREE.Matrix4).makeRotationY(Math.PI/2))}else if(result.shapeType===exo.operators.Bone.ShapeType.Cylinder){newCenter=new THREE.Vector3(0,length/2,0);geometry=new THREE.CylinderGeometry(result.width,result.height,length,12,1,false);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(newCenter.x,newCenter.y,newCenter.z));geometry.applyMatrix((new THREE.Matrix4).makeRotationX(Math.PI/2));geometry.applyMatrix((new THREE.Matrix4).makeRotationY(Math.PI/2))}else if(result.shapeType===exo.operators.Bone.ShapeType.Human){}polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);polyMesh.normalMap=exo.geometry.PolyMeshUtilities.flatNormalMap(polyMesh.faces,polyMesh.positions);return polyMesh},update:function(plug,result){if(!result||!_.size(result)){this.node.setObject(this.node.defaultMesh());return}var bonePolyMesh=this.createBone(result);var otherChildren=this.object3D?_.filter(this.object3D.children,function(obj){return obj.owner!==this.node},this):[];var object3D=exo.translators.three.generators.buildMesh(bonePolyMesh);this.node.meshes=object3D;if(this.mesh){object3D.children[0].material=this.mesh.material}if(this.wireframe){object3D.children[1].material=this.wireframe.material}if(object3D.children[0].material){object3D.children[0].material.color=result.color}if(object3D.children[1].material){object3D.children[1].material.color=result.color}object3D.children[0].visible=object3D.children[0].forceVisible=this.node.visible;object3D.children[1].visible=object3D.children[1].forceVisible=this.wireframe?this.wireframe.visible:true;_.each(otherChildren,function(obj){object3D.add(obj)},this);this.node.setObject(object3D);this.mesh=this.node.mesh=object3D.children[0];this.wireframe=this.node.wireframe=object3D.children[1];this.node.createBoundingBox()}});!function(){exo.translators.three.plugs.Camera=exo.translators.Plug.extend({createCamera:function(result){var cameraSize;var width,height;var camera;var orthoZoom=result.orthoZoom;cameraSize=result.computeCameraSize(true);var width=cameraSize.width,height=cameraSize.height;if(height===0){height=exo.math.EPSILON}if(result.projection==="Orthographic"){camera=new THREE.OrthographicCamera(-width,width,-height,height,result.nearClip,result.farClip)}else{camera=new THREE.PerspectiveCamera(result.fieldOfView,result.aspectRatio,result.nearClip,result.farClip)}camera.target=new THREE.Object3D;this.node.camera=this.camera=camera;camera.add(this.cameraMesh());this.node.cameraHelper=this.cameraHelper=this.createFrustumHelper(camera);this.showFrustumHelper(true);this.node.setObject(camera)},createFrustumHelper:function(camera){this.cameraClone=exo.geometry.CloneUtilities.cloneCamera(camera);this.node.cameraHelper=this.cameraHelper=new THREE.CameraHelper(this.cameraClone);this.cameraHelperAdded=false;return this.cameraHelper},showFrustumHelper:function(enableFrustum,showClipping){if(!this.cameraHelper){return}if(enableFrustum){if(showClipping){exo.geometry.CloneUtilities.copyCamera(this.cameraClone,this.camera,true)}else{exo.geometry.CloneUtilities.copyCamera(this.cameraClone,this.camera,true,10)}this.cameraHelper.update();if(!this.cameraHelperAdded){this.camera.add(this.cameraHelper);this.cameraHelperAdded=true}}else{if(this.cameraHelperAdded){this.camera.remove(this.cameraHelper);this.cameraHelperAdded=false}}},getCameraSize:function(camera,viewResolution){var aspect=camera.aspectRatio;var dist=camera.orthoZoom;var tangent=Math.tan(THREE.Math.degToRad(camera.fieldOfView/2));var camHeight_half=tangent*dist;var camWidth_half=camHeight_half*aspect;return{width:camWidth_half,height:camHeight_half}},cameraMesh:function(){this.mesh=this.node.mesh=exo.translators.three.generators.generatePrimitive({name:"CameraMesh",type:"cone",rotation:[90,0,0],scale:[.3,.3,.3],position:[0,0,.15],clearDepth:false,wireframe:true,wireMaterial:{color:[1,1,0],shininess:0,ambient:[.5,.5,.5]}});var box=exo.translators.three.generators.generatePrimitive({name:"CameraMeshBox",type:"box",rotation:[0,0,0],scale:[1,1,1],position:[0,.6,0],clearDepth:false,wireframe:true,wireMaterial:{color:[1,1,0],shininess:0,ambient:[.5,.5,.5]}});this.mesh.add(box);this.node.createBoundingBox();return this.mesh},update:function(plug,camera){var orthoZoom=camera.orthoZoom;var cameraSize=camera.computeCameraSize(true);var width=cameraSize.width,height=cameraSize.height;if(height===0){height=exo.math.EPSILON}var cameraMatches=camera.projection==="Orthographic"===this.camera instanceof THREE.OrthographicCamera;if(!this.camera||!cameraMatches){this.createCamera(camera)}this.camera.target.position.copy(camera.target);this.camera.far=camera.farClip;this.camera.near=camera.nearClip;if(camera.isOrthographic()){this.camera.left=-width;this.camera.right=width;this.camera.top=height;this.camera.bottom=-height;this.camera.near=this.camera.near;this.camera.far=this.camera.far}else{this.camera.fov=camera.fieldOfView;this.camera.aspect=camera.aspectRatio}this.camera.updateProjectionMatrix();this.showFrustumHelper(camera.showFrustum,camera.showClipping)},defaultScale:.075,adjustForDisplay:function(viewport,camera){if(this.mesh){this.node.adjustHelperForDisplay(viewport,camera,this.mesh,this.defaultScale)}}})}();exo.translators.three.plugs.Environment=exo.translators.Plug.extend({initialize:function(){this.materialTranslator=new exo.translators.three.plugs.Material(this.plug,this.node);this.node.skyboxPlug=this;this.scene=new THREE.Scene;var sphereGeometry=new exo.geometry.SphereLatheGeometry(1e4);this.skybox=this.node.skybox=new THREE.Mesh(sphereGeometry);this.scene.add(this.skybox);this.setVisibility(false)},update:function(plug,result){if(result.cubeMapVisible&&result.cubeMap&&result.cubeMap.material){this.materialTranslator.updateMeshMaterial(this.skybox,result.cubeMap.material,true);this.setVisibility(true)}else{this.setVisibility(false)}if(result.ambientLight){this.node.scene.ambientLight.color=result.ambientLight.clone()}},setVisibility:function(visible){this.visible=visible;this.skybox.visible=this.skybox.forceVisible=visible},adjustForDisplay:function(camera,cameraNode,viewport){if(this.visible){if(camera instanceof THREE.OrthographicCamera){var scale=cameraNode.camera.getWidth()/(viewport.getViewRect().width*10);if(scale>1){scale=1}this.skybox.scale.set(scale,scale,scale)}else{this.skybox.scale.set(1,1,1)}}},render:function(renderer,camera,cameraNode,viewport){this.scene.camera=camera;this.adjustForDisplay(camera,cameraNode,viewport);renderer.render(this.scene,camera)}});!function(){var LightCreator={__v1:new THREE.Vector3,PointLight:function(self,result){self.light=new THREE.PointLight(result.color.getHex(),result.intensity,result.distance);self.light.dataUpdate=function(result){this.color=result.color||new THREE.Color(16777215);this.intensity=result.intensity!==undefined?result.intensity:1;this.distance=result.distance!==undefined?result.distance:100};self.helper=new THREE.PointLightHelper(self.light,.1)},SpotLight:function(self,result){self.light=new THREE.SpotLight(result.color.getHex(),result.intensity,result.distance,result.coneAngle*(Math.PI/180),result.falloffExponent);self.light.target.position.set(0,0,-1);self.light.add(self.light.target);self.light.dataUpdate=function(result){this.color=result.color||new THREE.Color(16777215);this.intensity=result.intensity!==undefined?result.intensity:1;this.distance=result.distance!==undefined?result.distance:100;this.angle=result.coneAngle*(Math.PI/180);this.exponent=result.falloffExponent;this.castShadow=result.castShadow!==undefined?result.castShadow:false;this.shadowCameraVisible=result.showShadowCamera;this.shadowBias=result.shadowBias;this.shadowMapWidth=result.shadowSize;this.shadowMapHeight=result.shadowSize;this.shadowCameraFov=result.coneAngle*2;this.shadowCameraNear=result.shadowNearClip;this.shadowCameraFar=result.shadowFarClip;this.shadowDarkness=result.shadowDarkness;this.ShadowUpdate(result)};self.light.ShadowUpdate=function(result){if(this.cameraHelper){var cameraShadow=this.cameraHelper.camera;cameraShadow.fov=this.shadowCameraFov;cameraShadow.aspect=this.shadowMapWidth/this.shadowMapHeight;cameraShadow.near=this.shadowCameraNear;cameraShadow.far=this.shadowCameraFar;cameraShadow.updateProjectionMatrix();this.cameraHelper.update()}};self.helper=new THREE.SpotLightHelper(self.light,.1);self.light.add(self.helper);self.helper.lightCone.position.set(0,0,0);var oldUpdate=self.helper.update;self.helper.update=function(){var dist=this.light.distance;this.light.distance=1;oldUpdate.call(this);this.light.distance=dist}},DirectionalLight:function(self,result){self.light=new THREE.DirectionalLight(result.color.getHex(),result.intensity);self.light.target.position.set(0,0,-1);self.light.add(self.light.target);this.__v1.set(0,0,-1);var arrow=new THREE.ArrowHelper(this.__v1,new THREE.Vector3(0,0,0),1,16777215);self.light.add(arrow);self.light.dataUpdate=function(result){var lightDirty=false;this.color=result.color||new THREE.Color(16777215);this.intensity=result.intensity!==undefined?result.intensity:1;this.castShadow=result.castShadow!==undefined?result.castShadow:false;this.shadowCameraVisible=result.showShadowCamera;this.shadowBias=result.shadowBias;this.shadowMapWidth=result.shadowSize;this.shadowMapHeight=result.shadowSize;this.shadowCameraLeft=-result.shadowCameraSize;this.shadowCameraRight=result.shadowCameraSize;this.shadowCameraTop=result.shadowCameraSize;this.shadowCameraBottom=-result.shadowCameraSize;this.shadowCameraNear=result.shadowNearClip;this.shadowCameraFar=result.shadowFarClip;this.shadowDarkness=result.shadowDarkness;this.ShadowUpdate(result)};self.light.ShadowUpdate=function(result){if(this.cameraHelper){var cameraShadow=this.cameraHelper.camera;cameraShadow.left=this.shadowCameraLeft;cameraShadow.right=this.shadowCameraRight;cameraShadow.top=this.shadowCameraTop;cameraShadow.bottom=this.shadowCameraBottom;cameraShadow.near=this.shadowCameraNear;cameraShadow.far=this.shadowCameraFar;cameraShadow.updateProjectionMatrix();this.cameraHelper.update()}};self.helper=new THREE.DirectionalLightHelper(self.light,.1)}};exo.translators.three.plugs.Light=exo.translators.Plug.extend({initialize:function(){this.node.createBoundingBox=this.createBoundingBox.bind(this)},createBoundingBox:function(){if(!this.helper)return null;this.helper.lightSphere.geometry.computeBoundingBox();var bb=this.helper.lightSphere.geometry.boundingBox;return this.helper.lightSphere.geometry.boundingBox},createLight:function(lightPrimitive){var type=lightPrimitive.getType();this.type=type;if(this.helper&&this.helper.parent){this.helper.parent.remove(this.helper)}if(!lightPrimitive.color){return}LightCreator[type](this,lightPrimitive);this.update(this.plug,lightPrimitive);if(this.light.target){this.light.target.userData.targetInverse=this.light}this.node.helper=this.helper;this.light.helper=this.helper;this.node.removeDefaultLight();this.node.setObject(this.light);this.helper.isHelper=true;this.helper.position=new THREE.Vector3;this.helper.remove(this.helper.lightDistance);if(this.helper.lightArrow){this.helper.lightArrow.cone.scale.multiplyScalar(.4)}this.helper.each(function(node){node.isHelper=true});if(this.helper.lightCone)this.helper.lightCone.unselectable=true;this.light.add(this.helper)},update:function(plug,lightPrimitive){if(!(this.light instanceof THREE[lightPrimitive.getType()])){this.createLight(lightPrimitive);this.node.createBoundingBox=this.createBoundingBox.bind(this);this.node.createBoundingBox()}if(this.light){this.light.dataUpdate(lightPrimitive);this.helper.update();this.node.scene.threeScene.updateMaterials()}},defaultScale:.5,adjustForDisplay:function(viewport,camera){if(this.helper){if(this.helper.lightSphere){this.node.adjustHelperForDisplay(viewport,camera,this.helper.lightSphere,this.defaultScale)}}}})}();!function(){var textures={},previewTextures={};var materialPreviewScene,sphereObject;var whiteColor=(new THREE.Color).setRGB(1,1,1);var blackColor=(new THREE.Color).setRGB(0,0,0);exo.translators.three.plugs.Material=exo.translators.Plug.extend({initialize:function(){this.loadingTexture=this.getTexture(this.loadingTextureFile);this.node.getColor=this.getDisplayColor.bind(this);this.needsUpdate=true},getDisplayColor:function(){return this.plug.primitive.defaultColor||this.plug.operators.first().get("defaultColor")},update:function(plug,materialPrimitive){var mesh=this.node.mesh;var wireframe=this.node.wireframe;if(!materialPrimitive)return;if(wireframe){wireframe.material=new THREE.MeshBasicMaterial({color:materialPrimitive.defaultColor,wireframe:true})}if(mesh){this.updateMeshMaterial(mesh,materialPrimitive)}},updateMeshMaterial:function(mesh,materialPrimitive,isSkybox){var materials=materialPrimitive.getMaterial();var material=this.getThreeMaterial(materials,isSkybox);if(material){mesh.material=material;if(this.needsUpdate){this.updateMaterial(material,mesh.geometry)}}},updateMaterial:function(material,geometry){material.needsUpdate=true;geometry.buffersNeedUpdate=true;geometry.uvsNeedUpdate=true;geometry.colorsNeedUpdate=true;this.needsUpdate=false},parseCommonMaterialValues:function(result,isPreview){var values={};var polyMesh=this.node.polyMesh;if(result.side!==undefined){values.side=result.side?THREE.DoubleSide:THREE.FrontSide}else{values.side=THREE.FrontSide}values.color=result.diffuseColor;values.ambient=result.ambientColor;values.reflectivity=result.reflection!==undefined?result.reflection:0;values.refractionRatio=result.refraction!==undefined?result.refraction:0;if(result.emissiveColor){values.emissive=result.emissiveColor}if(result.vertexColors){if(polyMesh&&!polyMesh.hasColorMap()){polyMesh.setDefaultColorMap()}values.vertexColors=THREE.VertexColors}else{values.vertexColors=THREE.NoColors}if(result.diffuseMap){var texture=this.getTexture(result.diffuseMap);values.transparent=!!texture.transparent;values.map=texture.loaded?texture:this.loadingTexture;if(result.enbaleDiffuseFactor){values.color=result.diffuseFactor===undefined?result.diffuseColor:this.adjustColorByFactor(result.diffuseColor,result.diffuseFactor)}else{values.color=whiteColor}}if(result.opacityFactor!==undefined){values.transparent=result.opacityFactor<1?true:false;if(values.map&&values.map.transparent){values.transparent=values.map.transparent}values.opacity=result.opacityFactor}if(result.cubeMap){var texture;var cubeMapMaterial=result.cubeMap.material.getMaterial();if(cubeMapMaterial.type==="CubeMap"){if(cubeMapMaterial.material.cubeMap){}else if(cubeMapMaterial.material.maps){texture=this.getTextureCube(cubeMapMaterial.material.maps)}}values.envMap=texture?texture:null}var blend=result.blendCubeMap;if(blend&&blend!=="Normal"){if(blend==="Multiply"){values.combine=THREE.MultiplyOperation}else if(blend==="Mix"){values.combine=THREE.MixOperation}else if(blend==="Add"){values.combine=THREE.AddOperation}}return values},parseLambertMaterialValues:function(result,isPreview,values){},parsePhongMaterialValues:function(result,isPreview,values){if(result.specularColor){values.specular=result.specularColor}if(result.normalMap&&!result.cubeMap&&!result.bumpMap){var texture=this.getTexture(result.normalMap);values.normalMap=texture.loaded?texture:null}if(result.bumpMap){var texture=this.getTexture(result.bumpMap);values.bumpMap=texture.loaded?texture:null;values.bumpScale=result.bumpFactor}if(result.specularMap){var texture=this.getTexture(result.specularMap);values.specularMap=texture.loaded?texture:null;values.specular=this.adjustColorByFactor(result.specularColor,result.specularFactor)}values.shininess=result.glossiness!==undefined?result.glossiness:50;var normalFactor=result.normalFactor!==undefined?result.normalFactor:1;values.normalScale=new THREE.Vector2(normalFactor,normalFactor)},adjustColorByFactor:function(colorInput,factor){var colorOutput=colorInput.clone();var factorInv=1-factor;colorOutput.r=(1-colorInput.r)*factorInv+colorInput.r;colorOutput.g=(1-colorInput.g)*factorInv+colorInput.g;colorOutput.b=(1-colorInput.b)*factorInv+colorInput.b;return colorOutput},getThreeMaterial:function(materials,isSkybox){var material;if(!materials){return null}if(materials.type==="MultiID"){material=this.getMeshFaceMaterial(materials.material,false)}else if(materials.type==="Standard"||materials.type==="Default"){material=this.getStandardMaterial(materials.material,false)}else if(materials.type==="CubeMap"){material=this.getCubeMapMaterial(materials.material,isSkybox,false)}this.needsUpdate=true;return material},getCubeMapMaterial:function(material,isSkybox,isPreview){if(material.maps){var texture=this.getTextureCube(material.maps);if(isSkybox){var shader=THREE.ShaderLib["cube"];shader.uniforms["tCube"].value=texture;return new THREE.ShaderMaterial({fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:shader.uniforms,depthWrite:false,side:THREE.BackSide})}else{return new THREE.MeshPhongMaterial({color:16777215,envMap:texture})}}else{return new THREE.MeshLambertMaterial({color:16777215})}},getMeshFaceMaterial:function(multiMaterials,isPreview){var materials=[];if(!multiMaterials){return null}_.each(multiMaterials,function(materialInfo,materialID){materials[materialID]=this.getThreeMaterial(materialInfo)},this);return new THREE.MeshFaceMaterial(materials)},getStandardMaterial:function(material,isPreview){material.needsUpdate=true;var values=this.parseCommonMaterialValues(material,isPreview);if(material.materialType==="Lambert"){this.parseLambertMaterialValues(material,isPreview,values);return new THREE.MeshLambertMaterial(values)}else{this.parsePhongMaterialValues(material,isPreview,values);return new THREE.MeshPhongMaterial(values)}},getTexture:function(file){var uri=file.getDataURL();if(!uri&&this.loadingTexture){return this.loadingTexture}var threeTexture=textures[uri];var img=threeTexture?threeTexture.image:null;var type=file.imageType();if(threeTexture&&threeTexture.loaded){return threeTexture}else if(!threeTexture){img=new Image;img.crossOrigin="";img.src=uri;threeTexture=new THREE.Texture;threeTexture.image=img;threeTexture.transparent=type==="gif"||type==="png"}img.addEventListener("load",_.bind(function(){this.onTextureLoaded(threeTexture,img,file)},this),false);threeTexture.wrapS=threeTexture.wrapT=THREE.RepeatWrapping;threeTexture.anisotropy=16;textures[uri]=threeTexture;return threeTexture},onTextureLoaded:function(threeTexture,image,file){threeTexture.loaded=true;threeTexture.image=image;threeTexture.needsUpdate=true;if(file){threeTexture.sourceFile=file.get("name")}this.needsUpdate=true;this.plug.version++;this.triggerDirty();this.node.scene.render()},getTextureCube:function(files){var urls=[];var images=[];var imagesLoaded=0;var translator=this;var key="";for(var i=0,il=files.length;i<il;++i){urls[i]=files[i].getDataURL();key+=urls[i];if(i!==files.length-1){key+="-"}}var threeTexture=textures[key];if(threeTexture&&threeTexture.loaded){return threeTexture}else if(!threeTexture){_.each(urls,function(uri,index){var img=new Image;img.crossOrigin="";img.src=uri;images[index]=img;threeTexture=new THREE.Texture;threeTexture.image=images;img.addEventListener("load",function(){++imagesLoaded;if(imagesLoaded===urls.length){translator.onTextureLoaded(threeTexture,images)}},false)},this)}threeTexture.wrapS=threeTexture.wrapT=THREE.RepeatWrapping;threeTexture.anisotropy=16;threeTexture.flipY=false;textures[key]=threeTexture;return threeTexture},renderPreview:function(renderer,material,x,y,width,height){var threeMaterial=this.getStandardMaterial(material,true);threeMaterial.vertexColors=THREE.NoColors;var gl=renderer.context;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.viewport(x,y,width,height);threeMaterial.opacity=1;if(!materialPreviewScene){createPreviewScene()}if(this.needsUpdate){this.updateMaterial(material,sphereObject.obj.geometry)}sphereObject.obj.material=threeMaterial;materialPreviewScene.camera.setViewOffset(width,height,0,0,width,height);renderer.render(materialPreviewScene,materialPreviewScene.camera)},loadingTextureFile:new exo.sceneGraph.File({assetURL:"/img/textures/checkerboard.png",type:"image/png"})});var createPreviewScene=function(){materialPreviewScene=new THREE.Scene;materialPreviewScene.camera=new THREE.PerspectiveCamera(45,1,.1,1e3);materialPreviewScene.camera.position.set(0,0,3);var light=new THREE.DirectionalLight(16777215);light.position.set(1,1,1);materialPreviewScene.add(light);sphereObject=exo.translators.three.generators.generatePrimitive({type:"sphere"});materialPreviewScene.add(sphereObject)};exo.translators.three.plugs.Material.clearCache=function(){textures={};previewTextures={}}}();exo.translators.three.plugs.Null=exo.translators.Plug.extend({initialize:function(){this.mesh=exo.translators.three.generators.generatePrimitive({name:"NullMesh",type:"box",rotation:[0,0,0],scale:[1,1,1],clearDepth:false,wireframe:true,wireMaterial:{color:[1,1,0],shininess:0,ambient:[.5,.5,.5]}});this.node.getBoundingBox=this.getBoundingBox.bind(this);this.node.object3D.add(this.mesh);this.node.setObject(this.node.object3D)},getBoundingBox:function(){if(!this.mesh)return null;this.mesh.geometry.computeBoundingBox();var bb=this.mesh.geometry.boundingBox;bb.min.multiply(this.mesh.scale);bb.max.multiply(this.mesh.scale);return bb},update:function(plug,result){var size=result.size||1;var color=result.color||(new THREE.Color).setRGB(255,255,0);this.mesh.isHelper=true;this.mesh.scale.set(size,size,size);this.mesh.material.color=color;this.node.createBoundingBox()}});exo.translators.three.plugs.PolyMesh=exo.translators.Plug.extend({createMeshes:function(meshes){var meshMaterial=this.node.mesh?this.node.mesh.material:null;var wireMaterial=this.node.wireframe?this.node.wireframe.material:null;var visibilityMesh=this.node.mesh&&this.node.mesh.visible!==undefined?this.node.mesh.visible:true;var visibilityWireframe=this.node.wireframe&&this.node.wireframe.visible!==undefined?this.node.wireframe.visible:true;this.node.object3D.remove(this.node.meshes);this.node.meshes=meshes;this.node.mesh=this.node.meshes.children[0];this.node.wireframe=this.node.meshes.children[1];this.node.object3D.add(this.node.meshes);this.node.object3D.castShadow=this.node.castShadow;this.node.object3D.receiveShadow=this.node.receiveShadow;this.node.mesh.castShadow=this.node.castShadow;this.node.mesh.receiveShadow=this.node.receiveShadow;if(meshMaterial){this.node.mesh.material=meshMaterial}if(wireMaterial){this.node.wireframe.material=wireMaterial}this.node.mesh.visible=this.node.mesh.forceVisible=visibilityMesh;this.node.wireframe.visible=this.node.wireframe.forceVisible=visibilityWireframe;this.node.setObject(this.node.object3D)},update:function(plug,result){var polyMesh=result;if(!polyMesh)return;var changed=result.changed;if(changed.positions&&this.node.isFlipped){this.node.doFlip=2}switch(this.node.doFlip){case 2:polyMesh.flipFaces(true);case 1:this.node.doFlip=0;changed.positions=true;changed.uvs=true;changed.normals=true;changed.faces=true;break}var hasMesh=_.size(polyMesh)&&polyMesh.positions.length>0;var geometry,wireframeGeometry;if(hasMesh){if(this.node.meshes&&this.node.meshes.children.length>1){if(changed.faces||changed.normals||changed.uvs||changed.positions){this.createMeshes(exo.translators.three.generators.buildMesh(polyMesh))}else{geometry=this.node.mesh.geometry;if(changed.positions){wireframeGeometry=this.node.wireframe.geometry;var newWireframe=exo.translators.three.generators.buildWireframe(polyMesh);wireframeGeometry.vertices=newWireframe.geometry.vertices.slice(0);geometry.vertices=polyMesh.positions.slice(0);geometry.verticesNeedUpdate=true;wireframeGeometry.verticesNeedUpdate=true}if(changed.uvs){if(result.uvMaps){geometry.faceVertexUvs=exo.geometry.convertToThreeUVs(result.uvMaps)}geometry.uvsNeedUpdate=true}if(changed.normals){if(result.normalMap){exo.geometry.convertToThreeNormals(result.normalMap,geometry.vertices,geometry.faces)}geometry.normalsNeedUpdate=true}var colorMap=polyMesh.colorMaps?polyMesh.colorMaps[exo.geometry.PolyMesh.DEFAULT_MAP]:null;if(colorMap){exo.geometry.convertToThreeColors(colorMap,geometry.faces);geometry.colors=colorMap.values}if(changed.colors)geometry.colorsNeedUpdate=true}}else{this.createMeshes(exo.translators.three.generators.buildMesh(polyMesh))}}else{this.createMeshes(this.node.defaultMesh())}this.node.createSubObjects();this.node.createBoundingBox();result.clearChanged()}});exo.translators.three.plugs.Properties=exo.translators.Plug.extend({update:function(plug,result){var owner=plug.node();if(this.visible!==result.visible){this.node.object3D.each(function(obj){if(!obj.owner||obj.owner.node===owner){obj.visible=obj.forceVisible=result.visible}});this.visible=this.node.visible=result.visible}if(result.castShadow!==undefined){this.node.castShadow=result.castShadow;this.node.object3D.each(function(obj){obj.castShadow=result.castShadow})}if(result.receiveShadow!==undefined){this.node.receiveShadow=result.receiveShadow;this.node.object3D.each(function(obj){obj.receiveShadow=result.receiveShadow})}}});exo.translators.three.plugs.Transform=exo.translators.Plug.extend({update:function(plug,transform){var node=this.node;var object3D=node.object3D;transform.getTranslation(object3D.position);transform.getRotationQuaternion(object3D.quaternion);object3D.useQuaternion=true;if(node.type!=="Camera"){transform.getScale(object3D.scale)}object3D.updateMatrixWorld();if(node.type==="PolyMesh"){if(node.isFlipped===undefined){node.isFlipped=false;node.doFlip=0}if(node.isFlipped!==transform.needsFlip()){node.isFlipped=!node.isFlipped;node.doFlip=node.isFlipped?2:1;var polyMesh=node.plugs.PolyMesh;polyMesh.setDirty();polyMesh.doUpdate();_.each(node.children,function(child){var transform=child.plugs.Transform;transform.setDirty();transform.doUpdate()})}}var subObjects=node.subObjects;if(subObjects){subObjects.position.copy(object3D.position);subObjects.quaternion.copy(object3D.quaternion);subObjects.useQuaternion=object3D.useQuaternion;subObjects.scale.copy(object3D.scale)}node.each(function(node){if(node.helper){node.helper.update()}})}});!function(){var materials;var none=function(){};exo.translators.three.SceneConverter={convert:function(obj,parent,ctx,callback){var converter=this;this.onCompleted=callback||none;this.ctx=ctx||(parent?parent.scene().getCtx():null);this.added=0;this.toAdd=0;obj.each(function(object3D){if(converter.isSupported(object3D))converter.toAdd++});this.convertObject(obj,parent)},isSupported:function(obj){return!obj.isScene&&obj instanceof THREE.Object3D},convertObject:function(obj,parent){if(obj instanceof THREE.Scene||obj.isScene){this.convertScene(obj,parent,none)}else if(obj instanceof THREE.Mesh||obj.geometry){this.convertMesh(obj,parent,this.onNodeAdded.bind(this))}else if(obj instanceof THREE.Geometry){this.convertGeometry(obj,parent,this.onNodeAdded.bind(this))}else if(obj instanceof THREE.Light){this.convertLight(obj,parent,this.onNodeAdded.bind(this))}else if(obj instanceof THREE.Camera){this.convertCamera(obj,parent,this.onNodeAdded.bind(this))}else if(obj instanceof THREE.Object3D){this.convertObject3D(obj,parent,this.onNodeAdded.bind(this))}},onNodeAdded:function(node){this.added++;if(this.toAdd&&this.added===this.toAdd){this.onCompleted(this.sceneModel)}},convertScene:function(scene,parent,callback){var model=parent||new exo.sceneGraph.Scene;materials={};_.each(scene.children,function(child){this.convertObject(child,model.objectsRootNode)},this);this.sceneModel=model;callback.call(this,model)},convertObject3D:function(obj,parent,callback){var type=this.findObject3DType(obj);var rotation=obj.useQuaternion?(new THREE.Vector3).setEulerFromQuaternion(obj.quaternion,"ZYX"):obj.rotation;var modelDefinition={};var converter=this;modelDefinition[type]={};this.ctx(parent).addNode(obj.name||"Node",type,modelDefinition).then(function(model){var transformOperator=converter.ctx(model.plugs.Transform.operators.first());if(transformOperator){if(obj.position)transformOperator.set({translation:obj.position});if(rotation)transformOperator.set({rotation:rotation.multiplyScalar(180/Math.PI)});if(obj.scale)transformOperator.set({scale:obj.scale})}callback.call(converter,model);
_.each(obj.children,function(child){converter.convertObject(child,model)},converter)})},findObject3DType:function(obj){var type="Null";if(obj instanceof THREE.Mesh||obj.geometry){type="PolyMesh"}else if(obj instanceof THREE.Light){type="Light"}else if(obj instanceof THREE.Camera){type="Camera"}return type},convertMesh:function(mesh,parent,callback){this.convertObject3D(mesh,parent,function(model){var material=mesh.material;this.convertGeometry(mesh.geometry,model,material);callback.call(this,model)})},convertLight:function(light,parent,callback){var ctx=this.ctx;var converter=this;this.convertObject3D(light,parent,function(model){var lightPlug=this.ctx(model.plugs.Light);var onOperatorAdded=function(op){if(op.length)op=op.first();ctx(op).set({intensity:light.intensity,color:light.color,distance:light.distance});callback.call(converter,model)};if(light instanceof THREE.PointLight){lightPlug.addOperator("PointLight").then(onOperatorAdded)}else if(light instanceof THREE.DirectionalLight){lightPlug.addOperator("DirectionalLight").then(onOperatorAdded)}else if(light instanceof THREE.SpotLight){lightPlug.addOperator("SpotLight").then(onOperatorAdded)}})},convertCamera:function(camera,parent,callback){var ctx=this.ctx;var converter=this;this.convertObject3D(camera,parent,function(model){ctx(model.plugs.Camera).addOperator("Camera").then(function(op){callback.call(converter,model)})})},convertGeometry:function(geometry,parent,material){var polyMesh=exo.geometry.GeometryToPolyMesh.convert(geometry);if(material){if(material instanceof THREE.MeshFaceMaterial){var materialIds=[];var previousIndex=0;_.each(geometry.faces,function(face,index){if(face.materialIndex<10){materialIds[index]=previousIndex=face.materialIndex}else{materialIds[index]=previousIndex}},this);polyMesh.materialIds=materialIds;this.convertMultiMaterial(material,parent,none)}else{this.convertMaterial(material,parent,none)}}var blob=new exo.sceneGraph.File({name:parent.get("name")+".json",content:polyMesh,type:"application/json",sourceType:"import",internal:true});parent.scene().files.add(blob);this.ctx(parent.plugs.PolyMesh).addOperator("Mesh",{geometry:blob});if(geometry.material&&geometry.material.name){this.convertMaterial(geometry.material,parent,none)}},convertMultiMaterial:function(material,parent,callback){if(material.id&&materials[material.id]){var materialModel=materials[material.id];this.ctx(parent).find("#Material[reference]").set({reference:materialModel.id})}else{var scene=parent instanceof exo.sceneGraph.Scene?parent:parent.scene();var converter=this;var ctx=this.ctx;ctx("%MaterialLibrary").addNode(material.name,"Material",{Material:{}}).then(function(materialModel){ctx(materialModel.plugs.Material).addOperator("MultiID",{}).then(function(multiID){var val={};var length=material.materials.length>10?10:material.materials.length;_.each(material.materials,function(mat,id){if(id<length){converter.createMaterial(mat,parent,function(matModel){val["material"+id]=matModel.id;if(id>=length-1){ctx(multiID).set(val);material.id=materialModel.id;materials[material.id]=materialModel;this.ctx(parent).find("#Material[reference]").set({reference:materialModel.id});callback.call(converter,materialModel)}})}})})})}},convertMaterial:function(material,parent,callback){this.createMaterial(material,parent,function(materialModel){this.ctx(parent).find("#Material[reference]").set({reference:materialModel.id});callback.call(this,materialModel)})},createMaterial:function(material,parent,callback){materials=materials||{};if(material.id&&materials[material.id]){var materialModel=materials[material.id];callback.call(this,materialModel)}else{var scene=parent instanceof exo.sceneGraph.Scene?parent:parent.scene();var converter=this;var ctx=this.ctx;ctx("%MaterialLibrary").addNode(material.name||"Material","Material",{Material:{}}).then(function(materialModel){var materialPlug=ctx(materialModel.plugs.Material);materialPlug.addOperator("Standard",{materialType:findMaterialType(material),diffuseColor:material.color||16777215,ambientColor:material.ambient||16777215,specularColor:material.specular||16777215,diffuseMap:findTextureNode(scene,material,"diffuse"),specularMap:findTextureNode(scene,material,"specular")});material.id=materialModel.id;materials[material.id]=materialModel;callback.call(converter,materialModel)})}}};var findMaterialType=function(material){if(material instanceof THREE.MeshPhongMaterial){return"Phong"}else if(material instanceof THREE.MeshLambertMaterial){return"Lambert"}};var findFileName=function(url){var lastIndex=url.lastIndexOf("/");return lastIndex!==-1?url.substr(lastIndex+1):url};var findTextureNode=function(scene,threeMat,type){var mapType=type==="diffuse"?"map":type+"Map";var fileName=threeMat[type+"TextureFile"]||(threeMat[mapType]&&threeMat[mapType].image?threeMat[mapType].image.src:"");if(!fileName&&threeMat[mapType]){fileName=threeMat[mapType].sourceFile}fileName=findFileName(fileName);return scene.files.find(function(n){return n.isAsset()&&n.isImage()&&n.get("name")===fileName})}}();!function(){exo.translators.vray.Node=exo.translators.Node.extend({initialize:function(options){this.create(options);this.type=this.model.get("type")},create:function(options){this.visible=false;this.subObjectType="Object";this.plugs={}},setObject:function(obj){},destructor:function(){var ref=this.scene.vrReferences;if(ref)ref.removeReference(this.model)},updateChildren:function(addedChildren,removedChildren){_.each(removedChildren,function(child){child.destructor()},this)},eachObject:function(threeObj,iterator,context){}})}();!function(){exo.translators.vray.Scene=exo.translators.Scene.extend({initialize:function(options){this.registry=new exo.translators.Registry({Scene:exo.translators.vray.Scene,Node:exo.translators.vray.Node,Objects:exo.translators.vray.Node,MaterialLibrary:exo.translators.vray.Node,Textures:exo.translators.vray.Node,PolyMesh:exo.translators.vray.nodes.PolyMesh,Light:exo.translators.vray.nodes.Light,Camera:exo.translators.vray.nodes.Camera,Material:exo.translators.vray.nodes.Material,Texture:exo.translators.vray.nodes.Texture,Renderers:exo.translators.vray.Node,Renderer:exo.translators.vray.nodes.Renderer,Passes:exo.translators.vray.Node,Pass:exo.translators.vray.nodes.Pass});this.pass=options.thisPass;var sceneProp=options.sceneProp?options.sceneProp:{res_w:1280,res_h:720};var vsettings=this.vraySettings=options.vraySettings||{};var renderMode=vsettings.renderMode||"production";this.renderer=new require("vray").VRayRenderer({renderMode:renderMode,numThreads:2,showFrameBuffer:false,imageWidth:sceneProp.res_w,imageHeight:sceneProp.res_h,autoCommit:true});{var out=this.renderer.classes.SettingsOutput();out.img_width=sceneProp.res_w;out.img_height=sceneProp.res_h;out.rgn_width=sceneProp.res_w;out.rgn_height=sceneProp.res_h;out.bmp_width=sceneProp.res_w;out.bmp_height=sceneProp.res_h;out.r_width=sceneProp.res_w;out.r_height=sceneProp.res_h}this.vrReferences=new exo.translators.vray.factory.handler(this);this.update()},initEvents:function(editor){this.bindTo(editor.scene,"dirty",function(){this.trigger("dirty",this)},this);this.bindTo(editor.scene,"immediateUpdate",function(){this.updateNextFrame()},this);this.bindTo(this,"dirty",defer(0,this.update,this));this.bindTo(editor,"change:activeManipulator",this.triggerDirty,this)},updateChildren:exo.translators.vray.Node.prototype.updateChildren,updateProperties:exo.translators.vray.Node.prototype.updateProperties,renderImage:function(app,deferred,filename){var fs=require("fs");var path=require("path");filename=filename||"default.";var r=this.renderer;r.render();r.waitForImageReady(function(){app.resultsDir(function(err,resultsDir){if(err)throw Error(err);var outFile=path.join(resultsDir,filename)+"jpg";r.getImage().save(outFile,function(err){r.close();if(err)throw Error(err);fs.readFile(outFile,function(err,buffer){if(err)throw new Error(err);var content="data:image/jpg;base64,"+buffer.toString("base64");var file=new exo.sceneGraph.File({name:filename+"jpg",type:"image/jpg",sourceType:"export",content:content});app.scene.files.add(file);deferred.resolve(file)})})})})},exportVrScene:function(app,deferred,filename){var fs=require("fs");var path=require("path");var r=this.renderer;app.resultsDir(function(err,resultsDir){if(err)throw Error(err);filename=(filename||"default")+".vrscene";var fullOutFilename=path.join(resultsDir,filename);var settings={compressed:true,useHexFormat:true};r.export(fullOutFilename,settings,function(err){r.close();if(err)throw new Error(err);fs.readFile(fullOutFilename,"utf8",function(err,buffer){if(err)throw new Error(err);var file=new exo.sceneGraph.File({name:filename,type:"text/plain",sourceType:"export",content:buffer});app.scene.files.add(file);deferred.resolve(file)})})})},liveFeed:function(app,deferred,filename){},update:function(){var count=exo.translators.Scene.prototype.update.call(this);return count}})}();!function(){var vray;exo.translators.vray.Xform=function(xformRef){this.xform=xformRef};exo.translators.vray.Xform.prototype={updateTransform:function(transform){if(highbrow.browser||this.xform===undefined)return;vray=vray||require("vray");var elem=transform.getWorldTransform().elements;var offset=vray.Vector(elem[12],elem[13],elem[14]);var mat=vray.Matrix(vray.Vector(elem[0],elem[1],elem[2]),vray.Vector(elem[4],elem[5],elem[6]),vray.Vector(elem[8],elem[9],elem[10]));this.xform.transform=vray.Transform(mat,offset)}}}();!function(){exo.translators.vray.nodes.CameraMap={map:{},insert:function(node,vrayNode){this.map[node.attributes._id]=vrayNode},remove:function(node){delete this.map[node.attributes._id]},detach:function(node){this.map[node.attributes._id].detach()},attach:function(node){this.map[node.attributes._id].attach()}};exo.translators.vray.nodes.Camera=exo.translators.vray.Node.extend({type:"Camera",initialize:function(options){this.create(options);exo.translators.vray.nodes.CameraMap.insert(this.model,this);this.plugs={Camera:new exo.translators.vray.plugs.Camera(this.model.Camera,this),Transform:new exo.translators.vray.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.vray.plugs.Properties(this.model.Properties,this)}},detach:function(){_.each(this.plugs,function(plug){plug.setVrayObject(null)},this)},attach:function(){var vrayRenderView=this.scene.vrReferences.getReferenceFromId("renderView","Camera");_.each(this.plugs,function(plug){plug.setVrayObject(vrayRenderView);plug.setDirty();plug.doUpdate()},this)},destructor:function(){exo.translators.vray.nodes.CameraMap.remove(this.model);var ref=this.scene.vrReferences;if(ref)ref.removeReference(this.model)}})}();!function(){exo.translators.vray.nodes.Light=exo.translators.vray.Node.extend({type:"Light",initialize:function(options){this.create(options);var vrayLight=this.scene.vrReferences.getReference(this.model);vrayLight.noFallOff=this.scene.vraySettings.nfe;this.plugs={Light:new exo.translators.vray.plugs.Light(this.model.Light,this),Transform:new exo.translators.vray.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.vray.plugs.Properties(this.model.Properties,this)};_.each(this.plugs,function(plug){plug.setVrayObject(vrayLight)},this)}})}();!function(){exo.translators.vray.nodes.Material=exo.translators.vray.Node.extend({type:"Material",initialize:function(options){this.create(options);console.log("--- Material");this.plugs={}},destructor:function(){}})}();!function(){exo.translators.vray.nodes.Pass=exo.translators.vray.Node.extend({type:"Pass",initialize:function(options){this.create(options);var c_id=this.scene.pass;if(c_id&&this.model.Pass.attributes._id!==c_id.Pass.attributes._id){return}this.plugs={Pass:new exo.translators.vray.plugs.Pass(this.model.Pass,this)}}})}();!function(){exo.translators.vray.nodes.PolyMesh=exo.translators.vray.Node.extend({type:"PolyMesh",initialize:function(options){this.create(options);var vrayPolyMesh=this.scene.vrReferences.getReference(this.model);this.plugs={PolyMesh:new exo.translators.vray.plugs.PolyMesh(this.model.PolyMesh,this),Transform:new exo.translators.vray.plugs.Transform(this.model.Transform,this),Properties:new exo.translators.vray.plugs.Properties(this.model.Properties,this),Material:new exo.translators.vray.plugs.Material(this.model.Material,this)};_.each(this.plugs,function(plug){plug.setVrayObject(vrayPolyMesh)},this)}})}();!function(){exo.translators.vray.nodes.Renderer=exo.translators.vray.Node.extend({type:"Renderer",initialize:function(options){this.create(options);var c_id=this.scene.pass;if(c_id&&this.model.attributes._id!==c_id.Pass._result.render_red.attributes._id){return}var vraySettings=this.scene.vrReferences.getReferenceFromId("settings","Renderer");this.plugs={Renderer:new exo.translators.vray.plugs.Renderer(this.model.Renderer,this)};this.plugs.Renderer.setVrayObject(vraySettings)}})}();!function(){exo.translators.vray.nodes.Texture=exo.translators.vray.Node.extend({type:"Texture",initialize:function(options){this.create(options);console.log("--- Texture");this.plugs={}},destructor:function(){}})}();exo.translators.vray.plugs.Camera=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,camera){if(this.vrayObject)this.vrayObject.updateCamera(camera)}});!function(){exo.translators.vray.plugs.Light=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,lightPrimitive){this.vrayObject.updateLight(lightPrimitive)}})}();!function(){exo.translators.vray.plugs.Material=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,materialPrimitive){this.vrayObject.updateMaterial(materialPrimitive)}})}();!function(){exo.translators.vray.plugs.MaterialDefinition=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,materialPrimitive){}})}();!function(){var CameraMap=null;exo.translators.vray.plugs.Pass=exo.translators.Plug.extend({initialize:function(){if(!CameraMap)CameraMap=exo.translators.vray.nodes.CameraMap;this.curCam=null},update:function(plug,pass){if(this.curCam!==pass.render_cam){if(this.curCam){CameraMap.detach(this.curCam)}this.curCam=pass.render_cam;CameraMap.attach(this.curCam)}}})}();exo.translators.vray.plugs.PolyMesh=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,result){this.vrayObject.updateMesh(result)}});exo.translators.vray.plugs.Properties=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,result){}});exo.translators.vray.plugs.Renderer=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,renderer){if(this.vrayObject)this.vrayObject.updateRenderer(renderer)}});!function(){exo.translators.vray.plugs.Texture=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,texturePrimitive){}})}();exo.translators.vray.plugs.Transform=exo.translators.Plug.extend({initialize:function(){this.vrayObject=null},setVrayObject:function(obj){this.vrayObject=obj},update:function(plug,transform){if(this.vrayObject)this.vrayObject.updateTransform(transform)}});!function(){var vray;exo.translators.vray.factory.Base=function(vrScene,model){if(vrScene)this.vrScene=vrScene;if(model)this.model=model};exo.translators.vray.factory.Base.prototype={destructor:function(){}};exo.translators.vray.factory.Xform=function(vrScene,model,xformRef){exo.translators.vray.factory.Base.call(this,vrScene,model);this.xform=xformRef};var proto=exo.translators.vray.factory.Xform.prototype=Object.create(exo.translators.vray.factory.Base.prototype);proto.setXform=function(xformRef){this.xform=xformRef};proto.updateTransform=function(transform){if(this.xform===undefined)return;if(!vray)vray=require("vray");var elem=transform.getWorldTransform().elements;var offset=vray.Vector(elem[12],elem[13],elem[14]);var mat=vray.Matrix(vray.Vector(elem[0],elem[1],elem[2]),vray.Vector(elem[4],elem[5],elem[6]),vray.Vector(elem[8],elem[9],elem[10]));this.xform.transform=vray.Transform(mat,offset)}}();!function(){var vray;var toVectorList=function(vectors){var list=vray.VectorList();var i=list.length=vectors.length;do{--i;var v=vectors[i];var zz=v.z;list[i]=vray.Vector(v.x,v.y,zz?zz:0)}while(i>0);return list};var toFaceList=function(faces){var flist=vray.IntList();_.each(faces,function(face){var nbTriangles=face.length-2;var first=face[0];var second=face[1];for(var i=1;nbTriangles>0;--nbTriangles){flist.push(first);flist.push(second);second=face[++i];flist.push(second)}});return flist};var initNodeMesh=function(vrScene,model){var cls=vrScene.renderer.classes;this.matRef=cls.MtlDiffuse();var xform=cls.Node();this.xformRef=xform;xform.geometry=this.geomRef;xform.material=this.matRef;xform.nsamples=1;this.lightOn=false;this.destruct=function(r){r.deletePlugin(this.xformRef);r.deletePlugin(this.matRef)};return xform};var initLightMesh=function(vrScene,model){var cls=vrScene.renderer.classes;var light=cls.LightMesh();this.lightRef=light;light.color=vray.Color(1,1,1);light.intensity=1;light.geometry=this.geomRef;light.use_tex=1;this.lightOn=true;this.destruct=function(r){r.deletePlugin(this.lightRef)};return light};exo.translators.vray.factory.PolyMesh=function(vrScene,model){if(!vray)vray=require("vray");this.geomRef=vrScene.renderer.classes.GeomStaticMesh();var xform=initNodeMesh.call(this,vrScene,model);exo.translators.vray.factory.Xform.call(this,vrScene,model,xform)};var proto=exo.translators.vray.factory.PolyMesh.prototype=Object.create(exo.translators.vray.factory.Xform.prototype);proto.updateMesh=function(geometry){if(this.lightOn===(geometry.light===undefined)){var trans=this.xform.transform;this.destruct(this.vrScene.renderer);var xform=(this.lightOn?initNodeMesh:initLightMesh).call(this,this.vrScene,this.model);xform.transform=trans;this.setXform(xform)}var mesh=this.geomRef;mesh.vertices=toVectorList(geometry.positions);mesh.faces=toFaceList(geometry.faces);var normalMap=geometry.normalMap;if(normalMap&&normalMap.values&&normalMap.faces&&normalMap.values.length>0){mesh.normals=toVectorList(normalMap.values);mesh.faceNormals=toFaceList(normalMap.faces)}var uvMap=geometry.uvMaps["default"];if(uvMap&&uvMap.values&&uvMap.faces&&uvMap.values.length>0){var map_list=vray.List();var defUvs=vray.List();var defUvsCoords=toVectorList(uvMap.values);var defUvsFaces=toFaceList(uvMap.faces);defUvs.push(1);defUvs.push(defUvsCoords);defUvs.push(defUvsFaces);map_list.push(defUvs);mesh.map_channels=map_list}if(this.lightOn){var lightRef=this.lightRef;var light=geometry.light;lightRef.intensity_tex=light.intensity;lightRef.noDecay=light.falloffExponent===0}};proto.updateMaterial=function(material){var mnID=material.getMaterialNodeID();if(this.lightOn){var lightRef=this.lightRef;lightRef.color=vray.Color(1,1,1);if(!mnID){var color=material.defaultColor;lightRef.tex=vray.AColor(color.r,color.g,color.b,1)}else{lightRef.tex=vray.AColor(1,1,1,1)}}else{var matRef=this.matRef;matRef.diffuse=vray.Color(1,1,1);if(!mnID){var color=material.defaultColor;matRef.diffuse_tex=vray.AColor(color.r,color.g,color.b,1)}else{matRef.diffuse_tex=vray.AColor(1,1,1,1)}}};proto.destructor=function(){var r=this.vrScene.renderer;this.destruct(r);r.deletePlugin(this.geomRef)}}();!function(){var vray;exo.translators.vray.factory.Camera=function(vrScene,model){this.vrScene=vrScene;this.renderView=vrScene.renderer.classes.RenderView();exo.translators.vray.factory.Xform.call(this,vrScene,model,this.renderView)};var proto=exo.translators.vray.factory.Camera.prototype=Object.create(exo.translators.vray.factory.Xform.prototype);proto.updateCamera=function(camera){var view=this.renderView;if(!view)return;if(camera.fieldOfView!==undefined){view.fov=camera.fieldOfView*(Math.PI/180)}if(camera.nearClip!==undefined&&camera.farClip!==undefined){view.clipping=true;view.clipping_near=camera.nearClip;view.clipping_far=camera.farClip}};proto.destructor=function(){if(this.renderView)this.vrScene.renderer.deletePlugin(this.renderView)}}();!function(){var vray;var LightUpdate={common:function(L,result){L.intensity_tex=result.intensity;var c=result.color;L.color_tex=vray.AColor(c.r,c.g,c.b,1)},PointLight:function(result){var omni=this.vrayLight;omni.decay=this.noFallOff?0:result.falloffExponent;LightUpdate.common(omni,result)},SpotLight:function(result){var spot=this.vrayLight;spot.decay=this.noFallOff?0:result.falloffExponent;LightUpdate.common(spot,result)},DirectionalLight:function(result){LightUpdate.common(this.vrayLight,result)}};var LightCreator={PointLight:function(result){this.vrayLight=this.vrScene.renderer.classes.LightOmni();this.updateVrayLight=LightUpdate.PointLight},SpotLight:function(result){this.vrayLight=this.vrScene.renderer.classes.LightSpot();this.updateVrayLight=LightUpdate.SpotLight},DirectionalLight:function(result){this.vrayLight=this.vrScene.renderer.classes.LightDirect();this.updateVrayLight=LightUpdate.DirectionalLight}};exo.translators.vray.factory.Light=function(vrScene,model){if(!vray)vray=require("vray");this.vrayLight=null;this.noFallOff=false;exo.translators.vray.factory.Base.call(this,vrScene,model)};var proto=exo.translators.vray.factory.Light.prototype=Object.create(exo.translators.vray.factory.Xform.prototype);proto.updateLight=function(light){if(!this.vrayLight){LightCreator[light.lightType].call(this,light);this.vrayLight.color=vray.Color(1,1,1);exo.translators.vray.factory.Xform.call(this,null,null,this.vrayLight)}this.updateVrayLight(light)};proto.destructor=function(){this.vrScene.renderer.deletePlugin(this.vrayLight)}}();!function(){var vray;var IMAP_options={0:{min_rate:-4,max_rate:-3,lookup_mode:1,normal_threshold:.3,color_threshold:.4,distance_threshold:.1,calc_interp_samples:15},1:{min_rate:-3,max_rate:-2,lookup_mode:2,normal_threshold:.3,color_threshold:.4,distance_threshold:.1,calc_interp_samples:15},2:{min_rate:-3,max_rate:-1,lookup_mode:3,normal_threshold:.2,color_threshold:.4,distance_threshold:.1,calc_interp_samples:15},3:{min_rate:-3,max_rate:0,lookup_mode:5,normal_threshold:.1,color_threshold:.3,distance_threshold:.1,calc_interp_samples:10},4:{min_rate:-3,max_rate:1,lookup_mode:7,normal_threshold:.1,color_threshold:.2,distance_threshold:.3,calc_interp_samples:5}};var filterTypes={1:"FilterArea",2:"FilterBox",3:"FilterCatmullRom",4:"FilterCookVariable",5:"FilterGaussian",6:"FilterLanczos",7:"FilterMitNet",8:"FilterSinc",9:"FilterTriangle"};exo.translators.vray.factory.Renderer=function(vrScene,model){if(!vray)vray=require("vray");var cls=vrScene.renderer.classes;this.sGI=cls.SettingsGI();this.sIS=cls.SettingsImageSampler();this.sDMCGI=cls.SettingsDMCGI();this.sIM=cls.SettingsIrradianceMap();this.sEnv=cls.SettingsEnvironment();this.filter=null;this.sDMCGI.subdivs=50;this.sDMCGI.depth=2;this.sIS.subdivision_threshold=.1;this.sIS.subdivision_edges=1;this.sIS.type=2;this.lastFilter=-1;exo.translators.vray.factory.Base.call(this,vrScene,model)};var proto=exo.translators.vray.factory.Renderer.prototype=Object.create(exo.translators.vray.factory.Base.prototype);proto.updateRenderer=function(renderer){var vr=renderer.vraySettings;if(this.lastFilter!=vr.filter){var r=this.vrScene.renderer;if(this.filter){r.deletePlugin(this.filter);this.filter=null}if((this.lastFilter=vr.filter)>0){this.filter=r.classes[filterTypes[vr.filter]]()}}if(this.filter){this.filter.size=vr.filterSize}this.sGI.on=vr.gi?1:0;var c=vr.gi_color;this.sEnv.gi_tex=vray.Color(c.r,c.g,c.b);var imap=IMAP_options[vr.quality];var sIM=this.sIM;for(attr in imap)sIM[attr]=imap[attr]};proto.destructor=function(){var r=this.vrScene.renderer;r.deletePlugin(this.sGI);r.deletePlugin(this.sIS);r.deletePlugin(this.sDMCGI);r.deletePlugin(this.sIM);r.deletePlugin(this.sEnv);if(this.filter)r.deletePlugin(this.filter)}}();!function(){var typeMap={PolyMesh:exo.translators.vray.factory.PolyMesh,Light:exo.translators.vray.factory.Light,Camera:exo.translators.vray.factory.Camera,Material:exo.translators.vray.factory.Material,Texture:exo.translators.vray.factory.Texture,Renderer:exo.translators.vray.factory.Renderer};exo.translators.vray.factory.handler=function(vrScene){this.vrScene=vrScene;this.map={}};var proto=exo.translators.vray.factory.handler.prototype;proto.hasReferenceFromId=function(id){return this.map[id]!==undefined};proto.hasReference=function(model){return this.map[model.attributes._id]!==undefined};proto.getReferenceFromId=function(id,type){var ref=this.map[id];if(!ref){ref=typeMap[type];if(!ref)throw new Error("Unhandle type of node: "+type);ref=new ref(this.vrScene,null);this.map[id]=ref}return ref};proto.getReference=function(model){var id=model.attributes._id;var ref=this.map[id];if(!ref){ref=typeMap[model.get("type")];if(!ref)throw new Error("Unhandle type of node: "+model.get("type"));ref=new ref(this.vrScene,model);this.map[id]=ref}else if(!ref.model){ref.model=model}return ref};proto.removeReferenceFromId=function(id){var map=this.map;if(map[id]){map[id].destructor();delete map[id];return true}return false};proto.removeReference=function(model){var id=model.attributes._id;var map=this.map;if(map[id]){map[id].destructor();delete map[id];return true}return false}}();exo.ui.home.Error=highbrow.extend("ItemView","Error",{});exo.ui.home.Home=highbrow.extend("ItemView","Home",{});exo.ui.home.TopNav=highbrow.extend("ItemView","TopNav",{viewModel:exo.ui.vm.User,initialize:function(){this.store=this.options.store;this.store.on("set:user",function(user){this.model=user;this.rerender()},this);this.store.on("set:editor",function(editor){if(this.scene){this.scene.off("change:name",this.rerender,this)}this.editor=editor;if(editor){this.scene=editor.scene;this.scene.on("change:name",this.rerender,this)}else{this.scene=null}this.rerender()},this);this.model=this.store.user;this.session=new exo.models.Session({_id:"set",user:this.model});this.webSocket=this.store.webSocket},onRender:function(){if(this.menubarView){this.menubarView.close()}if(this.editor){this.menubarView=new exo.ui.views.Menubar({collection:this.editor.commands["menu"],editor:this.editor,el:$(".menubar")});this.menubarView.render()}},onShow:function(){this.webSocket.on("close",function(){this.$(".connected").hide();this.$(".not-connected").show();if(this.webSocket.disconnected){this.$(".not-connected i").removeClass("icon-warning-sign").addClass("icon-exclamation-sign")}else{this.$(".not-connected i").removeClass("icon-exclamation-sign").addClass("icon-warning-sign")}},this);this.webSocket.on("open",function(){this.$(".connected").show();this.$(".not-connected").hide()},this);this.webSocket.on("working",function(){this.$(".connected i").removeClass("icon-signal").addClass("icon-refresh")},this);this.webSocket.on("empty",function(){this.$(".connected i").removeClass("icon-refresh").addClass("icon-signal")},this)},view:function(){return{webSocket:this.webSocket,scene:this.scene?new exo.ui.vm.Scene(this.scene):null,screenfull:screenfull.enabled}},events:{"click .logout":"logout","click .go-offline":"goOffline","click .reconnect":"reconnect","click .fullscreen":"goFullScreen"},logout:function(e){e.preventDefault();var view=this;this.session.destroy({success:function(){view.trigger("logout")}})},goOffline:function(e){e.preventDefault();this.webSocket.disconnect()},reconnect:function(e){e.preventDefault();this.webSocket.connect(1)},goFullScreen:function(e){e.preventDefault();if(screenfull.enabled){screenfull.request()}}});exo.ui.home.Notification=highbrow.extend("ItemView","Notification",{className:"span6 offset3",events:{"click .close":"removeNotification"},removeNotification:function(e){this.options.parent.remove(this)},onShow:function(){var view=this;setTimeout(function(){view.removeNotification()},5e3)}});exo.ui.home.Notifications=highbrow.extend("CollectionView","Notifications",{className:"row",itemView:exo.ui.home.Notification,appendHtml:function(el,html){this.$(".row").append(html)},remove:function(child){this.collection.remove(child.model);this.removeChildView(child)}});exo.ui.home.Loading=highbrow.extend("ItemView","Loading",{initialize:function(){this.message=this.options.message||"Loading";this.render()},view:function(){return{message:this.message}}});!function(){exo.ui.home.route=function(app,$){if(highbrow.browser)notifications(app,$);topNav(app,$);exo.dropHandler=new exo.ui.views.DropHandler({el:$("body")});app.page("/",index);app.browser("/editor/:id",exo.ui.plugins.reset,editor,loading,exo.ui.plugins.load,exo.ui.scenes.load,loadingFinished).unload(exo.ui.scenes.unload,leaveEditor)};var loading=function(ctx,next){ctx.loadingStart=new Date;if(highbrow.browser&&!$("#loading").length){ctx.loadingView=new exo.ui.home.Loading({});$("body").append(ctx.loadingView.el)}next()};var loadingFinished=function(ctx){if(ctx.loadingView)ctx.loadingView.close();this.store.editor.bindHotkeys()};var notifications=function(app,$){var notifications=new exo.ui.home.Notifications({el:$("#notifications"),collection:app.store.notifications});notifications.render();if(highbrow.browser)notifications.onShow()};var topNav=function(app,$){var topnav=new exo.ui.home.TopNav({el:$("#topnav"),store:app.store});topnav.render();if(highbrow.browser)topnav.onShow();topnav.on("logout",function(){app.store.set("user",null);app.show("/")})};var index=function(ctx){if(!this.store.user)return this.show("/login",ctx);return this.show("/scenes",ctx)};var editor=function(ctx,next){ctx.scene=exo.sceneGraph.nodes.Scene.init(this.store.context,{_id:ctx.params.id});this.layout="editor";var studioModel=new exo.loadEditor(ctx.scene);exo.persistEditor(studioModel);ctx.studioEditor=new exo.ui.views.Editor({model:studioModel,el:$("#editor")});ctx.root.store.set("editor",studioModel);var eName=anlysTest?"Test - Open Editor":"Open Editor";var eData=anlysTest?{category:"Test - Editor",label:"Test - Open Editor"}:{category:"Editor",label:"Open Editor"};analytics.track(eName,eData);ctx.root.showView(ctx,ctx.studioEditor,"#editor","#app");next()};var leaveEditor=function(ctx,next){ctx.studioEditor.close();ctx.root.store.set("scene",null);ctx.root.store.set("editor",null);next()}}();exo.ui.views.Property=function($el,key,operator,editor){var node=operator.node&&operator.node()?operator.node():null;var scene=node&&node.scene()?node.scene():null;this.key=key;this.operator=operator;this.schema=_.extend({},operator.schema[key],operator.schema[key].schema);this.schema.prototype=operator.schema[key].prototype;this.attrs={key:key,value:operator.get(key),id:operator.id};this.attrs.label=this.schema.label||key;this.editor=editor;this.ctx=!this.operator.detachable&&scene?scene.getCtx():function(){return operator.ctx?operator.ctx():null};var context=_.extend(this.schema,this.attrs);if(this.view)_.extend(context,this.view(this.attrs,this.schema));this.$el=$(nct.render("editor/properties/"+_.str.underscored(this.schema.type),context));$el.append(this.$el);this.operator.on("change:"+key,this.triggerUpdate,this);this.initialize();this.update(operator,operator.get(key))};exo.ui.views.Property.extend=Backbone.Model.extend;_.extend(exo.ui.views.Property.prototype,{initialize:function(){},close:function(){if(this.onBlur)this.onBlur();this.operator.off("change:"+this.key,this.update,this)},set:function(val){var obj={};obj[this.key]=val;this.ctx(this.operator).set(obj)},triggerUpdate:function(){this.update(this.operator,this.operator.get(this.key))},update:function(op,val){}});exo.ui.views.properties.KeyFramable={initKeyFraming:function(){if(!this.schema.animatable)return;this.$propertyName=this.$el.find(".property-name");this.$propertyName.on("click",this.toggleKeyFrame.bind(this));this.$propertyName.on("contextmenu",this.popupContext.bind(this));
this.operator.on("timeChange",this.triggerDirty,this);this.operator.on("add:keyFrame",this.updateKeyFraming,this);this.operator.on("remove:keyFrame",this.updateKeyFraming,this)},triggerDirty:function(time){this.dirty=true;this.time=time;this.doUpdate(time)},doUpdate:function(){if(!this.dirty)return;if(!this.isUpdating){this.isUpdating=true;setTimeout(this.handleUpdateDirty.bind(this),100)}},handleUpdateDirty:function(){if(!this.dirty)return;this.update(this.operator,this.schema.getAt(this.time));this.dirty=false;this.isUpdating=false},updateKeyFraming:function(){if(!this.schema.animatable)return;_.each(["keyframed-key","keyframed-modified","keyframed-interpolated"],function(cls){this.$propertyName.removeClass(cls)},this);var keyFramed=this.operator.isKeyFramed(this.key);if(keyFramed){this.$propertyName.addClass("keyframed-"+keyFramed.type)}},set:function(val,idx){val=this.toVal(val,idx);var obj={};obj[this.key]=val;this.ctx(this.operator).set(obj)},toVal:function(val,idx){return val},toggleKeyFrame:function(){var keyFramed=this.operator.isKeyFramed(this.key);var ctx=this.ctx(this.operator);var val=ctx.getAt(this.key,this.operator.time);if(keyFramed.key){ctx.removeKeyFrame(this.key,this.operator.time)}else{ctx.setAt(this.key,val,this.operator.time)}},popupContext:function(e){this.contextMenu=exo.ui.views.KeyFramableContext.create({previous:this.contextMenu,editor:this.editor,model:this.operator,propertyView:this,event:e});return false}};exo.ui.views.properties.Number=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{initialize:function(){this.trackChange(this.$el.find("input"));this.initKeyFraming();this.update(this.operator,this.schema.get())},update:function(op,val){this.$el.find("input").val(Math.round(val*1e4)/1e4);this.updateKeyFraming()},trackChange:function($input){var prev_y,propView=this,idx=$input.data("idx");var onMouseDrag=function(e){propView.adjust(prev_y-e.clientY,idx);prev_y=e.clientY};var onMouseUp=function(e){$(window).off("mousemove",onMouseDrag);$(window).off("mouseup",onMouseUp)};$input.on("mousedown",function(e){prev_y=e.clientY;$(window).on("mousemove",onMouseDrag);$(window).on("mouseup",onMouseUp)});$input.on("blur",function(e){propView.set($input.val(),idx)});$input.on("keydown",function(e){if(e.keyCode===13){propView.set($input.val(),idx)}})},adjust:function(delta){var factor=this.schema.step||1;this.set(this.operator.get(this.key)+factor*delta)},toVal:function(val,idx){val=parseFloat(val);return!_.isNaN(val)?val:this.operator.get(this.key)}}));exo.ui.views.properties.Integer=exo.ui.views.properties.Number.extend({toVal:function(val,idx){val=parseInt(val,10);return!_.isNaN(val)?val:this.operator.get(this.key)}});exo.ui.views.properties.Vec3=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{initialize:function(){var trackChange=exo.ui.views.properties.Number.prototype.trackChange;var _this=this;this.$el.find("input").each(function(el){trackChange.call(_this,$(this))});if(this.schema.animatable){this.initKeyFraming();this.$x=this.$el.find("span.x");this.$x.on("click",this.togglePropertyKeyFrame.bind(this));this.$y=this.$el.find("span.y");this.$y.on("click",this.togglePropertyKeyFrame.bind(this));this.$z=this.$el.find("span.z");this.$z.on("click",this.togglePropertyKeyFrame.bind(this))}this.update(this.operator,this.schema.get())},view:function(){var vec3=this.operator.get(this.key);return{array:[{idx:"x",val:vec3.x.toString()},{idx:"y",val:vec3.y.toString()},{idx:"z",val:vec3.z.toString()}]}},adjust:function(delta,idx){var factor=this.schema.step||1;var num=this.operator.get(this.key)[idx];num=parseFloat((num+factor*delta).toFixed(2));num=Math.round(num*1e4)/1e4;this.set(num,idx)},toVal:function(val,idx){var next,cur=this.operator.get(this.key);var num=Number(val);if(_.isNaN(num)){return cur}else{num=Math.round(num*1e4)/1e4;next=[cur.x,cur.y,cur.z];next[{x:0,y:1,z:2}[idx]]=num;return next}},togglePropertyKeyFrame:function(e){var property=$(e.target).text();var kf=this.operator.isKeyFramed(this.key);var val=this.schema.getAt(this.operator.time);if(kf&&kf[property].key){this.schema.removePropertyAt(property,this.operator.time)}else{this.ctx(this.operator).setAt(this.key+"."+property,val[property])}},updateKeyFraming:function(){if(!this.schema.animatable)return;_.each(["key","modified","interpolated","mixed"],function(type){this.$propertyName.removeClass("keyframed-"+type);this.$x.removeClass("keyframed-"+type);this.$y.removeClass("keyframed-"+type);this.$z.removeClass("keyframed-"+type)},this);var kf=this.operator.isKeyFramed(this.key);if(kf){if(kf.isAll("key")){this.$propertyName.addClass("keyframed-key")}else if(kf.isAll("interpolated")){this.$propertyName.addClass("keyframed-interpolated")}else if(kf.isAll("modified")){this.$propertyName.addClass("keyframed-modified")}else{this.$propertyName.addClass("keyframed-mixed")}if(kf.x)this.$x.addClass("keyframed-"+kf.x.type);if(kf.y)this.$y.addClass("keyframed-"+kf.y.type);if(kf.z)this.$z.addClass("keyframed-"+kf.z.type)}},update:function(op,vec3){this.$el.find('input[data-idx="x"]').val(vec3.x);this.$el.find('input[data-idx="y"]').val(vec3.y);this.$el.find('input[data-idx="z"]').val(vec3.z);this.updateKeyFraming()}}));exo.ui.views.properties.Text=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{initialize:function(){var trackChange=exo.ui.views.properties.Number.prototype.trackChange;var propView=this;this.$input=this.$el.find("input");this.initKeyFraming();var updateFromInput=function(){propView.set($(this).val())};this.$input.on("blur",updateFromInput);this.$input.on("keydown",function(e){if(e.keyCode===13)updateFromInput.call(this)});this.update(this.operator,this.schema.get())},update:function(op,val){this.$input.val(val);this.updateKeyFraming()}}));exo.ui.views.properties.TextArea=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{DisplayStyle:{normalStyle:"normalStyle",indexStyle:"indexStyle"},initialize:function(){var propView=this;this.$input=this.$el.find("textarea");this.initKeyFraming();var updateFromInput=function(){propView.set($(this).val())};this.display=this.schema.display||this.DisplayStyle.normalStyle;this.rows=this.schema.rows||2;this.disabled=this.schema.disabled===undefined?false:this.schema.disabled;this.$input.attr("rows",this.rows);this.$input.attr("disabled",this.disabled);this.$input.on("blur",this.updateFromInput.bind(this));this.$input.on("keydown",function(e){propView.keydownUpdate(e,this)});this.update(this.operator,this.schema.get())},updateFromInput:function(){this.set(this.$input.val())},keydownUpdate:function(e){if(this.display===this.DisplayStyle.indexStyle){if(e.keyCode>=64&&e.keyCode<=90){e.preventDefault()}}if(e.keyCode===13){if(this.display===this.DisplayStyle.indexStyle){e.preventDefault()}this.updateFromInput.call(this)}},update:function(op,val){this.$input.val(val);this.updateKeyFraming()}}));exo.ui.views.properties.Boolean=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{initialize:function(){var trackChange=exo.ui.views.properties.Number.prototype.trackChange;this.$input=this.$el.find("input");this.initKeyFraming();var propView=this;this.$input.on("click",function(e){propView.set(propView.attrs.value=!propView.attrs.value)});this.update(this.operator,this.schema.get())},set:function(val){var obj={};obj[this.key]=!!val;this.ctx(this.operator).set(obj)},update:function(op,val){this.$input.prop("checked",!!val);this.updateKeyFraming()}}));!function(){var toString=function(color){if(color.a===1||_.isUndefined(color.a)){var s=color.hex.toString(16);while(s.length<6){s="0"+s}return"#"+s}else{return"rgba("+Math.round(color.r)+","+Math.round(color.g)+","+Math.round(color.b)+","+color.a+")"}};var result,toReturn;exo.ui.views.properties.interpretColor=function(){toReturn=false;var original=arguments.length>1?_.toArray(arguments):arguments[0];_.each(INTERPRETATIONS,function(family){if(family.litmus(original)){_.each(family.conversions,function(conversion,conversionName){result=conversion.read(original);if(toReturn===false&&result!==false){toReturn=result;result.conversionName=conversionName;result.conversion=conversion;return{}}});return{}}});return toReturn};var INTERPRETATIONS=[{litmus:_.isString,conversions:{ONE_CHAR_HEX:{read:function(original){var test=original.match(/^#?([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[1].toString()+test[1].toString()+test[1].toString()+test[1].toString()+test[1].toString(),16)}},write:toString},TWO_CHAR_HEX:{read:function(original){var test=original.match(/^#?([A-F0-9])([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[2].toString()+test[1].toString()+test[2].toString()+test[1].toString()+test[2].toString(),16)}},write:toString},THREE_CHAR_HEX:{read:function(original){var test=original.match(/^#?([A-F0-9])([A-F0-9])([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[1].toString()+test[2].toString()+test[2].toString()+test[3].toString()+test[3].toString(),16)}},write:toString},SIX_CHAR_HEX:{read:function(original){var test=original.match(/^#?([A-F0-9]{6})$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString(),16)}},write:toString},CSS_RGB:{read:function(original){var test=original.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3])}},write:toString},CSS_RGBA:{read:function(original){var test=original.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3]),a:parseFloat(test[4])}},write:toString}}},{litmus:_.isNumber,conversions:{HEX:{read:function(original){return{space:"HEX",hex:original,conversionName:"HEX"}},write:function(color){return color.hex}}}},{litmus:_.isArray,conversions:{RGB_ARRAY:{read:function(original){if(original.length!==3)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2]}},write:function(color){return[color.r,color.g,color.b]}},RGBA_ARRAY:{read:function(original){if(original.length!==4)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2],a:original[3]}},write:function(color){return[color.r,color.g,color.b,color.a]}}}},{litmus:_.isObject,conversions:{RGBA_OBJ:{read:function(original){if(_.isNumber(original.r)&&_.isNumber(original.g)&&_.isNumber(original.b)&&_.isNumber(original.a)){return{space:"RGB",r:original.r,g:original.g,b:original.b,a:original.a}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b,a:color.a}}},RGB_OBJ:{read:function(original){if(_.isNumber(original.r)&&_.isNumber(original.g)&&_.isNumber(original.b)){return{space:"RGB",r:original.r,g:original.g,b:original.b}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b}}},HSVA_OBJ:{read:function(original){if(_.isNumber(original.h)&&_.isNumber(original.s)&&_.isNumber(original.v)&&_.isNumber(original.a)){return{space:"HSV",h:original.h,s:original.s,v:original.v,a:original.a}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v,a:color.a}}},HSV_OBJ:{read:function(original){if(_.isNumber(original.h)&&_.isNumber(original.s)&&_.isNumber(original.v)){return{space:"HSV",h:original.h,s:original.s,v:original.v}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v}}}}}]}();exo.ui.views.properties.Color=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.KeyFramable,{initialize:function(){this.$saturationField=this.$el.find(".saturation-field");this.$fieldKnob=this.$el.find(".field-knob");this.$inputField=this.$el.find("input");this.$selector=this.$el.find(".selector");this.$hueKnob=this.$el.find(".hue-knob");this.$hueField=this.$el.find(".hue-field");this.bindSV();this.bindH();this.openOnClick();this.onBlur();this.initKeyFraming();this.update(this.operator,this.schema.get())},openOnClick:function(){var $selector=this.$selector;var $inputField=this.$inputField;$inputField.click(function(e){var offset=$inputField.offset();if($selector.is(":hidden")){$selector.detach().appendTo(document.body);$selector.css({left:offset.left,top:offset.top});$selector.show()}else{$selector.detach().hide()}})},color:function(){return this.operator.get(this.key)},bindSV:function(){var $satField=this.$saturationField,propView=this;var setSV=function(e){e.preventDefault();var w=$satField.width();var o=$satField.offset();var s=(e.clientX-o.left+document.body.scrollLeft)/w;var v=1-(e.clientY-o.top+document.body.scrollTop)/$satField.height();var hsv=THREE.ColorConverter.toHSV(propView.color());if(s>=0&&v>=0){hsv.v=THREE.Math.clamp(v,0,1);hsv.s=THREE.Math.clamp(s,0,1);propView.set(hsv)}};var unbindSV=function(){$(window).off("mousemove",setSV);$(window).off("mouseup",unbindSV)};var fieldDown=function(e){setSV(e);$(window).on("mousemove",setSV);$(window).on("mouseup",unbindSV)};this.$saturationField.on("mousedown",fieldDown);this.$fieldKnob.on("mousedown",fieldDown)},bindH:function(){var propView=this;var setH=function(e){e.preventDefault();var s=propView.$hueField.height();var o=propView.$hueField.offset();var h=1-(e.clientY-o.top+document.body.scrollTop)/s;var curHSV=THREE.ColorConverter.toHSV(propView.color());curHSV.h=h>=1?.9999:h<0?0:h;propView.set(curHSV);return false};var unbindH=function(){$(window).off("mousemove",setH);$(window).off("mouseup",unbindH)};this.$hueField.on("mousedown",function(e){setH(e);$(window).on("mousemove",setH);$(window).on("mouseup",unbindH)})},onRender:function(){this.$selector.detach().hide()},onBlur:function(){var propView=this;var $selector=this.$selector;var updateFromInput=function(i){var i=exo.ui.views.properties.interpretColor(propView.$inputField.val());if(i!==false){var c=new THREE.Color;if(i.space==="HEX"){c.setHex(i.hex)}else if(i.space==="RGB"){c.setRGB(i.r/255,i.g/255,i.b/255)}propView.set(c)}else{propView.$inputField.val("#"+propView.color().getHexString())}$selector.detach().hide()};this.$inputField.on("blur",updateFromInput);this.$inputField.on("keydown",function(e){if(e.keyCode===13)updateFromInput()});$selector.detach().hide()},adjust:function(delta,idx){},toVal:function(val,idx){if(val instanceof THREE.Color)return val;var color=new THREE.Color;THREE.ColorConverter.fromHSV(color,val.h,val.s,val.v);return color},update:function(op,color){color=this.schema.normalize(color);var hsv=THREE.ColorConverter.toHSV(color);var flip=hsv.v<.5||hsv.s>.5?255:0;var _flip=255-flip;this.$el.css("border-left-color",color.getStyle());this.$inputField.val("#"+color.getHexString());this.$inputField.css({"background-color":color.getStyle(),color:"rgb("+flip+","+flip+","+flip+")","text-shadow":"rgba("+_flip+","+_flip+","+_flip+",.7)"});this.$fieldKnob.css({marginLeft:95*hsv.s-7+"px",marginTop:100*(1-hsv.v)-7+"px",backgroundColor:color.getStyle(),border:"2px solid rgb("+flip+","+flip+","+flip+")"});this.$hueKnob.css("margin-top",(1-hsv.h)*100+"px");hsv.s=1;hsv.v=1;var gradient=THREE.ColorConverter.fromHSV(new THREE.Color,hsv.h,hsv.s,hsv.v);this.linearGradient(this.$saturationField[0],"left","#fff",gradient.getStyle());this.updateKeyFraming()},updateKeyFraming:function(){if(!this.schema.animatable)return;_.each(["key","modified","interpolated","mixed"],function(type){this.$propertyName.removeClass("keyframed-"+type)},this);var kf=this.operator.isKeyFramed(this.key);if(kf){if(kf.isAll("key")){this.$propertyName.addClass("keyframed-key")}else if(kf.isAll("interpolated")){this.$propertyName.addClass("keyframed-interpolated")}else if(kf.isAll("modified")){this.$propertyName.addClass("keyframed-modified")}else{this.$propertyName.addClass("keyframed-mixed")}}},linearGradient:function(elem,x,a,b){elem.style.background="";var vendors=["-moz-","-o-","-webkit-","-ms-",""];_.each(vendors,function(vendor){elem.style.cssText+="background: "+vendor+"linear-gradient("+x+", "+a+" 0%, "+b+" 100%); "})}}));exo.ui.views.properties.Options=exo.ui.views.Property.extend({initialize:function(){this.$select=this.$el.find("select");this.$select.on("change",this.change.bind(this));this.values=this.schema.values;this.labels=this.schema.labels||this.schema.values;this.render()},set:function(val){var obj={};obj[this.key]=val;this.ctx(this.operator).set(obj)},update:function(op,val){this.render()},change:function(e){this.set(this.$select.val())},render:function(data){var val=this.operator.get(this.key);var sel=val?"":'selected="selected"';this.$select.html(" ");_.each(this.labels,function(label,index){var value=this.values[index];sel=value===val?'selected="selected"':"";this.$select.append("<option value='"+value+"' "+sel+">"+label+"</option>")},this);this.$select.select2()}});exo.ui.views.properties.Button=exo.ui.views.Property.extend({initialize:function(){var propView=this;this.$el.on("click",function(e){propView.call()})},call:function(){var func,methodName,value=this.operator.get(this.key)||{};if(!value.disabled){methodName=this.schema.methodName||this.key;func=this.operator[methodName];if(!func&&this.operator.operator){func=this.operator.operator[methodName]}if(func){func.call(this.operator,this.operator)}else{throw new Error("Button function not found.")}}},update:function(op,val){var text=val?val.text:this.schema.text;this.$el.text(text||this.schema.label||this.key)}});exo.ui.views.properties.Node=exo.ui.views.Property.extend({initialize:function(){_.bindAll(this);var select=this.$select=this.$el.find("select");var reference=this.$reference=this.$el.find(".node-reference");this.$reference.on("click",this.selectReference.bind(this));this.$select.on("change",this.change);var filterQuery=this.schema.filter||function(){return true};this.nodes=this.operator.scene().filter(filterQuery.bind(this.operator));this.render()},change:function(e){var id=this.$select.val();var node=id?_.find(this.nodes,function(n){return n.id===id}):null;if(id&&node){this.set(id);this.$reference.show()}else{this.set(null);this.$reference.hide()}},selectReference:function(e){var node=this.operator.get(this.key);if(!node)return;if(!node.selectable){this.editor.clearSelection();this.editor.trigger("selected",node)}else{this.editor.clearSelection();this.editor.select(node)}},render:function(data){var val=this.operator.get(this.key);var sel=val?"":'selected="selected"';var currentNode=this.operator.node();_.each(this.nodes,function(node){if(node.id!==currentNode.id&&!node.references[currentNode.id]){sel=val&&node.id===val.id?'selected="selected"':"";this.$select.append("<option value='"+node.id+"' "+sel+">"+node.get("name")+"</option>")}},this);this.$select.select2({placeholder:"Select "+this.schema.label,allowClear:true});this.$reference.toggle(!!val)},onBlur:function(){this.$select.select2("close")}});exo.ui.views.properties.NodeList=exo.ui.views.Property.extend({initialize:function(){_.bindAll(this);var select=this.$select=this.$el.find("select");this.$select.on("change",this.change);var filterQuery=this.schema.filter||function(){return true};this.nodes=this.operator.scene().filter(filterQuery.bind(this.operator));this.updateView();this.$selectFromViewport=this.$el.find("i.select");this.$selectFromViewport.click(this.selectFromViewport);this.$nodeList=this.$el.find("ul.nodes");this.$nodeList.click(this.removeNode)},selectFromViewport:function(e){var selecting=!this.$selectFromViewport.data("selecting");this.$selectFromViewport.data("selecting",selecting);var editor=this.operator.scene().editor();editor.ignoreSelection=selecting;if(selecting){this.$selectFromViewport.addClass("active")}else{this.$selectFromViewport.removeClass("active");this.addNodes(editor.selected.models);this.$select.select2("val","")}},addNodes:function(nodes){var hasAlready=this.operator.schema[this.key].get();var ids=_.map(hasAlready.concat(nodes),function(n){return n.id||n});this.set(ids)},removeNode:function(e){var hasAlready=this.operator.schema[this.key].get();var id=$(e.target).data("id");if(!id)return;var ids=_.map(_.reject(hasAlready,function(n){return n.id===id}),function(n){return n.id});this.set(_.clone(ids));this.$select.select2("val","")},change:function(e){this.addNodes([this.$select.val()]);this.$select.select2("val","")},updateView:function(){_.each(this.nodes,function(node){this.$select.append("<option value='"+node.id+"'>"+node.get("name")+"</option>")},this);this.$select.select2({placeholder:"Add to "+this.schema.label,closeOnSelect:true})},update:function(op,val){var nodes=_.map(val,function(n){if(n){return{id:n.id,name:n.get("name")}}else{return{}}});this.$nodeList.html(nct.render("editor/properties/_nodes",{nodes:nodes}))},onBlur:function(){this.$select.select2("close")}});exo.ui.views.properties.dropUpload={initUpload:function($el,$target){this.$uploadEl=$el;this.$target=$target===undefined?$el:$target;this.$uploadEl.on("dragstart",this.dragstart.bind(this));this.$uploadEl.on("dragenter",this.dragenter.bind(this));this.$uploadEl.on("dragover",this.dragover.bind(this));if($target){$target.on("dragleave",this.dragleave.bind(this));$target.on("drop",this.drop.bind(this))}else{this.$uploadEl.on("dragleave",this.dragleave.bind(this));this.$uploadEl.on("drop",this.drop.bind(this))}this.dragUploading=false;this.draggingOther=false},showDragTarget:function(){},hideDragTarget:function(){},onload:function(e){},read:function(reader,file){reader.readAsText(file)},dragstart:function(e){},dragenter:function(e){if(!this.draggingOther&&e.dataTransfer.types&&Array.prototype.indexOf.call(e.dataTransfer.types,"Files")!==-1){this.showDragTarget();this.dragUploading=true;e.stopPropagation();e.preventDefault()}},dragleave:function(e){if(this.dragUploading){var rect=this.$target[0].getBoundingClientRect();var pos=this.getXY(e.originalEvent);if(pos.x>rect.left+rect.width-1||pos.x<rect.left||pos.y>rect.top+rect.height-1||pos.y<rect.top){this.hideDragTarget()}e.stopPropagation();e.preventDefault()}},dragover:function(e){if(this.dragUploading){e.stopPropagation();e.preventDefault()}},drop:function(e){if(this.dragUploading){this.hideDragTarget();e.stopPropagation();e.preventDefault();this.handleFiles(e.dataTransfer.files);this.dragUploading=false}},handleFiles:function(files){if(!files&&files.length)return;var file=files[0];this.file={name:file.name,size:file.size,type:file.type};var reader=new FileReader;reader.onload=this.onload;this.read(reader,file)},getXY:function(event){var x,y;if(typeof event.clientX==="undefined"){x=event.pageX+document.documentElement.scrollLeft;y=event.pageY+document.documentElement.scrollTop}else{x=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;y=event.clientY+document.body.scrollTop+document.documentElement.scrollTop}return{x:x,y:y}}};exo.ui.views.properties.File=exo.ui.views.Property.extend(_.extend({},exo.ui.views.properties.dropUpload,{initialize:function(){_.bindAll(this);var input=this.$input=this.$el.find("input");this.input=this.$input[0];this.$input.on("change",this.change);this.$el.find("button").on("click",function(e){input.click();e.preventDefault()});this.$uploadTools=this.$el.find(".upload-tools");this.$dropMessage=this.$el.find(".drop-message");this.initUpload(this.$uploadTools,this.$dropMessage)},showDragTarget:function(){if(this.$uploadTools.is(":visible")){this.$uploadTools.hide();this.$dropMessage.show()}},hideDragTarget:function(){this.$uploadTools.show();this.$dropMessage.hide()},onload:function(e){this.file.data=e.target.result;this.set(this.file)},change:function(){this.handleFiles(this.input.files)},update:function(op,val){if(this.file&&this.file.name){this.$el.find(".filename").text(this.file.name)}}}));exo.ui.views.properties.Blob=exo.ui.views.properties.File.extend({read:function(reader,file){reader.readAsBinaryString(file)}});exo.ui.views.properties.Image=exo.ui.views.properties.File.extend({initialize:function(){this.$select=this.$el.find("select");this.$select.on("change",this.change.bind(this));this.files=this.editor.scene.files;this.files.on("all",this.render,this);this.$reference=this.$el.find(".node-reference");this.$reference.on("click",this.selectReference.bind(this));this.render()},selectReference:function(e){var node=this.operator.get(this.key);if(node){this.editor.clearSelection();this.editor.trigger("selected",node)}},set:function(val){var obj={};obj[this.key]=val||null;this.ctx(this.operator).set(obj)},update:function(op,file){this.render()},change:function(e){this.set(this.$select.val())},read:function(reader,file){reader.readAsDataURL(file)},render:function(data){var val=this.operator.get(this.key);var sel=val?"":'selected="selected"';this.$select.html("<option></option>");_.each(this.files.assets(),function(file){if(file.isImage()){sel=file===val?'selected="selected"':"";this.$select.append("<option value='"+file.id+"' "+sel+">"+file.get("name")+"</option>")}},this);this.$select.select2({placeholder:"Select Image",allowClear:true})}});exo.ui.views.properties.JSON=exo.ui.views.properties.File.extend({initialize:function(){this.$select=this.$el.find("select");this.$select.on("change",this.change.bind(this));this.files=this.editor.scene.files;this.files.on("all",this.render,this);this.$reference=this.$el.find(".node-reference");this.$reference.on("click",this.selectReference.bind(this));this.render()},selectReference:function(e){var node=this.operator.get(this.key);if(node){this.editor.clearSelection();this.editor.trigger("selected",node)}},set:function(val){var obj={};obj[this.key]=val;this.ctx(this.operator).set(obj)},update:function(op,file){this.render()},change:function(e){this.set(this.$select.val())},read:function(reader,file){reader.readAsDataURL(file)},render:function(data){var val=this.operator.get(this.key);var sel=val?"":'selected="selected"';this.$select.html("<option></option>");_.each(this.files.assets(),function(file){if(file.isGeometry()){sel=file===val?'selected="selected"':"";this.$select.append("<option value='"+file.id+"' "+sel+">"+file.get("name")+"</option>")}},this);this.$select.select2({placeholder:"Select Geometry",allowClear:true})}});exo.ui.views.CommandView=highbrow.extend("ItemView","CommandView",{tagName:"li",initialize:function(){this.model.on("change",this.render,this)}});exo.ui.views.CommandsView=highbrow.extend("CollectionView","CommandsView",{itemView:exo.ui.views.CommandView,initialize:function(options){this.editor=this.options.editor;this.editor.selected.on("add",this.update,this);this.editor.selected.on("remove",this.update,this)},update:function(){this.collection.each(function(model){var command=model.get("command");if(command.uiUpdate){command.uiUpdate({path:this.path,editor:this.editor,node:this.options.node||this.editor.scene},model)}},this)},onRender:function(){this.update()},events:{"click .command":"command"},command:function(e){var name=$(e.currentTarget).data("command");var commands=name.split("/");var command=this.collection.find(function(model){return model.get("fullName")===name});if(command){var cmd=command.get("command");if(!cmd.link){e.preventDefault()}}else{e.preventDefault()}log.command('app.plugin("'+commands[0]+'").'+commands[1]+"();");exo.trackEvent("Plugin","Command",commands[0]+"."+commands[1]);var ctx=this.editor.getCtx();ctx().exec(commands[0],commands[1],{node:this.options.node||this.editor.scene}).fail(function(err){})}});exo.ui.views.TopNav=highbrow.extend("ItemView","TopNav",{initialize:function(){this.render()},onRender:function(){this.menubar=new exo.ui.views.Menubar({collection:this.model.commands["menu"],el:this.$(".menubar"),editor:this.model});this.menubar.render()}});exo.ui.views.Menubar=exo.ui.views.CommandsView.extend({name:"Menubar",place:"menu",topbar:true,events:{"click .dropdown":"trackDropDownMenu","click .command":"trackMenuCommand"},trackDropDownMenu:function(e){var menuChoice=$(e.currentTarget).data("menu");if(menuChoice==="Materials"){exo.trackEvent("Material Menu","Click Dropdown")}},trackMenuCommand:function(e){var clickedChoice=$(e.currentTarget).text();clickedChoice=$.trim(clickedChoice);var command=$(e.currentTarget).data("command");if(command.split("/")[0]==="material"){exo.trackEvent("Material Menu","Click",'"'+clickedChoice+'" Material')}return exo.ui.views.CommandsView.prototype.command.call(this,e)},appendHtml:function(el,html,model){var path=model.get("path");if(path instanceof String){path=[path]}else if(!(path instanceof Array)){path=[]}var depth=0;if(!el.is("ul")){el=el.find("ul:first")}while(depth<path.length){var title=path[depth];var menu=el.find('li[data-menu="'+title+'"]');if(menu.length===0){menu=$('<li data-menu="'+title+'" class="dropdown'+(depth===0&&this.topbar?"":"-submenu")+'"><a class="dropdown-toggle" data-toggle="dropdown" href="#">'+title+'</a><ul class="dropdown-menu" role="menu"></ul></li>');el.append(menu)}el=menu.find("ul:first");depth=depth+1}el.append(html)}});exo.ui.views.ContextMenuView=exo.ui.views.CommandsView.extend({className:"context scene-explorer-context",popup:function(options){this.detach();this.options=options||this.options;this.editor=this.options.editor||this.editor;this.node=this.options.node;this.$parent=$(this.options.parent||document.body);this.mousePos=this.getMousePosFromEvent(this.options.event);this.render()},moveToParent:false,getMousePosFromEvent:function(e){return e?{left:e.pageX,top:e.pageY}:null},setParentElement:function($parent,mousePos){this.detach();this.$parent=$parent||$(document.body);this.mousePos=mousePos},setModel:function(node){this.node=node;this.render()},onRender:function(){this._detach=this.detach.bind(this);$(window).on("click",this._detach);$(window).on("contextmenu",this._detach);this.$dropdownMenu=this.$el.find(".dropdown-menu:first");this.update();this.attach()},data:function(){return new exo.ui.vm.Node(this.options.node)},attach:function(){exo.ui.views.ContextMenuView.currentlyOpen=this;this.$parent=this.$parent||$(document.body);var offset=this.mousePos;if(!offset){offset=this.$parent.offset()}$(document.body).append(this.$el);this.$dropdownMenu.show();if(offset.left+this.$dropdownMenu.width()>this.$parent.offset().left+this.$parent.width()){offset.left=this.$parent.offset().left+this.$parent.width()-this.$dropdownMenu.width()}if(this.moveToParent){this.$el.css({left:offset.left,top:this.$parent.offset().top+this.$parent.height()})}else{this.$el.css({left:offset.left,top:offset.top})}},detach:function(e){var $target=e?$(e.target):null;$(window).off("click",this._detach);$(window).off("contextmenu",this._detach);this.$parent=null;this.$el.detach();if(this.$dropdownMenu)this.$dropdownMenu.hide()},appendHtml:exo.ui.views.Menubar.prototype.appendHtml});exo.ui.views.ContextMenuView.create=function(options){var previous=exo.ui.views.ContextMenuView.currentlyOpen;var $target=$(options.event.currentTarget);var parentClassName=this.prototype.parentClassName;var $parent=!parentClassName||$target.hasClass(parentClassName)?$target:$target.parents("."+parentClassName);var $previousParent=previous?previous.$parent:null;var id=$parent.data("id");var contextMenu=previous;options.parent=$parent;options.node=options.model||(id?options.editor.scene.getNodeById(id):options.editor.scene);options.collection=options.editor.commands[this.place]||new exo.models.Commands([]);if(options.event){options.event.preventDefault()}if(previous)previous.detach();if(options.reset||!previous||!$parent.is($previousParent)){contextMenu=new exo.ui.views[this.prototype.name](options);contextMenu.popup()}else{contextMenu.update()}return contextMenu};if(typeof jQuery!=="undefined"&&!_.include(jQuery.event.props,"dataTransfer")){jQuery.event.props.push("dataTransfer")}exo.ui.views.DropHandler=highbrow.extend("ItemView","DropHandler",{initialize:function(){this.visible=false;this.dragUploading=false;this.handlers=[];if(!this.$el.find("#drop-handler").length){this.$el.append(nct.render("editor/drop_handler",{}))}this.dragElements=[]},render:function(){},pushHandler:function(handler){this.handlers.push(handler)
},popHandler:function(){if(this.handlers.length>1){this.handlers.pop()}},events:{dragover:"dragover",dragenter:"dragenter",dragleave:"dragleave",drop:"drop"},showDragTarget:function(){var handler=this.handlers[this.handlers.length-1];if(handler&&handler.showDragTarget){handler.showDragTarget()}else{this.$(".drop-message").modal("show")}},hideDragTarget:function(){var handler=this.handlers[this.handlers.length-1];if(handler&&handler.hideDragTarget){handler.hideDragTarget()}else{this.$(".drop-message").modal("hide")}},handleFiles:function(files){var handler=this.handlers[this.handlers.length-1];if(handler&&handler.handleFiles)handler.handleFiles(files)},isDraggingFiles:function(e){return e.dataTransfer&&e.dataTransfer.types&&Array.prototype.indexOf.call(e.dataTransfer.types,"Files")!==-1},dragenter:function(e){if(this.isDraggingFiles(e)){if(this.dragElements.length===0){this.showDragTarget()}this.dragElements.push(e.target);this.dragUploading=true;e.stopPropagation();e.preventDefault()}},dragleave:function(e){if(this.dragUploading){this.dragElements=_.without(this.dragElements,e.target);if(this.dragElements.length===0){this.hideDragTarget();this.dragUploading=false}e.stopPropagation();e.preventDefault()}},dragover:function(e){if(this.dragUploading){e.stopPropagation();e.preventDefault()}},drop:function(e){if(this.dragUploading){e.stopPropagation();e.preventDefault();this.hideDragTarget();this.dragElements=[];this.dragUploading=false;this.handleFiles(e.dataTransfer.files)}},getXY:function(event){var x,y;if(typeof event.clientX==="undefined"){x=event.pageX+document.documentElement.scrollLeft;y=event.pageY+document.documentElement.scrollTop}else{x=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;y=event.clientY+document.body.scrollTop+document.documentElement.scrollTop}return{x:x,y:y}}});exo.ui.views.KeyFramableContext=exo.ui.views.ContextMenuView.extend({name:"KeyFramableContext",initialize:function(){this.propertyView=this.options.propertyView||null;this.popup(this.options);this.timeline=this.model.scene().plugs.Timeline},data:function(){var keyFramed=this.model.isKeyFramed(this.propertyView.key);var hasKeys=!!this.getTimes().length;return _.extend(new exo.ui.vm.Operator(this.model,this.error),{keyframed:!!keyFramed.key,hasKeys:hasKeys})},events:{"click .set-key-frame":"setKeyFrame","click .remove-key-frame":"removeKeyFrame","click .clear-key-frames":"clearKeyFrames","click .goto-first-key":"gotoFirstKey","click .goto-last-key":"gotoLastKey","click .goto-previous-key":"gotoPreviousKey","click .goto-next-key":"gotoNextKey"},moveToParent:true,parentClassName:"cr",setKeyFrame:function(e){e.preventDefault();var keyFramed=this.model.isKeyFramed(this.propertyView.key);var val=this.propertyView.schema.getAt(this.model.time);var ctx=this.propertyView.ctx(this.propertyView.operator);if(!keyFramed.key){ctx.setAt(this.propertyView.key,val);this.options.propertyView.updateKeyFraming()}},removeKeyFrame:function(e){e.preventDefault();var keyFramed=this.model.isKeyFramed(this.propertyView.key);var val=this.propertyView.schema.getAt(this.model.time);var ctx=this.propertyView.ctx(this.propertyView.operator);if(keyFramed.key){ctx.removeKeyFrame(this.propertyView.key,this.model.time);this.options.propertyView.updateKeyFraming()}},clearKeyFrames:function(e){e.preventDefault();var ctx=this.propertyView.ctx(this.propertyView.operator);var schema=this.propertyView.schema;var tracks=schema?schema.tracks||[schema.track]:null;var key=this.propertyView.key;var cleared={};var clearFromTrack=function(track,subKey){if(!track.keyf)return false;for(var i=track.keyf.keys.length-1;i>=0;--i){var clearKey=key+"-"+track.keyf.keys[i].t;if(!cleared[clearKey]){ctx.removeKeyFrame(key,track.keyf.keys[i].t);cleared[clearKey]=true}}};if(schema.tracks){_.each(schema.tracks,clearFromTrack)}else if(schema.track){clearFromTrack(schema.track)}},gotoKey:function(time){this.timeline.gotoTime(time)},gotoFirstKey:function(e){e.preventDefault();var times=this.getTimes();if(times&&times.length>=1){this.gotoKey(times[0])}},gotoLastKey:function(e){e.preventDefault();var times=this.getTimes();if(times&&times.length>=1){this.gotoKey(times[times.length-1])}},gotoPreviousKey:function(e){e.preventDefault();var times=this.getTimes();if(times&&times.length>1){var closestIndex=this.findClosestKey();var closestTime=times[closestIndex];if(this.timeline.currentFrame>closestTime){this.gotoKey(closestTime)}else if(closestIndex>0){this.gotoKey(times[closestIndex-1])}}},gotoNextKey:function(e){e.preventDefault();var times=this.getTimes();if(times&&times.length>1){var closestIndex=this.findClosestKey();var closestTime=times[closestIndex];if(this.timeline.currentFrame<closestTime){this.gotoKey(closestTime)}else if(closestIndex<times.length-1){this.gotoKey(times[closestIndex+1])}}},findClosestKey:function(){var times=this.getTimes();var closestDiff,closestTime,closestIndex;_.each(times,function(time,index){var diff=Math.abs(this.timeline.currentFrame-time);if(!index||diff<closestDiff){closestDiff=diff;closestTime=time;closestIndex=index}},this);return closestIndex},getTimes:function(){return this.model.schema[this.propertyView.key].getKeyFrameTimes()}});exo.ui.views.KeyFramableContext.create=exo.ui.views.ContextMenuView.create;exo.ui.FileUtils={saveFile:function(fileString,fileName){var blob=new Blob([fileString],{type:"application/octet-stream;charset="+document.characterSet});saveAs(blob,fileName)},exportNode:function(node,extension,options){var fileName=node.get("name")+"."+extension;exo.ui.FileUtils.saveFile(exo.resources.exportFile(node,extension,options),fileName)}};exo.ui.views.FileDialog=highbrow.extend("ItemView","FileDialog",{className:"modal hide fade",initialize:function(){this.files=[];this.accept=this.options.accept;this.$el.modal();_.bindAll(this);exo.dropHandler.pushHandler(this)},onRender:function(){if(this.accept)this.$(".file").attr("accept",this.accept)},events:{"change input.file":"updateFileList",submit:"choose","click .cancel":"cancel","click .submit":"choose"},onRender:function(){var extensions=exo.resources.supportedImporterExtensions();_.each(extensions,function(extension,index){extensions[index]="."+extension});this.$(".supported-extensions").text(extensions.join(", "))},showDragTarget:function(){this.$(".filedrop").addClass("dragging")},hideDragTarget:function(){this.$(".filedrop").removeClass("dragging")},done:function(){this.$el.modal("hide");exo.dropHandler.popHandler()},handleFiles:function(files){for(var i=0;i<files.length;i++){this.files.push(files[i])}this.done()},updateFileList:function(e){e.preventDefault();this.handleFiles(e.target.files)},cancel:function(e){e.preventDefault();this.files=[];this.done()},choose:function(e){if(e)e.preventDefault();this.done()}},{prompt:function(options,callback){options=options||{};var dialog=new exo.ui.views.FileDialog(options);dialog.render();$("body").append(dialog.el);dialog.$el.on("hidden",function(){var files=dialog.files;dialog.$el.detach();dialog.close();callback(files)})}});exo.ui.views.ManipulatorToolbar=exo.ui.views.CommandsView.extend({name:"ManipulatorToolbar",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this);this.editor=this.options.editor;this.editor.on("change:activeManipulator",this.changeActiveManipulator,this);this.editor.on("selectedManipulator",this.disableAll,this);this.editor.selected.on("add",this.disableAll,this);this.editor.selected.on("remove",this.disableAll,this)},changeActiveManipulator:function(editor,manipulator){this.findElement(this.activeManipulator).removeClass("active");this.findElement(manipulator).addClass("active");this.activeManipulator=manipulator;this.editor.scene.triggerDirty()},disableAll:function(){var node=this.editor.selected.length===1?this.editor.selected.last():null;var selectedManipulator=node?node.selectedManipulator:null;if(selectedManipulator&&selectedManipulator.gizmo!=="Transform"){_.each(["Select","Move","Rotate","Scale"],function(manipulator){this.findElement(manipulator).removeClass("active");this.findElement(manipulator).addClass("disabled")},this)}else{this.enableAll()}this.findElement(this.editor.currentManipulator()).addClass("active")},enableAll:function(){_.each(["Select","Move","Rotate","Scale"],function(manipulator){this.findElement(manipulator).removeClass("active");this.findElement(manipulator).removeClass("disabled")},this)},findElement:function(manipulator){return this.$el.find("[title="+manipulator+"]").parent()},onRender:function(){this.changeActiveManipulator(this.editor,this.editor.get("activeManipulator"));this.update()}},{place:"manipulatorToolbar"});exo.ui.views.SubObjectToolbar=exo.ui.views.CommandsView.extend({name:"SubobjectToolbar",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this);this.options.editor.subSelection.on("change:type",this.changeSubSelectionType,this)},changeSubSelectionType:function(subSelection,type){this.$el.find("[title="+this.subSelectionType+"]").parent().removeClass("active");this.$el.find("[title="+type+"]").parent().addClass("active");this.subSelectionType=type;this.editor.scene.triggerDirty()},onRender:function(){this.changeSubSelectionType(this.options.editor.subSelection,this.options.editor.subSelection.get("type"));this.update()}},{place:"subObjectToolbar"});exo.ui.views.Dialog=highbrow.extend("ItemView","Dialog",{onRender:function(){$(document).append(this.$el);this.$el.modal();console.log("onRender")}});exo.ui.views.Log=highbrow.extend("ItemView","Log",{initialize:function(){this.active="all";this.attrs={all:{num:0,label:"All"},error:{num:0,label:"Errors",badge:"important"},warning:{num:0,label:"Warnings",badge:"warning"},log:{num:0},info:{num:0,label:"Logs",badge:"info"},command:{num:0,label:"Commands",badge:""},pre:{num:0}};this.model.notifications.on("add",this.addNotification,this);this.model.scene.changes.on("add",function(change){this.command(change,false)},this);this.logCount=0;this.maxLogCount=50;this.pending=[]},events:{"click .filter a":"filterTo","click .clear":"clear","contextmenu .body":"contextMenu"},clear:function(e){e.preventDefault();this.$body.empty();_.each(this.attrs,function(i){i.num=0});this.renderHeader();this.updateTitle()},filterTo:function(e){e.preventDefault();var type=$(e.currentTarget).data("type");if(!type)return;this.active=type;if(type==="all"){this.$body.find("div.message").show()}else{this.$body.find("div.message").hide();this.$body.find("div."+type).show()}this.renderHeader()},view:function(){return{types:_.map(this.attrs,function(i,key){return _.extend({},i,{key:key,active:this.active===key})},this)}},command:function(message,notify){return this.create(message,"command",notify)},pre:function(message,notify){return this.create(message,"pre",notify)},log:function(message,notify){return this.create(message,"pre",notify)},info:function(message,notify){return this.create(message,"info",notify)},warning:function(message,notify){return this.create(message,"warning",notify)},error:function(message,notify){return this.create(message,"error",notify);this.updateTitle()},create:function(message,type,notify){var notification=new exo.models.Notification({message:message,type:type,persist:type==="error"});notification.shouldNotify=!!notify;if(notify){this.model.notifications.add(notification)}else{this.addNotification(notification)}return notification},notificationIcons:{info:"icon-info-sign",success:"icon-ok-sign",error:"icon-warning-sign",notice:"icon-exclamation-sign"},addNotification:function(notification){this.pending.push(notification);if(this.pending.length>this.maxLogCount){this.pending.shift()}this.model.callWhenDone(this.handleNotifications,this)()},handleNotifications:function(){var log=this;setTimeout(function(){_.each(log.pending,function(notification){var message=notification.get("message");if(message instanceof exo.sceneGraph.Change){message=message.toApi();if(message){notification.set("message",message)}else{return}}log.handleNotification(notification,notification.shouldNotify)});log.pending=[]},100)},handleNotification:function(notification,notify){notify=notify===undefined?true:notify;var type=notification.get("type");var message=notification.get("message");var title=notification.get("title");var isCommand=type==="command"||type==="pre";var logMessage;var logBody=this.$body[0],$logBody=this.$body;var bottom=logBody.scrollHeight-$logBody.outerHeight();var messageTitle=$('<span class="message-title">'+title+"</span>");if(isCommand){logMessage=$('<div class="message '+type+'"><pre>'+message+"</pre></div>")}else{logMessage=$('<div class="message '+type+'">'+message+"</div>")}this.logCount++;if(this.logCount>this.maxLogCount){this.logCount--;this.$body.children().first().remove()}this.$body.append(logMessage);logMessage.prepend(messageTitle);messageTitle.toggle(!!title);logMessage.append(this.createProgressbar(notification,true));if(logBody.scrollTop||bottom&&!this.scrollbarCreated){this.modifyScrollbar(bottom)}if(notify){var icon=(this.notificationIcons[type]||this.notificationIcons.info)+" icon-white";var pnotify=$.pnotify({title:title,text:message,hide:!notification.get("persist"),icon:icon,type:isCommand?"info":type});pnotify.closer.find("span").addClass("icon-white");pnotify.sticker.find("span").addClass("icon-white");pnotify.container.append(this.createProgressbar(notification));notification.on("closed",function(){setTimeout(function(){pnotify.pnotify_remove()},2e3)})}},modifyScrollbar:function(bottom){var $logBody=this.$body,logBody=this.$body[0];bottom=bottom||logBody.scrollHeight-$logBody.outerHeight();this.scrollbarCreated=true;this.scrollTop=logBody.scrollTop;var scrollTop=this.scrollTop;var atBottom=!scrollTop||scrollTop>=bottom-50;setTimeout(function(){var bottom=logBody.scrollHeight-$logBody.outerHeight();if(atBottom){logBody.scrollTop=bottom}else{logBody.scrollTop=scrollTop}},0)},createProgressbar:function(notification,hideOnComplete){var progressBar=$('<div class="progress"></div>');var progress=$('<div class="bar" style="width:'+notification.get("progress")+'%"></div>');progressBar.toggle(notification.get("showProgress"));progressBar.append(progress);if(hideOnComplete&&notification.get("progress")>=100){progressBar.hide()}notification.on("change:progress",function(){var percentage=notification.get("progress");progress.css("width",percentage+"%");if(hideOnComplete&&percentage>=100){progressBar.hide()}});notification.on("change:showProgress",function(){progressBar.toggle(notification.get("showProgress"))});return progressBar},handleLog:function(level,message,notify){if(!this.attrs[level])return;this.attrs[level].num=(this.attrs[level].num||0)+1;this[level](message,notify);this.$body.scrollTop(this.el.scrollHeight);this.renderHeader()},updateTitle:function(){var title="Log";if(this.attrs.error.num){title='Log <span class="badge badge-important">'+this.attrs.error.num+"</span>"}this.$tabTitle.html(title)},renderHeader:function(){this.$header.html(nct.render("editor/log_header",this.view()))},onRender:function(){this.$tabTitle=$("#log-option a");this.$header=this.$el.find(".header");this.$body=this.$el.find(".body");this.renderHeader()},onShow:function(){log.on("log",this.handleLog,this)},contextMenu:function(e){e.stopPropagation()}});exo.ui.views.Statusbar=highbrow.extend("ItemView","Statusbar",{});exo.ui.views.PropertiesSimple=highbrow.extend("ItemView","PropertiesSimple",{initialize:function(options){this.node=options.node;this.propertyViews={}},data:function(){if(!this.node)return{};return new exo.ui.vm.Node(this.node,this.error)},updateNode:function(){if(this.node){this.update(this.node)}},update:function(model){this.node=model;this.rerender()},onRender:function(){this.renderProperties(this.$el.find(".node"),this.node)},renderProperties:function($el,node){var $ul=$el.find(".properties ul");$ul.empty();this.propertyViews[node.id]={};_.each(node.schema,function(info,key){if(!info.schema.hidden){var PropertyView=exo.ui.views.properties[info.type];if(!PropertyView)throw new Error("Unknown property type: "+info.type);this.propertyViews[node.id][key]=new PropertyView($ul,key,node,this.model)}},this)}});exo.ui.views.Properties=highbrow.extend("ItemView","Properties",{initialize:function(){this.node=this.model.scene;if(this.model.selected.length){this.update(this.model.selected.last())}this.model.selected.on("add",this.model.callWhenDone(this.update,this),this);this.model.scene.on("removeNode",this.model.callWhenDone(this.onNodeRemoved,this),this);this.model.on("selected",this.model.callWhenDone(this.update,this),this);this.model.on("selectedManipulator",this.model.callWhenDone(this.manipulatorSelected,this),this);this.closedPlugs={};this.propertyViews={};this.update(this.node)},data:function(){if(!this.node)return{};return new exo.ui.vm.Node(this.node,this.error)},events:{"click .operator":"switchOperator","click .operator-manipulator":"activateManipulator","click .toggle-manipulators":"toggleManipulators","change .add-node":"addNode","change .operator-choices":"addOperator","click .remove-operator":"removeOperator","click .collapse-mesh":"collapseMesh","click .toggle-active-operator":"toggleActiveOperator","hide .accordion-body":"hideAccordion","show .accordion-body":"showAccordion","dragenter .operator":"dragEnterOperator","dragover .operator":"dragOverOperator","dragleave .operator":"dragLeaveOperator","dragend .operator":"dragEndOperator","drop .operator":"dropOperator"},hideAccordion:function(e){if($(e.target).hasClass("accordion-body")){$(e.currentTarget).prev().find("i").removeClass("icon-chevron-down").addClass("icon-chevron-right");this.closedPlugs[this.node.plugs.get($(e.currentTarget).attr("id")).get("type")]=true}},showAccordion:function(e){if($(e.target).hasClass("accordion-body")){$(e.currentTarget).prev().find("i").removeClass("icon-chevron-right").addClass("icon-chevron-down");this.closedPlugs[this.node.plugs.get($(e.currentTarget).attr("id")).get("type")]=false}},setActiveOperator:function(plug,operator){if(plug.activeOperator){plug.activeOperator.off("change:schema",this);_.each(this.propertyViews[plug.activeOperator.id],function(propView,key){propView.close()});this.propertyViews[plug.activeOperator.id]={}}plug.activeOperator=operator||(plug.operators.length?plug.operators.last():plug);plug.activeOperator.on("change:schema",this.rerender,this)},toggleActiveOperator:function(e){var plug=this.node.plugs.get($(e.target).parents(".plug").attr("id"));if(plug){var id=$(e.currentTarget).data("id");var operator=plug.operators.get($(e.currentTarget).data("id"));if(operator){this.model.getCtx()(operator).set({active:!operator.get("active")});plug.applyOperators();this.rerender()}}},updateNode:function(){this.update(this.node)},onNodeRemoved:function(node){if(node===this.node){this.update(this.model.scene)}},onOperatorAdded:function(operator){this.updateNode();var $plugEl=this.$el.find("div#"+operator.plug().id);var $operatorEl=$plugEl.find("a#"+operator.id);var selectedManipulator=operator.operator.selectedManipulator;this.switchActiveOperator(operator,operator.plug(),$operatorEl,$plugEl);if(selectedManipulator){this.activateManipulatorByName(operator,selectedManipulator)}else{this.clearSelectedManipulator()}},onOperatorRemoved:function(operator){var plug=operator.plug();if(this.node.selectedManipulator&&this.node.selectedManipulator.operator===operator){this.clearSelectedManipulator()}if(operator===plug.activeOperator){this.setActiveOperator(plug)}this.updateNode()},update:function(model){if(model!==this.node){this.$activeManipulator=null}if(this.node.selectedManipulator){this.manipulatorSelected(this.node,this.node.selectedManipulator)}if(this.model.ignoreSelection)return;if(this.node&&this.node.plugs){this.node.plugs.each(function(plug){plug.operators.off("add",this.onOperatorAdded,this);plug.operators.off("remove",this.onOperatorRemoved,this);this.closeViews(plug)},this)}this.node=model;this.node.closedPlugs=this.closedPlugs;if(this.node.plugs){this.node.plugs.each(function(plug){this.setActiveOperator(plug,plug.activeOperator);plug.operators.on("add",this.onOperatorAdded,this);plug.operators.on("remove",this.onOperatorRemoved,this)},this)}this.rerender()},onRender:function(){this.renderProperties(this.$el.find(".node"),this.node);if(this.node.plugs){this.node.plugs.each(function(plug){this.renderProperties($("#"+plug.id),plug.activeOperator)},this)}this.$el.find(".operator-choices").select2({width:this.$el.width()-10});if(this.node.selectedManipulator){this.$activeManipulator=this.$el.find("#"+this.node.selectedManipulator.operator.id+" #"+this.node.selectedManipulator.name)}},renderProperties:function($el,operator){var $ul=$el.find(".properties ul.properties");$ul.empty();this.propertyViews[operator.id]={};_.each(operator.schema,function(info,key){if(!info.schema.hidden){var PropertyView=exo.ui.views.properties[info.type];if(!PropertyView)throw new Error("Unknown property type: "+info.type);this.propertyViews[operator.id][key]=new PropertyView($ul,key,operator,this.model)}},this)},switchOperator:function(e){e.preventDefault();var $plugEl=$(e.currentTarget).parents(".plug");var plug=this.node.plugs.get($plugEl.attr("id"));var operator=plug.operators.get(e.target.id);this.switchActiveOperator(operator,plug,$(e.currentTarget),$plugEl);if(this.$activeManipulator){this.clearSelectedManipulator();this.model.scene.triggerDirty()}},switchActiveOperator:function(operator,plug,$operatorEl,$plugEl){if(!plug.activeOperator||plug.activeOperator!==operator){$plugEl.find("a.operator").removeClass("selected");$operatorEl.addClass("selected");this.setActiveOperator(plug,operator);this.renderProperties($plugEl,operator)}},activateManipulator:function(e){var $el=$(e.currentTarget);var manipulatorName=$el.attr("name");var $operatorEl=$el.parents("li").find(".operator");var $plugEl=$el.parents(".plug");var plug=this.node.plugs.get($plugEl.attr("id"));var operator=plug.operators.get($operatorEl.attr("id"));this.activateManipulatorByName(operator,manipulatorName,$operatorEl,$plugEl)},activateManipulatorByName:function(operator,manipulatorName){if(operator&&manipulatorName){this.clearSelectedManipulator();if(!operator.expandedManipulators){this.openManipulators(operator)}this.model.selectManipulator(this.node,operator,manipulatorName)}},openManipulators:function(operator,$operatorEl){$operatorEl=$operatorEl||this.$("#"+operator.id);operator.expandedManipulators=true;var $toggleEl=$operatorEl.parent().find(".toggle-manipulators");$toggleEl.removeClass("icon-chevron-right").addClass("icon-chevron-down");$operatorEl.parent().find("#"+operator.id+"-manipulators").addClass("in")},manipulatorSelected:function(node,operatorManipulator){this.$el.find(".operator-manipulator").removeClass("selected");this.$activeManipulator=null;if(operatorManipulator){var operator=operatorManipulator.operator;var plug=operator.plug();var name=operatorManipulator.name;var $plugEl=this.$("#"+plug.id);var $operatorEl=this.$("#"+operator.id+" .operator");var $manipulatorEl=$plugEl.find("#"+name);this.switchActiveOperator(operator,plug,$operatorEl,$plugEl);$manipulatorEl.addClass("selected");this.$activeManipulator=$manipulatorEl}this.model.scene.triggerDirty()},toggleManipulators:function(e){var $el=$(e.currentTarget);var $operatorEl=$el.parents("li").find(".operator");var $plugEl=$el.parents(".plug");var plug=this.node.plugs.get($plugEl.attr("id"));var operator=plug.operators.get($operatorEl.attr("id"));operator.expandedManipulators=!operator.expandedManipulators;if($el.hasClass("icon-chevron-right")){$el.removeClass("icon-chevron-right").addClass("icon-chevron-down")}else{$el.removeClass("icon-chevron-down").addClass("icon-chevron-right")}},clearSelectedManipulator:function(){if(this.node)this.model.selectManipulator(this.node,null);this.$el.find(".operator-manipulator").removeClass("selected");this.$activeManipulator=null},addOperator:function(e){var operator=$(e.currentTarget).val();if(operator){var $plugEl=$(e.target).parents(".plug");var plug=this.node.plugs.get($plugEl.attr("id"));var propertyView=this;this.model.getCtx()(plug).addOperator(operator)}},removeOperator:function(e){var plug=this.node.plugs.get($(e.target).parents(".plug").attr("id"));var operator=plug.operators.get($(e.currentTarget).data("id"));this.model.getCtx()(operator).remove()},collapseMesh:function(e){var plug=this.node.plugs.get($(e.target).parents(".plug").attr("id"));exo.geometry.PolyMeshUtilities.collapseMesh(plug)},addNode:function(e){var name=$(e.currentTarget).val();if(name){var node=this.node.addNode(name,name);this.model.clearSelection();this.model.select(node)}},closeViews:function(plug){if(plug.activeOperator){_.each(this.propertyViews[plug.activeOperator.id],function(propView,key){propView.close()})}},dragEnterOperator:function(e){if(!this.opDragSource){this.opDragSource=e.currentTarget;$(this.opDragSource).hide()}e.stopPropagation();e.preventDefault()},dragOverOperator:function(e){if(this.dragTarget){$(this.dragTarget).removeClass("drag-target");this.dragTarget=null}var sourceOperator=this.elementToOperator(this.opDragSource);var destOperator=this.elementToOperator(e.currentTarget);if(sourceOperator!==destOperator){this.dragTarget=e.currentTarget;$(e.currentTarget).addClass("drag-target")}e.stopPropagation();e.preventDefault()},dragLeaveOperator:function(e){e.stopPropagation();e.preventDefault()},dragEndOperator:function(e){if(this.dragTarget){$(this.dragTarget).removeClass("drag-target");this.dragTarget=null}$(this.opDragSource).show();this.opDragSource=null;e.stopPropagation();e.preventDefault()},dropOperator:function(e){var sourceOperator=this.elementToOperator(this.opDragSource);var destOperator=this.elementToOperator(e.currentTarget);if(sourceOperator!==destOperator){var operators=destOperator.collection;var operatorsArray=operators.toArray().splice(1);var sourceIndex=operatorsArray.indexOf(sourceOperator);var destIndex=operatorsArray.indexOf(destOperator);if(sourceIndex!==-1){operators.remove(operatorsArray);operatorsArray.splice(destIndex+1,0,operatorsArray.splice(sourceIndex,1)[0]);operators.add(operatorsArray);this.setActiveOperator(sourceOperator.plug(),sourceOperator);this.rerender()}}$(this.opDragSource).show();this.opDragSource=null;e.stopPropagation();e.preventDefault()},elementToOperator:function(el){var plug=this.node.plugs.get($(el).parents(".plug").attr("id"));var operator=plug.operators.get(el.id);if(!operator){el=$(el).children(".operator")[0];operator=plug.operators.get(el.id)}return operator}});exo.ui.views.ResultItem=highbrow.extend("ItemView","ResultItem",{tagName:"tgroup",events:{"click .delete-result":"deleteResult"},deleteResult:function(e){e.preventDefault();this.model.destroy()},onRender:function(e){if(this.model.get("failed")){this.$el.addClass("failed")}}});exo.ui.views.Results=highbrow.extend("CollectionView","Results",{itemView:exo.ui.views.ResultItem,initialize:function(){this.model.results.scene=this.model;this.collection=this.model.results;this.collection.on("add",function(){this.updateTitle()},this);this.collection.on("remove",function(){this.updateTitle()},this);this.collection.on("change",function(model){var content=model.get("content");if(model.get("done")&&!model.get("failed")&&(content===null||content===undefined||content===false||content===true||content==="")){this.collection.remove(model)}else{this.children[model.cid].render()}this.updateTitle()},this)},data:function(){return{sceneId:this.options.model.id,sceneName:this.options.model.get("name")}},onRender:function(){this.$tabTitle=$("#results-option a");this.updateTitle()},updateTitle:function(){var memo=this.collection.reduce(function(memo,model){if(model.get("done")){if(model.get("failed"))memo.error+=1;else memo.done+=1}else{memo.pending+=1}return memo},{error:0,pending:0,done:0});var title=this.collection.length?"Jobs ":"";if(memo.error>0){title+='<span class="badge badge-important">'+memo.error+"</span>"}else if(memo.pending>0){title+='<span class="badge badge-info">'+memo.pending+"</span>"}else if(memo.done>0){title+='<span class="badge">'+memo.done+"</span>"}this.$tabTitle.html(title)},appendHtml:function(el,html){this.$("table.results tbody").append(html)}});exo.ui.views.Assets=highbrow.extend("ItemView","Assets",{initialize:function(){this.initSelection();_.bindAll(this);this.model.on("new",this.initSelection.bind(this));this.bindTo(this.model.scene.files,"add",this.model.callWhenDone(this.rerender,this),this);this.bindTo(this.model.scene.files,"change:disabled",this.model.callWhenDone(this.rerender,this),this)},initSelection:function(){this.sceneExplorer=this.options.sceneExplorer;this.watchName(this.model.scene.files);this.rerender()},watchName:function(node){node.each(function(n){n.on("change:name",function(n,name){this.$('[data-id="'+n.id+'"] span').text(name)},this)},this)},events:{"click .toggle-assets":"toggleAssets","click .explorer-menu":"popupContext","contextmenu .select-node":"popupContext","click .select-node":"selectNode"},selectNode:function(e){var id=$(e.currentTarget).data("id");var node=this.model.scene.files.get(id);if(!node)return;this.model.clearSelection();this.model.trigger("selected",node);this.sceneExplorer.selectCollection(node,this.$el)},onRender:function(){this.showAssets(this.model.get("assetsShown"))},toggleAssets:function(e){this.showAssets(!this.model.get("assetsShown"))},showAssets:function(shown){var $target=this.$el.find(".toggle-assets .toggler");if(shown!==this.model.get("assetsShown")){this.model.set("assetsShown",shown)}if(shown){$target.removeClass("icon-chevron-right").addClass("icon-chevron-down")}else{$target.removeClass("icon-chevron-down").addClass("icon-chevron-right")}this.$el.find("#assets-body").toggle(shown)},popupContext:function(e){var id=$(e.currentTarget).data("id");if(!id){var $el=$(e.currentTarget).parents(".select-node");id=$el.data("id")}var node=this.model.scene.files.get(id);if(!node)return;this.model.clearSelection();this.model.trigger("selected",node);this.sceneExplorer.selectCollection(node,this.$el);this.contextMenu=exo.ui.views.SceneExplorerContext.create({previous:this.contextMenu,editor:this.model,event:e,model:node});return false}});exo.ui.views.SceneExplorer=highbrow.extend("ItemView","SceneExplorer",{initialize:function(){this.initSelection();_.bindAll(this);this.model.on("new",this.initSelection.bind(this))},onShow:function(){this.throttledRender=$.throttle(1e3,this.render)},onRender:function(){this.waiting=false;if(!this.model.selected.length){if(this.model.modelSelection){this.selectCollection(this.model.modelSelection)}else{this.selectCollection(this.model.scene)}}this.assets=new exo.ui.views.Assets({model:this.model,el:this.$el.find(".assets"),sceneExplorer:this});this.assets.render()},initSelection:function(){var addNodeHandler=function(node){this.render();if(!node.selectable){this.model.clearSelection();this.selectCollection(node)}};this.model.scene.on("addNode",function(node){this.watchName(node);this.model.callWhenDone(addNodeHandler,this)(node)},this);this.model.scene.on("removeNode",function(node){this.model.callWhenDone(this.render,this)()},this);this.model.selected.on("add",function(node){this.deselectCollection();this.$('[data-id="'+node.id+'"]').addClass("selected")},this);this.model.selected.on("remove",function(node){this.deselectCollection();this.$('[data-id="'+node.id+'"]').removeClass("selected");if(!this.model.selected.length){this.selectCollection(this.model.scene)}},this);this.watchName(this.model.scene);this.rerender()},watchName:function(node){node.each(function(n){n.on("change:name",function(n,name){this.$('[data-id="'+n.id+'"] .node-name').text(name)},this)},this)},events:{"click .select-node":"selectNode","click .toggle-children":"toggleChildren","click .explorer-menu":"popupContext","contextmenu .select-node":"popupContext","dragstart .select-node":"dragStartNode","dragenter .select-node":"dragEnterNode","dragover .select-node":"dragOverNode","dragleave .select-node":"dragLeaveNode","dragend .select-node":"dragEndNode","drop .select-node":"dropNode"},selectCollection:function(node,$el){$el=$el||this.$el;
if(this.$selectedCollection)this.$selectedCollection.removeClass("selected");this.$selectedCollection=$el.find('[data-id="'+node.id+'"]').addClass("selected")},deselectCollection:function(){if(this.$selectedCollection){this.$selectedCollection.removeClass("selected");this.$selectedCollection=null}},selectNode:function(e){var $target=$(e.currentTarget);var id=$target.data("id");var node=this.model.scene.getNodeById(id);if(!node)return;if(!node.selectable){this.model.clearSelection();this.model.select(node);this.selectCollection(node)}else{if(e.shiftKey){this.selectUntil($target)}else if(e.ctrlKey||e.metaKey){this.model.toggleSelection(node)}else{this.model.clearSelection();this.model.select(node)}}},selectUntil:function($target){var lastSelected=this.model.selected.last();if(!lastSelected)return;var id=$target.data("id");var node=this.model.scene.getNodeById(id);var $lastSelectedEl,$targetParent=$target.parent(),$children=$targetParent.parent().children();var editor=this.model;$targetParent.siblings().each(function(){var $el=$(this);if($el.find(".select-node").data("id")===lastSelected.id){$lastSelectedEl=$el}});var $first=$children.index($lastSelectedEl)<$children.index($targetParent)?$lastSelectedEl:$targetParent;var $last=$first===$lastSelectedEl?$targetParent:$lastSelectedEl;$first.nextUntil($last).each(function(){var id=$(this).find(".select-node").data("id");editor.select(editor.scene.getNodeById(id))});editor.select(node)},toggleChildren:function(e){var $target=$(e.currentTarget);var id=$target.parents(".select-node").data("id");var node=this.model.scene.getNodeById(id);node.collapsedChildren=!node.collapsedChildren;if(!node.collapsedChildren){$target.removeClass("icon-chevron-right").addClass("icon-chevron-down")}else{$target.removeClass("icon-chevron-down").addClass("icon-chevron-right")}},popupContext:function(e){var $target=$(e.currentTarget);var id=$target.data("id");var node=this.model.scene.getNodeById(id);if(!node)return;if(!this.model.selected._byId[id]){this.selectNode(e)}this.contextMenu=exo.ui.views.SceneExplorerContext.create({previous:this.contextMenu,editor:this.model,event:e});return false},isDraggingFiles:function(e){return e.dataTransfer&&e.dataTransfer.types&&Array.prototype.indexOf.call(e.dataTransfer.types,"Files")!==-1},dragStartNode:function(e){var id=$(e.currentTarget).data("id");e.dataTransfer.setData("Text",id);if(!this.dragSource&&!this.model.selected._byId[id]){this.selectNode(e)}this.dragSource=e.currentTarget},dragEnterNode:function(e){if(this.dragSource&&!this.isDraggingFiles(e)){var node=this.elementToNode(e.currentTarget);if(node){this.draggingOther=true;e.stopPropagation();e.preventDefault()}}},dragOverNode:function(e){if(this.dragTarget){$(this.dragTarget).find(".node-container").removeClass("drag-target");this.dragTarget=null}var parentNode=this.elementToNode(e.currentTarget);if(parentNode&&parentNode.canAddChild(this.elementToNode(this.dragSource))){this.dragTarget=e.currentTarget;$(e.currentTarget).find(".node-container").addClass("drag-target")}e.stopPropagation();e.preventDefault()},dragLeaveNode:function(e){e.stopPropagation();e.preventDefault()},dropNode:function(e){if(this.dragSource){var target=this.elementToNode(e.currentTarget);var selected=this.model.selected.toArray();_.each(selected,function(source){if(!(source instanceof exo.sceneGraph.nodes.Material)){source.ctx().reparent(target)}if(target instanceof exo.sceneGraph.nodes.Material&&source.Material){source.ctx().find("#Material[reference]").set("reference",target.id)}},this);var source=this.model.modelSelection;if(source instanceof exo.sceneGraph.nodes.Material&&target.Material){var lastReferenceOp=target.Material.getLastReferenceOp();if(lastReferenceOp){target.ctx().find("#Material[reference]").set("reference",source.id)}}this.dragSource=null}this.draggingOther=false;e.stopPropagation();e.preventDefault()},dragEndNode:function(e){if(this.dragTarget){$(this.dragTarget).find(".node-container").removeClass("drag-target");this.dragTarget=null}if(this.dragSource){$(this.dragSource).parent().show();this.dragSource=null}this.draggingOther=false;e.stopPropagation();e.preventDefault()},elementToNode:function(el){var $el=$(el),id;if(!$el.hasClass(".select-node")){var parents=$el.parents(".select-node");if(parents.length){$el=$(parents[0])}}id=$el.data("id");return id?this.model.scene.getNodeById(id):null}});exo.ui.views.SceneExplorerContext=exo.ui.views.ContextMenuView.extend({name:"SceneExplorerContext",data:function(){return new exo.ui.vm.Node(this.node,this.error)},events:{"click .add-node":"addNode","click .delete-node":"deleteNode","click .command":"command"},moveToParent:true,parentClassName:"select-node",addNode:function(e){e.preventDefault();var type=$(e.currentTarget).data("type");var contextView=this;this.node.ctx().addNode(type,type).then(function(node){contextView.editor.clearSelection();contextView.editor.select(node);contextView.detach()})},deleteNode:function(e){e.preventDefault();this.editor.deselect(this.node);this.node.ctx().remove();this.detach()}},{place:"sceneExplorer"});exo.ui.views.SceneExplorerContext.create=exo.ui.views.ContextMenuView.create;exo.ui.views.Script=highbrow.extend("ItemView","Script",{initialize:function(){_.bindAll(this);Mousetrap.bind("command+e",this.exec);this.initScriptsCollection()},initScriptsCollection:function(){this.collection=this.collection||new exo.models.Scripts;if(!this.collection.length)this.addNewScript();this.active=0},data:function(){return{scripts:this.collection.map(function(script,i){return{i:i.toString(),name:script.get("name"),active:this.active===i}},this),name:this.collection.length?this.collection.at(this.active).get("name"):""}},events:{"click .exec":"exec","click .next":"nextScript","click .prev":"prevScript","click .add-script":"addScript","click .remove-script":"removeScript","click .change-script":"changeScript","keydown .script-name":"changeScriptName",contextmenu:"contextMenu"},nextScript:function(e){this.active=this.active>=this.collection.length-1?0:this.active+1;this.update()},prevScript:function(e){this.active=this.active===0?this.collection.length-1:this.active-1;this.update()},changeScriptName:function(e){var esc=event.which===27,nl=event.which===13;if(esc){document.execCommand("undo");e.target.blur()}else if(nl){e.preventDefault();e.target.blur();this.collection.at(this.active).set("name",e.currentTarget.innerHTML);this.update()}},removeScript:function(e){e.preventDefault();var idx=Number($(e.target).parent().data("script"));if(idx<=this.active)this.active=this.active-1;this.collection.remove(this.collection.at(idx));if(this.collection.length===0){this.addNewScript()}this.update()},addNewScript:function(){var name="Script "+(this.collection.length+1);this.collection.add({content:"",name:name});this.active=this.collection.length-1},addScript:function(e){e.preventDefault();var prev=this.active;this.addNewScript();this.update(prev)},update:function(prev){if(prev!==undefined)this.collection.at(prev).set("content",this.editor.getValue());this.$(".header").html(nct.render("editor/script_header",this.data()));this.editor.setValue(this.collection.at(this.active).get("content"))},changeScript:function(e){e.preventDefault();if($(e.target).hasClass("remove-script"))return;var prev=this.active;this.active=$(e.currentTarget).data("script");this.update(prev)},onShow:function(){var el=this.$(".code")[0];this.editor=CodeMirror(el,{mode:"javascript",theme:"lesser-dark",lineNumbers:true,matchBrackets:true,extraKeys:{"Cmd-/":this.executeScript,"Cmd-.":this.executeSelected},value:this.collection.at(this.active).get("content")});this.editor.on("change",this.onChange.bind(this))},onChange:function(){if(this.collection.length){this.collection.at(this.active).set({content:this.editor.getValue()})}},exec:function(){exo.api.pluginRegistry.execScript(this.editor.getSelection()||this.editor.getValue(),this.model)},contextMenu:function(e){e.stopPropagation()}});exo.ui.views.Timeline=highbrow.extend("ItemView","Timeline",{initialize:function(){this.updating=false;this.draggingMarker=false;this.minorIncrement=exo.ui.views.Timeline.DEFAULT_MINOR_INCREMENT;this.majorIncrement=exo.ui.views.Timeline.DEFAULT_MAJOR_INCREMENT;this.initTimeline();this.model.on("new",this.initTimeline.bind(this));this.model.selected.on("add",this.updateNode,this);this.model.on("selected",this.updateNode,this);$(window).on("resize",this.onResize.bind(this));$(window).on("mouseup",this.stopDraggingMarker.bind(this));$(window).on("mousemove",this.dragMarker.bind(this))},initTimeline:function(){this.timeline=this.model.scene.plugs.Timeline;this.timeline.on("change:currentFrame",this.positionMarker,this);this.timeline.on("change:currentFrame",this.jumpInTime,this);this.timeline.on("change:playing",defer(1,this.rerender,this));this.timeline.on("dirty",defer(1,this.rerender,this));this.keyFrames={}},view:function(){return{playing:this.timeline.playing}},events:{"click .play":"play","click .pause":"pause","click .stop":"stop","mousedown .ruler":"startDragging","mousedown .key-frame":"startDragging"},play:function(e){this.model.set("loadingCommand",true);this.timeline.play()},pause:function(e){this.timeline.pause();this.model.set("loadingCommand",false)},stop:function(e){this.timeline.stop();this.timeline.gotoPercentage(0);this.model.set("loadingCommand",false)},gotoTime:function(e){var percentage=(e.pageX-this.$ruler.offset().left)/this.$ruler.width();this.timeline.gotoPercentage(percentage)},startDragging:function(e){var time=this.getTime(e);if(this.keyFrames[time]){this.draggingKeyFrames={time:time,keyFrames:this.keyFrames[time]}}else{this.gotoTime(e);this.draggingMarker=true}return false},setKeyFrame:function(e){var oldTime=this.draggingKeyFrames.time;var newTime=this.getTime(e);if(newTime!==oldTime){delete this.keyFrames[oldTime];this.keyFrames[newTime]=this.draggingKeyFrames.keyFrames;this.draggingKeyFrames.time=newTime;_.each(this.draggingKeyFrames.keyFrames,function(keyFrame){keyFrame.model.ctx().moveKeyFrame(keyFrame.key,oldTime,newTime)},this);this.movedKeyFrames=true}},getTime:function(e){var percentage=(e.pageX-this.$ruler.offset().left)/this.$ruler.width();return e.currentTarget.id?parseInt(e.currentTarget.id,10):Math.round(percentage*this.timeline.primitive.getDuration())},updateNode:function(model){if(this.node&&this.node.plugs){this.node.plugs.each(function(plug){plug.off("add:keyFrame",this.updateNode,this);plug.off("remove:keyFrame",this.updateNode,this)},this)}if(model){this.node=model.node?model.node():model}this.keyFrames={};if(this.node&&this.node.plugs){this.addKeyFrames(this.node);this.node.plugs.each(function(plug){plug.on("add:keyFrame",this.updateNode,this);plug.on("remove:keyFrame",this.updateNode,this)},this)}this.rerender()},addKeyFrames:function(model){var kf;_.each(model.schema,function(attr,name){if(attr&&attr.animatable&&attr.hasKeyFrames()){_.each(attr.keyFrames(),function(key){this.keyFrames[key.t]=this.keyFrames[key.t]||[];if(!_.find(this.keyFrames[key.t],function(info){return info.key===name})){this.keyFrames[key.t].push({model:model,key:name})}},this)}},this);if(model.plugs){model.plugs.each(this.addKeyFrames,this)}if(model.operators){model.operators.each(this.addKeyFrames,this)}},onRender:function(){this.$ruler=this.$el.find(".ruler");this.$controls=this.$el.find(".controls");this.$marker=this.$el.find(".marker");this.$increments=this.$el.find(".increments");this.$keyFrames=this.$el.find(".key-frames");this.calcRulerSize();this.onRulerChanged();this.$marker.on("mouseover",function(){var time=this.timeline.currentFrame;this.$marker.tooltip("destroy");if(!this.draggingMarker){if(this.keyFrames[time]){this.$marker.tooltip({title:this.getKeyframeInfo(this.keyFrames[time],time)})}else{this.$marker.tooltip({title:"Frame: "+time})}}}.bind(this))},onRulerChanged:function(){this.createIncrements();this.positionMarker()},onResize:function(){this.width=this.$ruler.width();this.markerWidth=this.$marker.width();this.positionIncrements();this.calcRulerSize();this.positionMarker()},calcRulerSize:function(){this.$ruler.width(this.$el.width()-this.$controls.width());this.$ruler.height(this.$el.height());this.width=this.$ruler.width();this.markerWidth=this.$marker.width()},dragMarker:function(e){if(this.draggingKeyFrames){this.setKeyFrame(e)}else if(this.draggingMarker){this.gotoTime(e)}return false},stopDraggingMarker:function(e){this.destroyTooltips();if(this.draggingKeyFrames&&!this.movedKeyFrames){this.gotoTime(e)}this.movedKeyFrames=false;this.draggingMarker=false;this.draggingKeyFrames=null},createIncrements:function(){var cssClass,i;this.$increments.html(" ");for(i=this.minorIncrement;i<this.timeline.primitive.animationEndFrame;i+=this.minorIncrement){cssClass=i%this.majorIncrement===0?"major":"minor";this.$increments.append('<span class="increment '+cssClass+'"></div>')}_.each(this.keyFrames,function(keyFrame,time){this.$keyFrames.append('<span class="key-frame" id="'+time+'"></div>')},this);this.positionIncrements()},positionIncrements:function(){var i;var length=this.timeline.primitive.getDuration();var incrementSize=this.minorIncrement/length*this.width;var childNum;var keyFrameTime;var left;for(i=this.minorIncrement;i<this.timeline.primitive.animationEndFrame;i+=this.minorIncrement){childNum=parseInt(i/this.minorIncrement,10);left=childNum*incrementSize-this.markerWidth;if(left<0)left=0;if(left>this.width)left=this.width;$(this.$increments.children()[childNum-1]).css({left:left})}i=0;_.each(this.keyFrames,function(keyFrame,time){var left=time/length*this.width-this.markerWidth;if(left<0)left=0;if(left>this.width)left=this.width;var $keyFrame=$(this.$keyFrames.children()[i]).css({left:left});$keyFrame.on("mouseover",function(){if(this.$tooltip){this.$tooltip.tooltip("destroy");this.$tooltip=null}if(!this.draggingKeyFrames&&!this.draggingMarker){$keyFrame.tooltip({title:this.getKeyframeInfo(keyFrame,time)});this.$tooltip=$keyFrame}}.bind(this));i++},this)},destroyTooltips:function(){if(this.$tooltip||this.$marker){$(".tooltip").remove()}if(this.$tooltip){this.$tooltip.tooltip("destroy");this.$tooltip=null}if(this.$marker){this.$marker.tooltip("destroy")}},getKeyframeInfo:function(keyFrameProps,time){var title="Frame: "+time;_.each(keyFrameProps,function(keyFrameProp,index){var value=this.getValue(keyFrameProp,time);var strValue=JSON.stringify(value.toJSON?value.toJSON():value.toArray?value.toArray():value,null,"	");var name=keyFrameProp.model.get("name")||keyFrameProp.model.get("type");title+='<div class="divider"></div>'+name+": "+keyFrameProp.key+"<br />Value: "+strValue},this);return title},getValue:function(keyFrameProp,time){return keyFrameProp.model.getAt(keyFrameProp.key,time)},positionMarker:function(){var left=this.timeline.percentageComplete()*this.width-this.markerWidth;var time=this.timeline.currentFrame;if(left<0)left=0;if(left>this.width)left=this.width;this.$marker.css({left:left});if(this.keyFrames[time]){this.$marker.addClass("keyframed")}else{this.$marker.removeClass("keyframed")}}},{DEFAULT_MINOR_INCREMENT:5,DEFAULT_MAJOR_INCREMENT:20});exo.ui.views.Toolbar=exo.ui.views.CommandsView.extend({name:"Toolbar",onRender:function(){this.$el.find("#Polygons").addClass("active");this.$el.find("#Polygons-option").addClass("active");this.update()},appendHtml:function(el,html,model){var path=model.get("path");var panel=el.find("div#"+path+" ul");if(panel.length===0){el.find(".panel-header ul").append('<li id="'+path+'-option"><a href="#'+path+'" data-toggle="tab">'+path+"</a></li>");panel=$('<div id="'+path+'" class="tab-pane"><ul class="nav nav-pills nav-buttons"></ul></div>');el.find(".panel-body").append(panel);panel=panel.find("ul")}panel.append(html)}},{place:"toolbar"});exo.ui.views.ViewportsContext=exo.ui.views.ContextMenuView.extend({name:"ViewportsContext",moveToParent:false,data:function(){return new exo.ui.vm.Node(this.node,this.error)}},{place:"viewportsContext"});exo.ui.views.ViewportsContext.create=exo.ui.views.ContextMenuView.create;exo.ui.views.Viewport=highbrow.extend("ItemView","Viewport",{initialize:function(){this.widthSafeView=0;this.heightSafeView=0;this.displayScene=this.options.displayScene;this.editor=this.options.editor;this.$el.addClass(this.model.get("fullscreen")?"fullscreen":this.model.get("position"));if(!this.model.get("visible"))this.$el.hide();this.canvas=this.options.canvas;this.$canvas=$(this.canvas);this.model.on("change",function(){this.rerender()},this);this.model.on("change:visible",this.toggleVisible,this);this.model.on("change:fullscreen",this.toggleFullscreen,this);this.model.on("new",this.render.bind(this));this.model.scene.on("addNode",function(node){if(node.get("type")==="Camera"){this.editor.callWhenDone(this.rerender,this)()}},this);this.model.scene.on("removeNode",function(node){if(node.get("type")==="Camera"){if(node===this.model.camera){this.model.set("viewType","perspective")}this.editor.callWhenDone(this.rerender,this)()}},this);$(window).on("mouseup",this.handleMouseUp.bind(this));this.model.on("switch:camera",this.updateCameraName,this);this.model.scene.files.on("doneLoading",defer(0,this.rerender,this));this.model.scene.on("objectsLoaded",defer(0,this.onLoaded,this));this.model.scene.on("loaded",defer(0,this.frameAllMeshes,this))},className:"viewport",events:{"click .switch-camera":"switchCamera","click .switch-preset-camera":"switchPresetCamera","click .switch-displayType":"switchDisplayType","click .toggle-edges":"toggleEdges","click .toggle-grid":"toggleGrid","click .toggle-stats":"toggleStats","click .resize":"resize","click .frame-all":"frameAll","click .frame-selection":"frameSelection","click .camera-properties":"cameraProperties"},updateCameraName:function(){var name=this.model.camera.get("name");this.$el.find("a.selected-camera").html(name)},onRender:function(){this.updateStats(this.model,this.model.get("statsVisible"))},onLoaded:function(){this.rerender();this.frameAllMeshes()},updateStats:function(model,visible){if(visible){if(!this.statsView){this.statsView=new exo.ui.views.Stats({model:this.editor.stats})}this.$el.append(this.statsView.el);this.statsView.show()}else{if(this.statsView)this.statsView.hide()}},resizeCameraViewport:function(){if(!this.isCameraDefault()){this.calcSize()}},switchCamera:function(e){e.preventDefault();var id=$(e.currentTarget).data("camera");var camera=this.displayScene.useCamera(id);this.model.setCamera(camera);this.model.camera.plugs.Camera.on("dirty",function(){this.resizeCameraViewport()},this);this.calcSize()},switchPresetCamera:function(e){e.preventDefault();var viewType=$(e.currentTarget).data("camera");this.model.set("viewType",viewType);this.calcSize()},switchDisplayType:function(e){e.preventDefault();var renderType=$(e.currentTarget).data("display");this.model.set("renderType",renderType)},toggleEdges:function(e){e.preventDefault();var edgesShown=$(e.currentTarget).data("edges");this.model.set("edges",!edgesShown)},toggleStats:function(e){e.preventDefault();this.model.set("statsVisible",!this.model.get("statsVisible"))},toggleGrid:function(e){e.preventDefault();var gridVisible=$(e.currentTarget).data("grid");this.model.set("gridVisible",!gridVisible)},toggleFullscreen:function(model,full){this.$el[full?"removeClass":"addClass"](model.get("position"));this.$el[full?"addClass":"removeClass"]("fullscreen");this.calcSize()},toggleVisible:function(model,visible){this.$el.toggle();this.calcSize()},resize:function(e){e.preventDefault();this.model.set("fullscreen",!this.model.get("fullscreen"));this.trigger("resize",this)},calcSize:function(){var fullscreen=this.model.get("fullscreen"),x=0,y=0,width=0,height=0;width=this.$el.width();height=this.$el.height();if(!fullscreen){x=this.$el.position().left;y=height-this.$el.position().top}var widthCamera=width;var heightCamera=height;this.heightSafeView=0;this.widthSafeView=0;var cameraNode=this.model.camera;if(cameraNode&&!this.isCameraDefault(cameraNode)){var aspect=cameraNode.camera.aspectRatio;var viewAspect=width/height;if(viewAspect!==aspect){if(aspect>viewAspect){heightCamera=width/aspect}else if(aspect<viewAspect){widthCamera=height*aspect}if(heightCamera>0){this.heightSafeView=(height-heightCamera)/2}if(widthCamera>0){this.widthSafeView=(width-widthCamera)/2}this.$el.find(".safeview-camera").css({left:this.widthSafeView,top:this.heightSafeView,width:widthCamera,height:heightCamera})}else{}}var rect=new exo.shapes.Rectangle(x+this.widthSafeView,y+this.heightSafeView,widthCamera,heightCamera);this.model.set("rect",rect);return rect},showSafeView:function(){var safeViewStatus=false;return function(enableSafeView){if(enableSafeView){this.$el.find(".safeview-camera").show();safeViewStatus=true}else if(safeViewStatus){this.$el.find(".safeview-camera").hide();safeViewStatus=false}}}(),isCameraDefault:function(cameraNode){if(!cameraNode){cameraNode=this.model.camera}if(cameraNode&&!cameraNode.scene()){return true}return false},findNodes:function(e,firstOnly){var selectionBox=this.selectionBox||this.createSelectionBox(e);if(selectionBox.width>=2||selectionBox.height>=2){var screenRect=this.getScreenRect(this.model.get("rect"),selectionBox);return this.displayScene.findNodesInArea(screenRect,this.model.camera.id)}else{var vector=this.getVector(this.model.get("rect"),selectionBox);return this.displayScene.findNodes(vector,this.model.camera.id,firstOnly)}},findGizmoPart:function(e){var selectionBox=this.selectionBox||this.createSelectionBox(e);var screenRect=this.getScreenRect(this.model.get("rect"),selectionBox);return this.displayScene.findGizmos(screenRect,this.model)},findSubObjectGizmoParts:function(e){var selectionBox=this.selectionBox||this.createSelectionBox(e);var screenRect=this.getScreenRect(this.model.get("rect"),selectionBox);return this.displayScene.findInSubObjectGizmo(screenRect,this.model,selectionBox.width>=2||selectionBox.height>=2)},getScreenRect:function(rect,selectionBox){var recWidth=rect.width!==0?rect.width:exo.math.EPSILON;var recHeight=rect.height!==0?rect.height:exo.math.EPSILON;var x=selectionBox.x/recWidth*2-1;var y=(1-selectionBox.y/recHeight)*2-1;var width=selectionBox.width/recWidth*2;var height=selectionBox.height/recHeight*2;y-=height;return{x:x,y:y,width:width,height:height}},getVector:function(rect,selectionBox,threeCamera){var x=selectionBox.x/(rect.width!==0?rect.width:exo.math.EPSILON)*2-1;var y=-(selectionBox.y/(rect.height!==0?rect.height:exo.math.EPSILON))*2+1;return new THREE.Vector3(x,y,.5)},handleSelection:function(e,firstOnly){var nodesFound=this.findNodes(e,firstOnly);if(nodesFound.length===0){nodesFound=null}if(!(e.ctrlKey||e.metaKey||e.altKey)&&(nodesFound||this.editor.selected.length)){this.editor.clearSelection()}_.each(nodesFound,function(selectable){if(e.altKey){this.editor.deselect(selectable.displayNode.node)}else if(!this.editor.selected.where({_id:selectable.displayNode.node.id}).length){this.editor.select(selectable.displayNode.node)}},this);return nodesFound},handleSubSelection:function(e,clearSubSelection){var partsFound=this.findSubObjectGizmoParts(e);var type=this.editor.subSelection.get("type");var objectsChecked={};var ctrlKey=e.ctrlKey||e.metaKey,altKey=e.altKey;var noCtrlAlt=!(ctrlKey||altKey);if(noCtrlAlt&&(partsFound.length>0||clearSubSelection)){this.editor.subSelection.clear()}if(partsFound.length<1){return null}_.each(partsFound,function(part){if(!objectsChecked[part.object]){var subObjects=null;var toAdd=[],toRemove=[];if(type==="Vertex"){subObjects=part.vertices}else if(type==="Face"){subObjects=part.faces}else if(type==="Edge"){subObjects=part.edges}_.each(subObjects,function(index){if(!ctrlKey&&altKey){toRemove.push(index)}else{toAdd.push(index)}},this);if(toAdd.length){this.editor.subSelection.add(toAdd)}else if(toRemove.length){this.editor.subSelection.remove(toRemove)}objectsChecked[part.object]=toAdd.length||toRemove.length}},this);return partsFound},hasSubSelection:function(){return this.editor.selected.length===1&&this.editor.subSelection.get("type")!=="Object"},handleMouseDown:function(e){var mouseButton=e.mouseButton||e.which||0;var $target=$(e.target);var nodesFound=null,subObjectsFound=null;if(mouseButton===1&&($target.is(this.$el)||$target.is("canvas"))){this.selectionBox=this.createSelectionBox(e);if(this.hasSubSelection()){if(!e.ctrlKey){subObjectsFound=this.handleSubSelection(e,false)}else{subObjectsFound=null}}else{nodesFound=this.handleSelection(e,true)}}return subObjectsFound||nodesFound},handleMouseMove:function(e){this.updateSelectionBox(e)},handleMouseMoveCursor:function(e,gizmoSelected,nodesSelected,subObjectSelected){var subObjectsFound,nodesFound,gizmoFound;if(this.selectionBox){return}if(this.editor.hasAnySelection()){if(gizmoSelected!==undefined){gizmoFound=gizmoSelected}else{gizmoFound=this.findGizmoPart(e)}}if(gizmoFound){this.$el.parent().parent().css("cursor","move")}else{if(this.hasSubSelection()){subObjectsFound=subObjectSelected!==undefined?subObjectSelected:this.findSubObjectGizmoParts(e)}else{nodesFound=nodesSelected!==undefined?nodesSelected:this.findNodes(e)}if(subObjectsFound&&subObjectsFound.length>0||nodesFound&&nodesFound.length>0){this.$el.parent().parent().css("cursor","crosshair")}else{this.$el.parent().parent().css("cursor","auto")}}},handleMouseUp:function(e){var nodesFound=null,subObjectsFound=null;if(this.selectionBox){if(this.hasSubSelection()){subObjectsFound=this.handleSubSelection(e,true)}else{nodesFound=this.handleSelection(e,false)}this.$(".drag-selection").hide();this.selectionBox=undefined;this.$el.parent().parent().css("cursor","auto")}return nodesFound},createSelectionBox:function(e){var position=this.getMousePosition(e);return{startX:position.x,startY:position.y,x:position.x,y:position.y,width:1,height:1}},updateSelectionBox:function(e){if(this.selectionBox){var position=this.getMousePosition(e);var viewWidth=this.$el.width()-2,viewHeight=this.$el.height()-2;var top=Math.max(-this.heightSafeView,Math.min(position.y,this.selectionBox.startY));var left=Math.max(-this.widthSafeView,Math.min(position.x,this.selectionBox.startX));var bottom=Math.min(viewHeight-this.heightSafeView,Math.max(position.y,this.selectionBox.startY));var right=Math.min(viewWidth-this.widthSafeView,Math.max(position.x,this.selectionBox.startX));var width=Math.abs(right-left),height=Math.abs(bottom-top);this.selectionBox.x=left;this.selectionBox.y=top;this.selectionBox.width=width;this.selectionBox.height=height;this.$(".drag-selection").show();this.$(".drag-selection").css({left:left+this.widthSafeView,top:top+this.heightSafeView,width:width,height:height});this.$el.parent().parent().css("cursor","crosshair")}},getMousePosition:function(e){var position=this.$el.offset();return{x:e.clientX-position.left-this.widthSafeView,y:e.clientY-position.top-this.heightSafeView}},frameAllMeshes:function(e){this.editor.frameAllMeshes(this)},frameAll:function(e){this.editor.frameAll(this)},frameSelection:function(e){this.editor.frameSelection(this)},cameraProperties:function(){this.editor.subSelection.clear();this.editor.clearSelection();this.editor.trigger("selected",this.model.camera)}});exo.ui.views.Viewports=highbrow.extend("ItemView","Viewports",{initialize:function(){this.quality="medium";this.panFactor=3;this.wheelZoomFactor=.1;this.smoothZoomFactor=.2;var that=this;$(window).on("focus",function(){if(that.displayScene){that.displayScene.version++;that.displayScene.update()}});$(window).on("mousedown",this.handleMouseDownWindow.bind(this));$(window).on("mouseup",this.handleMouseUp.bind(this));$(window).on("mousemove",this.handleMouseMove.bind(this));var renderEachViewport=function(){_.each(this.viewports,function(viewport){viewport.rerender()},this)};this.model.scene.on("addNode",function(node){if(node.get("type")==="Camera"){this.model.callWhenDone(renderEachViewport,this)()}},this);this.model.scene.on("removeNode",function(node){if(node.get("type")==="Camera"){this.model.callWhenDone(renderEachViewport,this)()}},this);this.bindHotkeys();this.model.on("new",this.createDisplayScene.bind(this))},events:{"mousedown canvas":"handleMouseDown","mousewheel canvas":"handleMouseWheel","DOMMouseScroll canvas":"handleMouseWheel","contextmenu canvas":"popupContext","dragenter canvas":"dragEnterNode","dragover canvas":"dragOverNode","dragleave canvas":"dragLeaveNode","dragend canvas":"dragEndNode","drop canvas":"dropNode"},initializeContext:function(){if(this.supportsWebGL()){this.renderer=new THREE.WebGLRenderer({antialias:true,canvas:this.canvas});this.gl=this.renderer.getContext();this.model.set("webGLSupport",true)}else{this.renderer=new THREE.CanvasRenderer({antialias:true,canvas:this.canvas});this.renderer.getContext=function(){return null};this.renderer.setViewport=function(x,y,width,height){};this.renderer.setSize(this.$el.width(),this.$el.parent().height());this.gl=null;this.model.set("webGLSupport",false)}this.renderer.setClearColor(1907997,1);this.renderer.autoClear=false},supportsWebGL:function(){var contextTypes=["webgl","experimental-webgl"];var gl=null;_.each(contextTypes,function(type){if(!gl){try{gl=this.canvas.getContext(type)}catch(e){gl=null}}},this);return!!gl},onClose:function(){this.displayScene.destroy();$(window).off("focus");$(window).off("mouseup");$(window).off("mousemove");this.gl=null;this.renderer=null},bindHotkeys:function(){Mousetrap.bind("f",this.frameSelectionActive.bind(this));Mousetrap.bind("a",this.frameAllActive.bind(this));Mousetrap.bind("shift+f",this.frameSelection.bind(this));Mousetrap.bind("shift+a",this.frameAll.bind(this))},createDisplayScene:function(){if(!(this.displayScene&&this.displayScene.model===this.model.scene)){if(this.displayScene){this.displayScene.destroy()}this.displayScene=new exo.translators.three.Scene(this.model.scene,null,{editor:this.model,renderer:this.renderer});this.model.displayScene=this.displayScene;_.each(this.viewports,function(viewport){viewport.displayScene=this.displayScene;viewport.render()},this)}},createViewports:function(){this.viewports=this.model.viewports.map(function(viewport,i){var view=new exo.ui.views.Viewport({model:viewport,displayScene:this.displayScene,editor:this.model,canvas:this.canvas});if(!i){this.model.currentViewport=viewport}view.on("resize",this.resizeViewports,this);this.$(".viewports").append(view.el);return view},this)},resizeViewports:function(view){_.each(this.viewports,function(v){if(v!==view){v.model.set("visible",view.model.get("fullscreen")?false:true)}})},onRender:function(){this.$el.on("contextmenu",function(event){event.preventDefault()});this.$canvas=this.$("canvas");this.canvas=this.$canvas[0];this.initializeContext();if(!this.viewports){this.createViewports()}this.createDisplayScene();if(!this.gl){this.canvasRendererFallbacks()}},canvasRendererFallbacks:function(){_.each(this.viewports,function(view,i){if(i===this.model.viewports.length-1){view.model.set("fullscreen",true);view.model.set("viewType","perspective");view.model.set("renderType","wireframe")}else{view.model.set("fullscreen",false)}view.trigger("resize",view)},this)},sizeCanvas:function(){var width=this.$el.width();var height=this.$el.parent().height();var x=this.$el.position().left;var y=this.$el.position().top;this.$canvas.css({width:width,height:height,x:x,y:y,position:"absolute"});this.canvas.width=width;this.canvas.height=height;_.each(this.viewports,function(viewport){viewport.calcSize()});if(!this.gl){this.renderer.setSize(width,height)}},onShow:function(){this.sizeCanvas()},handleMouseDown:function(e){var mouseInfo=this.getMouseInformation(e);var gizmoVisible=this.displayScene.isGizmoVisible();if(this.currentViewport){if(this.mouseButton===1){this.nodesFound=null;this.gizmoPartFound=gizmoVisible?this.currentViewport.findGizmoPart(e):null;if(!this.gizmoPartFound){if(this.currentViewport.hasSubSelection()){this.subGizmoPartFound=this.currentViewport.handleMouseDown(e)}else{this.nodesFound=this.currentViewport.handleMouseDown(e)}}this.displayScene.highlightGizmoParts(this.getHandleInfo());if(!this.model.hasSelection()){if(!e.ctrlKey&&!e.altKey){this.model.select(this.model.scene)
}}}}return false},handleMouseDownWindow:function(e){if(e.ctrlKey||e.shiftKey){var subSelection=this.model.subSelection;subSelection.setConvertFlag(true)}},getHandleInfo:function(){var handleInfo=null;if(this.gizmoPartFound){handleInfo=this.gizmoPartFound.handle}else if(this.nodesFound&&this.model.getActiveManipulator()){handleInfo=this.model.getActiveManipulator().defaultHandleInfo}return handleInfo},handleMouseMove:function(e){var mouseInfo=this.getMouseInformation(e);var gizmoVisible=this.displayScene.isGizmoVisible();if(gizmoVisible){if(this.gizmoPartFound)this.displayScene.highlightGizmoParts(this.getHandleInfo());else this.displayScene.unhighlightGizmoParts(this.getHandleInfo())}if(this.mouseButton===2||this.mouseButton===1&&e.metaKey){if(e.ctrlKey){this.panCamera(mouseInfo.deltaX,mouseInfo.deltaY)}else{this.orbitCamera(mouseInfo.deltaX,mouseInfo.deltaY)}this.displayScene.update()}else if(this.mouseButton===1){if(e.ctrlKey&&e.altKey){if(!this.isMouseOutsideScreen(e)){this.lastDeltaZoom=-mouseInfo.deltaY}this.zoomCamera(this.lastDeltaZoom,this.smoothZoomFactor,true)}else{var found=this.gizmoPartFound;if(this.currentViewport&&!found){this.currentViewport.handleMouseMove(e)}if(found&&this.model.selected.length){var handleInfo=this.gizmoPartFound?this.gizmoPartFound.handle:null;this.model.manipulate(mouseInfo,handleInfo)}}}else if(this.mouseButton===0){this.findCurrentViewport(mouseInfo);if(this.currentViewport){if(gizmoVisible){this.gizmoPartFound=this.currentViewport.findGizmoPart(e)}if(!this.gizmoPartFound){this.nodesFound=this.currentViewport.findNodes(e)}this.currentViewport.handleMouseMoveCursor(e,this.gizmoPartFound,this.nodesFound)}}},findCurrentViewport:function(mouseInfo){_.each(this.viewports,function(viewport){var viewportModel=viewport.model;if(this.containsView(mouseInfo.canvasX,mouseInfo.canvasY,viewportModel)){this.model.currentViewport=viewportModel;this.currentViewport=viewport}},this);return this.currentViewport},handleMouseWheel:function(e){var mouseInfo=this.getMouseWheelInformation(e);this.zoomCamera(mouseInfo.wheelDelta,this.wheelZoomFactor,false)},handleMouseUp:function(e){var mouseInfo=this.getMouseInformation(e);var found=this.nodesFound||this.gizmoPartFound||this.subGizmoPartFound;if(found&&this.model.selected.length){var handleInfo=this.gizmoPartFound?this.gizmoPartFound.handle:null;this.model.manipulate(mouseInfo,handleInfo,true)}this.displayScene.unhighlightGizmoParts();this.nodesFound=this.gizmoPartFound=this.subGizmoPartFound=null},getMouseInformation:function(event){var offset=this.$canvas.offset();var mouseInfo={};mouseInfo.canvasX=event.clientX-offset.left;mouseInfo.canvasY=event.clientY-offset.top;mouseInfo.deltaX=this.oldCanvasX?mouseInfo.canvasX-this.oldCanvasX:0;mouseInfo.deltaY=this.oldCanvasY?mouseInfo.canvasY-this.oldCanvasY:0;mouseInfo.inCanvas=mouseInfo.canvasX<=this.$canvas.width()&&mouseInfo.canvasX>0&&mouseInfo.canvasY<=this.$canvas.height()&&mouseInfo.canvasY>0;this.oldCanvasX=mouseInfo.canvasX;this.oldCanvasY=mouseInfo.canvasY;if(event.type==="mousedown"){this.mouseButton=event.mouseButton||event.which||0;if(this.mouseButton===3&&event.altKey){this.mouseButton=2}}else if(event.type==="mouseup"){this.mouseButton=0}this.mouseButton=this.mouseButton||0;return mouseInfo},isMouseOutsideScreen:function(event){var screenW=$(document).width();var screenH=$(document).height();if(event.clientY<=0||event.clientY>=screenH||event.clientX<=0||event.clientX>=screenW){return true}return false},getMouseWheelInformation:function(event){var mouseInfo={};if(event.originalEvent){event.wheelDelta=event.originalEvent.wheelDelta;event.detail=event.originalEvent.detail}if(event.wheelDelta){event.wheelDelta=event.wheelDelta/60}else if(event.detail){event.wheelDelta=-event.detail/2}mouseInfo.wheelDelta=event.wheelDelta||0;return mouseInfo},containsView:function(x,y,viewport){var canvasHeight=this.$canvas.height();var rect=viewport.get("rect");y=canvasHeight-y;return viewport.get("visible")&&!(x<=rect.x||y<=rect.y||x>=rect.x+rect.width||y>=rect.y+rect.height)},zoomCamera:function(delta,zoomStep,fixedSpeed){var viewport=this.model.currentViewport;if(!viewport||!viewport.camera)return;if(delta!==0){viewport.camera.zoom(zoomStep*delta,viewport,this.displayScene,fixedSpeed)}},orbitCamera:function(deltaX,deltaY){var viewport=this.model.currentViewport;if(!viewport||!viewport.camera){return}var orbitAroundType;if(this.model.hasSubSelection()){orbitAroundType=viewport.camera.OrbitType.SubSelectionCenter}else if(this.model.hasSelection()){orbitAroundType=viewport.camera.OrbitType.SelectionCenter}else{orbitAroundType=viewport.camera.OrbitType.ViewCenter}viewport.camera.orbit(deltaX,deltaY,orbitAroundType,viewport,this.displayScene)},panCamera:function(deltaX,deltaY){var viewport=this.model.currentViewport;if(!viewport||!viewport.camera)return;if(!viewport.camera.isOrthographic()){deltaX*=this.panFactor;deltaY*=this.panFactor}viewport.camera.pan(deltaX,deltaY,viewport,this.displayScene)},frameAllActive:function(e){this.model.frameAll(this.currentViewport)},frameSelectionActive:function(e){this.model.frameSelection(this.currentViewport)},frameAll:function(e){this.model.frameAll()},frameSelection:function(e){this.model.frameSelection()},popupContext:function(e){if(!(e.altKey||e.metaKey||e.ctrlKey)){if(this.model.selected.length){this.contextMenu=exo.ui.views.ViewportsContext.create({previous:this.contextMenu,editor:this.model,event:e,reset:true})}return false}},dragEnterNode:function(e){e.preventDefault()},dragOverNode:function(e){e.preventDefault()},dragLeaveNode:function(e){e.preventDefault()},dropNode:function(e){var source=this.model.scene.getNodeById(e.dataTransfer.getData("Text"));if(source){var ev=e.originalEvent||e;var mouseInfo=this.getMouseInformation(ev);this.findCurrentViewport(mouseInfo);this.currentViewport.selectionBox=this.currentViewport.createSelectionBox(ev);var targets=this.currentViewport.findNodes(ev);var target=targets.length?targets[0].displayNode.model:null;if(target){var selected=this.model.selected.toArray();_.each(selected,function(source){if(source instanceof exo.sceneGraph.nodes.Material&&target.Material){var lastReferenceOp=target.Material.getLastReferenceOp();if(lastReferenceOp){target.ctx(lastReferenceOp).set("reference",source.id)}}else{source.ctx().reparent(target)}},this);e.stopPropagation();e.preventDefault()}}},dragEndNode:function(e){e.preventDefault()}});exo.ui.views.ChangeItem=highbrow.extend("ItemView","ChangeItem",{tagName:"li",appendHtml:function(el,html){this.$("ul.history-list:first").append(html)},initialize:function(){var editor=this.model.scene().editor();this.collection=this.model.changes;this.bindTo(this.model,"change",this.rerender);this.bindTo(this.model,"notifyProgress",this.updateProgress,this);this.bindTo(this.model,"change:status",this.changeStatus,this)},updateProgress:function(change,isChange){if(isChange)return this.rerender();var progress=this.model.heirarchicalProgress();this.$el.find("span.heirarchical").html(progress);if(progress===1){this.$el.find(".progress").remove()}else{this.$el.find(".bar").css("width",""+progress*100+"%")}},changeStatus:function(model,newStatus){this.$el.removeClass(model.previous("status"));this.$el.addClass(newStatus)},onRender:function(){this.changeStatus(this.model,this.model.get("status"))}});exo.ui.views.ChangeItem.prototype.itemView=exo.ui.views.ChangeItem;exo.ui.views.History=highbrow.extend("CollectionView","History",{itemView:exo.ui.views.ChangeItem,tagName:"ul",initialize:function(){this.collection=this.model.scene.changes},appendHtml:function(el,html){this.$("#changes").append(html)},events:{contextmenu:"contextMenu"},contextMenu:function(e){e.stopPropagation()}});exo.ui.views.EdgeSelection=exo.ui.views.CommandsView.extend({name:"EdgeSelection",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this)},onRender:function(){this.properties=new exo.ui.views.PropertiesSimple({el:this.$("#sub-selection-props")[0],model:this.editor,node:this.model});this.properties.render()},data:function(){return new exo.ui.vm.Editor(this.editor)},appendHtml:function(el,html){el.find("ul").append(html)}},{place:"edgeSelection"});exo.ui.views.VertexSelection=exo.ui.views.CommandsView.extend({name:"VertexSelection",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this)},onRender:function(){this.properties=new exo.ui.views.PropertiesSimple({el:this.$("#sub-selection-props")[0],model:this.editor,node:this.model});this.properties.render()},data:function(){return new exo.ui.vm.Editor(this.editor)},appendHtml:function(el,html){el.find("ul").append(html)}},{place:"vertexSelection"});exo.ui.views.FaceSelection=exo.ui.views.CommandsView.extend({name:"FaceSelection",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this)},onRender:function(){this.properties=new exo.ui.views.PropertiesSimple({el:this.$("#sub-selection-props")[0],model:this.editor,node:this.model});this.properties.render()},data:function(){return new exo.ui.vm.Editor(this.editor)},appendHtml:function(el,html){el.find("ul").append(html)}},{place:"faceSelection"});exo.ui.views.ObjectSelection=exo.ui.views.CommandsView.extend({name:"ObjectSelection",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this)},onRender:function(){this.properties=new exo.ui.views.PropertiesSimple({el:this.$("#sub-selection-props")[0],model:this.editor,node:this.model});this.properties.render()},data:function(){return new exo.ui.vm.Editor(this.editor)},appendHtml:function(el,html){el.find("ul").append(html)}},{place:"objectSelection"});!function(){exo.ui.views.Selection=exo.ui.views.CommandsView.extend({name:"Selection",initialize:function(){exo.ui.views.CommandsView.prototype.initialize.call(this);this.editor=this.options.editor;this.editor.subSelection.on("add",this.render,this);this.editor.subSelection.on("remove",this.render,this);this.editor.selected.on("add",this.render,this);this.editor.selected.on("remove",this.render,this)},onRender:function(){var type=this.editor.subSelection.get("type");var SubSelectionView=exo.ui.views[type+"Selection"];this.properties=new exo.ui.views.PropertiesSimple({el:this.$el.find("#selection-props")[0],model:this.editor,node:this.editor.selectionProperties});this.properties.render();if(SubSelectionView){this.subSelectionView=new SubSelectionView({el:this.$el.find(".sub-selection-content"),editor:this.editor,model:this.editor.subSelection.properties[type.toLowerCase()],collection:this.editor.commands[SubSelectionView.place]});this.subSelectionView.render()}},data:function(){return new exo.ui.vm.Editor(this.editor)},appendHtml:function(el,html){el.find(".selection-content ul").append(html)}},{place:"selection"})}();exo.ui.views.Stats=highbrow.extend("ItemView","Stats",{className:"stats",initialize:function(){_.bindAll(this);this.visible=true;this.model.on("change",this.rerender,this);this.lastChanged=null;this.update()},events:{"click .reset":"reset"},reset:function(e){e.preventDefault();exo.stats.reset();this.rerender()},update:function(){if(this.visible&&exo.stats.lastChanged>this.lastChanged){this.render();this.lastChanged=new Date}setTimeout(this.update,500)},show:function(){this.visible=true;this.$el.show()},hide:function(){this.visible=false;this.$el.hide()}});exo.ui.views.SceneRename=highbrow.extend("ItemView","SceneRename",{className:"modal hide fade",initialize:function(){this.ctx=this.options.ctx},onRender:function(){this.$input=this.$("input");this.$input.val(this.ctx("%Scene").get("name"));var input=this.$input;this.$el.on("shown",function(){setTimeout(function(){input.focus()},0)});this.$el.modal("show")},events:{"click .rename":"rename","click .cancel":"cancel","keydown input":"onKeyEnter"},onKeyEnter:function(e){if(e.which===13){this.rename()}},rename:function(e){this.ctx("%Scene").set({name:this.$input.val()});this.$el.modal("hide")},cancel:function(){this.$el.modal("hide")}},{attach:function(ctx){var $el=$("#editor");var renamer=new exo.ui.views.SceneRename({ctx:ctx});renamer.render();$el.append(renamer.el);renamer.$el.on("hidden",function(){renamer.$el.detach();renamer.close()})}});exo.ui.views.Editor=highbrow.extend("ItemView","Editor",{initialize:function(){this.views={};this.model.layout.set("tabs",{left:[{id:"scene-explorer",name:"Explorer",active:true},{id:"selection",name:"Sub-Object",active:false}],right:[{id:"properties",name:"Properties",active:true},{id:"history",name:"History",active:false}],bottom:[{id:"script",name:"Script",active:false},{id:"log",name:"Log",active:true}]});this.model.subSelection.on("change:type",this.switchToSelection,this);exo.dropHandler.pushHandler({handleFiles:this.handleFiles.bind(this)})},events:{"click #left-column .panel-collapsed":"showLeftPanel","dblclick #left-column .panel-header":"collapseLeftPanel","click #right-column .panel-collapsed":"showRightPanel","dblclick #right-column .panel-header":"collapseRightPanel","click #bottom-row .panel-collapsed":"showBottomPanel","dblclick #bottom-row .panel-header":"collapseBottomPanel",contextmenu:"contextMenu"},handleFiles:function(files){this.model.getCtx().exec("importers","importFiles",{files:files})},onRender:function(){_.each(exo.ui.views.Editor.viewMap,function(view,id){this.views[id]=new view({model:this.model,el:$("#"+id)[0]});this.views[id].render()},this);_.each(exo.ui.views.Editor.commandViews,function(view,id){this.views[id]=new view({collection:this.model.commands[view.place],el:$("#"+id),editor:this.model});this.views[id].render()},this);this.views["toolbar"].render();this.$bottom=$("#bottom-row");this.$bottomResizer=this.$("#bottom-resizer");this.$mainRow=this.$("#main-row");this.$timeline=this.$("#timeline-row");this.$left=$("#left-column");this.$leftResizer=this.$("#left-resizer");this.$center=this.$("#center-column");this.$right=$("#right-column");this.$rightResizer=this.$("#right-resizer");this.notifyIncompatibilities()},notifyIncompatibilities:function(){var warningNotification;if(!this.model.get("webGLSupport")){if(Modernizr.canvas){warningNotification=new exo.models.Notification({title:"Canvas Rendering Mode",message:"You are currently running in canvas mode and do not have access "+"to some of the features or performance from the full version. In order to get the "+'full experience, make sure your browser is <a href="http://get.webgl.org/" target="_blank">WebGL enabled</a>.',type:"warning",persist:true});this.model.notifications.add(warningNotification)}else{warningNotification=new exo.models.Notification({title:"HTML5 Canvas Not Supported",message:"Unable to fallback to canvas mode. Your browser does not support HTML5 Canvas or WebGL.",type:"error",persist:true});this.model.notifications.add(warningNotification)}}if(!Modernizr.localstorage){warningNotification=new exo.models.Notification({title:"LocalStorage Not Supported",message:"HTML5 localStorage is not supported in your browser. Local settings such as viewport type will not be saved.",type:"warning",persist:true});this.model.notifications.add(warningNotification)}if(!Modernizr.draganddrop){warningNotification=new exo.models.Notification({title:"Drag and Drop Not Supported",message:"HTML5 Drag and Drop is not supported in your browser.",type:"warning",persist:true});this.model.notifications.add(warningNotification)}if(!document.evaluate){warningNotification=new exo.models.Notification({title:"Collada Importing Not Supported",message:"Some XPath functionality does not exist on this browser, therefore our current Collada importer is not available.",type:"warning",persist:true});this.model.notifications.add(warningNotification)}},checkCollapse:function(width,$el,stillResizing){var placement=$el[0].id.substr(0,$el[0].id.indexOf("-"));if(width<this.model.layout.COLLAPSE_UNDER){$el.find(".panel-body").hide();$el.find(".panel-header").hide();if(!stillResizing)this["$"+placement+"Resizer"].hide()}else{$el.find(".panel-body").show();$el.find(".panel-header").show();if(!stillResizing)this["$"+placement+"Resizer"].show()}},expand:function($el){var placement=$el[0].id.substr(0,$el[0].id.indexOf("-"));$el.find(".panel-body").show();$el.find(".panel-header").show();$el.find(".panel-collapsed").hide();this["$"+placement+"Resizer"].show();this.views["viewports"].sizeCanvas()},resizeBottom:function(height,stillResizing){this.$bottom.css("height",height);var bottomHeight=height===0?this.model.layout.COLLAPSED_WIDTH:height;this.$timeline.css("bottom",bottomHeight);this.$mainRow.css("bottom",bottomHeight+this.model.layout.TIMELINE_HEIGHT);this.checkCollapse(height,this.$bottom,stillResizing)},collapseBottomPanel:function(){this.resizeBottom(0);this.$bottomResizer.hide();this.model.layout.setResize("bottom",0);this.$bottom.find(".panel-collapsed").show();this.resize()},showBottomPanel:function(e){this.resizeBottom(this.model.layout.get("bottomHeight"));this.$bottomResizer.show().css("top",$("#editor").height()-this.model.layout.get("bottomHeight"));this.expand(this.$bottom);this.model.layout.setResize("bottom")},splitBottom:function(){var editorView=this;this.bottomSplitter=DragDrop.bind(this.$bottomResizer[0],{});this.reflowBottom();var drag=function(e){var bottomHeight=$("#editor").height()-editorView.$bottomResizer.position().top;editorView.resizeBottom(bottomHeight,true)};var dragEnd=function(e){var bottomHeight=$("#editor").height()-editorView.$bottomResizer.position().top;if(bottomHeight<editorView.model.layout.COLLAPSE_UNDER){editorView.collapseBottomPanel()}else{editorView.model.layout.setResize("bottom",bottomHeight);editorView.resize()}};this.bottomSplitter.bindEvent("drag",drag);this.bottomSplitter.bindEvent("dragend",dragEnd)},reflowBottom:function(){var height=$("#editor").height();this.bottomSplitter.setBoundingBox({x:{min:0,max:0},y:{min:this.$mainRow.position().top+300,max:height}});this.$bottomResizer.css("top",height-$("#bottom-row").height());this.$bottomResizer.css("bottom","")},resizeLeft:function(left,stillResizing){this.$left.css("width",left);this.$center.css("left",left===0?this.model.layout.COLLAPSED_WIDTH:left);this.checkCollapse(left,this.$left,stillResizing)},collapseLeftPanel:function(){this.resizeLeft(0);this.$left.find(".panel-collapsed").show();this.$leftResizer.hide();this.model.layout.setResize("left",0);this.resize()},showLeftPanel:function(e){this.resizeLeft(this.model.layout.get("leftWidth"));this.$leftResizer.show().css("left",this.model.layout.get("leftWidth"));this.expand(this.$left);this.model.layout.setResize("left")},splitLeft:function(){var editorView=this;this.leftSplitter=DragDrop.bind(this.$leftResizer[0],{});this.reflowLeft();var drag=function(e){editorView.resizeLeft(editorView.$leftResizer.position().left,true)};var dragEnd=function(e){var left=editorView.$leftResizer.position().left;if(left<editorView.model.layout.COLLAPSE_UNDER){editorView.collapseLeftPanel()}else{editorView.model.layout.setResize("left",left);editorView.resize()}};this.leftSplitter.bindEvent("drag",drag);this.leftSplitter.bindEvent("dragend",dragEnd)},reflowLeft:function(){this.leftSplitter.setBoundingBox({x:{min:0,max:this.$center.position().left+this.$center.width()-300},y:{min:0,max:0}})},resizeRight:function(width,stillResizing){this.$right.css("width",width);this.$center.css("right",width===0?this.model.layout.COLLAPSED_WIDTH:width);this.checkCollapse(width,this.$right,stillResizing)},collapseRightPanel:function(){this.resizeRight(0);this.$right.find(".panel-collapsed").show();this.$rightResizer.hide();this.model.layout.setResize("right",0);this.resize()},showRightPanel:function(e){var rightWidth=this.model.layout.get("rightWidth");this.resizeRight(rightWidth);this.$rightResizer.show().css("left",$("#editor").width()-rightWidth);this.expand(this.$right);this.model.layout.setResize("right")},splitRight:function(){var editorView=this;this.rightSplitter=DragDrop.bind(this.$rightResizer[0],{});this.reflowRight();var drag=function(e){var right=editorView.$rightResizer.position().left;editorView.resizeRight($("#editor").width()-right,true)};var dragEnd=function(e){var rightWidth=$("#editor").width()-editorView.$rightResizer.position().left;if(rightWidth<editorView.model.layout.COLLAPSE_UNDER){editorView.collapseRightPanel()}else{editorView.model.layout.setResize("right",rightWidth);editorView.resize()}};this.rightSplitter.bindEvent("drag",drag);this.rightSplitter.bindEvent("dragend",dragEnd)},reflowRight:function(){var width=$("#editor").width();this.rightSplitter.setBoundingBox({x:{min:this.$center.position().left+300,max:width},y:{min:0,max:0}});this.$rightResizer.css("left",width-this.$right.width());this.$rightResizer.css("right","")},resize:function(){this.reflowLeft();this.reflowRight();this.reflowBottom();this.views["viewports"].sizeCanvas()},onShow:function(){this.splitLeft();this.splitRight();this.splitBottom();$(window).on("resize",this.resize.bind(this));_.each(this.views,function(view,id){view.onShow()})},close:function(){$(window).off("resize");this.bottomSplitter.unbindEvent("drag");this.rightSplitter.unbindEvent("drag");this.leftSplitter.unbindEvent("drag");this.bottomSplitter.unbindEvent("dragEnd");this.rightSplitter.unbindEvent("dragEnd");this.leftSplitter.unbindEvent("dragEnd");this.undelegateEvents();exo.dropHandler.popHandler();_.each(this.views,function(view){view.close()})},switchToSelection:function(){var subSelection=this.model.subSelection;if(subSelection&&subSelection.getType()!=="Object"){this.switchTab("selection");this.views["selection"].render()}},switchTab:function(tabName){this.$("#"+tabName+"-option a").tab("show")},contextMenu:function(e){if(!$(e.target).is("input")){return false}}},{commandViews:{toolbar:exo.ui.views.Toolbar,"manipulator-toolbar":exo.ui.views.ManipulatorToolbar,"subobject-toolbar":exo.ui.views.SubObjectToolbar,selection:exo.ui.views.Selection},viewMap:{viewports:exo.ui.views.Viewports,"scene-explorer":exo.ui.views.SceneExplorer,script:exo.ui.views.Script,properties:exo.ui.views.Properties,log:exo.ui.views.Log,timeline:exo.ui.views.Timeline,history:exo.ui.views.History}});exo.ui.user.Profile=highbrow.extend("FormView","Profile",{events:{submit:"handleFormSubmit"}});exo.ui.user.ChangePassword=highbrow.extend("FormView","ChangePassword",{events:{"blur [name*=password]":"checkOldPassword","blur [name*=newPassword]":"preCheck","blur [name*=confPassword]":"preCheck",submit:"submitNewPassword"},checkOldPassword:function(e){var _this=this,oldPassword=this.$el.find('[name="password"]');new exo.models.Session({username:this.model.attributes.username,password:$(e.currentTarget).val()}).save({},{success:function(model,resp){oldPassword.parents(".control-group").removeClass("error");oldPassword.next(".help-inline").remove();oldPassword.data("validated",true)},error:function(model,response,options){_this.passwordValidationError();_this._handleError(response);return _this.trigger("error",_this.error)}})},passwordValidationError:function(){var input=this.$el.find('[name="password"]');input.data("validated",false);if(!input.parents(".control-group").is(".error")){input.parents(".control-group").addClass("error");input.after('<span class="help-inline">Incorrect password</span>')}},preCheck:function(){if($('[name="confPassword"]').val()!==""&&$('[name="newPassword"]').val()!=="")this.checkPasswordsMatch()},checkPasswordsMatch:function(e){var newPassword=this.$el.find('[name="newPassword"]'),confPassword=this.$el.find('[name="confPassword"]');if(confPassword.val()===""&&newPassword.val()===""){return false}else if(newPassword.val()===confPassword.val()){confPassword.parents(".control-group").removeClass("error");confPassword.next(".help-inline").remove();return true}else{if(!confPassword.parents(".control-group").is(".error")){confPassword.parents(".control-group").addClass("error");confPassword.after('<span class="help-inline">Passwords do not match</span>')}return false}},onRender:function(){this.$el.find("input").val("")},submitNewPassword:function(e){var _this=this;e.preventDefault();if(!$('[name="password"]').data("validated")){this.passwordValidationError();return}if(!this.checkPasswordsMatch())return;this.model.set({password:$('[name="newPassword"]').val()});this.error=this.model.savable();if(this.error)return this.rerender();this.model.save({},{success:function(model,resp){return _this.trigger("success",_this.model)},error:function(model,response,options){_this._handleError(response);_this.rerender();return _this.trigger("error",_this.error)}})}});!function(){_.each(exo.ui.user,function(view){view.namespace="user"});exo.ui.user.route=function(app){app.page("",profile);app.page("/profile",profile);app.page("/password",changePassword)};var profile=function(ctx){var view=new exo.ui.user.Profile({model:ctx.user});view.on("success",function(user){ctx.root.showNext(ctx,"/user")});return view};var changePassword=function(ctx){var view=new exo.ui.user.ChangePassword({model:ctx.user});view.on("success",function(user){ctx.root.showNext(ctx,"/user")});return view}}();exo.ui.plugins.ListItem=highbrow.extend("ItemView","ListItem",{tagName:"tr",onShow:function(){this.$("a.edit").popover({trigger:"hover",placement:"bottom"})},onClose:function(){$(".popover").remove()}});exo.ui.plugins.List=highbrow.extend("CollectionView","List",{appendHtml:function(el,html){this.$("table").append(html)},itemView:exo.ui.plugins.ListItem});exo.ui.plugins.Edit=highbrow.extend("FormView","Edit",{events:{"click .save":"save",submit:"handleFormSubmit"},initialize:function(){this.initialAttrs=_.clone(this.model.attributes);this.bindTo(this.model,"change",this.checkDirty,this)},checkDirty:function(){if(_.isEqual(this.initialAttrs,this.model.attributes)){$("button.save").text("Saved").attr("disabled",true)}else{$("button.save").text("Save").attr("disabled",false)}},onShow:function(){this.$("input[name=loadFromServer]").on("change",this.onChangeServer.bind(this));this.onChangeServer();var $el=this.$(".content");if($el.length){var extraKeys={};this.editor=CodeMirror($el[0],{mode:"javascript",theme:"lesser-dark",lineNumbers:true,lineWrapping:true,matchBrackets:true,value:this.model.get("content")});this.editor.setSize(null,"100%");$el.data("codemirror",this.editor);this.editor.on("change",this.onChangeContent.bind(this))}this.checkDirty()},onChangeContent:function(){this.model.set({content:this.editor.getValue()})},onChangeServer:function(){if(this.$("input[name=loadFromServer]").prop("checked")){this.$("input[name=url]").parents(".control-group").show();this.$(".content").hide()}else{this.$("input[name=url]").parents(".control-group").hide();this.$(".content").show()}},rerender:function(){this.render();this.onShow()},save:function(e){e.preventDefault();$("button.save").text("Saving...").attr("disabled",true);var _this=this;var callbacks={success:function(model,resp){_this.initialAttrs=_.clone(_this.model.attributes);$("button.save").text("Save").attr("disabled",false);_this.rerender();_this.trigger("saved",_this.model)},error:function(model,response,options){_this._handleError(response);_this.rerender();$("button.save").text("Save").attr("disabled",false);_this.trigger("error",_this.error)}};this.error=this.model.savable();if(this.error){return this.rerender()}if(this.collection){this.collection.create(this.model,callbacks)}else{this.model.save({},callbacks)}}});!function(){_.each(exo.ui.plugins,function(view){view.namespace="plugins"});exo.ui.plugins.route=function(app){app.page("",fetch,list);app.page("/new",create,edit);app.page("/:uuid",show);app.page("/:uuid/edit",fetch,find,edit)};exo.ui.plugins.reset=function(ctx,next){exo.api.pluginRegistry=new exo.api.PluginRegistry(ctx.root.store.user);next()};exo.ui.plugins.load=function(ctx,next){exo.api.loadPlugins(this.store.user,function(err){if(!err&&ctx.root.store.editor)ctx.root.store.editor.initializeCommands();next(err)},"Error Loading Plugins")};var show=function(ctx,next){};var fetch=function(ctx,next){if(!this.store.plugins){this.store.set("plugins",exo.models.Plugins.init(this.store.context))}this.store.plugins.fetchWithFail(this.store.user,next,"Error Fetching Plugins")};var list=function(ctx){var view=new exo.ui.plugins.List({collection:this.store.plugins});return view};var create=function(ctx,next){this.store.set("plugin",new exo.models.Plugin);next()};var find=function(ctx,next){var plugin=this.store.plugins.get(ctx.params.uuid);this.store.set("plugin",plugin);next()};var edit=function(ctx){var view=new exo.ui.plugins.Edit({model:this.store.plugin,collection:this.store.plugins});view.on("success",function(plugin){ctx.root.show("/plugins")});return view};var editor=function(ctx){if(this.store.plugin.get("loadFromServer")){return ctx.root.show("/plugins")}var view=new exo.ui.plugins.Editor({plugin:this.store.plugin});view.on("success",function(plugin){ctx.root.show("/plugins")});return view}}();exo.ui.views.Script.prototype.initScriptsCollection=function(){this.collection=this.collection||new exo.models.Scripts;if(!this.collection.length)this.addNewScript();this.active=0;this.collection.fetch();var monitorScript=function(script){script.on("change",function(){script.trySave()})};this.collection.on("reset",function(coll){if(!this.collection.length)this.addNewScript();this.collection.each(monitorScript);this.update()},this);this.collection.each(monitorScript);this.collection.on("add",monitorScript)};exo.ui.scenes.ListItem=highbrow.extend("ItemView","ListItem",{initialize:function(){var parent=this.options.parent;this.user=parent?parent.options.user:null;this.rerender()},tagName:"tr",events:{"click .delete-scene":"deleteScene","click .share-scene":"shareScene","click .plugin-share-scene":"shareSceneWithPlugin","click .clone-scene":"cloneScene"},data:function(){var viewModel=new exo.ui.vm.Scene(this.model);viewModel.isAdmin=this.user&&this.user.isAdmin();return viewModel},deleteScene:function(e){e.preventDefault();this.model.destroy()},shareScene:function(e){e.preventDefault();exo.ui.scenes.Share.attach(this.$el,this.model)},shareSceneWithPlugin:function(e){e.preventDefault();if(this.user&&this.user.isAdmin()){exo.ui.scenes.PluginShare.attach(this.$el,this.model)}},cloneScene:function(e){e.preventDefault();$.post(this.model.url()+"/clone",function(data){exo.app.show("/editor/"+data._id)}).fail(function(err){exo.reportError(err,"Error cloning scene","Error cloning scene")})}});exo.ui.scenes.Create=highbrow.extend("ItemView","Create",{className:"modal hide fade",initialize:function(){this.sceneList=[];this.$el.modal()},onRender:function(){this.fetchSceneTemplates(["template","example"]);$(".plugin-content").hide()},fetchSceneTemplates:function(types){var createView=this;var plugins=exo.api.pluginRegistry.models;createView.renderEmptySceneOption();_.each(plugins,function(plugin){if(!plugin.attributes.label){var pluginName=plugin.attributes.name;plugin.attributes.label=pluginName.charAt(0).toUpperCase()+pluginName.slice(1)}createView.renderPluginOptions(plugin);_.each(types,function(type){exo.sceneGraph.Scenes.fetchByNameType(plugin.attributes.name,type,function(scenes){createView.renderSceneTemplates(scenes,plugin,type)})})})},renderEmptySceneOption:function(){this.$(".new-scene-content").append('<div id="emptyScene-container"><div id="emptyScene-header" class="plugin-header-empty"><a href="#" class="create-blank-scene">Empty Scene</a></div>\n</div>')},renderPluginOptions:function(plugin){var name=plugin.attributes.name;var label=plugin.attributes.label;this.$(".new-scene-content").append('<div id="'+name+'-container"><div id="'+name+'-header" class="plugin-header"><a href="#">'+label+'</a></div>\n<div id="'+name+'-body" class="plugin-content"><ul id="'+name+'-list"></ul></div></div>');this.$(".plugin-header").hide();this.$(".scene-type-item").hide()},renderSceneTemplates:function(scenes,plugin,type){if(scenes.models.length<1){return}var sceneList=this.sceneList;var pluginName=plugin.attributes.name;cType=type.charAt(0).toUpperCase()+type.slice(1)+"s";$("#"+pluginName+"-list").append('<li id="'+pluginName+"-"+type+'-item\'" class="scene-type-item">'+cType+'<ul id="'+pluginName+"-"+type+'-scene-list"><ul></li>');
_.each(scenes.models,function(scene){var theId=scene.id;$("#"+pluginName+"-"+type+"-scene-list").append('<li data-id="'+theId+'"><a href="#" class="create-'+type+'-scene" data-id="'+scene.id+'" data-plugin="'+pluginName+'">'+scene.get("name")+"</a></li>");sceneList[theId]=scene;$("#"+pluginName+"-header").show()})},onPluginSelected:function(){this.selected=this.$select.val();this.fetchSceneTemplates(["template","example"])},collapse:function(plugin){$(".plugin-content").each(function(){if($(this).attr("id")===plugin+"-body"&&$(this).css("display")==="none"){$(this).show("slow");$("#"+plugin+"-header").css("background-image","url(/img/collapse2.png)")}else{$(this).hide("slow");var id=$(this).attr("id").replace(/-body$/,"-header");$("#"+id).css("background-image","url(/img/expand.png)")}})},events:{"click .create-blank-scene":"createBlankScene","click .create-template-scene":"createSceneFromTemplate","click .create-example-scene":"createSceneFromExample","click .plugin-header":"onPluginHeaderSelected","click .cancel":"cancel"},onPluginHeaderSelected:function(e){var plugin=$(e.currentTarget.outerHTML).attr("id").replace(/-header$/,"");this.collapse(plugin)},createBlankScene:function(e){e.preventDefault();var scene=new exo.sceneGraph.Scene({name:"Untitled Scene"});scene.initObjects();var createView=this;scene.save({},{success:function(model){exo.trackEvent("Scene","New","from [Empty Scene]");createView.$el.modal("hide");exo.app.show("/editor/"+model.id)}})},createSceneFrom:function(e,type){e.preventDefault();var createView=this;var sceneId=$(e.currentTarget).data("id");var pluginName=$(e.currentTarget).data("plugin");var sceneToClone=this.sceneList[sceneId];if(sceneToClone){$.post(sceneToClone.url()+"/clone?pluginAccess="+pluginName+"&name="+sceneToClone.get("name")+"-Clone ",function(data){exo.trackEvent("Scene","New","from "+type+"["+sceneToClone.get("name")+"]");createView.$el.modal("hide");exo.app.show("/editor/"+data._id)}).fail(function(err){exo.reportError(err,"Error cloning scene","Error cloning scene")})}else{}},createSceneFromTemplate:function(e){this.createSceneFrom(e,"template")},createSceneFromExample:function(e){this.createSceneFrom(e,"example")},cancel:function(){this.$el.modal("hide")}},{attach:function($el){$el=$el||$("#editor");var create=new exo.ui.scenes.Create;create.render();$el.append(create.el);create.$el.on("hidden",function(){create.$el.detach();create.close()})}});exo.ui.scenes.List=highbrow.extend("CollectionView","List",{appendHtml:function(el,html){this.$("tbody").append(html)},itemView:exo.ui.scenes.ListItem,events:{"click .create-scene":"createNewScene"},createNewScene:function(){exo.ui.scenes.Create.attach(this.$el)}});exo.ui.scenes.PluginShare=highbrow.extend("ItemView","PluginShare",{className:"modal hide fade",initialize:function(){this.originalAccess=_.clone(this.model.get("pluginAccess"));this.bindTo(this.model,"change:pluginAccess",function(){this.renderAccess()},this);this.$el.modal()},onRender:function(){var shareView=this;this.$el.find("select[name=add]").select2();this.$el.find("select[name=type]").select2();this.$el.on("hidden",function(){shareView.model.set("pluginAccess",shareView.originalAccess)})},renderAccess:function(){this.$el.find("table.access tbody").html(nct.render("scenes/_plugin_share_list",this.context()))},events:{"click .add-access":"addPlugin",submit:"submitChanges","click .remove-access":"removeAccess","click .cancel":"cancelChanges","click .submit":"submitChanges"},removeAccess:function(e){e.preventDefault();var pluginName=$(e.currentTarget).data("pluginname");var pluginType=$(e.currentTarget).data("plugintype");this.model.removePluginAccess({pluginName:pluginName,pluginType:pluginType})},addPlugin:function(e){var scene=this.model;var $pluginInput=this.$el.find("select[name=add]");var $typeInput=this.$el.find("select[name=type]");var pluginName=$pluginInput.val();var pluginType=$typeInput.val();if(pluginName&&pluginType){scene.addPluginAccess({pluginName:pluginName,pluginType:pluginType})}$pluginInput.val("").attr("disabled",false).focus()},cancelChanges:function(e){this.$el.modal("hide")},submitChanges:function(e){e.preventDefault();var shareView=this;this.model.save({},{success:function(){shareView.originalAccess=_.clone(shareView.model.get("pluginAccess"));shareView.$el.modal("hide")},error:function(){}})}},{attach:function($el,model,user){var share=new exo.ui.scenes.PluginShare({model:model});share.render();share.onRender();$el.append(share.el);share.$el.on("hidden",function(){share.$el.detach();share.close()})}});exo.ui.scenes.Share=highbrow.extend("ItemView","Share",{className:"modal hide fade",initialize:function(){this.originalAccess=_.clone(this.model.get("access"));this.doRenderAccess=true;this.bindTo(this.model,"change:access",function(){this.renderAccess()},this)},onRender:function(){var shareView=this;this.$el.on("hidden",function(){shareView.model.set("access",shareView.originalAccess)});var input=this.$(".shareList");this.$el.on("shown",function(){setTimeout(function(){input.focus()},0)});this.$el.modal("show");input.bind("input propertychange",$.proxy(this.updateList,this))},renderAccess:function(){if(this.doRenderAccess){this.$el.find("table.access tbody").html(nct.render("scenes/_share_list",this.context()))}},events:{submit:"submitChanges","click .remove-access":"removeAccess","click .submit":"submitChanges","click .addUser":"updateList","click .cancel":"cancel","keydown .shareList":"onKeyEnter"},onKeyEnter:function(e){if(e.which===13){this.submitChanges(e)}},updateList:function(e){var $submit=this.$(".submit");var hasContent=this.$(".shareList").val();$submit.attr("disabled",!hasContent)},removeAccess:function(e){e.preventDefault();var $submit=this.$el.find(".submit");var $help=this.$el.find(".help-inline");var $input=this.$el.find(".shareList");$help.html("");var username=$(e.currentTarget).data("username");this.model.removeAccess(username);$submit.attr("disabled",false);$input.attr("disabled",false)},addUsernames:function(){var shareView=this;var scene=this.model;var $input=this.$el.find(".shareList");var $help=this.$el.find(".help-inline");var $submit=this.$el.find(".submit");$input.attr("disabled",true);var usernameList=$input.val();if(!usernameList)return;usernameList=usernameList.replace(/[\s\n\r]+/g,"");var accessList=usernameList.split(",");accessList=_.uniq(accessList);this.doRenderAccess=false;$submit.attr("disabled",false);_.each(accessList,function(usernameOrEmail){if(usernameOrEmail.length!==0){info={username:usernameOrEmail,permission:"rw"};scene.addAccess(info)}});return accessList},submitChanges:function(e){e.preventDefault();var $help=this.$el.find(".help-inline");var $submit=this.$el.find(".submit");var $input=this.$el.find(".shareList");if($submit.attr("disabled")){return}var shareView=this;var theNewAccess=shareView.addUsernames();this.doRenderAccess=true;this.model.save({},{success:function(scene,resp){shareView.originalAccess=_.clone(shareView.model.get("access"));$input.val("");$help.html("");$input.attr("disabled",false);$submit.attr("disabled",true);if(theNewAccess){exo.trackEvent("Scene","Share","with: "+theNewAccess.join())}},error:function(scene,response,options){shareView.model.set("access",shareView.originalAccess);$input.attr("disabled",false);var errorText="";if(response.status===422){var resp=JSON.parse(response.responseText);errorText=resp.message}else{errorText="Server error: contact support@exocortex.com and we'll look into this."}$help.html(errorText)}})},cancel:function(e){e.preventDefault();this.model.set("access",null);this.model.set("access",this.originalAccess);this.$el.modal("hide")}},{attach:function($el,model){$el=$el||$("#editor");var share=new exo.ui.scenes.Share({model:model});share.render();share.onRender();$el.append(share.el);share.$el.on("hidden",function(){share.$el.detach();share.close()})}});!function(){_.each(exo.ui.scenes,function(view,name){view.namespace="scenes"});exo.ui.scenes.route=function(app){app.page("",fetch,list)};var fetch=function(ctx,next){exo.api.pluginRegistry=new exo.api.PluginRegistry(ctx.root.store.user);ctx.scenes=exo.sceneGraph.Scenes.init(this.store.context);ctx.scenes.fetchWithFail(this.store.user,next,"Error Fetching Scenes")};var find=function(ctx,next){ctx.scene=exo.sceneGraph.Scene.init(this.store.context,{_id:ctx.params.uuid});ctx.scene.fetch({success:function(){next()}})};var findResults=function(ctx,next){ctx.results=exo.models.Results.init(this.store.context,[],{scene:ctx.scene});ctx.results.fetch({success:function(){next()},error:function(model,xhr,options){console.log("scene results routes",xhr)}})};var results=function(ctx){var view=new exo.ui.results.List({collection:ctx.results,scene:ctx.scene});return view};var findFiles=function(ctx,next){ctx.files=exo.models.Files.init(this.store.context,[],{scene:ctx.scene});ctx.files.fetch({success:function(){next()},error:function(model,xhr,options){console.log("scene files error",xhr)}})};var files=function(ctx){var view=new exo.ui.files.List({collection:ctx.files,scene:ctx.scene});return view};var list=exo.ui.scenes.list=function(ctx){var view=new exo.ui.scenes.List({user:ctx.root.store.user,collection:ctx.scenes});view.on("new-scene",function(scene){ctx.root.show("/editor/"+scene.id);var eName=anlysTest?"Test - Create Scene":"Create Scene";var eData=anlysTest?{category:"Test - Scene",label:"Test - Create Scene"}:{category:"Scene",label:"Create Scene"};analytics.track(eName,eData)});return view};var changeQueues={};var load=exo.ui.scenes.load=function(ctx,next){var success=function(err){if(err)return next(err);ctx.scene.initObjects();ctx.scene.each(function(n){n.plugs.each(function(plug){plug.applyOperators()})});ctx.scene.handle();changeQueues[ctx.scene.id]=ctx.scene.changeQueue;ctx.root.store.editor.setScene(ctx.scene);ctx.root.store.editor.select(ctx.scene);next()};ctx.scene.fetchWithFail(this.store.user,success,"Error Loading Scene")};exo.ui.scenes.unload=function(ctx,next){if(changeQueues[ctx.scene.id]&&changeQueues[ctx.scene.id].isBusy()){changeQueues[ctx.scene.id].on("empty",function(){delete changeQueues[ctx.scene.id]})}else{delete changeQueues[ctx.scene.id]}next()};exo.ui.scenes.isBusy=function(scene){return scene&&scene.files.isSaving()||_.find(changeQueues,function(changeQueue){return changeQueue.isBusy()})}}();exo.ui.files.ListItem=highbrow.extend("ItemView","ListItem",{tagName:"tr"});exo.ui.files.List=highbrow.extend("CollectionView","List",{itemView:exo.ui.files.ListItem,appendHtml:function(el,html){this.$("table.files tbody").append(html)},events:{fileuploadadd:function(){},fileuploaddragover:function(){this.$(".filedrop").addClass("dropping")},fileuploaddrop:function(){this.$(".filedrop").removeClass("dropping")},fileuploaddone:"uploadDone"},uploadDone:function(e,data){this.collection.add(data.result)},data:function(){return{sceneId:this.options.scene.get("id"),sceneName:this.options.scene.get("name")}},onShow:function(){this.$el.fileupload({maxFileSize:2e7,dataType:"json",url:"/api/scenes/"+this.options.scene.id+"/files",dropZone:this.$(".filedrop")})}});!function(){_.each(exo.ui.files,function(view){view.namespace="files"});exo.ui.files.route=function(app){app.page("",fetch,list)};var fetch=function(ctx,next){if(!this.store.files){this.store.set("files",exo.models.Files.init(this.store.context))}this.store.files.fetch({success:function(){next()}})};var list=function(ctx){var view=new exo.ui.files.Files({collection:this.store.files});return view}}();exo.ui.results.ListItem=highbrow.extend("ItemView","ListItem",{tagName:"tr",events:{"click .delete-result":"deleteResult"},deleteResult:function(e){e.preventDefault();this.model.destroy()},onRender:function(e){if(this.model.get("failed")){this.$el.addClass("failed")}}});exo.ui.results.List=highbrow.extend("CollectionView","List",{itemView:exo.ui.results.ListItem,events:{"click .delete-all-results":"deleteResults"},initialize:function(){var uri="/scenes/"+this.options.scene.id+"/results";if(highbrow.browser){this.collectionQueue=new exo.CollectionQueue(window.app.store.queue,this.collection,uri)}this.collection.on("change",function(model){this.children[model.cid].render()},this)},data:function(){return{sceneId:this.options.scene.id,sceneName:this.options.scene.get("name")}},appendHtml:function(el,html){this.$("table.results tbody").append(html)},deleteResults:function(ev){ev.preventDefault();if(window.confirm("Are you sure you wish to delete all results?")){_.each(this.collection.toArray(),function(result){result.destroy()})}}});!function(){_.each(exo.ui.results,function(view,name){view.namespace="results"});exo.ui.results.route=function(app){}}();exo.ui.admin.ApplicationsItem=highbrow.extend("ItemView","ApplicationsItem",{tagName:"tr",events:{"click .grant-referral":"grantReferral","click .delete-application":"deleteApplication"},failResponse:function(errorMessage){$form.find(".alert").html(errorMessage).removeClass("hide");setTimeout(function(){$form.find(".alert").html("").addClass("hide")},1e3)},grantReferral:function(e){e.preventDefault();var referral=new exo.models.Referral({targetEmail:this.model.attributes.email});referral.save({},{success:function(){},error:function(err){console.log(err);return failResponse(err)}})},deleteApplication:function(e){e.preventDefault();this.model.destroy()}});exo.ui.admin.Applications=highbrow.extend("CollectionView","Applications",{appendHtml:function(el,html){this.$("table").append(html)},events:{"click .random-referrals":"randomReferrals"},itemView:exo.ui.admin.ApplicationsItem,view:function(){return _.extend(this.collection.pageInfo(),{query:{pending:!this.options.query||this.options.query==="pending",referred:this.options.query==="referred",deleted:this.options.query==="deleted",all:this.options.query=="all"}})},randomReferrals:function(e){e.preventDefault();var cLength=this.collection.length;for(var i=0;i<10;i++){var cIndex=Math.floor(Math.random()*cLength);console.log(cIndex,cLength);var model=this.collection.at(cIndex);var referral=new exo.models.Referral({targetEmail:model.attributes.email});console.log(model.attributes.email);var asyncResponse=function(email){referral.save({},{success:function(){console.log(email,"success")},error:function(err){console.log(email,err)}})};asyncResponse(model.attributes.email)}}});exo.ui.admin.ReferralsItem=highbrow.extend("ItemView","ReferralsItem",{tagName:"tr"});exo.ui.admin.Referrals=highbrow.extend("CollectionView","Referrals",{appendHtml:function(el,html){this.$("table").append(html)},events:{"click .add-referral":"addReferral"},itemView:exo.ui.admin.ReferralsItem,view:function(){return _.extend(this.collection.pageInfo(),{query:{all:!this.options.query,redeemed:this.options.query==="redeemed",unredeemed:this.options.query==="unredeemed"}})},editEmail:function(e){e.preventDefault();this.$el.find(".help-inline").html("")},addReferral:function(e){e.preventDefault();var ref=new exo.models.Referral;exo.ui.admin.ReferralForm.attach(this.$el,ref,this.collection)}});exo.ui.admin.ReferralForm=highbrow.extend("ItemView","ReferralForm",{className:"modal hide fade",failResponse:function($form){return function(jqXHR){var response=$.parseJSON(jqXHR.responseText);$form.find(".alert").html(response.message).removeClass("hide");$.each(response.errors||{},function(i,err){var fieldErrorMsgId=err.field+"-error-msg";$("#"+fieldErrorMsgId).remove();$form.find("input[name="+err.field+"]").parents(".control-group").addClass("error").find(".controls").append('<span class="help-inline" id="'+fieldErrorMsgId+'">'+err.message+"</span>")})}},initialize:function(){this.$el.modal()},events:{submit:"submit","click .submit":"submit","click .cancel":"cancel"},onRender:function(){var referralView=this;this.$el.on("hidden",function(){})},submit:function(e){e.preventDefault();var $form=this.$el.find(".send-referral");var view=this;$.post("/api/referrals",$form.serialize()).done(function(response){var ref=new exo.models.Referral(response);view.collection.add(ref);view.$el.modal("hide")}).fail(view.failResponse($form))},cancel:function(e){e.preventDefault();this.$el.modal("hide")}},{attach:function($el,model,collection){var referral=new exo.ui.admin.ReferralForm({model:model,collection:collection});var $that=$el;referral.render();referral.onRender();$el.append(referral.el);referral.$el.on("hidden",function(){referral.$el.detach();referral.close()})}});exo.ui.admin.Dashboard=highbrow.extend("ItemView","Dashboard",{});exo.ui.admin.UsersItem=highbrow.extend("ItemView","UsersItem",{tagName:"tr"});exo.ui.admin.Users=highbrow.extend("CollectionView","Users",{appendHtml:function(el,html){this.$("table").append(html)},events:{"change .role-checkbox":"changeRole","change .enable-checkbox":"changeEnabled"},view:function(){return _.extend(this.collection.pageInfo(),{query:{all:!this.options.query,admin:this.options.query==="admin",disabled:this.options.query==="disabled"}})},changeRole:function(event){var $input=$(event.target);var model=this.collection.get($input.data("user"));var role=$input.data("role");var flags=model.get("flags");if($input.prop("checked")){if(flags.indexOf(role)===-1){flags.push(role);model.set("flags",flags)}}else{model.set("flags",_.without(flags,role))}model.save();this.children[model.cid].render()},changeEnabled:function(event){var $input=$(event.target);var model=this.collection.get($input.data("user"));model.save({enabled:event.target.checked});this.children[model.cid].render()},itemView:exo.ui.admin.UsersItem});!function(){_.each(exo.ui.admin,function(view){view.namespace="admin"});var adminInfo=function(ctx,next){ctx.info=exo.models.AdminInfo.init(this.store.context);ctx.info.fetchWithFail(this.store.user,next,"Error fetching admin info")};var dashboard=function(ctx){var view=new exo.ui.admin.Dashboard({model:ctx.info});return view};var users={fetch:function(ctx,next){this.store.set("users",exo.models.Users.init(this.store.context,[],{query:ctx.query()}));this.store.users.fetchWithFail(this.store.user,next,"Error Fetching Users")},list:function(ctx){var view=new exo.ui.admin.Users({collection:this.store.users,query:ctx.query("type")});return view},find:function(ctx,next){ctx.user=this.store.users.findUser(ctx.params.username);next(ctx.user?null:404)},fetchUser:function(ctx,next){ctx.user=exo.models.User.init(this.store.context,{_id:ctx.params.username});ctx.user.fetchWithFail(this.store.user,next,"Error Fetching User")},next:function(ctx){ctx.showNext="/admin/users"}};var scenes={fetch:function(ctx,next){ctx.scenes=exo.sceneGraph.Scenes.init(this.store.context);ctx.scenes.fetch({data:{username:ctx.user.get("username")},success:function(){next()},error:function(model,response){next(response)}})}};var referrals={fetch:function(ctx,next){this.store.set("referrals",exo.models.Referrals.init(this.store.context,[],{query:ctx.query()}));this.store.referrals.fetchWithFail(this.store.user,next,"Error Fetching Referrals")},list:function(ctx){var view=new exo.ui.admin.Referrals({collection:this.store.referrals,query:ctx.query("type")});return view},create:function(ctx){var referral=new exo.models.Referral;var view=new exo.ui.admin.ReferralForm({model:referral});view.on("success",function(){ctx.root.show("/admin/referrals")});return view}};var applications={fetch:function(ctx,next){this.store.set("applications",exo.models.Applications.init(this.store.context,[],{query:ctx.query()}));this.store.applications.fetchWithFail(this.store.user,next,"Error Fetching Applications")},list:function(ctx){var view=new exo.ui.admin.Applications({collection:this.store.applications,query:ctx.query("type")});return view}};exo.ui.admin.route=function(app){app.page("",adminInfo,dashboard);app.page("/users",users.fetch,users.list);exo.ui.user.route(app.mount("/users/:username",users.fetch,users.find,users.next));app.page("/users/:username/scenes",users.fetchUser,scenes.fetch,exo.ui.scenes.list);app.page("/referrals",referrals.fetch,referrals.list);app.page("/referrals/new",referrals.create);app.page("/applications",applications.fetch,applications.list)}}();exo.ui.help.Index=highbrow.extend("ItemView","Index",{initialize:function(){}});!function(){_.each(exo.ui.help,function(view){view.namespace="help"});exo.ui.help.route=function(app){app.page("",index)};var index=function(ctx){var view=new exo.ui.help.Index;return view}}();exo.WebSocket=function(options){options=options||{};this.id=options.id||uuid.v4();this.reconnectNextAt=options.reconnectNextAt||1;this.connected=false;this.retryTimeout=options.retryTimeout||1e3;this.userCookie=options.userCookie;_.bindAll(this);if(options.io)this.setIO(options.io);if(options.url){this.url=options.url;this.connect()}};_.extend(exo.WebSocket.prototype,highbrow.Backbone.Events);_.extend(exo.WebSocket.prototype,{connect:function(reconnectNextAt){var webSocket=this;webSocket.disconnected=false;if(reconnectNextAt)this.reconnectNextAt=reconnectNextAt;var sock=new SockJS(this.url);sock.onopen=function(){webSocket.connected=true;webSocket.reconnectNextAt=1;webSocket.setIO(sock);webSocket.trigger("open",webSocket);console.log("SockJS connection open")};sock.onclose=function(){webSocket.connected=false;console.log("sockjs close, connect in: ",webSocket.reconnectNextAt);webSocket.trigger("close",webSocket);if(!webSocket.disconnected){setTimeout(function(){webSocket.reconnectNextAt=webSocket.reconnectNextAt*2;webSocket.connect()},webSocket.reconnectNextAt*1e3)}}},disconnect:function(){this.disconnected=true;this.io.close()},networkGone:function(){this.io.close()},isOffline:function(){if(this.io===undefined)return true;return this.io.isReady===undefined?this.io.readyState!==1:!this.io.isReady},isOnline:function(){if(this.io===undefined)return false;return this.io.isReady===undefined?this.io.readyState===1:this.io.isReady},setIO:function(io){this.io=io;this.io.onmessage=this.write.bind(this);_.each(this.scenes,this.watch)},write:function(data){var msg=JSON.parse(_.isString(data)?data:data.data);this.trigger(msg.uri,msg)},send:function(info){if(this.isOnline()){this.io.send(JSON.stringify(_.extend({userCookie:this.userCookie},info)),this)}},checkRetry:function(info){var webSocket=this;setTimeout(function(){if(!webSocket.working||webSocket.isOffline())return;var data=webSocket.working.data;if(webSocket.working.type==="change"&&data.id===info.data.id&&data.get("timestamp")===info.data.get("timestamp")){webSocket.send(webSocket.working)}else if(_.isEqual(webSocket.working,info)){webSocket.send(webSocket.working)}},this.retryTimeout)}});exo.ChangeQueue=function(webSocket,scene){this.webSocket=webSocket;this.changes=[];this.outgoingChange=false;this.uri="/scenes/"+scene.id;this.scene=scene;this.webSocket.on(this.uri,this.receive,this);this.webSocket.on("open",this.onOpen,this);if(this.webSocket.isOnline()){this.onOpen()}};_.extend(exo.ChangeQueue.prototype,highbrow.Backbone.Events,{addChange:function(change){var info={event:"transform",uri:this.uri,data:change};var last=this.changes[this.changes.length-1];if(last&&last.data.id===change.id){this.changes[this.changes.length-1]=info}else{this.changes.push(info)}if(!this.outgoingChange)this.work()},changeChange:function(change){this.webSocket.send({event:"change",uri:this.uri,data:_.extend({_id:change.id},change.changed)})},onOpen:function(msg){this.webSocket.send({event:"listen",uri:this.uri,data:{sceneId:this.scene.id,version:this.scene.get("version")}});this.work()},close:function(){this.webSocket.disconnect()},closeWhenEmpty:function(){this.onEmpty(this.close,this)},onEmpty:function(callback,context){if(this.changes.length===0)return callback.call(context);this.once("empty",callback,context)},receive:function(msg){if(this.timeoutId)clearTimeout(this.timeoutId);this.timeoutId=null;var fn={listen:this.receiveListen,transform:this.receiveTransform,change:this.receiveChange,failTransform:this.receiveFailTransform}[msg.event];if(fn){fn.call(this,msg.data)}else{console.error("unknown event",msg.event,msg)}},initializeChange:function(change){if(typeof change.value==="string"){change.value=JSON.parse(change.value)}if(change.scene){delete change.scene}return new exo.sceneGraph.Change(change,{scene:this.scene})},findCollection:function(change){return _.reduce(change.parentChangeIds(),function(changes,id){if(!changes)return false;var parentChange=changes.get(id);return parentChange&&parentChange.changes},this.scene.changes)},receiveChange:function(change){var changeModel=this.initializeChange(change);var changes=this.findCollection(changeModel);var updating=changes&&changes.get(changeModel.id);if(updating){if(change.progress&&updating.get("progress")>change.progress){delete change.progress}updating.set(change,{nosync:true})}},receiveFailTransform:function(info){var change=this.initializeChange(info.change);if(this.outgoingChange&&this.outgoingChange.data.id===change.id){this.outgoingChange=false}var changes=this.findCollection(change);if(!changes){throw new Error("Change parent not found: "+change.get("parentChange"))}change.set({status:"fail"});changes.receiveChange(change);this.trigger("receiveChange",change);this.work();if(highbrow.browser){var pnotify=$.pnotify({title:"Error Saving Change",text:info.error.message,hide:false,icon:"icon-warning-sign icon-white",type:"error"});pnotify.closer.find("span").addClass("icon-white");pnotify.sticker.find("span").addClass("icon-white")}},receiveTransform:function(change){if(change===undefined){this.work();return}change=this.initializeChange(change);if(this.outgoingChange&&this.outgoingChange.data.id===change.id){this.outgoingChange=false}var changes=this.findCollection(change);if(!changes){throw new Error("Change parent not found: "+change.get("parentChange"))}changes.receiveChange(change);this.trigger("receiveChange",change);this.work()},receiveListen:function(msg){_.each(msg.changes||[],function(change){this.receiveChange(change)},this)},isBusy:function(){return this.outgoingChange!==false||this.changes.length!==0},work:function(){if(this.outgoingChange)return;if(!this.changes.length){this.trigger("empty");return}if(this.webSocket.isOffline())return;this.outgoingChange=this.changes.shift();this.webSocket.send(this.outgoingChange);if(this.timeoutId)clearTimeout(this.timeoutId);this.timeoutId=setTimeout(_.bind(this.timeout,this),exo.conf.messageTimeout||1e4)},timeout:function(){this.changes.unshift(this.outgoingChange);console.log("ChangeQueue timeout, network problem?");this.outgoingChange=null;this.webSocket.networkGone()}});exo.CollectionQueue=function(webSocket,collection,uri){this.webSocket=webSocket;this.collection=collection;this.uri=uri;this.webSocket.on(this.uri,this.receive,this);this.webSocket.on("open",this.onOpen,this);if(this.webSocket.isOnline()){this.onOpen()}};_.extend(exo.CollectionQueue.prototype,highbrow.Backbone.Events);_.extend(exo.CollectionQueue.prototype,{onOpen:function(){this.webSocket.send({event:"listen",uri:this.uri})},receive:function(msg){if(this[msg.event+"Message"]){this[msg.event+"Message"](msg.data)}else{console.error("unknown event",msg.event,msg)}},addMessage:function(data){this.collection.add([data])},changeMessage:function(data){var model=this.collection.get(data._id);if(model){model.set(data)}}});!function(){var fromNow=function(attr){return function(){var d=this.model.get(attr);return d?moment(d).fromNow():""}};var createdFromNow=function(){var createdAt=this.model.get("createdAt");if(!createdAt)return"";return moment(this.model.get("createdAt")).fromNow()};exo.ui.vm.Err=highbrow.extend("ViewModel","Err",{});exo.ui.vm.Err.attrs(["message","title","statusCode"]);exo.ui.vm.Camera=highbrow.extend("ViewModel","Camera",{});exo.ui.vm.Camera.attrs(["name"]);exo.ui.vm.Viewport=highbrow.extend("ViewModel","Viewport",{selected:function(){var camera=this.model.camera;var type=camera.get("name");return{name:_.str.humanize(type),propertyType:type}},cameras:function(){var collection=this.model.cameras();return collection.map(function(c){return new exo.ui.vm.Camera(c)})},cameraPresets:function(){return _.map(["perspective","front","back","left","right","top","bottom"],function(type){return{name:_.str.humanize(type),propertyType:type}})},displayName:function(){return{realistic:"Realistic",boundingBox:"Bounding Box",wireframe:"Wireframe",shaded:"Shaded"}[this.model.get("renderType")]},displayTypes:function(){return _.map(["Realistic","Shaded","Wireframe","Bounding Box"],function(type){var propertyType=type.toLowerCase();if(propertyType==="bounding box"){propertyType="boundingBox"}return{type:type,propertyType:propertyType}})},supportsViewports:function(){return this.model.scene.editor().get("webGLSupport")},isLoading:function(){return this.model.scene.files.numLoading()}});exo.ui.vm.Viewport.attrs(["renderType","viewType","position","fullscreen"]);exo.ui.vm.Viewport.boolean(["gridVisible","edges","statsVisible"]);exo.ui.vm.Change=highbrow.ViewModel.extend({cssClass:function(){return{fail:"error",pending:"pending"}[this.model.get("status")]||""},changeValues:function(){var scene=this.model.scene();var opToDesc=function(opInfo){var obj=scene.getByPath(opInfo.path);if(opInfo.op==="exec"){return"exec:"+opInfo.data.key}else{return(obj&&obj.apiName()||"?")+" - "+opInfo.op}};var result=[];var description=function(change,depth,last){_.each(change.getValue(),function(opInfo){var info={pre:_.str.pad("",depth*2),desc:opToDesc(opInfo),changeValues:[],status:change.get("status")};last.push(info);if(change.changes.length){change.changes.each(function(c){if(c.get("status")!=="ok"){description(c,depth+1,info.changeValues)}})}})};description(this.model,0,result);return result},progress:function(){return this.model.get("progress").toString()},numChildren:function(){return this.model.changes.length},heirarchicalProgressPct:function(){return this.model.heirarchicalProgress()*100},complete:function(){return this.model.heirarchicalProgress()===1}});exo.ui.vm.Change.attrs(["version","status","undo","owner"]);exo.ui.vm.Change.pass(["toApi","heirarchicalProgress"]);exo.ui.vm.Change.collection("changes",exo.ui.vm.Change);exo.ui.vm.File=highbrow.ViewModel.extend({assetURL:function(){return this.model.assetURL()},isGeometry:function(){return this.model.isGeometry()},isImage:function(){return this.model.isImage()}});exo.ui.vm.File.attrs(["name","url","size","type","internal","cleanURL"]);exo.ui.vm.Schema=highbrow.extend("ViewModel","Schema",{});exo.ui.vm.Operator=highbrow.extend("ViewModel","Operator",{hasManipulators:function(){return this.model.manipulations&&_.keys(this.model.manipulations).length},manipulations:function(){var id=this.model.id;return _.map(this.model.manipulations,function(manipulator){return{name:manipulator.name,id:id,gizmo:manipulator.gizmo,selected:manipulator.selected?"selected":""}})},isSelected:function(){return this.model===this.model.plug().activeOperator},expandedManipulators:function(){return this.model.expandedManipulators}});exo.ui.vm.Operator.attrs(["type","active"]);exo.ui.vm.Operator.collection_in("plug",function(){return exo.ui.vm.Plug});exo.ui.vm.Plug=highbrow.extend("ViewModel","Plug",{operatorStack:function(){var ops=this.model.operators.map(function(op,index){var selected=this.model.activeOperator===op?"selected":"";var vm=new exo.ui.vm.Operator(op);vm.id=op.id;vm.notBottom=index>0;vm.type=op.operator.name;vm.selected=selected;return vm},this);ops.reverse();return ops},operatorChoices:function(){var operators=this.model.availableOperators();var operatorsArray=[];var operatorsByCategory={Model:{category:"Model",items:[]},Render:{category:"Render",items:[]},Animate:{category:"Animate",items:[]},Simulate:{category:"Simulate",items:[]},None:{items:[]},Information:{category:"Information",items:[]},Creation:{category:"Creation",items:[]}};_.each(operators,function(operator){if(!operator.hidden){var category=operator.category?operator.category:"None";operatorsByCategory[category]=operatorsByCategory[category]||{category:category,items:[]};operatorsByCategory[category].items.push(operator)}});_.each(operatorsByCategory,function(category){category.items=category.items.sort(function(a,b){return a.name>b.name?1:-1
});operatorsArray.push(category)});return operatorsArray},selectedOperator:function(){return new exo.ui.vm.Operator(this.model.activeOperator)},visible:function(){return!this.model.collection.parent.closedPlugs[this.model.get("type")]},isMaterial:function(){return this.model.get("type")==="Material"},isMesh:function(){return this.model.get("type")==="PolyMesh"}});exo.ui.vm.Plug.attrs(["name","type"]);exo.ui.vm.Plug.collection("operators",exo.ui.vm.Operator);var disallowedDragTypes={Scene:true,Objects:true,MaterialLibrary:true,Passes:true,Renderers:true};var nodeViewModel={creationOperator:function(){if(!this.model.plugs.length)return"";if(!this.model.plugs.at(0).operators.length)return"";return this.model.plugs.at(0).operators.at(0).operator.name},creationOperatorImage:function(){var img=this.get("type");if(img==="PolyMesh"){img=this.creationOperator()||img}return img?"/img/"+img+".png":""},materials:function(){var material=this.model.material;return this.model.scene().materials.map(function(mat){return{id:mat.id,name:mat.get("name"),selected:mat===material?'selected="selected"':""}})},allowedChildren:function(){return _.compact(_.map(this.model.allowedChildren,function(name){return _.contains(["Objects","Passes","Renderers"],name)?null:{name:name}}))},removable:function(){return this.model.removable},selected:function(){var editor=this.model.editor?this.model.editor():null;if(editor){if(editor.selected.length){return editor.selected._byId[this.model.id]?"selected":""}else{return editor.modelSelection===this.model?"selected":""}}},collapsedChildren:function(){return this.model.collapsedChildren},isDraggable:function(){return!disallowedDragTypes[this.model.get("type")]},isFile:function(){return this.model instanceof exo.sceneGraph.File},isImage:function(){return this.model instanceof exo.sceneGraph.File&&this.model.isImage()},src:function(){if(this.model instanceof exo.sceneGraph.File&&this.model.isImage()){return this.model.getDataURL()}return""},assetURL:function(){if(this.model instanceof exo.sceneGraph.File){return this.model.assetURL()}return""},cleanURL:function(){if(this.model instanceof exo.sceneGraph.File){return this.model.get("cleanURL")}return""},unavailable:function(){var user=exo.api.pluginRegistry.user;return this.model.userFlag&&!user.isA(this.model.userFlag)}};var pluralized={Object:"Objects",Vertex:"Vertices",Face:"Faces",Edge:"Edges"};var editorViewModel={node:function(){return new exo.ui.vm.Node(this.model.scene)},manipulators:function(){var manipulators=[{key:"Select",icon:"Select",label:"Select",shortcut:"q"},{key:"Move",icon:"Move",label:"Move",shortcut:"w"},{key:"Rotate",icon:"Rotate",label:"Rotate",shortcut:"e"},{key:"Scale",icon:"Scale",label:"Scale",shortcut:"r"}];var active=this.model.get("activeManipulator");var cur=_.find(manipulators,function(m){return active===m.key});if(cur)cur.active="active";return manipulators},selectionName:function(){if(this.model.selected.length===1){return this.model.subSelection.node().get("name")}else if(this.model.selected.length>1){return"Group"}else{return""}},groupName:function(){var type=this.model.subSelection.get("type");var list=type==="Object"?this.model.selected:this.model.subSelection.get("indices");var isSingle=list.length===1;var outOf=type!=="Object"?"/"+this.model.subSelection.available().length:"";return list.length+outOf+" "+(isSingle?type:pluralized[type])},hasSubSelection:function(){return this.model.subSelection.get("type")!=="Object"},isPolyMesh:function(){var node=this.model.subSelection.node();return node?node.isPolyMesh():false},hasSelection:function(){return this.model.selected.length>0},hasGroupOrSubSelection:function(){return this.model.subSelection.get("type")!=="Object"||this.model.selected.length>1}};exo.ui.vm.Node=highbrow.extend("ViewModel","Node",nodeViewModel);exo.ui.vm.Node.attrs(["name","size"]);exo.ui.vm.Node.collection("nodes",exo.ui.vm.Node);exo.ui.vm.Node.collection("plugs",exo.ui.vm.Plug);exo.ui.vm.Scene=highbrow.extend(exo.ui.vm.Node,"Scene",{assets:function(){return _.map(this.model.files.assets(),function(f){return new exo.ui.vm.File(f)})}});exo.ui.vm.Scene.collection("changes",exo.ui.vm.Change);exo.ui.vm.Scene.collection("files",exo.ui.vm.File);exo.ui.vm.Layout=highbrow.extend("ViewModel","Layout",{leftCollapsedShow:function(){return this.model.get("leftCollapsed")?"block":"none"},leftNoCollapsedShow:function(){return this.model.get("leftCollapsed")?"none":"block"},rightCollapsedShow:function(){return this.model.get("rightCollapsed")?"block":"none"},rightNoCollapsedShow:function(){return this.model.get("rightCollapsed")?"none":"block"},bottomCollapsedShow:function(){return this.model.get("bottomCollapsed")?"block":"none"},bottomNoCollapsedShow:function(){return this.model.get("bottomCollapsed")?"none":"block"},leftWidth:function(){return this.model.get("leftCollapsed")?0:this.model.get("leftWidth")},rightWidth:function(){return this.model.get("rightCollapsed")?0:this.model.get("rightWidth")},bottomHeight:function(){return this.model.get("bottomCollapsed")?0:this.model.get("bottomHeight")},centerLeft:function(){return this.model.get("leftCollapsed")?20:this.model.get("leftWidth")},centerRight:function(){return this.model.get("rightCollapsed")?20:this.model.get("rightWidth")},mainBottom:function(){return this.model.get("bottomCollapsed")?this.model.TIMELINE_HEIGHT+this.model.COLLAPSED_WIDTH:this.bottomHeight()+this.model.TIMELINE_HEIGHT},timelineBottom:function(){return this.model.get("bottomCollapsed")?20:this.model.get("bottomHeight")},timelineHeight:function(){return this.model.TIMELINE_HEIGHT}});exo.ui.vm.Layout.attrs(["leftCollapsed","rightCollapsed","bottomCollapsed","tabs"]);exo.ui.vm.Timeline=highbrow.extend("ViewModel","Timeline",{});exo.ui.vm.Timeline.attrs(["playing"]);exo.ui.vm.Notification=highbrow.ViewModel.extend({});exo.ui.vm.Notification.attrs(["title","message","persist","amount","type","showProgress"]);exo.ui.vm.Editor=highbrow.extend("ViewModel","Editor",editorViewModel);exo.ui.vm.Editor.model("scene",exo.ui.vm.Scene);exo.ui.vm.Editor.model("layout",exo.ui.vm.Layout);exo.ui.vm.Editor.model("timeline",exo.ui.vm.Timeline);exo.ui.vm.Editor.collection("notifications",exo.ui.vm.Notification);exo.ui.vm.Editor.attrs(["webGLSupport"]);exo.ui.vm.Result=highbrow.ViewModel.extend({});exo.ui.vm.Result.attrs(["command","done"]);_.extend(exo.ui.vm.Result.prototype,{content:function(){switch(this.model.get("contentType")){case"Files":return _.map(this.model.content(),function(f){return new exo.ui.vm.File(f)});case"File":return new exo.ui.vm.File(this.model.content());default:return this.model.content()}},description:function(){var command=this.model.command();var commandDesc;if(command)commandDesc=command.description||command.name;return this.model.get("description")||commandDesc||this.model.get("command")},createdFromNow:createdFromNow,elapsedTime:function(){return moment(this.model.get("modifiedAt")).diff(this.model.get("createdAt"),"seconds",true)},isFiles:function(){return this.model.get("contentType")==="Files"},isFile:function(){return this.model.get("contentType")==="File"}});exo.ui.vm.Stats=highbrow.extend("ViewModel","Stats",{stats:function(){return _.compact(exo.stats.map(function(info,key){if(info.average===undefined&&info.value===undefined){return false}return _.extend({},info,{value:info.format(info.value===undefined?info.average:info.value)})}))}});exo.ui.vm.Stats.attrs([]);exo.ui.vm.Script=highbrow.extend("ViewModel","Script",{});exo.ui.vm.Script.attrs(["name","text"]);exo.ui.vm.Command=highbrow.extend("ViewModel","Command",{link:function(){return this.model.get("command").link},linkTarget:function(){return this.model.get("command").linkTarget}});exo.ui.vm.Command.attrs(["icon","enabled","visible","label","shortcut","fullName"]);exo.ui.vm.AdminInfo=highbrow.ViewModel.extend({});exo.ui.vm.AdminInfo.attrs(["numUsersActiveNow","numUsersActiveInLastDay","numUsersActiveInLastWeek","numUsersActiveInLastMonth","numUsers","numScenes","referralsSummary","applicationsSummary"]);exo.ui.vm.User=highbrow.ViewModel.extend({username:function(){return this.model.get("username")||this.model.get("email")},emailVerified:function(){return this.model.get("emailStatus").status==="verified"},emailSuccess:function(){if(this.model.get("emailStatus").notice==="success"){this.emailNoteReset();return true}return false},emailFailed:function(){if(this.model.get("emailStatus").notice==="failed"){this.emailNoteReset();return true}return false},emailNoteReset:function(){this.model.set({emailStatus:{notice:""}});this.model.save()},lastUpdated:function(){return moment(this.model.get("updatedAt")).fromNow()},lastActive:function(){var activeTime=this.model.get("lastActive");var isConnected=this.model.get("isConnected");if(isConnected)return"active";else if(activeTime===undefined)return"never";else return moment(activeTime).fromNow()},createdFromNow:createdFromNow,isEnabled:function(){return this.model.isEnabled()},roles:function(){return _.map(["admin","render","plugins"],function(role){return{name:role,selected:this.model.isA(role)}},this)},userAvatar:function(){return getGravatar(this.model.get("email"),25)}});var getGravatar=function(email,size){var emailHash=SparkMD5.hash(email);var defaultAvatar="http://clara.io/img/default_avatar.png";return"http://www.gravatar.com/avatar/"+emailHash+".jpg"+"?s="+size+"&d="+defaultAvatar};exo.ui.vm.User.attrs(["name","email","city","country","website","portfolio","gravatar","password","accountStatus","emailStatus","referral"]);exo.ui.vm.User.pass(["isAdmin","isPlugins"]);exo.ui.vm.Application=highbrow.ViewModel.extend({createdFromNow:createdFromNow,referralFromNow:fromNow("referralDate"),websiteLink:function(){var website=this.model.get("website");if(website&&website.length>1&&!/^(ftp|http|https):\/\//.test(website)){website="http://"+website}return website},code:function(){var priorityCode=this.model.get("priorityCode");if(priorityCode&&priorityCode.length>8){priorityCode=priorityCode.substring(0,7)+"..."}return priorityCode}});exo.ui.vm.Application.attrs(["email","name","jobTitle","company","creationDate","username","twitterFollow","tweetedPromo","facebookLike","discussUsername","discussIntroLink"]);exo.ui.vm.Referral=highbrow.ViewModel.extend({createdFromNow:createdFromNow,redeemedFromNow:fromNow("redeemedAt")});exo.ui.vm.Referral.attrs(["targetEmail","type","token","customMessage","username","redeemedAt"]);exo.ui.vm.Session=highbrow.ViewModel.extend({});exo.ui.vm.Session.attrs(["username","password"]);exo.ui.vm.Notification=highbrow.ViewModel.extend({});exo.ui.vm.Notification.attrs(["type","message"]);_.extend(exo.ui.vm.Scene.prototype,{lastUpdated:fromNow("modifiedAt"),name:function(){return this.model.get("name")},access:function(){var owner={username:this.model.get("owner"),isOwner:true,email:"",permission:"owner"};if(this.model.scene().ownerData.length>0){owner.email=this.model.scene().ownerData.models[0].get("email")}var currAccess=this.model.get("access")||[];var access=[owner].concat(currAccess);for(var i=0;i<access.length;i++){var email=access[i].email||"";access[i].gravatar=getGravatar(email,35)}return access},plugins:function(){return _.map(exo.api.pluginRegistry.list(),function(pluginName){return{name:pluginName}})},pluginShareTypes:function(){return _.map(["example","template","materialLibrary"],function(type){return{type:type}})}});exo.ui.vm.Scene.prototype.createdFromNow=createdFromNow;exo.ui.vm.Scene.attrs(["owner","pluginAccess"]);exo.ui.vm.Scene.date(["createdAt","updatedAt"]);exo.ui.vm.Scene.collection("changes",exo.ui.vm.Change);exo.ui.vm.Plugin=highbrow.ViewModel.extend({lastUpdated:fromNow("modifiedAt")});exo.ui.vm.Plugin.attrs(["name","version","description","loadFromServer"]);exo.ui.vm.Script=highbrow.ViewModel.extend({});exo.ui.vm.Script.attrs(["content"])}();nct.register(nct.r.doif(nct.r.get("analytics",[],"if"),nct.r.multi([nct.r.write("\n"),nct.r.write("\n  <script>\n  analytics.initialize({\n      'Google Analytics' : 'UA-38840155-1',\n      'Mixpanel' : {\n        "),nct.r.write("\n        "),nct.r.doif(nct.r.get("production",[],"if"),nct.r.write("\n          token  : 'b9852bf50a457c8cb60c435035dd7db2',\n        "),nct.r.write("\n          token  : '69cabb016be55a4981a7018466285457',\n        ")),nct.r.write("\n        "),nct.r.write("\n          people : true\n      },\n      'Customer.io' : '46760e24c78041b9f89e'\n    });\n  </script>\n"),nct.r.write("\n")],false)),"_analytics");nct.register(nct.r.doif(nct.r.get("node",[],"if"),nct.r.multi([nct.r.write("\n  "),nct.r.each(nct.r.mget(["node","children"],[],"each"),nct.r.multi([nct.r.write('\n  <a href="'),nct.r.getout_no("url",[],[]),nct.r.write('" class="hub-link">\n    <div class="hub-icon">\n      '),nct.r.doif(nct.r.get("image",[],"if"),nct.r.multi([nct.r.write('\n        <img src="'),nct.r.getout_no("image",[],[]),nct.r.write('" />\n      ')],false),nct.r.write('\n        <img src="/img/Icons/glyphicons_078_warning_sign@2x.png" />\n      ')),nct.r.write("\n      </div>\n      <h2>"),nct.r.getout_no("name",[],[]),nct.r.write("</h2>\n    </a>\n  ")],false)),nct.r.write("\n")],false)),"_hub_idx");nct.register(nct.r.each(nct.r.get("node",[],"each"),nct.r.multi([nct.r.write('\n  <ul class="nav nav-list">\n    '),nct.r.partial("_index_node"),nct.r.write("\n  </ul>\n")],false)),"_index");nct.register(nct.r.multi([nct.r.write('<li id="'),nct.r.getout_no("source",[],[]),nct.r.write('">\n  <a href="'),nct.r.getout_no("url",[],[]),nct.r.write('">'),nct.r.getout_no("name",[],[]),nct.r.write("</a>\n  "),nct.r.doif(nct.r.get("children",[],"if"),nct.r.multi([nct.r.write('\n    <ul class="nav nav-list">\n      '),nct.r.each(nct.r.get("children",[],"each"),nct.r.multi([nct.r.write("\n        "),nct.r.partial("_index_node"),nct.r.write("\n      ")],false)),nct.r.write("\n    </ul>\n  ")],false)),nct.r.write("\n</li>")],false),"_index_node");nct.register(nct.r.multi([nct.r.write("<div class=\"pagination pagination-right\">\n  <ul class=''>\n    <li "),nct.r.unless(nct.r.get("prev",[],"unless"),nct.r.write("class='disabled'")),nct.r.write("><a class='prev'\n    href='"),nct.r.getout("prevUrl",[],[]),nct.r.write("'>Prev</a></li>\n    <li><span>"),nct.r.getout("start",[],[]),nct.r.write(".."),nct.r.getout("end",[],[]),nct.r.write(" of "),nct.r.getout("total",[],[]),nct.r.write("</span></li>\n    <li "),nct.r.unless(nct.r.get("next",[],"unless"),nct.r.write("class='disabled'")),nct.r.write(">\n      <a class='next "),nct.r.unless(nct.r.get("next",[],"unless"),nct.r.write("disabled")),nct.r.write("'\n      href='"),nct.r.getout("nextUrl",[],[]),nct.r.write("'>Next</a>\n    </li>\n  </ul>\n</div>\n")],false),"_pagination");nct.register(nct.r.write("<!-- Place this tag after the last +1 button tag. -->\n<script type=\"text/javascript\">\n  (function() {\n    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;\n    po.src = 'https://apis.google.com/js/plusone.js';\n    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);\n  })();\n</script>\n\n\n<!-- Standard Facebook Like -->\n<div id=\"fb-root\"></div>\n<script>(function(d, s, id) {\n  var js, fjs = d.getElementsByTagName(s)[0];\n  if (d.getElementById(id)) return;\n  js = d.createElement(s); js.id = id;\n  js.src = \"//connect.facebook.net/en_US/all.js#xfbml=1&status=0\";\n  fjs.parentNode.insertBefore(js, fjs);\n}(document, 'script', 'facebook-jssdk'));</script>\n\n<!-- Twitter  -->\n\n<script>\n!function(d,s,id){\n	var js;\n	var fjs=d.getElementsByTagName(s)[0];\n	var p=/^http:/.test(d.location)?'http':'https';\n	\n	if(!d.getElementById(id)){\n		js=d.createElement(s);\n		js.id=id;js.src=p+'://platform.twitter.com/widgets.js';\n		fjs.parentNode.insertBefore(js,fjs);\n	}\n}(document, 'script', 'twitter-wjs');\n</script>"),"_social_media_snippets");nct.register(nct.r.multi([nct.r.write('<div id="mocha" class="integration bottom"></div>\n<script src="/js/mocha.js"></script>\n<script>'),nct.r.write("\n  $script.ready(['three','deps', 'exo'], function() {\n    var i = window.location.href.indexOf('?');\n    var obj = ~i ?  highbrow.querystring.parse(window.location.href.slice(i + 1)) : {};\n    var tests = obj.tests ? obj.tests.split(',') : [];\n    tests = obj.test ? [obj.test] : tests;\n    tests = tests.map(function(t) { return '/integration/'+t+'.js'; });\n\n    $script(['/build/js/test.js', '/integration/helpers.js'], function() {\n      mocha.setup({ui: 'bdd', globals: ['scene','sceneNode']});\n      mocha.suite.bail(true);\n      window.mochaLib = mocha;\n\n      $script(tests, function() {\n        if (top === self) {\n          var runner = mocha.run();\n        } else {\n          if(document.runTest) {\n            document.runTest();\n          } else {\n            document.fullyLoaded = true;\n          }\n        }\n      });\n    });\n  });\n"),nct.r.write("</script>\n")],false),"_test_loading");nct.register(nct.r.multi([nct.r.doif(nct.r.get("title",[],"if"),nct.r.multi([nct.r.write("<h1>"),nct.r.getout("title",[],[]),nct.r.write("<h1>")],false)),nct.r.write("\n<h2>"),nct.r.getout("message",[],[]),nct.r.write("</h2>\n\n")],false),"error");nct.register(nct.r.write('<!DOCTYPE html>\n<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->\n<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->\n<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->\n<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->\n<head>\n  <meta charset="utf-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">'),"header_boilerplate");nct.register(nct.r.multi([nct.r.write('<!DOCTYPE html>\n<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->\n<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->\n<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->\n<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->\n<head>\n  <meta charset="utf-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">\n  <noscript><meta http-equiv="refresh" content="0; url=http://www.activatejavascript.org/"/></noscript>\n  <title>'),nct.r.getout("applicationName",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <link href="'),nct.r.mgetout(["deps","studio_css"],[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n  '),nct.r.doif(nct.r.get("test",[],"if"),nct.r.write('\n  <link rel="stylesheet" href="/css/mocha.css">\n  ')),nct.r.write('\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.doif(nct.r.get("bugsnagApiKey",[],"if"),nct.r.multi([nct.r.write('\n    <script src="//d2wy8f7a9ursnm.cloudfront.net/bugsnag-1.0.4.min.js" data-apikey="'),nct.r.getout_no("bugsnagApiKey",[],[]),nct.r.write('"></script>\n  ')],false)),nct.r.write("\n  <script>"),nct.r.write('\n    (function(a,b,c){typeof c["module"]!="undefined"&&c.module.exports?c.module.exports=b():typeof c["define"]!="undefined"&&c["define"]=="function"&&c.define.amd?define(a,b):c[a]=b()})("$script",function(){function p(a,b){for(var c=0,d=a.length;c<d;++c)if(!b(a[c]))return j;return 1}function q(a,b){p(a,function(a){return!b(a)})}function r(a,b,i){function o(a){return a.call?a():d[a]}function t(){if(!--n){d[m]=1,l&&l();for(var a in f)p(a.split("|"),o)&&!q(f[a],o)&&(f[a]=[])}}a=a[k]?a:[a];var j=b&&b.call,l=j?b:i,m=j?a.join(""):b,n=a.length;return setTimeout(function(){q(a,function(a){if(h[a])return m&&(e[m]=1),h[a]==2&&t();h[a]=1,m&&(e[m]=1),s(!c.test(a)&&g?g+a+".js":a,t)})},0),r}function s(c,d){var e=a.createElement("script"),f=j;e.onload=e.onerror=e[o]=function(){if(e[m]&&!/^c|loade/.test(e[m])||f)return;e.onload=e[o]=null,f=1,h[c]=2,d()},e.async=1,e.src=c,b.insertBefore(e,b.firstChild)}var a=document,b=a.getElementsByTagName("head")[0],c=/^https?:\\/\\//,d={},e={},f={},g,h={},i="string",j=!1,k="push",l="DOMContentLoaded",m="readyState",n="addEventListener",o="onreadystatechange";return!a[m]&&a[n]&&(a[n](l,function t(){a.removeEventListener(l,t,j),a[m]="complete"},j),a[m]="loading"),r.get=s,r.order=function(a,b,c){(function d(e){e=a.shift(),a.length?r(e,d):r(e,b,c)})()},r.path=function(a){g=a},r.ready=function(a,b,c){a=a[k]?a:[a];var e=[];return!q(a,function(a){d[a]||e[k](a)})&&p(a,function(a){return d[a]})?b():!function(a){f[a]=f[a]||[],f[a][k](b),c&&c(e)}(a.join("|")),r},r},this)\n  '),nct.r.write("</script>\n  <!-- "),nct.r.getout("analytics",[],[]),nct.r.write(' -->\n  <script>\n    var self = self || window; // fix bug in fonts.js\n    var pageStart = new Date();\n\n    var loadMessage = function(msg) {\n      var loadingDiv = document.getElementById("loadingMessage");\n      if (loadingDiv) loadingDiv.innerHTML = msg;\n    };\n\n    var loadingTimeout = setTimeout(function() {\n      loadMessage("Loading Error")\n    }, 10000);\n\n    $script(\''),nct.r.mgetout(["deps","three_js"],[],[]),nct.r.write("', 'three');\n    $script('"),nct.r.mgetout(["deps","deps_js"],[],[]),nct.r.write('\', \'deps\');\n    $script.ready([\'three\',\'deps\'], function() {\n      var depsLoaded = new Date();\n      if (typeof THREE === "undefined" || typeof $ === "undefined") {\n        loadMessage("Dependencies not loaded");\n        return;\n      }\n      loadMessage("Loading...");\n     '),nct.r.doif(nct.r.get("minified",[],"if"),nct.r.multi([nct.r.write("\n       $script('"),nct.r.mgetout(["deps","app_js"],[],[]),nct.r.write("', 'exo');\n     ")],false),nct.r.write("\n       $script('/js/appStub.js');\n     ")),nct.r.write("\n      $script.ready('exo', function() {\n        var appLoaded = new Date();\n        exo.on('loaded', function() {\n          clearTimeout(loadingTimeout);\n          $('#loading').remove();\n          "),nct.r.write("\n          if (anlysTest) {\n            analytics.track( 'Test - Deps', { category: 'Test - Load', label: '', value: depsLoaded - pageStart } );\n            analytics.track( 'Test - App', { category: 'Test - Load', label: '', value: appLoaded - depsLoaded } );\n            analytics.track( 'Test - Init', { category: 'Test - Load', label: '', value: new Date() - appLoaded } );\n            analytics.track( 'Test - Total', { category: 'Test - Load', label: '', value: new Date() - pageStart } );\n          }\n          else {\n            analytics.track( 'Deps', { category: 'Load', label: '', value: depsLoaded - pageStart } );\n            analytics.track( 'App', { category: 'Load', label: '', value: appLoaded - depsLoaded } );\n            analytics.track( 'Init', { category: 'Load', label: '', value: new Date() - appLoaded } );\n            analytics.track( 'Total', { category: 'Load', label: '', value: new Date() - pageStart } );\n          }\n          "),nct.r.write("\n        });\n        exo.on('loadError', function(err) {\n          clearTimeout(loadingTimeout);\n          loadMessage(\"Error starting app....\");\n          throw err;\n        });\n        highbrow.setDomLibrary($);\n        "),nct.r.doif(nct.r.get("clientOnly",[],"if"),nct.r.write("\n        exo.initStudio();\n        "),nct.r.multi([nct.r.write("\n        window.app = exo.init("),nct.r.getout_no("appOptions",[],[]),nct.r.write(");\n        ")],false)),nct.r.write('\n      });\n    });\n  </script>\n</head>\n<body>\n  <div id="loading" class=\'loading overlay\'>\n    <div id="loadingMessage" class="message">Loading</div>\n  </div>\n  <div id="topnav" class="uirow"></div>\n  <div class="app-container scroll-y">\n    <div id="app" class="content-body"></div>\n  </div>\n  <div id="editor" style="display: none">\n  </div>\n  '),nct.r.doif(nct.r.get("test",[],"if"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("_test_loading"),nct.r.write("\n  ")],false)),nct.r.write("\n\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n</body>\n</html>\n')],false),"layout");nct.register(nct.r.multi([nct.r.write('<div id="loading" class=\'loading overlay subtle\'>\n  <div id="" class="message">'),nct.r.getout("message",[],[]),nct.r.write("</div>\n</div>\n")],false),"loading");nct.register(nct.r.multi([nct.r.doif(nct.r.get("command",[],"if"),nct.r.multi([nct.r.write('\n<li><a class="command" data-command="'),nct.r.getout("command",[],[]),nct.r.write('" href="#">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n")],false),nct.r.multi([nct.r.write('\n<li class="dropdown'),nct.r.doif(nct.r.get("depth",[],"if"),nct.r.write("-submenu")),nct.r.write('">\n  <a class="dropdown-toggle" data-toggle="dropdown" href="#">'),nct.r.getout("name",[],[]),nct.r.write('</a>\n  <ul class="dropdown-menu" role="menu">\n  '),nct.r.each(nct.r.get("items",[],"each"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("menubar_item"),nct.r.write("\n  ")],false)),nct.r.write("\n  </ul>\n</li>\n")],false)),nct.r.write("\n")],false),"menubar_item");nct.register(nct.r.multi([nct.r.write('<div class="alert alert-'),nct.r.getout("type",[],[]),nct.r.write('">\n  <button type="button" class="close" data-dismiss="alert">x</button>\n  '),nct.r.getout("message",[],[]),nct.r.write("\n</div>\n")],false),"notification");nct.register(nct.r.write('<div class="row">\n</div>\n'),"notifications");nct.register(nct.r.write('<div class="navbar navbar-fixed-top dark top-nav"><div class="container"><a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><div class="span-banner"><a href="/"><img class="banner" src="/img/landing/ClaraLogoBeta-trimmed.png"/></a></div><div class="nav-collapse collapse"><ul class="pull-right nav-pills nav"><li><a href="/learn">Learn</a></li><li><a href="http://discuss.exocortex.com">Forum</a></li><li><a href="http://webchat.freenode.net/?channels=clara.io&uio=d4">Chat</a></li><li><a href="http://exocortex.com/blog">Blog</a></li><li><a href="http://exocortex.com/company">Company</a></li><li class="login"></li></ul></div></div></div>'),"static_top_nav");nct.register(nct.r.multi([nct.r.write('<div class="navbar">\n  <div class="navbar-inner">\n    <a class="brand" href="/" style="padding-top: 3px;">\n      <img src=\'/img/ClaraIO_ColorOnTransparent_450x83.png\' />\n    </a>\n\n    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">\n      <span class="icon-bar icon-white"></span>\n      <span class="icon-bar icon-white"></span>\n      <span class="icon-bar icon-white"></span>\n    </a>\n\n    '),nct.r.doif(nct.r.get("scene",[],"if"),nct.r.multi([nct.r.write('\n      <ul class="nav usernav">\n        <li><a class="brand" href="/scenes">Scenes:</a></li>\n        <li><div class="brand">'),nct.r.mgetout(["scene","name"],[],[]),nct.r.write('</div></li>\n      </ul>\n      <div class="nav-collapse collapse">\n        <ul class="menubar nav">\n        </ul>\n      </div>\n    ')],false),nct.r.multi([nct.r.write('\n      <ul class="nav usernav">\n        <li><a class="brand" href="/scenes">Scenes</a></li>\n        '),nct.r.doif(nct.r.get("isPlugins",[],"if"),nct.r.write('<li><a class="brand" href="/plugins">Plugins</a></li>')),nct.r.write("\n      </ul>\n    ")],false)),nct.r.write('\n\n    <div class="nav-collapse collapse">\n      <ul class="nav usernav pull-right">\n        <li><a href="/learn" target="_blank">Learn</a></li>\n        <li><a href="http://discuss.exocortex.com" target="_blank">Forum</a></li>\n        <li><a href="http://webchat.freenode.net/?channels=clara.io&uio=d4" target="_blank">Chat</a></li>\n        <li class=\'connected\' '),nct.r.unless(nct.r.mget(["webSocket","connected"],[],"unless"),nct.r.write('style="display: none"')),nct.r.write('>\n          <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i\n          class="icon-signal icon-white" /></a>\n          <ul class="dropdown-menu" role="menu">\n            <li><a class="go-offline" href=\'#\'>Go Offline</a></li>\n          </ul>\n        </li>\n        <li class=\'not-connected\' '),nct.r.doif(nct.r.mget(["webSocket","connected"],[],"if"),nct.r.write('style="display: none"')),nct.r.write('>\n          <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i\n          class="icon-warning-sign icon-white" /></a>\n          <ul class="dropdown-menu" role="menu">\n            <li><a class="reconnect">Reconnect</a></li>\n          </ul>\n        </li>\n        '),nct.r.doif(nct.r.get("username",[],"if"),nct.r.multi([nct.r.write('\n          <li class="dropdown">\n            <!--<a class="dropdown-toggle" id="user-dropdown" data-toggle="dropdown" href="#"><i class="icon-user icon-white"></i> '),nct.r.getout("username",[],[]),nct.r.write('</a>-->\n            <a class="dropdown-toggle" id="user-dropdown" data-toggle="dropdown" href="#"><img class="top-avatar" src="'),nct.r.getout("userAvatar",[],[]),nct.r.write('"/> '),nct.r.getout("username",[],[]),nct.r.write('</a>\n            <ul class="dropdown-menu" role="menu">\n              <li><a class=\'\' href="/scenes"><i class="icon-home\n              icon-white"></i> Scenes</a></li>\n              '),nct.r.doif(nct.r.get("isPlugins",[],"if"),nct.r.write('<li><a class=\'\' href="/plugins"><i class="icon-tasks\n              icon-white"></i> Plugins</a></li>')),nct.r.write('\n              <li class="divider"></li>\n              '),nct.r.doif(nct.r.get("screenfull",[],"if"),nct.r.write("\n              <li><a class='fullscreen' href='#'><i class=\"icon-fullscreen\n              icon-white\"></i> Full Screen</a></li>\n              ")),nct.r.write('\n              <li><a class=\'\' href="/user"><i class="icon-cog\n              icon-white"></i> Settings</a></li>\n              '),nct.r.doif(nct.r.get("isAdmin",[],"if"),nct.r.write('\n              <li><a class=\'\' href="/admin"><i class="icon-plane\n              icon-white"></i> Admin</a></li>\n              ')),nct.r.write('\n              <li class="divider"></li>\n              <li><a class=\'logout\' href="#"><i class="icon-off\n              icon-white"></i> Log Out</a></li>\n            </ul>\n          </li>\n        ')],false)),nct.r.write("\n      </ul>\n    </div>\n  </div>\n</div>\n\n")],false),"top_nav");nct.register(nct.r.doif(nct.r.get("analytics",[],"if"),nct.r.multi([nct.r.write("\n"),nct.r.write("\n  <script>\n  analytics.initialize({\n      'Google Analytics' : 'UA-38840155-1',\n      'Mixpanel' : {\n        "),nct.r.write("\n        "),nct.r.doif(nct.r.get("production",[],"if"),nct.r.write("\n          token  : 'b9852bf50a457c8cb60c435035dd7db2',\n        "),nct.r.write("\n          token  : '69cabb016be55a4981a7018466285457',\n        ")),nct.r.write("\n        "),nct.r.write("\n          people : true\n      },\n      'Customer.io' : '46760e24c78041b9f89e'\n    });\n  </script>\n"),nct.r.write("\n")],false)),"_analytics");nct.register(nct.r.doif(nct.r.get("node",[],"if"),nct.r.multi([nct.r.write("\n  "),nct.r.each(nct.r.mget(["node","children"],[],"each"),nct.r.multi([nct.r.write('\n  <a href="'),nct.r.getout_no("url",[],[]),nct.r.write('" class="hub-link">\n    <div class="hub-icon">\n      '),nct.r.doif(nct.r.get("image",[],"if"),nct.r.multi([nct.r.write('\n        <img src="'),nct.r.getout_no("image",[],[]),nct.r.write('" />\n      ')],false),nct.r.write('\n        <img src="/img/Icons/glyphicons_078_warning_sign@2x.png" />\n      ')),nct.r.write("\n      </div>\n      <h2>"),nct.r.getout_no("name",[],[]),nct.r.write("</h2>\n    </a>\n  ")],false)),nct.r.write("\n")],false)),"_hub_idx");nct.register(nct.r.each(nct.r.get("node",[],"each"),nct.r.multi([nct.r.write('\n  <ul class="nav nav-list">\n    '),nct.r.partial("_index_node"),nct.r.write("\n  </ul>\n")],false)),"_index");nct.register(nct.r.multi([nct.r.write('<li id="'),nct.r.getout_no("source",[],[]),nct.r.write('">\n  <a href="'),nct.r.getout_no("url",[],[]),nct.r.write('">'),nct.r.getout_no("name",[],[]),nct.r.write("</a>\n  "),nct.r.doif(nct.r.get("children",[],"if"),nct.r.multi([nct.r.write('\n    <ul class="nav nav-list">\n      '),nct.r.each(nct.r.get("children",[],"each"),nct.r.multi([nct.r.write("\n        "),nct.r.partial("_index_node"),nct.r.write("\n      ")],false)),nct.r.write("\n    </ul>\n  ")],false)),nct.r.write("\n</li>")],false),"_index_node");
nct.register(nct.r.multi([nct.r.write("<div class=\"pagination pagination-right\">\n  <ul class=''>\n    <li "),nct.r.unless(nct.r.get("prev",[],"unless"),nct.r.write("class='disabled'")),nct.r.write("><a class='prev'\n    href='"),nct.r.getout("prevUrl",[],[]),nct.r.write("'>Prev</a></li>\n    <li><span>"),nct.r.getout("start",[],[]),nct.r.write(".."),nct.r.getout("end",[],[]),nct.r.write(" of "),nct.r.getout("total",[],[]),nct.r.write("</span></li>\n    <li "),nct.r.unless(nct.r.get("next",[],"unless"),nct.r.write("class='disabled'")),nct.r.write(">\n      <a class='next "),nct.r.unless(nct.r.get("next",[],"unless"),nct.r.write("disabled")),nct.r.write("'\n      href='"),nct.r.getout("nextUrl",[],[]),nct.r.write("'>Next</a>\n    </li>\n  </ul>\n</div>\n")],false),"_pagination");nct.register(nct.r.write("<!-- Place this tag after the last +1 button tag. -->\n<script type=\"text/javascript\">\n  (function() {\n    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;\n    po.src = 'https://apis.google.com/js/plusone.js';\n    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);\n  })();\n</script>\n\n\n<!-- Standard Facebook Like -->\n<div id=\"fb-root\"></div>\n<script>(function(d, s, id) {\n  var js, fjs = d.getElementsByTagName(s)[0];\n  if (d.getElementById(id)) return;\n  js = d.createElement(s); js.id = id;\n  js.src = \"//connect.facebook.net/en_US/all.js#xfbml=1&status=0\";\n  fjs.parentNode.insertBefore(js, fjs);\n}(document, 'script', 'facebook-jssdk'));</script>\n\n<!-- Twitter  -->\n\n<script>\n!function(d,s,id){\n	var js;\n	var fjs=d.getElementsByTagName(s)[0];\n	var p=/^http:/.test(d.location)?'http':'https';\n	\n	if(!d.getElementById(id)){\n		js=d.createElement(s);\n		js.id=id;js.src=p+'://platform.twitter.com/widgets.js';\n		fjs.parentNode.insertBefore(js,fjs);\n	}\n}(document, 'script', 'twitter-wjs');\n</script>"),"_social_media_snippets");nct.register(nct.r.multi([nct.r.write('<div id="mocha" class="integration bottom"></div>\n<script src="/js/mocha.js"></script>\n<script>'),nct.r.write("\n  $script.ready(['three','deps', 'exo'], function() {\n    var i = window.location.href.indexOf('?');\n    var obj = ~i ?  highbrow.querystring.parse(window.location.href.slice(i + 1)) : {};\n    var tests = obj.tests ? obj.tests.split(',') : [];\n    tests = obj.test ? [obj.test] : tests;\n    tests = tests.map(function(t) { return '/integration/'+t+'.js'; });\n\n    $script(['/build/js/test.js', '/integration/helpers.js'], function() {\n      mocha.setup({ui: 'bdd', globals: ['scene','sceneNode']});\n      mocha.suite.bail(true);\n      window.mochaLib = mocha;\n\n      $script(tests, function() {\n        if (top === self) {\n          var runner = mocha.run();\n        } else {\n          if(document.runTest) {\n            document.runTest();\n          } else {\n            document.fullyLoaded = true;\n          }\n        }\n      });\n    });\n  });\n"),nct.r.write("</script>\n")],false),"_test_loading");nct.register(nct.r.multi([nct.r.write('<ul class="breadcrumb">\n  <li><a href="/admin">Admin</a> <span class="divider">/</span></li>\n  <li class="active">Applications</li>\n</ul>\n<div class="title">\n  <a class="btn btn-primary pull-right random-referrals" href="#">Random Referrals</a>\n  <h1>Applications</h1>\n</div>\n<div class="row">\n  <div class="span6">\n    <ul class="nav nav-pills" style="margin: 18px 0;">\n      <li class="'),nct.r.doif(nct.r.mget(["query","pending"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/applications?type=pending">Pending</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","referred"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/applications?type=referred">Referred</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","deleted"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/applications?type=deleted">Deleted</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","all"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/applications?type=all">All</a></li>\n    </ul>\n  </div>\n  <div class="span6">\n    '),nct.r.partial("_pagination"),nct.r.write("\n  </div>\n</div>\n<div class=\"alert hide\"></div>\n<table class='table table-hover admin'>\n  <thead>\n    <tr>\n      <th>Email</th>\n      <th>Name</th>\n      <th>Title</th>\n      <th>Company</th>\n      <th>Website</th>\n      <th>Code</th>\n      <th>Forum</th>\n      <th>Created</th>\n      <th>Referred</th>\n      <th>Username</th>\n      <th></th>\n    </tr>\n  </thead>\n</table>\n"),nct.r.partial("_pagination"),nct.r.write("\n")],false),"admin/applications");nct.register(nct.r.multi([nct.r.write('<td><a href="mailto:'),nct.r.getout("email",[],[]),nct.r.write('">'),nct.r.getout("email",[],[]),nct.r.write("</a></td>\n<td>"),nct.r.getout("name",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("jobTitle",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("company",[],[]),nct.r.write("</td>\n<td>"),nct.r.doif(nct.r.get("websiteLink",[],"if"),nct.r.multi([nct.r.write('<a href="'),nct.r.getout("websiteLink",[],[]),nct.r.write('" target="_blank">Link</a>')],false)),nct.r.write("</td>\n<td>"),nct.r.getout("code",[],[]),nct.r.write("</td>\n<td>"),nct.r.doif(nct.r.get("discussUsername",[],"if"),nct.r.multi([nct.r.write('<a href="http://discuss.exocortex.com/users/'),nct.r.getout("discussUsername",[],[]),nct.r.write('">'),nct.r.getout("discussUsername",[],[]),nct.r.write("</a>")],false)),nct.r.doif(nct.r.get("discussIntroLink",[],"if"),nct.r.multi([nct.r.write(' <a href="'),nct.r.getout("discussIntroLink",[],[]),nct.r.write('" target="_blank">(Intro)</a>')],false)),nct.r.write("</td>\n<td>"),nct.r.getout("createdFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("referralFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("username",[],[]),nct.r.write('</td>\n<td>\n  <div class="btn-group">\n    <a class="btn dropdown-toggle" data-toggle="dropdown"\n    href="#">Actions <span class="caret"></span></a>\n    <ul class="dropdown-menu">\n      <li><a href="#" class=\'grant-referral\'>Grant Referral</a></li>\n      <li><a href="#" class=\'delete-application\'>Delete</a></li>\n    </ul>\n  </div>\n</td>\n')],false),"admin/applications_item");nct.register(nct.r.multi([nct.r.write("<ul class=\"breadcrumb\">\n  <li class=\"active\">Admin</li>\n</ul>\n<div class='row'>\n  <div class='span3'>\n    <ul class='user-settings nav nav-pills nav-stacked'>\n      <li class=\"active\"><a href='/admin'>Dashboard</a></li>\n      <li><a href='/admin/users'>Users</a></li>\n      <li><a href='/admin/referrals'>Referrals</a></li>\n      <li><a href='/admin/applications'>Applications</a></li>\n      <li><a href='/kue'>Kue</a></li>\n    </ul>\n  </div>\n  <div class='span8'>\n    <div class='row'>\n      <div class='box'>\n        <h3>Users: "),nct.r.getout("numUsers",[],[]),nct.r.write(" (X:"),nct.r.getout("numUsersActiveNow",[],[]),nct.r.write(", D:"),nct.r.getout("numUsersActiveInLastDay",[],[]),nct.r.write(", W:"),nct.r.getout("numUsersActiveInLastWeek",[],[]),nct.r.write(", M:"),nct.r.getout("numUsersActiveInLastMonth",[],[]),nct.r.write(")</h3>\n        <h3>Scenes: "),nct.r.getout("numScenes",[],[]),nct.r.write("</h3>\n        <h3>Referrals: "),nct.r.getout("referralsSummary",[],[]),nct.r.write("</h3>\n        <h3>Applications: "),nct.r.getout("applicationsSummary",[],[]),nct.r.write("</h3>\n      </div>\n    </div>\n  </div>\n</div>\n")],false),"admin/dashboard");nct.register(nct.r.multi([nct.r.write('<div class="modal-header"><h3>Send Referral</h3></div><div class="modal-body"><form class="send-referral collapsed"><fieldset><div class="alert hide"></div><div class="control-group '),nct.r.mgetout(["error","targetEmail"],[],[]),nct.r.write(' undefined"><label class="control-label" for="targetEmail">Email</label><div class="controls"><input class="span4" name="targetEmail" value="'),nct.r.getout("targetEmail",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","targetEmail"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","targetEmail_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div></fieldset></form></div><div class="modal-footer"><button class="btn btn-primary submit" type="submit">Send Referral</button><button class="btn cancel" type="button">Cancel</button></div>')],false),"admin/referral_form");nct.register(nct.r.multi([nct.r.write('<ul class="breadcrumb">\n  <li><a href="/admin">Admin</a> <span class="divider">/</span></li>\n  <li class="active">Referrals</li>\n</ul>\n<div class="title">\n  <a class="btn btn-primary pull-right add-referral" href="#">Add New Referral</a>\n  <h1>Referrals</h1>\n</div>\n<div class="row">\n  <div class="span6">\n    <ul class="nav nav-pills">\n      <li class="'),nct.r.doif(nct.r.mget(["query","all"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/referrals">All</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","unredeemed"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/referrals?type=unredeemed">Unredeemed</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","redeemed"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/referrals?type=redeemed">Redeemed</a></li>\n    </ul>\n  </div>\n  <div class="span6">\n    '),nct.r.partial("_pagination"),nct.r.write("\n  </div>\n</div>\n<table class='table table-hover admin'>\n  <thead>\n    <tr>\n      <th>email</th>\n      <th>token</th>\n      <th>created</th>\n      <th>redeemed</th>\n      <th>username</th>\n      <th>message</th>\n    </tr>\n  </thead>\n</table>\n"),nct.r.partial("_pagination"),nct.r.write("\n")],false),"admin/referrals");nct.register(nct.r.multi([nct.r.write("<td>"),nct.r.getout("targetEmail",[],[]),nct.r.write("</a></td>\n<td>"),nct.r.getout("id",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("createdFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("redeemedFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("username",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("customMessage",[],[]),nct.r.write("</td>\n")],false),"admin/referrals_item");nct.register(nct.r.multi([nct.r.write('<ul class="breadcrumb">\n  <li><a href="/admin">Admin</a> <span class="divider">/</span></li>\n  <li class="active">Users</li>\n</ul>\n<div class="title">\n  <h1>Users</h1>\n</div>\n<div class="row">\n  <div class="span6">\n    <ul class="nav nav-pills">\n      <li class="'),nct.r.doif(nct.r.mget(["query","all"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/users">All</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","admin"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/users?type=admin">Admin</a></li>\n      <li class="'),nct.r.doif(nct.r.mget(["query","disabled"],[],"if"),nct.r.write("active")),nct.r.write('"><a href="/admin/users?type=disabled">Disabled</a></li>\n    </ul>\n  </div>\n  <div class="span6">\n    '),nct.r.partial("_pagination"),nct.r.write("\n  </div>\n</div>\n<table class='table table-hover admin'>\n  <thead>\n	<tr>\n	  <th>username</th>\n	  <th>scenes</th>\n	  <th>name</th>\n	  <th>created</th>\n	  <th>last active</th>\n	  <th>roles</th>\n	  <th>enabled</th>\n	</tr>\n  </thead>\n</table>\n"),nct.r.partial("_pagination"),nct.r.write("\n\n\n\n")],false),"admin/users");nct.register(nct.r.multi([nct.r.write("<td><a href='/admin/users/"),nct.r.getout("id",[],[]),nct.r.write("'>"),nct.r.getout("username",[],[]),nct.r.write("</a></td>\n<td><a href='/admin/users/"),nct.r.getout("id",[],[]),nct.r.write("/scenes'>Scenes</a></td>\n<td>"),nct.r.getout("name",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("createdFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("lastActive",[],[]),nct.r.write('</td>\n<td>\n  <div class="btn-group">\n    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">\n      '),nct.r.each(nct.r.get("roles",[],"each"),nct.r.doif(nct.r.get("selected",[],"if"),nct.r.multi([nct.r.getout("name",[],[]),nct.r.write(",")],false))),nct.r.write('\n      <span class="caret"></span>\n    </a>\n    <ul class="dropdown-menu">'),nct.r.each(nct.r.get("roles",[],"each"),nct.r.multi([nct.r.write("\n      <li><label><input class='role-checkbox' data-user='"),nct.r.getout("id",[],[]),nct.r.write("' data-role='"),nct.r.getout("name",[],[]),nct.r.write("' type='checkbox' "),nct.r.doif(nct.r.get("selected",[],"if"),nct.r.write("checked='checked'")),nct.r.write(">"),nct.r.getout("name",[],[]),nct.r.write("</input></li></label>\n    ")],false)),nct.r.write("</ul>\n  </div>\n</td>\n<td> \n  <input class='enable-checkbox' type=\"checkbox\" data-user='"),nct.r.getout("id",[],[]),nct.r.write('\' name="vehicle" value="Bike" '),nct.r.doif(nct.r.get("isEnabled",[],"if"),nct.r.write('checked="checked"')),nct.r.write(' align="center">\n</td>\n')],false),"admin/users_item");nct.register(nct.r.multi([nct.r.write('<div class="accordion assets" id="assets">\n  <div class="accordion-group">\n    <div class="accordion-heading">\n      <a class="accordion-toggle toggle-assets" href="#assets-body"><i class="toggler icon-chevron-down icon-white"></i> Assets</a>\n    </div>\n    <div id="assets-body" class="files accordion-body">\n      '),nct.r.each(nct.r.mget(["scene","assets"],[],"each"),nct.r.multi([nct.r.write("\n        "),nct.r.unless(nct.r.get("internal",[],"unless"),nct.r.multi([nct.r.write("\n          "),nct.r.unless(nct.r.get("isGeometry",[],"unless"),nct.r.multi([nct.r.write('\n            <div class="dropdown select-node" data-id="'),nct.r.getout("id",[],[]),nct.r.write('">\n              <div class="node-container">\n                <div class="node-name asset-name">\n                  '),nct.r.getout("name",[],[]),nct.r.write("\n                </div>\n              </div>\n            </div>\n          ")],false)),nct.r.write("\n        ")],false)),nct.r.write("\n      ")],false)),nct.r.write("\n      "),nct.r.unless(nct.r.mget(["scene","assets","length"],[],"unless"),nct.r.write("\n        You currently have no assets. Try dragging and dropping some in.\n      ")),nct.r.write("\n    </div>\n  </div>\n</div>\n")],false),"editor/assets");nct.register(nct.r.multi([nct.r.write("<canvas></canvas>\n<div class='dropdown'>\n  <a class=\"dropdown-toggle selected-camera\" data-toggle=\"dropdown\" href=\"#\">Camera: Default\n  Camera</a>\n  <ul class='dropdown-menu' role='menu'>\n    "),nct.r.each(nct.r.get("cameras",[],"each"),nct.r.multi([nct.r.write('\n    <li><a data-camera="'),nct.r.getout("id",[],[]),nct.r.write("\" tabindex='-1' class='switch-camera' href='#'>"),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n    ")],false)),nct.r.write("\n  </ul>\n</div>\n")],false),"editor/canvas");nct.register(nct.r.multi([nct.r.getout("version",[],[]),nct.r.write(", "),nct.r.getout("owner",[],[]),nct.r.doif(nct.r.get("undo",[],"if"),nct.r.write(" <span class='undo'>UNDO</span>")),nct.r.write("\n"),nct.r.partial("editor/change_leaf"),nct.r.write("\n"),nct.r.unless(nct.r.get("complete",[],"unless"),nct.r.multi([nct.r.write('\n<div class="progress">\n  <div class="bar" style="width: '),nct.r.getout("heirarchicalProgressPct",[],[]),nct.r.write('%"></div>\n</div>\n')],false)),nct.r.write("\n")],false),"editor/change_item");nct.register(nct.r.multi([nct.r.write("<ul>\n"),nct.r.each(nct.r.get("changeValues",[],"each"),nct.r.multi([nct.r.write('\n<li class="'),nct.r.getout("status",[],[]),nct.r.write('">'),nct.r.getout("pre",[],[]),nct.r.getout("desc",[],[]),nct.r.write("\n"),nct.r.doif(nct.r.get("changeValues",[],"if"),nct.r.multi([nct.r.write("\n"),nct.r.partial("editor/change_leaf"),nct.r.write("\n")],false)),nct.r.write("\n</li>\n")],false)),nct.r.write("\n</ul>\n")],false),"editor/change_leaf");nct.register(nct.r.multi([nct.r.write('<COLLADA xmlns="http://www.collada.org/2005/11/COLLADASchema" version="1.4.1">\n    <asset>\n        <contributor>\n            <authoring_tool>'),nct.r.getout("toolName",[],[]),nct.r.write("</authoring_tool>\n        </contributor>\n        <created>"),nct.r.getout("date",[],[]),nct.r.write("</created>\n        <up_axis>Y_UP</up_axis>\n    </asset>"),nct.r.doif(nct.r.mget(["cameras","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_cameras>\n        "),nct.r.each(nct.r.get("cameras",[],"each"),nct.r.multi([nct.r.write('\n        <camera id="'),nct.r.getout("id",[],[]),nct.r.write('Shape" name="'),nct.r.getout("name",[],[]),nct.r.write('Shape">\n            <optics>\n                <technique_common>\n                    <perspective>\n                        <yfov>'),nct.r.getout("fieldOfView",[],[]),nct.r.write("</yfov>\n                        <aspect_ratio>"),nct.r.getout("aspectRatio",[],[]),nct.r.write("</aspect_ratio>\n                        <znear>"),nct.r.getout("nearClip",[],[]),nct.r.write("</znear>\n                        <zfar>"),nct.r.getout("farClip",[],[]),nct.r.write("</zfar>\n                    </perspective>\n                </technique_common>\n            </optics>\n        </camera>\n        ")],false)),nct.r.write("\n    </library_cameras>")],false)),nct.r.doif(nct.r.mget(["lights","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_lights>\n        "),nct.r.each(nct.r.get("lights",[],"each"),nct.r.multi([nct.r.write('\n        <light id="'),nct.r.getout("id",[],[]),nct.r.write('Shape" name="'),nct.r.getout("name",[],[]),nct.r.write('Shape">\n            <technique_common>\n                <'),nct.r.getout("lightType",[],[]),nct.r.write(">\n                    <color>"),nct.r.getout("color",[],[]),nct.r.write("</color>"),nct.r.doif(nct.r.get("intensity",[],"if"),nct.r.multi([nct.r.write("\n                    <intensity>"),nct.r.getout("intensity",[],[]),nct.r.write("</intensity>")],false)),nct.r.doif(nct.r.get("distance",[],"if"),nct.r.multi([nct.r.write("\n                    <distance>"),nct.r.getout("distance",[],[]),nct.r.write("</distance>")],false)),nct.r.write("\n                </"),nct.r.getout("lightType",[],[]),nct.r.write(">\n            </technique_common>\n        </light>\n        ")],false)),nct.r.write("\n    </library_lights>")],false)),nct.r.doif(nct.r.mget(["images","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_images>\n        "),nct.r.each(nct.r.get("images",[],"each"),nct.r.multi([nct.r.write('\n        <image id="'),nct.r.getout("fileId",[],[]),nct.r.write('" name="'),nct.r.getout("fileId",[],[]),nct.r.write('" depth="1">\n            <init_from>./'),nct.r.getout("fileName",[],[]),nct.r.write("</init_from>\n        </image>\n        ")],false)),nct.r.write("\n    </library_images>")],false)),nct.r.doif(nct.r.mget(["materials","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_materials>\n        "),nct.r.each(nct.r.get("materials",[],"each"),nct.r.multi([nct.r.write('\n        <material id="'),nct.r.getout("id",[],[]),nct.r.write('" name="'),nct.r.getout("name",[],[]),nct.r.write('">\n            <instance_effect url="#fx'),nct.r.getout("id",[],[]),nct.r.write('"/>\n        </material>\n        ')],false)),nct.r.write("\n    </library_materials>")],false)),nct.r.doif(nct.r.mget(["effects","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_effects>\n        "),nct.r.each(nct.r.get("effects",[],"each"),nct.r.multi([nct.r.write('\n        <effect id="fx'),nct.r.getout("id",[],[]),nct.r.write('">\n            <profile_COMMON>'),nct.r.doif(nct.r.get("hasTexture",[],"if"),nct.r.multi([nct.r.write('\n                <newparam sid="'),nct.r.getout("fileId",[],[]),nct.r.write('-surface">\n                    <surface type="2D">\n                        <init_from>'),nct.r.getout("fileId",[],[]),nct.r.write('</init_from>\n                        <format>A8R8G8B8</format>\n                    </surface>\n                </newparam>\n                <newparam sid="'),nct.r.getout("fileId",[],[]),nct.r.write('-sampler">\n                    <sampler2D>\n                        <source>'),nct.r.getout("fileId",[],[]),nct.r.write("-surface</source>\n                        <minfilter>LINEAR_MIPMAP_LINEAR</minfilter>\n                        <magfilter>LINEAR</magfilter>\n                    </sampler2D>\n                </newparam>")],false)),nct.r.write('\n                <technique sid="common">\n                    <blinn>\n                        <emission>\n                            <color>0 0 0</color>\n                        </emission>\n                        <ambient>\n                            <color>0 0 0</color>\n                        </ambient>\n                        <diffuse>\n                            '),nct.r.doif(nct.r.get("hasTexture",[],"if"),nct.r.multi([nct.r.write('<texture texture="'),nct.r.getout("fileId",[],[]),nct.r.write('-sampler" texcoord="TEX0"/>')],false),nct.r.multi([nct.r.write("<color>"),nct.r.getout("color",[],[]),nct.r.write("</color>")],false)),nct.r.write("\n                        </diffuse>\n                        <specular>\n                            <color>"),nct.r.getout("specular",[],[]),nct.r.write("</color>\n                        </specular>\n                        <shininess>\n                            <float>1</float>\n                        </shininess>\n                        <reflective>\n                            <color>0 0 0 1</color>\n                        </reflective>\n                        <reflectivity>\n                            <float>0.5</float>\n                        </reflectivity>\n                        <transparent>\n                            <color>0 0 0 1</color>\n                        </transparent>\n                        <transparency>\n                            <float>"),nct.r.getout("opacity",[],[]),nct.r.write("</float>\n                        </transparency>\n                        <index_of_refraction>\n                            <float>1</float>\n                        </index_of_refraction>\n                    </blinn>\n                </technique>\n            </profile_COMMON>\n        </effect>\n        ")],false)),nct.r.write("\n    </library_effects>")],false)),nct.r.doif(nct.r.mget(["meshes","length"],[],"if"),nct.r.multi([nct.r.write("\n    <library_geometries>\n        "),nct.r.each(nct.r.get("meshes",[],"each"),nct.r.multi([nct.r.write('\n        <geometry id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib" name="'),nct.r.getout("name",[],[]),nct.r.write('Shape">\n            <mesh>\n                <source id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-positions" name="position">\n                    <float_array id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-positions-array" count="'),nct.r.getout("positionFullLength",[],[]),nct.r.write('">'),nct.r.getout("vertices",[],[]),nct.r.write('</float_array>\n                    <technique_common>\n                        <accessor count="'),nct.r.getout("positionLength",[],[]),nct.r.write('" offset="0" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-positions-array" stride="3">\n                            <param name="X" type="float"/>\n                            <param name="Y" type="float"/>\n                            <param name="Z" type="float"/>\n                        </accessor>\n                    </technique_common>\n                </source>'),nct.r.doif(nct.r.get("normals",[],"if"),nct.r.multi([nct.r.write('\n                <source id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-normals" name="normal">\n                    <float_array id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-normals-array" count="'),nct.r.getout("normalsFullLength",[],[]),nct.r.write('">'),nct.r.getout("normals",[],[]),nct.r.write('</float_array>\n                    <technique_common>\n                        <accessor count="'),nct.r.getout("normalsLength",[],[]),nct.r.write('" offset="0" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-normals-array" stride="3">\n                            <param name="X" type="float"/>\n                            <param name="Y" type="float"/>\n                            <param name="Z" type="float"/>\n                        </accessor>\n                    </technique_common>\n                </source>')],false)),nct.r.doif(nct.r.get("uvs",[],"if"),nct.r.multi([nct.r.write('\n                <source id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-map1" name="map1">\n                    <float_array id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-map1-array" count="'),nct.r.getout("uvsFullLength",[],[]),nct.r.write('">'),nct.r.getout("uvs",[],[]),nct.r.write('</float_array>\n                    <technique_common>\n                        <accessor count="'),nct.r.getout("uvsLength",[],[]),nct.r.write('" offset="0" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-map1-array" stride="2">\n                            <param name="S" type="float"/>\n                            <param name="T" type="float"/>\n                        </accessor>\n                    </technique_common>\n                </source>')],false)),nct.r.write('\n                <vertices id="'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-vertices">\n                    <input semantic="POSITION" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-positions"/>\n                </vertices>\n                <triangles count="'),nct.r.getout("faceLength",[],[]),nct.r.write('">\n                    <input offset="0" semantic="VERTEX" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-vertices"/>'),nct.r.doif(nct.r.get("normals",[],"if"),nct.r.multi([nct.r.write('\n                    <input offset="1" semantic="NORMAL" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-normals"/>')],false)),nct.r.doif(nct.r.get("uvs",[],"if"),nct.r.multi([nct.r.write('\n                    <input offset="2" semantic="TEXCOORD" source="#'),nct.r.getout("name",[],[]),nct.r.write('Shape-lib-map1" set="0"/>')],false)),nct.r.write("\n                    <p>"),nct.r.getout("faces",[],[]),nct.r.write("</p>\n                </triangles>\n            </mesh>\n        </geometry>\n        ")],false)),nct.r.write("\n    </library_geometries>")],false)),nct.r.doif(nct.r.mget(["nodes","length"],[],"if"),nct.r.multi([nct.r.write('\n    <library_visual_scenes>\n        <visual_scene id="'),nct.r.getout("sceneName",[],[]),nct.r.write('" name="'),nct.r.getout("sceneName",[],[]),nct.r.write('">\n            '),nct.r.each(nct.r.get("nodes",[],"each"),nct.r.multi([nct.r.write("\n                "),nct.r.partial("editor/collada_node"),nct.r.write("\n            ")],false)),nct.r.write("\n        </visual_scene>\n    </library_visual_scenes>")],false)),nct.r.write('\n    <scene>\n        <instance_visual_scene url="#'),nct.r.getout("sceneName",[],[]),nct.r.write('"/>\n    </scene>\n</COLLADA>\n')],false),"editor/collada");nct.register(nct.r.multi([nct.r.write('<node id="'),nct.r.getout("id",[],[]),nct.r.write('" name="'),nct.r.getout("name",[],[]),nct.r.write('">'),nct.r.doif(nct.r.get("position",[],"if"),nct.r.multi([nct.r.write('\n    <translate sid="translate">'),nct.r.getout("position",[],[]),nct.r.write("</translate>")],false)),nct.r.doif(nct.r.get("scale",[],"if"),nct.r.multi([nct.r.write('\n    <scale sid="scale">'),nct.r.getout("scale",[],[]),nct.r.write("</scale>")],false)),nct.r.write('\n    <rotate sid="rotateX">1 0 0 '),nct.r.getout("rotationX",[],[]),nct.r.write('</rotate>\n    <rotate sid="rotateY">0 1 0 '),nct.r.getout("rotationY",[],[]),nct.r.write('</rotate>\n    <rotate sid="rotateZ">0 0 1 '),nct.r.getout("rotationZ",[],[]),nct.r.write("</rotate>"),nct.r.doif(nct.r.get("mesh",[],"if"),nct.r.multi([nct.r.write('\n    <instance_geometry url="#'),nct.r.getout("mesh",[],[]),nct.r.write('Shape-lib">'),nct.r.doif(nct.r.get("materialId",[],"if"),nct.r.multi([nct.r.write('\n        <bind_material>\n            <technique_common>\n                <instance_material symbol="'),nct.r.getout("materialId",[],[]),nct.r.write('" target="#'),nct.r.getout("materialId",[],[]),nct.r.write('">'),nct.r.doif(nct.r.get("hasTextures",[],"if"),nct.r.write('\n                    <bind_vertex_input semantic="TEX0" input_semantic="TEXCOORD" input_set="0"/>')),nct.r.write("\n                </instance_material>\n            </technique_common>\n        </bind_material>\n    ")],false)),nct.r.write("</instance_geometry>")],false)),nct.r.doif(nct.r.get("isCamera",[],"if"),nct.r.multi([nct.r.write('\n    <instance_camera url="#'),nct.r.getout("id",[],[]),nct.r.write('Shape"/>')],false)),nct.r.doif(nct.r.get("isLight",[],"if"),nct.r.multi([nct.r.write('\n    <instance_light url="#'),nct.r.getout("id",[],[]),nct.r.write('Shape"/>')],false)),nct.r.write("\n    "),nct.r.each(nct.r.get("children",[],"each"),nct.r.multi([nct.r.write("\n        "),nct.r.partial("collada_node"),nct.r.write("\n    ")],false)),nct.r.write("\n</node>")],false),"editor/collada_node");nct.register(nct.r.multi([nct.r.doif(nct.r.get("visible",[],"if"),nct.r.multi([nct.r.write('\n  <a class="'),nct.r.doif(nct.r.get("icon",[],"if"),nct.r.write("icon"),nct.r.write("cmd-text")),nct.r.write(" command "),nct.r.unless(nct.r.get("enabled",[],"unless"),nct.r.write("disabled")),nct.r.write('" title="'),nct.r.getout("label",[],[]),nct.r.doif(nct.r.get("shortcut",[],"if"),nct.r.multi([nct.r.write(" ("),nct.r.getout("shortcut",[],[]),nct.r.write(")")],false)),nct.r.write('" data-command="'),nct.r.getout("fullName",[],[]),nct.r.write('" href="'),nct.r.doif(nct.r.get("link",[],"if"),nct.r.getout("link",[],[]),nct.r.write("#")),nct.r.write('" '),nct.r.doif(nct.r.get("linkTarget",[],"if"),nct.r.multi([nct.r.write('target="'),nct.r.getout("linkTarget",[],[]),nct.r.write('"')],false)),nct.r.write(">\n    "),nct.r.doif(nct.r.get("icon",[],"if"),nct.r.multi([nct.r.write("\n    <img src='/img/"),nct.r.getout("icon",[],[]),nct.r.write(".png' class='toolbar-icon'/>\n    ")],false),nct.r.multi([nct.r.write("\n      "),nct.r.getout("label",[],[]),nct.r.write("\n    ")],false)),nct.r.write("\n  </a>\n")],false)),nct.r.write("\n")],false),"editor/command_view");nct.register(nct.r.write('<div class="modal fade">\n  <div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Modal header</h3>\n  </div>\n  <div class="modal-body">\n    <p>One fine body</p>\n  </div>\n  <div class="modal-footer">\n    <a href="#" class="btn">Close</a>\n    <a href="#" class="btn btn-primary">Save changes</a>\n  </div>\n</div>\n'),"editor/dialog");nct.register(nct.r.write('<div id="drop-handler" class="drop-message modal hide fade">\n  <div class=\'modal-body\'>\n    <h1>Upload Files</h1>\n  </div>\n</div>\n\n'),"editor/drop_handler");nct.register(nct.r.write('<ul class="nav nav-pills nav-buttons">\n</ul>\n<div id="sub-selection-props"></div>'),"editor/edge_selection");nct.register(nct.r.multi([nct.r.write('<div id="toolbar-row" class="uirow panel" style="top: 0; height: 68px;">\n  <div id="side-toolbar" class="uicol panel" style="width: 200px;">\n    <ul id="manipulator-toolbar" class="nav nav-pills nav-buttons"></ul>\n    <ul id="subobject-toolbar" class="nav nav-pills nav-buttons"></ul>\n  </div>\n  <div id="toolbar" class="uicol panel" style="left: 201px; right: 0;"/>\n</div>\n<div id="main-row" class="uirow panel" style="top: 68px; bottom: '),nct.r.mgetout(["layout","mainBottom"],[],[]),nct.r.write('px;">\n  <div id="left-column" class="uicol panel" style="left: 0; width: '),nct.r.mgetout(["layout","leftWidth"],[],[]),nct.r.write('px;">\n    <div class="panel-collapsed vertical" style="display: '),nct.r.mgetout(["layout","leftCollapsedShow"],[],[]),nct.r.write('">\n      <i class="icon-white icon-chevron-right"></i>\n    </div>\n    <div class="panel-header" style="display: '),nct.r.mgetout(["layout","leftNoCollapsedShow"],[],[]),nct.r.write('">\n      <ul class="nav nav-tabs">\n        '),nct.r.each(nct.r.mget(["layout","tabs","left"],[],"each"),nct.r.multi([nct.r.write('\n        <li id="'),nct.r.getout("id",[],[]),nct.r.write('-option" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write('"><a href="#'),nct.r.getout("id",[],[]),nct.r.write('" data-toggle="tab">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n        ")],false)),nct.r.write('\n      </ul>\n    </div>\n    <div class="panel-body tab-content" style="display: '),nct.r.mgetout(["layout","leftNoCollapsedShow"],[],[]),nct.r.write('">\n      '),nct.r.each(nct.r.mget(["layout","tabs","left"],[],"each"),nct.r.multi([nct.r.write('\n        <div id="'),nct.r.getout("id",[],[]),nct.r.write('" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write(' tab-pane"></div>\n      ')],false)),nct.r.write('\n    </div>\n  </div>\n  <div id=\'left-resizer\' class="split-resizer-horizontal" style="left: '),nct.r.mgetout(["layout","leftWidth"],[],[]),nct.r.write("px; display: "),nct.r.mgetout(["layout","leftNoCollapsedShow"],[],[]),nct.r.write(';"></div>\n  <div id="center-column" class="uicol panel" style="left: '),nct.r.mgetout(["layout","centerLeft"],[],[]),nct.r.write("px; right: "),nct.r.mgetout(["layout","centerRight"],[],[]),nct.r.write('px;">\n    <div id="viewports"></div>\n  </div>\n  <div id=\'right-resizer\' class="split-resizer-horizontal" style="right: '),nct.r.mgetout(["layout","rightWidth"],[],[]),nct.r.write("px; display: "),nct.r.mgetout(["layout","rightNoCollapsedShow"],[],[]),nct.r.write(';"></div>\n  <div id="right-column" class="uicol panel" style="width: '),nct.r.mgetout(["layout","rightWidth"],[],[]),nct.r.write('px; right: 0;">\n    <div class="panel-collapsed vertical right" style="display: '),nct.r.mgetout(["layout","rightCollapsedShow"],[],[]),nct.r.write('">\n      <i class="icon-white icon-chevron-left"></i>\n    </div>\n    <div class="panel-header" style="display: '),nct.r.mgetout(["layout","rightNoCollapsedShow"],[],[]),nct.r.write('">\n      <ul class="nav nav-tabs">\n        '),nct.r.each(nct.r.mget(["layout","tabs","right"],[],"each"),nct.r.multi([nct.r.write('\n        <li id="'),nct.r.getout("id",[],[]),nct.r.write('-option" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write('"><a href="#'),nct.r.getout("id",[],[]),nct.r.write('" data-toggle="tab">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n        ")],false)),nct.r.write('\n      </ul>\n    </div>\n    <div class="panel-body tab-content" style="display: '),nct.r.mgetout(["layout","rightNoCollapsedShow"],[],[]),nct.r.write('">\n      '),nct.r.each(nct.r.mget(["layout","tabs","right"],[],"each"),nct.r.multi([nct.r.write('\n        <div id="'),nct.r.getout("id",[],[]),nct.r.write('" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write(' tab-pane"></div>\n      ')],false)),nct.r.write('\n    </div>\n  </div>\n</div>\n<div id="timeline-row" class="uirow panel" style="bottom: '),nct.r.mgetout(["layout","timelineBottom"],[],[]),nct.r.write("px; height: "),nct.r.mgetout(["layout","timelineHeight"],[],[]),nct.r.write(';">\n  <div id="timeline"></div>\n</div>\n<div id=\'bottom-resizer\' class="split-resizer-vertical" style="bottom: '),nct.r.mgetout(["layout","bottomHeight"],[],[]),nct.r.write("px; display: "),nct.r.mgetout(["layout","bottomNoCollapsedShow"],[],[]),nct.r.write(';"></div>\n<div id="bottom-row" class="uirow panel" style="height: '),nct.r.mgetout(["layout","bottomHeight"],[],[]),nct.r.write('px; bottom: 0;">\n  <div class="panel-collapsed bottom" style="display: '),nct.r.mgetout(["layout","bottomCollapsedShow"],[],[]),nct.r.write('">\n    <i class="icon-white icon-chevron-up"></i>\n  </div>\n  <div class="panel-header" style="display: '),nct.r.mgetout(["layout","bottomNoCollapsedShow"],[],[]),nct.r.write('">\n    <ul class="nav nav-tabs">\n      '),nct.r.each(nct.r.mget(["layout","tabs","bottom"],[],"each"),nct.r.multi([nct.r.write('\n      <li id="'),nct.r.getout("id",[],[]),nct.r.write('-option" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write('"><a href="#'),nct.r.getout("id",[],[]),nct.r.write('" data-toggle="tab">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n      ")],false)),nct.r.write('\n    </ul>\n  </div>\n  <div class="panel-body tab-content" style="display: '),nct.r.mgetout(["layout","bottomNoCollapsedShow"],[],[]),nct.r.write('">\n    '),nct.r.each(nct.r.mget(["layout","tabs","bottom"],[],"each"),nct.r.multi([nct.r.write('\n      <div id="'),nct.r.getout("id",[],[]),nct.r.write('" class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write(' tab-pane"></div>\n    ')],false)),nct.r.write("\n  </div>\n</div>\n")],false),"editor/editor");
nct.register(nct.r.write('<ul class="nav nav-pills nav-buttons">\n</ul>\n<div id="sub-selection-props"></div>'),"editor/face_selection");nct.register(nct.r.write('<div class="modal-header">\n  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n  <h3>Choose Files</h3>\n</div>\n<div class="modal-body">\n  <form>\n    <div class="well filedrop" style="margin-right: 20px;">\n      <p>Drop file here to upload</p>\n    </div>\n    <input multiple class="xlarge span4 file" name="file" type="file" value="">\n  </form>\n  <div>Supported filetypes: <span class="supported-extensions"></span></div>\n</div>\n<div class="modal-footer">\n  <a href="#" class="btn cancel">Cancel</a>\n  <a href="#" class="btn btn-primary submit">Choose</a>\n</div>\n'),"editor/file_dialog");nct.register(nct.r.multi([nct.r.write('<div class="file-properties">\n  File:\n  '),nct.r.doif(nct.r.get("cleanURL",[],"if"),nct.r.multi([nct.r.write('\n    <a target="_blank" href="'),nct.r.getout("cleanURL",[],[]),nct.r.write('">'),nct.r.getout("name",[],[]),nct.r.write("</a>\n  ")],false),nct.r.multi([nct.r.write("\n    "),nct.r.getout("name",[],[]),nct.r.write("\n  ")],false)),nct.r.write("\n  "),nct.r.doif(nct.r.get("size",[],"if"),nct.r.multi([nct.r.write("<br/>Size: "),nct.r.getout("size",[],[]),nct.r.write(" bytes")],false)),nct.r.write("\n  "),nct.r.doif(nct.r.get("isImage",[],"if"),nct.r.multi([nct.r.write('\n    <img src="'),nct.r.getout("src",[],[]),nct.r.write('" />\n  ')],false),nct.r.multi([nct.r.write('\n    <br /><a href="'),nct.r.getout("cleanURL",[],[]),nct.r.write('" download="'),nct.r.getout("name",[],[]),nct.r.write('">Download File</a>\n  ')],false)),nct.r.write("\n</div>\n")],false),"editor/file_properties");nct.register(nct.r.write('<ul id="changes" class="history-list scroll-y">\n</ul>\n'),"editor/history");nct.register(nct.r.multi([nct.r.write('<div class="dropdown">\n  <ul class="dropdown-menu" role="menu">\n    <li><a tabindex="-1" href="#" class="set-key-frame">Set Key Frame</a></li>\n  '),nct.r.doif(nct.r.get("keyframed",[],"if"),nct.r.write('\n    <li><a tabindex="-1" href="#" class="remove-key-frame">Remove Key Frame</a></li>\n  ')),nct.r.write("\n  "),nct.r.doif(nct.r.get("hasKeys",[],"if"),nct.r.write('\n    <li><a tabindex="-1" href="#" class="clear-key-frames">Clear Key Frames</a></li>\n    <li class="divider"></li>\n    <li><a tabindex="-1" href="#" class="goto-first-key">Goto First Key</a></li>\n    <li><a tabindex="-1" href="#" class="goto-previous-key">Goto Previous Key</a></li>\n    <li><a tabindex="-1" href="#" class="goto-next-key">Goto Next Key</a></li>\n    <li><a tabindex="-1" href="#" class="goto-last-key">Goto Last Key</a></li>\n  ')),nct.r.write("\n  </ul>\n</div>\n")],false),"editor/key_framable_context");nct.register(nct.r.write('<div class="header uirow">\n</div>\n<div class="body uirow scroll-y">\n</div>\n'),"editor/log");nct.register(nct.r.multi([nct.r.write('<div class="btn-group pull-right">\n  <button class="btn clear">Clear</button>\n</div>\n<ul class="filter nav nav-pills">\n  '),nct.r.each(nct.r.get("types",[],"each"),nct.r.multi([nct.r.write("\n  "),nct.r.doif(nct.r.get("label",[],"if"),nct.r.multi([nct.r.write('\n    <li class="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("active")),nct.r.write('"><a href="#" data-type="'),nct.r.getout("key",[],[]),nct.r.write('">\n    '),nct.r.getout("label",[],[]),nct.r.write("\n     "),nct.r.doif(nct.r.get("num",[],"if"),nct.r.multi([nct.r.write('\n     <span class="badge '),nct.r.doif(nct.r.get("badge",[],"if"),nct.r.multi([nct.r.write("badge-"),nct.r.getout("badge",[],[])],false)),nct.r.write('">'),nct.r.getout("num",[],[]),nct.r.write("</span>\n     ")],false)),nct.r.write("\n    </a></li>\n  ")],false)),nct.r.write("\n  ")],false)),nct.r.write("\n</ul>\n")],false),"editor/log_header");nct.register(nct.r.write(""),"editor/manipulator_toolbar");nct.register(nct.r.multi([nct.r.write('<a href="#" class="add" class=\'materials\'><i class="icon-plus icon-white"></i> Add Material</a>\n<ul class=\'materials unstyled\'>\n  '),nct.r.each(nct.r.mget(["scene","materials"],[],"each"),nct.r.multi([nct.r.write('\n    <li class=\'node\'><a class="edit" data-id="'),nct.r.getout("id",[],[]),nct.r.write('"><span>'),nct.r.getout("name",[],[]),nct.r.write("</span></a></li>\n  ")],false)),nct.r.write('\n</ul>\n<div class="material-preview">\n</div>\n<div class="properties dg main" style="width: 245px;">\n  <ul>\n  </ul>\n</div>\n')],false),"editor/materials");nct.register(nct.r.write('<li data-menu="File" class="dropdown">\n  <a class="dropdown-toggle" data-toggle="dropdown" href="#">File</a>\n  <ul class="dropdown-menu" role="menu"></ul>\n</li>\n<li data-menu="Edit" class="dropdown">\n  <a class="dropdown-toggle" data-toggle="dropdown" href="#">Edit</a>\n  <ul class="dropdown-menu" role="menu"></ul>\n</li>\n'),"editor/menubar");nct.register(nct.r.write('<ul class="nav nav-pills nav-buttons">\n</ul>\n<div id="sub-selection-props"></div>\n'),"editor/object_selection");nct.register(nct.r.multi([nct.r.each(nct.r.get("nodes",[],"each"),nct.r.multi([nct.r.write("\n<li>"),nct.r.getout("name",[],[]),nct.r.write(' <i class="icon-white icon-remove pull-right" data-id="'),nct.r.getout("id",[],[]),nct.r.write('"></i></li>\n')],false)),nct.r.write("\n")],false),"editor/properties/_nodes");nct.register(nct.r.multi([nct.r.write('<li class="cr file">\n  <div class=\'upload-tools\' style="">\n    <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <input name="'),nct.r.getout("key",[],[]),nct.r.write("\" type=\"file\" style=\"display: none;\" />\n      <button class='btn'>Select File</button>\n    </div>\n    <p class='filename'></p>\n  </div>\n  <div class='drop-message' style='display: none; background-color: #666;'>\n   <p style=\"padding: 20px;\">Drop File Here</p>\n  </div>\n</li>\n")],false),"editor/properties/blob");nct.register(nct.r.multi([nct.r.write('<li class="cr boolean">\n  <div>\n    <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <input class="checkbox" name="'),nct.r.getout("key",[],[]),nct.r.write('" type="checkbox" '),nct.r.doif(nct.r.get("value",[],"if"),nct.r.write('checked="checked"')),nct.r.write(" />\n    </div>\n  </div>\n</li>\n")],false),"editor/properties/boolean");nct.register(nct.r.multi([nct.r.write('<button class="cr button btn">'),nct.r.getout("label",[],[]),nct.r.write("</button>")],false),"editor/properties/button");nct.register(nct.r.multi([nct.r.write('<li class="cr object color">\n  <div>\n    <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <input type="text">\n      <div class="color-selector selector">\n        <div class="field-knob">\n        </div>\n        <div class="saturation-field">\n          <div></div>\n        </div>\n        <div class="hue-field">\n          <div class="hue-knob">\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</li>\n\n')],false),"editor/properties/color");nct.register(nct.r.multi([nct.r.write('<li class="cr file">\n  <div class=\'upload-tools\' style="">\n    <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <input name="'),nct.r.getout("key",[],[]),nct.r.write("\" type=\"file\" style=\"display: none;\" />\n      <button class='btn'>Select File</button>\n    </div>\n    <p class='filename'></p>\n  </div>\n  <div class='drop-message' style='display: none;'>\n   <p style=\"padding: 20px;\">Drop File Here</p>\n  </div>\n</li>\n")],false),"editor/properties/file");nct.register(nct.r.multi([nct.r.write('<li class="cr file">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write(' <i class="node-reference icon-white icon-chevron-right selectable"></i></span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option></option>\n    </select>\n  </div>\n</li>\n')],false),"editor/properties/image");nct.register(nct.r.multi([nct.r.write('<li class="cr number">\n  <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n  <div class="c">\n    <input class="number" name="'),nct.r.getout("key",[],[]),nct.r.write('" type="text" value="'),nct.r.getout("value",[],[]),nct.r.write('" />\n  </div>\n</li>\n')],false),"editor/properties/integer");nct.register(nct.r.multi([nct.r.write('<li class="cr file">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write(' <i class="node-reference icon-white icon-chevron-right selectable"></i></span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option></option>\n    </select>\n  </div>\n</li>\n')],false),"editor/properties/json");nct.register(nct.r.multi([nct.r.write('<li class="cr node">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write(' <i class="node-reference icon-white icon-chevron-right selectable"></i></span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option></option>\n    </select>\n  </div>\n</li>\n')],false),"editor/properties/node");nct.register(nct.r.multi([nct.r.write('<li class="cr nodes">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write('\n  <i title="Select '),nct.r.getout("label",[],[]),nct.r.write('" class="select icon-white icon-hand-right pull-right" style="padding: 4px;"></i>\n  </span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option></option>\n    </select>\n\n    <ul class=\'nodes\'>\n    </ul>\n  </div>\n</li>\n')],false),"editor/properties/node_list");nct.register(nct.r.multi([nct.r.write('<li class="cr number">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write(' <i class="node-reference icon-white icon-chevron-right selectable"></i></span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option>loading...</option>\n    </select>\n  </div>\n</li>\n')],false),"editor/properties/node_reference");nct.register(nct.r.multi([nct.r.write('<li class="cr number">\n  <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n  <div class="c">\n    <input class="number" name="'),nct.r.getout("key",[],[]),nct.r.write('" type="text" value="'),nct.r.getout("value",[],[]),nct.r.write('" />\n  </div>\n</li>\n')],false),"editor/properties/number");nct.register(nct.r.multi([nct.r.write('<li class="cr number">\n  <span class="property-name">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n  <div class="c">\n    <select name="'),nct.r.getout("key",[],[]),nct.r.write('" style="width: 100%;">\n      <option>loading...</option>\n    </select>\n  </div>\n</li>')],false),"editor/properties/options");nct.register(nct.r.multi([nct.r.write('<li class="cr string">\n  <div>\n    <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <input class="text" name="'),nct.r.getout("key",[],[]),nct.r.write('" type="text" value="'),nct.r.getout("value",[],[]),nct.r.write('" />\n    </div>\n  </div>\n</li>\n\n')],false),"editor/properties/text");nct.register(nct.r.multi([nct.r.write('<li class="cr string">\n  <div>\n    <span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n    <div class="c">\n      <textarea style="background-color: #303030; resize: vertical; width: 100%;"> '),nct.r.getout("value",[],[]),nct.r.write(" </textarea>\n    </div>\n  </div>\n</li>\n\n")],false),"editor/properties/text_area");nct.register(nct.r.multi([nct.r.write('<li class="cr vec3">\n<span class="property-name '),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("label",[],[]),nct.r.write('</span>\n<div class="c">\n  '),nct.r.each(nct.r.get("array",[],"each"),nct.r.multi([nct.r.write('\n  <span class="'),nct.r.getout("idx",[],[]),nct.r.write(" "),nct.r.doif(nct.r.get("animatable",[],"if"),nct.r.write("animatable")),nct.r.write('">'),nct.r.getout("idx",[],[]),nct.r.write('</span>\n  <input class="vec number" name="'),nct.r.getout("key",[],[]),nct.r.write("["),nct.r.getout("idx",[],[]),nct.r.write(']" data-idx="'),nct.r.getout("idx",[],[]),nct.r.write('" type="text" value="'),nct.r.getout("val",[],[]),nct.r.write('" />\n  ')],false)),nct.r.write("\n</div>\n</li>\n")],false),"editor/properties/vec3");nct.register(nct.r.multi([nct.r.write('<div class="node">\n  <div class="properties dg main" style="width: 245px;">\n    <ul class="properties">\n    </ul>\n  </div>\n</div>\n<div class="accordion" id="node-plugs">\n'),nct.r.each(nct.r.get("plugs",[],"each"),nct.r.multi([nct.r.write('\n  <div class="accordion-group">\n    <div class="accordion-heading">\n      <a class="accordion-toggle" data-toggle="collapse"\n         href="#'),nct.r.getout("id",[],[]),nct.r.write('"><i class="icon-chevron-'),nct.r.doif(nct.r.get("visible",[],"if"),nct.r.write("down"),nct.r.write("right")),nct.r.write(' icon-white"></i> '),nct.r.getout("type",[],[]),nct.r.write('</a>\n    </div>\n    <div id="'),nct.r.getout("id",[],[]),nct.r.write('" class="plug accordion-body collapse '),nct.r.doif(nct.r.get("visible",[],"if"),nct.r.write("in")),nct.r.write('">\n      <div class="accordion-inner">\n        '),nct.r.doif(nct.r.mget(["operatorChoices","length"],[],"if"),nct.r.multi([nct.r.write('\n          <select class="operator-choices" data-placeholder="Add Operator">\n            <option></option>\n            '),nct.r.each(nct.r.get("operatorChoices",[],"each"),nct.r.multi([nct.r.write("\n              "),nct.r.doif(nct.r.mget(["items","length"],[],"if"),nct.r.multi([nct.r.write("\n                "),nct.r.doif(nct.r.get("category",[],"if"),nct.r.multi([nct.r.write('<optgroup label="'),nct.r.getout("category",[],[]),nct.r.write('">')],false)),nct.r.write("\n                "),nct.r.each(nct.r.get("items",[],"each"),nct.r.multi([nct.r.write('\n                  <option value="'),nct.r.getout("name",[],[]),nct.r.write('">'),nct.r.getout("name",[],[]),nct.r.write("</option>\n                ")],false)),nct.r.write("\n                "),nct.r.doif(nct.r.get("category",[],"if"),nct.r.write("</optgroup>")),nct.r.write("\n              ")],false)),nct.r.write("\n            ")],false)),nct.r.write("\n          </select>\n        ")],false)),nct.r.write("\n        "),nct.r.doif(nct.r.mget(["operatorStack","length"],[],"if"),nct.r.multi([nct.r.write('\n          <ul class="operator-stack" style="overflow-y: auto; max-height:150px; ">\n          '),nct.r.each(nct.r.get("operatorStack",[],"each"),nct.r.multi([nct.r.write('\n            <li id="'),nct.r.getout("id",[],[]),nct.r.write('">\n              <a class="remove-operator pull-right" title="Remove operator" data-id="'),nct.r.getout("id",[],[]),nct.r.write('"><i class="icon-remove icon-white"></i></a>\n              <a class="toggle-active-operator pull-right" title="'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("Hide"),nct.r.write("Show")),nct.r.write('" data-id="'),nct.r.getout("id",[],[]),nct.r.write('"><i class="icon-eye-'),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write("open"),nct.r.write("close faded")),nct.r.write(' icon-white"></i></a>\n              <div class="manipulator-toggle pull-left">\n                '),nct.r.doif(nct.r.get("hasManipulators",[],"if"),nct.r.multi([nct.r.write('\n                    <i data-toggle="collapse" data-target="#'),nct.r.getout("id",[],[]),nct.r.write('-manipulators" class="toggle-manipulators icon-white '),nct.r.doif(nct.r.get("expandedManipulators",[],"if"),nct.r.write("icon-chevron-down"),nct.r.write("icon-chevron-right")),nct.r.write('"></i>\n                ')],false),nct.r.write('\n                  <img src=\'/img/empty.png\' width="14" height="14" />\n                ')),nct.r.write("\n              </div>\n              <a class='operator "),nct.r.getout("selected",[],[]),nct.r.write(" "),nct.r.getout("primitive",[],[]),nct.r.write(" "),nct.r.getout("type",[],[]),nct.r.write("' id=\""),nct.r.getout("id",[],[]),nct.r.write('" draggable="'),nct.r.doif(nct.r.get("notBottom",[],"if"),nct.r.write("true"),nct.r.write("false")),nct.r.write('">'),nct.r.getout("type",[],[]),nct.r.write("</a>\n              "),nct.r.doif(nct.r.get("hasManipulators",[],"if"),nct.r.multi([nct.r.write('\n                <ul id="'),nct.r.getout("id",[],[]),nct.r.write('-manipulators" class="operator-manipulators collapse '),nct.r.doif(nct.r.get("expandedManipulators",[],"if"),nct.r.write("in")),nct.r.write('">\n                  '),nct.r.each(nct.r.get("manipulations",[],"each"),nct.r.multi([nct.r.write('\n                    <li class="operator-manipulator"><a id="'),nct.r.getout("name",[],[]),nct.r.write('" name="'),nct.r.getout("name",[],[]),nct.r.write('" class="operator-manipulator '),nct.r.getout("selected",[],[]),nct.r.write('">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n                  ")],false)),nct.r.write("\n                </ul>\n              ")],false)),nct.r.write("\n            </li>\n          ")],false)),nct.r.write("\n          </ul>\n          <div>\n            "),nct.r.doif(nct.r.get("isMesh",[],"if"),nct.r.write("\n              <button class='cr button btn collapse-mesh'>Collapse</button>\n            ")),nct.r.write("\n          </div>\n        ")],false)),nct.r.write('\n        <div class="properties dg main" style="width: 245px;">\n          <ul class="properties">\n          </ul>\n        </div>\n      </div>\n    </div>\n  </div>\n')],false)),nct.r.write("\n  "),nct.r.doif(nct.r.get("isFile",[],"if"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("editor/file_properties"),nct.r.write("\n  ")],false)),nct.r.write("\n</div>\n")],false),"editor/properties");nct.register(nct.r.write('<div class="node">\n  <div class="properties dg main" style="width: 245px;">\n    <ul>\n    </ul>\n  </div>\n</div>'),"editor/properties_simple");nct.register(nct.r.multi([nct.r.write('<tr width="100%">\n <td class="description" width="100%">'),nct.r.getout("description",[],[]),nct.r.write('</td>\n <td><a class="btn delete-result" href="#">x</a></td>\n</tr>\n<tr>\n <td colspan="2" width="100%">\n  '),nct.r.doif(nct.r.get("done",[],"if"),nct.r.multi([nct.r.write("\n    "),nct.r.doif(nct.r.get("isFiles",[],"if"),nct.r.multi([nct.r.write("\n   <ul>\n      "),nct.r.each(nct.r.get("content",[],"each"),nct.r.multi([nct.r.write("\n      <li><a href='"),nct.r.getout("assetURL",[],[]),nct.r.write('\' target="_blank">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n      ")],false)),nct.r.write("\n   </ul>\n    ")],false),nct.r.multi([nct.r.write("\n      "),nct.r.doif(nct.r.get("isFile",[],"if"),nct.r.multi([nct.r.write("\n      <a href='"),nct.r.mgetout(["content","assetURL"],[],[]),nct.r.write('\' target="_blank">'),nct.r.mgetout(["content","name"],[],[]),nct.r.write("</a>\n      ")],false),nct.r.multi([nct.r.write("\n        "),nct.r.getout("content",[],[]),nct.r.write("\n      ")],false)),nct.r.write("\n    ")],false)),nct.r.write("\n  ")],false),nct.r.write('\n  <img height="16" width="16" src="/img/loading.gif"/>\n  ')),nct.r.write("\n </td>\n</tr>\n")],false),"editor/result_item");nct.register(nct.r.write("<table class='table results'>\n  <tbody/>\n</table>\n"),"editor/results");nct.register(nct.r.multi([nct.r.write("<div class='scene node'>\n  "),nct.r.each(nct.r.get("node",[],"each"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("editor/scene_explorer_node"),nct.r.write("\n  ")],false)),nct.r.write("\n  <div class='assets'>\n  </div>\n</div>\n\n<div class='drop-message' style='display: none;'>\n  <p style='padding: 20px;'>Upload Files</p>\n</div>\n")],false),"editor/scene_explorer");nct.register(nct.r.multi([nct.r.write('<div class="dropdown">\n  <ul class="dropdown-menu" role="menu">\n    '),nct.r.each(nct.r.get("allowedChildren",[],"each"),nct.r.multi([nct.r.write('\n      <li><a tabindex="-1" href="#" class="add-node" data-type="'),nct.r.getout("name",[],[]),nct.r.write('">Add '),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n    ")],false)),nct.r.write('\n    <li class="divider"></li>\n  </ul>\n</div>\n')],false),"editor/scene_explorer_context");nct.register(nct.r.unless(nct.r.get("unavailable",[],"unless"),nct.r.multi([nct.r.write('\n<div class="dropdown select-node '),nct.r.getout("selected",[],[]),nct.r.write('" data-id="'),nct.r.getout("id",[],[]),nct.r.write('" draggable="'),nct.r.getout("isDraggable",[],[]),nct.r.write('">\n  <div class="explorer-toggle">\n    '),nct.r.doif(nct.r.mget(["nodes","length"],[],"if"),nct.r.multi([nct.r.write('\n      <i data-toggle="collapse" data-target="#'),nct.r.getout("id",[],[]),nct.r.write('-children" class="toggle-children icon-white '),nct.r.doif(nct.r.get("collapsedChildren",[],"if"),nct.r.write("icon-chevron-right"),nct.r.write("icon-chevron-down")),nct.r.write('"></i>\n    ')],false),nct.r.write('\n      <img src=\'/img/empty.png\' width="14" height="14" />\n    ')),nct.r.write('\n  </div>\n  <div class="node-container">\n    <div class="explorer-icon">'),nct.r.doif(nct.r.get("creationOperatorImage",[],"if"),nct.r.multi([nct.r.write("<img src='"),nct.r.getout("creationOperatorImage",[],[]),nct.r.write("' />")],false),nct.r.write('<img src=\'/img/empty.png\' width="16" height="16" />')),nct.r.write('</div>\n    <div class="node-name">'),nct.r.getout("name",[],[]),nct.r.write('</div>\n  </div>\n</div>\n<div id="'),nct.r.getout("id",[],[]),nct.r.write('-children" class="node-children collapse '),nct.r.unless(nct.r.get("collapsedChildren",[],"unless"),nct.r.write("in")),nct.r.write('">\n  '),nct.r.each(nct.r.get("nodes",[],"each"),nct.r.multi([nct.r.write("\n    <div class='node'>\n      "),nct.r.partial("editor/scene_explorer_node"),nct.r.write("\n    </div>\n  ")],false)),nct.r.write("\n</div>\n")],false)),"editor/scene_explorer_node");nct.register(nct.r.write('<div class="modal-header">\n  <h3>Rename Scene</h3>\n</div>\n<div class="modal-body">\n  <input type="Text" />\n</div>\n<div class="modal-footer">\n  <a href="#" class="btn rename btn-primary">Rename</a>\n  <a href="#" class="btn cancel">Cancel</a>\n</div>'),"editor/scene_rename");nct.register(nct.r.multi([nct.r.write('<div class="btn-toolbar header" style="margin: 0;">\n  '),nct.r.partial("editor/script_header"),nct.r.write('\n</div>\n<div class="code"></div>\n')],false),"editor/script");nct.register(nct.r.multi([nct.r.write('  <div class="btn-group">\n    <button title="Prev Script" class="btn prev"><i class="icon-chevron-left icon-white"></i></button>\n    <button title="Next Script" class="btn next"><i class="icon-white icon-chevron-right"></i></button>\n  </div>\n  <div class="btn-group">\n    <button class="btn">\n      <span class="script-name" contenteditable="true">'),nct.r.getout("name",[],[]),nct.r.write('</span>\n    </button>\n    <button class="btn dropdown-toggle" data-toggle="dropdown">\n      <span class="caret"></span>\n    </button>\n    <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel" style="width: 200px">\n      '),nct.r.each(nct.r.get("scripts",[],"each"),nct.r.multi([nct.r.write('\n      <li><a class="change-script" data-script="'),nct.r.getout("i",[],[]),nct.r.write('" tabindex="-1"\n      href="#">'),nct.r.getout("name",[],[]),nct.r.doif(nct.r.get("active",[],"if"),nct.r.write(' <i class="icon-ok icon-white"></i>')),nct.r.write('\n      <i class="remove-script icon-remove icon-white pull-right"></i></a></li>\n      ')],false)),nct.r.write('\n      <li class="divider"></li>\n      <li><a class="add-script">Add new script</a></li>\n    </ul>\n  </div>\n  <div class="btn-group pull-right">\n    <button title="Execute Script" class="btn exec"><i class="icon-white icon-play"></i></button>\n  </div>\n')],false),"editor/script_header");nct.register(nct.r.multi([nct.r.doif(nct.r.get("hasSelection",[],"if"),nct.r.multi([nct.r.write('\n  <div class="selection-header">'),nct.r.getout("selectionName",[],[]),nct.r.write("</div>\n")],false)),nct.r.write("\n\n"),nct.r.doif(nct.r.get("hasGroupOrSubSelection",[],"if"),nct.r.multi([nct.r.write('\n  <div class="selection-sub-header">'),nct.r.getout("groupName",[],[]),nct.r.write(" selected</div>\n")],false)),nct.r.write("\n\n"),nct.r.doif(nct.r.get("isPolyMesh",[],"if"),nct.r.write('\n  <div class="panel-content sub-selection-content">\n  </div>\n')),nct.r.write('\n\n<div class="panel-content selection-content">\n  <ul class="nav nav-pills nav-buttons">\n  </ul>\n  <div id="selection-props"></div>\n</div>\n')],false),"editor/selection");nct.register(nct.r.multi([nct.r.write('<ul class="nav nav-pills nav-buttons">\n'),nct.r.each(nct.r.get("sideToolbar",[],"each"),nct.r.multi([nct.r.write("\n  "),nct.r.partial("toolbar_item"),nct.r.write("\n")],false)),nct.r.write('\n</ul>\n<ul class="nav nav-pills nav-buttons">\n'),nct.r.each(nct.r.get("subObjects",[],"each"),nct.r.multi([nct.r.write("\n  "),nct.r.partial("toolbar_item"),nct.r.write("\n")],false)),nct.r.write("\n</ul>")],false),"editor/side_toolbar");nct.register(nct.r.multi([nct.r.write("<ul class='unstyled'>\n  "),nct.r.each(nct.r.get("stats",[],"each"),nct.r.multi([nct.r.write("\n    <li>"),nct.r.getout("label",[],[]),nct.r.write(": <b>"),nct.r.getout("value",[],[]),nct.r.write("</b>"),nct.r.doif(nct.r.get("count",[],"if"),nct.r.multi([nct.r.write(", <i>"),nct.r.getout("count",[],[]),nct.r.write("</i>")],false)),nct.r.write(" "),nct.r.doif(nct.r.get("total",[],"if"),nct.r.multi([nct.r.write(", ("),nct.r.getout("total",[],[]),nct.r.write(")")],false)),nct.r.write("</li>\n  ")],false)),nct.r.write("\n</ul>\n")],false),"editor/stats");nct.register(nct.r.multi([nct.r.doif(nct.r.mget(["progress","loading"],[],"if"),nct.r.multi([nct.r.write('\n  <div class="info">'),nct.r.mgetout(["progress","info"],[],[]),nct.r.write('</div>\n  <span class="progress"><div class="bar" style="width:'),nct.r.mgetout(["progress","amount"],[],[]),nct.r.write('%"></div></span>\n')],false)),nct.r.write("\n"),nct.r.unless(nct.r.get("webGLSupport",[],"unless"),nct.r.write('\n<div class="browser-message">Currently running in Canvas mode, consider trying\n  <a href="http://www.mozilla.org/en-US/firefox/new/" target="_blank">Firefox</a> or\n  <a href="http://chrome.google.com" target="_blank">Chrome</a> instead.\n</div>'))],false),"editor/statusbar");nct.register(nct.r.write(""),"editor/subobject_toolbar");nct.register(nct.r.multi([nct.r.write('<div class="controls btn-group">\n  <button class="'),nct.r.doif(nct.r.get("playing",[],"if"),nct.r.write("pause"),nct.r.write("play")),nct.r.write(' btn"><i class="icon-'),nct.r.doif(nct.r.get("playing",[],"if"),nct.r.write("pause"),nct.r.write("play")),nct.r.write(' icon-white"></i></button>\n  <button class="stop btn"><i class="icon-stop icon-white"></i></button>\n</div>\n<div class="ruler">\n  <div class="increments">\n  </div>\n  <div class="marker">\n  </div>\n  <div class="key-frames">\n  </div>\n</div>\n')],false),"editor/timeline");nct.register(nct.r.write('<div class="panel-header">\n  <ul class="nav nav-tabs"></ul>\n</div>\n<div class="panel-body tab-content"></div>\n'),"editor/toolbar");nct.register(nct.r.write('<div class="navbar">\n  <div class="navbar-inner">\n    <a class="brand" href="#" style="padding-top: 3px;">\n      <img width=\'150px\' height=\'34.5px\' src=\'/img/ClaraIO_ColorOnTransparent_450x83.png\' />\n    </a>\n    <ul class="menubar nav"></ul>\n    <div class="statusbar pull-right"></div>\n  </div>\n</div>\n'),"editor/top_nav");nct.register(nct.r.write('<ul class="nav nav-pills nav-buttons">\n</ul>\n<div id="sub-selection-props"></div>'),"editor/vertex_selection");nct.register(nct.r.multi([nct.r.write("<div class='controls'>\n  "),nct.r.doif(nct.r.get("supportsViewports",[],"if"),nct.r.multi([nct.r.write("<a href='#' class='resize pull-right'><i class='"),nct.r.doif(nct.r.get("fullscreen",[],"if"),nct.r.write("icon-resize-small"),nct.r.write("icon-resize-full")),nct.r.write(" icon-white'></i></a>")],false)),nct.r.write("\n  "),nct.r.doif(nct.r.get("isLoading",[],"if"),nct.r.write("<img class='pull-right' src='/img/spinner.gif' />")),nct.r.write('\n  <div class=\'dropdown\'>\n    <a class="dropdown-toggle" data-toggle="dropdown" href="#">+</a>\n    <ul class=\'dropdown-menu\' role=\'menu\'>\n      <li><a class="toggle-edges" data-edges="'),nct.r.getout("edges",[],[]),nct.r.write('" href="#">'),nct.r.doif(nct.r.get("edges",[],"if"),nct.r.write("Hide"),nct.r.write("Show")),nct.r.write(' Edges</a></li>\n      <li><a class="toggle-grid" data-grid="'),nct.r.getout("gridVisible",[],[]),nct.r.write('" href="#">'),nct.r.doif(nct.r.get("gridVisible",[],"if"),nct.r.write("Hide"),nct.r.write("Show")),nct.r.write(' Grid</a></li>\n      <li><a class="frame-all" title="Frame All (a)" href="#">Frame All</a></li>\n      <li><a class="frame-selection" title="Frame Selected (f)" href="#">Frame Selection</a></li>\n      <li><a class="toggle-stats" href="#">'),nct.r.doif(nct.r.get("statsVisible",[],"if"),nct.r.write("Hide"),nct.r.write("Show")),nct.r.write(' Stats</a></li>\n      <li><a class="camera-properties" href="#">Camera Properties</a></li>\n    </ul>\n  </div>\n  <div class=\'dropdown\'>\n    <a class="dropdown-toggle selected-camera" data-toggle="dropdown" href="#">'),nct.r.mgetout(["selected","name"],[],[]),nct.r.write("</a>\n    <ul class='dropdown-menu' role='menu'>\n      "),nct.r.doif(nct.r.mget(["cameras","length"],[],"if"),nct.r.multi([nct.r.write("\n      <li class='dropdown-submenu'>\n        <a class=\"cameras-title\" href=\"#\">Cameras</a>\n        <ul class='dropdown-menu'>\n          "),nct.r.each(nct.r.get("cameras",[],"each"),nct.r.multi([nct.r.write('\n            <li><a data-camera="'),nct.r.getout("id",[],[]),nct.r.write("\" tabindex='-1' class='switch-camera' href='#'>"),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n          ")],false)),nct.r.write("\n        </ul>\n      </li>\n      ")],false)),nct.r.write("\n      "),nct.r.each(nct.r.get("cameraPresets",[],"each"),nct.r.multi([nct.r.write('\n      <li><a data-camera="'),nct.r.getout("propertyType",[],[]),nct.r.write("\" tabindex='-1' class='switch-preset-camera' href='#'>"),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n      ")],false)),nct.r.write('\n    </ul>\n  </div>\n  <div class=\'dropdown\'>\n    <a class="dropdown-toggle selected-displayType" data-toggle="dropdown" href="#">'),nct.r.getout("displayName",[],[]),nct.r.write("</a>\n    <ul class='dropdown-menu' role='menu'>\n      "),nct.r.each(nct.r.get("displayTypes",[],"each"),nct.r.multi([nct.r.write('\n      <li><a data-display="'),nct.r.getout("propertyType",[],[]),nct.r.write("\" tabindex='-1' class='switch-displayType' href='#'>"),nct.r.getout("type",[],[]),nct.r.write("</a></li>\n      ")],false)),nct.r.write("\n    </ul>\n  </div>\n</div>\n<div class='safeview-camera' style=\"display: none;\"></div>\n<div class='drag-selection' style=\"display: none;\"></div>\n")],false),"editor/viewport");nct.register(nct.r.write('<canvas></canvas>\n<div class="viewports uicol uirow"></div>\n'),"editor/viewports");nct.register(nct.r.write('<div class="dropdown">\n  <ul class="dropdown-menu" role="menu"></ul>\n</div>\n'),"editor/viewports_context");nct.register(nct.r.multi([nct.r.write("Hello "),nct.r.getout("username",[],[]),nct.r.write("!\n\nThank you for your interest in "),nct.r.getout("applicationName",[],[]),nct.r.write(".  We will let you in as soon as there is room in the beta.\n\nTo stay up to date on the progress of Clara.io, including new features, tutorials, partnerships and featured contents, please follow us on Twitter http://twitter.com/ExocortexCom and like us on Facebook http://fb.me/Exocortex\n\nAlso, you can register on our forums and introduce yourself via a post. Tell us where you're from and why you're interested: http://discuss.exocortex.com\n\nKeep an eye on your inbox for our newsletter and your invitation key. It's an exciting time now in the early stages of "),nct.r.getout("applicationName",[],[]),nct.r.write(" and we hope to get you on board soon.\n\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/ApplicationReceived");
nct.register(nct.r.multi([nct.r.write("Hello "),nct.r.getout("username",[],[]),nct.r.write("!\n\nWe have noticed that you've been busy exploring "),nct.r.getout("applicationName",[],[]),nct.r.write(" lately. We hope that you have enjoyed your time with it so far and we would love to hear your thoughts on how we're doing so far. Our [forums] are the best way to get in touch with us and to give us your feedback. If you have any suggested features or would like to discuss current workflows, join in on the discussion with our other active users and help us shape development in the coming months.\n\nIf you are proud of any of the work that you have produced with "),nct.r.getout("applicationName",[],[]),nct.r.write(", our forums have a [gallery] section where you can show off and discuss with staff and users. We're always on the lookout for great content created in the early stages of this beta, and in the near future we will be looking to feature artists in our newsletter and blog.\n\nTo keep up with the latest development news, follow us on [Twitter] and like us on [Facebook]. We'll be announcing our new features, featured content and any other beta news here.\n\nThanks for your continued interest in making "),nct.r.getout("applicationName",[],[]),nct.r.write(" the best it can be. We look forward to hearing from you soon.\n\nAll the best,\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/HighActivity");nct.register(nct.r.multi([nct.r.write("Hello "),nct.r.getout("username",[],[]),nct.r.write("!\n\nIt's been a while since your last login to "),nct.r.getout("applicationName",[],[]),nct.r.write(". We hope you have enjoyed your time with it so far, and we encourage you to check back regularly as we are always adding new features and improving the service.\n\nIf there's something about your experience that you think could be improved, we would love to hear your suggestions. Our [forums] are the best way to let us know your thoughts, and any feedback you can provide is much appreciated. While you're there, consider chatting with other users and seeing what they've been up to.\n\nTo keep up with the latest development news, follow us on [Twitter] and like us on [Facebook]. We'll be announcing our new features, featured content and any other beta news here.\n\nIt's an exciting time now in the early stages of "),nct.r.getout("applicationName",[],[]),nct.r.write(" and we look forward to hearing from you soon.\n\nBest regards,\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/Inactivity");nct.register(nct.r.multi([nct.r.write("Hello!\n\nYou've been granted access to the "),nct.r.getout("applicationName",[],[]),nct.r.write(" beta!\n\nClick here to get started:\n\n"),nct.r.getout("urlRoot",[],[]),nct.r.getout("link",[],[]),nct.r.write("\n\nPlease note that "),nct.r.getout("applicationName",[],[]),nct.r.write(" does require WebGL and we recommend using the latest version of Firefox or Chrome for the best experience.\n\nHave a suggestion or a question? Visit our discussion forums, http://exocortex.com/forum\n\nTo keep up with the progress of Clara.io, please follow us on Twitter, http://twitter.com/ExocortexCom , and like us on Facebook, http://fb.me/Exocortex . We'll be announcing our new features, featured content and any other beta news here.\n\nThanks for your interest in making "),nct.r.getout("applicationName",[],[]),nct.r.write(" the best it can be. We look forward to hearing from you soon.\n\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/ReferralInvitation");nct.register(nct.r.multi([nct.r.write("Hello"),nct.r.doif(nct.r.get("targetName",[],"if"),nct.r.multi([nct.r.write(" "),nct.r.getout("targetName",[],[])],false)),nct.r.write("!\n\n"),nct.r.getout("originatorName",[],[]),nct.r.write(" "),nct.r.doif(nct.r.get("originatorUsername",[],"if"),nct.r.multi([nct.r.write("("),nct.r.getout("originatorUsername",[],[]),nct.r.write(")")],false)),nct.r.write(' has just shared a 3D scene entitled "'),nct.r.getout("sceneName",[],[]),nct.r.write('" with you on http://Clara.io !\n\n'),nct.r.getout("urlRoot",[],[]),nct.r.write("/editor/"),nct.r.getout("sceneId",[],[]),nct.r.write("\n\n"),nct.r.doif(nct.r.get("isRegistered",[],"if"),nct.r.multi([nct.r.write("You can log in to edit and view your scenes at:\n\n"),nct.r.getout("urlRoot",[],[]),nct.r.write("/login\n\n")],false),nct.r.multi([nct.r.write("No user account was found for your email address "),nct.r.getout("email",[],[]),nct.r.write(".\n\nhttp://Clara.io, the next-generation web-based 3D content creation platform, is currently in beta.  To gain access to the 3D scene that "),nct.r.getout("originatorName",[],[]),nct.r.write(" shared with you, please register here:\n\n"),nct.r.getout("urlRoot",[],[]),nct.r.write("\n\n")],false)),nct.r.write("The Clara.io Team\nhttp://clara.io\n")],false),"emails/ShareInvitation");nct.register(nct.r.multi([nct.r.write("Hello "),nct.r.getout("username",[],[]),nct.r.write(",\n\nWe've received your request for a password reset. To proceed, simply visit this link and enter your new password.\n\n"),nct.r.getout("urlRoot",[],[]),nct.r.write("/password_reset?username="),nct.r.getout("username",[],[]),nct.r.write("&token="),nct.r.getout("token",[],[]),nct.r.write("\n\nIf you are not "),nct.r.getout("username",[],[]),nct.r.write(" or you did not request a password reset, please disregard this email. Sorry about that! You can always email us at support@exocortex.com if you experience any difficulties.\n\nBest regards,\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/UserPasswordReset");nct.register(nct.r.multi([nct.r.write("Hello "),nct.r.getout("username",[],[]),nct.r.write(",\n\nWelcome to "),nct.r.getout("applicationName",[],[]),nct.r.write("!  Your account is all set for you to get started creating great 3D content in your browser. If you haven't already, we recommend you introduce yourself on our forums http://discuss.exocortex.com\n\nTell us where you're from and start meeting the other active users of "),nct.r.getout("applicationName",[],[]),nct.r.write(". Our forums are the hub of our beta community and - as the saying goes - the more the merrier.\n\nTo keep up with the progress of Clara.io, learn about new features and other news, please follow us on Twitter http://twitter.com/ExocortexCom and like us on Facebook http://fb.me/Exocortex\n\nThanks for your interest in making "),nct.r.getout("applicationName",[],[]),nct.r.write(" the best it can be. We look forward to hearing from you soon.\n\nThe Clara.io Team\nhttp://clara.io\n")],false),"emails/UserWelcome");nct.register(nct.r.multi([nct.r.doif(nct.r.get("title",[],"if"),nct.r.multi([nct.r.write("<h1>"),nct.r.getout("title",[],[]),nct.r.write("<h1>")],false)),nct.r.write("\n<h2>"),nct.r.getout("message",[],[]),nct.r.write("</h2>\n\n")],false),"error");nct.register(nct.r.write('<!DOCTYPE html>\n<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->\n<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->\n<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->\n<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->\n<head>\n  <meta charset="utf-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">'),"header_boilerplate");nct.register(nct.r.write("<h1>Help</h1>\n"),"help/index");nct.register(nct.r.multi([nct.r.write('<!DOCTYPE html>\n<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->\n<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->\n<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->\n<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->\n<head>\n  <meta charset="utf-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">\n  <noscript><meta http-equiv="refresh" content="0; url=http://www.activatejavascript.org/"/></noscript>\n  <title>'),nct.r.getout("applicationName",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <link href="'),nct.r.mgetout(["deps","studio_css"],[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n  '),nct.r.doif(nct.r.get("test",[],"if"),nct.r.write('\n  <link rel="stylesheet" href="/css/mocha.css">\n  ')),nct.r.write('\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.doif(nct.r.get("bugsnagApiKey",[],"if"),nct.r.multi([nct.r.write('\n    <script src="//d2wy8f7a9ursnm.cloudfront.net/bugsnag-1.0.4.min.js" data-apikey="'),nct.r.getout_no("bugsnagApiKey",[],[]),nct.r.write('"></script>\n  ')],false)),nct.r.write("\n  <script>"),nct.r.write('\n    (function(a,b,c){typeof c["module"]!="undefined"&&c.module.exports?c.module.exports=b():typeof c["define"]!="undefined"&&c["define"]=="function"&&c.define.amd?define(a,b):c[a]=b()})("$script",function(){function p(a,b){for(var c=0,d=a.length;c<d;++c)if(!b(a[c]))return j;return 1}function q(a,b){p(a,function(a){return!b(a)})}function r(a,b,i){function o(a){return a.call?a():d[a]}function t(){if(!--n){d[m]=1,l&&l();for(var a in f)p(a.split("|"),o)&&!q(f[a],o)&&(f[a]=[])}}a=a[k]?a:[a];var j=b&&b.call,l=j?b:i,m=j?a.join(""):b,n=a.length;return setTimeout(function(){q(a,function(a){if(h[a])return m&&(e[m]=1),h[a]==2&&t();h[a]=1,m&&(e[m]=1),s(!c.test(a)&&g?g+a+".js":a,t)})},0),r}function s(c,d){var e=a.createElement("script"),f=j;e.onload=e.onerror=e[o]=function(){if(e[m]&&!/^c|loade/.test(e[m])||f)return;e.onload=e[o]=null,f=1,h[c]=2,d()},e.async=1,e.src=c,b.insertBefore(e,b.firstChild)}var a=document,b=a.getElementsByTagName("head")[0],c=/^https?:\\/\\//,d={},e={},f={},g,h={},i="string",j=!1,k="push",l="DOMContentLoaded",m="readyState",n="addEventListener",o="onreadystatechange";return!a[m]&&a[n]&&(a[n](l,function t(){a.removeEventListener(l,t,j),a[m]="complete"},j),a[m]="loading"),r.get=s,r.order=function(a,b,c){(function d(e){e=a.shift(),a.length?r(e,d):r(e,b,c)})()},r.path=function(a){g=a},r.ready=function(a,b,c){a=a[k]?a:[a];var e=[];return!q(a,function(a){d[a]||e[k](a)})&&p(a,function(a){return d[a]})?b():!function(a){f[a]=f[a]||[],f[a][k](b),c&&c(e)}(a.join("|")),r},r},this)\n  '),nct.r.write("</script>\n  <!-- "),nct.r.getout("analytics",[],[]),nct.r.write(' -->\n  <script>\n    var self = self || window; // fix bug in fonts.js\n    var pageStart = new Date();\n\n    var loadMessage = function(msg) {\n      var loadingDiv = document.getElementById("loadingMessage");\n      if (loadingDiv) loadingDiv.innerHTML = msg;\n    };\n\n    var loadingTimeout = setTimeout(function() {\n      loadMessage("Loading Error")\n    }, 10000);\n\n    $script(\''),nct.r.mgetout(["deps","three_js"],[],[]),nct.r.write("', 'three');\n    $script('"),nct.r.mgetout(["deps","deps_js"],[],[]),nct.r.write('\', \'deps\');\n    $script.ready([\'three\',\'deps\'], function() {\n      var depsLoaded = new Date();\n      if (typeof THREE === "undefined" || typeof $ === "undefined") {\n        loadMessage("Dependencies not loaded");\n        return;\n      }\n      loadMessage("Loading...");\n     '),nct.r.doif(nct.r.get("minified",[],"if"),nct.r.multi([nct.r.write("\n       $script('"),nct.r.mgetout(["deps","app_js"],[],[]),nct.r.write("', 'exo');\n     ")],false),nct.r.write("\n       $script('/js/appStub.js');\n     ")),nct.r.write("\n      $script.ready('exo', function() {\n        var appLoaded = new Date();\n        exo.on('loaded', function() {\n          clearTimeout(loadingTimeout);\n          $('#loading').remove();\n          "),nct.r.write("\n          if (anlysTest) {\n            analytics.track( 'Test - Deps', { category: 'Test - Load', label: '', value: depsLoaded - pageStart } );\n            analytics.track( 'Test - App', { category: 'Test - Load', label: '', value: appLoaded - depsLoaded } );\n            analytics.track( 'Test - Init', { category: 'Test - Load', label: '', value: new Date() - appLoaded } );\n            analytics.track( 'Test - Total', { category: 'Test - Load', label: '', value: new Date() - pageStart } );\n          }\n          else {\n            analytics.track( 'Deps', { category: 'Load', label: '', value: depsLoaded - pageStart } );\n            analytics.track( 'App', { category: 'Load', label: '', value: appLoaded - depsLoaded } );\n            analytics.track( 'Init', { category: 'Load', label: '', value: new Date() - appLoaded } );\n            analytics.track( 'Total', { category: 'Load', label: '', value: new Date() - pageStart } );\n          }\n          "),nct.r.write("\n        });\n        exo.on('loadError', function(err) {\n          clearTimeout(loadingTimeout);\n          loadMessage(\"Error starting app....\");\n          throw err;\n        });\n        highbrow.setDomLibrary($);\n        "),nct.r.doif(nct.r.get("clientOnly",[],"if"),nct.r.write("\n        exo.initStudio();\n        "),nct.r.multi([nct.r.write("\n        window.app = exo.init("),nct.r.getout_no("appOptions",[],[]),nct.r.write(");\n        ")],false)),nct.r.write('\n      });\n    });\n  </script>\n</head>\n<body>\n  <div id="loading" class=\'loading overlay\'>\n    <div id="loadingMessage" class="message">Loading</div>\n  </div>\n  <div id="topnav" class="uirow"></div>\n  <div class="app-container scroll-y">\n    <div id="app" class="content-body"></div>\n  </div>\n  <div id="editor" style="display: none">\n  </div>\n  '),nct.r.doif(nct.r.get("test",[],"if"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("_test_loading"),nct.r.write("\n  ")],false)),nct.r.write("\n\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n</body>\n</html>\n')],false),"layout");nct.register(nct.r.multi([nct.r.write('<div id="loading" class=\'loading overlay subtle\'>\n  <div id="" class="message">'),nct.r.getout("message",[],[]),nct.r.write("</div>\n</div>\n")],false),"loading");nct.register(nct.r.multi([nct.r.doif(nct.r.get("command",[],"if"),nct.r.multi([nct.r.write('\n<li><a class="command" data-command="'),nct.r.getout("command",[],[]),nct.r.write('" href="#">'),nct.r.getout("name",[],[]),nct.r.write("</a></li>\n")],false),nct.r.multi([nct.r.write('\n<li class="dropdown'),nct.r.doif(nct.r.get("depth",[],"if"),nct.r.write("-submenu")),nct.r.write('">\n  <a class="dropdown-toggle" data-toggle="dropdown" href="#">'),nct.r.getout("name",[],[]),nct.r.write('</a>\n  <ul class="dropdown-menu" role="menu">\n  '),nct.r.each(nct.r.get("items",[],"each"),nct.r.multi([nct.r.write("\n    "),nct.r.partial("menubar_item"),nct.r.write("\n  ")],false)),nct.r.write("\n  </ul>\n</li>\n")],false)),nct.r.write("\n")],false),"menubar_item");nct.register(nct.r.multi([nct.r.write('<div class="alert alert-'),nct.r.getout("type",[],[]),nct.r.write('">\n  <button type="button" class="close" data-dismiss="alert">x</button>\n  '),nct.r.getout("message",[],[]),nct.r.write("\n</div>\n")],false),"notification");nct.register(nct.r.write('<div class="row">\n</div>\n'),"notifications");nct.register(nct.r.multi([nct.r.write('<form class="plugin form-vertical"><div class="row"><div class="span4"><ul class="breadcrumb"><li><a href="/plugins">Plugins</a><span class="divider">/</span></li><li class="active">'),nct.r.getout("name",[],[]),nct.r.write('</li></ul><div class="page-header">'),nct.r.doif(nct.r.get("isNew",[],"if"),nct.r.write("<h1>Create New Plugin</h1>\n"),nct.r.write("<h1>Edit Plugin</h1>")),nct.r.write('</div><fieldset><div class="control-group '),nct.r.mgetout(["error","name"],[],[]),nct.r.write(' undefined"><label class="control-label" for="name">Name</label><div class="controls"><input class="span4" name="name" value="'),nct.r.getout("name",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","name"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","name_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","version"],[],[]),nct.r.write(' undefined"><label class="control-label" for="version">Version</label><div class="controls"><input class="span4" name="version" value="'),nct.r.getout("version",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","version"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","version_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","description"],[],[]),nct.r.write('"><label class="control-label" for="description">Description</label><textarea class="span4" name="description" rows="5">'),nct.r.getout("description",[],[]),nct.r.write("</textarea>"),nct.r.doif(nct.r.mget(["error","description"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","description_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div><div class="control-group"><div class="controls"><label class="checkbox"><input name="loadFromServer" type="checkbox"/>Load From Server</label></div></div><div class="control-group '),nct.r.mgetout(["error","url"],[],[]),nct.r.write(' undefined"><label class="control-label" for="url">Development Server</label><div class="controls"><input class="span4" name="url" value="'),nct.r.getout("url",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","url"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","url_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary" type="submit">Submit</button><button class="btn pull-right save" type="submit" disabled="disabled">Save</button></div></fieldset></div><div class="span8"><div class="content" style="position: absolute; top: 0; bottom: 0; left: 300px; right: 0"></div></div></div></form>')],false),"plugins/edit");nct.register(nct.r.write('<ul class="breadcrumb">\n  <li class="active">Plugins</li>\n</ul>\n<div class="title">\n  <a href=\'/plugins/new\' class="btn btn-primary pull-right create-plugin">Create New\n  Plugin</a>\n  <h1>Plugins</h1>\n</div>\n<table class=\'table\'>\n<tr>\n  <th>Name</th>\n  <th>Version</th>\n  <th>Updated</th>\n  <th></th>\n</tr>\n</table>\n'),"plugins/list");nct.register(nct.r.multi([nct.r.write("<td><a class='edit' href='/plugins/"),nct.r.getout("id",[],[]),nct.r.write('/edit\' style="display: block;"\n data-content="'),nct.r.getout("description",[],[]),nct.r.write('">'),nct.r.getout("name",[],[]),nct.r.write(" (edit)</a></td>\n<td>"),nct.r.getout("version",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("lastUpdated",[],[]),nct.r.write("</td>\n<td></td>\n")],false),"plugins/list_item");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.getout_no("Title",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="documentation static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container doc-container">\n    <div class="hub-block">\n      '),nct.r.getout_no("Content",[],[]),nct.r.write('\n      <div class="hub-link-list">\n        '),nct.r.partial("_hub_idx"),nct.r.write('\n      </div>\n    </div>\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n\n</body>\n</html>\n')],false),"publishing/learn/layout-hub");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.getout_no("Title",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="documentation static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container doc-container">\n    <div class="left-index">\n      '),nct.r.partial("_index"),nct.r.write('\n    </div>\n    <div class="main-content">\n      <div class="bottom-nav">\n        '),nct.r.doif(nct.r.mget(["neighbours","prev"],[],"if"),nct.r.multi([nct.r.write('\n        <a class="btn btn-custom" href="'),nct.r.mgetout_no(["neighbours","prev"],[],[]),nct.r.write('"><i class="icon-chevron-left" style="margin-right: 8px; float: left"></i>Previous</a>\n        ')],false)),nct.r.write("\n        "),nct.r.doif(nct.r.mget(["neighbours","next"],[],"if"),nct.r.multi([nct.r.write('\n        <a class="btn btn-custom" style="float:right" href="'),nct.r.mgetout_no(["neighbours","next"],[],[]),nct.r.write('">Next<i class="icon-chevron-right" style="margin-left: 8px; float: right"></i></a>\n        ')],false)),nct.r.write("\n      </div>\n      "),nct.r.getout_no("Content",[],[]),nct.r.write('\n      <div class="bottom-nav">\n        '),nct.r.doif(nct.r.mget(["neighbours","prev"],[],"if"),nct.r.multi([nct.r.write('\n        <a class="btn btn-custom" href="'),nct.r.mgetout_no(["neighbours","prev"],[],[]),nct.r.write('"><i class="icon-chevron-left" style="margin-right: 8px; float: left"></i>Previous</a>\n        ')],false)),nct.r.write("\n        "),nct.r.doif(nct.r.mget(["neighbours","next"],[],"if"),nct.r.multi([nct.r.write('\n        <a class="btn btn-custom" style="float:right" href="'),nct.r.mgetout_no(["neighbours","next"],[],[]),nct.r.write('">Next<i class="icon-chevron-right" style="margin-left: 8px; float: right"></i></a>\n        ')],false)),nct.r.write('\n      </div>\n    </div>\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n\n  '),nct.r.write('\n  <script type="text/javascript">\n    var currentFile = "#" + "'),nct.r.getout_no("currentFile",[],[]),nct.r.write('";\n    $("" + currentFile).addClass("active");\n  </script>\n  '),nct.r.write("\n\n</body>\n\n</html>\n")],false),"publishing/learn/layout");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.getout_no("Title",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="documentation static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container doc-container">\n    <div class="hub-block">\n      '),nct.r.getout_no("Content",[],[]),nct.r.write('\n      <div class="hub-link-list">\n        '),nct.r.partial("_hub_idx"),nct.r.write('\n      </div>\n    </div>\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n\n</body>\n</html>\n')],false),"publishing/legal/layout-hub");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.getout_no("Title",[],[]),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="documentation static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container doc-container">\n    <div class="main-content legal">\n      '),nct.r.getout_no("Content",[],[]),nct.r.write('\n    </div>\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n\n</body>\n</html>\n')],false),"publishing/legal/layout");nct.register(nct.r.multi([nct.r.write('<ul class="breadcrumb">\n  <li><a href="/scenes">Scenes</a> <span class="divider">/</span></li>\n  <li><a href="/editor/'),nct.r.getout("sceneId",[],[]),nct.r.write('">'),nct.r.getout("sceneName",[],[]),nct.r.write('</a> <span class="divider">/</span></li>\n  <li class="active">Results</li>\n</ul>\n<div class="title">\n  <h1>Results</h1>\n</div>\n<table class=\'table results\'>\n  <tr>\n    <th></th>\n    <th>Start Time</th>\n    <th>Elapsed Time</th>\n    <th>Results</th>\n    <th><a class="btn close delete-all-results" href="#">Clear</a></th>\n  </tr>\n</table>\n')],false),"results/list");nct.register(nct.r.multi([nct.r.write("<td>"),nct.r.getout("description",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("createdFromNow",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("elapsedTime",[],[]),nct.r.write("s</td>\n<td>\n"),nct.r.doif(nct.r.get("done",[],"if"),nct.r.multi([nct.r.write("\n  "),nct.r.doif(nct.r.get("isFiles",[],"if"),nct.r.multi([nct.r.write("\n    "),nct.r.each(nct.r.get("content",[],"each"),nct.r.multi([nct.r.write("\n      <a href='"),nct.r.getout("assetURL",[],[]),nct.r.write('\' target="_blank">'),nct.r.getout("name",[],[]),nct.r.write("</a>,\n    ")],false)),nct.r.write("\n  ")],false),nct.r.multi([nct.r.write("\n    "),nct.r.doif(nct.r.get("isFile",[],"if"),nct.r.multi([nct.r.write("\n      <a href='"),nct.r.mgetout(["content","assetURL"],[],[]),nct.r.write('\' target="_blank">'),nct.r.mgetout(["content","name"],[],[]),nct.r.write("</a>\n    ")],false),nct.r.multi([nct.r.write("\n      "),nct.r.getout("content",[],[]),nct.r.write("\n    ")],false)),nct.r.write("\n  ")],false)),nct.r.write("\n")],false),nct.r.write('\n  <img height="16" width="16" src="/img/loading.gif"/>\n')),nct.r.write('</td>\n<td><a class="btn close delete-result" href="#">x</a></td>\n')],false),"results/list_item");nct.register(nct.r.multi([nct.r.each(nct.r.get("pluginAccess",[],"each"),nct.r.multi([nct.r.write("\n<tr>\n  <td>"),nct.r.getout("pluginName",[],[]),nct.r.write("</td>\n  <td>"),nct.r.getout("pluginType",[],[]),nct.r.write("</td>\n  <td>\n    <a class='remove-access' data-plugintype='"),nct.r.getout("pluginType",[],[]),nct.r.write("' data-pluginname='"),nct.r.getout("pluginName",[],[]),nct.r.write("' href='#'><i class=\"icon-white icon-remove\"></i></a>\n  </td>\n</tr>\n")],false)),nct.r.write("\n")],false),"scenes/_plugin_share_list");nct.register(nct.r.multi([nct.r.each(nct.r.get("access",[],"each"),nct.r.multi([nct.r.write('\n<tr>\n  <td class="scene-share-access avatar"><img class="share-avatar" src="'),nct.r.doif(nct.r.get("gravatar",[],"if"),nct.r.getout("gravatar",[],[]),nct.r.write("../img/default_avatar.png")),nct.r.write('"/></td>\n  <td class="scene-share-access">'),nct.r.doif(nct.r.get("username",[],"if"),nct.r.getout("username",[],[]),nct.r.getout("email",[],[])),nct.r.write('</td>\n  <td class="scene-share-access">'),nct.r.getout("permission",[],[]),nct.r.write('\n  </td>\n  <td class="scene-share-access">\n    '),nct.r.unless(nct.r.get("isOwner",[],"unless"),nct.r.multi([nct.r.write("\n    <a class='remove-access' data-username='"),nct.r.doif(nct.r.get("username",[],"if"),nct.r.getout("username",[],[]),nct.r.getout("email",[],[])),nct.r.write("' href='#'><i class=\"icon-white icon-remove\"></i></a>\n    ")],false)),nct.r.write("\n  </td>\n</tr>\n")],false)),nct.r.write("\n")],false),"scenes/_share_list");nct.register(nct.r.write('<div class="modal-header">\n  <!--\n  <select class="pull-right plugin-select" data-placeholder="Select a Plugin">\n    <option></option>\n  </select>\n-->\n  <h3>New Scene</h3>\n</div>\n<div class="modal-body">\n  <div class="new-scene-content" id="new-scene-content">\n    <!--\n    <div class="templates">\n      <h5>Templates</h5><hr />\n      <div class="template-list active">\n      </div>\n    </div>\n    <div class="examples" style="display:none">\n      <hr /><h5>Examples</h5><hr />\n      <div class="example-list">\n      </div>\n    </div>\n  -->\n  </div>\n</div>\n<div class="modal-footer">\n  <a href="#" class="btn cancel">Cancel</a>\n</div>'),"scenes/create");nct.register(nct.r.write('<div class="title">\n  <div class="dropdown pull-right btn-group">\n    <button class="btn btn-primary btn-custom create-scene">New Scene</button>\n  </div>\n  <h1>Scenes</h1>\n</div>\n<table class=\'table\'>\n<thead>\n  <tr>\n    <th>Scene</th>\n    <th>Owner</th>\n    <th>Updated</th>\n    <th></th>\n    <th></th>\n  </tr>\n</thead>\n<tbody>\n</tbody>\n</table>\n'),"scenes/list");nct.register(nct.r.multi([nct.r.write('<td data-toggle="context" data-target="#actions-'),nct.r.getout("id",[],[]),nct.r.write('" style="position: relative">\n  <a href=\'/editor/'),nct.r.getout("id",[],[]),nct.r.write('\' style="display: block;">'),nct.r.getout("name",[],[]),nct.r.write("</a>\n</td>\n<td>"),nct.r.getout("owner",[],[]),nct.r.write("</td>\n<td>"),nct.r.getout("lastUpdated",[],[]),nct.r.write("</td>\n<td><!-- <a href='/scenes/"),nct.r.getout("id",[],[]),nct.r.write("/results'>Results</a>, <a href='/scenes/"),nct.r.getout("id",[],[]),nct.r.write('/files\'>Files </a>--></td>\n<td>\n  <div class="btn-group">\n    <a class="btn dropdown-toggle" data-toggle="dropdown"\n    href="#">Actions <span class="caret"></span></a>\n    <ul class="dropdown-menu">\n      '),nct.r.doif(nct.r.get("isAdmin",[],"if"),nct.r.write("\n        <li><a href=\"#\" class='plugin-share-scene'>Share With Plugin</a></li>\n      ")),nct.r.write('\n      <li><a href="#" class=\'share-scene\'>Share</a></li>\n      <li><a href="#" class=\'clone-scene\'>Clone</a></li>\n      <li class="divider"></li>\n      <li><a href="#" class=\'delete-scene\'>Delete</a></li>\n    </ul>\n  </div>\n</td>\n')],false),"scenes/list_item");
nct.register(nct.r.multi([nct.r.write('<div class="modal-header">\n  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n  <h3>Plugin Sharing Settings</h3>\n</div>\n<div class="modal-body">\n  <p>Currently shared plugins:</p>\n  <table class=\'access\'>\n    <thead>\n      <tr>\n        <th>Plugin Name</th>\n        <th>Type</th>\n      </tr>\n    </thead>\n    <tbody>\n    '),nct.r.partial("scenes/_plugin_share_list"),nct.r.write('\n    </tbody>\n  </table>\n  <form class="collapsed">\n    <fieldset>\n      <label>Add plugin:</label>\n      <select type="text" name="add" data-placeholder="Enter plugin name">\n        <option></option>\n        '),nct.r.each(nct.r.get("plugins",[],"each"),nct.r.multi([nct.r.write('\n        <option value="'),nct.r.getout("name",[],[]),nct.r.write('">'),nct.r.getout("name",[],[]),nct.r.write("</option>\n        ")],false)),nct.r.write('\n      </select>\n      <select type="text" name="type" data-placeholder="Enter sharing type">\n        <option></option>\n        '),nct.r.each(nct.r.get("pluginShareTypes",[],"each"),nct.r.multi([nct.r.write('\n        <option value="'),nct.r.getout("type",[],[]),nct.r.write('">'),nct.r.getout("type",[],[]),nct.r.write("</option>\n        ")],false)),nct.r.write('\n      </select>\n      <a href="#" class="add-access"><i class="icon-white icon-plus"></i></a>\n    </fieldset>\n  </form>\n</div>\n<div class="modal-footer">\n  <a href="#" class="btn btn-primary submit">Share</a>\n  <a href="#" class="btn cancel">Cancel</a>\n</div>\n')],false),"scenes/plugin_share");nct.register(nct.r.multi([nct.r.write('<div class="modal-header">\n  <h3>Sharing Settings - '),nct.r.getout("name",[],[]),nct.r.write('</h3>\n</div>\n<div class="modal-body">\n  <p>Users able to access this scene:</p>\n  <table class=\'access sharing-scenes\'>\n    <thead>\n      <tr>\n        <th class="share-scene-header avatar-header"></th>\n        <th class="share-scene-header username">User</th>\n        <!--<th id="share-scene-name" class="share-scene-header">User Name</th>-->\n        <th class="share-scene-header permission">Permission</th>\n        <th class="share-scene-header operation"></th>\n      </tr>\n    </thead>\n    <tbody>\n    '),nct.r.partial("scenes/_share_list"),nct.r.write('\n    </tbody>\n  </table>\n  <form class="collapsed">\n    <fieldset>\n      <label>Add people:</label>\n      <!--<input type="text" name="add" placeholder="Enter username or e-mail" /> -->\n      <textarea wrap="logical" class="shareList" name="add" placeholder="Enter comma-separated usernames or e-mails."></textarea>\n      <!--<a href="#" class="btn btn-primary addUser">Add</a>-->\n      <span class="help-inline share-help"></span>\n    </fieldset>\n  </form>\n</div>\n<div class="modal-footer">\n  <a href="#" class="btn btn-primary submit" disabled="true">Share &amp; Save</a>\n  <a href="#" class="btn cancel">Cancel</a>\n</div>\n')],false),"scenes/share");nct.register(nct.r.extend("static/layout_error",nct.r.multi([nct.r.block("error",nct.r.write("403")),nct.r.block("title",nct.r.write("403 Access Forbidden")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Access is Forbidden <span>:(</span></h1></div><p>Sorry, but the page you were trying to view has not been made available to you.</p><p>Please email support@exocortex.com and we will see what is going on.</p>'))],false)),"static/403");nct.register(nct.r.extend("static/layout_error",nct.r.multi([nct.r.block("error",nct.r.write("404")),nct.r.block("title",nct.r.write("404 Page Not Found")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Not found <span>:(</span></h1></div><p>Sorry, but the page you were trying to view does not exist.</p><p>It looks like this was the result of either:</p><ul><li>a mistyped address</li><li>an out-of-date link</li></ul>')),nct.r.block("fixurlscript",nct.r.write('<script>    var GOOG_FIXURL_LANG = (navigator.language || "").slice(0,2),GOOG_FIXURL_SITE = location.host;  </script>  <script src="http://linkhelp.clients.google.com/tbproxy/lh/wm/fixurl.js"></script>'))],false)),"static/404");nct.register(nct.r.extend("static/layout_error",nct.r.multi([nct.r.block("error",nct.r.write("500")),nct.r.block("title",nct.r.write("500 Internal Server Error")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Internal Server Error <span>:(</span></h1></div><p>Sorry, but the page you were trying to view has caused a server error.</p><p>Please email support@exocortex.com and we will see what is going on.</p>'))],false)),"static/500");nct.register(nct.r.extend("static/layout_error",nct.r.multi([nct.r.block("error",nct.r.write("502")),nct.r.block("title",nct.r.write("502 Bad Gateway")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Bad Gateway <span>:(</span></h1></div><p>Sorry, but the internal server you were trying to access is not currently available.</p><p>Please email support@exocortex.com and we will see what is going on.</p>'))],false)),"static/502");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Apply for the Clara.io Beta")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="page-header"><h1>Apply for the Clara.io Beta</h1></div><form class="apply form-horizontal static-form" action="/api/applications" method="POST"><fieldset><div class="alert hide"></div><div class="control-group '),nct.r.mgetout(["error","email"],[],[]),nct.r.write(' undefined"><label class="control-label" for="email">Email</label><div class="controls"><input class="span4" name="email" value="'),nct.r.getout("email",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","email"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","email_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary btn-custom" type="submit">Apply</button></div></fieldset></form>')],false))],false)),"static/apply");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Optional Beta Application Information")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="page-header"><h1>Optional Information</h1></div><form class="apply_step2 form-horizontal static-form" action="/api/applications" method="POST"><fieldset><div class="alert hide"></div><div><p class="spaced-text">We have recorded your email, thanks!  Speed up your acceptance into the beta by letting us know more about you.</p></div><input class="span4" name="id" type="hidden"/><h3>Contact Information</h3><div class="control-group '),nct.r.mgetout(["error","name"],[],[]),nct.r.write(' undefined"><label class="control-label" for="name">Name</label><div class="controls"><input class="span4" name="name" value="'),nct.r.getout("name",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","name"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","name_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","jobTitle"],[],[]),nct.r.write(' undefined"><label class="control-label" for="jobTitle">Job Title</label><div class="controls"><input class="span4" name="jobTitle" value="'),nct.r.getout("jobTitle",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","jobTitle"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","jobTitle_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","company"],[],[]),nct.r.write(' undefined"><label class="control-label" for="company">Company</label><div class="controls"><input class="span4" name="company" value="'),nct.r.getout("company",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","company"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","company_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","website"],[],[]),nct.r.write(' undefined"><label class="control-label" for="website">Website</label><div class="controls"><input class="span4" name="website" value="'),nct.r.getout("website",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","website"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","website_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","priorityCode"],[],[]),nct.r.write(' undefined"><label class="control-label" for="priorityCode">Code</label><div class="controls"><input class="span4" name="priorityCode" value="'),nct.r.getout("priorityCode",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","priorityCode"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","priorityCode_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><h3>Join Our Community</h3><div><p class="spaced-text">Let the rest of the Clara.io community know who you are by joining our forums and <a href="http://discuss.exocortex.com/category/introductions" target="_blank">introducing yourself</a>.</p><div class="control-group '),nct.r.mgetout(["error","discussIntroLink"],[],[]),nct.r.write(' undefined"><label class="control-label" for="discussIntroLink">Link to Your Post</label><div class="controls"><input class="span4" name="discussIntroLink" value="'),nct.r.getout("discussIntroLink",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","discussIntroLink"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","discussIntroLink_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><p class="spaced-text">To keep up with the latest news for Clara.io, follow us on Twitter or like us on Facebook or G+.</p><div class="social-media"><div class="social-media-item"><a href="http://exocortex.com/t"><img src="/img/landing/TwitterButton.png" alt="Follow Us on Twitter" style="border: 0px;"/></a></div><div class="social-media-item"><a href="http://exocortex.com/gp" rel="publisher"><img src="/img/landing/GPlusButton.png" alt="Add Us to Your G+ Circle" style="border: 0px;"/></a></div><div class="social-media-item"><a href="http://exocortex.com/fb"><img src="/img/landing/FBButton.png" alt="Like Us on Facebook" style="border: 0px;"/></a></div></div></div><div><p class="spaced-text">By using Clara.io, you are agreeing to be bound by our <a href="/legal/terms-of-service">Terms of Service</a> and our <a href="/legal/privacy-policy">Privacy Policy</a>.</p></div><div class="form-actions"><button class="btn btn-primary btn-custom" type="submit">Done</button></div></fieldset></form>')],false))],false)),"static/apply_step2");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Apply for Beta Access - Thanks")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Thanks for Applying for the Clara.io Beta</h1><div><p class="large">Thanks for applying!</p></div><div><p class="spaced-text">Go back to the <a href="/">Clara.io homepage</a> or visit <a href="http://exocortex.com">Exocortex.com</a></p></div></div>'))],false)),"static/apply_thanks");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Forgot your Password?")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="page-header"><h1>Forgot your Password?</h1></div><p class="spaced-text">Enter your username or email address below and we will send you instructions on how to reset your password.</p><form class="forgot_password form-horizontal static-form" action="api/sessions/forgot_password" method="POST"><fieldset><div class="alert hide"></div><div class="control-group '),nct.r.mgetout(["error","username"],[],[]),nct.r.write(' undefined"><label class="control-label" for="username">Username or Email</label><div class="controls"><input class="span4" name="username" value="'),nct.r.getout("username",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","username"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","username_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary btn-custom" type="submit">Reset Password</button><button class="btn" type="cancel" onclick="window.location.href=\'/login\';">Cancel</button></div></fieldset></form>')],false))],false)),"static/forgot_password");nct.register(nct.r.extend("static/layout_landing",nct.r.multi([nct.r.block("title",nct.r.write(" by Exocortex - Home")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="container"><div class="span12"><div id="myCarousel" class="carousel slide"><div class="carousel-inner"><div class="active item"><div class="row carousel-img" style="background-image: url(/img/landing/Banner3.jpg);"><div class="carousel-title"><h1>3D Creation and Sharing<br>on the Web</h1></div><div class="carousel-banner"><h2>No downloads, no licenses, no configuration.<br>Create, upload, tweak, share, convert, and collaborate with Clara.io. Right from your browser.</h2></div></div></div><div class="item"><div class="row carousel-img" style="background-image: url(/img/landing/Banner2.jpg);"><div class="carousel-title"><h1 class="light-text">Hosted on the Cloud, Always Available</h1></div><div class="carousel-banner"><h2>Your data is always available where ever you choose to work.</h2></div></div></div><div class="item"><div class="row carousel-img" style="background-image: url(/img/landing/Banner1.jpg);"><div class="carousel-title"><h1>Familiar Interface, Unfamiliar Convenience</h1></div><div class="carousel-banner"><h2>Our UI is modelled on traditional desktop tools, but we have removed licensing, configuration, deploy, upgrades and limited resources.</h2></div></div></div></div><div class="carousel-signup"><form class="apply" action="/api/applications" method="POST"><fieldset><div class="formfields"><div class="control-group '),nct.r.mgetout(["error","email"],[],[]),nct.r.write(' undefined"><div class="controls"><input class="email-box big-form" name="email" placeholder="Your Email"/>'),nct.r.doif(nct.r.mget(["error","email"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","email_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-custom btn-large" type="submit">Apply for the Beta</button></div></div><div class="formfields"><div class="alert hide"></div></div></fieldset></form></div><a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a><a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a></div><div class="row"><div class="mainFeatureItem"><img src="/img/landing/CloudIconFlat.png"/><h2>On the Cloud</h2><p class="large">Available anytime, anywhere, even on the go.</p></div><div class="mainFeatureItem"><img src="/img/landing/GlobeIconFlat.png"/><h2>In the Browser</h2><p class="large">Forget installation and configuration. Just launch your browser and start creating.</p></div><div class="mainFeatureItem"><img src="/img/landing/ShareIconFlat.png"/><h2>With Anyone</h2><p class="large">Share your 3D scene with your friends and collaborate in real-time.</p></div></div><div class="row light"><div class="announcement"><h1>Now in Beta!</h1><hr /><p class="large">Join us in testing the future of 3D content creation.</p><p>Receive the latest updates, submit your feedback, and contribute to making Clara.io the industry leader in 3D.</p><button id="registerBtn" class="btn btn-custom btn-large btn-announcement">Apply</button></div></div><div class="row light"><div class="announcement"><h1>Features to match your workflow</h1><hr /></div></div><div class="row light"><div class="announcement"><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_339_rabbit@2x.png"/></div><p class="large">Polymeshes</p><p>Operate on polygon meshes with support for indexed UVs and color and normal maps.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_139_adjust_alt@2x.png"/></div><p class="large">Operators</p><p>Use operators to easily modify and transform your models.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_176_forward@2x.png"/></div><p class="large">Animation</p><p>Compose animations using keyframes on nearly any object parameter.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_096_vector_path_polygon@2x.png"/></div><p class="large">Sub-object editing</p><p>Create custom models quickly using familiar sub-object editing tools.</p></div></div></div><div class="row light"><div class="announcement"><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_244_conversation@2x.png"/></div><p class="large">Real Time Editing</p><p>Collaborate and view changes as they happen. Preview scenes in high fidelity with real time shaders.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_057_history@2x.png"/></div><p class="large">Versioning</p><p>Return to any previous version of your work with automatic version control.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_165_iphone_exchange@2x.png"/></div><p class="large">Multi-Platform</p><p>Work from your powerful Windows or Linux PC, your portable MacBook, and even from an Android tablet.</p></div><div class="smallFeatureItem"><div class="icon"><img src="/img/landing/glyphicons_083_random@2x.png"/></div><p class="large">Wide Format Support</p><p>Import and export your models and textures using the most popular formats.</p></div></div></div><div class="row light"><div class="announcement"><h1>What people are saying</h1><hr /></div></div><div class="row light"><div class="announcement"><div class="customerQuote"><p>"Clara.io is <strong>really amazing</strong>.  I am very confident such an approach is <strong>the future of the industry</strong>."<br /><br />&mdash; Douglas Lassance, Layout Artist at Blur Studio.</p></div><div class="customerQuote"><p>"From watching the early stages of Clara.io, it is obvious how <strong>fast this tool is growing and will continue to grow</strong>. Their development decisions have been made with <strong>the future in mind</strong>."<br /><br />&mdash; Allen Pestaluky, Game Developer & Designer at Magmic</p></div></div></div><div class="separator"></div><div class="row blue"><h1>Made by professionals for professionals</h1><p class="large">Clara.io is the latest innovation from the trusted and experienced team at <a href=\'http://exocortex.com\'>Exocortex</a>.</p><p>Exocortex\'s suite of products are trusted by hundreds of creative teams at studios around the world.<br/>Exocortex\'s tools have been used to create these recent Hollywood blockbuster films:</p><div class="poster-strip"><img src="/img/landing/HP7Pt2Poster.png"/><img src="/img/landing/AvengersPoster.png"/><img src="/img/landing/IronMan3Poster.png"/><img src="/img/landing/IntoDarknessPoster.png"/><img src="/img/landing/CatchingFirePoster.png"/><img src="/img/landing/Titanic3DPoster.png"/><img src="/img/landing/JP3DPoster.png"/></div></div><div class="row"><div class="bottom-nav"><ul class="nav-pills nav bottom-nav"><li><a href="http://exocortex.com/blog">Blog</a></li><li class="separator">|</li><li><a href="http://exocortex.com/forum">Community</a></li><li class="separator">|</li><li><a href="http://exocortex.com/company">Company</a></li></ul></div></div><div class="row social-media"><div class="social-media-item"><a href="http://exocortex.com/t"><img src="/img/landing/TwitterButton.png" alt="Follow Us on Twitter" style="border: 0px;"/></a></div><div class="social-media-item"><a href="http://exocortex.com/gp" rel="publisher"><img src="/img/landing/GPlusButton.png" alt="Add Us to Your G+ Circle" style="border: 0px;"/></a></div><div class="social-media-item"><a href="http://exocortex.com/fb"><img src="/img/landing/FBButton.png" alt="Like Us on Facebook" style="border: 0px;"/></a></div></div><div class="row end-text"><p>&copy; 2005-2013 Exocortex Technologies, Inc. Product names are trademarks of Exocortex Technologies, Inc.</p><p>By using Clara.io, you are agreeing to be bound by our <a href="/legal/terms-of-service">Terms of Service</a> and our <a href="/legal/privacy-policy">Privacy Policy</a>.</p></div></div></div>')],false))],false)),"static/landing");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.block("title",nct.r.write("")),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container below-nav">\n    '),nct.r.block("main",nct.r.write("")),nct.r.write('\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.block("bottom",nct.r.write("")),nct.r.write("\n  "),nct.r.partial("_analytics"),nct.r.write('\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n</body>\n</html>\n')],false),"static/layout");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.write(" - "),nct.r.block("title",nct.r.write("")),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container">\n    '),nct.r.block("main",nct.r.write("")),nct.r.write("\n    "),nct.r.block("fixurlscript",nct.r.write("")),nct.r.write('\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript"> var anlysTest = '),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write('\n\n	<script type="text/javascript">\n    analytics.pageview(\'/'),nct.r.block("error",nct.r.write("")),nct.r.write('/?url=\' + document.location.pathname + document.location.search + \'&ref=\' + document.referrer);\n	</script>\n  <script type="text/javascript" src="/fonts/MyFontsWebfontsKit.js"></script>\n\n</body>\n</html>\n')],false),"static/layout_error");nct.register(nct.r.multi([nct.r.partial("header_boilerplate"),nct.r.write("\n  <title>"),nct.r.getout("applicationName",[],[]),nct.r.block("title",nct.r.write("")),nct.r.write('</title>\n  <link rel="shortcut icon" href="/img/favicon.ico" />\n  <link href="'),nct.r.getout("studio_css",[],[]),nct.r.write('" rel="stylesheet" type="text/css">\n</head>\n<body class="landing static-body">\n  '),nct.r.partial("static_top_nav"),nct.r.write('\n  <div class="container landing-container dark">\n    '),nct.r.block("main",nct.r.write("")),nct.r.write('\n  </div>\n\n  <!-- bottom loading of our JavaScript to improve page speed -->\n  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-carousel-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-transition-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/bootstrap-collapse-v2.1.1.js"></script>\n  <script type="text/javascript" src="/js/analytics-0.11.7.min.js"></script>\n  <script type="text/javascript" src="'),nct.r.getout("static_js",[],[]),nct.r.write('"></script>\n  <script type="text/javascript">\n    $(\'.carousel\').carousel('),nct.r.getout("interval:",["5000"],[]),nct.r.write(");\n    $('.carousel').carousel('cycle');\n  </script>\n  <script type=\"text/javascript\"> var anlysTest = "),nct.r.doif(nct.r.get("analyticsTest",[],"if"),nct.r.getout_no("analyticsTest",[],[]),nct.r.write("false")),nct.r.write(";</script>\n  "),nct.r.partial("_analytics"),nct.r.write("\n  <scrtipt type=\"text/javascript\">\n    var context = {\n      providers: {\n        'All'      : false,\n        'Mixpanel' : true\n      }\n    };\n    analytics.track('Loaded Landing Page', context);\n  </script>\n  <script type=\"text/javascript\" src=\"/fonts/MyFontsWebfontsKit.js\"></script>\n\n</body>\n</html>\n")],false),"static/layout_landing");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Login")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="page-header"><h1>Login</h1></div><form class="login form-horizontal static-form" action="/api/session" method="POST"><fieldset><div class="alert hide"></div><div class="control-group '),nct.r.mgetout(["error","username"],[],[]),nct.r.write(' undefined"><label class="control-label" for="username">Username or E-mail</label><div class="controls"><input class="span4" name="username" value="'),nct.r.getout("username",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","username"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","username_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","password"],[],[]),nct.r.write(' undefined"><label class="control-label" for="password">Password</label><div class="controls"><input class="span4" type="password" name="password" value="'),nct.r.getout("password",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","password"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","password_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary btn-custom" type="submit">Log In</button></div><p class="controls spaced-text"><a href="/forgot_password">Forgot password?</a><br /><a href="/apply">Don\'t yet have an account? Apply here!</a></p></fieldset></form>')],false)),nct.r.block("bottom",nct.r.multi([nct.r.write('<script type="text/javascript">$(document).ready(function() {\n  $(\'body\').append(\'<script type="text/javascript" src="'),nct.r.getout_no("deps_js",[],[]),nct.r.write("\"><\\/script>');\n  $('body').append('<script type=\"text/javascript\" src=\""),nct.r.getout_no("three_js",[],[]),nct.r.write("\"><\\/script>');\n});</script>")],false))],false)),"static/login");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Password Reset")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="page-header"><h1>Reset Password</h1></div><form class="password_reset form-horizontal static-form" action="/api/sessions/reset_password" method="POST"><fieldset><div class="alert hide"></div><input class="span4" name="username" type="hidden"/><input class="span4" name="token" type="hidden"/><div class="control-group '),nct.r.mgetout(["error","password"],[],[]),nct.r.write(' undefined"><label class="control-label" for="password">New Password</label><div class="controls"><input class="span4" type="password" name="password" value="'),nct.r.getout("password",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","password"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","password_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","password_confirm"],[],[]),nct.r.write(' undefined"><label class="control-label" for="password_confirm">Confirm Password</label><div class="controls"><input class="span4" type="password" name="password_confirm" value="'),nct.r.getout("password",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","password_confirm"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","password_confirm_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary btn-custom" type="submit">Change Password</button><button class="btn btn-inverse" type="cancel" onclick="window.location.href=\'/login\';">Cancel</button></div></fieldset></form>')],false))],false)),"static/password_reset");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Password Reset Sent")),nct.r.block("main",nct.r.write('<div class="page-header"><h1>Password Reset Sent</h1></div><p class="spaced-text">Your reset password request was sent to your registered email address.<br />The link for resetting your password will be valid only for 24 hrs.</p><p class="spaced-text">Once you have reset your password, return to the <a href="/login">Log In page</a>.</p>'))],false)),"static/password_reset_sent");nct.register(nct.r.extend("static/layout",nct.r.multi([nct.r.block("title",nct.r.write("Sign-Up")),nct.r.block("main",nct.r.multi([nct.r.write('<div class="row"><div class="span8 offset2"><div class="page-header"><h1>Sign-Up</h1></div><form class="signup form-horizontal static-form" action="/api/users" method="POST"><fieldset><input name="_method" type="hidden" value="POST"/><div class="alert hide"></div><input class="span4" name="referral" type="hidden"/><div class="control-group '),nct.r.mgetout(["error","username"],[],[]),nct.r.write(' undefined"><label class="control-label" for="username">Username</label><div class="controls"><input class="span4" name="username" value="'),nct.r.getout("username",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","username"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","username_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","name"],[],[]),nct.r.write(' undefined"><label class="control-label" for="name">Name</label><div class="controls"><input class="span4" name="name" value="'),nct.r.getout("name",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","name"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","name_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","password"],[],[]),nct.r.write(' undefined"><label class="control-label" for="password">Password</label><div class="controls"><input class="span4" type="password" name="password" value="'),nct.r.getout("password",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","password"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","password_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div>By using Clara.io, you are agreeing to be bound by our <a href="/legal/terms-of-service">Terms of Service</a> and our <a href="/legal/privacy-policy">Privacy Policy</a>.</div><div class="form-actions"><button class="btn btn-primary" type="submit">Signup</button></div></fieldset></form></div></div>')],false))],false)),"static/signup");
nct.register(nct.r.write('<div class="navbar navbar-fixed-top dark top-nav"><div class="container"><a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><div class="span-banner"><a href="/"><img class="banner" src="/img/landing/ClaraLogoBeta-trimmed.png"/></a></div><div class="nav-collapse collapse"><ul class="pull-right nav-pills nav"><li><a href="/learn">Learn</a></li><li><a href="http://discuss.exocortex.com">Forum</a></li><li><a href="http://webchat.freenode.net/?channels=clara.io&uio=d4">Chat</a></li><li><a href="http://exocortex.com/blog">Blog</a></li><li><a href="http://exocortex.com/company">Company</a></li><li class="login"></li></ul></div></div></div>'),"static_top_nav");nct.register(nct.r.multi([nct.r.write('<div class="navbar">\n  <div class="navbar-inner">\n    <a class="brand" href="/" style="padding-top: 3px;">\n      <img src=\'/img/ClaraIO_ColorOnTransparent_450x83.png\' />\n    </a>\n\n    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">\n      <span class="icon-bar icon-white"></span>\n      <span class="icon-bar icon-white"></span>\n      <span class="icon-bar icon-white"></span>\n    </a>\n\n    '),nct.r.doif(nct.r.get("scene",[],"if"),nct.r.multi([nct.r.write('\n      <ul class="nav usernav">\n        <li><a class="brand" href="/scenes">Scenes:</a></li>\n        <li><div class="brand">'),nct.r.mgetout(["scene","name"],[],[]),nct.r.write('</div></li>\n      </ul>\n      <div class="nav-collapse collapse">\n        <ul class="menubar nav">\n        </ul>\n      </div>\n    ')],false),nct.r.multi([nct.r.write('\n      <ul class="nav usernav">\n        <li><a class="brand" href="/scenes">Scenes</a></li>\n        '),nct.r.doif(nct.r.get("isPlugins",[],"if"),nct.r.write('<li><a class="brand" href="/plugins">Plugins</a></li>')),nct.r.write("\n      </ul>\n    ")],false)),nct.r.write('\n\n    <div class="nav-collapse collapse">\n      <ul class="nav usernav pull-right">\n        <li><a href="/learn" target="_blank">Learn</a></li>\n        <li><a href="http://discuss.exocortex.com" target="_blank">Forum</a></li>\n        <li><a href="http://webchat.freenode.net/?channels=clara.io&uio=d4" target="_blank">Chat</a></li>\n        <li class=\'connected\' '),nct.r.unless(nct.r.mget(["webSocket","connected"],[],"unless"),nct.r.write('style="display: none"')),nct.r.write('>\n          <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i\n          class="icon-signal icon-white" /></a>\n          <ul class="dropdown-menu" role="menu">\n            <li><a class="go-offline" href=\'#\'>Go Offline</a></li>\n          </ul>\n        </li>\n        <li class=\'not-connected\' '),nct.r.doif(nct.r.mget(["webSocket","connected"],[],"if"),nct.r.write('style="display: none"')),nct.r.write('>\n          <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i\n          class="icon-warning-sign icon-white" /></a>\n          <ul class="dropdown-menu" role="menu">\n            <li><a class="reconnect">Reconnect</a></li>\n          </ul>\n        </li>\n        '),nct.r.doif(nct.r.get("username",[],"if"),nct.r.multi([nct.r.write('\n          <li class="dropdown">\n            <!--<a class="dropdown-toggle" id="user-dropdown" data-toggle="dropdown" href="#"><i class="icon-user icon-white"></i> '),nct.r.getout("username",[],[]),nct.r.write('</a>-->\n            <a class="dropdown-toggle" id="user-dropdown" data-toggle="dropdown" href="#"><img class="top-avatar" src="'),nct.r.getout("userAvatar",[],[]),nct.r.write('"/> '),nct.r.getout("username",[],[]),nct.r.write('</a>\n            <ul class="dropdown-menu" role="menu">\n              <li><a class=\'\' href="/scenes"><i class="icon-home\n              icon-white"></i> Scenes</a></li>\n              '),nct.r.doif(nct.r.get("isPlugins",[],"if"),nct.r.write('<li><a class=\'\' href="/plugins"><i class="icon-tasks\n              icon-white"></i> Plugins</a></li>')),nct.r.write('\n              <li class="divider"></li>\n              '),nct.r.doif(nct.r.get("screenfull",[],"if"),nct.r.write("\n              <li><a class='fullscreen' href='#'><i class=\"icon-fullscreen\n              icon-white\"></i> Full Screen</a></li>\n              ")),nct.r.write('\n              <li><a class=\'\' href="/user"><i class="icon-cog\n              icon-white"></i> Settings</a></li>\n              '),nct.r.doif(nct.r.get("isAdmin",[],"if"),nct.r.write('\n              <li><a class=\'\' href="/admin"><i class="icon-plane\n              icon-white"></i> Admin</a></li>\n              ')),nct.r.write('\n              <li class="divider"></li>\n              <li><a class=\'logout\' href="#"><i class="icon-off\n              icon-white"></i> Log Out</a></li>\n            </ul>\n          </li>\n        ')],false)),nct.r.write("\n      </ul>\n    </div>\n  </div>\n</div>\n\n")],false),"top_nav");nct.register(nct.r.multi([nct.r.write('<div class="row"><div class="span3"><ul class="user-settings nav nav-pills nav-stacked"><li><a href="/user">User Profile</a></li><li class="active"><a href="/user/password">Change Password</a></li></ul></div><div class="span9"><form class="user-settings form-horizontal" method="post"><fieldset><div class="control-group '),nct.r.mgetout(["error","password"],[],[]),nct.r.write(' undefined"><label class="control-label" for="password">Old Password</label><div class="controls"><input class="span4" type="password" name="password"/>'),nct.r.doif(nct.r.mget(["error","password"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","password_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","newPassword"],[],[]),nct.r.write(' undefined"><label class="control-label" for="newPassword">New Password</label><div class="controls"><input class="span4" type="password" name="newPassword"/>'),nct.r.doif(nct.r.mget(["error","newPassword"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","newPassword_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","confPassword"],[],[]),nct.r.write(' undefined"><label class="control-label" for="confPassword">Confirm New Password</label><div class="controls"><input class="span4" type="password" name="confPassword"/>'),nct.r.doif(nct.r.mget(["error","confPassword"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","confPassword_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary" type="submit">Confirm Change</button></div></fieldset></form></div></div>')],false),"user/change_password");nct.register(nct.r.multi([nct.r.write('<div class="row"><div class="span3 profile-menu"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="/user">User Profile</a></li><li><a href="/user/password">Change Password</a></li></ul></div><div class="span9"><form class="user-settings form-horizontal"><fieldset><div class="control-group '),nct.r.mgetout(["error","username"],[],[]),nct.r.write(' undefined"><label class="control-label" for="username">Username</label><div class="controls"><input class="span4" disabled="disabled" name="username" value="'),nct.r.getout("username",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","username"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","username_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","apiToken"],[],[]),nct.r.write(' undefined"><label class="control-label" for="apiToken">API Token</label><div class="controls"><input class="span4" disabled="disabled" name="apiToken" value="'),nct.r.getout("apiToken",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","apiToken"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","apiToken_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","email"],[],[]),nct.r.write(' undefined"><label class="control-label" for="email">Email</label><div class="controls"><input class="span4" disabled="disabled" name="email" value="'),nct.r.getout("email",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","email"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","email_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","name"],[],[]),nct.r.write(' undefined"><label class="control-label" for="name">Name</label><div class="controls"><input class="span4" name="name" value="'),nct.r.getout("name",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","name"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","name_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","city"],[],[]),nct.r.write(' undefined"><label class="control-label" for="city">City</label><div class="controls"><input class="span4" name="city" value="'),nct.r.getout("city",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","city"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","city_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","country"],[],[]),nct.r.write(' undefined"><label class="control-label" for="country">Country</label><div class="controls"><input class="span4" name="country" value="'),nct.r.getout("country",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","country"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","country_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","website"],[],[]),nct.r.write(' undefined"><label class="control-label" for="website">Website</label><div class="controls"><input class="span4" name="website" value="'),nct.r.getout("website",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","website"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","website_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","portfolio"],[],[]),nct.r.write(' undefined"><label class="control-label" for="portfolio">Portfolio URL</label><div class="controls"><input class="span4" name="portfolio" value="'),nct.r.getout("portfolio",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","portfolio"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","portfolio_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","gravatar"],[],[]),nct.r.write(' undefined"><label class="control-label" for="gravatar">Gravatar Email</label><div class="controls"><input class="span4" name="gravatar" value="'),nct.r.getout("gravatar",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","gravatar"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","gravatar_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary" type="submit">Confirm Change</button></div></fieldset></form></div></div>')],false),"user/profile");nct.register(nct.r.multi([nct.r.write('<div class="row"><div class="span9 offset3"><form class="user-settings form-horizontal" method="post"><fieldset><div class="control-group '),nct.r.mgetout(["error","name"],[],[]),nct.r.write(' undefined"><label class="control-label" for="name">Name</label><div class="controls"><input class="span4" name="name" value="'),nct.r.getout("name",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","name"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","name_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="control-group '),nct.r.mgetout(["error","email"],[],[]),nct.r.write(' undefined"><label class="control-label" for="email">Email</label><div class="controls"><input class="span4" name="email" value="'),nct.r.getout("email",[],[]),nct.r.write('"/>'),nct.r.doif(nct.r.mget(["error","email"],[],"if"),nct.r.multi([nct.r.write('<span class="help-inline">'),nct.r.mgetout(["error","email_message"],[],[]),nct.r.write("</span>")],false)),nct.r.write('</div></div><div class="form-actions"><button class="btn btn-primary" type="submit">Active me</button></div></fieldset></form></div></div>')],false),"user/set_referral");!function(){var fetchWithFail=function(user,next,errorMessage){this.fetch({success:function(){next()},error:function(model,xhr,options){var errModel=exo.models.Err.create(errorMessage,user,xhr.status);next(errModel)}})};highbrow.Model.prototype.fetchWithFail=fetchWithFail;highbrow.Collection.prototype.fetchWithFail=fetchWithFail;var root=highbrow.browser?window:global;root.log=function(message,notify){root.log.trigger("log","log",message,notify)};root.log.pre=function(message,notify){root.log.trigger("log","pre",message,notify)};root.log.info=function(message,notify){root.log.trigger("log","info",message,notify)};root.log.warning=function(error,message,notify){root.log.trigger("log","warning",error,message,notify)};root.log.error=function(error,message){var errorMessage=error&&error.message?error.message:error;if(typeof errorMessage==="object"){errorMessage=""}root.log.trigger("log","error",message?errorMessage+"\n"+message:errorMessage);if(error instanceof Error){root.log.pre(error.stack);console.error(message?message+": ":"",error.stack)}else{console.error(errorMessage,message?": "+message:"")}};root.log.command=function(cmd,notify){root.log.trigger("log","command",cmd,notify)};_.extend(root.log,highbrow.Backbone.Events);_.extend(exo,highbrow.Backbone.Events);highbrow.setViewModels(exo.ui.vm);_.each(exo.ui.views,function(view,name){view.namespace="editor"});_.each(exo.operators,function(operator){exo.sceneGraph.registry.addOperator(operator)});exo.reportError=function(err,prefix,message){log.error(err,message);if(err instanceof Error){setTimeout(function(){throw err},0)}};exo.persistEditor=function(editor){var saving=false;var saveEditor=function(){if(saving||!store)return;saving=true;setTimeout(function(){store.set("editor",editor.toJSON());saving=false},500)};editor.on("change",saveEditor);editor.viewports.on("change",saveEditor);editor.layout.on("change",saveEditor)};exo.loadEditor=function(scene){var editorJSON=store?store.get("editor"):null;if(editorJSON&&editorJSON.version!==exo.models.Editor.prototype.defaults.version){editorJSON=null}var editor=new exo.models.Editor(editorJSON||{});if(scene)editor.setScene(scene);return editor};exo.initStudio=function(conf){exo.clientOnly=true;exo.conf=conf||{applicationName:"Clara.io"};var user=new exo.models.User({name:"Jane Doe",username:"nobody",flags:["plugins"]});exo.api.pluginRegistry=new exo.api.PluginRegistry(user);var scene=exo.scene=new exo.sceneGraph.nodes.Scene({name:"Scene"});scene.initObjects();var model=exo.loadEditor(scene);model.bindHotkeys();var topNav=new exo.ui.views.TopNav({model:model,el:$("#topnav")});var statusbar=new exo.ui.views.Statusbar({el:$(".statusbar"),model:model});statusbar.render();exo.dropHandler=new exo.ui.views.DropHandler({el:$("body")});var editor=new exo.ui.views.Editor({model:model,el:$("#editor")});editor.render();editor.onShow();$("#editor").show();$("#app").hide();exo.persistEditor(model);exo.trigger("loaded");root.log("Clara.io initialized")};var defaultLayout=function(ctx,next){this.layout="default";next()};var loggedIn=function(ctx,next){if(!this.store.user)return this.show("/login",ctx.callback);next()};var delay=function(ctx,next){setTimeout(next,1e3)};var buildApp=function($,options){var app=new highbrow.Application({$el:$("body")},defaultLayout);app.store.on("set:user",function(user){if(!highbrow.browser)return;if(typeof Bugsnag!=="undefined"){Bugsnag.metaData={user:{username:user&&user.get("username"),email:user&&user.get("email")},app:{gitsha:options.gitsha}}}if(user){analytics.identify(user.get("username"),{email:user.get("email"),firstName:user.get("name")})}});if(options.notifications){app.store.set("notifications",new exo.models.Notifications(options.notifications))}exo.conf=options.conf;app.store.set("context",options.context||{});if(options.user){app.store.set("user",new exo.models.User(options.user));app.store.context.currentUser=app.store.user}if(highbrow.browser){app.store.set("webSocket",new exo.WebSocket({url:document.location.protocol+"//"+exo.conf.webSocketExternalHost+":"+exo.conf.webSocketExternalPort+exo.conf.webSocketPath,userCookie:options.userCookie}));app.store.context.webSocket=app.store.webSocket}exo.ui.home.route(app,$);exo.ui.user.route(app.mount("/user",loggedIn,function(ctx,next){ctx.user=this.store.user;next()}));exo.ui.plugins.route(app.mount("/plugins",loggedIn));exo.ui.scenes.route(app.mount("/scenes",loggedIn));exo.ui.admin.route(app.mount("/admin"));exo.ui.help.route(app.mount("/help",loggedIn));app.showView=function(ctx,view,cur,old){if(highbrow.browser){$(cur).show();$(old).hide()}if(cur==="#app"){app.display(view,cur)}else{view.render();if(highbrow.browser&&view.onShow)view.onShow()}ctx.shown=true;if(highbrow.browser)analytics.pageview(ctx.path)};app.on("show",function(ctx,view){if(ctx.shown||!view||!(view instanceof highbrow.ItemView))return;var cur=this.layout==="default"?"#app":"#editor";var old=this.layout==="default"?"#editor":"#app";app.showView(ctx,view,cur,old)});app.on("error",function(err,ctx,result){var model=err;if(!err instanceof exo.models.Err){exo.reportError(err);model=exo.models.Err.create(err)}if(model.status===401){window.location="/login?"+highbrow.querystring.stringify({redirect:ctx.path})}var errView=new exo.ui.home.Error({model:model});app.showView(ctx,errView,"#app","#editor");if(ctx.loadingView)ctx.loadingView.close();$("#loading").remove();model.renderedView=true});app.showNext=function(ctx,path){this.show(ctx.query("return_to")||ctx.showNext||path||"/")};if(highbrow.browser){window.onbeforeunload=function(e){if(exo.ui.scenes.isBusy(app.store.editor?app.store.editor.scene:null)){return"You have changes currently pending."}}}return app};exo.reportError=function(err,prefix,message){log.error(err,message);if(prefix){err.message=prefix+": "+err.message}if(highbrow.browser&&typeof Bugsnag!=="undefined"){Bugsnag.notifyException(err)}else{setTimeout(function(){throw err},0)}};exo.init=function(options){try{var app=exo.app=buildApp($,options);app.on("unhandled",function(ctx){window.location.href=ctx.path});app.start(function(err){exo.trigger("loaded")});return app}catch(err){if(highbrow.browser&&typeof Bugsnag!=="undefined")Bugsnag.notifyException(err);exo.trigger("loadError",err)}};exo.render=function($,route,options,callback){var app=buildApp($,options);var timeout=setTimeout(function(){callback(new Error("Page show timeout"))},2e3);app.on("unhandled",function(ctx){clearTimeout(timeout);callback(true)});var rendered=false;var cb=function(err,unused,ctx){if(rendered)return;rendered=true;clearTimeout(timeout);app.$el.attr("data-ssr","true");callback(err,ctx.root.currentRoute.path)};try{return app.show(route,cb)}catch(e){clearTimeout(timeout);return callback(e)}}}();!function(_){"use strict";var defaultOptions={forceUpdate:false,selector:"name*",labelFormatter:"sentenceCase",valid:Function.prototype,invalid:Function.prototype};var formatFunctions={formatLabel:function(attrName,model){return defaultLabelFormatters[defaultOptions.labelFormatter](attrName,model)},format:function(){var args=Array.prototype.slice.call(arguments),text=args.shift();return text.replace(/\{(\d+)\}/g,function(match,number){return typeof args[number]!=="undefined"?args[number]:match})}};var flatten=function(obj,into,prefix){into=into||{};prefix=prefix||"";_.each(obj,function(val,key){if(obj.hasOwnProperty(key)){if(val&&typeof val==="object"&&!(val instanceof Date||val instanceof RegExp)){flatten(val,into,prefix+key+".")}else{into[prefix+key]=val}}});return into};var Validation=function(){var getValidatedAttrs=function(model){return _.reduce(_.keys(model.validation||{}),function(memo,key){memo[key]=void 0;return memo},{})};var getValidators=function(model,attr){var attrValidationSet=model.validation?model.validation[attr]||{}:{};if(_.isFunction(attrValidationSet)||_.isString(attrValidationSet)){attrValidationSet={fn:attrValidationSet}}if(!_.isArray(attrValidationSet)){attrValidationSet=[attrValidationSet]}return _.reduce(attrValidationSet,function(memo,attrValidation){_.each(_.without(_.keys(attrValidation),"msg"),function(validator){memo.push({fn:defaultValidators[validator],val:attrValidation[validator],msg:attrValidation.msg})});return memo},[])};var validateAttr=function(model,attr,value,computed){return _.reduce(getValidators(model,attr),function(memo,validator){var ctx=_.extend({},formatFunctions,defaultValidators),result=validator.fn.call(ctx,value,attr,validator.val,model,computed);if(result===false||memo===false){return false}if(result&&!memo){return validator.msg||result}return memo},"")};var validateModel=function(model,attrs){var error,invalidAttrs={},isValid=true,computed=_.clone(attrs),flattened=flatten(attrs);_.each(flattened,function(val,attr){error=validateAttr(model,attr,val,computed);if(error){invalidAttrs[attr]=error;isValid=false}});return{invalidAttrs:invalidAttrs,isValid:isValid}};var mixin=function(view,options){return{preValidate:function(attr,value){return validateAttr(this,attr,value,_.extend({},this.attributes))},isValid:function(option){var flattened=flatten(this.attributes);if(_.isString(option)){return!validateAttr(this,option,flattened[option],_.extend({},this.attributes))}if(_.isArray(option)){return _.reduce(option,function(memo,attr){return memo&&!validateAttr(this,attr,flattened[attr],_.extend({},this.attributes))},true,this)}if(option===true){this.validate()}return this.validation?this._isValid:true},validate:function(attrs,setOptions){var model=this,validateAll=!attrs,opt=_.extend({},options,setOptions),validatedAttrs=getValidatedAttrs(model),allAttrs=_.extend({},validatedAttrs,model.attributes,attrs),changedAttrs=flatten(attrs||allAttrs),result=validateModel(model,allAttrs);model._isValid=result.isValid;_.each(validatedAttrs,function(val,attr){var invalid=result.invalidAttrs.hasOwnProperty(attr);if(!invalid){opt.valid(view,attr,opt.selector)}});_.each(validatedAttrs,function(val,attr){var invalid=result.invalidAttrs.hasOwnProperty(attr),changed=changedAttrs.hasOwnProperty(attr);if(invalid&&(changed||validateAll)){opt.invalid(view,attr,result.invalidAttrs[attr],opt.selector)}});_.defer(function(){model.trigger("validated",model._isValid,model,result.invalidAttrs);model.trigger("validated:"+(model._isValid?"valid":"invalid"),model,result.invalidAttrs)});if(!opt.forceUpdate&&_.intersection(_.keys(result.invalidAttrs),_.keys(changedAttrs)).length>0){return result.invalidAttrs}}}};var bindModel=function(view,model,options){_.extend(model,mixin(view,options))};var unbindModel=function(model){delete model.validate;delete model.preValidate;delete model.isValid};var collectionAdd=function(model){bindModel(this.view,model,this.options)};var collectionRemove=function(model){unbindModel(model)};return{version:"0.7.1",configure:function(options){_.extend(defaultOptions,options)},bind:function(view,options){var model=view.model,collection=view.collection;options=_.extend({},defaultOptions,defaultCallbacks,options);if(typeof model==="undefined"&&typeof collection==="undefined"){throw"Before you execute the binding your view must have a model or a collection.\n"+"See http://thedersen.com/projects/backbone-validation/#using-form-model-validation for more information."}if(model){bindModel(view,model,options)}else if(collection){collection.each(function(model){bindModel(view,model,options)});collection.bind("add",collectionAdd,{view:view,options:options});collection.bind("remove",collectionRemove)}},unbind:function(view){var model=view.model,collection=view.collection;if(model){unbindModel(view.model)}if(collection){collection.each(function(model){unbindModel(model)});collection.unbind("add",collectionAdd);collection.unbind("remove",collectionRemove)}},mixin:mixin(null,defaultOptions)}}();var defaultCallbacks=Validation.callbacks={valid:function(view,attr,selector){view.$("["+selector+'~="'+attr+'"]').removeClass("invalid").removeAttr("data-error")},invalid:function(view,attr,error,selector){view.$("["+selector+'~="'+attr+'"]').addClass("invalid").attr("data-error",error)}};var defaultPatterns=Validation.patterns={digits:/^\d+$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,url:/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i};var defaultMessages=Validation.messages={required:"{0} is required",acceptance:"{0} must be accepted",min:"{0} must be greater than or equal to {1}",max:"{0} must be less than or equal to {1}",range:"{0} must be between {1} and {2}",length:"{0} must be {1} characters",minLength:"{0} must be at least {1} characters",maxLength:"{0} must be at most {1} characters",rangeLength:"{0} must be between {1} and {2} characters",oneOf:"{0} must be one of: {1}",equalTo:"{0} must be the same as {1}",pattern:"{0} must be a valid {1}"};var defaultLabelFormatters=Validation.labelFormatters={none:function(attrName){return attrName},sentenceCase:function(attrName){return attrName.replace(/(?:^\w|[A-Z]|\b\w)/g,function(match,index){return index===0?match.toUpperCase():" "+match.toLowerCase()}).replace("_"," ")},label:function(attrName,model){return model.labels&&model.labels[attrName]||defaultLabelFormatters.sentenceCase(attrName,model)}};var defaultValidators=Validation.validators=function(){var trim=String.prototype.trim?function(text){return text===null?"":String.prototype.trim.call(text)}:function(text){var trimLeft=/^\s+/,trimRight=/\s+$/;return text===null?"":text.toString().replace(trimLeft,"").replace(trimRight,"")};var isNumber=function(value){return _.isNumber(value)||_.isString(value)&&value.match(defaultPatterns.number)};var hasValue=function(value){return!(_.isNull(value)||_.isUndefined(value)||_.isString(value)&&trim(value)==="")};return{fn:function(value,attr,fn,model,computed){if(_.isString(fn)){fn=model[fn]}return fn.call(model,value,attr,computed)},required:function(value,attr,required,model,computed){var isRequired=_.isFunction(required)?required.call(model,value,attr,computed):required;if(!isRequired&&!hasValue(value)){return false}if(isRequired&&!hasValue(value)){return this.format(defaultMessages.required,this.formatLabel(attr,model))}},acceptance:function(value,attr,accept,model){if(value!=="true"&&(!_.isBoolean(value)||value===false)){return this.format(defaultMessages.acceptance,this.formatLabel(attr,model))}},min:function(value,attr,minValue,model){if(!isNumber(value)||value<minValue){return this.format(defaultMessages.min,this.formatLabel(attr,model),minValue)}},max:function(value,attr,maxValue,model){if(!isNumber(value)||value>maxValue){return this.format(defaultMessages.max,this.formatLabel(attr,model),maxValue)}},range:function(value,attr,range,model){if(!isNumber(value)||value<range[0]||value>range[1]){return this.format(defaultMessages.range,this.formatLabel(attr,model),range[0],range[1])}},length:function(value,attr,length,model){if(!hasValue(value)||trim(value).length!==length){return this.format(defaultMessages.length,this.formatLabel(attr,model),length)}},minLength:function(value,attr,minLength,model){if(!hasValue(value)||trim(value).length<minLength){return this.format(defaultMessages.minLength,this.formatLabel(attr,model),minLength)}},maxLength:function(value,attr,maxLength,model){if(!hasValue(value)||trim(value).length>maxLength){return this.format(defaultMessages.maxLength,this.formatLabel(attr,model),maxLength)}},rangeLength:function(value,attr,range,model){if(!hasValue(value)||trim(value).length<range[0]||trim(value).length>range[1]){return this.format(defaultMessages.rangeLength,this.formatLabel(attr,model),range[0],range[1])}},oneOf:function(value,attr,values,model){if(!_.include(values,value)){return this.format(defaultMessages.oneOf,this.formatLabel(attr,model),values.join(", "))}},equalTo:function(value,attr,equalTo,model,computed){if(value!==computed[equalTo]){return this.format(defaultMessages.equalTo,this.formatLabel(attr,model),this.formatLabel(equalTo,model))}},pattern:function(value,attr,pattern,model){if(!hasValue(value)||!value.toString().match(defaultPatterns[pattern]||pattern)){return this.format(defaultMessages.pattern,this.formatLabel(attr,model),pattern)}}}}();return Validation}(_);exo.api.definePlugin("animation",{version:"0.0.1",label:"Animation"},function(app){app.defineCommand({name:"createBone",execute:function(app,options){var scene=app.scene.objectsRootNode;var model=app.editor;var selectedBone;if(model.selected.length){selectedBone=model.selected.last()}if(selectedBone){if(!selectedBone.Bone||!selectedBone.Bone.activeOperator){return}var boneStart=selectedBone.Bone.activeOperator.get("boneStart");var boneLength=selectedBone.Bone.activeOperator.get("boneLength");var pWidth=selectedBone.Bone.activeOperator.get("width");var pHeight=selectedBone.Bone.activeOperator.get("height");var boneLength=selectedBone.Bone.activeOperator.get("boneLength");var boneShape=selectedBone.Bone.activeOperator.get("shapeType");var capSizeStart=selectedBone.Bone.activeOperator.get("capSizeStart");var capSizeEnd=selectedBone.Bone.activeOperator.get("capSizeEnd");var falloff=selectedBone.Bone.activeOperator.get("falloff");
var boneDirectionPos=selectedBone.Bone.activeOperator.get("boneDirection").clone();boneDirectionPos.multiplyScalar(boneLength);var childOptions={width:pWidth,height:pHeight,shapeType:boneShape,boneLength:boneLength,capSizeStart:capSizeStart,capSizeEnd:capSizeEnd,falloff:falloff};var boneNode=exo.geometry.BoneUtils.insertBone(selectedBone,scene,childOptions);boneNode.Transform.ctx().set("translation",boneDirectionPos)}else{exo.geometry.BoneUtils.insertBone(selectedBone,scene,{})}}});app.defineCommand({name:"createSkeleton",execute:function(app,options){var scene=app.scene.objectsRootNode;exo.geometry.BoneUtils.createHumanSkeleton(scene)}})});exo.api.definePlugin("creators",{version:"0.0.1",label:"Creators"},function(registrar){var keys={};var creators=_.map(exo.sceneGraph.registry.operators(null),function(op){var key=_.find(op.name.split(""),function(letter){if(keys[letter.toLowerCase()]){return false}else{keys[letter.toLowerCase()]=op;return true}});return{name:op.name,primitive:op.target,key:key&&key.toLowerCase()}});var createUniqueName=function(ctx,originalName){var num=0;var name=originalName;while(ctx(name).length>0){name=originalName+ ++num}return name};var creatorCategories={PolyMesh:"Polygons",Bone:"Bones",Light:"Lights",Camera:"Rendering",Renderer:"Rendering",Null:"General"};var hiddenCreators={Mesh:true,Bone:true};var ignoredPrimitives={Transform:true,Properties:true,Texture:true,Material:true,Timeline:true,Environment:true,GeneralRenderer:true,Pass:true};_.each(creators,function(creator){if(creator.name.indexOf("/")!==-1)return;if(creator.primitive&&!ignoredPrimitives[creator.primitive]){var commandDef={name:"create"+_.str.camelize(creator.name),shortcut:"c "+creator.key,creator:creator,execute:function(ctx,options){var name=createUniqueName(ctx,this.creator.name);var editor=ctx.editor;var plugs={};plugs[this.creator.primitive]=this.creator.name;var nodeJSON=new exo.sceneGraph.nodes[this.creator.primitive]({name:name,type:this.creator.primitive},plugs).toJSON();var node=ctx("%Objects").first().createNode(nodeJSON);if(node.isCamera()){editor.viewports.each(function(viewport,index){viewport.trigger("change")},this.creator)}editor.clearSelection();editor.select(node);ctx("%Objects").addNode(node)}};if(!hiddenCreators[creator.name]){commandDef.uiPlace={toolbar:creatorCategories[creator.primitive]||creator.primitive};commandDef.uiState={label:creator.name,icon:creator.name}}registrar.defineCommand(commandDef)}})});exo.api.definePlugin("default",{version:"0.0.1",label:"Default"},function(app){});!function(){exo.api.definePlugin("edit",{version:"0.0.1",label:"Editing"},function(app){app.defineCommand({name:"clone",uiPlace:{menu:["Edit"],viewportsContext:true,sceneExplorer:true},uiState:{label:"Clone"},uiUpdate:function(ctx,state){state.set("visible",anyNodeRemovable(ctx))},execute:function(ctx,options){if(!ctx.editor.selected.length&&ctx.editor.modelSelection&&ctx.editor.modelSelection.removable){var node=ctx.editor.modelSelection;ctx.editor.clearSelection();ctx(node.parentNode()).addNode(node.cloneJSON()).then(function(node){ctx.editor.select(node)})}else{var selectedById=_.clone(ctx.editor.selected._byId);ctx(":selection").filter(function(node){return!ancestorsSelected(selectedById,node)}).start().each(function(node){if(node.removable){ctx(node.parentNode()).addNode(node.cloneJSON())}}).end()}}});app.defineCommand({name:"deleteNode",uiPlace:{menu:["Edit"],sceneExplorer:true},uiState:{label:"Delete"},uiUpdate:function(ctx,state){state.set("visible",anyNodeRemovable(ctx))},execute:function(ctx,options){if(!anyNodeRemovable(ctx))return;var onRemoved=function(){ctx.editor.selected.clear()};ctx(":selection").remove().then(onRemoved)}});var anyNodeRemovable=function(ctx){if(ctx.node&&!(ctx.node instanceof exo.sceneGraph.Node))return false;var removable=false;if(!ctx.editor.selected.length&&ctx.editor.modelSelection){removable=ctx.editor.modelSelection.removable}else{ctx.editor.selected.each(function(node){if(node.removable)removable=true})}return removable};app.defineCommand({name:"delete",uiPlace:{menu:["Edit"],viewportsContext:true},uiState:{label:"Delete"},shortcut:["del","backspace"],execute:function(ctx,options){var node=ctx.editor.subSelection.node();var type=ctx.editor.subSelection.get("type");var onRemoved=function(){if(type!=="Object"){ctx.editor.subSelection.clear()}else{ctx.editor.selected.clear()}};if(type==="Vertex"||type==="Edge"){ctx(node.PolyMesh).addOperator("DeleteComponent",{componentType:type,indices:exo.geometry.GeometryUtils.arrayIndicesToString(ctx.editor.subSelection.getVertices())});onRemoved()}else if(type==="Face"){ctx(node.PolyMesh).addOperator("DeleteComponent",{componentType:type,indices:exo.geometry.GeometryUtils.arrayIndicesToString(ctx.editor.subSelection.get("indices"))});onRemoved()}else{ctx(":selection").remove().then(onRemoved)}}});app.defineCommand({name:"createMaterialFromTexture",uiPlace:{sceneExplorer:true},uiState:{label:"Create Material"},uiUpdate:function(context,state){state.set("visible",context.node instanceof exo.sceneGraph.File&&context.node.isImage())},execute:function(ctx,options){if(ctx.node){ctx(ctx.scene.defaultMaterialLibrary).addNode(ctx.node.getName(),"Material",{Material:{Standard:{diffuseMap:ctx.node}}})}}});app.defineCommand({name:"createMeshFromGeometry",uiPlace:{sceneExplorer:true},uiState:{label:"Create PolyMesh"},uiUpdate:function(context,state){state.set("visible",context.node instanceof exo.sceneGraph.File&&context.node.isGeometry())},execute:function(ctx,options){if(ctx.node){ctx(ctx.scene.objectsRootNode).addNode(ctx.node.getName(),"PolyMesh",{PolyMesh:{Mesh:{geometry:ctx.node}}})}}});app.defineCommand({name:"importTexture",uiPlace:{sceneExplorer:true},uiState:{label:"Import Texture"},uiUpdate:function(context,state){state.set("visible",context.node&&context.node.get("type")==="Textures")},execute:function(ctx,options){exo.ui.FileUtils.launchFileDialog(true,function(files){exo.ui.FileUtils.importImages(files,ctx.scene)},"image/*")}});app.defineCommand({name:"undo",uiPlace:{menu:["Edit"]},uiState:{label:"Undo"},shortcut:"ctrl+z",execute:function(ctx,options){ctx.undo()}});app.defineCommand({name:"redo",uiPlace:{menu:["Edit"]},uiState:{label:"Redo"},shortcut:"shift+ctrl+z",execute:function(ctx,options){ctx.redo()}});app.defineCommand({name:"merge",uiPlace:{sceneExplorer:true,menu:["Edit"],viewportsContext:true},uiState:{label:"Merge"},uiUpdate:function(context,state){state.set("visible",context.node&&context.node.get("type")==="PolyMesh"||context.editor.selected.length>1&&context.editor.selected.every(function(o){return o.get("type")==="PolyMesh"}))},execute:function(ctx,options){exo.geometry.PolyMeshUtilities.mergeSelectedPolyMeshNodes(ctx.editor,"Merged_Meshes")}})});var ancestorsSelected=function(selectedById,node){var parent=node.parentNode();return parent?selectedById[parent.id]||ancestorsSelected(selectedById,parent):false}}();exo.api.definePlugin("exporters",{version:"0.0.1",label:"Exporters"},function(app){if(highbrow.server){var fs=require("fs");var path=require("path")}app.defineCommand({name:"saveClientFile",execute:function(app,options){exo.ui.FileUtils.saveFile(options.get("content"),options.get("name"))}});app.defineCommand({name:"export",execute:function(app,options){return exo.resources.exportFile(app.scene,options.get("extension"),{},app)}});app.defineCommand({name:"exportCollada",uiPlace:{menu:["Export"]},uiState:{label:"Collada"},execute:function(app,options){app.exec("exporters","export",{extension:"dae"}).then(function(content){app.exec("exporters","saveClientFile",{content:content,name:app.scene.get("name")+".dae"})})}});app.defineCommand({name:"exportOBJ",uiPlace:{menu:["Export"]},uiState:{label:"OBJ"},execute:function(app,options){app.exec("exporters","export",{extension:"obj"}).then(function(content){app.exec("exporters","saveClientFile",{content:content,name:app.scene.get("name")+".obj"})})}});app.defineCommand({name:"exportSTL",uiPlace:{menu:["Export"]},uiState:{label:"STL"},execute:function(app,options){app.exec("exporters","export",{extension:"stl"}).then(function(content){app.exec("exporters","saveClientFile",{content:content,name:app.scene.get("name")+".stl"})})}});app.defineCommand({name:"exportThreeSON",uiPlace:{menu:["Export"]},uiState:{label:"ThreeJS"},execute:function(app,options){app.exec("exporters","export",{extension:"json"}).then(function(content){app.exec("exporters","saveClientFile",{content:content,name:app.scene.get("name")+".json"})})}});app.defineCommand({name:"exportjsfbx",uiPlace:{menu:["Export"]},uiState:{label:"jsFBX"},execute:function(app,options){app.exec("exporters","export",{extension:"jsfbx"}).then(function(content){app.exec("exporters","saveClientFile",{content:content,name:app.scene.get("name")+".jsfbx"})})}});app.defineCommand({name:"exportFBX_Server",uiPlace:{menu:["Export"]},uiState:{label:"FBX"},notificationMessage:function(app,options){return"Exporting to FBX"},returns:"File",executeServer:function(ctx,options){var scriptDir=path.join(__dirname,"lib/app/geometry/utilities/fbx_converter_export.py");var fileString=exo.resources.exporters.jsfbx.exportFile(ctx.scene);var fileName=ctx.scene.get("name")+".ojsfbx";var fileOutN=ctx.scene.get("name")+".fbx";var deferred=Q.defer();deferred.notify(20);ctx.resultsDir(function(err,resultsDir){if(err)throw err;fs.writeFile(path.join(resultsDir,fileName),fileString,function(err){if(err)throw err;Q.all(ctx.scene.files.map(function(file){if(!file.isImage())return true;var fileDeferred=Q.defer();ctx.fetchAsset(file,function(err,path){if(err)return fileDeferred.reject(err);fileDeferred.resolve()});return fileDeferred.promise})).fail(function(err){return deferred.reject(err)}).then(function(){deferred.notify(40);fs.open(path.join(resultsDir,"jsfbx.stdout.txt"),"w",function(err,stdout){if(err)return deferred.reject(err);fs.open(path.join(resultsDir,"jsfbx.stderr.txt"),"w",function(err,stderr){if(err)return deferred.reject(err);var args=[scriptDir,fileName,fileOutN,"--embed-media"];if(options.optionString!==undefined){args.push(options.optionString)}var cp=require("child_process").spawn("python3.1",args,{cwd:resultsDir,stdio:[null,stdout,stderr]});cp.on("exit",function(code){deferred.notify(80);if(code===0){fs.readFile(path.join(resultsDir,fileOutN),function(err,buffer){if(err)return deferred.reject(err);var content="data:application/octet-stream;base64"+buffer.toString("base64");ctx.addFile({name:fileOutN,type:"application/octet-stream",sourceType:"export",content:content}).then(function(file){deferred.resolve(file)}).fail(function(err){deferred.reject(err)})})}else{Q.all([ctx.exec("exporters","saveResult",{name:"jsfbx.stderr.txt",type:"text/plain"}),ctx.exec("exporters","saveResult",{name:"jsfbx.stdout.txt",type:"text/plain"})]).then(function(fs){files=files.concat(fs);deferred.reject(files)})}})})})})})});return deferred.promise}})});exo.api.definePlugin("file",{version:"0.0.1",label:"File"},function(app){app.defineCommand({name:"createNewScene",uiPlace:{menu:["File"]},uiState:{label:"New..."},execute:function(ctx,options){exo.ui.scenes.Create.attach()}});app.defineCommand({name:"openSceneList",uiPlace:{menu:["File"]},uiState:{label:"Open..."},shortcut:"ctrl+o",link:"/scenes",linkTarget:"_blank"});app.defineCommand({name:"renameScene",uiPlace:{menu:["File"]},uiState:{label:"Rename..."},execute:function(ctx,options){exo.ui.views.SceneRename.attach(ctx)}});app.defineCommand({name:"cloneScene",uiPlace:{menu:["File"]},uiState:{label:"Clone"},execute:function(ctx,options){$.post(ctx.scene.url()+"/clone",function(data){exo.app.show("/editor/"+data._id)}).fail(function(err){exo.reportError(err,"Error cloning scene","Error cloning scene")})}});app.defineCommand({name:"shareScene",uiPlace:{menu:["File"]},uiState:{label:"Share..."},execute:function(ctx,options){exo.ui.scenes.Share.attach("",ctx.scene)}})});exo.api.definePlugin("importers",{version:"0.0.1",label:"Importers"},function(registrar){if(highbrow.server){var fs=require("fs");var path=require("path")}registrar.defineCommand({name:"importPrompt",uiPlace:{menu:true},uiState:{label:"Import"},execute:function(ctx,options){var deferred=Q.defer();var importers="";_.each(exo.resources.importers,function(importer,name){importers+=", ."+name});exo.ui.views.FileDialog.prompt({accept:"image/*, .fbx"+importers},function(files){ctx.exec("importers","importFiles",{files:files}).then(function(result){deferred.resolve(result)}).fail(function(err){deferred.reject(err)})});return deferred.promise}});registrar.defineCommand({name:"doImport",execute:function(ctx,options){var deferred=Q.defer();var files=_.map(options.get("files"),function(f){return exo.sceneGraph.File.create(f,{context:ctx.scene.context})});var numFinished=0;var numImporting=0;var numFiles=files.length;var closeLoading=function(succeeded){return function(err){deferred.notify(100);if(succeeded)deferred.resolve(true);else deferred.reject(err||false)}};var importFiles=function(files){var promises=_.map(files,function(file){var extension=file.extname().replace(/\./,"").toLowerCase();var fileType=file.getFileType();if(ctx.hasCommand("importers",extension)){return ctx.exec("importers",extension,{file:file,notify:!file.isImage()})}else if(ctx.hasCommand("importers",fileType)){return ctx.exec("importers",fileType,{file:file,notify:!file.isImage()})}else{log.warning("cannot find importer for "+extension+" or "+fileType)}});return Q.all(promises)};var sorted=exo.resources.organizeResources(files);_.reduce(sorted,function(promise,resources){return Q.when(promise,function(){numFinished+=numImporting;deferred.notify(numFinished/numFiles*100);numImporting=resources.length;return importFiles(resources)})},1).then(function(){numFinished+=numImporting;deferred.notify(numFinished/numFiles*100);return closeLoading(true)()}).fail(closeLoading(false));return deferred.promise}});registrar.defineCommand({name:"importFiles",notificationMessage:function(app,options){var numFiles=options.get("files").length;return"Importing "+numFiles+(numFiles===1?" file.":" files.")},execute:function(ctx,options){var deferred=Q.defer();ctx.addFiles(options.get("files")).then(function(files){files=_.isArray(files)?files:[files];ctx.exec("importers","importFilesOnServer",{files:files}).then(function(){deferred.resolve()}).fail(function(err){deferred.reject(err)})}).fail(function(err){deferred.reject(err)});return deferred.promise}});registrar.defineCommand({name:"importFilesOnServer",notificationMessage:function(app,options){return"Importing Files on the Server"},executeServer:function(ctx,options){var deferred=Q.defer();ctx.exec("importers","doImport",{files:options.get("files")}).then(function(r){ctx.exec("importers","waitForSyncComplete").then(function(){deferred.resolve(r)}).fail(function(err){deferred.reject(err)})}).fail(function(err){deferred.reject(err)});return deferred.promise}});registrar.defineCommand({name:"fbx",notificationMessage:function(app,options){return"Importing FBX"},executeServer:function(ctx,options,attrs,change){var mime=require("mime");mime.define({"application/json":["jsfbx"]});var deferred=Q.defer();var scriptDir=path.join(__dirname,"lib/app/geometry/utilities/fbx_converter_import.py");var file;if(!options.get("file").get){file=new exo.sceneGraph.File(options.get("file"))}else{file=options.get("file")}var inFile=file.get("name");var basename=path.basename(inFile,path.extname(inFile));var outFile=basename+".jsfbx";var fbmDir=basename+".fbm";var args=[scriptDir,file.get("name"),outFile];ctx.fetchAsset(file,function(err,filePath){if(err)throw err;var resultsDir=path.dirname(filePath);fs.open(path.join(resultsDir,"ijsfbx.stdout.txt"),"w",function(err,stdout){if(err)return deferred.reject(err);fs.open(path.join(resultsDir,"ijsfbx.stderr.txt"),"w",function(err,stderr){var cp=require("child_process").spawn("python3.1",args,{cwd:resultsDir,stdio:[null,stdout,stderr]});cp.on("exit",function(code){if(code!==0){Q.all([ctx.exec("exporters","saveResult",{name:"ijsfbx.stderr.txt",type:"text/plain"}),ctx.exec("exporters","saveResult",{name:"ijsfbx.stdout.txt",type:"text/plain"})]).then(function(files){deferred.reject({files:files})});return}fs.readdir(path.join(resultsDir,fbmDir),function(err,files){var filenames;if(err){filenames=[outFile]}else{filenames=_.map(files,function(f){return path.join(fbmDir,f)});filenames.push(outFile)}Q.all(_.map(filenames,function(filename){var deferred=Q.defer();fs.readFile(path.join(resultsDir,filename),function(err,buffer){if(err)return deferred.reject(err);var type=mime.lookup(filename);var charset=mime.charsets.lookup(type);var content;if(charset==="UTF-8"||type==="application/json"){content=buffer.toString("utf8")}else{content="data:"+type+";base64"+buffer.toString("base64")}deferred.resolve({name:path.basename(filename),type:type,sourceType:"import",content:content})});return deferred.promise})).then(function(files){deferred.resolve(ctx.exec("importers","doImport",{files:files}))}).fail(function(r){deferred.reject(r)})})})})})});return deferred.promise}});registrar.defineCommand({name:"waitForSyncComplete",executeServer:function(app,options){var deferred=Q.defer();if(app.scene.changeQueue.isBusy()){app.scene.changeQueue.once("empty",function(){deferred.resolve(true)})}else{deferred.resolve(true)}return deferred.promise}});_.each(exo.resources.importers,function(importer,extension){if(importer.importFile){registrar.defineCommand({name:extension,notificationMessage:function(app,options){return getFileDescription(app,options)},execute:function(ctx,options){var deferred=Q.defer();importer.importFile.call(importer,options.get("file"),ctx,deferred,deferred.makeNodeResolver());return deferred.promise}})}});var getFileDescription=function(app,options){var file=options.get("file");var size=(file.get("size")/1024).toFixed(1);var sizeText=size?" ("+size+"KB)":"";return"File: "+file.get("name")+sizeText}});exo.api.definePlugin("manipulators",{version:"0.0.1",label:"Manipulators"},function(registrar){var manipulatorTypes={Select:{shortcut:"q"},Move:{shortcut:"w"},Rotate:{shortcut:"e"},Scale:{shortcut:"r"}};_.each(manipulatorTypes,function(manipulatorType,manipulatorName){registrar.defineCommand({name:"activate"+manipulatorName+"Manipulator",uiPlace:{manipulatorToolbar:true},uiState:{label:manipulatorName,icon:manipulatorName},shortcut:manipulatorType.shortcut,execute:function(ctx,options){ctx().editor.set("activeManipulator",manipulatorName)}})});var subObjectTypes={Object:{shortcut:"t"},Face:{shortcut:"y"},Edge:{shortcut:"u"},Vertex:{shortcut:"i"}};_.each(subObjectTypes,function(subObjectType,subObjectName){registrar.defineCommand({name:"activate"+subObjectName+"SubObject",uiPlace:{subObjectToolbar:true},uiState:{label:subObjectName,icon:subObjectName},shortcut:subObjectType.shortcut,execute:function(ctx,options){ctx().editor.subSelection.set("type",subObjectName)},uiUpdate:subObjectName==="Object"?undefined:function(context,state){var node=context.editor.subSelection.node();var subSelectable=node?node.subSelectable:null;var selectionLength=context.editor.selected.length;state.set("enabled",selectionLength===1&&subSelectable&&subSelectable[subObjectName])}})})});!function(){exo.api.definePlugin("material",{version:"0.0.1",label:"Materials"},function(app){var addMaterialCommand=function(materialNode,libraryName){var materialName=materialNode.get("name");var menu=["Materials",_.str.humanize(libraryName)];if(materialNode.Material.isCubeMap()){menu.push("Cube Maps")}app.defineCommand({name:"library"+_.str.camelize(libraryName)+_.str.camelize(materialName),uiPlace:{menu:menu},uiState:{label:_.str.humanize(materialName)},cloneJSON:function(node){var json=node.cloneJSON();json.name=node.get("name");delete json.sceneId;delete json._id;delete json.__v;return json},cloneFile:function(file){var json=file.toJSON();delete json.sceneId;delete json._id;delete json.__v;return json},cloneNode:function(node,ctx,onAdded){var filesToAdd=[];var material=node.material.getMaterialProperties();var cmd=this;var nodeFound=ctx.scene.defaultMaterialLibrary.find(function(n){return n.get("name")===node.get("name")});if(nodeFound){return onAdded(nodeFound)}var addReference=function(val,key,callback){if(val instanceof Array){var arrayKey=key==="maps"?"map":"";var idx=0;var references={};_.each(val,function(v,index){addReference(v,arrayKey+index,function(added){if(added)_.extend(references,added);if(++idx===_.size(val)){callback(references)}})})}else if(val instanceof exo.sceneGraph.File){ctx.addFile(cmd.cloneFile(val)).then(function(fileAdded){var added={};added[key]=fileAdded;callback(added)})}else if(val instanceof exo.sceneGraph.nodes.Material){cmd.cloneNode(val,ctx,function(nodeAdded){var added={};added[key]=nodeAdded;callback(added)})}else{callback()}};var count=0;var numReferences=_.size(material);var references={};_.each(material,function(val,key){addReference(val,key,function(added){if(added)_.extend(references,added);if(++count===numReferences){ctx("%MaterialLibrary").addNode(cmd.cloneJSON(node)).then(function(node){_.each(references,function(nodeAdded,key){ctx(node).find("#Material["+key+"]").set(key,nodeAdded.id)});onAdded(node)})}})})},execute:function(ctx,options){var selected=ctx.editor.selected.toArray();this.cloneNode(materialNode,ctx,function(clonedMaterial){if(clonedMaterial.Material.isCubeMap()){ctx("%Scene").find("#Environment[cubeMap]").set({cubeMap:clonedMaterial.id})}else{_.each(selected,function(node){if(node.plugs.Material&&node.isMesh()){ctx(node).find("#Material[reference]").set({reference:clonedMaterial.id})}})}})}})};exo.sceneGraph.Scenes.fetchByType("materialLibrary",function(libraries){libraries.each(function(scene){var libraryName=scene.get("name");scene.fetch({success:function(scene){scene.initMaterials();var cubeMaps=scene.defaultMaterialLibrary.nodes.filter(function(node){return node.Material.isCubeMap()});var materials=scene.defaultMaterialLibrary.nodes.filter(function(node){return!node.Material.isCubeMap()});_.each(materials,function(materialNode){addMaterialCommand(materialNode,libraryName)});_.each(cubeMaps,function(materialNode){addMaterialCommand(materialNode,libraryName)})}})})})})}();exo.api.definePlugin("renderers",{version:"0.0.1",label:"Renderers",userFlag:"render"},function(app){var extractGeneralSettings=function(app){var scene=app.scene;if(scene.getNode("Renderers").nodes.length===0){throw new Error("No renderer defined. Need at least one.")}var passes=scene.getNode("Passes");if(passes.nodes.length===0){throw new Error("No pass defined. Need at least one.")}return passes.GeneralRenderer._result};var validatePass=function(pass){var pass_res=pass._result;if(pass_res.render_cam===undefined){throw new Error(["No camera assigned to pass ",pass.get("name"),", pass ignored!"].join(""))}var red=pass_res.render_red;if(red===undefined||red===null){throw new Error(["No renderer assigned to pass ",pass.get("name"),", pass ignored!"].join(""))}if(red.Renderer._result===undefined){throw new Error(["Renderer ",red.get("name")," has no creator operator assigned to it!"].join(""))}if(red.Renderer._result.exportScene===undefined){throw new Error(["Renderer ",red.get("name")," has no exportScene function!"].join(""))}return true};var renderSinglePass=function(app,pass,generalSettings,ignoreActivatedFlag){var passPass=pass.Pass;var pass_res=passPass._result;if(ignoreActivatedFlag===undefined&&!pass_res.activated)return true;validatePass(passPass);var this_scene_prop=_.clone(generalSettings);if(pass_res.over_res){this_scene_prop.res_w=pass_res.over_res_x;this_scene_prop.res_h=pass_res.over_res_y}this_scene_prop.sceneName=app.scene.get("name");return pass_res.render_red.Renderer._result.exportScene(app,this_scene_prop,pass)};var currentPass=function(app,options){app.scene.setTime(options.get("currentTime"));var general=extractGeneralSettings(app);if(!general)return false;if(!general.curPass){throw new Error("No current pass selected!")}return renderSinglePass(app,general.curPass,general,true)};var allPasses=function(app,options){app.scene.setTime(options.get("currentTime"));var general=extractGeneralSettings(app);var passes=app.scene.getNode("Passes");var deferred=Q.defer();Q.all(passes.nodes.map(function(model){return renderSinglePass(app,model,general)})).then(function(files){deferred.resolve(_.flatten(files))});return deferred.promise};app.defineCommand({name:"currentPass",returns:"Files",uiPlace:{menu:["Render"]},uiState:{label:"Current Pass"},execute:function(app,options){app.exec("renderers","currentPassServer",{currentTime:app.scene.time})}});app.defineCommand({name:"currentPassServer",returns:"Files",executeServer:function(app,options){return currentPass(app,options)}});app.defineCommand({name:"allPasses",returns:"Files",uiPlace:{menu:["Render"]},uiState:{label:"All Passes"},execute:function(app,options){app.exec("renderers","allPassesServer",{currentTime:app.scene.time})}});app.defineCommand({name:"allPassesServer",returns:"Files",executeServer:function(app,options){return allPasses(app,options)}})});!function(){exo.api.definePlugin("selection",{label:"0.0.1",label:"Selections"},function(app){app.defineCommand({name:"selectAll",uiPlace:{menu:["Edit"],selection:true},uiState:{label:"Select All"},shortcut:"ctrl+a",execute:function(app,options){var selected=app.editor.selected.toArray();var nodeList=[];_.each(app.scene.objectsRootNode.nodes,getNodesRecursive,this);if(app.editor.subSelection.get("type")==="Object"){app.editor.selected.clear();app.editor.selected.add(getAllNodes(app.scene.objectsRootNode))}else{app.editor.subSelection.addAll()}}});app.defineCommand({name:"clearSelection",uiPlace:{menu:["Edit"],selection:true},uiState:{label:"Select None"},execute:function(app,options){if(app.editor.subSelection.get("type")==="Object"){app.editor.selected.clear()}else{app.editor.subSelection.clear()}}});app.defineCommand({name:"selectInvert",uiPlace:{menu:["Edit"],selection:true},uiState:{label:"Select Invert"},execute:function(app,options){var subSelection=app.editor.subSelection;var subSelectionType=subSelection.get("type");if(subSelectionType==="Object"){app.editor.selectionInvert()}else{var unselectedIndices=subSelection.getUnselectedIndices();subSelection.clear();subSelection.set("indices",unselectedIndices)}}})});var getAllNodes=function(root){var nodeList=[];if(root.nodes.length){root.nodes.each(getNodesRecursive(nodeList),this)}return nodeList};var getNodesRecursive=function(nodeList){return function(node){nodeList.push(node);if(node.nodes.length){node.nodes.each(getNodesRecursive(nodeList),this)}}}}();exo.api.definePlugin("vray-re",{version:"0.0.1",label:"V-Ray",userFlag:"render"},function(app){if(highbrow.server){var fs=require("fs");var path=require("path")}var imgExt={j:"jpg",p:"png",e:"exr"};app.defineCommand({name:"render",returns:"File",executeServer:function(app,options){var deferred=Q.defer();var vraySettings=options.get("vraySettings");var sceneProp=options.get("sceneProp");var thisPass=options.get("thisPass");var localOp={vraySettings:vraySettings,sceneProp:sceneProp,thisPass:thisPass};var filename=thisPass.Pass._result.filename;if(!filename||filename.length==0){filename=[thisPass.get("name"),sceneProp.sceneName]}else{filename=[filename]}if(sceneProp.curFrame){var num=[sceneProp.curFrame];var pad=Math.ceil(Math.log(sceneProp.curFrame+1)/Math.log(10))-sceneProp.padding;while(pad>0){num.splice(0,0,0);--pad}filename.splice(0,0,num.join(""))}var vrScene=new exo.translators.vray.Scene(app.scene,null,localOp);if(vraySettings.exp){vrScene.exportVrScene(app,deferred,filename.join("."))}else{filename.push(imgExt[vraySettings.outFormat]);vrScene.renderImage(app,deferred,filename.join("."))}return deferred.promise}});var vrayRendering=function(app,this_scene_prop,pass){var options={vraySettings:this.vraySettings,sceneProp:this_scene_prop,thisPass:pass};return app.exec("vray-re","render",options)};var qList={0:"Very Low",1:"Low",2:"Medium",3:"High",4:"Very High"};var oList={0:"JPEG",1:"PNG",2:"OpenEXR"};var fList={0:"None",1:"Area",2:"Box",3:"Catmull-Rom",4:"Cook Variable",5:"Gaussian",6:"Lanczos",7:"MitNet",8:"Sinc",9:"Triangle"};var vrayCreatorOperator={name:"create",schema:{quality:{type:"Options",defaultValue:"1",values:Object.keys(qList),labels:qList,label:"IMAP Quality"},outFormat:{type:"Options",defaultValue:"0",values:Object.keys(oList),labels:oList,label:"Output Format"},gi:{type:"Boolean",defaultValue:true,label:"Global Illumination"},gi_color:{type:"Color",initialValue:16777215,label:"Global Illumination Color"},ao:{type:"Boolean",defaultValue:false,label:"Ambient Occlusion"},nfe:{type:"Boolean",defaultValue:true,label:"No Falloff Exponent for Lights"},exp:{type:"Boolean",defaultValue:false,label:"Export VR Scene"},filter:{type:"Options",defaultValue:"1",values:Object.keys(fList),labels:fList,label:"Filter"},filterSize:{type:"Number",defaultValue:1.5,step:.01,minValue:0,label:"Filter Size"}},target:"Renderer",category:"Creation",create:function(operator){var vray={};vray.quality=operator.get("quality");vray.outFormat=operator.get("outFormat");vray.gi=operator.get("gi");vray.gi_color=operator.get("gi_color");vray.ao=operator.get("ao");vray.nfe=operator.get("nfe");vray.exp=operator.get("exp");vray.filter=operator.get("filter");vray.filterSize=operator.get("filterSize");return{vraySettings:vray,exportScene:vrayRendering}}};var vrayCreate={name:"Vray",uiPlace:{toolbar:"Rendering"},uiState:{label:"V-Ray",icon:"vray"},execute:function(ctx,options){var num=0,name="vray";var editor=ctx.editor;while(ctx(name).length>0){name="vray"+ ++num}var deferred=Q.defer();ctx("Renderers").addNode(name,"Renderer",{Renderer:"vray-re/create"}).then(function(node){if(editor){editor.clearSelection(node);editor.select(node)}deferred.resolve(node)});return deferred.promise}};app.defineOperator(vrayCreatorOperator);app.defineCommand(vrayCreate)});
//# sourceMappingURL=/js/app.js.map