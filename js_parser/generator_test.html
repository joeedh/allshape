
      <html><head><title>Generator Test</title></head>
      <script>
      function arr_iter(keys)
      {
        this.keys = keys;
        this.cur = 0;
        
        this.next = function() {
          if (this.cur >= this.keys.length) {
            throw StopIteration;
          }
          
          return this.keys[this.cur++];
        }
      }

      __use_Iterator = true;

      function __get_iter(obj)
      {
        if (obj.__proto__.hasOwnProperty("__iterator__") || obj.hasOwnProperty("__iterator__")) {
          return obj.__iterator__();
        } else {
          if (__use_Iterator) {
            return Iterator(obj);
          } else {
            keys = []
            for (var k in obj) {
              keys.push(k)
            }
            return new arr_iter(keys);
          }
        }
      }

      function __get_iter2(obj)
      {
        if (obj.__proto__.hasOwnProperty("__iterator__") || obj.hasOwnProperty("__iterator__")) {
          return obj.__iterator__();
        } else {
          keys = []
          for (var k in obj) {
            keys.push([k, obj[k]])
          }
          return new arr_iter(keys);
        }
      }

      try {
        _tst = Iterator({});
      } catch (Error) {
        __use_Iterator = false;
        Iterator = __get_iter2;
      }
      FrameContinue = {1:1};
      FrameBreak = {2:2};
      \"use strict\";
var a=\"\nLoop {\n  eid : int\n  flag : int\n  index : int\n  type : int\n\n  co : vec3\n  no : vec3\n  loop : int | eid(loop)\n  edges : array(e, int) | e.eid\n\n  loops : array(Loop)\n}\n\";
function SchemaStruct(fields) {
}
var SchemaTypes=[Element, Vertex, Edge, Loop, Face, Mesh];
var _bt_h={\"String\": \"string\", \"Number\": \"number\", \"Function\": \"function\"}
function btypeof(obj) {
 if (typeof obj==\"object\") {
   if (obj.constructor.name in _bt_h)
    return _bt_h[obj.constructor.name];
   else 
    return \"object\";
 }
 else {
  return typeof obj;
 }
}
function JSONType() {
}
create_prototype(JSONType);
function JSOB(obj) {
 obj.__proto__ = JSONType.prototype;
 obj.constructor = JSONType;
 return obj;
}
function StaticString(s, maxlength) {
 if (s.length>maxlength)
  s = s.slice(0, maxlength);
 String.call(this, s);
}
inherit(StaticString, String);
var _basic_types={\"StaticString\": \"static_string\", \"String\": \"string\", \"Number\": \"number\", \"Vec2\": \"vec2\", \"Vec3\": \"vec3\", \"Vec4\": \"vec4\", \"Matrix4\": \"mat4\", \"number\": \"number\", \"string\": \"string\"}
function SchemaError(msg) {
 this.msg = msg;
 Error.call(this, msg);
}
inherit(SchemaError, Error);
function gen_schema(obj, calc_subschema) {
 if (calc_subschema==undefined)
  calc_subschema = false;
 var s={}
 if (obj==undefined) {
   throw new Error(\"Undefined not allowed\");
 }
 if (btypeof(obj) in _basic_types) {
   s[\"type\"] = _basic_types[btypeof(obj)];
   return s;
 }
 else 
  if (obj.__class__ in _basic_types) {
   s[\"type\"] = _basic_types[obj.__class__];
   return s;
 }
 if ((obj instanceof Array)||(obj instanceof GArray)) {
   s.type = \"array\";
   if (obj.length==0) {
     if (\"s_array_type\" in obj)
      s.subtype = obj.s_array_type;
     else 
      s.subtype = \"null\";
   }
   else {
    var type=\"s_array_type\" in obj ? obj.s_array_type : undefined;
    for (var i=0; i<obj.length; i++) {
      var t2=gen_schema(obj[i]);
      if (type==undefined)
       type = t2;
    }
    s.subtype = type;
   }
 }
 else 
  if (is_obj_lit(obj)) {
   s[\"type\"] = \"object\";
   var fields=[];
   var __iter_k = __get_iter(obj);
   while (1) {
    try {
     var k = __iter_k.next();
     if (k==\"constructor\"||k==\"prototype\"||k==\"__proto__\")
      continue;
     fields.push([k, gen_schema(obj[k])]);
    }
    catch (_for_err) {
      if (_for_err!==StopIteration) {
        if (_do_iter_err_stacktrace)
         print_stack(_for_err);
        throw _for_err;
        break;
      }
      break;
    }
   }
   s[\"fields\"] = fields;
 }
 else {
  s[\"type\"] = \"schema_object\";
  s[\"name\"] = obj.__class__;
 }
 return s;
}
function BJSON() {
 this.schemas = {}
}
BJSON.prototype.pack_array = function(obj, type) {
}
BJSON.prototype.get_schema_name = function(name) {
 return this.schemas[name];
}
BJSON.prototype.get_schema = function(obj) {
 if (is_obj_lit(obj)) {
   return gen_schema(obj);
 }
 if (!(obj.__class__ in this.schemas)) {
   this.schemas[obj.__class__] = gen_schema(obj.toJSON());
 }
 return this.schemas[obj.__class__];
}
BJSON.prototype.schema_pack = function(data, obj, schema, depth) {
 if (depth==undefined)
  depth = 1;
 var dstr=\"\";
 for (var i=0; i<depth; i++) {
   dstr+=\"->\";
 }
 if (schema[\"type\"]==\"array\") {
   var subtype=schema[\"subtype\"];
   pack_int(data, obj.length);
   for (var i=0; i<obj.length; i++) {
     if (subtype[\"type\"]==\"schema_object\")
      this.schema_pack(data, obj[i].toJSON(), this.get_schema(obj[i]), depth+1);
     else 
      this.schema_pack(data, obj[i], subtype, depth+1);
   }
 }
 else 
  if (schema[\"type\"]==\"object\") {
   var fields=schema[\"fields\"];
   for (var i=0; i<fields.length; i++) {
     var k=fields[i][0], t=fields[i][1];
     var m=obj[k];
     if (t[\"type\"]==\"schema_object\") {
       this.schema_pack(data, m.toJSON(), this.get_schema(m), depth+1);
     }
     else {
      this.schema_pack(data, m, t, depth+1);
     }
   }
 }
 else 
  if (schema[\"type\"]==\"number\"||schema[\"type\"]==\"float32\") {
   pack_float(data, Number(obj));
 }
 else 
  if (schema[\"type\"]==\"string\") {
   pack_string(data, obj);
 }
 else 
  if (schema[\"type\"]==\"int32\") {
   pack_int(data, Number(obj));
 }
 else 
  if (schema[\"type\"]==\"static_string\") {
   pack_static_string(data, obj, schema[\"maxlength\"]);
 }
}
BJSON.prototype.binify = function(obj) {
 var schema=this.get_schema(obj);
 if (is_obj_lit(obj))
  var json=obj;
 else 
  var json=obj.toJSON();
 var data=[];
 this.schema_pack(data, json, schema);
 return data;
}
BJSON.prototype.parse = function(data, schema, ui) {
 if (schema==undefined) {
   console.log(\"null schema\");
   return;
 }
 if (ui==undefined)
  ui = new unpack_ctx();
 if (schema[\"type\"]==\"int32\") {
   return unpack_int(data, ui);
 }
 else 
  if (schema[\"type\"]==\"number\"||schema[\"type\"]==\"float32\") {
   return unpack_float(data, ui);
 }
 else 
  if (schema[\"type\"]==\"string\") {
   return unpack_string(data, ui);
 }
 else 
  if (schema[\"type\"]==\"static_string\") {
   return unpack_static_string(data, ui, schema[\"maxlength\"]);
 }
 else 
  if (schema[\"type\"]==\"object\") {
   var obj={}
   var fields=schema[\"fields\"];
   for (var i=0; i<fields.length; i++) {
     obj[fields[i][0]] = this.parse(data, fields[i][1], ui);
   }
   return obj;
 }
 else 
  if (schema[\"type\"]==\"schema_object\") {
   schema = this.get_schema_name(schema[\"name\"]);
   return this.parse(data, schema, ui);
 }
 else 
  if (schema[\"type\"]==\"array\") {
   var len=unpack_int(data, ui);
   var s=schema[\"subtype\"];
   var arr=[];
   for (var i=0; i<len; i++) {
     arr.push(this.parse(data, s, ui));
   }
   return arr;
 }
 return -1;
}
function test_schema() {
 try {
  var objtest={\"v1\": new Vertex(), \"v2\": new Vertex(), \"a\": 1}
  var bjson=new BJSON();
  var schema=bjson.get_schema(objtest);
  var data=bjson.binify(objtest);
  console.log(data);
  console.log(JSON.stringify(objtest));
  data = new DataView(new Uint8Array(data).buffer);
  var json=bjson.parse(data, schema);
  console.log(JSON.stringify(json));
 }
 catch (err) {
   print_stack(err);
 }
 bjson = new BJSON();
 var mesh=makeBoxMesh(null);
 console.log(\"generating mesh...\");
 for (var i=0; i<4; i++) {
   _quad_subd(mesh, mesh.faces, 1);
 }
 console.log(\"totvert: \", mesh.verts.length);
 console.log(\"saving mesh...\");
 var obj=mesh.toJSON();
 schema = bjson.get_schema(mesh);
 var data=bjson.binify(mesh);
 data = new DataView(new Uint8Array(data).buffer);
 console.log(\"parsing data. . .\");
 var obj=bjson.parse(data, schema);
 console.log(\"-----====-----\");
 console.log(\"finished; testing load\");
 var m=Mesh.fromJSON(obj);
 return true;
}
var SchmTypes={BYTE: 0, INT: 1, FLOAT: 2, STRING: 3, FIXEDSTRING: 4, ARRAY: 5, VEC2: 6, VEC3: 7, VEC4: 8, MAT4: 9, COLOR: 10, DATAREF: 11, OBJECT: 12}

  j = 0;
  for (var tst in new range2(2, 8)) {
    if (_do_frame_debug) console.log(tst);
    if (j > 10)
      break;
    j++;
  }
  </script>
  </html>
  